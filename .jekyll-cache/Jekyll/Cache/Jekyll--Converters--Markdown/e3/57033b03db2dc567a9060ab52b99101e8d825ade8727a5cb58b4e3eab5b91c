I"TÒ<ul id="markdown-toc">
  <li><a href="#ç®€ä»‹" id="markdown-toc-ç®€ä»‹">ç®€ä»‹</a>    <ul>
      <li><a href="#ä¸ºä»€ä¹ˆé€‰æ‹©" id="markdown-toc-ä¸ºä»€ä¹ˆé€‰æ‹©">ä¸ºä»€ä¹ˆé€‰æ‹©ï¼Ÿ</a></li>
      <li><a href="#amqp" id="markdown-toc-amqp">AMQP</a></li>
      <li><a href="#å®‰è£…ä¸ä½¿ç”¨" id="markdown-toc-å®‰è£…ä¸ä½¿ç”¨">å®‰è£…ä¸ä½¿ç”¨</a></li>
      <li><a href="#ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…" id="markdown-toc-ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…">ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…</a></li>
      <li><a href="#äº¤æ¢æœº" id="markdown-toc-äº¤æ¢æœº">äº¤æ¢æœº</a></li>
      <li><a href="#æ¦‚å¿µ" id="markdown-toc-æ¦‚å¿µ">æ¦‚å¿µ</a></li>
    </ul>
  </li>
  <li><a href="#ç‰¹æ€§" id="markdown-toc-ç‰¹æ€§">ç‰¹æ€§</a>    <ul>
      <li><a href="#æ¶ˆæ¯æŠ•é€’æˆåŠŸ" id="markdown-toc-æ¶ˆæ¯æŠ•é€’æˆåŠŸ">æ¶ˆæ¯æŠ•é€’æˆåŠŸ</a></li>
      <li><a href="#æ¶ˆæ¯å¹‚ç­‰æ€§" id="markdown-toc-æ¶ˆæ¯å¹‚ç­‰æ€§">æ¶ˆæ¯å¹‚ç­‰æ€§</a></li>
      <li><a href="#é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹" id="markdown-toc-é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹">é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹</a></li>
      <li><a href="#æ¶ˆæ¯ç¡®è®¤ä¸è¿”å›" id="markdown-toc-æ¶ˆæ¯ç¡®è®¤ä¸è¿”å›">æ¶ˆæ¯ç¡®è®¤ä¸è¿”å›</a></li>
      <li><a href="#è‡ªå®šä¹‰æ¶ˆè´¹è€…" id="markdown-toc-è‡ªå®šä¹‰æ¶ˆè´¹è€…">è‡ªå®šä¹‰æ¶ˆè´¹è€…</a></li>
      <li><a href="#æ¶ˆæ¯é™æµ" id="markdown-toc-æ¶ˆæ¯é™æµ">æ¶ˆæ¯é™æµ</a></li>
      <li><a href="#æ¶ˆæ¯çš„ackå’Œnack" id="markdown-toc-æ¶ˆæ¯çš„ackå’Œnack">æ¶ˆæ¯çš„ACKå’ŒNACK</a></li>
      <li><a href="#ttlæ¶ˆæ¯" id="markdown-toc-ttlæ¶ˆæ¯">TTLæ¶ˆæ¯</a></li>
      <li><a href="#æ­»ä¿¡é˜Ÿåˆ—" id="markdown-toc-æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</a></li>
    </ul>
  </li>
  <li><a href="#æ•´åˆspring-amqp" id="markdown-toc-æ•´åˆspring-amqp">æ•´åˆspring AMQP</a>    <ul>
      <li><a href="#rabbitadmin" id="markdown-toc-rabbitadmin">RabbitAdmin</a></li>
      <li><a href="#æ¶ˆæ¯ç›‘å¬å™¨" id="markdown-toc-æ¶ˆæ¯ç›‘å¬å™¨">æ¶ˆæ¯ç›‘å¬å™¨</a></li>
      <li><a href="#æ¶ˆæ¯ç›‘å¬é€‚é…å™¨" id="markdown-toc-æ¶ˆæ¯ç›‘å¬é€‚é…å™¨">æ¶ˆæ¯ç›‘å¬é€‚é…å™¨</a></li>
      <li><a href="#æ¶ˆæ¯è½¬æ¢å™¨" id="markdown-toc-æ¶ˆæ¯è½¬æ¢å™¨">æ¶ˆæ¯è½¬æ¢å™¨</a></li>
    </ul>
  </li>
  <li><a href="#æ•´åˆspringboot" id="markdown-toc-æ•´åˆspringboot">æ•´åˆspringboot</a>    <ul>
      <li><a href="#ç”Ÿäº§è€…" id="markdown-toc-ç”Ÿäº§è€…">ç”Ÿäº§è€…</a></li>
      <li><a href="#æ¶ˆè´¹è€…" id="markdown-toc-æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</a></li>
    </ul>
  </li>
  <li><a href="#æ•´åˆspring-cloud" id="markdown-toc-æ•´åˆspring-cloud">æ•´åˆspring cloud</a>    <ul>
      <li><a href="#ç”Ÿäº§è€…-1" id="markdown-toc-ç”Ÿäº§è€…-1">ç”Ÿäº§è€…</a></li>
      <li><a href="#æ¶ˆè´¹è€…-1" id="markdown-toc-æ¶ˆè´¹è€…-1">æ¶ˆè´¹è€…</a></li>
    </ul>
  </li>
</ul>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>

<p><a href="https://github.com/BaiWeiJieKu/MK-rabbitmq">github</a></p>

<h4 id="ä¸ºä»€ä¹ˆé€‰æ‹©">ä¸ºä»€ä¹ˆé€‰æ‹©ï¼Ÿ</h4>

<ul>
  <li>å¼€æºï¼Œæ€§èƒ½ä¼˜ç§€ï¼Œç¨³å®šæ€§ä¿éšœ</li>
  <li>æä¾›å¯é æ€§æ¶ˆæ¯æŠ•é€’æ¨¡å¼ï¼ˆconfirmï¼‰ï¼Œè¿”å›æ¨¡å¼ï¼ˆreturnï¼‰</li>
  <li>ä¸SpringAMQPå®Œç¾æ•´åˆï¼ŒAPIä¸°å¯Œ</li>
  <li>é›†ç¾¤æ¨¡å¼ä¸°å¯Œï¼Œè¡¨è¾¾å¼é…ç½®ï¼ŒHAæ¨¡å¼ï¼Œé•œåƒé˜Ÿåˆ—æ¨¡å‹</li>
  <li>ä¿è¯æ•°æ®ä¸ä¸¢å¤±çš„å‰æåšåˆ°é«˜å¯é æ€§ï¼Œå¯ç”¨æ€§</li>
  <li>Erlangè¯­è¨€æœ€åˆåº”ç”¨äºäº¤æ¢æœºé¢†åŸŸçš„æ¶æ„æ¨¡å¼ï¼Œè¿™æ ·ä½¿å¾—RabbitMQåœ¨Brokerä¹‹é—´è¿›è¡Œæ•°æ®äº¤äº’çš„æ€§èƒ½æ˜¯éå¸¸ä¼˜ç§€çš„</li>
  <li>Erlangçš„ç‰¹ç‚¹ï¼šErlangæœ‰ç€å’ŒåŸç”ŸSocketä¸€æ ·çš„å»¶è¿Ÿ</li>
</ul>

<h4 id="amqp">AMQP</h4>

<ul>
  <li>é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAdvanced Message Queuing Protocolï¼‰</li>
  <li>AMQPå®šä¹‰ï¼šæ˜¯å…·æœ‰ç°ä»£ç‰¹å¾çš„äºŒè¿›åˆ¶åè®®ã€‚æ˜¯ä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚</li>
  <li>æ ¸å¿ƒæ¦‚å¿µï¼š
    <ul>
      <li>Serverï¼šåˆç§°Brokerï¼Œæ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå®ç°AMQPå®ä½“æœåŠ¡</li>
      <li>Connectionï¼šè¿æ¥ï¼Œåº”ç”¨ç¨‹åºä¸Brokerçš„ç½‘ç»œè¿æ¥</li>
      <li>Channelï¼šç½‘ç»œä¿¡é“ï¼Œå‡ ä¹æ‰€æœ‰çš„æ“ä½œéƒ½åœ¨Channelä¸­è¿›è¡Œï¼ŒChannelæ˜¯è¿›è¡Œæ¶ˆæ¯è¯»å†™çš„é€šé“ã€‚å®¢æˆ·ç«¯å¯å»ºç«‹å¤šä¸ªChannelï¼Œæ¯ä¸ªChannelä»£è¡¨ä¸€ä¸ªä¼šè¯ä»»åŠ¡</li>
      <li>Messageï¼šæ¶ˆæ¯ï¼ŒæœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€çš„æ•°æ®ï¼Œç”±Propertieså’ŒBodyç»„æˆã€‚Propertieså¯ä»¥å¯¹æ¶ˆæ¯è¿›è¡Œä¿®é¥°ï¼Œæ¯”å¦‚æ¶ˆæ¯çš„ä¼˜å…ˆçº§ï¼Œå»¶è¿Ÿç­‰é«˜çº§ç‰¹æ€§ï¼›Bodyå°±æ˜¯æ¶ˆæ¯ä½“å†…å®¹</li>
      <li>Virtual hostï¼šè™šæ‹Ÿåœ°å€ï¼Œç”¨äºè¿›è¡Œé€»è¾‘éš”ç¦»ï¼Œæœ€ä¸Šå±‚çš„æ¶ˆæ¯è·¯ç”±ã€‚ä¸€ä¸ªVirtual Hosté‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeå’ŒQueueï¼ŒåŒä¸€ä¸ªVirtual Host é‡Œé¢ä¸èƒ½æœ‰ç›¸åŒåç§°çš„Exchangeæˆ–Queueã€‚</li>
      <li>Exchangeï¼šäº¤æ¢æœºï¼Œæ¥æ”¶æ¶ˆæ¯ï¼Œæ ¹æ®è·¯ç”±é”®è½¬å‘æ¶ˆæ¯åˆ°ç»‘å®šçš„é˜Ÿåˆ—</li>
      <li>Bindingï¼šExchangeå’ŒQueueä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œbindingä¸­å¯ä»¥åŒ…å«routing key</li>
      <li>Routing keyï¼šä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œè™šæ‹Ÿæœºå¯ç”¨å®ƒæ¥ç¡®å®šå¦‚ä½•è·¯ç”±ä¸€ä¸ªç‰¹å®šæ¶ˆæ¯</li>
      <li>Queueï¼šä¹Ÿç§°ä¸ºMessage Queueï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¿å­˜æ¶ˆæ¯å¹¶å°†å®ƒä»¬è½¬å‘ç»™æ¶ˆè´¹è€…</li>
    </ul>
  </li>
</ul>

<h4 id="å®‰è£…ä¸ä½¿ç”¨">å®‰è£…ä¸ä½¿ç”¨</h4>

<ul>
  <li>1.ä¸‹è½½Erlang</li>
  <li>2.å¯¹ç…§ç‰ˆæœ¬ä¸‹è½½RabbitMQ</li>
  <li>æœåŠ¡çš„å¯åŠ¨ï¼šrabbitmq-server start &amp;</li>
  <li>æœåŠ¡çš„åœæ­¢ï¼šrabbitmqctl stop_app</li>
  <li>ç®¡ç†æ’ä»¶ï¼šrabbitmq-plugins enable rabbitmq_management</li>
  <li>è®¿é—®åœ°å€ï¼š<code class="language-plaintext highlighter-rouge">http://IP:15672/</code></li>
  <li>å¸¸ç”¨å‘½ä»¤ï¼š
    <ul>
      <li>å…³é—­åº”ç”¨ï¼šrabbitmqctl stop_app</li>
      <li>å¯åŠ¨åº”ç”¨ï¼šrabbitmqctl start_app</li>
      <li>æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼šrabbitmqctl status</li>
      <li>æ·»åŠ ç”¨æˆ·ï¼šrabbitmqctl add_user username password</li>
      <li>åˆ—å‡ºæ‰€æœ‰ç”¨æˆ·ï¼šrabbitmqctl list_users</li>
      <li>åˆ é™¤ç”¨æˆ·ï¼šrabbitmqctl delete_user username</li>
      <li>æ¸…é™¤ç”¨æˆ·æƒé™ï¼šrabbitmqctl clear_permissions -p vhostpath username</li>
      <li>åˆ—å‡ºç”¨æˆ·æƒé™ï¼šrabbitmqctl list_user_permission username</li>
      <li>ä¿®æ”¹å¯†ç ï¼šrabbitmqctl change_password username newpassword</li>
      <li>è®¾ç½®ç”¨æˆ·æƒé™ï¼š<code class="language-plaintext highlighter-rouge">rabbitmqctl set_permissions -p vhostpath username ".*" ".*" ".*"</code></li>
      <li>åˆ›å»ºè™šæ‹Ÿä¸»æœºï¼šrabbitmqctl add_vhost vhostpath</li>
      <li>åˆ—å‡ºæ‰€æœ‰è™šæ‹Ÿä¸»æœºï¼šrabbitmqctl list_vhosts</li>
      <li>åˆ—å‡ºè™šæ‹Ÿä¸»æœºä¸Šæ‰€æœ‰æƒé™ï¼šrabbitmqctl list_permissions -p vhostpath</li>
      <li>åˆ é™¤è™šæ‹Ÿä¸»æœºï¼šrabbitmqctl delete_vhost vhostpath</li>
      <li>æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—ä¿¡æ¯ï¼šrabbitmqctl list_queues</li>
      <li>æ¸…é™¤é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ï¼šrabbitmqctl -p vhostpath purge_queue blue</li>
      <li>æ¸…é™¤æ‰€æœ‰æ•°æ®ï¼Œåœ¨stop_appåä½¿ç”¨ï¼šrabbitmqctl reset</li>
      <li>ç»„æˆé›†ç¾¤å‘½ä»¤ï¼š<code class="language-plaintext highlighter-rouge">rabbitmqctl join_cluster &lt;clusternode&gt; [--ram]</code></li>
      <li>æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼šrabbitmqctl cluster_status</li>
      <li>ä¿®æ”¹é›†ç¾¤èŠ‚ç‚¹çš„å­˜å‚¨å½¢å¼ï¼š<code class="language-plaintext highlighter-rouge">rabbitmqctl change_cluster_node_type disc | ram</code></li>
      <li>æ‘˜é™¤èŠ‚ç‚¹ï¼šrabbitmqctl forget_cluster_node [â€“offline]</li>
      <li>ä¿®æ”¹èŠ‚ç‚¹åç§°ï¼š<code class="language-plaintext highlighter-rouge">rabbitmqctl rename_cluster_node oldnode1 newnode1 [oldnode2][newnode2]</code></li>
    </ul>
  </li>
</ul>

<h4 id="ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…">ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…</h4>

<ul>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>com.rabbitmq<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>amqp-client<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;version&gt;</span>3.6.5<span class="nt">&lt;/version&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Procuder</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="c1">//1 åˆ›å»ºä¸€ä¸ªConnectionFactory, å¹¶è¿›è¡Œé…ç½®</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 é€šè¿‡è¿æ¥å·¥å‚åˆ›å»ºè¿æ¥</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         
         <span class="c1">//3 é€šè¿‡connectionåˆ›å»ºä¸€ä¸ªChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="c1">//4 é€šè¿‡Channelå‘é€æ•°æ®</span>
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ!"</span><span class="o">;</span>
             <span class="c1">//1 exchange   2 routingKey</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"test001"</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
 
         <span class="c1">//5 è®°å¾—è¦å…³é—­ç›¸å…³çš„è¿æ¥</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
         <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="c1">//1 åˆ›å»ºä¸€ä¸ªConnectionFactory, å¹¶è¿›è¡Œé…ç½®</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 é€šè¿‡è¿æ¥å·¥å‚åˆ›å»ºè¿æ¥</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         
         <span class="c1">//3 é€šè¿‡connectionåˆ›å»ºä¸€ä¸ªChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="c1">//4 å£°æ˜ï¼ˆåˆ›å»ºï¼‰ä¸€ä¸ªé˜Ÿåˆ—</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test001"</span><span class="o">;</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         
         <span class="c1">//5 åˆ›å»ºæ¶ˆè´¹è€…</span>
         <span class="nc">QueueingConsumer</span> <span class="n">queueingConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
         
         <span class="c1">//6 è®¾ç½®Channel</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">queueingConsumer</span><span class="o">);</span>
         
         <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
             <span class="c1">//7 è·å–æ¶ˆæ¯</span>
             <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">queueingConsumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹ç«¯: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
             <span class="c1">//Envelope envelope = delivery.getEnvelope();</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="äº¤æ¢æœº">äº¤æ¢æœº</h4>

<ul>
  <li>Exchangeï¼šæ¥æ”¶æ¶ˆæ¯ï¼Œå¹¶æ ¹æ®è·¯ç”±é”®è½¬å‘æ¶ˆæ¯æ‰€ç»‘å®šçš„é˜Ÿåˆ—</li>
  <li>äº¤æ¢æœºå±æ€§ï¼š
    <ul>
      <li>Nameï¼šäº¤æ¢æœºåç§°</li>
      <li>Durabilityï¼šæ˜¯å¦éœ€è¦æŒä¹…åŒ–ï¼Œtrueä¸ºæŒä¹…åŒ–</li>
      <li>Auto Deleteï¼šå½“æœ€åä¸€ä¸ªç»‘å®šåˆ°Exchangeä¸Šçš„é˜Ÿåˆ—åˆ é™¤åï¼Œè‡ªåŠ¨åˆ é™¤è¯¥Exchange</li>
      <li>Internalï¼šå½“å‰Exchangeæ˜¯å¦ç”¨äºRabbitMQå†…éƒ¨ä½¿ç”¨ï¼Œé»˜è®¤ä¸ºfalse</li>
      <li>Arguementsï¼šæ‰©å±•å‚æ•°ï¼Œç”¨äºæ‰©å±•AMQPåè®®è‡ªå®šåˆ¶åŒ–ä½¿ç”¨</li>
    </ul>
  </li>
  <li>äº¤æ¢æœºç±»å‹ï¼š</li>
  <li>Directï¼šæ‰€æœ‰å‘é€åˆ°Direct Exchangeçš„æ¶ˆæ¯è¢«è½¬å‘åˆ°RouteKeyä¸­æŒ‡å®šçš„Queue</li>
  <li>æ³¨æ„ï¼šDirectæ¨¡å¼å¯ä»¥ä½¿ç”¨RabbitMQè‡ªå¸¦çš„Exchangeï¼šdefault Exchangeï¼Œæ‰€ä»¥ä¸éœ€è¦å°†Exchangeè¿›è¡Œä»»ä½•ç»‘å®šï¼ˆbindingï¼‰æ“ä½œï¼Œæ¶ˆæ¯ä¼ é€’æ—¶ï¼ŒRouteKeyå¿…é¡»å®Œå…¨åŒ¹é…æ‰ä¼šè¢«é˜Ÿåˆ—æ¥æ”¶ï¼Œå¦åˆ™è¯¥æ¶ˆæ¯ä¼šè¢«æŠ›å¼ƒã€‚</li>
</ul>

<p><img src="https://img-blog.csdn.net/20160131181826914?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /></p>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer4DirectExchange</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="c1">//1 åˆ›å»ºConnectionFactory</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 åˆ›å»ºConnection</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="c1">//3 åˆ›å»ºChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_direct_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"test.direct"</span><span class="o">;</span>
         <span class="c1">//5 å‘é€</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello World RabbitMQ 4  Direct Exchange Message 111 ... "</span><span class="o">;</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span> <span class="o">,</span> <span class="kc">null</span> <span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>       
         
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer4DirectExchange</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
        <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">()</span> <span class="o">;</span>  
        
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         <span class="c1">//é‡è¿</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setAutomaticRecoveryEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setNetworkRecoveryInterval</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
        
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_direct_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">exchangeType</span> <span class="o">=</span> <span class="s">"direct"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_direct_queue"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"test.direct"</span><span class="o">;</span>
         
         <span class="c1">//è¡¨ç¤ºå£°æ˜äº†ä¸€ä¸ªäº¤æ¢æœº</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">exchangeType</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="c1">//è¡¨ç¤ºå£°æ˜äº†ä¸€ä¸ªé˜Ÿåˆ—</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="c1">//å»ºç«‹ä¸€ä¸ªç»‘å®šå…³ç³»:</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
        <span class="c1">//durable æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯</span>
        <span class="nc">QueueingConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="c1">//å‚æ•°ï¼šé˜Ÿåˆ—åç§°ã€æ˜¯å¦è‡ªåŠ¨ACKã€Consumer</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">consumer</span><span class="o">);</span>  
        <span class="c1">//å¾ªç¯è·å–æ¶ˆæ¯  </span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>  
            <span class="c1">//è·å–æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œè¿™ä¸€æ­¥å°†ä¼šä¸€ç›´é˜»å¡  </span>
            <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>  
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>    
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ”¶åˆ°æ¶ˆæ¯ï¼š"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>  
        <span class="o">}</span> 
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>Topicï¼šæ‰€æœ‰å‘é€åˆ°Topic Exchangeçš„æ¶ˆæ¯è¢«è½¬å‘åˆ°æ‰€æœ‰å…³å¿ƒRouteKeyä¸­æŒ‡å®šTopicçš„Queueä¸Šã€‚Exchangeå°†RouteKeyå’ŒæŸTopicè¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼Œæ­¤æ—¶é˜Ÿåˆ—éœ€è¦ç»‘å®šä¸€ä¸ªTopicã€‚</li>
  <li>æ³¨æ„ï¼šå¯ä»¥ä½¿ç”¨é€šé…ç¬¦è¿›è¡Œæ¨¡ç³ŠæŸ¥è¯¢
    <ul>
      <li>ç¬¦å·â€œ#â€åŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯</li>
      <li>ç¬¦å·* åŒ¹é…ä¸å¤šä¸å°‘ä¸€ä¸ªè¯</li>
      <li>ä¾‹å¦‚ï¼šâ€œlog.#â€èƒ½åŒ¹é…åˆ°â€œlog.info.oaâ€ã€‚è€Œâ€log.*â€œåªä¼šåŒ¹é…åˆ°â€log.errorâ€</li>
    </ul>
  </li>
</ul>

<p><img src="https://img-blog.csdn.net/20160131181917712?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /></p>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer4TopicExchange</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="c1">//1 åˆ›å»ºConnectionFactory</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 åˆ›å»ºConnection</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="c1">//3 åˆ›å»ºChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_topic_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey1</span> <span class="o">=</span> <span class="s">"user.save"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey2</span> <span class="o">=</span> <span class="s">"user.update"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey3</span> <span class="o">=</span> <span class="s">"user.delete.abc"</span><span class="o">;</span>
         <span class="c1">//5 å‘é€</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello World RabbitMQ 4 Topic Exchange Message ..."</span><span class="o">;</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey1</span> <span class="o">,</span> <span class="kc">null</span> <span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span> 
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey2</span> <span class="o">,</span> <span class="kc">null</span> <span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>     
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey3</span> <span class="o">,</span> <span class="kc">null</span> <span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span> 
         <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer4TopicExchange</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
        <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">()</span> <span class="o">;</span>  
        
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setAutomaticRecoveryEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setNetworkRecoveryInterval</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
        
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_topic_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">exchangeType</span> <span class="o">=</span> <span class="s">"topic"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_topic_queue"</span><span class="o">;</span>
         <span class="c1">//æ¨¡ç³ŠåŒ¹é…</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"user.*"</span><span class="o">;</span>
         <span class="c1">// 1 å£°æ˜äº¤æ¢æœº </span>
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">exchangeType</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="c1">// 2 å£°æ˜é˜Ÿåˆ—</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="c1">// 3 å»ºç«‹äº¤æ¢æœºå’Œé˜Ÿåˆ—çš„ç»‘å®šå…³ç³»:</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
        <span class="c1">//durable æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯</span>
        <span class="nc">QueueingConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="c1">//å‚æ•°ï¼šé˜Ÿåˆ—åç§°ã€æ˜¯å¦è‡ªåŠ¨ACKã€Consumer</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">consumer</span><span class="o">);</span>  
        <span class="c1">//å¾ªç¯è·å–æ¶ˆæ¯  </span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>  
            <span class="c1">//è·å–æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œè¿™ä¸€æ­¥å°†ä¼šä¸€ç›´é˜»å¡  </span>
            <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>  
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>    
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ”¶åˆ°æ¶ˆæ¯ï¼š"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>  
        <span class="o">}</span> 
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//æ³¨æ„ï¼šä¿®æ”¹äº†æ¨¡ç³ŠåŒ¹é…çš„routing Keyåè¦æŠŠä»¥å‰çš„è¿›è¡Œè§£ç»‘</span>
</code></pre></div></div>

<ul>
  <li>Fanoutï¼šä¸å¤„ç†è·¯ç”±é”®ï¼Œåªéœ€è¦ç®€å•çš„å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœºä¸Šã€‚å‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯éƒ½ä¼šè¢«è½¬å‘åˆ°ä¸è¯¥äº¤æ¢æœºç»‘å®šçš„æ‰€æœ‰é˜Ÿåˆ—ä¸Šã€‚Fanoutäº¤æ¢æœºè½¬å‘æ¶ˆæ¯æ˜¯æœ€å¿«çš„</li>
</ul>

<p><img src="https://img-blog.csdn.net/20160131181857446?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQv/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="" /></p>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer4FanoutExchange</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="c1">//1 åˆ›å»ºConnectionFactory</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 åˆ›å»ºConnection</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="c1">//3 åˆ›å»ºChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_fanout_exchange"</span><span class="o">;</span>
         <span class="c1">//5 å‘é€</span>
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello World RabbitMQ 4 FANOUT Exchange Message ..."</span><span class="o">;</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="kc">null</span> <span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>             
         <span class="o">}</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>  
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer4FanoutExchange</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
        <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">()</span> <span class="o">;</span>  
        
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setAutomaticRecoveryEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setNetworkRecoveryInterval</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
        
        <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>  
         <span class="c1">//4 å£°æ˜</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_fanout_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">exchangeType</span> <span class="o">=</span> <span class="s">"fanout"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_fanout_queue"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>    <span class="c1">//ä¸è®¾ç½®è·¯ç”±é”®</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">exchangeType</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
        <span class="c1">//durable æ˜¯å¦æŒä¹…åŒ–æ¶ˆæ¯</span>
        <span class="nc">QueueingConsumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
        <span class="c1">//å‚æ•°ï¼šé˜Ÿåˆ—åç§°ã€æ˜¯å¦è‡ªåŠ¨ACKã€Consumer</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">consumer</span><span class="o">);</span> 
        <span class="c1">//å¾ªç¯è·å–æ¶ˆæ¯  </span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>  
            <span class="c1">//è·å–æ¶ˆæ¯ï¼Œå¦‚æœæ²¡æœ‰æ¶ˆæ¯ï¼Œè¿™ä¸€æ­¥å°†ä¼šä¸€ç›´é˜»å¡  </span>
            <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">consumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>  
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>    
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ”¶åˆ°æ¶ˆæ¯ï¼š"</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>  
        <span class="o">}</span> 
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¦‚å¿µ">æ¦‚å¿µ</h4>

<ul>
  <li>
    <p>ç»‘å®šï¼šExchangeå’ŒExchangeï¼ŒQueueä¹‹é—´çš„è¿æ¥å…³ç³»ï¼ŒBindingä¸­å¯ä»¥åŒ…å«RoutingKeyæˆ–è€…å‚æ•°</p>
  </li>
  <li>
    <p>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå®é™…å­˜å‚¨æ¶ˆæ¯æ•°æ®</p>

    <ul>
      <li>Durabilityï¼šæ˜¯å¦æŒä¹…åŒ–ï¼ŒDurableï¼šæ˜¯ï¼ŒTransientï¼šå¦</li>
      <li>Auto deleteï¼šè‹¥é€‰yesï¼Œä»£è¡¨å½“æœ€åä¸€ä¸ªç›‘å¬è¢«ç§»é™¤ä¹‹åï¼Œè¯¥Queueä¼šè‡ªåŠ¨è¢«åˆ é™¤</li>
    </ul>
  </li>
  <li>
    <p>æ¶ˆæ¯ï¼šæœåŠ¡å™¨å’Œåº”ç”¨ç¨‹åºä¹‹é—´ä¼ é€çš„æ•°æ®ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€æ®µæ•°æ®ï¼Œç”±Propertieså’ŒPayloadï¼ˆBodyï¼‰ç»„æˆ</p>

    <ul>
      <li>å¸¸ç”¨å±æ€§ï¼šdelivery mode,headers,content_type,content_encoding,priority,correlation_id,reply_to,expiration,message_id,timestamp,type,user_id,app_id,cluster_id</li>
      <li>ç”Ÿäº§è€…</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Procuder</span> <span class="o">{</span>
   
      
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="c1">//1 åˆ›å»ºä¸€ä¸ªConnectionFactory, å¹¶è¿›è¡Œé…ç½®</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
           
         <span class="c1">//2 é€šè¿‡è¿æ¥å·¥å‚åˆ›å»ºè¿æ¥</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
           
         <span class="c1">//3 é€šè¿‡connectionåˆ›å»ºä¸€ä¸ªChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
           
         <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
         <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"my1"</span><span class="o">,</span> <span class="s">"111"</span><span class="o">);</span>
         <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"my2"</span><span class="o">,</span> <span class="s">"222"</span><span class="o">);</span>
           
           
         <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">deliveryMode</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">contentEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">expiration</span><span class="o">(</span><span class="s">"10000"</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">build</span><span class="o">();</span>
           
         <span class="c1">//4 é€šè¿‡Channelå‘é€æ•°æ®</span>
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ!"</span><span class="o">;</span>
             <span class="c1">//1 exchange   2 routingKey</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"test001"</span><span class="o">,</span> <span class="n">properties</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
   
         <span class="c1">//5 è®°å¾—è¦å…³é—­ç›¸å…³çš„è¿æ¥</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
         <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <ul>
      <li>æ¶ˆè´¹è€…</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
           
         <span class="c1">//1 åˆ›å»ºä¸€ä¸ªConnectionFactory, å¹¶è¿›è¡Œé…ç½®</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
           
         <span class="c1">//2 é€šè¿‡è¿æ¥å·¥å‚åˆ›å»ºè¿æ¥</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
           
         <span class="c1">//3 é€šè¿‡connectionåˆ›å»ºä¸€ä¸ªChannel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
           
         <span class="c1">//4 å£°æ˜ï¼ˆåˆ›å»ºï¼‰ä¸€ä¸ªé˜Ÿåˆ—</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test001"</span><span class="o">;</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
           
         <span class="c1">//5 åˆ›å»ºæ¶ˆè´¹è€…</span>
         <span class="nc">QueueingConsumer</span> <span class="n">queueingConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
           
         <span class="c1">//6 è®¾ç½®Channel</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">queueingConsumer</span><span class="o">);</span>
           
         <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
             <span class="c1">//7 è·å–æ¶ˆæ¯</span>
             <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">queueingConsumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹ç«¯: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
             <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="n">delivery</span><span class="o">.</span><span class="na">getProperties</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">();</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"headers get my1 value: "</span> <span class="o">+</span> <span class="n">headers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"my1"</span><span class="o">));</span>
               
             <span class="c1">//Envelope envelope = delivery.getEnvelope();</span>
         <span class="o">}</span>
           
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>
  </li>
  <li>
    <p>è™šæ‹Ÿä¸»æœºï¼šè™šæ‹Ÿåœ°å€ï¼Œç”¨äºè¿›è¡Œé€»è¾‘éš”ç¦»ï¼Œæœ€ä¸Šå±‚çš„æ¶ˆæ¯è·¯ç”±ã€‚ä¸€ä¸ªVirtual Hosté‡Œé¢å¯ä»¥æœ‰è‹¥å¹²ä¸ªExchangeå’ŒQueueã€‚åŒä¸€ä¸ªVirtual Hosté‡Œé¢ä¸èƒ½æœ‰ç›¸åŒåç§°çš„Exchangeæˆ–Queue</p>
  </li>
</ul>

<h3 id="ç‰¹æ€§">ç‰¹æ€§</h3>

<h4 id="æ¶ˆæ¯æŠ•é€’æˆåŠŸ">æ¶ˆæ¯æŠ•é€’æˆåŠŸ</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯ç”Ÿäº§ç«¯çš„å¯é æ€§æŠ•é€’ï¼Ÿ
    <ul>
      <li>ä¿éšœæ¶ˆæ¯çš„æˆåŠŸå‘å‡º</li>
      <li>ä¿éšœèŠ‚ç‚¹çš„æˆåŠŸæ¥æ”¶</li>
      <li>å‘é€ç«¯æ”¶åˆ°èŠ‚ç‚¹çš„ç¡®è®¤åº”ç­”</li>
      <li>å®Œå–„çš„æ¶ˆæ¯è¡¥å¿æœºåˆ¶</li>
    </ul>
  </li>
  <li>å¦‚ä½•ä¿éšœæ¶ˆæ¯ç™¾åˆ†ç™¾æŠ•é€’æˆåŠŸï¼Ÿ
    <ul>
      <li>æ–¹æ¡ˆä¸€ï¼šæ¶ˆæ¯è½åº“ï¼Œå¯¹æ¶ˆæ¯çŠ¶æ€è¿›è¡Œæ‰“æ ‡</li>
      <li><img src="https://i.loli.net/2020/08/08/Gs6TIWgNK9ytHxn.png" alt="image.png" /></li>
      <li>æ–¹æ¡ˆäºŒï¼šæ¶ˆæ¯çš„å»¶è¿ŸæŠ•é€’ï¼ŒåšäºŒæ¬¡ç¡®è®¤ï¼Œå›è°ƒæ£€æŸ¥</li>
      <li><img src="https://i.loli.net/2020/08/08/y2bg6fRvjk34PwL.png" alt="image.png" /></li>
    </ul>
  </li>
</ul>

<h4 id="æ¶ˆæ¯å¹‚ç­‰æ€§">æ¶ˆæ¯å¹‚ç­‰æ€§</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯æ¶ˆæ¯å¹‚ç­‰æ€§ï¼Ÿ
    <ul>
      <li>å€Ÿé‰´æ•°æ®åº“çš„ä¹è§‚é”æœºåˆ¶ï¼š</li>
      <li>æ¯”å¦‚è´­ä¹°å•†å“æ›´æ–°åº“å­˜æ—¶ï¼šupdate table set count=count-1,version=version+1 where version=1</li>
      <li>versionæ˜¯ä¸€ä¸ªç‰ˆæœ¬å·ï¼Œåœ¨æ¯æ¬¡æŸ¥è¯¢æ—¶è¿›è¡ŒåŠ ä¸€</li>
    </ul>
  </li>
</ul>

<h4 id="é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹">é¿å…æ¶ˆæ¯é‡å¤æ¶ˆè´¹</h4>

<ul>
  <li>æ¶ˆè´¹ç«¯å®ç°å¹‚ç­‰æ€§ï¼Œå°±æ„å‘³ç€ï¼Œæˆ‘ä»¬çš„æ¶ˆæ¯æ°¸è¿œä¸ä¼šæ¶ˆè´¹å¤šæ¬¡ï¼Œå³ä½¿æˆ‘ä»¬æ”¶åˆ°äº†å¤šæ¡ä¸€æ ·çš„æ¶ˆæ¯</li>
  <li>ä¸šç•Œä¸»æµçš„å¹‚ç­‰æ€§æ“ä½œï¼š
    <ul>
      <li>å”¯ä¸€ID+æŒ‡çº¹ç æœºåˆ¶ï¼Œåˆ©ç”¨æ•°æ®åº“ä¸»é”®å»é‡</li>
      <li>select count(1) from t_order where id=å”¯ä¸€ID+æŒ‡çº¹ç </li>
      <li>å¥½å¤„ï¼šå®ç°ç®€å•</li>
      <li>åå¤„ï¼šé«˜å¹¶å‘ä¸‹æœ‰æ•°æ®åº“å†™å…¥çš„æ€§èƒ½ç“¶é¢ˆ</li>
      <li>è§£å†³æ–¹æ¡ˆï¼šè·Ÿè¿›IDè¿›è¡Œåˆ†åº“åˆ†è¡¨è¿›è¡Œç®—æ³•è·¯ç”±</li>
    </ul>
  </li>
  <li>ä½¿ç”¨Redisè¿›è¡Œå¹‚ç­‰ï¼Œéœ€è¦è€ƒè™‘çš„é—®é¢˜
    <ul>
      <li>æˆ‘ä»¬æ˜¯å¦è¦è¿›è¡Œæ•°æ®åº“è½åº“ï¼Œå¦‚æœè½åº“çš„è¯ï¼Œå…³é”®è§£å†³çš„é—®é¢˜æ˜¯æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•åšåˆ°åŸå­æ€§</li>
      <li>å¦‚æœä¸è¿›è¡Œè½åº“ï¼Œé‚£ä¹ˆå­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚ä½•è®¾ç½®å®šæ—¶åŒæ­¥çš„ç­–ç•¥</li>
    </ul>
  </li>
</ul>

<h4 id="æ¶ˆæ¯ç¡®è®¤ä¸è¿”å›">æ¶ˆæ¯ç¡®è®¤ä¸è¿”å›</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼š
    <ul>
      <li>æ¶ˆæ¯çš„ç¡®è®¤æ˜¯æŒ‡ç”Ÿäº§è€…æŠ•é€’æ¶ˆæ¯åï¼Œå¦‚æœå®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼Œåˆ™ä¼šç»™ç”Ÿäº§ç«¯ä¸€ä¸ªåº”ç­”</li>
      <li>ç”Ÿäº§ç«¯è¿›è¡Œæ¥æ”¶åº”ç­”ï¼Œç”¨æ¥ç¡®å®šè¿™æ¡æ¶ˆæ¯æ˜¯å¦æ­£å¸¸çš„å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ˜¯æ¶ˆæ¯çš„å¯é æ€§æŠ•é€’çš„æ ¸å¿ƒä¿éšœ</li>
      <li><img src="https://i.loli.net/2020/08/08/YCsJmaoZGkWPLTt.png" alt="image.png" /></li>
    </ul>
  </li>
  <li>å¦‚ä½•å®ç°Confirmç¡®è®¤æ¶ˆæ¯ï¼Ÿ
    <ul>
      <li>ç¬¬ä¸€æ­¥ï¼Œåœ¨channelä¸Šå¼€å¯ç¡®è®¤æ¨¡å¼ï¼šchannel.confirmSelect()</li>
      <li>ç¬¬äºŒæ­¥ï¼Œåœ¨channelä¸Šæ·»åŠ ç›‘å¬ï¼šaddConfirmListenerï¼Œç›‘å¬æˆåŠŸå’Œå¤±è´¥çš„è¿”å›ç»“æœï¼Œæ ¹æ®å…·ä½“çš„ç»“æœå¯¹æ¶ˆæ¯è¿›è¡Œé‡æ–°å‘é€ï¼Œæˆ–è€…è®°å½•æ—¥å¿—ç­‰åç»­å¤„ç†</li>
    </ul>
  </li>
  <li>confirmç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="c1">//1 åˆ›å»ºConnectionFactory</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 è·å–C   onnection</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         
         <span class="c1">//3 é€šè¿‡Connectionåˆ›å»ºä¸€ä¸ªæ–°çš„Channel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         
         <span class="c1">//4 æŒ‡å®šæˆ‘ä»¬çš„æ¶ˆæ¯æŠ•é€’æ¨¡å¼: æ¶ˆæ¯çš„ç¡®è®¤æ¨¡å¼ </span>
         <span class="n">channel</span><span class="o">.</span><span class="na">confirmSelect</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_confirm_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"confirm.save"</span><span class="o">;</span>
         
         <span class="c1">//5 å‘é€ä¸€æ¡æ¶ˆæ¯</span>
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ Send confirm message!"</span><span class="o">;</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         
         <span class="c1">//6 æ·»åŠ ä¸€ä¸ªç¡®è®¤ç›‘å¬</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">addConfirmListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConfirmListener</span><span class="o">()</span> <span class="o">{</span>
             <span class="nd">@Override</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleNack</span><span class="o">(</span><span class="kt">long</span> <span class="n">deliveryTag</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">multiple</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------no ack!-----------"</span><span class="o">);</span>
             <span class="o">}</span>
             
             <span class="nd">@Override</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleAck</span><span class="o">(</span><span class="kt">long</span> <span class="n">deliveryTag</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">multiple</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                 <span class="c1">//æˆåŠŸ</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------ack!-----------"</span><span class="o">);</span>
             <span class="o">}</span>
         <span class="o">});</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>confirmæ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="c1">//1 åˆ›å»ºConnectionFactory</span>
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="c1">//2 è·å–Connection</span>
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         
         <span class="c1">//3 é€šè¿‡Connectionåˆ›å»ºä¸€ä¸ªæ–°çš„Channel</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_confirm_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"confirm.#"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_confirm_queue"</span><span class="o">;</span>
         
         <span class="c1">//4 å£°æ˜äº¤æ¢æœºå’Œé˜Ÿåˆ— ç„¶åè¿›è¡Œç»‘å®šè®¾ç½®, æœ€ååˆ¶å®šè·¯ç”±Key</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="c1">//5 åˆ›å»ºæ¶ˆè´¹è€… </span>
         <span class="nc">QueueingConsumer</span> <span class="n">queueingConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">queueingConsumer</span><span class="o">);</span>
         
         <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
             <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">queueingConsumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
             
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹ç«¯: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>returnï¼šæ¶ˆæ¯è¿”å›</li>
  <li>return Listenerç”¨äºå¤„ç†ä¸€äº›ä¸å¯è·¯ç”±çš„æ¶ˆæ¯</li>
  <li>æˆ‘ä»¬çš„æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œé€šè¿‡æŒ‡å®šä¸€ä¸ªExchangeå’ŒRoutingkeyï¼ŒæŠŠæ¶ˆæ¯é€è¾¾åˆ°æŸä¸€ä¸ªé˜Ÿåˆ—ä¸­å»ï¼Œç„¶åæˆ‘ä»¬çš„æ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—ï¼Œè¿›è¡Œæ¶ˆæ¯å¤„ç†æ“ä½œ</li>
  <li>ä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå½“å‰çš„exchangeä¸å­˜åœ¨æˆ–è€…æŒ‡å®šçš„è·¯ç”±keyè·¯ç”±ä¸åˆ°ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬éœ€è¦ç›‘å¬è¿™ç§ä¸å¯è¾¾çš„æ¶ˆæ¯ï¼Œå°±è¦ä½¿ç”¨return Listener</li>
  <li>å…³é”®é…ç½®é¡¹Mandatoryï¼šå¦‚æœä¸ºtrueï¼Œåˆ™ç›‘å¬å™¨ä¼šæ¥æ”¶åˆ°è·¯ç”±ä¸å¯è¾¾çš„æ¶ˆæ¯ï¼Œç„¶åè¿›è¡Œåç»­å¤„ç†ï¼Œå¦‚æœä¸ºfalseï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯è‡ªåŠ¨åˆ é™¤è¯¥æ¶ˆæ¯</li>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchange</span> <span class="o">=</span> <span class="s">"test_return_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"return.save"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKeyError</span> <span class="o">=</span> <span class="s">"abc.save"</span><span class="o">;</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ Return Message"</span><span class="o">;</span>
         
         
         <span class="n">channel</span><span class="o">.</span><span class="na">addReturnListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ReturnListener</span><span class="o">()</span> <span class="o">{</span>
             <span class="nd">@Override</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleReturn</span><span class="o">(</span><span class="kt">int</span> <span class="n">replyCode</span><span class="o">,</span> <span class="nc">String</span> <span class="n">replyText</span><span class="o">,</span> <span class="nc">String</span> <span class="n">exchange</span><span class="o">,</span>
                      <span class="nc">String</span> <span class="n">routingKey</span><span class="o">,</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
                 
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---------handle  return----------"</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"replyCode: "</span> <span class="o">+</span> <span class="n">replyCode</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"replyText: "</span> <span class="o">+</span> <span class="n">replyText</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"exchange: "</span> <span class="o">+</span> <span class="n">exchange</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"routingKey: "</span> <span class="o">+</span> <span class="n">routingKey</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"properties: "</span> <span class="o">+</span> <span class="n">properties</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"body: "</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
             <span class="o">}</span>
         <span class="o">});</span>
         
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">routingKeyError</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         
         <span class="c1">//channel.basicPublish(exchange, routingKeyError, true, null, msg.getBytes());</span>
    
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
 
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_return_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"return.#"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_return_queue"</span><span class="o">;</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="nc">QueueingConsumer</span> <span class="n">queueingConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">QueueingConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">queueingConsumer</span><span class="o">);</span>
         
         <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
             
             <span class="nc">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">queueingConsumer</span><span class="o">.</span><span class="na">nextDelivery</span><span class="o">();</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">delivery</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹è€…: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
         <span class="o">}</span>
 
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="è‡ªå®šä¹‰æ¶ˆè´¹è€…">è‡ªå®šä¹‰æ¶ˆè´¹è€…</h4>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchange</span> <span class="o">=</span> <span class="s">"test_consumer_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"consumer.save"</span><span class="o">;</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ Consumer Message"</span><span class="o">;</span>
         
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>
 

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_consumer_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"consumer.#"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_consumer_queue"</span><span class="o">;</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MyConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è‡ªå®šä¹‰æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConsumer</span> <span class="kd">extends</span> <span class="nc">DefaultConsumer</span> <span class="o">{</span>
 
 
    <span class="kd">public</span> <span class="nf">MyConsumer</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleDelivery</span><span class="o">(</span><span class="nc">String</span> <span class="n">consumerTag</span><span class="o">,</span> <span class="nc">Envelope</span> <span class="n">envelope</span><span class="o">,</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------consume message----------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"consumerTag: "</span> <span class="o">+</span> <span class="n">consumerTag</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"envelope: "</span> <span class="o">+</span> <span class="n">envelope</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"properties: "</span> <span class="o">+</span> <span class="n">properties</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"body: "</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
    <span class="o">}</span>
 
 
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯é™æµ">æ¶ˆæ¯é™æµ</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é™æµï¼Ÿ
    <ul>
      <li>å‡è®¾ä¸€ä¸ªåœºæ™¯ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬rabbitMQæœåŠ¡å™¨æœ‰ä¸Šä¸‡æ¡æœªå¤„ç†çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬éšä¾¿æ‰“å¼€ä¸€ä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œå°±ä¼šç¬é—´æœ‰å·¨é‡çš„æ¶ˆæ¯å…¨éƒ¨æ¨é€è¿‡æ¥ï¼Œä½†æ˜¯æˆ‘ä»¬å•ä¸ªå®¢æˆ·ç«¯æ— æ³•åŒæ—¶å¤„ç†è¿™ä¹ˆå¤šæ•°æ®</li>
    </ul>
  </li>
  <li>rabbitMQæä¾›äº†ä¸€ç§qosï¼ˆæœåŠ¡è´¨é‡ä¿è¯ï¼‰åŠŸèƒ½ï¼Œå³åœ¨éè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯çš„å‰æä¸‹ï¼Œå¦‚æœä¸€å®šæ•°ç›®çš„æ¶ˆæ¯ï¼ˆé€šè¿‡åŸºäºconsumeræˆ–è€…channelè®¾ç½®qosçš„å€¼ï¼‰æœªè¢«ç¡®è®¤å‰ï¼Œä¸è¿›è¡Œæ¶ˆè´¹æ–°çš„æ¶ˆæ¯</li>
  <li>æ–¹æ³•ï¼švoid BasicQos(uint prefetchSize,ushort prefetchCount,bool global)ï¼›
    <ul>
      <li>prefetchSizeï¼š0</li>
      <li>prefetchCountï¼šä¼šå‘Šè¯‰MQä¸è¦åŒæ—¶ç»™ä¸€ä¸ªæ¶ˆè´¹è€…æ¨é€å¤šäºNä¸ªæ¶ˆæ¯ï¼Œå³ä¸€æ—¦æœ‰Nä¸ªæ¶ˆæ¯è¿˜æ²¡æœ‰ackï¼Œåˆ™è¯¥consumerå°†blockæ‰ï¼Œç›´åˆ°æœ‰æ¶ˆæ¯ack</li>
      <li>globalï¼štrue\false ä»¥ä¸Šé™åˆ¶æ˜¯channelçº§åˆ«çš„è¿˜æ˜¯consumerçº§åˆ«</li>
    </ul>
  </li>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchange</span> <span class="o">=</span> <span class="s">"test_qos_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"qos.save"</span><span class="o">;</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ QOS Message"</span><span class="o">;</span>
         
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_qos_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_qos_queue"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"qos.#"</span><span class="o">;</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="c1">//1 é™æµæ–¹å¼  ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ autoAckè®¾ç½®ä¸º false</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicQos</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MyConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">));</span>
         
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConsumer</span> <span class="kd">extends</span> <span class="nc">DefaultConsumer</span> <span class="o">{</span>
 
 
    <span class="kd">private</span> <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">MyConsumer</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
         <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleDelivery</span><span class="o">(</span><span class="nc">String</span> <span class="n">consumerTag</span><span class="o">,</span> <span class="nc">Envelope</span> <span class="n">envelope</span><span class="o">,</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------consume message----------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"consumerTag: "</span> <span class="o">+</span> <span class="n">consumerTag</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"envelope: "</span> <span class="o">+</span> <span class="n">envelope</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"properties: "</span> <span class="o">+</span> <span class="n">properties</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"body: "</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicAck</span><span class="o">(</span><span class="n">envelope</span><span class="o">.</span><span class="na">getDeliveryTag</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
         
    <span class="o">}</span>
 
 
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯çš„ackå’Œnack">æ¶ˆæ¯çš„ACKå’ŒNACK</h4>

<ul>
  <li>æ¶ˆè´¹ç«¯çš„æ‰‹å·¥ACKå’ŒNACK</li>
  <li>æ¶ˆè´¹ç«¯è¿›è¡Œæ¶ˆè´¹çš„æ—¶å€™ï¼Œå¦‚æœç”±äºä¸šåŠ¡å¼‚å¸¸æˆ‘ä»¬å¯ä»¥è¿›è¡Œæ—¥å¿—çš„è®°å½•ï¼Œç„¶åè¿›è¡Œè¡¥å¿ï¼</li>
  <li>å¦‚æœç”±äºæœåŠ¡å™¨å®•æœºç­‰ä¸¥é‡é—®é¢˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦æ‰‹å·¥è¿›è¡ŒACKä¿éšœæ¶ˆè´¹ç«¯æ¶ˆè´¹æˆåŠŸã€‚</li>
  <li>æ¶ˆè´¹ç«¯çš„é‡å›é˜Ÿåˆ—</li>
  <li>æ¶ˆè´¹ç«¯é‡å›é˜Ÿåˆ—æ˜¯ä¸ºäº†å¯¹æ²¡æœ‰å¤„ç†æˆåŠŸçš„æ¶ˆæ¯ï¼ŒæŠŠæ¶ˆæ¯é‡æ–°æŠ•é€’ç»™Broker</li>
  <li>ä¸€èˆ¬å®é™…åº”ç”¨ä¸­ï¼Œéƒ½ä¼šå…³é—­é‡å›é˜Ÿåˆ—ï¼Œè®¾ç½®ä¸ºfalse</li>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchange</span> <span class="o">=</span> <span class="s">"test_ack_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"ack.save"</span><span class="o">;</span>
    
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
             <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
             <span class="n">headers</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"num"</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
             
             <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">deliveryMode</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">contentEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">headers</span><span class="o">(</span><span class="n">headers</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
             <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ ACK Message "</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">properties</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>æ¶ˆè´¹è€…</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
 
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_ack_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_ack_queue"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"ack.#"</span><span class="o">;</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="c1">// æ‰‹å·¥ç­¾æ”¶ å¿…é¡»è¦å…³é—­ autoAck = false</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MyConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">));</span>
         
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConsumer</span> <span class="kd">extends</span> <span class="nc">DefaultConsumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">MyConsumer</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
         <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleDelivery</span><span class="o">(</span><span class="nc">String</span> <span class="n">consumerTag</span><span class="o">,</span> <span class="nc">Envelope</span> <span class="n">envelope</span><span class="o">,</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------consume message----------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"body: "</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
         <span class="k">if</span><span class="o">((</span><span class="nc">Integer</span><span class="o">)</span><span class="n">properties</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"num"</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
             <span class="c1">// å½“num=0æ—¶ï¼ŒæŠŠæ¶ˆæ¯æ”¾åˆ°é‡å›é˜Ÿåˆ—å°¾ç«¯</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicNack</span><span class="o">(</span><span class="n">envelope</span><span class="o">.</span><span class="na">getDeliveryTag</span><span class="o">(),</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
             <span class="c1">// æ­£å¸¸æ¶ˆè´¹</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicAck</span><span class="o">(</span><span class="n">envelope</span><span class="o">.</span><span class="na">getDeliveryTag</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ttlæ¶ˆæ¯">TTLæ¶ˆæ¯</h4>

<ul>
  <li>TTLæ˜¯time to liveçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå­˜æ—¶é—´</li>
  <li>rabbitMQæ”¯æŒæ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨æ¶ˆæ¯å‘é€æ—¶å¯ä»¥è¿›è¡ŒæŒ‡å®š</li>
  <li>rabbitMQæ”¯æŒé˜Ÿåˆ—çš„è¿‡æœŸæ—¶é—´ï¼Œä»æ¶ˆæ¯å…¥é˜Ÿåˆ—å¼€å§‹è®¡ç®—ï¼Œåªè¦è¶…è¿‡äº†é˜Ÿåˆ—çš„è¶…æ—¶æ—¶é—´é…ç½®ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¼šè‡ªåŠ¨çš„æ¸…é™¤</li>
</ul>

<h4 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</h4>

<ul>
  <li>æ­»ä¿¡é˜Ÿåˆ—ï¼šDLXï¼ŒDead-Letter-Exchange</li>
  <li>åˆ©ç”¨DLXï¼Œå½“æ¶ˆæ¯åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­å˜æˆæ­»ä¿¡ä¹‹åï¼Œå®ƒèƒ½è¢«é‡æ–°publishåˆ°å¦ä¸€ä¸ªExchangeï¼Œè¿™ä¸ªExchangeå°±æ˜¯DLX</li>
  <li>æ¶ˆæ¯å˜æˆæ­»ä¿¡çš„å‡ ç§æƒ…å†µï¼š
    <ul>
      <li>æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆbasic.reject/basic.nackï¼‰å¹¶ä¸”requeue=false</li>
      <li>æ¶ˆæ¯TTLè¿‡æœŸ</li>
      <li>é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦</li>
    </ul>
  </li>
  <li>DLXä¹Ÿæ˜¯ä¸€ä¸ªæ­£å¸¸çš„Exchangeï¼Œå’Œä¸€èˆ¬çš„Exchangeæ²¡æœ‰åŒºåˆ«ï¼Œå®ƒèƒ½åœ¨ä»»ä½•çš„é˜Ÿåˆ—ä¸Šè¢«æŒ‡å®šï¼Œå®é™…ä¸Šå°±æ˜¯è®¾ç½®æŸä¸ªé˜Ÿåˆ—çš„å±æ€§</li>
  <li>å½“è¿™ä¸ªé˜Ÿåˆ—ä¸­æœ‰æ­»ä¿¡æ—¶ï¼ŒMQå°±è‡ªåŠ¨çš„å°†è¿™ä¸ªæ¶ˆæ¯é‡æ–°å‘å¸ƒåˆ°è®¾ç½®çš„Exchangeä¸Šå»ï¼Œè¿›è€Œè¢«è·¯ç”±åˆ°å¦ä¸€ä¸ªé˜Ÿåˆ—</li>
  <li>å¯ä»¥ç›‘å¬è¿™ä¸ªé˜Ÿåˆ—ä¸­æ¶ˆæ¯åšç›¸åº”çš„å¤„ç†ï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥å¼¥è¡¥MQ3.0ä»¥å‰æ”¯æŒçš„immediateå‚æ•°çš„åŠŸèƒ½</li>
  <li>æ­»ä¿¡é˜Ÿåˆ—è®¾ç½®
    <ul>
      <li>é¦–å…ˆéœ€è¦è®¾ç½®æ­»ä¿¡é˜Ÿåˆ—çš„exchangeå’Œqueueï¼Œç„¶åè¿›è¡Œç»‘å®š</li>
      <li>ç„¶åæˆ‘ä»¬è¿›è¡Œæ­£å¸¸å£°æ˜äº¤æ¢æœºï¼Œé˜Ÿåˆ—ï¼Œç»‘å®šï¼Œåªä¸è¿‡æˆ‘ä»¬éœ€è¦åœ¨é˜Ÿåˆ—ä¸ŠåŠ ä¸€ä¸ªå‚æ•°ï¼š<code class="language-plaintext highlighter-rouge">arguments.put("x-dead-letter-exchange","dlx.exchange")</code></li>
      <li>è¿™æ ·æ¶ˆæ¯åœ¨è¿‡æœŸï¼Œrequeueï¼Œé˜Ÿåˆ—åœ¨è¾¾åˆ°æœ€å¤§é•¿åº¦æ—¶ï¼Œæ¶ˆæ¯å°±å¯ä»¥ç›´æ¥è·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—</li>
    </ul>
  </li>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Producer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="nc">String</span> <span class="n">exchange</span> <span class="o">=</span> <span class="s">"test_dlx_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"dlx.save"</span><span class="o">;</span>
         
         <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="s">"Hello RabbitMQ DLX Message"</span><span class="o">;</span>
         
         <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
             
             <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
                      <span class="o">.</span><span class="na">deliveryMode</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">contentEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)</span>
                      <span class="o">.</span><span class="na">expiration</span><span class="o">(</span><span class="s">"10000"</span><span class="o">)</span>  <span class="c1">//æ¶ˆæ¯è¿‡æœŸåä¼šè½¬å…¥æ­»ä¿¡é˜Ÿåˆ—</span>
                      <span class="o">.</span><span class="na">build</span><span class="o">();</span>
             <span class="n">channel</span><span class="o">.</span><span class="na">basicPublish</span><span class="o">(</span><span class="n">exchange</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">properties</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
         <span class="o">}</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>æ¶ˆè´¹è€…</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>
 
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         
         <span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setHost</span><span class="o">(</span><span class="s">"192.168.11.76"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPort</span><span class="o">(</span><span class="mi">5672</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         
         <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">connectionFactory</span><span class="o">.</span><span class="na">newConnection</span><span class="o">();</span>
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createChannel</span><span class="o">();</span>
         
         <span class="c1">// è¿™å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„äº¤æ¢æœº å’Œ é˜Ÿåˆ— ä»¥åŠè·¯ç”±</span>
         <span class="nc">String</span> <span class="n">exchangeName</span> <span class="o">=</span> <span class="s">"test_dlx_exchange"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">routingKey</span> <span class="o">=</span> <span class="s">"dlx.#"</span><span class="o">;</span>
         <span class="nc">String</span> <span class="n">queueName</span> <span class="o">=</span> <span class="s">"test_dlx_queue"</span><span class="o">;</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="n">exchangeName</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         
         <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">agruments</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
         <span class="n">agruments</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"x-dead-letter-exchange"</span><span class="o">,</span> <span class="s">"dlx.exchange"</span><span class="o">);</span>
         <span class="c1">//è¿™ä¸ªagrumentså±æ€§ï¼Œè¦è®¾ç½®åˆ°å£°æ˜é˜Ÿåˆ—ä¸Š</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">agruments</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="n">exchangeName</span><span class="o">,</span> <span class="n">routingKey</span><span class="o">);</span>
         
         <span class="c1">//è¦è¿›è¡Œæ­»ä¿¡é˜Ÿåˆ—çš„å£°æ˜:</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">exchangeDeclare</span><span class="o">(</span><span class="s">"dlx.exchange"</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueDeclare</span><span class="o">(</span><span class="s">"dlx.queue"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">queueBind</span><span class="o">(</span><span class="s">"dlx.queue"</span><span class="o">,</span> <span class="s">"dlx.exchange"</span><span class="o">,</span> <span class="s">"#"</span><span class="o">);</span>
         
         <span class="n">channel</span><span class="o">.</span><span class="na">basicConsume</span><span class="o">(</span><span class="n">queueName</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MyConsumer</span><span class="o">(</span><span class="n">channel</span><span class="o">));</span>
         
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyConsumer</span> <span class="kd">extends</span> <span class="nc">DefaultConsumer</span> <span class="o">{</span>
 
 
    <span class="kd">public</span> <span class="nf">MyConsumer</span><span class="o">(</span><span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
         <span class="kd">super</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleDelivery</span><span class="o">(</span><span class="nc">String</span> <span class="n">consumerTag</span><span class="o">,</span> <span class="nc">Envelope</span> <span class="n">envelope</span><span class="o">,</span> <span class="no">AMQP</span><span class="o">.</span><span class="na">BasicProperties</span> <span class="n">properties</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------consume message----------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"consumerTag: "</span> <span class="o">+</span> <span class="n">consumerTag</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"envelope: "</span> <span class="o">+</span> <span class="n">envelope</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"properties: "</span> <span class="o">+</span> <span class="n">properties</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"body: "</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">body</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="æ•´åˆspring-amqp">æ•´åˆspring AMQP</h3>

<h4 id="rabbitadmin">RabbitAdmin</h4>

<ul>
  <li>RabbitAdminåº•å±‚å®ç°å°±æ˜¯ä»springå®¹å™¨ä¸­è·å–exchangeï¼Œbindingï¼Œroutingkeyä»¥åŠqueueçš„@Beanå£°æ˜</li>
  <li>ç„¶åä½¿ç”¨RabbitTemplateçš„executeæ–¹æ³•æ‰§è¡Œå¯¹åº”çš„å£°æ˜ï¼Œä¿®æ”¹ï¼Œåˆ é™¤ç­‰ä¸€ç³»åˆ—RabbitMQåŸºç¡€åŠŸèƒ½æ“ä½œ</li>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>com.rabbitmq<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>amqp-client<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;version&gt;</span>3.6.5<span class="nt">&lt;/version&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>config</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@ComponentScan</span><span class="o">({</span><span class="s">"com.bfxy.spring.*"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitMQConfig</span> <span class="o">{</span>
 
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ConnectionFactory</span> <span class="nf">connectionFactory</span><span class="o">(){</span>
         <span class="nc">CachingConnectionFactory</span> <span class="n">connectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CachingConnectionFactory</span><span class="o">();</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setAddresses</span><span class="o">(</span><span class="s">"192.168.11.76:5672"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"guest"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"guest"</span><span class="o">);</span>
         <span class="n">connectionFactory</span><span class="o">.</span><span class="na">setVirtualHost</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">connectionFactory</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">RabbitAdmin</span> <span class="nf">rabbitAdmin</span><span class="o">(</span><span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">RabbitAdmin</span> <span class="n">rabbitAdmin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RabbitAdmin</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">setAutoStartup</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">rabbitAdmin</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="cm">/**  
     * é’ˆå¯¹æ¶ˆè´¹è€…é…ç½®  
     * 1. è®¾ç½®äº¤æ¢æœºç±»å‹  
     * 2. å°†é˜Ÿåˆ—ç»‘å®šåˆ°äº¤æ¢æœº  
        FanoutExchange: å°†æ¶ˆæ¯åˆ†å‘åˆ°æ‰€æœ‰çš„ç»‘å®šé˜Ÿåˆ—ï¼Œæ— routingkeyçš„æ¦‚å¿µ  
        HeadersExchange ï¼šé€šè¿‡æ·»åŠ å±æ€§key-valueåŒ¹é…  
        DirectExchange:æŒ‰ç…§routingkeyåˆ†å‘åˆ°æŒ‡å®šé˜Ÿåˆ—  
        TopicExchange:å¤šå…³é”®å­—åŒ¹é…  
     */</span>  
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">TopicExchange</span> <span class="nf">exchange001</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TopicExchange</span><span class="o">(</span><span class="s">"topic001"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>  
    <span class="o">}</span>  
 
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">queue001</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="s">"queue001"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">//é˜Ÿåˆ—æŒä¹…  </span>
    <span class="o">}</span>  
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Binding</span> <span class="nf">binding001</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="nc">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue001</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange001</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="s">"spring.*"</span><span class="o">);</span>  
    <span class="o">}</span>  
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">TopicExchange</span> <span class="nf">exchange002</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">new</span> <span class="nf">TopicExchange</span><span class="o">(</span><span class="s">"topic002"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>  
    <span class="o">}</span>  
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">queue002</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="s">"queue002"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">//é˜Ÿåˆ—æŒä¹…  </span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Binding</span> <span class="nf">binding002</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="nc">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue002</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange002</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="s">"rabbit.*"</span><span class="o">);</span>  
    <span class="o">}</span> 
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Queue</span> <span class="nf">queue003</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Queue</span><span class="o">(</span><span class="s">"queue003"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span> <span class="c1">//é˜Ÿåˆ—æŒä¹…  </span>
    <span class="o">}</span>
    
    <span class="nd">@Bean</span>  
    <span class="kd">public</span> <span class="nc">Binding</span> <span class="nf">binding003</span><span class="o">()</span> <span class="o">{</span>  
        <span class="k">return</span> <span class="nc">BindingBuilder</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">queue003</span><span class="o">()).</span><span class="na">to</span><span class="o">(</span><span class="n">exchange001</span><span class="o">()).</span><span class="na">with</span><span class="o">(</span><span class="s">"mq.*"</span><span class="o">);</span>  
    <span class="o">}</span>

</code></pre></div></div>

<p>æµ‹è¯•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationTests</span> <span class="o">{</span>
 
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
    
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RabbitAdmin</span> <span class="n">rabbitAdmin</span><span class="o">;</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testAdmin</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareExchange</span><span class="o">(</span><span class="k">new</span> <span class="nc">DirectExchange</span><span class="o">(</span><span class="s">"test.direct"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareExchange</span><span class="o">(</span><span class="k">new</span> <span class="nc">TopicExchange</span><span class="o">(</span><span class="s">"test.topic"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareExchange</span><span class="o">(</span><span class="k">new</span> <span class="nc">FanoutExchange</span><span class="o">(</span><span class="s">"test.fanout"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareQueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Queue</span><span class="o">(</span><span class="s">"test.direct.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareQueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Queue</span><span class="o">(</span><span class="s">"test.topic.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareQueue</span><span class="o">(</span><span class="k">new</span> <span class="nc">Queue</span><span class="o">(</span><span class="s">"test.fanout.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareBinding</span><span class="o">(</span><span class="k">new</span> <span class="nc">Binding</span><span class="o">(</span><span class="s">"test.direct.queue"</span><span class="o">,</span>
                 <span class="nc">Binding</span><span class="o">.</span><span class="na">DestinationType</span><span class="o">.</span><span class="na">QUEUE</span><span class="o">,</span>
                 <span class="s">"test.direct"</span><span class="o">,</span> <span class="s">"direct"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;()));</span>
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareBinding</span><span class="o">(</span>
                 <span class="nc">BindingBuilder</span>
                 <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">Queue</span><span class="o">(</span><span class="s">"test.topic.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>         <span class="c1">//ç›´æ¥åˆ›å»ºé˜Ÿåˆ—</span>
                 <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="nc">TopicExchange</span><span class="o">(</span><span class="s">"test.topic"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="c1">//ç›´æ¥åˆ›å»ºäº¤æ¢æœº å»ºç«‹å…³è”å…³ç³»</span>
                 <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">"user.#"</span><span class="o">));</span>   <span class="c1">//æŒ‡å®šè·¯ç”±Key</span>
         
         
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">declareBinding</span><span class="o">(</span>
                 <span class="nc">BindingBuilder</span>
                 <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">Queue</span><span class="o">(</span><span class="s">"test.fanout.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span>      
                 <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="k">new</span> <span class="nc">FanoutExchange</span><span class="o">(</span><span class="s">"test.fanout"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">false</span><span class="o">)));</span>
         
         <span class="c1">//æ¸…ç©ºé˜Ÿåˆ—æ•°æ®</span>
         <span class="n">rabbitAdmin</span><span class="o">.</span><span class="na">purgeQueue</span><span class="o">(</span><span class="s">"test.topic.queue"</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯ç›‘å¬å™¨">æ¶ˆæ¯ç›‘å¬å™¨</h4>

<ul>
  <li>SimpleMessageListenerContainerï¼šç®€å•æ¶ˆæ¯ç›‘å¬å®¹å™¨ï¼Œæœ‰ç›‘å¬é˜Ÿåˆ—ï¼Œè‡ªåŠ¨å¯åŠ¨ï¼Œè‡ªåŠ¨å£°æ˜åŠŸèƒ½ã€‚è®¾ç½®äº‹åŠ¡ç‰¹æ€§ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼Œäº‹åŠ¡å±æ€§ï¼Œäº‹åŠ¡å®¹é‡ï¼ˆå¹¶å‘ï¼‰ï¼Œæ˜¯å¦å¼€å¯äº‹åŠ¡ï¼Œå›æ»šæ¶ˆæ¯ç­‰</li>
  <li>é…ç½®</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleMessageListenerContainer</span> <span class="nf">messageContainer</span><span class="o">(</span><span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
    
    <span class="nc">SimpleMessageListenerContainer</span> <span class="n">container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleMessageListenerContainer</span><span class="o">(</span><span class="n">connectionFactory</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setQueues</span><span class="o">(</span><span class="n">queue001</span><span class="o">(),</span> <span class="n">queue002</span><span class="o">(),</span> <span class="n">queue003</span><span class="o">(),</span> <span class="n">queue_image</span><span class="o">(),</span> <span class="n">queue_pdf</span><span class="o">());</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setConcurrentConsumers</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setMaxConcurrentConsumers</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setDefaultRequeueRejected</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setAcknowledgeMode</span><span class="o">(</span><span class="nc">AcknowledgeMode</span><span class="o">.</span><span class="na">AUTO</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setExposeListenerChannel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="n">container</span><span class="o">.</span><span class="na">setConsumerTagStrategy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ConsumerTagStrategy</span><span class="o">()</span> <span class="o">{</span>
             <span class="nd">@Override</span>
             <span class="kd">public</span> <span class="nc">String</span> <span class="nf">createConsumerTag</span><span class="o">(</span><span class="nc">String</span> <span class="n">queue</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">return</span> <span class="n">queue</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
             <span class="o">}</span>
         <span class="o">});</span>
    
    <span class="n">container</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChannelAwareMessageListener</span><span class="o">()</span> <span class="o">{</span>
             <span class="nd">@Override</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                 <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"----------æ¶ˆè´¹è€…: "</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
             <span class="o">}</span>
         <span class="o">});</span>
   <span class="err">ï½</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯ç›‘å¬é€‚é…å™¨">æ¶ˆæ¯ç›‘å¬é€‚é…å™¨</h4>

<ul>
  <li>MessageListenerAdapterï¼šæ¶ˆæ¯ç›‘å¬é€‚é…å™¨</li>
  <li>é€šè¿‡é€‚é…å™¨çš„ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå¦‚ä¸‹æ ¸å¿ƒå±æ€§</li>
  <li>defaultListenerMethod é»˜è®¤ç›‘å¬æ–¹æ³•åç§°ï¼šç”¨äºè®¾ç½®ç›‘å¬æ–¹æ³•åç§°</li>
  <li>Delegate å§”æ‰˜å¯¹è±¡ï¼šå®é™…çœŸå®çš„å§”æ‰˜å¯¹è±¡ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯</li>
  <li>queueOrTagMethodName é˜Ÿåˆ—æ ‡è¯†ä¸æ–¹æ³•åç»„æˆçš„é›†åˆ</li>
  <li>é…ç½®</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleMessageListenerContainer</span> <span class="nf">messageContainer</span><span class="o">(</span><span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
<span class="cm">/**
    * 1 é€‚é…å™¨æ–¹å¼. é»˜è®¤æ˜¯æœ‰è‡ªå·±çš„æ–¹æ³•åå­—çš„ï¼šhandleMessage
         // å¯ä»¥è‡ªå·±æŒ‡å®šä¸€ä¸ªæ–¹æ³•çš„åå­—: consumeMessage
         // ä¹Ÿå¯ä»¥æ·»åŠ ä¸€ä¸ªè½¬æ¢å™¨: ä»å­—èŠ‚æ•°ç»„è½¬æ¢ä¸ºString
    MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
    adapter.setDefaultListenerMethod("consumeMessage");
    adapter.setMessageConverter(new TextMessageConverter());
    container.setMessageListener(adapter);
    */</span>
    
    <span class="cm">/**
    * 2 é€‚é…å™¨æ–¹å¼: æˆ‘ä»¬çš„é˜Ÿåˆ—åç§° å’Œ æ–¹æ³•åç§° ä¹Ÿå¯ä»¥è¿›è¡Œä¸€ä¸€çš„åŒ¹é…
    * 
    MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
    adapter.setMessageConverter(new TextMessageConverter());
    Map&lt;String, String&gt; queueOrTagToMethodName = new HashMap&lt;&gt;();
    queueOrTagToMethodName.put("queue001", "method1");
    queueOrTagToMethodName.put("queue002", "method2");
    adapter.setQueueOrTagToMethodName(queueOrTagToMethodName);
    container.setMessageListener(adapter);     
    */</span>
    <span class="k">return</span> <span class="n">container</span><span class="o">;</span>
<span class="err">ï½</span>

</code></pre></div></div>

<p>adapter</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageDelegate</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é»˜è®¤æ–¹æ³•, æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">messageBody</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­—èŠ‚æ•°ç»„æ–¹æ³•, æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">messageBody</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nc">String</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­—ç¬¦ä¸²æ–¹æ³•, æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="n">messageBody</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(</span><span class="nc">String</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"method1 æ”¶åˆ°æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">messageBody</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(</span><span class="nc">String</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"method2 æ”¶åˆ°æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">messageBody</span><span class="o">));</span>
    <span class="o">}</span>
    
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nc">Map</span> <span class="n">messageBody</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"mapæ–¹æ³•, æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="n">messageBody</span><span class="o">);</span>
    <span class="o">}</span>
    
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"orderå¯¹è±¡, æ¶ˆæ¯å†…å®¹, id: "</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> 
                 <span class="s">", name: "</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> 
                 <span class="s">", content: "</span><span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nc">Packaged</span> <span class="n">pack</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"packageå¯¹è±¡, æ¶ˆæ¯å†…å®¹, id: "</span> <span class="o">+</span> <span class="n">pack</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> 
                 <span class="s">", name: "</span> <span class="o">+</span> <span class="n">pack</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> 
                 <span class="s">", content: "</span><span class="o">+</span> <span class="n">pack</span><span class="o">.</span><span class="na">getDescription</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">consumeMessage</span><span class="o">(</span><span class="nc">File</span> <span class="n">file</span><span class="o">)</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ–‡ä»¶å¯¹è±¡ æ–¹æ³•, æ¶ˆæ¯å†…å®¹:"</span> <span class="o">+</span> <span class="n">file</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯è½¬æ¢å™¨">æ¶ˆæ¯è½¬æ¢å™¨</h4>

<ul>
  <li>MessageConverter</li>
  <li>æˆ‘ä»¬åœ¨å‘é€æ¶ˆæ¯æ—¶ï¼Œé»˜è®¤æ¶ˆæ¯ä½“ä¸ºäºŒè¿›åˆ¶çš„æ•°æ®æ–¹å¼è¿›è¡Œä¼ è¾“ï¼Œå¦‚æœå¸Œæœ›å†…éƒ¨è¿›è¡Œè½¬æ¢ï¼Œå°±éœ€è¦è‡ªå®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</li>
  <li>éœ€è¦å®ç°MessageConverteræ¥å£ï¼Œé‡å†™toMessageï¼ˆjavaå¯¹è±¡è½¬æ¢ä¸ºmessageï¼‰å’ŒfromMessageï¼ˆmessageå¯¹è±¡è½¬æ¢ä¸ºjavaå¯¹è±¡ï¼‰ä¸¤ä¸ªæ–¹æ³•</li>
  <li>jsonè½¬æ¢å™¨ï¼šJackson2JsonMessageConverterï¼šå¯ä»¥è¿›è¡Œjavaå¯¹è±¡çš„è½¬æ¢åŠŸèƒ½</li>
  <li>DegaultJackson2JavaTypeMapperï¼šæ˜ å°„å™¨ï¼Œå¯ä»¥è¿›è¡Œjavaå¯¹è±¡çš„æ˜ å°„å…³ç³»</li>
  <li>è‡ªå®šä¹‰äºŒè¿›åˆ¶è½¬æ¢å™¨ï¼šæ¯”å¦‚å›¾ç‰‡ç±»å‹ï¼ŒPDFï¼ŒPPTï¼Œæµåª’ä½“</li>
  <li>é…ç½®</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SimpleMessageListenerContainer</span> <span class="nf">messageContainer</span><span class="o">(</span><span class="nc">ConnectionFactory</span> <span class="n">connectionFactory</span><span class="o">)</span> <span class="o">{</span>
<span class="c1">// 1.1 æ”¯æŒjsonæ ¼å¼çš„è½¬æ¢å™¨</span>
        <span class="cm">/**
        MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
        adapter.setDefaultListenerMethod("consumeMessage");
        
        Jackson2JsonMessageConverter jackson2JsonMessageConverter = new Jackson2JsonMessageConverter();
        adapter.setMessageConverter(jackson2JsonMessageConverter);
        
        container.setMessageListener(adapter);
        */</span>
    
        
        
        <span class="c1">// 1.2 DefaultJackson2JavaTypeMapper &amp; Jackson2JsonMessageConverter æ”¯æŒjavaå¯¹è±¡è½¬æ¢</span>
        <span class="cm">/**
        MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
        adapter.setDefaultListenerMethod("consumeMessage");
        
        Jackson2JsonMessageConverter jackson2JsonMessageConverter = new Jackson2JsonMessageConverter();
        
        DefaultJackson2JavaTypeMapper javaTypeMapper = new DefaultJackson2JavaTypeMapper();
        jackson2JsonMessageConverter.setJavaTypeMapper(javaTypeMapper);
        
        adapter.setMessageConverter(jackson2JsonMessageConverter);
        container.setMessageListener(adapter);
        */</span>
        
        
        <span class="c1">//1.3 DefaultJackson2JavaTypeMapper &amp; Jackson2JsonMessageConverter æ”¯æŒjavaå¯¹è±¡å¤šæ˜ å°„è½¬æ¢</span>
        <span class="cm">/**
        MessageListenerAdapter adapter = new MessageListenerAdapter(new MessageDelegate());
        adapter.setDefaultListenerMethod("consumeMessage");
        Jackson2JsonMessageConverter jackson2JsonMessageConverter = new Jackson2JsonMessageConverter();
        DefaultJackson2JavaTypeMapper javaTypeMapper = new DefaultJackson2JavaTypeMapper();
        
        Map&lt;String, Class&lt;?&gt;&gt; idClassMapping = new HashMap&lt;String, Class&lt;?&gt;&gt;();
         idClassMapping.put("order", com.bfxy.spring.entity.Order.class);
         idClassMapping.put("packaged", com.bfxy.spring.entity.Packaged.class);
         
         javaTypeMapper.setIdClassMapping(idClassMapping);
         
         jackson2JsonMessageConverter.setJavaTypeMapper(javaTypeMapper);
        adapter.setMessageConverter(jackson2JsonMessageConverter);
        container.setMessageListener(adapter);
        */</span>
        
        <span class="c1">//1.4 ext convert</span>
        
        <span class="nc">MessageListenerAdapter</span> <span class="n">adapter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageListenerAdapter</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageDelegate</span><span class="o">());</span>
        <span class="n">adapter</span><span class="o">.</span><span class="na">setDefaultListenerMethod</span><span class="o">(</span><span class="s">"consumeMessage"</span><span class="o">);</span>
        
        <span class="c1">//å…¨å±€çš„è½¬æ¢å™¨:</span>
         <span class="nc">ContentTypeDelegatingMessageConverter</span> <span class="n">convert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ContentTypeDelegatingMessageConverter</span><span class="o">();</span>
         
         <span class="nc">TextMessageConverter</span> <span class="n">textConvert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TextMessageConverter</span><span class="o">();</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"text"</span><span class="o">,</span> <span class="n">textConvert</span><span class="o">);</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"html/text"</span><span class="o">,</span> <span class="n">textConvert</span><span class="o">);</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"xml/text"</span><span class="o">,</span> <span class="n">textConvert</span><span class="o">);</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">,</span> <span class="n">textConvert</span><span class="o">);</span>
         
         <span class="nc">Jackson2JsonMessageConverter</span> <span class="n">jsonConvert</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Jackson2JsonMessageConverter</span><span class="o">();</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"json"</span><span class="o">,</span> <span class="n">jsonConvert</span><span class="o">);</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">,</span> <span class="n">jsonConvert</span><span class="o">);</span>
         
         <span class="nc">ImageMessageConverter</span> <span class="n">imageConverter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImageMessageConverter</span><span class="o">();</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"image/png"</span><span class="o">,</span> <span class="n">imageConverter</span><span class="o">);</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"image"</span><span class="o">,</span> <span class="n">imageConverter</span><span class="o">);</span>
         
         <span class="nc">PDFMessageConverter</span> <span class="n">pdfConverter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PDFMessageConverter</span><span class="o">();</span>
         <span class="n">convert</span><span class="o">.</span><span class="na">addDelegate</span><span class="o">(</span><span class="s">"application/pdf"</span><span class="o">,</span> <span class="n">pdfConverter</span><span class="o">);</span>
        
         
         <span class="n">adapter</span><span class="o">.</span><span class="na">setMessageConverter</span><span class="o">(</span><span class="n">convert</span><span class="o">);</span>
         <span class="n">container</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="n">adapter</span><span class="o">);</span>
         
    <span class="k">return</span> <span class="n">container</span><span class="o">;</span>
<span class="err">ï½</span>

</code></pre></div></div>

<p>body</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConverterBody</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ConverterBody</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nf">ConverterBody</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getBody</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">body</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setBody</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">body</span> <span class="o">=</span> <span class="n">body</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<p>image</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImageMessageConverter</span> <span class="kd">implements</span> <span class="nc">MessageConverter</span> <span class="o">{</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Message</span> <span class="nf">toMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">MessageProperties</span> <span class="n">messageProperties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">MessageConversionException</span><span class="o">(</span><span class="s">" convert error ! "</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">fromMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------Image MessageConverter----------"</span><span class="o">);</span>
         
         <span class="nc">Object</span> <span class="n">_extName</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getMessageProperties</span><span class="o">().</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"extName"</span><span class="o">);</span>
         <span class="nc">String</span> <span class="n">extName</span> <span class="o">=</span> <span class="n">_extName</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">"png"</span> <span class="o">:</span> <span class="n">_extName</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
         
         <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"d:/010_test/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s">"."</span> <span class="o">+</span> <span class="n">extName</span><span class="o">;</span>
         <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">body</span><span class="o">),</span> <span class="n">f</span><span class="o">.</span><span class="na">toPath</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">f</span><span class="o">;</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<p>pdf</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PDFMessageConverter</span> <span class="kd">implements</span> <span class="nc">MessageConverter</span> <span class="o">{</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Message</span> <span class="nf">toMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">MessageProperties</span> <span class="n">messageProperties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">MessageConversionException</span><span class="o">(</span><span class="s">" convert error ! "</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">fromMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------PDF MessageConverter----------"</span><span class="o">);</span>
         
         <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"d:/010_test/"</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s">".pdf"</span><span class="o">;</span>
         <span class="nc">File</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">path</span><span class="o">);</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="nc">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="k">new</span> <span class="nc">ByteArrayInputStream</span><span class="o">(</span><span class="n">body</span><span class="o">),</span> <span class="n">f</span><span class="o">.</span><span class="na">toPath</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">f</span><span class="o">;</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<p>text</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TextMessageConverter</span> <span class="kd">implements</span> <span class="nc">MessageConverter</span> <span class="o">{</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Message</span> <span class="nf">toMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">MessageProperties</span> <span class="n">messageProperties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">Message</span><span class="o">(</span><span class="n">object</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">messageProperties</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">fromMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">MessageConversionException</span> <span class="o">{</span>
         <span class="nc">String</span> <span class="n">contentType</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">getMessageProperties</span><span class="o">().</span><span class="na">getContentType</span><span class="o">();</span>
         <span class="k">if</span><span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">contentType</span> <span class="o">&amp;&amp;</span> <span class="n">contentType</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">"text"</span><span class="o">))</span> <span class="o">{</span>
             <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
         <span class="o">}</span>
         <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<p>æµ‹è¯•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSendJsonMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">();</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"001"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"æ¶ˆæ¯è®¢å•"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"æè¿°ä¿¡æ¯"</span><span class="o">);</span>
         <span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"order 4 json: "</span> <span class="o">+</span> <span class="n">json</span><span class="o">);</span>
         
         <span class="nc">MessageProperties</span> <span class="n">messageProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProperties</span><span class="o">();</span>
         <span class="c1">//è¿™é‡Œæ³¨æ„ä¸€å®šè¦ä¿®æ”¹contentTypeä¸º application/json</span>
         <span class="n">messageProperties</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">json</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">messageProperties</span><span class="o">);</span>
         
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"topic001"</span><span class="o">,</span> <span class="s">"spring.order"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSendJavaMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">();</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"001"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"è®¢å•æ¶ˆæ¯"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"è®¢å•æè¿°ä¿¡æ¯"</span><span class="o">);</span>
         <span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"order 4 json: "</span> <span class="o">+</span> <span class="n">json</span><span class="o">);</span>
         
         <span class="nc">MessageProperties</span> <span class="n">messageProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProperties</span><span class="o">();</span>
         <span class="c1">//è¿™é‡Œæ³¨æ„ä¸€å®šè¦ä¿®æ”¹contentTypeä¸º application/json</span>
         <span class="n">messageProperties</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
         <span class="n">messageProperties</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"__TypeId__"</span><span class="o">,</span> <span class="s">"com.bfxy.spring.entity.Order"</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">json</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">messageProperties</span><span class="o">);</span>
         
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"topic001"</span><span class="o">,</span> <span class="s">"spring.order"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSendMappingMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ObjectMapper</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ObjectMapper</span><span class="o">();</span>
         
         <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">();</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"001"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"è®¢å•æ¶ˆæ¯"</span><span class="o">);</span>
         <span class="n">order</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="s">"è®¢å•æè¿°ä¿¡æ¯"</span><span class="o">);</span>
         
         <span class="nc">String</span> <span class="n">json1</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"order 4 json: "</span> <span class="o">+</span> <span class="n">json1</span><span class="o">);</span>
         
         <span class="nc">MessageProperties</span> <span class="n">messageProperties1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProperties</span><span class="o">();</span>
         <span class="c1">//è¿™é‡Œæ³¨æ„ä¸€å®šè¦ä¿®æ”¹contentTypeä¸º application/json</span>
         <span class="n">messageProperties1</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
         <span class="n">messageProperties1</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"__TypeId__"</span><span class="o">,</span> <span class="s">"order"</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">message1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">json1</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">messageProperties1</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"topic001"</span><span class="o">,</span> <span class="s">"spring.order"</span><span class="o">,</span> <span class="n">message1</span><span class="o">);</span>
         
         <span class="nc">Packaged</span> <span class="n">pack</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Packaged</span><span class="o">();</span>
         <span class="n">pack</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="s">"002"</span><span class="o">);</span>
         <span class="n">pack</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"åŒ…è£¹æ¶ˆæ¯"</span><span class="o">);</span>
         <span class="n">pack</span><span class="o">.</span><span class="na">setDescription</span><span class="o">(</span><span class="s">"åŒ…è£¹æè¿°ä¿¡æ¯"</span><span class="o">);</span>
         
         <span class="nc">String</span> <span class="n">json2</span> <span class="o">=</span> <span class="n">mapper</span><span class="o">.</span><span class="na">writeValueAsString</span><span class="o">(</span><span class="n">pack</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"pack 4 json: "</span> <span class="o">+</span> <span class="n">json2</span><span class="o">);</span>
 
         <span class="nc">MessageProperties</span> <span class="n">messageProperties2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProperties</span><span class="o">();</span>
         <span class="c1">//è¿™é‡Œæ³¨æ„ä¸€å®šè¦ä¿®æ”¹contentTypeä¸º application/json</span>
         <span class="n">messageProperties2</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/json"</span><span class="o">);</span>
         <span class="n">messageProperties2</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="s">"__TypeId__"</span><span class="o">,</span> <span class="s">"packaged"</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">message2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">json2</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">messageProperties2</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"topic001"</span><span class="o">,</span> <span class="s">"spring.pack"</span><span class="o">,</span> <span class="n">message2</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSendExtConverterMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
<span class="c1">//          byte[] body = Files.readAllBytes(Paths.get("d:/002_books", "picture.png"));</span>
<span class="c1">//          MessageProperties messageProperties = new MessageProperties();</span>
<span class="c1">//          messageProperties.setContentType("image/png");</span>
<span class="c1">//          messageProperties.getHeaders().put("extName", "png");</span>
<span class="c1">//          Message message = new Message(body, messageProperties);</span>
<span class="c1">//          rabbitTemplate.send("", "image_queue", message);</span>
         
             <span class="kt">byte</span><span class="o">[]</span> <span class="n">body</span> <span class="o">=</span> <span class="nc">Files</span><span class="o">.</span><span class="na">readAllBytes</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"d:/002_books"</span><span class="o">,</span> <span class="s">"mysql.pdf"</span><span class="o">));</span>
             <span class="nc">MessageProperties</span> <span class="n">messageProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageProperties</span><span class="o">();</span>
             <span class="n">messageProperties</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"application/pdf"</span><span class="o">);</span>
             <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Message</span><span class="o">(</span><span class="n">body</span><span class="o">,</span> <span class="n">messageProperties</span><span class="o">);</span>
             <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">""</span><span class="o">,</span> <span class="s">"pdf_queue"</span><span class="o">,</span> <span class="n">message</span><span class="o">);</span>
    <span class="o">}</span>

</code></pre></div></div>

<h3 id="æ•´åˆspringboot">æ•´åˆspringboot</h3>

<p>pom</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h4 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h4>

<ul>
  <li>é…ç½®</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.rabbitmq.addresses</span><span class="p">=</span><span class="s">192.168.11.76:5672</span>
<span class="py">spring.rabbitmq.username</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.rabbitmq.password</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.rabbitmq.virtual-host</span><span class="p">=</span><span class="s">/</span>
<span class="py">spring.rabbitmq.connection-timeout</span><span class="p">=</span><span class="s">15000</span>
 
<span class="py">spring.rabbitmq.publisher-confirms</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.rabbitmq.publisher-returns</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.rabbitmq.template.mandatory</span><span class="p">=</span><span class="s">true</span>
</code></pre></div></div>

<p>å‘é€ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate.ConfirmCallback</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.core.RabbitTemplate.ReturnCallback</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.support.CorrelationData</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.MessageBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">com.bfxy.springboot.entity.Order</span><span class="o">;</span>
 
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitSender</span> <span class="o">{</span>
 
    <span class="c1">//è‡ªåŠ¨æ³¨å…¥RabbitTemplateæ¨¡æ¿ç±»</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RabbitTemplate</span> <span class="n">rabbitTemplate</span><span class="o">;</span>  
    
    <span class="c1">//å›è°ƒå‡½æ•°: confirmç¡®è®¤</span>
    <span class="kd">final</span> <span class="nc">ConfirmCallback</span> <span class="n">confirmCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RabbitTemplate</span><span class="o">.</span><span class="na">ConfirmCallback</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">confirm</span><span class="o">(</span><span class="nc">CorrelationData</span> <span class="n">correlationData</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">ack</span><span class="o">,</span> <span class="nc">String</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"correlationData: "</span> <span class="o">+</span> <span class="n">correlationData</span><span class="o">);</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ack: "</span> <span class="o">+</span> <span class="n">ack</span><span class="o">);</span>
             <span class="k">if</span><span class="o">(!</span><span class="n">ack</span><span class="o">){</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¼‚å¸¸å¤„ç†...."</span><span class="o">);</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">};</span>
    
    <span class="c1">//å›è°ƒå‡½æ•°: returnè¿”å›</span>
    <span class="kd">final</span> <span class="nc">ReturnCallback</span> <span class="n">returnCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RabbitTemplate</span><span class="o">.</span><span class="na">ReturnCallback</span><span class="o">()</span> <span class="o">{</span>
         <span class="nd">@Override</span>
         <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnedMessage</span><span class="o">(</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">amqp</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">Message</span> <span class="n">message</span><span class="o">,</span> <span class="kt">int</span> <span class="n">replyCode</span><span class="o">,</span> <span class="nc">String</span> <span class="n">replyText</span><span class="o">,</span>
                 <span class="nc">String</span> <span class="n">exchange</span><span class="o">,</span> <span class="nc">String</span> <span class="n">routingKey</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"return exchange: "</span> <span class="o">+</span> <span class="n">exchange</span> <span class="o">+</span> <span class="s">", routingKey: "</span> 
                 <span class="o">+</span> <span class="n">routingKey</span> <span class="o">+</span> <span class="s">", replyCode: "</span> <span class="o">+</span> <span class="n">replyCode</span> <span class="o">+</span> <span class="s">", replyText: "</span> <span class="o">+</span> <span class="n">replyText</span><span class="o">);</span>
         <span class="o">}</span>
    <span class="o">};</span>
    
    <span class="c1">//å‘é€æ¶ˆæ¯æ–¹æ³•è°ƒç”¨: æ„å»ºMessageæ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="nc">MessageHeaders</span> <span class="n">mhs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageHeaders</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="nc">MessageBuilder</span><span class="o">.</span><span class="na">createMessage</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">mhs</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">setConfirmCallback</span><span class="o">(</span><span class="n">confirmCallback</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">setReturnCallback</span><span class="o">(</span><span class="n">returnCallback</span><span class="o">);</span>
         <span class="c1">//id + æ—¶é—´æˆ³ å…¨å±€å”¯ä¸€ </span>
         <span class="nc">CorrelationData</span> <span class="n">correlationData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorrelationData</span><span class="o">(</span><span class="s">"1234567890"</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">"exchange-1"</span><span class="o">,</span> <span class="s">"springboot.abc"</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">correlationData</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">//å‘é€æ¶ˆæ¯æ–¹æ³•è°ƒç”¨: æ„å»ºè‡ªå®šä¹‰å¯¹è±¡æ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendOrder</span><span class="o">(</span><span class="nc">Order</span> <span class="n">order</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">setConfirmCallback</span><span class="o">(</span><span class="n">confirmCallback</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">setReturnCallback</span><span class="o">(</span><span class="n">returnCallback</span><span class="o">);</span>
         <span class="c1">//id + æ—¶é—´æˆ³ å…¨å±€å”¯ä¸€ </span>
         <span class="nc">CorrelationData</span> <span class="n">correlationData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorrelationData</span><span class="o">(</span><span class="s">"0987654321"</span><span class="o">);</span>
         <span class="n">rabbitTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="s">"exchange-2"</span><span class="o">,</span> <span class="s">"springboot.def"</span><span class="o">,</span> <span class="n">order</span><span class="o">,</span> <span class="n">correlationData</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<p>æµ‹è¯•</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationTests</span> <span class="o">{</span>
 
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextLoads</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
    
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RabbitSender</span> <span class="n">rabbitSender</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">SimpleDateFormat</span> <span class="n">simpleDateFormat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="o">);</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSender1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
          <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"number"</span><span class="o">,</span> <span class="s">"12345"</span><span class="o">);</span>
          <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"send_time"</span><span class="o">,</span> <span class="n">simpleDateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">()));</span>
          <span class="n">rabbitSender</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="s">"Hello RabbitMQ For Spring Boot!"</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSender2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
          <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">(</span><span class="s">"001"</span><span class="o">,</span> <span class="s">"ç¬¬ä¸€ä¸ªè®¢å•"</span><span class="o">);</span>
          <span class="n">rabbitSender</span><span class="o">.</span><span class="na">sendOrder</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆè´¹è€…">æ¶ˆè´¹è€…</h4>

<ul>
  <li>é…ç½®</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.rabbitmq.addresses</span><span class="p">=</span><span class="s">192.168.11.76:5672</span>
<span class="py">spring.rabbitmq.username</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.rabbitmq.password</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.rabbitmq.virtual-host</span><span class="p">=</span><span class="s">/</span>
<span class="py">spring.rabbitmq.connection-timeout</span><span class="p">=</span><span class="s">15000</span>
 
<span class="py">spring.rabbitmq.listener.simple.acknowledge-mode</span><span class="p">=</span><span class="s">manual</span>
<span class="py">spring.rabbitmq.listener.simple.concurrency</span><span class="p">=</span><span class="s">5</span>
<span class="py">spring.rabbitmq.listener.simple.max-concurrency</span><span class="p">=</span><span class="s">10</span>
 
<span class="py">spring.rabbitmq.listener.order.queue.name</span><span class="p">=</span><span class="s">queue-2</span>
<span class="py">spring.rabbitmq.listener.order.queue.durable</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.rabbitmq.listener.order.exchange.name</span><span class="p">=</span><span class="s">exchange-2</span>
<span class="py">spring.rabbitmq.listener.order.exchange.durable</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.rabbitmq.listener.order.exchange.type</span><span class="p">=</span><span class="s">topic</span>
<span class="py">spring.rabbitmq.listener.order.exchange.ignoreDeclarationExceptions</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.rabbitmq.listener.order.key</span><span class="p">=</span><span class="s">springboot.*</span>

</code></pre></div></div>

<p>æ¥æ”¶ç«¯</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.Exchange</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.Queue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.QueueBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.rabbit.annotation.RabbitListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.amqp.support.AmqpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.Headers</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.Payload</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">com.rabbitmq.client.Channel</span><span class="o">;</span>
 
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitReceiver</span> <span class="o">{</span>
 
    
    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">bindings</span> <span class="o">=</span> <span class="nd">@QueueBinding</span><span class="o">(</span>
             <span class="n">value</span> <span class="o">=</span> <span class="nd">@Queue</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"queue-1"</span><span class="o">,</span> 
             <span class="n">durable</span><span class="o">=</span><span class="s">"true"</span><span class="o">),</span>
             <span class="n">exchange</span> <span class="o">=</span> <span class="nd">@Exchange</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"exchange-1"</span><span class="o">,</span> 
             <span class="n">durable</span><span class="o">=</span><span class="s">"true"</span><span class="o">,</span> 
             <span class="n">type</span><span class="o">=</span> <span class="s">"topic"</span><span class="o">,</span> 
             <span class="n">ignoreDeclarationExceptions</span> <span class="o">=</span> <span class="s">"true"</span><span class="o">),</span>
             <span class="n">key</span> <span class="o">=</span> <span class="s">"springboot.*"</span>
             <span class="o">)</span>
    <span class="o">)</span>
    <span class="nd">@RabbitHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹ç«¯Payload: "</span> <span class="o">+</span> <span class="n">message</span><span class="o">.</span><span class="na">getPayload</span><span class="o">());</span>
         <span class="nc">Long</span> <span class="n">deliveryTag</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span><span class="n">message</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">AmqpHeaders</span><span class="o">.</span><span class="na">DELIVERY_TAG</span><span class="o">);</span>
         <span class="c1">//æ‰‹å·¥ACK</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicAck</span><span class="o">(</span><span class="n">deliveryTag</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    
    
    <span class="cm">/**
     * ä½¿ç”¨æ³¨è§£æ–¹å¼å¯ä»¥åœ¨å¯åŠ¨é¡¹ç›®æ—¶è‡ªåŠ¨åˆ›å»ºäº¤æ¢æœºï¼Œé˜Ÿåˆ—å’Œç»‘å®šå…³ç³»
     * @param order
     * @param channel
     * @param headers
     * @throws Exception
     */</span>
    <span class="nd">@RabbitListener</span><span class="o">(</span><span class="n">bindings</span> <span class="o">=</span> <span class="nd">@QueueBinding</span><span class="o">(</span>
             <span class="n">value</span> <span class="o">=</span> <span class="nd">@Queue</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"${spring.rabbitmq.listener.order.queue.name}"</span><span class="o">,</span> 
             <span class="n">durable</span><span class="o">=</span><span class="s">"${spring.rabbitmq.listener.order.queue.durable}"</span><span class="o">),</span>
             <span class="n">exchange</span> <span class="o">=</span> <span class="nd">@Exchange</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"${spring.rabbitmq.listener.order.exchange.name}"</span><span class="o">,</span> 
             <span class="n">durable</span><span class="o">=</span><span class="s">"${spring.rabbitmq.listener.order.exchange.durable}"</span><span class="o">,</span> 
             <span class="n">type</span><span class="o">=</span> <span class="s">"${spring.rabbitmq.listener.order.exchange.type}"</span><span class="o">,</span> 
             <span class="n">ignoreDeclarationExceptions</span> <span class="o">=</span> <span class="s">"${spring.rabbitmq.listener.order.exchange.ignoreDeclarationExceptions}"</span><span class="o">),</span>
             <span class="n">key</span> <span class="o">=</span> <span class="s">"${spring.rabbitmq.listener.order.key}"</span>
             <span class="o">)</span>
    <span class="o">)</span>
    <span class="nd">@RabbitHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOrderMessage</span><span class="o">(</span><span class="nd">@Payload</span> <span class="n">com</span><span class="o">.</span><span class="na">bfxy</span><span class="o">.</span><span class="na">springboot</span><span class="o">.</span><span class="na">entity</span><span class="o">.</span><span class="na">Order</span> <span class="n">order</span><span class="o">,</span> 
             <span class="nc">Channel</span> <span class="n">channel</span><span class="o">,</span> 
             <span class="nd">@Headers</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">headers</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------------------------------"</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹ç«¯order: "</span> <span class="o">+</span> <span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
         <span class="nc">Long</span> <span class="n">deliveryTag</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span><span class="n">headers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">AmqpHeaders</span><span class="o">.</span><span class="na">DELIVERY_TAG</span><span class="o">);</span>
         <span class="c1">//æ‰‹å·¥ACK</span>
         <span class="n">channel</span><span class="o">.</span><span class="na">basicAck</span><span class="o">(</span><span class="n">deliveryTag</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>
    
    
<span class="o">}</span>

</code></pre></div></div>

<h3 id="æ•´åˆspring-cloud">æ•´åˆspring cloud</h3>

<p>pom</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;dependencies&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span> 
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
         
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-stream-rabbit<span class="nt">&lt;/artifactId&gt;</span>
             <span class="nt">&lt;version&gt;</span>1.3.4.RELEASE<span class="nt">&lt;/version&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
             <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
             <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

</code></pre></div></div>

<h4 id="ç”Ÿäº§è€…-1">ç”Ÿäº§è€…</h4>

<ul>
  <li>é…ç½®</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">8001</span>
<span class="py">server.servlet.context-path</span><span class="p">=</span><span class="s">/producer</span>
 
<span class="py">spring.application.name</span><span class="p">=</span><span class="s">producer</span>
<span class="py">spring.cloud.stream.bindings.output_channel.destination</span><span class="p">=</span><span class="s">exchange-3</span>
<span class="py">spring.cloud.stream.bindings.output_channel.group</span><span class="p">=</span><span class="s">queue-3</span>
<span class="py">spring.cloud.stream.bindings.output_channel.binder</span><span class="p">=</span><span class="s">rabbit_cluster</span>
 
<span class="py">spring.cloud.stream.binders.rabbit_cluster.type</span><span class="p">=</span><span class="s">rabbit</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.addresses</span><span class="p">=</span><span class="s">192.168.11.76:5672</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.username</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.password</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.virtual-host</span><span class="p">=</span><span class="s">/</span>

</code></pre></div></div>

<ul>
  <li>é€šé“æ¥å£</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.Output</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageChannel</span><span class="o">;</span>
 
<span class="cm">/**
 * &lt;B&gt;ä¸­æ–‡ç±»åï¼š&lt;/B&gt;&lt;BR&gt;
 * &lt;B&gt;æ¦‚è¦è¯´æ˜ï¼š&lt;/B&gt;&lt;BR&gt;
 * è¿™é‡Œçš„Baristaæ¥å£æ˜¯å®šä¹‰æ¥ä½œä¸ºåé¢ç±»çš„å‚æ•°ï¼Œè¿™ä¸€æ¥å£å®šä¹‰æ¥é€šé“ç±»å‹å’Œé€šé“åç§°ã€‚
 * é€šé“åç§°æ˜¯ä½œä¸ºé…ç½®ç”¨ï¼Œé€šé“ç±»å‹åˆ™å†³å®šäº†appä¼šä½¿ç”¨è¿™ä¸€é€šé“è¿›è¡Œå‘é€æ¶ˆæ¯è¿˜æ˜¯ä»ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Barista</span> <span class="o">{</span>
      
    <span class="c1">//String INPUT_CHANNEL = "input_channel";  </span>
    <span class="nc">String</span> <span class="no">OUTPUT_CHANNEL</span> <span class="o">=</span> <span class="s">"output_channel"</span><span class="o">;</span>  
 
    <span class="c1">//æ³¨è§£@Inputå£°æ˜äº†å®ƒæ˜¯ä¸€ä¸ªè¾“å…¥ç±»å‹çš„é€šé“ï¼Œåå­—æ˜¯Barista.INPUT_CHANNELï¼Œä¹Ÿå°±æ˜¯position3çš„input_channelã€‚è¿™ä¸€åå­—ä¸ä¸Šè¿°é…ç½®app2çš„é…ç½®æ–‡ä»¶ä¸­position1åº”è¯¥ä¸€è‡´ï¼Œè¡¨æ˜æ³¨å…¥äº†ä¸€ä¸ªåå­—å«åšinput_channelçš„é€šé“ï¼Œå®ƒçš„ç±»å‹æ˜¯inputï¼Œè®¢é˜…çš„ä¸»é¢˜æ˜¯position2å¤„å£°æ˜çš„mydestè¿™ä¸ªä¸»é¢˜  </span>
<span class="c1">//    @Input(Barista.INPUT_CHANNEL)  </span>
<span class="c1">//    SubscribableChannel loginput();  </span>
    <span class="c1">//æ³¨è§£@Outputå£°æ˜äº†å®ƒæ˜¯ä¸€ä¸ªè¾“å‡ºç±»å‹çš„é€šé“ï¼Œåå­—æ˜¯output_channelã€‚è¿™ä¸€åå­—ä¸app1ä¸­é€šé“åä¸€è‡´ï¼Œè¡¨æ˜æ³¨å…¥äº†ä¸€ä¸ªåå­—ä¸ºoutput_channelçš„é€šé“ï¼Œç±»å‹æ˜¯outputï¼Œå‘å¸ƒçš„ä¸»é¢˜åä¸ºmydestã€‚  </span>
    <span class="nd">@Output</span><span class="o">(</span><span class="nc">Barista</span><span class="o">.</span><span class="na">OUTPUT_CHANNEL</span><span class="o">)</span>
    <span class="nc">MessageChannel</span> <span class="nf">logoutput</span><span class="o">();</span>  
 
<span class="c1">// String INPUT_BASE = "queue-1";  </span>
<span class="c1">// String OUTPUT_BASE = "queue-1";  </span>
<span class="c1">// @Input(Barista.INPUT_BASE)  </span>
<span class="c1">// SubscribableChannel input1();  </span>
<span class="c1">// MessageChannel output1();  </span>
      
<span class="o">}</span>  

</code></pre></div></div>

<ul>
  <li>å‘é€ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.EnableBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.MessageBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
 
<span class="nd">@EnableBinding</span><span class="o">(</span><span class="nc">Barista</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Service</span>  
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitmqSender</span> <span class="o">{</span>  
  
    <span class="nd">@Autowired</span>  
    <span class="kd">private</span> <span class="nc">Barista</span> <span class="n">barista</span><span class="o">;</span>  
    
    <span class="c1">// å‘é€æ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="nc">Object</span> <span class="n">message</span><span class="o">,</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
        <span class="k">try</span><span class="o">{</span>
         <span class="nc">MessageHeaders</span> <span class="n">mhs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MessageHeaders</span><span class="o">(</span><span class="n">properties</span><span class="o">);</span>
         <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="nc">MessageBuilder</span><span class="o">.</span><span class="na">createMessage</span><span class="o">(</span><span class="n">message</span><span class="o">,</span> <span class="n">mhs</span><span class="o">);</span>
            <span class="kt">boolean</span> <span class="n">sendStatus</span> <span class="o">=</span> <span class="n">barista</span><span class="o">.</span><span class="na">logoutput</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------------sending -------------------"</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘é€æ•°æ®ï¼š"</span> <span class="o">+</span> <span class="n">message</span> <span class="o">+</span> <span class="s">",sendStatus: "</span> <span class="o">+</span> <span class="n">sendStatus</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>  
         <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------------error-------------"</span><span class="o">);</span>
         <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
           
        <span class="o">}</span>  
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>  
    
<span class="o">}</span>  

</code></pre></div></div>

<ul>
  <li>æµ‹è¯•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationTests</span> <span class="o">{</span>
 
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">RabbitmqSender</span> <span class="n">rabbitmqSender</span><span class="o">;</span>
    
    
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendMessageTest1</span><span class="o">()</span> <span class="o">{</span>
       <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
       <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">properties</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;();</span>
                <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"SERIAL_NUMBER"</span><span class="o">,</span> <span class="s">"12345"</span><span class="o">);</span>
                <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"BANK_NUMBER"</span><span class="o">,</span> <span class="s">"abc"</span><span class="o">);</span>
                <span class="n">properties</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"PLAT_SEND_TIME"</span><span class="o">,</span> <span class="nc">DateUtils</span><span class="o">.</span><span class="na">formatDate</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">(),</span> <span class="s">"yyyy-MM-dd HH:mm:ss.SSS"</span><span class="o">));</span>
            <span class="n">rabbitmqSender</span><span class="o">.</span><span class="na">sendMessage</span><span class="o">(</span><span class="s">"Hello, I am amqp sender num :"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">properties</span><span class="o">);</span>
              
           <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"--------error-------"</span><span class="o">);</span>
               <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> 
           <span class="o">}</span>
       <span class="o">}</span>
       <span class="c1">//TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆè´¹è€…-1">æ¶ˆè´¹è€…</h4>

<ul>
  <li>é…ç½®</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">8002</span>
<span class="py">server.context-path</span><span class="p">=</span><span class="s">/consumer</span>
 
<span class="py">spring.application.name</span><span class="p">=</span><span class="s">consumer</span>
<span class="py">spring.cloud.stream.bindings.input_channel.destination</span><span class="p">=</span><span class="s">exchange-3</span>
<span class="py">spring.cloud.stream.bindings.input_channel.group</span><span class="p">=</span><span class="s">queue-3</span>
<span class="py">spring.cloud.stream.bindings.input_channel.binder</span><span class="p">=</span><span class="s">rabbit_cluster</span>
<span class="py">spring.cloud.stream.bindings.input_channel.consumer.concurrency</span><span class="p">=</span><span class="s">1</span>
<span class="py">spring.cloud.stream.rabbit.bindings.input_channel.consumer.requeue-rejected</span><span class="p">=</span><span class="s">false</span>
<span class="py">spring.cloud.stream.rabbit.bindings.input_channel.consumer.acknowledge-mode</span><span class="p">=</span><span class="s">MANUAL</span>
<span class="py">spring.cloud.stream.rabbit.bindings.input_channel.consumer.recovery-interval</span><span class="p">=</span><span class="s">3000</span>
<span class="py">spring.cloud.stream.rabbit.bindings.input_channel.consumer.durable-subscription</span><span class="p">=</span><span class="s">true</span>
<span class="py">spring.cloud.stream.rabbit.bindings.input_channel.consumer.max-concurrency</span><span class="p">=</span><span class="s">5</span>
 
<span class="py">spring.cloud.stream.binders.rabbit_cluster.type</span><span class="p">=</span><span class="s">rabbit</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.addresses</span><span class="p">=</span><span class="s">192.168.11.76:5672</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.username</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.password</span><span class="p">=</span><span class="s">guest</span>
<span class="py">spring.cloud.stream.binders.rabbit_cluster.environment.spring.rabbitmq.virtual-host</span><span class="p">=</span><span class="s">/</span>

</code></pre></div></div>

<ul>
  <li>é€šé“æ¥å£</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.Input</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.SubscribableChannel</span><span class="o">;</span>
 
<span class="cm">/**
 * &lt;B&gt;ä¸­æ–‡ç±»åï¼š&lt;/B&gt;&lt;BR&gt;
 * &lt;B&gt;æ¦‚è¦è¯´æ˜ï¼š&lt;/B&gt;&lt;BR&gt;
 * è¿™é‡Œçš„Baristaæ¥å£æ˜¯å®šä¹‰æ¥ä½œä¸ºåé¢ç±»çš„å‚æ•°ï¼Œè¿™ä¸€æ¥å£å®šä¹‰æ¥é€šé“ç±»å‹å’Œé€šé“åç§°ã€‚
 * é€šé“åç§°æ˜¯ä½œä¸ºé…ç½®ç”¨ï¼Œé€šé“ç±»å‹åˆ™å†³å®šäº†appä¼šä½¿ç”¨è¿™ä¸€é€šé“è¿›è¡Œå‘é€æ¶ˆæ¯è¿˜æ˜¯ä»ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚
 * @author ashenï¼ˆAlienwareï¼‰
 * @since 2016å¹´7æœˆ22æ—¥
 */</span>
 
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Barista</span> <span class="o">{</span>
      
    <span class="nc">String</span> <span class="no">INPUT_CHANNEL</span> <span class="o">=</span> <span class="s">"input_channel"</span><span class="o">;</span>  
 
    <span class="c1">//æ³¨è§£@Inputå£°æ˜äº†å®ƒæ˜¯ä¸€ä¸ªè¾“å…¥ç±»å‹çš„é€šé“ï¼Œåå­—æ˜¯Barista.INPUT_CHANNELï¼Œä¹Ÿå°±æ˜¯position3çš„input_channelã€‚è¿™ä¸€åå­—ä¸ä¸Šè¿°é…ç½®app2çš„é…ç½®æ–‡ä»¶ä¸­position1åº”è¯¥ä¸€è‡´ï¼Œè¡¨æ˜æ³¨å…¥äº†ä¸€ä¸ªåå­—å«åšinput_channelçš„é€šé“ï¼Œå®ƒçš„ç±»å‹æ˜¯inputï¼Œè®¢é˜…çš„ä¸»é¢˜æ˜¯position2å¤„å£°æ˜çš„mydestè¿™ä¸ªä¸»é¢˜  </span>
    <span class="nd">@Input</span><span class="o">(</span><span class="nc">Barista</span><span class="o">.</span><span class="na">INPUT_CHANNEL</span><span class="o">)</span>  
    <span class="nc">SubscribableChannel</span> <span class="nf">loginput</span><span class="o">();</span>  
    
      
<span class="o">}</span>  

</code></pre></div></div>

<ul>
  <li>æ¥æ”¶ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.springframework.amqp.support.AmqpHeaders</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.EnableBinding</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.StreamListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">com.rabbitmq.client.Channel</span><span class="o">;</span>
 
 
<span class="nd">@EnableBinding</span><span class="o">(</span><span class="nc">Barista</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RabbitmqReceiver</span> <span class="o">{</span>  
 
    <span class="nd">@StreamListener</span><span class="o">(</span><span class="nc">Barista</span><span class="o">.</span><span class="na">INPUT_CHANNEL</span><span class="o">)</span>  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receiver</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>  
         <span class="nc">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">rabbitmq</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">Channel</span><span class="o">)</span> <span class="n">message</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">AmqpHeaders</span><span class="o">.</span><span class="na">CHANNEL</span><span class="o">);</span>
         <span class="nc">Long</span> <span class="n">deliveryTag</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Long</span><span class="o">)</span> <span class="n">message</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="nc">AmqpHeaders</span><span class="o">.</span><span class="na">DELIVERY_TAG</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Input Stream 1 æ¥å—æ•°æ®ï¼š"</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹å®Œæ¯•------------"</span><span class="o">);</span>
    <span class="n">channel</span><span class="o">.</span><span class="na">basicAck</span><span class="o">(</span><span class="n">deliveryTag</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
    <span class="o">}</span>  
<span class="o">}</span>  

</code></pre></div></div>

:ET