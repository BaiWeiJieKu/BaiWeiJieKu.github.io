I"€´<ul id="markdown-toc">
  <li><a href="#é›†æˆspringboot" id="markdown-toc-é›†æˆspringboot">é›†æˆspringboot</a>    <ul>
      <li><a href="#pom" id="markdown-toc-pom">pom</a></li>
      <li><a href="#springå®¹å™¨" id="markdown-toc-springå®¹å™¨">springå®¹å™¨</a></li>
      <li><a href="#servlet-contexté…ç½®" id="markdown-toc-servlet-contexté…ç½®">Servlet Contexté…ç½®</a></li>
      <li><a href="#å®‰å…¨é…ç½®" id="markdown-toc-å®‰å…¨é…ç½®">å®‰å…¨é…ç½®</a></li>
      <li><a href="#controller" id="markdown-toc-controller">controller</a></li>
    </ul>
  </li>
  <li><a href="#å·¥ä½œåŸç†" id="markdown-toc-å·¥ä½œåŸç†">å·¥ä½œåŸç†</a>    <ul>
      <li><a href="#ç»“æ„æ€»è§ˆ" id="markdown-toc-ç»“æ„æ€»è§ˆ">ç»“æ„æ€»è§ˆ</a></li>
      <li><a href="#è®¤è¯æµç¨‹" id="markdown-toc-è®¤è¯æµç¨‹">è®¤è¯æµç¨‹</a></li>
      <li><a href="#authenticationprovider" id="markdown-toc-authenticationprovider">AuthenticationProvider</a></li>
      <li><a href="#userdetailsservice" id="markdown-toc-userdetailsservice">UserDetailsService</a></li>
      <li><a href="#passwordencoder" id="markdown-toc-passwordencoder">PasswordEncoder</a></li>
    </ul>
  </li>
  <li><a href="#æˆæƒæµç¨‹" id="markdown-toc-æˆæƒæµç¨‹">æˆæƒæµç¨‹</a>    <ul>
      <li><a href="#æˆæƒå†³ç­–" id="markdown-toc-æˆæƒå†³ç­–">æˆæƒå†³ç­–</a></li>
    </ul>
  </li>
  <li><a href="#è‡ªå®šä¹‰è®¤è¯" id="markdown-toc-è‡ªå®šä¹‰è®¤è¯">è‡ªå®šä¹‰è®¤è¯</a>    <ul>
      <li><a href="#è‡ªå®šä¹‰ç™»å½•é¡µé¢" id="markdown-toc-è‡ªå®šä¹‰ç™»å½•é¡µé¢">è‡ªå®šä¹‰ç™»å½•é¡µé¢</a></li>
      <li><a href="#è¿æ¥æ•°æ®åº“" id="markdown-toc-è¿æ¥æ•°æ®åº“">è¿æ¥æ•°æ®åº“</a></li>
    </ul>
  </li>
  <li><a href="#ä¼šè¯" id="markdown-toc-ä¼šè¯">ä¼šè¯</a>    <ul>
      <li><a href="#è·å–ç”¨æˆ·èº«ä»½" id="markdown-toc-è·å–ç”¨æˆ·èº«ä»½">è·å–ç”¨æˆ·èº«ä»½</a></li>
      <li><a href="#ä¼šè¯æ§åˆ¶" id="markdown-toc-ä¼šè¯æ§åˆ¶">ä¼šè¯æ§åˆ¶</a></li>
      <li><a href="#ä¼šè¯è¶…æ—¶" id="markdown-toc-ä¼šè¯è¶…æ—¶">ä¼šè¯è¶…æ—¶</a></li>
      <li><a href="#å®‰å…¨ä¼šè¯" id="markdown-toc-å®‰å…¨ä¼šè¯">å®‰å…¨ä¼šè¯</a></li>
    </ul>
  </li>
  <li><a href="#é€€å‡º" id="markdown-toc-é€€å‡º">é€€å‡º</a>    <ul>
      <li><a href="#logouthandler" id="markdown-toc-logouthandler">logoutHandler</a></li>
    </ul>
  </li>
  <li><a href="#æˆæƒ" id="markdown-toc-æˆæƒ">æˆæƒ</a>    <ul>
      <li><a href="#æ•°æ®åº“" id="markdown-toc-æ•°æ®åº“">æ•°æ®åº“</a></li>
      <li><a href="#ä¿®æ”¹æˆæƒé€»è¾‘" id="markdown-toc-ä¿®æ”¹æˆæƒé€»è¾‘">ä¿®æ”¹æˆæƒé€»è¾‘</a></li>
      <li><a href="#webæˆæƒ" id="markdown-toc-webæˆæƒ">WEBæˆæƒ</a></li>
      <li><a href="#æ–¹æ³•æˆæƒ" id="markdown-toc-æ–¹æ³•æˆæƒ">æ–¹æ³•æˆæƒ</a></li>
    </ul>
  </li>
</ul>
<h3 id="é›†æˆspringboot">é›†æˆspringboot</h3>

<ul>
  <li>åˆ›å»ºmavenå·¥ç¨‹ security-spring-boot</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/mDw8r6jTY4o3UFB.png" alt="image.png" /></p>

<h4 id="pom">pom</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>security-springboot<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.1.3.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯&gt;spring bootä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯&gt;spring securityä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯jspä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--jspé¡µé¢ä½¿ç”¨jstlæ ‡ç­¾ --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jstl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--ç”¨äºç¼–è¯‘jsp --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-jasper<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.18.0<span class="nt">&lt;/version&gt;</span>
          <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;finalName&gt;</span>security-springboot<span class="nt">&lt;/finalName&gt;</span>
        <span class="nt">&lt;pluginManagement&gt;</span>
            <span class="nt">&lt;plugins&gt;</span>
                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.maven<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>tomcat7-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>
                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;configuration&gt;</span>
                        <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
                        <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
                    <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>

                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;configuration&gt;</span>
                        <span class="nt">&lt;encoding&gt;</span>utf-8<span class="nt">&lt;/encoding&gt;</span>
                        <span class="nt">&lt;useDefaultDelimiters&gt;</span>true<span class="nt">&lt;/useDefaultDelimiters&gt;</span>
                        <span class="nt">&lt;resources&gt;</span>
                            <span class="nt">&lt;resource&gt;</span>
                                <span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
                                <span class="nt">&lt;filtering&gt;</span>true<span class="nt">&lt;/filtering&gt;</span>
                                <span class="nt">&lt;includes&gt;</span>
                                    <span class="nt">&lt;include&gt;</span>**/*<span class="nt">&lt;/include&gt;</span>
                                <span class="nt">&lt;/includes&gt;</span>
                            <span class="nt">&lt;/resource&gt;</span>
                            <span class="nt">&lt;resource&gt;</span>
                                <span class="nt">&lt;directory&gt;</span>src/main/java<span class="nt">&lt;/directory&gt;</span>
                                <span class="nt">&lt;includes&gt;</span>
                                    <span class="nt">&lt;include&gt;</span>**/*.xml<span class="nt">&lt;/include&gt;</span>
                                <span class="nt">&lt;/includes&gt;</span>
                            <span class="nt">&lt;/resource&gt;</span>
                        <span class="nt">&lt;/resources&gt;</span>
                    <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>
            <span class="nt">&lt;/plugins&gt;</span>
        <span class="nt">&lt;/pluginManagement&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<h4 id="springå®¹å™¨">springå®¹å™¨</h4>

<ul>
  <li>SpringBootå·¥ç¨‹å¯åŠ¨ä¼šè‡ªåŠ¨æ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…ä¸‹çš„æ‰€æœ‰Beanï¼ŒåŠ è½½åˆ°springå®¹å™¨ã€‚</li>
  <li>1ï¼‰Spring Booté…ç½®æ–‡ä»¶ï¼šåœ¨resourcesä¸‹æ·»åŠ application.properties</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">8080</span>
<span class="py">server.servlet.context-path</span><span class="p">=</span><span class="s">/security-springboot</span>
<span class="py">spring.application.name</span> <span class="p">=</span> <span class="s">security-springboot</span>
</code></pre></div></div>

<ul>
  <li>2ï¼‰Spring Boot å¯åŠ¨ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecuritySpringBootApp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SecuritySpringBootApp</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="servlet-contexté…ç½®">Servlet Contexté…ç½®</h4>

<ul>
  <li>ç”±äºSpring boot starterè‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œè¿™é‡Œæ— éœ€ä½¿ç”¨@EnableWebMvcä¸@ComponentScanï¼ŒWebConfigå¦‚ä¸‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="c1">//é»˜è®¤Urlæ ¹è·¯å¾„è·³è½¬åˆ°/loginï¼Œæ­¤urlä¸ºspring securityæä¾›</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addViewControllers</span><span class="o">(</span><span class="nc">ViewControllerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addViewController</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"redirect:/login"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è§†å›¾è§£æå™¨é…ç½®åœ¨application.propertiesä¸­</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.mvc.view.prefix</span><span class="p">=</span><span class="s">/WEB-INF/views/</span>
<span class="py">spring.mvc.view.suffix</span><span class="p">=</span><span class="s">.jsp</span>
</code></pre></div></div>

<h4 id="å®‰å…¨é…ç½®">å®‰å…¨é…ç½®</h4>

<ul>
  <li>ç”±äºSpring boot starterè‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œè¿™é‡Œæ— éœ€ä½¿ç”¨@EnableWebSecurityï¼ŒWebSecurityConfigå†…å®¹å¦‚ä¸‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
<span class="c1">//é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span>  <span class="o">{</span>
        <span class="c1">//åœ¨userDetailsService()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªUserDetailsServiceç»™springå®¹å™¨ï¼ŒSpring Securityä¼šä½¿ç”¨å®ƒæ¥è·å–ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬æš‚æ—¶ä½¿ç”¨InMemoryUserDetailsManagerå®ç°ç±»ï¼Œå¹¶åœ¨å…¶ä¸­åˆ†åˆ«åˆ›å»ºäº†zhangsanã€lisiä¸¤ä¸ªç”¨æˆ·ï¼Œå¹¶è®¾ç½®å¯†ç å’Œæƒé™ã€‚</span>
        <span class="nc">InMemoryUserDetailsManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryUserDetailsManager</span><span class="o">();</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"lisi"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"456"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p2"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">manager</span><span class="o">;</span>
<span class="o">}</span>
    <span class="c1">//å¯†ç ç¼–ç å™¨</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//å…ˆä½¿ç”¨ä¸åŠ å¯†çš„å¯†ç ç¼–ç å™¨</span>
        <span class="k">return</span>  <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//é…ç½®å®‰å…¨æ‹¦æˆªæœºåˆ¶</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span> <span class="c1">//æ‰€æœ‰çš„/r/**è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>             <span class="c1">//é™¤äº†/r/**ä»¥å¤–çš„è¯·æ±‚éƒ½å¯ä»¥ç›´æ¥è®¿é—®</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span><span class="c1">//å…è®¸è¡¨å•ç™»å½•</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">().</span><span class="na">successForwardUrl</span><span class="o">(</span><span class="s">"/login-success"</span><span class="o">);</span><span class="c1">//è‡ªå®šä¹‰ç™»å½•æˆåŠŸåçš„è·³è½¬åœ°å€</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="controller">controller</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login-success"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">loginSuccess</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" ç™»å½•æˆåŠŸ"</span><span class="o">;</span>
<span class="o">}</span>
<span class="cm">/**
 * æµ‹è¯•èµ„æº1
 * @return
 */</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r1"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">r1</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" è®¿é—®èµ„æº1"</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * æµ‹è¯•èµ„æº2
 * @return
 */</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r2"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">r2</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" è®¿é—®èµ„æº2"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h3>

<h4 id="ç»“æ„æ€»è§ˆ">ç»“æ„æ€»è§ˆ</h4>

<ul>
  <li>Spring Securityæ‰€è§£å†³çš„é—®é¢˜å°±æ˜¯<strong>å®‰å…¨è®¿é—®æ§åˆ¶</strong>ï¼Œè€Œå®‰å…¨è®¿é—®æ§åˆ¶åŠŸèƒ½å…¶å®å°±æ˜¯å¯¹æ‰€æœ‰è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ ¡éªŒæ¯ä¸ªè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿè®¿é—®å®ƒæ‰€æœŸæœ›çš„èµ„æºã€‚</li>
  <li>å¯ä»¥é€šè¿‡Filteræˆ–AOPç­‰æŠ€æœ¯æ¥å®ç°ï¼ŒSpring Securityå¯¹Webèµ„æºçš„ä¿æŠ¤æ˜¯é Filterå®ç°çš„</li>
  <li>å½“åˆå§‹åŒ–Spring Securityæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º<code class="language-plaintext highlighter-rouge">SpringSecurityFilterChain</code>çš„Servletè¿‡æ»¤å™¨ï¼Œç±»å‹ä¸º org.springframework.security.web.FilterChainProxyï¼Œå®ƒå®ç°äº†javax.servlet.Filterï¼Œå› æ­¤å¤–éƒ¨çš„è¯·æ±‚ä¼šç»è¿‡æ­¤ç±»</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/UXrMlHCoE5iPnOg.png" alt="image.png" /></p>

<ul>
  <li>FilterChainProxyæ˜¯ä¸€ä¸ªä»£ç†ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯FilterChainProxyä¸­SecurityFilterChainæ‰€åŒ…å«çš„å„ä¸ªFilter</li>
  <li>åŒæ—¶è¿™äº›Filterä½œä¸ºBeanè¢«Springç®¡ç†ï¼Œå®ƒä»¬æ˜¯Spring Securityæ ¸å¿ƒï¼Œå„æœ‰å„çš„èŒè´£ï¼Œä½†ä»–ä»¬å¹¶ä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>è®¤è¯</strong>ï¼Œä¹Ÿä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>æˆæƒ</strong>ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬äº¤ç»™äº†<strong>è®¤è¯ç®¡ç†å™¨</strong>ï¼ˆAuthenticationManagerï¼‰å’Œ<strong>å†³ç­–ç®¡ç†å™¨</strong>ï¼ˆAccessDecisionManagerï¼‰è¿›è¡Œå¤„ç†</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/3JWCQYZ74KFfomy.png" alt="image.png" /></p>

<ul>
  <li><strong>SecurityContextPersistenceFilter</strong> ï¼šè¿™ä¸ªFilteræ˜¯æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹çš„å…¥å£å’Œå‡ºå£ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼‰ï¼Œä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»é…ç½®å¥½çš„ SecurityContextRepository ä¸­è·å– SecurityContextï¼Œç„¶åæŠŠå®ƒè®¾ç½®ç»™ SecurityContextHolderã€‚åœ¨è¯·æ±‚å®Œæˆåå°† SecurityContextHolder æŒæœ‰çš„ SecurityContext å†ä¿å­˜åˆ°é…ç½®å¥½çš„ SecurityContextRepositoryï¼ŒåŒæ—¶æ¸…é™¤ securityContextHolder æ‰€æŒæœ‰çš„ SecurityContextï¼›</li>
  <li><strong>UsernamePasswordAuthenticationFilter</strong> ç”¨äºå¤„ç†æ¥è‡ªè¡¨å•æäº¤çš„è®¤è¯ã€‚è¯¥è¡¨å•å¿…é¡»æä¾›å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶å†…éƒ¨è¿˜æœ‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åè¿›è¡Œå¤„ç†çš„ AuthenticationSuccessHandler å’Œ AuthenticationFailureHandlerï¼Œè¿™äº›éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚åšç›¸å…³æ”¹å˜ï¼›</li>
  <li><strong>FilterSecurityInterceptor</strong> æ˜¯ç”¨äºä¿æŠ¤webèµ„æºçš„ï¼Œä½¿ç”¨AccessDecisionManagerå¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæˆæƒè®¿é—®</li>
  <li><strong>ExceptionTranslationFilter</strong> èƒ½å¤Ÿæ•è·æ¥è‡ª FilterChain æ‰€æœ‰çš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å®ƒåªä¼šå¤„ç†ä¸¤ç±»å¼‚å¸¸ï¼šAuthenticationException å’Œ AccessDeniedExceptionï¼Œå…¶å®ƒçš„å¼‚å¸¸å®ƒä¼šç»§ç»­æŠ›å‡ºã€‚</li>
</ul>

<h4 id="è®¤è¯æµç¨‹">è®¤è¯æµç¨‹</h4>

<p><img src="https://i.loli.net/2020/02/22/rdeuIJ8gGq6DKom.png" alt="image.png" /></p>

<ul>
  <li>ä»”ç»†åˆ†æè®¤è¯è¿‡ç¨‹ï¼š
    <ul>
      <li>ç”¨æˆ·æäº¤ç”¨æˆ·åã€å¯†ç è¢«SecurityFilterChainä¸­çš„<code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨è·å–åˆ°ï¼Œå°è£…ä¸ºè¯·æ±‚Authenticationï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯UsernamePasswordAuthenticationTokenè¿™ä¸ªå®ç°ç±»</li>
      <li>ç„¶åè¿‡æ»¤å™¨å°†Authenticationæäº¤è‡³è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰è¿›è¡Œè®¤è¯</li>
      <li>è®¤è¯æˆåŠŸåï¼Œ<code class="language-plaintext highlighter-rouge">AuthenticationManager</code>èº«ä»½ç®¡ç†å™¨è¿”å›ä¸€ä¸ªè¢«å¡«å……æ»¡äº†ä¿¡æ¯çš„ï¼ˆåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰<code class="language-plaintext highlighter-rouge">Authentication</code>å®ä¾‹</li>
      <li><code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>å®‰å…¨ä¸Šä¸‹æ–‡å®¹å™¨å°†ç¬¬3æ­¥å¡«å……äº†ä¿¡æ¯çš„<code class="language-plaintext highlighter-rouge">Authentication</code>ï¼Œé€šè¿‡SecurityContextHolder.getContext().setAuthentication(â€¦)æ–¹æ³•ï¼Œè®¾ç½®åˆ°å…¶ä¸­ã€‚</li>
    </ul>
  </li>
  <li>å¯ä»¥çœ‹å‡ºAuthenticationManageræ¥å£ï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œä¹Ÿæ˜¯å‘èµ·è®¤è¯çš„å‡ºå‘ç‚¹ï¼Œå®ƒçš„å®ç°ç±»ä¸ºProviderManagerã€‚è€ŒSpring Securityæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œå› æ­¤ProviderManagerç»´æŠ¤ç€ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">List&lt;AuthenticationProvider&gt;</code>åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œæœ€ç»ˆå®é™…çš„è®¤è¯å·¥ä½œæ˜¯ç”±AuthenticationProviderå®Œæˆçš„ã€‚</li>
  <li>webè¡¨å•çš„å¯¹åº”çš„AuthenticationProviderå®ç°ç±»ä¸ºDaoAuthenticationProviderï¼Œå®ƒçš„å†…éƒ¨åˆç»´æŠ¤ç€ä¸€ä¸ªUserDetailsServiceè´Ÿè´£UserDetailsçš„è·å–ã€‚æœ€ç»ˆAuthenticationProviderå°†UserDetailså¡«å……è‡³Authenticationã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/FqVJ4PhoX3bAs5L.png" alt="image.png" /></p>

<h4 id="authenticationprovider">AuthenticationProvider</h4>

<ul>
  <li>
    <p>è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰å§”æ‰˜AuthenticationProviderå®Œæˆè®¤è¯å·¥ä½œã€‚</p>
  </li>
  <li>
    <p>AuthenticationProvideræ˜¯ä¸€ä¸ªæ¥å£</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationProvider</span> <span class="o">{</span>
    <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">var1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li><strong>authenticate</strong>()æ–¹æ³•å®šä¹‰äº†<strong>è®¤è¯çš„å®ç°è¿‡ç¨‹</strong>ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢åŒ…å«äº†ç™»å½•ç”¨æˆ·æ‰€æäº¤çš„ç”¨æˆ·ã€å¯†ç ç­‰ã€‚è€Œè¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªAuthenticationï¼Œè¿™ä¸ªAuthenticationåˆ™æ˜¯åœ¨è®¤è¯æˆåŠŸåï¼Œå°†ç”¨æˆ·çš„æƒé™åŠå…¶ä»–ä¿¡æ¯é‡æ–°ç»„è£…åç”Ÿæˆã€‚</li>
    </ul>
  </li>
  <li>Spring Securityä¸­ç»´æŠ¤ç€ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">List&lt;AuthenticationProvider&gt;</code>åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œä¸åŒçš„è®¤è¯æ–¹å¼ä½¿ç”¨ä¸åŒçš„AuthenticationProviderã€‚å¦‚ä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»å½•æ—¶ï¼Œä½¿ç”¨AuthenticationProvider1ï¼ŒçŸ­ä¿¡ç™»å½•æ—¶ä½¿ç”¨AuthenticationProvider2ç­‰ç­‰è¿™æ ·çš„ä¾‹å­å¾ˆå¤šã€‚</li>
  <li>æ¯ä¸ªAuthenticationProvideréœ€è¦å®ç°<strong>supportsï¼ˆï¼‰</strong>æ–¹æ³•æ¥è¡¨æ˜è‡ªå·±æ”¯æŒçš„è®¤è¯æ–¹å¼ï¼Œå¦‚æˆ‘ä»¬ä½¿ç”¨è¡¨å•æ–¹å¼è®¤è¯ï¼Œåœ¨æäº¤è¯·æ±‚æ—¶Spring Securityä¼šç”ŸæˆUsernamePasswordAuthenticationTokenï¼Œå®ƒæ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢å°è£…ç€ç”¨æˆ·æäº¤çš„ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//DaoAuthenticationProviderçš„åŸºç±»AbstractUserDetailsAuthenticationProvider</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>ä¹Ÿå°±æ˜¯è¯´å½“webè¡¨å•æäº¤ç”¨æˆ·åå¯†ç æ—¶ï¼ŒSpring Securityç”±DaoAuthenticationProviderå¤„ç†ã€‚</strong></li>
  <li>Authenticationæ˜¯spring securityåŒ…ä¸­çš„æ¥å£ï¼Œç›´æ¥ç»§æ‰¿è‡ªPrincipalç±»ï¼Œè€ŒPrincipalæ˜¯ä½äº<code class="language-plaintext highlighter-rouge">java.security</code>åŒ…ä¸­çš„ã€‚å®ƒæ˜¯è¡¨ç¤ºç€ä¸€ä¸ªæŠ½è±¡ä¸»ä½“èº«ä»½ï¼Œä»»ä½•ä¸»ä½“éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œå› æ­¤åŒ…å«ä¸€ä¸ªgetName()æ–¹æ³•ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Authentication</span> <span class="kd">extends</span> <span class="nc">Principal</span><span class="o">,</span> <span class="nc">Serializable</span> <span class="o">{</span>         <span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span>
 
    <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>              <span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span>
    
  	<span class="nc">Object</span> <span class="nf">getCredentials</span><span class="o">();</span>										  <span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span>				

    <span class="nc">Object</span> <span class="nf">getDetails</span><span class="o">();</span>                                                  <span class="err">ï¼ˆ</span><span class="mi">4</span><span class="err">ï¼‰</span>

    <span class="nc">Object</span> <span class="nf">getPrincipal</span><span class="o">();</span>                                                <span class="err">ï¼ˆ</span><span class="mi">5</span><span class="err">ï¼‰</span>

    <span class="kt">boolean</span> <span class="nf">isAuthenticated</span><span class="o">();</span>                                            

    <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ï¼ˆ2ï¼‰getAuthorities()ï¼Œæƒé™ä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»ï¼Œé€šå¸¸æ˜¯ä»£è¡¨æƒé™ä¿¡æ¯çš„ä¸€ç³»åˆ—å­—ç¬¦ä¸²ã€‚</li>
  <li>ï¼ˆ3ï¼‰getCredentials()ï¼Œå‡­è¯ä¿¡æ¯ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç å­—ç¬¦ä¸²ï¼Œåœ¨è®¤è¯è¿‡åé€šå¸¸ä¼šè¢«ç§»é™¤ï¼Œç”¨äºä¿éšœå®‰å…¨ã€‚</li>
  <li>ï¼ˆ4ï¼‰getDetails()ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®ç°æ¥å£é€šå¸¸ä¸º WebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIdçš„å€¼ã€‚</li>
  <li>ï¼ˆ5ï¼‰<strong>getPrincipal()</strong>ï¼Œèº«ä»½ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›çš„æ˜¯UserDetailsæ¥å£çš„å®ç°ç±»ï¼ŒUserDetailsä»£è¡¨ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œé‚£ä»Authenticationä¸­å–å‡ºæ¥çš„UserDetailså°±æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå®ƒä¹Ÿæ˜¯æ¡†æ¶ä¸­çš„å¸¸ç”¨æ¥å£ä¹‹ä¸€ã€‚</li>
</ul>

<h4 id="userdetailsservice">UserDetailsService</h4>

<ul>
  <li>å’±ä»¬ç°åœ¨çŸ¥é“DaoAuthenticationProviderå¤„ç†äº†webè¡¨å•çš„è®¤è¯é€»è¾‘ï¼Œè®¤è¯æˆåŠŸåæ—¢å¾—åˆ°ä¸€ä¸ªAuthentication(UsernamePasswordAuthenticationTokenå®ç°)ï¼Œé‡Œé¢åŒ…å«äº†èº«ä»½ä¿¡æ¯ï¼ˆPrincipalï¼‰ã€‚è¿™ä¸ªèº«ä»½ä¿¡æ¯å°±æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Object</code> ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å®ƒå¯ä»¥è¢«å¼ºè½¬ä¸ºUserDetailså¯¹è±¡ã€‚</li>
  <li>DaoAuthenticationProviderä¸­åŒ…å«äº†ä¸€ä¸ªUserDetailsServiceå®ä¾‹ï¼Œå®ƒè´Ÿè´£æ ¹æ®ç”¨æˆ·åæå–ç”¨æˆ·ä¿¡æ¯UserDetails(åŒ…å«å¯†ç )ï¼Œè€ŒåDaoAuthenticationProviderä¼šå»å¯¹æ¯”UserDetailsServiceæå–çš„ç”¨æˆ·å¯†ç ä¸ç”¨æˆ·æäº¤çš„å¯†ç æ˜¯å¦åŒ¹é…ä½œä¸ºè®¤è¯æˆåŠŸçš„å…³é”®ä¾æ®ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å°†è‡ªå®šä¹‰çš„<code class="language-plaintext highlighter-rouge">UserDetailsService</code>å…¬å¼€ä¸ºspring beanæ¥å®šä¹‰è‡ªå®šä¹‰èº«ä»½éªŒè¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>    
	<span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>UserDetailsServiceåªè´Ÿè´£ä»ç‰¹å®šçš„åœ°æ–¹ï¼ˆé€šå¸¸æ˜¯æ•°æ®åº“ï¼‰åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œä»…æ­¤è€Œå·²ã€‚è€ŒDaoAuthenticationProviderçš„èŒè´£æ›´å¤§ï¼Œå®ƒå®Œæˆå®Œæ•´çš„è®¤è¯æµç¨‹ï¼ŒåŒæ—¶ä¼šæŠŠUserDetailså¡«å……è‡³Authenticationã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="nc">Serializable</span> <span class="o">{</span>

   <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>

   <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">();</span>

   <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Authenticationçš„getCredentials()ä¸UserDetailsä¸­çš„getPassword()éœ€è¦è¢«åŒºåˆ†å¯¹å¾…ï¼Œå‰è€…æ˜¯ç”¨æˆ·æäº¤çš„å¯†ç å‡­è¯ï¼Œåè€…æ˜¯ç”¨æˆ·å®é™…å­˜å‚¨çš„å¯†ç ï¼Œè®¤è¯å…¶å®å°±æ˜¯å¯¹è¿™ä¸¤è€…çš„æ¯”å¯¹ã€‚</li>
  <li>Authenticationä¸­çš„getAuthorities()å®é™…æ˜¯ç”±UserDetailsçš„getAuthorities()ä¼ é€’è€Œå½¢æˆçš„ã€‚</li>
  <li>é€šè¿‡å®ç°UserDetailsServiceå’ŒUserDetailsï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹ç”¨æˆ·ä¿¡æ¯è·å–æ–¹å¼ä»¥åŠç”¨æˆ·ä¿¡æ¯å­—æ®µçš„æ‰©å±•</li>
  <li>Spring Securityæä¾›çš„InMemoryUserDetailsManager(å†…å­˜è®¤è¯)ï¼ŒJdbcUserDetailsManager(jdbcè®¤è¯)å°±æ˜¯UserDetailsServiceçš„å®ç°ç±»ï¼Œä¸»è¦åŒºåˆ«æ— éå°±æ˜¯ä»å†…å­˜è¿˜æ˜¯ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ã€‚</li>
  <li>è‡ªå®šä¹‰UserDetailsService</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringDataUserDetailsService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="c1">//ç™»å½•è´¦å·</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"username="</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
        <span class="c1">//æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...</span>
        <span class="c1">//è¿™é‡Œæš‚æ—¶ä½¿ç”¨é™æ€æ•°æ®</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1">//å±è”½å®‰å…¨é…ç½®ç±»ä¸­UserDetailsServiceçš„å®šä¹‰</span>
<span class="cm">/*    @Bean
    public UserDetailsService userDetailsService()  {
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        manager.createUser(User.withUsername("zhangsan").password("123").authorities("p1").build());
        manager.createUser(User.withUsername("lisi").password("456").authorities("p2").build());
        return manager;
}*/</span>
</code></pre></div></div>

<h4 id="passwordencoder">PasswordEncoder</h4>

<ul>
  <li>Spring Securityä¸ºäº†é€‚åº”å¤šç§å¤šæ ·çš„åŠ å¯†ç±»å‹ï¼Œåˆåšäº†æŠ½è±¡ï¼ŒDaoAuthenticationProvideré€šè¿‡PasswordEncoderæ¥å£çš„matchesæ–¹æ³•è¿›è¡Œå¯†ç çš„å¯¹æ¯”ï¼Œè€Œå…·ä½“çš„å¯†ç å¯¹æ¯”ç»†èŠ‚å–å†³äºå®ç°ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordEncoder</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">var1</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">var1</span><span class="o">,</span> <span class="nc">String</span> <span class="n">var2</span><span class="o">);</span>

    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">upgradeEncoding</span><span class="o">(</span><span class="nc">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è€ŒSpring Securityæä¾›å¾ˆå¤šå†…ç½®çš„PasswordEncoderï¼Œèƒ½å¤Ÿå¼€ç®±å³ç”¨ï¼Œä½¿ç”¨æŸç§PasswordEncoderåªéœ€è¦è¿›è¡Œå¦‚ä¸‹å£°æ˜å³å¯ï¼Œå¦‚ä¸‹ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span>  <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>NoOpPasswordEncoderé‡‡ç”¨å­—ç¬¦ä¸²åŒ¹é…æ–¹æ³•ï¼Œä¸å¯¹å¯†ç è¿›è¡ŒåŠ å¯†æ¯”è¾ƒå¤„ç†ï¼Œå¯†ç æ¯”è¾ƒæµç¨‹å¦‚ä¸‹ï¼š
    <ul>
      <li>1ã€ç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆæ˜æ–‡ ï¼‰</li>
      <li>2ã€DaoAuthenticationProviderè·å–UserDetailsï¼ˆå…¶ä¸­å­˜å‚¨äº†ç”¨æˆ·çš„æ­£ç¡®å¯†ç ï¼‰</li>
      <li>3ã€DaoAuthenticationProviderä½¿ç”¨PasswordEncoderå¯¹è¾“å…¥çš„å¯†ç å’Œæ­£ç¡®çš„å¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¯†ç ä¸€è‡´åˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™æ ¡éªŒå¤±è´¥ã€‚</li>
    </ul>
  </li>
  <li>
    <p>å®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨BCryptPasswordEncoder, Pbkdf2PasswordEncoder, SCryptPasswordEncoderç­‰</p>
  </li>
  <li>
    <p>ä½¿ç”¨BCryptPasswordEncoder</p>

    <ul>
      <li>1ã€åœ¨å®‰å…¨é…ç½®ç±»ä¸­é…ç½®BCryptPasswordEncoder</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>æ·»åŠ ä¾èµ–ï¼š</li>
    </ul>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>

    <ul>
      <li>æµ‹è¯•</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBCrypt</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
        <span class="c1">//å¯¹åŸå§‹å¯†ç åŠ å¯†</span>
        <span class="nc">String</span> <span class="n">hashpw</span> <span class="o">=</span> <span class="nc">BCrypt</span><span class="o">.</span><span class="na">hashpw</span><span class="o">(</span><span class="s">"123"</span><span class="o">,</span><span class="nc">BCrypt</span><span class="o">.</span><span class="na">gensalt</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hashpw</span><span class="o">);</span>
        <span class="c1">//æ ¡éªŒåŸå§‹å¯†ç å’ŒBCryptå¯†ç æ˜¯å¦ä¸€è‡´</span>
        <span class="kt">boolean</span> <span class="n">checkpw</span> <span class="o">=</span> <span class="nc">BCrypt</span><span class="o">.</span><span class="na">checkpw</span><span class="o">(</span><span class="s">"123"</span><span class="o">,</span> <span class="s">"$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">checkpw</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>ä¿®æ”¹å®‰å…¨é…ç½®ç±»ï¼Œå®é™…é¡¹ç›®ä¸­å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç å¹¶ä¸æ˜¯åŸå§‹å¯†ç ï¼Œéƒ½æ˜¯ç»è¿‡åŠ å¯†å¤„ç†çš„å¯†ç ã€‚</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"$2a$10$1b5mIkehqv5c4KRrX9bUj.A4Y2hug3IGCnMCL5i4RpQrYV12xNKye"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="æˆæƒæµç¨‹">æˆæƒæµç¨‹</h3>

<ul>
  <li>Spring Securityå¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">http.authorizeRequests()</code>å¯¹webè¯·æ±‚è¿›è¡Œæˆæƒä¿æŠ¤ã€‚Spring Securityä½¿ç”¨æ ‡å‡†Filterå»ºç«‹äº†å¯¹webè¯·æ±‚çš„æ‹¦æˆªï¼Œæœ€ç»ˆå®ç°å¯¹èµ„æºçš„æˆæƒè®¿é—®ã€‚</li>
  <li>Spring Securityçš„æˆæƒæµç¨‹å¦‚ä¸‹ï¼š
    <ul>
      <li><strong>æ‹¦æˆªè¯·æ±‚</strong>ï¼Œå·²è®¤è¯ç”¨æˆ·è®¿é—®å—ä¿æŠ¤çš„webèµ„æºå°†è¢«SecurityFilterChainä¸­çš„<code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>çš„å­ç±»æ‹¦æˆªã€‚</li>
      <li><strong>è·å–èµ„æºè®¿é—®ç­–ç•¥</strong>ï¼ŒFilterSecurityInterceptorä¼šä»<code class="language-plaintext highlighter-rouge">SecurityMetadataSource</code>çš„å­ç±»<code class="language-plaintext highlighter-rouge">DefaultFilterInvocationSecurityMetadataSource</code>è·å–è¦è®¿é—®å½“å‰èµ„æºæ‰€éœ€è¦çš„æƒé™<code class="language-plaintext highlighter-rouge">Collection&lt;ConfigAttribute&gt;</code>ã€‚</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/aTW3FGwodSMRsQ6.png" alt="image.png" /></p>

<ul>
  <li>SecurityMetadataSourceå…¶å®å°±æ˜¯è¯»å–è®¿é—®ç­–ç•¥çš„æŠ½è±¡ï¼Œè€Œè¯»å–çš„å†…å®¹ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬é…ç½®çš„è®¿é—®è§„åˆ™ï¼Œ è¯»å–è®¿é—®ç­–ç•¥å¦‚ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">http</span>
   	<span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>                                                           
           <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r1"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p1"</span><span class="o">)</span>                                      
           <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r2"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p2"</span><span class="o">)</span>
           <span class="o">...</span>
</code></pre></div></div>

<ul>
  <li>æœ€åï¼ŒFilterSecurityInterceptorä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">AccessDecisionManager</code>è¿›è¡Œæˆæƒå†³ç­–ï¼Œè‹¥å†³ç­–é€šè¿‡ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºï¼Œå¦åˆ™å°†ç¦æ­¢è®¿é—®ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccessDecisionManager</span> <span class="o">{</span>
  	<span class="cm">/**
  	* é€šè¿‡ä¼ é€’çš„å‚æ•°æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™
  	*/</span>
    <span class="kt">void</span> <span class="nf">decide</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">configAttributes</span> <span class="o">)</span> <span class="kd">throws</span> <span class="nc">AccessDeniedException</span><span class="o">,</span> <span class="nc">InsufficientAuthenticationException</span><span class="o">;</span>
	 <span class="c1">//ç•¥..</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç€é‡è¯´æ˜ä¸€ä¸‹decideçš„å‚æ•°ï¼š
    <ul>
      <li>authenticationï¼šè¦è®¿é—®èµ„æºçš„è®¿é—®è€…çš„èº«ä»½</li>
      <li>objectï¼šè¦è®¿é—®çš„å—ä¿æŠ¤èµ„æºï¼Œwebè¯·æ±‚å¯¹åº”FilterInvocation</li>
      <li>configAttributesï¼šæ˜¯å—ä¿æŠ¤èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œé€šè¿‡SecurityMetadataSourceè·å–ã€‚</li>
    </ul>
  </li>
  <li><strong>decideæ¥å£å°±æ˜¯ç”¨æ¥é‰´å®šå½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™ã€‚</strong></li>
</ul>

<h4 id="æˆæƒå†³ç­–">æˆæƒå†³ç­–</h4>

<ul>
  <li>AccessDecisionManageré‡‡ç”¨<strong>æŠ•ç¥¨</strong>çš„æ–¹å¼æ¥ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè®¿é—®å—ä¿æŠ¤èµ„æºã€‚</li>
  <li>AccessDecisionManagerä¸­åŒ…å«çš„ä¸€ç³»åˆ—AccessDecisionVoterå°†ä¼šè¢«ç”¨æ¥å¯¹Authenticationæ˜¯å¦æœ‰æƒè®¿é—®å—ä¿æŠ¤å¯¹è±¡è¿›è¡ŒæŠ•ç¥¨ï¼ŒAccessDecisionManageræ ¹æ®æŠ•ç¥¨ç»“æœï¼Œåšå‡ºæœ€ç»ˆå†³ç­–ã€‚</li>
  <li>AccessDecisionVoteræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…¶ä¸­å®šä¹‰æœ‰ä¸‰ä¸ªæ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccessDecisionVoter</span><span class="o">&lt;</span><span class="no">S</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="no">ACCESS_GRANTED</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kt">int</span> <span class="no">ACCESS_ABSTAIN</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kt">int</span> <span class="no">ACCESS_DENIED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>

    <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">ConfigAttribute</span> <span class="n">var1</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">var1</span><span class="o">);</span>

    <span class="kt">int</span> <span class="nf">vote</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">var1</span><span class="o">,</span> <span class="no">S</span> <span class="n">var2</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">var3</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>vote()æ–¹æ³•çš„è¿”å›ç»“æœä¼šæ˜¯AccessDecisionVoterä¸­å®šä¹‰çš„ä¸‰ä¸ªå¸¸é‡ä¹‹ä¸€ã€‚ACCESS_GRANTEDè¡¨ç¤ºåŒæ„ï¼ŒACCESS_DENIEDè¡¨ç¤ºæ‹’ç»ï¼ŒACCESS_ABSTAINè¡¨ç¤ºå¼ƒæƒã€‚</li>
  <li>å¦‚æœä¸€ä¸ªAccessDecisionVoterä¸èƒ½åˆ¤å®šå½“å‰Authenticationæ˜¯å¦æ‹¥æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤å¯¹è±¡çš„æƒé™ï¼Œåˆ™å…¶vote()æ–¹æ³•çš„è¿”å›å€¼åº”å½“ä¸ºå¼ƒæƒACCESS_ABSTAINã€‚</li>
  <li>Spring Securityå†…ç½®äº†ä¸‰ä¸ªåŸºäºæŠ•ç¥¨çš„AccessDecisionManagerå®ç°ç±»å¦‚ä¸‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯<strong>AffirmativeBased</strong>ã€<strong>ConsensusBased</strong>å’Œ<strong>UnanimousBased</strong>ã€‚Spring securityé»˜è®¤ä½¿ç”¨çš„æ˜¯AffirmativeBasedã€‚</li>
  <li><strong>AffirmativeBased</strong>çš„é€»è¾‘æ˜¯ï¼š</li>
  <li>ï¼ˆ1ï¼‰åªè¦æœ‰AccessDecisionVoterçš„æŠ•ç¥¨ä¸ºACCESS_GRANTEDåˆ™åŒæ„ç”¨æˆ·è¿›è¡Œè®¿é—®</li>
  <li>ï¼ˆ2ï¼‰å¦‚æœå…¨éƒ¨å¼ƒæƒä¹Ÿè¡¨ç¤ºé€šè¿‡</li>
  <li>
    <p>ï¼ˆ3ï¼‰å¦‚æœæ²¡æœ‰ä¸€ä¸ªäººæŠ•èµæˆç¥¨ï¼Œä½†æ˜¯æœ‰äººæŠ•åå¯¹ç¥¨ï¼Œåˆ™å°†æŠ›å‡ºAccessDeniedException</p>
  </li>
  <li><strong>ConsensusBased</strong>çš„é€»è¾‘æ˜¯ï¼š</li>
  <li>ï¼ˆ1ï¼‰å¦‚æœèµæˆç¥¨å¤šäºåå¯¹ç¥¨åˆ™è¡¨ç¤ºé€šè¿‡ã€‚</li>
  <li>ï¼ˆ2ï¼‰åè¿‡æ¥ï¼Œå¦‚æœåå¯¹ç¥¨å¤šäºèµæˆç¥¨åˆ™å°†æŠ›å‡ºAccessDeniedExceptionã€‚</li>
  <li>ï¼ˆ3ï¼‰å¦‚æœèµæˆç¥¨ä¸åå¯¹ç¥¨ç›¸åŒä¸”ä¸ç­‰äº0ï¼Œå¹¶ä¸”å±æ€§allowIfEqualGrantedDeniedDecisionsçš„å€¼ä¸ºtrueï¼Œåˆ™è¡¨ç¤ºé€šè¿‡ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸AccessDeniedExceptionã€‚å‚æ•°allowIfEqualGrantedDeniedDecisionsçš„å€¼é»˜è®¤ä¸ºtrueã€‚</li>
  <li>ï¼ˆ4ï¼‰å¦‚æœæ‰€æœ‰çš„AccessDecisionVoteréƒ½å¼ƒæƒäº†ï¼Œåˆ™å°†è§†å‚æ•°allowIfAllAbstainDecisionsçš„å€¼è€Œå®šï¼Œå¦‚æœè¯¥å€¼ä¸ºtrueåˆ™è¡¨ç¤ºé€šè¿‡ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸AccessDeniedExceptionã€‚å‚æ•°allowIfAllAbstainDecisionsçš„å€¼é»˜è®¤ä¸ºfalseã€‚</li>
  <li><strong>UnanimousBased</strong>çš„é€»è¾‘ï¼š</li>
  <li>ä¸å¦å¤–ä¸¤ç§å®ç°æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œå¦å¤–ä¸¤ç§ä¼šä¸€æ¬¡æ€§æŠŠå—ä¿æŠ¤å¯¹è±¡çš„é…ç½®å±æ€§å…¨éƒ¨ä¼ é€’ç»™AccessDecisionVoterè¿›è¡ŒæŠ•ç¥¨ï¼Œè€ŒUnanimousBasedä¼šä¸€æ¬¡åªä¼ é€’ä¸€ä¸ªConfigAttributeç»™AccessDecisionVoterè¿›è¡ŒæŠ•ç¥¨ã€‚</li>
  <li>è¿™ä¹Ÿå°±æ„å‘³ç€å¦‚æœæˆ‘ä»¬çš„AccessDecisionVoterçš„é€»è¾‘æ˜¯åªè¦ä¼ é€’è¿›æ¥çš„ConfigAttributeä¸­æœ‰ä¸€ä¸ªèƒ½å¤ŸåŒ¹é…åˆ™æŠ•èµæˆç¥¨ï¼Œä½†æ˜¯æ”¾åˆ°UnanimousBasedä¸­å…¶æŠ•ç¥¨ç»“æœå°±ä¸ä¸€å®šæ˜¯èµæˆäº†</li>
  <li>ï¼ˆ1ï¼‰å¦‚æœå—ä¿æŠ¤å¯¹è±¡é…ç½®çš„æŸä¸€ä¸ªConfigAttributeè¢«ä»»æ„çš„AccessDecisionVoteråå¯¹äº†ï¼Œåˆ™å°†æŠ›å‡ºAccessDeniedExceptionã€‚</li>
  <li>ï¼ˆ2ï¼‰å¦‚æœæ²¡æœ‰åå¯¹ç¥¨ï¼Œä½†æ˜¯æœ‰èµæˆç¥¨ï¼Œåˆ™è¡¨ç¤ºé€šè¿‡ã€‚</li>
  <li>ï¼ˆ3ï¼‰å¦‚æœå…¨éƒ¨å¼ƒæƒäº†ï¼Œåˆ™å°†è§†å‚æ•°allowIfAllAbstainDecisionsçš„å€¼è€Œå®šï¼Œtrueåˆ™é€šè¿‡ï¼Œfalseåˆ™æŠ›å‡ºAccessDeniedExceptionã€‚</li>
</ul>

<h3 id="è‡ªå®šä¹‰è®¤è¯">è‡ªå®šä¹‰è®¤è¯</h3>

<h4 id="è‡ªå®šä¹‰ç™»å½•é¡µé¢">è‡ªå®šä¹‰ç™»å½•é¡µé¢</h4>

<ul>
  <li>
    <p>Spring Securityçš„é»˜è®¤é…ç½®æ²¡æœ‰æ˜ç¡®è®¾å®šä¸€ä¸ªç™»å½•é¡µé¢çš„URLï¼Œå› æ­¤Spring Securityä¼šæ ¹æ®å¯ç”¨çš„åŠŸèƒ½è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªç™»å½•é¡µé¢URLï¼Œå¹¶ä½¿ç”¨é»˜è®¤URLå¤„ç†ç™»å½•çš„æäº¤å†…å®¹ï¼Œç™»å½•åè·³è½¬çš„åˆ°é»˜è®¤URLç­‰ç­‰ã€‚å°½ç®¡è‡ªåŠ¨ç”Ÿæˆçš„ç™»å½•é¡µé¢å¾ˆæ–¹ä¾¿å¿«é€Ÿå¯åŠ¨å’Œè¿è¡Œï¼Œä½†å¤§å¤šæ•°åº”ç”¨ç¨‹åºéƒ½å¸Œæœ›å®šä¹‰è‡ªå·±çš„ç™»å½•é¡µé¢ã€‚</p>
  </li>
  <li>
    <p>åœ¨é¡¹ç›®å·¥ç¨‹ä¸­åˆ›å»ºè‡ªå·±çš„ç™»å½•é¡µé¢</p>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>webapp---WEB-INF---views---login.jsp
</code></pre></div></div>

<ul>
  <li>åœ¨WebConfig.javaä¸­é…ç½®è®¤è¯é¡µé¢åœ°å€ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//é»˜è®¤Urlæ ¹è·¯å¾„è·³è½¬åˆ°/loginï¼Œæ­¤urlä¸ºspring securityæä¾›</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addViewControllers</span><span class="o">(</span><span class="nc">ViewControllerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">addViewController</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"redirect:/login-view"</span><span class="o">);</span>
    <span class="n">registry</span><span class="o">.</span><span class="na">addViewController</span><span class="o">(</span><span class="s">"/login-view"</span><span class="o">).</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"login"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>åœ¨WebSecurityConfigä¸­é…ç½®è¡¨ç« ç™»å½•ä¿¡æ¯ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//é…ç½®å®‰å…¨æ‹¦æˆªæœºåˆ¶</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span> <span class="c1">//æ‰€æœ‰çš„/r/**è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>             <span class="c1">//é™¤äº†/r/**ä»¥å¤–çš„è¯·æ±‚éƒ½å¯ä»¥ç›´æ¥è®¿é—®</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span><span class="c1">//å…è®¸è¡¨å•ç™»å½•</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
            		<span class="o">.</span><span class="na">loginPage</span><span class="o">(</span><span class="s">"/login-view"</span><span class="o">)</span> <span class="c1">//é…ç½®ç™»å½•URL</span>
            		<span class="o">.</span><span class="na">loginProcessingUrl</span><span class="o">(</span><span class="s">"/login"</span><span class="o">)</span> <span class="c1">//é…ç½®ç™»å½•éªŒè¯è¯·æ±‚åœ°å€</span>
            		<span class="o">.</span><span class="na">successForwardUrl</span><span class="o">(</span><span class="s">"/login-success"</span><span class="o">);</span><span class="c1">//è‡ªå®šä¹‰ç™»å½•æˆåŠŸåçš„è·³è½¬åœ°å€</span>
        			<span class="o">.</span><span class="na">permitAll</span><span class="o">();</span> <span class="c1">//å…è®¸ä»»æ„ç”¨æˆ·è®¿é—®åŸºäºè¡¨å•ç™»å½•çš„æ‰€æœ‰çš„URLã€‚</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>spring securityä¸ºé˜²æ­¢CSRFï¼ˆCross-site request forgeryè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰çš„å‘ç”Ÿï¼Œé™åˆ¶äº†é™¤äº†getä»¥å¤–çš„å¤§å¤šæ•°æ–¹æ³•ã€‚</p>
  </li>
  <li>
    <p>è§£å†³æ–¹æ³•1ï¼š</p>

    <p>å±è”½CSRFæ§åˆ¶ï¼Œå³spring securityä¸å†é™åˆ¶CSRFã€‚</p>

    <p>é…ç½®WebSecurityConfig</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>	<span class="c1">//å±è”½CSRFæ§åˆ¶ï¼Œå³spring securityä¸å†é™åˆ¶CSRF</span>
            <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>è§£å†³æ–¹æ³•2ï¼š</p>

    <p>åœ¨login.jspé¡µé¢æ·»åŠ ä¸€ä¸ªtokenï¼Œspring securityä¼šéªŒè¯tokenï¼Œå¦‚æœtokenåˆæ³•åˆ™å¯ä»¥ç»§ç»­è¯·æ±‚ã€‚</p>

    <p>ä¿®æ”¹login.jsp</p>
  </li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"login"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span>  <span class="na">name=</span><span class="s">"${_csrf.parameterName}"</span>   <span class="na">value=</span><span class="s">"${_csrf.token}"</span><span class="nt">/&gt;</span>
   ...
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<h4 id="è¿æ¥æ•°æ®åº“">è¿æ¥æ•°æ®åº“</h4>

<ul>
  <li>æ·»åŠ ä¾èµ–</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

<span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<ul>
  <li>å®šä¹‰dataSourceï¼šåœ¨application.propertiesé…ç½®</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:mysql://localhost:3306/user_db</span>
<span class="py">spring.datasource.username</span><span class="p">=</span><span class="s">root</span>
<span class="py">spring.datasource.password</span><span class="p">=</span><span class="s">mysql</span>
<span class="py">spring.datasource.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.jdbc.Driver</span>
</code></pre></div></div>

<ul>
  <li>å®šä¹‰Dao:å®šä¹‰æ¨¡å‹ç±»å‹ï¼Œåœ¨modelåŒ…å®šä¹‰UserDtoï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDto</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">fullname</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">mobile</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>åœ¨DaoåŒ…å®šä¹‰UserDaoï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nc">UserDto</span> <span class="nf">getUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">){</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span><span class="s">"select id,username,password,fullname from t_user where username = ?"</span><span class="o">;</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">UserDto</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">username</span><span class="o">},</span> <span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">UserDto</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="k">if</span><span class="o">(</span><span class="n">list</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">list</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">list</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>åœ¨serviceåŒ…ä¸‹å®šä¹‰SpringDataUserDetailsServiceï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringDataUserDetailsService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="nc">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="c1">//ç™»å½•è´¦å·</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"username="</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
        <span class="c1">//æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...</span>
        <span class="nc">UserDto</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//æ³¨æ„è¿™é‡Œå¦‚æœä½¿ç”¨BCryptPasswordEncoderå¯†ç ç¼–è¾‘å™¨ï¼Œåœ¨æ•°æ®åº“ä¸­å­˜å‚¨çš„åº”è¯¥æ˜¯å¯†æ–‡</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getFullname</span><span class="o">()).</span><span class="na">password</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ä¼šè¯">ä¼šè¯</h3>

<ul>
  <li>ç”¨æˆ·è®¤è¯é€šè¿‡åï¼Œä¸ºäº†é¿å…ç”¨æˆ·çš„æ¯æ¬¡æ“ä½œéƒ½è¿›è¡Œè®¤è¯å¯å°†ç”¨æˆ·çš„ä¿¡æ¯ä¿å­˜åœ¨ä¼šè¯ä¸­ã€‚spring securityæä¾›ä¼šè¯ç®¡ç†ï¼Œè®¤è¯é€šè¿‡åå°†èº«ä»½ä¿¡æ¯æ”¾å…¥SecurityContextHolderä¸Šä¸‹æ–‡ï¼ŒSecurityContextä¸å½“å‰çº¿ç¨‹è¿›è¡Œç»‘å®šï¼Œæ–¹ä¾¿è·å–ç”¨æˆ·èº«ä»½ã€‚</li>
</ul>

<h4 id="è·å–ç”¨æˆ·èº«ä»½">è·å–ç”¨æˆ·èº«ä»½</h4>

<ul>
  <li>ç¼–å†™LoginControllerï¼Œå®ç°/r/r1ã€/r/r2çš„æµ‹è¯•èµ„æºï¼Œå¹¶ä¿®æ”¹loginSuccessæ–¹æ³•ï¼Œæ³¨æ„getUsernameæ–¹æ³•ï¼ŒSpring Securityè·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ³•ä¸ºSecurityContextHolder.getContext().getAuthentication()</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoginController</span> <span class="o">{</span>

    <span class="cm">/**
     * ç”¨æˆ·ç™»å½•æˆåŠŸ
     * @return
     */</span>
    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login-success"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">loginSuccess</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getUsername</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">+</span> <span class="s">" ç™»å½•æˆåŠŸ"</span><span class="o">;</span>
    <span class="o">}</span>

   <span class="cm">/**
     * è·å–å½“å‰ç™»å½•ç”¨æˆ·å
     * @return
     */</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">(){</span>
        <span class="c1">//è·å–è®¤è¯åçš„ç”¨æˆ·ä¿¡æ¯</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="c1">//æ²¡æœ‰è®¤è¯</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">authentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">()){</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">Object</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">principal</span> <span class="k">instanceof</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">UserDetails</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">username</span> <span class="o">=</span> <span class="o">((</span><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">security</span><span class="o">.</span><span class="na">core</span><span class="o">.</span><span class="na">userdetails</span><span class="o">.</span><span class="na">UserDetails</span><span class="o">)</span><span class="n">principal</span><span class="o">).</span><span class="na">getUsername</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">principal</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>

        <span class="o">}</span>
        <span class="k">return</span> <span class="n">username</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æµ‹è¯•èµ„æº1
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r1"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">r1</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getUsername</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">+</span> <span class="s">" è®¿é—®èµ„æº1"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/**
     * æµ‹è¯•èµ„æº2
     * @return
     */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r2"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">r2</span><span class="o">(){</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">getUsername</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">+</span> <span class="s">" è®¿é—®èµ„æº2"</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ä¼šè¯æ§åˆ¶">ä¼šè¯æ§åˆ¶</h4>

<ul>
  <li>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é€‰é¡¹å‡†ç¡®æ§åˆ¶ä¼šè¯ä½•æ—¶åˆ›å»ºä»¥åŠSpring Securityå¦‚ä½•ä¸ä¹‹äº¤äº’ï¼š</li>
</ul>

<table>
  <thead>
    <tr>
      <th>æœºåˆ¶</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>always</td>
      <td>å¦‚æœæ²¡æœ‰sessionå­˜åœ¨å°±åˆ›å»ºä¸€ä¸ª</td>
    </tr>
    <tr>
      <td>ifRequired</td>
      <td>å¦‚æœéœ€è¦å°±åˆ›å»ºä¸€ä¸ªSessionï¼ˆé»˜è®¤ï¼‰ç™»å½•æ—¶</td>
    </tr>
    <tr>
      <td>never</td>
      <td>SpringSecurity å°†ä¸ä¼šåˆ›å»ºSessionï¼Œä½†æ˜¯å¦‚æœåº”ç”¨ä¸­å…¶ä»–åœ°æ–¹åˆ›å»ºäº†Sessionï¼Œé‚£ä¹ˆSpring Securityå°†ä¼šä½¿ç”¨å®ƒã€‚</td>
    </tr>
    <tr>
      <td>stateless</td>
      <td>SpringSecurityå°†ç»å¯¹ä¸ä¼šåˆ›å»ºSessionï¼Œä¹Ÿä¸ä½¿ç”¨Session</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>é€šè¿‡ä»¥ä¸‹é…ç½®æ–¹å¼å¯¹è¯¥é€‰é¡¹è¿›è¡Œé…ç½®ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
   <span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
        <span class="o">.</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">IF_REQUIRED</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒSpring Securityä¼šä¸ºæ¯ä¸ªç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¼šæ–°å»ºä¸€ä¸ªSessionï¼Œå°±æ˜¯<strong>ifRequired</strong> ã€‚</li>
  <li>è‹¥é€‰ç”¨<strong>never</strong>ï¼Œåˆ™æŒ‡ç¤ºSpring Securityå¯¹ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¸åˆ›å»ºSessionäº†ï¼Œä½†è‹¥ä½ çš„åº”ç”¨ç¨‹åºåœ¨æŸåœ°æ–¹æ–°å»ºäº†sessionï¼Œé‚£ä¹ˆSpring Securityä¼šç”¨å®ƒçš„ã€‚</li>
  <li>è‹¥ä½¿ç”¨<strong>stateless</strong>ï¼Œåˆ™è¯´æ˜Spring Securityå¯¹ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¸ä¼šåˆ›å»ºSessionäº†ï¼Œä½ çš„åº”ç”¨ç¨‹åºä¹Ÿä¸ä¼šå…è®¸æ–°å»ºsessionã€‚å¹¶ä¸”å®ƒä¼šæš—ç¤ºä¸ä½¿ç”¨cookieï¼Œæ‰€ä»¥æ¯ä¸ªè¯·æ±‚éƒ½éœ€è¦é‡æ–°è¿›è¡Œèº«ä»½éªŒè¯ã€‚è¿™ç§æ— çŠ¶æ€æ¶æ„é€‚ç”¨äºREST APIåŠå…¶æ— çŠ¶æ€è®¤è¯æœºåˆ¶ã€‚</li>
</ul>

<h4 id="ä¼šè¯è¶…æ—¶">ä¼šè¯è¶…æ—¶</h4>

<ul>
  <li>
    <p>å¯ä»¥åœ¨sevletå®¹å™¨ä¸­è®¾ç½®Sessionçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚ä¸‹è®¾ç½®Sessionæœ‰æ•ˆæœŸä¸º3600sï¼›</p>
  </li>
  <li>
    <p>spring boot é…ç½®æ–‡ä»¶ï¼š</p>
  </li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.servlet.session.timeout</span><span class="p">=</span><span class="s">3600s</span>
</code></pre></div></div>

<ul>
  <li>sessionè¶…æ—¶ä¹‹åï¼Œå¯ä»¥é€šè¿‡Spring Security è®¾ç½®è·³è½¬çš„è·¯å¾„ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="na">sessionManagement</span><span class="o">()</span>
    <span class="o">.</span><span class="na">expiredUrl</span><span class="o">(</span><span class="s">"/login-view?error=EXPIRED_SESSION"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">invalidSessionUrl</span><span class="o">(</span><span class="s">"/login-view?error=INVALID_SESSION"</span><span class="o">);</span>
</code></pre></div></div>

<ul>
  <li>expiredæŒ‡sessionè¿‡æœŸï¼ŒinvalidSessionæŒ‡ä¼ å…¥çš„sessionidæ— æ•ˆã€‚</li>
</ul>

<h4 id="å®‰å…¨ä¼šè¯">å®‰å…¨ä¼šè¯</h4>

<ul>
  <li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨httpOnlyå’Œsecureæ ‡ç­¾æ¥ä¿æŠ¤æˆ‘ä»¬çš„ä¼šè¯cookieï¼š
    <ul>
      <li><strong>httpOnly</strong>ï¼šå¦‚æœä¸ºtrueï¼Œé‚£ä¹ˆæµè§ˆå™¨è„šæœ¬å°†æ— æ³•è®¿é—®cookie</li>
      <li><strong>secure</strong>ï¼šå¦‚æœä¸ºtrueï¼Œåˆ™cookieå°†ä»…é€šè¿‡HTTPSè¿æ¥å‘é€</li>
    </ul>
  </li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.servlet.session.cookie.http-only</span><span class="p">=</span><span class="s">true</span>
<span class="py">server.servlet.session.cookie.secure</span><span class="p">=</span><span class="s">true</span>
</code></pre></div></div>

<h3 id="é€€å‡º">é€€å‡º</h3>

<ul>
  <li>Spring securityé»˜è®¤å®ç°äº†logouté€€å‡ºï¼Œè®¿é—®/logoutï¼Œæœç„¶ä¸å‡ºæ‰€æ–™ï¼Œé€€å‡ºåŠŸèƒ½Springä¹Ÿæ›¿æˆ‘ä»¬åšå¥½äº†ã€‚</li>
  <li>è‡ªå®šä¹‰é€€å‡ºæˆåŠŸçš„é¡µé¢ï¼š</li>
  <li>åœ¨WebSecurityConfigçš„protected void configure(HttpSecurity http)ä¸­é…ç½®ï¼š</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.and()
.logout()
.logoutUrl("/logout")
.logoutSuccessUrl("/login-view?logout");
</code></pre></div></div>

<ul>
  <li>å½“é€€å‡ºæ“ä½œå‡ºå‘æ—¶ï¼Œå°†å‘ç”Ÿï¼š
    <ul>
      <li>ä½¿HTTP Session æ— æ•ˆ</li>
      <li>æ¸…é™¤<code class="language-plaintext highlighter-rouge">SecurityContextHolder</code></li>
      <li>è·³è½¬åˆ° <code class="language-plaintext highlighter-rouge">/login-view?logout</code></li>
    </ul>
  </li>
  <li>ç±»ä¼¼äºé…ç½®ç™»å½•åŠŸèƒ½ï¼Œå’±ä»¬å¯ä»¥è¿›ä¸€æ­¥è‡ªå®šä¹‰é€€å‡ºåŠŸèƒ½ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
            <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
      		<span class="c1">//...</span>
            <span class="o">.</span><span class="na">and</span><span class="o">()</span>
            <span class="o">.</span><span class="na">logout</span><span class="o">()</span>                                                    <span class="o">(</span><span class="mi">1</span><span class="o">)</span>
                <span class="o">.</span><span class="na">logoutUrl</span><span class="o">(</span><span class="s">"/logout"</span><span class="o">)</span>                                    <span class="o">(</span><span class="mi">2</span><span class="o">)</span>
                <span class="o">.</span><span class="na">logoutSuccessUrl</span><span class="o">(</span><span class="s">"/login-view?logout"</span><span class="o">)</span>                  <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
                <span class="o">.</span><span class="na">logoutSuccessHandler</span><span class="o">(</span><span class="n">logoutSuccessHandler</span><span class="o">)</span>              <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
      		    <span class="o">.</span><span class="na">addLogoutHandler</span><span class="o">(</span><span class="n">logoutHandler</span><span class="o">)</span>                         <span class="o">(</span><span class="mi">5</span><span class="o">)</span>
                <span class="o">.</span><span class="na">invalidateHttpSession</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>                             <span class="o">(</span><span class="mi">6</span><span class="o">)</span>
                
<span class="o">}</span>

<span class="cm">/*
ï¼ˆ1ï¼‰æä¾›ç³»ç»Ÿé€€å‡ºæ”¯æŒï¼Œä½¿ç”¨WebSecurityConfigurerAdapterä¼šè‡ªåŠ¨è¢«åº”ç”¨
ï¼ˆ2ï¼‰è®¾ç½®è§¦å‘é€€å‡ºæ“ä½œçš„URL (é»˜è®¤æ˜¯/logout).
ï¼ˆ3ï¼‰é€€å‡ºä¹‹åè·³è½¬çš„URLã€‚é»˜è®¤æ˜¯/login?logoutã€‚
ï¼ˆ4ï¼‰å®šåˆ¶çš„ LogoutSuccessHandler ï¼Œç”¨äºå®ç°ç”¨æˆ·é€€å‡ºæˆåŠŸæ—¶çš„å¤„ç†ã€‚å¦‚æœæŒ‡å®šäº†è¿™ä¸ªé€‰é¡¹é‚£ä¹ˆlogoutSuccessUrl()çš„è®¾ç½®ä¼šè¢«å¿½ç•¥ã€‚
ï¼ˆ5ï¼‰æ·»åŠ ä¸€ä¸ªLogoutHandlerï¼Œç”¨äºå®ç°ç”¨æˆ·é€€å‡ºæ—¶çš„æ¸…ç†å·¥ä½œ.é»˜è®¤SecurityContextLogoutHandlerä¼šè¢«æ·»åŠ ä¸ºæœ€åä¸€ä¸ªLogoutHandlerã€‚
ï¼ˆ6ï¼‰æŒ‡å®šæ˜¯å¦åœ¨é€€å‡ºæ—¶è®©HttpSessionæ— æ•ˆã€‚ é»˜è®¤è®¾ç½®ä¸º trueã€‚
*/</span>
</code></pre></div></div>

<ul>
  <li><strong>æ³¨æ„ï¼šå¦‚æœè®©logoutåœ¨GETè¯·æ±‚ä¸‹ç”Ÿæ•ˆï¼Œå¿…é¡»å…³é—­é˜²æ­¢CSRFæ”»å‡»csrf().disable()ã€‚å¦‚æœå¼€å¯äº†CSRFï¼Œå¿…é¡»ä½¿ç”¨postæ–¹å¼è¯·æ±‚/logout</strong></li>
</ul>

<h4 id="logouthandler">logoutHandler</h4>

<ul>
  <li>ä¸€èˆ¬æ¥è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">LogoutHandler</code>çš„å®ç°ç±»è¢«ç”¨æ¥æ‰§è¡Œå¿…è¦çš„æ¸…ç†ï¼Œå› è€Œä»–ä»¬ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li>ä¸‹é¢æ˜¯Spring Securityæä¾›çš„ä¸€äº›å®ç°ï¼š
    <ul>
      <li>PersistentTokenBasedRememberMeServices åŸºäºæŒä¹…åŒ–tokençš„<strong>RememberMe</strong>åŠŸèƒ½çš„ç›¸å…³æ¸…ç†</li>
      <li>TokenBasedRememberMeService åŸºäºtokençš„<strong>RememberMe</strong>åŠŸèƒ½çš„ç›¸å…³æ¸…ç†</li>
      <li>CookieClearingLogoutHandler é€€å‡ºæ—¶Cookieçš„ç›¸å…³æ¸…ç†</li>
      <li>CsrfLogoutHandler è´Ÿè´£åœ¨é€€å‡ºæ—¶ç§»é™¤csrfToken</li>
      <li>SecurityContextLogoutHandler é€€å‡ºæ—¶SecurityContextçš„ç›¸å…³æ¸…ç†</li>
    </ul>
  </li>
  <li>é“¾å¼APIæä¾›äº†è°ƒç”¨ç›¸åº”çš„<code class="language-plaintext highlighter-rouge">LogoutHandler</code> å®ç°çš„å¿«æ·æ–¹å¼ï¼Œæ¯”å¦‚deleteCookies()ã€‚</li>
</ul>

<h3 id="æˆæƒ">æˆæƒ</h3>

<ul>
  <li>æˆæƒçš„æ–¹å¼åŒ…æ‹¬ <strong>webæˆæƒå’Œæ–¹æ³•æˆæƒ</strong>ï¼Œwebæˆæƒæ˜¯é€šè¿‡ urlæ‹¦æˆªè¿›è¡Œæˆæƒï¼Œæ–¹æ³•æˆæƒæ˜¯é€šè¿‡ æ–¹æ³•æ‹¦æˆªè¿›è¡Œæˆæƒã€‚ä»–ä»¬éƒ½ä¼šè°ƒç”¨accessDecisionManagerè¿›è¡Œæˆæƒå†³ç­–ï¼Œè‹¥ä¸ºwebæˆæƒåˆ™æ‹¦æˆªå™¨ä¸ºFilterSecurityInterceptorï¼›è‹¥ä¸ºæ–¹æ³•æˆæƒåˆ™æ‹¦æˆªå™¨ä¸ºMethodSecurityInterceptorã€‚å¦‚æœåŒæ—¶é€šè¿‡webæˆæƒå’Œæ–¹æ³•æˆæƒåˆ™å…ˆæ‰§è¡Œwebæˆæƒï¼Œå†æ‰§è¡Œæ–¹æ³•æˆæƒï¼Œæœ€åå†³ç­–é€šè¿‡ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºï¼Œå¦åˆ™å°†ç¦æ­¢è®¿é—®ã€‚</li>
</ul>

<h4 id="æ•°æ®åº“">æ•°æ®åº“</h4>

<ul>
  <li>è§’è‰²è¡¨ï¼š</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`t_role`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²id'</span><span class="p">,</span>
  <span class="nv">`role_name`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²åç§°'</span><span class="p">,</span>
  <span class="nv">`description`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²æè¿°'</span><span class="p">,</span>
  <span class="nv">`create_time`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²åˆ›å»ºæ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`update_time`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²ä¿®æ”¹æ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`status`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²çŠ¶æ€'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">),</span>
  <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="nv">`unique_role_name`</span> <span class="p">(</span><span class="nv">`role_name`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>

<span class="k">insert</span>  <span class="k">into</span> <span class="nv">`t_role`</span><span class="p">(</span><span class="nv">`id`</span><span class="p">,</span><span class="nv">`role_name`</span><span class="p">,</span><span class="nv">`description`</span><span class="p">,</span><span class="nv">`create_time`</span><span class="p">,</span><span class="nv">`update_time`</span><span class="p">,</span><span class="nv">`status`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'ç®¡ç†å‘˜'</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="s1">''</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>ç”¨æˆ·è§’è‰²å…³ç³»è¡¨ï¼š</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`t_user_role`</span> <span class="p">(</span>
  <span class="nv">`user_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'ç”¨æˆ·id'</span><span class="p">,</span>
  <span class="nv">`role_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²id'</span><span class="p">,</span>
  <span class="nv">`create_time`</span> <span class="nb">datetime</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'åˆ›å»ºæ—¶é—´'</span><span class="p">,</span>
  <span class="nv">`creator`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'åˆ›å»ºè€…'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`user_id`</span><span class="p">,</span><span class="nv">`role_id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>


<span class="k">insert</span>  <span class="k">into</span> <span class="nv">`t_user_role`</span><span class="p">(</span><span class="nv">`user_id`</span><span class="p">,</span><span class="nv">`role_id`</span><span class="p">,</span><span class="nv">`create_time`</span><span class="p">,</span><span class="nv">`creator`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">,</span><span class="k">NULL</span><span class="p">,</span><span class="k">NULL</span><span class="p">);</span>

</code></pre></div></div>

<ul>
  <li>æƒé™è¡¨ï¼š</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`t_permission`</span> <span class="p">(</span>
  <span class="nv">`id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`code`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æƒé™æ ‡è¯†ç¬¦'</span><span class="p">,</span>
  <span class="nv">`description`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æè¿°'</span><span class="p">,</span>
  <span class="nv">`url`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è¯·æ±‚åœ°å€'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>

<span class="k">insert</span>  <span class="k">into</span> <span class="nv">`t_permission`</span><span class="p">(</span><span class="nv">`id`</span><span class="p">,</span><span class="nv">`code`</span><span class="p">,</span><span class="nv">`description`</span><span class="p">,</span><span class="nv">`url`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'p1'</span><span class="p">,</span><span class="s1">'æµ‹è¯•èµ„æº1'</span><span class="p">,</span><span class="s1">'/r/r1'</span><span class="p">),(</span><span class="s1">'2'</span><span class="p">,</span><span class="s1">'p3'</span><span class="p">,</span><span class="s1">'æµ‹è¯•èµ„æº2'</span><span class="p">,</span><span class="s1">'/r/r2'</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>è§’è‰²æƒé™å…³ç³»è¡¨ï¼š</li>
</ul>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`t_role_permission`</span> <span class="p">(</span>
  <span class="nv">`role_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'è§’è‰²id'</span><span class="p">,</span>
  <span class="nv">`permission_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æƒé™id'</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`role_id`</span><span class="p">,</span><span class="nv">`permission_id`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span>

<span class="k">insert</span>  <span class="k">into</span> <span class="nv">`t_role_permission`</span><span class="p">(</span><span class="nv">`role_id`</span><span class="p">,</span><span class="nv">`permission_id`</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'1'</span><span class="p">),(</span><span class="s1">'1'</span><span class="p">,</span><span class="s1">'2'</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="ä¿®æ”¹æˆæƒé€»è¾‘">ä¿®æ”¹æˆæƒé€»è¾‘</h4>

<ul>
  <li>ä¿®æ”¹daoæ¥å£ï¼šåœ¨UserDaoä¸­æ·»åŠ </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ·æƒé™</span>
<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">findPermissionsByUserId</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">){</span>
    <span class="nc">String</span> <span class="n">sql</span><span class="o">=</span><span class="s">"SELECT * FROM t_permission WHERE id IN(\n"</span> <span class="o">+</span>
            <span class="s">"SELECT permission_id FROM t_role_permission WHERE role_id IN(\n"</span> <span class="o">+</span>
            <span class="s">"\tSELECT role_id FROM t_user_role WHERE user_id = ? \n"</span> <span class="o">+</span>
            <span class="s">")\n"</span> <span class="o">+</span>
            <span class="s">")"</span><span class="o">;</span>

    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">PermissionDto</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]{</span><span class="n">userId</span><span class="o">},</span> <span class="k">new</span> <span class="nc">BeanPropertyRowMapper</span><span class="o">&lt;&gt;(</span><span class="nc">PermissionDto</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
    <span class="c1">//è·å–æƒé™æ ‡è¯†ç¬¦</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
    <span class="n">list</span><span class="o">.</span><span class="na">iterator</span><span class="o">().</span><span class="na">forEachRemaining</span><span class="o">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">permissions</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="na">getCode</span><span class="o">()));</span>
    <span class="k">return</span> <span class="n">permissions</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä¿®æ”¹UserDetailServiceï¼šå®ç°ä»æ•°æ®åº“è¯»å–æƒé™</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
    <span class="c1">//ç™»å½•è´¦å·</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"username="</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
    <span class="c1">//æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...</span>
    <span class="nc">UserDto</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æŸ¥è¯¢ç”¨æˆ·æƒé™</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findPermissionsByUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">perarray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">permissions</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
    <span class="n">permissions</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">perarray</span><span class="o">);</span>
    <span class="c1">//åˆ›å»ºuserDetails</span>
    <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getFullname</span><span class="o">()).</span><span class="na">password</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()).</span><span class="na">authorities</span><span class="o">(</span><span class="n">perarray</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="webæˆæƒ">WEBæˆæƒ</h4>

<ul>
  <li>æˆ‘ä»¬æƒ³è¿›è¡Œçµæ´»çš„æˆæƒæ§åˆ¶è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿé€šè¿‡ç»™<code class="language-plaintext highlighter-rouge">http.authorizeRequests()</code>æ·»åŠ å¤šä¸ªå­èŠ‚ç‚¹æ¥å®šåˆ¶éœ€æ±‚åˆ°æˆ‘ä»¬çš„URL</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">http</span>
        <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>                                          <span class="o">(</span><span class="mi">1</span><span class="o">)</span>
        <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r1"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p1"</span><span class="o">)</span>                      <span class="o">(</span><span class="mi">2</span><span class="o">)</span>
        <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r2"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p2"</span><span class="o">)</span>                      <span class="o">(</span><span class="mi">3</span><span class="o">)</span>
        <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r3"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"hasAuthority('p1') and hasAuthority('p2')"</span><span class="o">)</span> <span class="o">(</span><span class="mi">4</span><span class="o">)</span>
        <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span>                         <span class="o">(</span><span class="mi">5</span><span class="o">)</span>
        <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>                                     <span class="o">(</span><span class="mi">6</span><span class="o">)</span>
        <span class="o">.</span><span class="na">and</span><span class="o">()</span>
        <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
        <span class="c1">// ...</span>
<span class="o">}</span>

<span class="cm">/*
ï¼ˆ1ï¼‰http.authorizeRequests()æ–¹æ³•æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œæ¯ä¸ªmacheræŒ‰ç…§ä»–ä»¬çš„å£°æ˜é¡ºåºæ‰§è¡Œã€‚

ï¼ˆ2ï¼‰æŒ‡å®šâ€/r/r1â€URLï¼Œæ‹¥æœ‰p1æƒé™æ ‡è¯†ç¬¦èƒ½å¤Ÿè®¿é—®

ï¼ˆ3ï¼‰æŒ‡å®šâ€/r/r2â€URLï¼Œæ‹¥æœ‰p2æƒé™æ ‡è¯†ç¬¦èƒ½å¤Ÿè®¿é—®

ï¼ˆ4ï¼‰æŒ‡å®šäº†â€/r/r3â€URLï¼ŒåŒæ—¶æ‹¥æœ‰p1å’Œp2æƒé™æ ‡è¯†ç¬¦æ‰èƒ½å¤Ÿè®¿é—®

ï¼ˆ5ï¼‰æŒ‡å®šäº†é™¤äº†r1ã€r2ã€r3ä¹‹å¤–â€/r/**â€œèµ„æºï¼ŒåŒæ—¶é€šè¿‡èº«ä»½è®¤è¯å°±èƒ½å¤Ÿè®¿é—®ï¼Œè¿™é‡Œä½¿ç”¨SpELï¼ˆSpring Expression Languageï¼‰è¡¨è¾¾å¼ã€‚ã€‚

ï¼ˆ6ï¼‰å‰©ä½™çš„å°šæœªåŒ¹é…çš„èµ„æºï¼Œä¸åšä¿æŠ¤ã€‚
*/</span>
</code></pre></div></div>

<ul>
  <li><strong>æ³¨æ„ï¼šè§„åˆ™çš„é¡ºåºæ˜¯é‡è¦çš„,æ›´å…·ä½“çš„è§„åˆ™åº”è¯¥å…ˆå†™</strong>ã€‚ç°åœ¨ä»¥/ adminå¼€å§‹çš„æ‰€æœ‰å†…å®¹éƒ½éœ€è¦å…·æœ‰ADMINè§’è‰²çš„èº«ä»½éªŒè¯ç”¨æˆ·,å³ä½¿æ˜¯/ admin / loginè·¯å¾„(å› ä¸º/ admin / loginå·²ç»è¢«/ admin / **è§„åˆ™åŒ¹é…,å› æ­¤ç¬¬äºŒä¸ªè§„åˆ™è¢«å¿½ç•¥).</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">)</span>
<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/login"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
</code></pre></div></div>

<ul>
  <li>å› æ­¤,ç™»å½•é¡µé¢çš„è§„åˆ™åº”è¯¥åœ¨/ admin / **è§„åˆ™ä¹‹å‰.ä¾‹å¦‚.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/login"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/admin/**"</span><span class="o">).</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"ADMIN"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>ä¿æŠ¤URLå¸¸ç”¨çš„æ–¹æ³•æœ‰ï¼š
    <ul>
      <li><strong>authenticated()</strong> ä¿æŠ¤URLï¼Œéœ€è¦ç”¨æˆ·ç™»å½•</li>
      <li><strong>permitAll()</strong> æŒ‡å®šURLæ— éœ€ä¿æŠ¤ï¼Œä¸€èˆ¬åº”ç”¨ä¸é™æ€èµ„æºæ–‡ä»¶</li>
      <li><strong>hasRole(String role)</strong> é™åˆ¶å•ä¸ªè§’è‰²è®¿é—®ï¼Œè§’è‰²å°†è¢«å¢åŠ  â€œROLE_â€ .æ‰€ä»¥â€ADMINâ€ å°†å’Œ â€œROLE_ADMINâ€è¿›è¡Œæ¯”è¾ƒ</li>
      <li><strong>hasAuthority(String authority)</strong> é™åˆ¶å•ä¸ªæƒé™è®¿é—®</li>
      <li><strong>hasAnyRole(Stringâ€¦ roles)</strong>å…è®¸å¤šä¸ªè§’è‰²è®¿é—®</li>
      <li><strong>hasAnyAuthority(Stringâ€¦ authorities)</strong> å…è®¸å¤šä¸ªæƒé™è®¿é—®</li>
      <li><strong>access(String attribute)</strong> è¯¥æ–¹æ³•ä½¿ç”¨ SpELè¡¨è¾¾å¼, æ‰€ä»¥å¯ä»¥åˆ›å»ºå¤æ‚çš„é™åˆ¶</li>
      <li><strong>hasIpAddress(String ipaddressExpression)</strong> é™åˆ¶IPåœ°å€æˆ–å­ç½‘</li>
    </ul>
  </li>
</ul>

<h4 id="æ–¹æ³•æˆæƒ">æ–¹æ³•æˆæƒ</h4>

<ul>
  <li>ä»Spring Security2.0ç‰ˆæœ¬å¼€å§‹ï¼Œå®ƒæ”¯æŒæœåŠ¡å±‚æ–¹æ³•çš„å®‰å…¨æ€§çš„æ”¯æŒã€‚æœ¬èŠ‚å­¦ä¹ @PreAuthorize,@PostAuthorize, @Securedä¸‰ç±»æ³¨è§£ã€‚</li>
  <li>æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•<code class="language-plaintext highlighter-rouge">@Configuration</code>å®ä¾‹ä¸Šä½¿ç”¨<code class="language-plaintext highlighter-rouge">@EnableGlobalMethodSecurity</code>æ³¨é‡Šæ¥å¯ç”¨åŸºäºæ³¨è§£çš„å®‰å…¨æ€§ã€‚</li>
  <li>ä»¥ä¸‹å†…å®¹å°†å¯ç”¨Spring Securityçš„<code class="language-plaintext highlighter-rouge">@Secured</code>æ³¨é‡Šã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodSecurityConfig</span> <span class="o">{</span><span class="c1">// ...}</span>
</code></pre></div></div>

<ul>
  <li>ç„¶åå‘æ–¹æ³•ï¼ˆåœ¨ç±»æˆ–æ¥å£ä¸Šï¼‰æ·»åŠ æ³¨è§£å°±ä¼šé™åˆ¶å¯¹è¯¥æ–¹æ³•çš„è®¿é—®ã€‚ Spring Securityçš„åŸç”Ÿæ³¨é‡Šæ”¯æŒä¸ºè¯¥æ–¹æ³•å®šä¹‰äº†ä¸€ç»„å±æ€§ã€‚ è¿™äº›å°†è¢«ä¼ é€’ç»™AccessDecisionManagerä»¥ä¾›å®ƒä½œå‡ºå®é™…çš„å†³å®šï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BankService</span> <span class="o">{</span>

<span class="nd">@Secured</span><span class="o">(</span><span class="s">"IS_AUTHENTICATED_ANONYMOUSLY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span> <span class="nf">readAccount</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="nd">@Secured</span><span class="o">(</span><span class="s">"IS_AUTHENTICATED_ANONYMOUSLY"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span><span class="o">[]</span> <span class="nf">findAccounts</span><span class="o">();</span>

<span class="nd">@Secured</span><span class="o">(</span><span class="s">"ROLE_TELLER"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span> <span class="nf">post</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/*
ä»¥ä¸Šé…ç½®æ ‡æ˜readAccountã€findAccountsæ–¹æ³•å¯åŒ¿åè®¿é—®ï¼Œåº•å±‚ä½¿ç”¨WebExpressionVoteræŠ•ç¥¨å™¨
postæ–¹æ³•éœ€è¦æœ‰TELLERè§’è‰²æ‰èƒ½è®¿é—®ï¼Œåº•å±‚ä½¿ç”¨RoleVoteræŠ•ç¥¨å™¨ã€‚
*/</span>
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨å¦‚ä¸‹ä»£ç å¯å¯ç”¨prePostæ³¨è§£çš„æ”¯æŒ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MethodSecurityConfig</span> <span class="o">{</span><span class="c1">// ...}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BankService</span> <span class="o">{</span>

<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"isAnonymous()"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span> <span class="nf">readAccount</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"isAnonymous()"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span><span class="o">[]</span> <span class="nf">findAccounts</span><span class="o">();</span>

<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('p_transfer') and hasAuthority('p_read_account')"</span><span class="o">)</span>
<span class="kd">public</span> <span class="nc">Account</span> <span class="nf">post</span><span class="o">(</span><span class="nc">Account</span> <span class="n">account</span><span class="o">,</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">);</span>
<span class="o">}</span>

<span class="cm">/*
ä»¥ä¸Šé…ç½®æ ‡æ˜readAccountã€findAccountsæ–¹æ³•å¯åŒ¿åè®¿é—®ï¼Œpostæ–¹æ³•éœ€è¦åŒæ—¶æ‹¥æœ‰p_transferå’Œp_read_accountæƒé™æ‰èƒ½è®¿é—®ï¼Œåº•å±‚ä½¿ç”¨WebExpressionVoteræŠ•ç¥¨å™¨
*/</span>
</code></pre></div></div>

:ET