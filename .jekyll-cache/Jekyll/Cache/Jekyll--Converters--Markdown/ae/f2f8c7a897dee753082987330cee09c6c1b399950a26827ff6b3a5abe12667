I"Œ’<ul id="markdown-toc">
  <li><a href="#çº¿ç¨‹å…«å¤§æ ¸å¿ƒåŸºç¡€" id="markdown-toc-çº¿ç¨‹å…«å¤§æ ¸å¿ƒåŸºç¡€">çº¿ç¨‹å…«å¤§æ ¸å¿ƒåŸºç¡€</a></li>
  <li><a href="#å¤šçº¿ç¨‹å®ç°æ–¹å¼" id="markdown-toc-å¤šçº¿ç¨‹å®ç°æ–¹å¼">å¤šçº¿ç¨‹å®ç°æ–¹å¼</a></li>
  <li><a href="#å¯åŠ¨çº¿ç¨‹æ­£ç¡®æ–¹å¼" id="markdown-toc-å¯åŠ¨çº¿ç¨‹æ­£ç¡®æ–¹å¼">å¯åŠ¨çº¿ç¨‹æ­£ç¡®æ–¹å¼</a></li>
  <li><a href="#æ­£ç¡®åœæ­¢çº¿ç¨‹" id="markdown-toc-æ­£ç¡®åœæ­¢çº¿ç¨‹">æ­£ç¡®åœæ­¢çº¿ç¨‹</a></li>
  <li><a href="#é”™è¯¯çš„åœæ­¢çº¿ç¨‹" id="markdown-toc-é”™è¯¯çš„åœæ­¢çº¿ç¨‹">é”™è¯¯çš„åœæ­¢çº¿ç¨‹</a></li>
  <li><a href="#çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" id="markdown-toc-çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</a></li>
  <li><a href="#threadå’Œobjecté‡è¦æ–¹æ³•" id="markdown-toc-threadå’Œobjecté‡è¦æ–¹æ³•">Threadå’ŒObjecté‡è¦æ–¹æ³•</a>    <ul>
      <li><a href="#æ–¹æ³•æ¦‚è§ˆ" id="markdown-toc-æ–¹æ³•æ¦‚è§ˆ">æ–¹æ³•æ¦‚è§ˆ</a></li>
      <li><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼" id="markdown-toc-ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼">ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</a></li>
      <li><a href="#çº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°" id="markdown-toc-çº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°">çº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°</a></li>
      <li><a href="#sleepè¯¦è§£" id="markdown-toc-sleepè¯¦è§£">sleepè¯¦è§£</a></li>
      <li><a href="#joinè¯¦è§£" id="markdown-toc-joinè¯¦è§£">joinè¯¦è§£</a></li>
      <li><a href="#yieldè¯¦è§£" id="markdown-toc-yieldè¯¦è§£">yieldè¯¦è§£</a></li>
    </ul>
  </li>
  <li><a href="#çº¿ç¨‹å„å±æ€§" id="markdown-toc-çº¿ç¨‹å„å±æ€§">çº¿ç¨‹å„å±æ€§</a>    <ul>
      <li><a href="#çº¿ç¨‹id" id="markdown-toc-çº¿ç¨‹id">çº¿ç¨‹ID</a></li>
      <li><a href="#çº¿ç¨‹åç§°" id="markdown-toc-çº¿ç¨‹åç§°">çº¿ç¨‹åç§°</a></li>
      <li><a href="#å®ˆæŠ¤çº¿ç¨‹" id="markdown-toc-å®ˆæŠ¤çº¿ç¨‹">å®ˆæŠ¤çº¿ç¨‹</a></li>
      <li><a href="#ä¼˜å…ˆçº§" id="markdown-toc-ä¼˜å…ˆçº§">ä¼˜å…ˆçº§</a></li>
    </ul>
  </li>
  <li><a href="#æœªæ•è·å¼‚å¸¸å¦‚ä½•å¤„ç†" id="markdown-toc-æœªæ•è·å¼‚å¸¸å¦‚ä½•å¤„ç†">æœªæ•è·å¼‚å¸¸å¦‚ä½•å¤„ç†ï¼Ÿ</a>    <ul>
      <li><a href="#æœªæ•è·å¼‚å¸¸" id="markdown-toc-æœªæ•è·å¼‚å¸¸">æœªæ•è·å¼‚å¸¸</a></li>
    </ul>
  </li>
  <li><a href="#åŒåˆƒå‰‘å¤šçº¿ç¨‹ä¼šå¯¼è‡´çš„é—®é¢˜" id="markdown-toc-åŒåˆƒå‰‘å¤šçº¿ç¨‹ä¼šå¯¼è‡´çš„é—®é¢˜">åŒåˆƒå‰‘ï¼šå¤šçº¿ç¨‹ä¼šå¯¼è‡´çš„é—®é¢˜</a>    <ul>
      <li><a href="#çº¿ç¨‹å®‰å…¨" id="markdown-toc-çº¿ç¨‹å®‰å…¨">*çº¿ç¨‹å®‰å…¨</a>        <ul>
          <li><a href="#aæƒ…å†µ" id="markdown-toc-aæƒ…å†µ">a++æƒ…å†µ</a></li>
          <li><a href="#æ­»é”" id="markdown-toc-æ­»é”">æ­»é”</a></li>
          <li><a href="#å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–" id="markdown-toc-å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–">å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–</a></li>
        </ul>
      </li>
      <li><a href="#æ€§èƒ½é—®é¢˜" id="markdown-toc-æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</a></li>
    </ul>
  </li>
  <li><a href="#javaå†…å­˜æ¨¡å‹" id="markdown-toc-javaå†…å­˜æ¨¡å‹">Javaå†…å­˜æ¨¡å‹</a>    <ul>
      <li><a href="#javaå†…å­˜ç»“æ„" id="markdown-toc-javaå†…å­˜ç»“æ„">Javaå†…å­˜ç»“æ„</a></li>
      <li><a href="#javaå¯¹è±¡æ¨¡å‹" id="markdown-toc-javaå¯¹è±¡æ¨¡å‹">Javaå¯¹è±¡æ¨¡å‹</a></li>
      <li><a href="#javaå†…å­˜æ¨¡å‹-1" id="markdown-toc-javaå†…å­˜æ¨¡å‹-1">Javaå†…å­˜æ¨¡å‹</a></li>
      <li><a href="#é‡æ’åº" id="markdown-toc-é‡æ’åº">é‡æ’åº</a></li>
      <li><a href="#å¯è§æ€§" id="markdown-toc-å¯è§æ€§">å¯è§æ€§</a></li>
      <li><a href="#ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜" id="markdown-toc-ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜">ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜</a></li>
      <li><a href="#happens-beforeè§„åˆ™" id="markdown-toc-happens-beforeè§„åˆ™">Happens-Beforeè§„åˆ™</a>        <ul>
          <li><a href="#å•çº¿ç¨‹è§„åˆ™" id="markdown-toc-å•çº¿ç¨‹è§„åˆ™">å•çº¿ç¨‹è§„åˆ™</a></li>
          <li><a href="#é”æ“ä½œ" id="markdown-toc-é”æ“ä½œ">é”æ“ä½œ</a></li>
          <li><a href="#volatileå˜é‡" id="markdown-toc-volatileå˜é‡">volatileå˜é‡</a></li>
          <li><a href="#çº¿ç¨‹å¯åŠ¨" id="markdown-toc-çº¿ç¨‹å¯åŠ¨">çº¿ç¨‹å¯åŠ¨</a></li>
          <li><a href="#çº¿ç¨‹join" id="markdown-toc-çº¿ç¨‹join">çº¿ç¨‹join</a></li>
          <li><a href="#ä¼ é€’æ€§" id="markdown-toc-ä¼ é€’æ€§">ä¼ é€’æ€§</a></li>
          <li><a href="#ä¸­æ–­" id="markdown-toc-ä¸­æ–­">ä¸­æ–­</a></li>
          <li><a href="#æ„é€ æ–¹æ³•" id="markdown-toc-æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</a></li>
          <li><a href="#å·¥å…·ç±»" id="markdown-toc-å·¥å…·ç±»">å·¥å…·ç±»</a></li>
        </ul>
      </li>
      <li><a href="#volatileå…³é”®å­—" id="markdown-toc-volatileå…³é”®å­—">volatileå…³é”®å­—</a>        <ul>
          <li><a href="#ä¸¤ç‚¹ä½œç”¨" id="markdown-toc-ä¸¤ç‚¹ä½œç”¨">ä¸¤ç‚¹ä½œç”¨</a></li>
          <li><a href="#å°ç»“" id="markdown-toc-å°ç»“">å°ç»“</a></li>
        </ul>
      </li>
      <li><a href="#synchronized" id="markdown-toc-synchronized">synchronized</a></li>
      <li><a href="#åŸå­æ€§" id="markdown-toc-åŸå­æ€§">åŸå­æ€§</a>        <ul>
          <li><a href="#longå’Œdouble" id="markdown-toc-longå’Œdouble">longå’Œdouble</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#å•ä¾‹æ¨¡å¼çš„8ç§å†™æ³•" id="markdown-toc-å•ä¾‹æ¨¡å¼çš„8ç§å†™æ³•">å•ä¾‹æ¨¡å¼çš„8ç§å†™æ³•</a>    <ul>
      <li><a href="#é¥¿æ±‰å¼" id="markdown-toc-é¥¿æ±‰å¼">é¥¿æ±‰å¼</a></li>
      <li><a href="#æ‡’æ±‰å¼" id="markdown-toc-æ‡’æ±‰å¼">æ‡’æ±‰å¼</a></li>
      <li><a href="#åŒé‡æ£€æŸ¥" id="markdown-toc-åŒé‡æ£€æŸ¥">åŒé‡æ£€æŸ¥*</a></li>
      <li><a href="#é™æ€å†…éƒ¨ç±»" id="markdown-toc-é™æ€å†…éƒ¨ç±»">é™æ€å†…éƒ¨ç±»</a></li>
      <li><a href="#æšä¸¾æ¨¡å¼" id="markdown-toc-æšä¸¾æ¨¡å¼">æšä¸¾æ¨¡å¼*</a></li>
    </ul>
  </li>
  <li><a href="#æ­»é”-1" id="markdown-toc-æ­»é”-1">æ­»é”</a>    <ul>
      <li><a href="#å®šä½æ­»é”" id="markdown-toc-å®šä½æ­»é”">å®šä½æ­»é”</a></li>
      <li><a href="#ä¿®å¤æ­»é”" id="markdown-toc-ä¿®å¤æ­»é”">ä¿®å¤æ­»é”</a></li>
      <li><a href="#é¿å…æ­»é”" id="markdown-toc-é¿å…æ­»é”">é¿å…æ­»é”</a></li>
      <li><a href="#æ´»æ€§æ•…éšœ" id="markdown-toc-æ´»æ€§æ•…éšœ">æ´»æ€§æ•…éšœ</a>        <ul>
          <li><a href="#æ´»é”" id="markdown-toc-æ´»é”">æ´»é”</a></li>
          <li><a href="#é¥¥é¥¿" id="markdown-toc-é¥¥é¥¿">é¥¥é¥¿</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#è„‘å›¾" id="markdown-toc-è„‘å›¾">è„‘å›¾</a></li>
  <li><a href="#é¿å‘å¿…çœ‹" id="markdown-toc-é¿å‘å¿…çœ‹">é¿å‘å¿…çœ‹</a>    <ul>
      <li><a href="#1æ¸…æ¥šé”å’Œä¿æŠ¤å¯¹è±¡çš„å±‚é¢" id="markdown-toc-1æ¸…æ¥šé”å’Œä¿æŠ¤å¯¹è±¡çš„å±‚é¢">1æ¸…æ¥šé”å’Œä¿æŠ¤å¯¹è±¡çš„å±‚é¢</a></li>
      <li><a href="#2åŠ é”è¦è€ƒè™‘é”çš„åœºæ™¯å’Œç²’åº¦" id="markdown-toc-2åŠ é”è¦è€ƒè™‘é”çš„åœºæ™¯å’Œç²’åº¦">2åŠ é”è¦è€ƒè™‘é”çš„åœºæ™¯å’Œç²’åº¦</a></li>
      <li><a href="#3å°å¿ƒæ­»é”é—®é¢˜" id="markdown-toc-3å°å¿ƒæ­»é”é—®é¢˜">3å°å¿ƒæ­»é”é—®é¢˜</a></li>
    </ul>
  </li>
</ul>
<h3 id="çº¿ç¨‹å…«å¤§æ ¸å¿ƒåŸºç¡€">çº¿ç¨‹å…«å¤§æ ¸å¿ƒåŸºç¡€</h3>

<h3 id="å¤šçº¿ç¨‹å®ç°æ–¹å¼">å¤šçº¿ç¨‹å®ç°æ–¹å¼</h3>

<ul>
  <li>
    <p>å®ç°å¤šçº¿ç¨‹çš„æ–¹å¼æœ‰ä¸€ç§ï¼Œä¸¤ç§è¿˜æ˜¯å››ç§ï¼Ÿ</p>

    <ul>
      <li>å®˜æ–¹æŒ‡æ˜å®ç°å¤šçº¿ç¨‹çš„æ–¹å¼æœ‰ä¸¤ç§</li>
      <li>æ–¹å¼ä¸€ï¼šç»§æ‰¿Threadç±»</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ç”¨Threadæ–¹å¼å®ç°çº¿ç¨‹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadStyle</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨Threadç±»å®ç°çº¿ç¨‹"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">ThreadStyle</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <p>â€‹</p>

    <ul>
      <li>æ–¹å¼äºŒï¼šå®ç°Runnableæ¥å£(ä¼˜å…ˆé€‰æ‹©)</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ç”¨Runnableæ–¹å¼åˆ›å»ºçº¿ç¨‹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RunnableStyle</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">RunnableStyle</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨Runnableæ–¹æ³•å®ç°çº¿ç¨‹"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>åŒæ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µ</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.createthreads</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     åŒæ—¶ä½¿ç”¨Runnableå’ŒThreadä¸¤ç§å®ç°çº¿ç¨‹çš„æ–¹å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BothRunnableThread</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆ‘æ¥è‡ªRunnable"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">})</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆ‘æ¥è‡ªThread"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
ç»“æœï¼šæˆ‘æ¥è‡ªThread
åŸå› ï¼šçœ‹Threadæºç 
å› ä¸ºé‡å†™äº†Threadçš„runæ–¹æ³•ï¼Œæ‰€ä»¥åŸæœ¬çš„runæ–¹æ³•å°±ä¸è¢«æ‰§è¡Œäº†
*/</span>
</code></pre></div>    </div>

    <ul>
      <li>
        <p>æ€»ç»“æ¥è¯´ï¼Œåˆ›å»ºçº¿ç¨‹åªæœ‰ä¸€ç§æ–¹å¼ï¼Œé‚£å°±æ˜¯æ„é€ Threadç±»ï¼Œè€Œå®ç°çº¿ç¨‹çš„æ‰§è¡Œå•å…ƒæœ‰ä¸¤ç§æ–¹å¼ã€‚</p>

        <p>æ–¹å¼ä¸€ï¼šå®ç°Runnableæ¥å£çš„runæ–¹æ³•ï¼Œå¹¶æŠŠRunnableå®ä¾‹ä¼ ç»™Threadç±»</p>

        <p>æ–¹å¼äºŒï¼šé‡å†™Threadçš„runæ–¹æ³•ï¼ˆé›†æˆThreadç±»ï¼‰</p>
      </li>
    </ul>
  </li>
  <li>
    <p>é”™è¯¯è§‚ç‚¹ï¼š<strong>è¿™äº›æ–¹å¼éƒ½æ˜¯ä¸€äº›è¡¨é¢ç°è±¡ï¼Œæœ¬è´¨éƒ½æ˜¯é‚£ä¸¤ç§æ–¹å¼</strong></p>

    <ul>
      <li>çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹ä¹Ÿç®—æ˜¯ä¸€ç§æ–°å»ºçº¿ç¨‹çš„æ–¹å¼ï¼šå†…éƒ¨å®ç°ä¹Ÿæ˜¯åˆ›å»ºçš„Threadå¯¹è±¡</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     çº¿ç¨‹æ± åˆ›å»ºçº¿ç¨‹çš„æ–¹æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPool5</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">()</span> <span class="o">{});</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>é€šè¿‡Callableå’ŒFutureTaskåˆ›å»ºçº¿ç¨‹ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼</li>
      <li>æ— è¿”å›å€¼æ˜¯å®ç°Runnableæ¥å£ï¼Œæœ‰è¿”å›å€¼æ˜¯å®ç°callableæ¥å£ï¼Œæ‰€ä»¥callableæ˜¯å®ç°çº¿ç¨‹æ–°æ–¹å¼</li>
      <li>å®šæ—¶å™¨ï¼ŒåŒ¿åå†…éƒ¨ç±»ï¼Œlambdaè¡¨è¾¾å¼</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å®šæ—¶å™¨åˆ›å»ºçº¿ç¨‹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DemoTimmerTask</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Timer</span> <span class="n">timer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Timer</span><span class="o">();</span>
        <span class="n">timer</span><span class="o">.</span><span class="na">scheduleAtFixedRate</span><span class="o">(</span><span class="k">new</span> <span class="nc">TimerTask</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="mi">1000</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     åŒ¿åå†…éƒ¨ç±»çš„æ–¹å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnonymousInnerClassDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     lambdaè¡¨è¾¾å¼åˆ›å»ºçº¿ç¨‹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Lambda</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">())).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="å¯åŠ¨çº¿ç¨‹æ­£ç¡®æ–¹å¼">å¯åŠ¨çº¿ç¨‹æ­£ç¡®æ–¹å¼</h3>

<ul>
  <li>
    <p>æ€æ ·æ‰æ˜¯å¯åŠ¨çº¿ç¨‹çš„æ­£ç¡®æ–¹å¼ï¼Ÿ</p>
  </li>
  <li>
    <p>startæ–¹æ³•çš„å«ä¹‰</p>

    <p>å¯åŠ¨æ–°çº¿ç¨‹</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å¯¹æ¯”startå’Œrunä¸¤ç§å¯åŠ¨çº¿ç¨‹çš„æ–¹å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StartAndRunMethod</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="o">};</span>
        <span class="n">runnable</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>

    <p>å‡†å¤‡å·¥ä½œ</p>

    <p>ä¸èƒ½é‡å¤startï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå› ä¸ºçº¿ç¨‹æœ‰ä¸€ä¸ªçŠ¶æ€å±æ€§ï¼Œæ¯æ¬¡å¯åŠ¨çº¿ç¨‹éƒ½ä¼šå»æ£€æŸ¥</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.startthread</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºä¸èƒ½ä¸¤æ¬¡è°ƒç”¨startæ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ¥é”™
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CantStartTwice</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>
  </li>
  <li>
    <p>runæ–¹æ³•çš„å«ä¹‰</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Runnable</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">if</span><span class="o">(</span><span class="n">target</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
  <span class="n">target</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
<span class="o">}</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p>å¯åŠ¨çº¿ç¨‹åº”è¯¥è°ƒç”¨startæ–¹æ³•ï¼Œä»è€Œé—´æ¥çš„è°ƒç”¨runæ–¹æ³•</p>
  </li>
</ul>

<h3 id="æ­£ç¡®åœæ­¢çº¿ç¨‹">æ­£ç¡®åœæ­¢çº¿ç¨‹</h3>

<ul>
  <li>å¦‚ä½•æ­£ç¡®åœæ­¢çº¿ç¨‹ï¼Ÿ</li>
  <li>åŸç†ä»‹ç»ï¼šä½¿ç”¨interruptæ¥é€šçŸ¥ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶</li>
  <li>æ­£å¸¸ä¸­æ–­çº¿ç¨‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.stopthreads</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     runæ–¹æ³•å†…æ²¡æœ‰sleepæˆ–waitæ–¹æ³•æ—¶ï¼Œåœæ­¢çº¿ç¨‹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayStopThreadWithoutSleep</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="c1">//é€šè¿‡æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å·²ç»è¢«ä¸­æ–­</span>
        <span class="k">while</span> <span class="o">(!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">num</span> <span class="o">&lt;=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">10000</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯10000çš„å€æ•°"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">num</span><span class="o">++;</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä»»åŠ¡è¿è¡Œç»“æŸäº†"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">RightWayStopThreadWithoutSleep</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç¡çœ æƒ…å†µä¸‹ä¸­æ–­</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
 * æè¿°ï¼š     å¸¦æœ‰sleepçš„ä¸­æ–­çº¿ç¨‹çš„å†™æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayStopThreadWithSleep</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">300</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°"</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">num</span><span class="o">++;</span>
                <span class="o">}</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>å¾ªç¯å†…ç¡çœ </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡å¾ªç¯éƒ½ä¼šè°ƒç”¨sleepæˆ–waitç­‰æ–¹æ³•ï¼Œé‚£ä¹ˆä¸éœ€è¦æ¯æ¬¡è¿­ä»£éƒ½æ£€æŸ¥æ˜¯å¦å·²ä¸­æ–­
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayStopThreadWithSleepEveryLoop</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">10000</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°"</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">num</span><span class="o">++;</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸­æ–­å¤±æ•ˆï¼Œå¦‚æœåœ¨sleepä¸­è¿›è¡Œä¸­æ–­ï¼Œä¼šæ¸…é™¤ä¸­æ–­æ ‡è¯†ï¼Œæ‰€ä»¥å»æ£€æµ‹çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­æ˜¯æ£€æµ‹ä¸åˆ°çš„</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å¦‚æœwhileé‡Œé¢æ”¾try/catchï¼Œä¼šå¯¼è‡´ä¸­æ–­å¤±æ•ˆ
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CantInterrupt</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">10000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">num</span><span class="o">++;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">};</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¼˜å…ˆé€‰æ‹©ï¼šä¼ é€’ä¸­æ–­</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/**
 * æè¿°ï¼š     æœ€ä½³å®è·µï¼šcatchäº†InterruptedExcetionä¹‹åçš„ä¼˜å…ˆé€‰æ‹©ï¼šåœ¨æ–¹æ³•ç­¾åä¸­æŠ›å‡ºå¼‚å¸¸ é‚£ä¹ˆåœ¨run()å°±ä¼šå¼ºåˆ¶try/catch
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayStopThreadInProd</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"go"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">throwInMethod</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
                <span class="c1">//ä¿å­˜æ—¥å¿—ã€åœæ­¢ç¨‹åº</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¿å­˜æ—¥å¿—"</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">throwInMethod</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      		<span class="c1">//å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">RightWayStopThreadInProd</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸æƒ³æˆ–æ— æ³•ä¼ é€’ï¼šæ¢å¤ä¸­æ–­</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼šæœ€ä½³å®è·µ2ï¼šåœ¨catchå­è¯­å¥ä¸­è°ƒç”¨Thread.currentThread().interrupt()æ¥æ¢å¤è®¾ç½®ä¸­æ–­çŠ¶æ€ï¼Œä»¥ä¾¿äºåœ¨åç»­çš„æ‰§è¡Œä¸­ï¼Œä¾ç„¶èƒ½å¤Ÿæ£€æŸ¥åˆ°åˆšæ‰å‘ç”Ÿäº†ä¸­æ–­
 * å›åˆ°åˆšæ‰RightWayStopThreadInProdè¡¥ä¸Šä¸­æ–­ï¼Œè®©å®ƒè·³å‡º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayStopThreadInProd2</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Interruptedï¼Œç¨‹åºè¿è¡Œç»“æŸ"</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">reInterrupt</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">reInterrupt</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//ä¸­æ–­</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">RightWayStopThreadInProd2</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>
    <p>ä¸åº”å±è”½ä¸­æ–­</p>
  </li>
  <li>
    <p>å“åº”ä¸­æ–­çš„æ–¹æ³•ï¼š</p>

    <ul>
      <li>Object.wait()/wait(long)/wait(long,int)</li>
      <li>Thread.sleep(long)/Thread.sleep(long,int)</li>
      <li>Thread.join()/Thread.join(long)/Thread.join(long,int)</li>
      <li>java.util.concurrent.BlockingQueue.take()/put(E)</li>
      <li>java.util.concurrent.locks.Lock.lockInterruptibly()</li>
      <li>java.util.concurrent.CountDownLatch.await()</li>
      <li>java.util.concurrent.CyclicBarrier.await()</li>
      <li>java.util.concurrent.Exchanger.exchange(V)</li>
      <li>java.nio.channels.InterruptiableChannelç›¸å…³æ–¹æ³•</li>
      <li>java.nio.channels.Selectorçš„ç›¸å…³æ–¹æ³•</li>
    </ul>
  </li>
  <li>
    <p>æ­£ç¡®ä½¿ç”¨interruptä¸­æ–­çº¿ç¨‹çš„å¥½å¤„ï¼š</p>

    <p>é€šè¿‡ä½¿ç”¨interruptæ¥å‘å‡ºä¸€ä¸ªä¿¡å·ï¼Œè®©çº¿ç¨‹è‡ªå·±å»å¤„ç†ï¼Œä½¿çº¿ç¨‹ä»£ç æ›´åŠ å®‰å…¨ï¼Œä¹Ÿå®Œæˆäº†æ¸…ç†å·¥ä½œï¼Œæ•°æ®çš„å®Œæ•´æ€§ä¹Ÿå¾—åˆ°äº†ä¿éšœ</p>
  </li>
</ul>

<h3 id="é”™è¯¯çš„åœæ­¢çº¿ç¨‹">é”™è¯¯çš„åœæ­¢çº¿ç¨‹</h3>

<ul>
  <li>è¢«å¼ƒç”¨çš„stopï¼Œsuspendï¼Œå’Œresumeæ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     é”™è¯¯çš„åœæ­¢æ–¹æ³•ï¼šç”¨stop()æ¥åœæ­¢çº¿ç¨‹ï¼Œä¼šå¯¼è‡´çº¿ç¨‹è¿è¡Œä¸€åŠçªç„¶åœæ­¢ï¼Œæ²¡åŠæ³•å®Œæˆä¸€ä¸ªåŸºæœ¬å•ä½çš„æ“ä½œï¼ˆä¸€ä¸ªè¿é˜Ÿï¼‰ï¼Œä¼šé€ æˆè„æ•°æ®ï¼ˆæœ‰çš„è¿é˜Ÿå¤šé¢†å–å°‘é¢†å–è£…å¤‡ï¼‰ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StopThread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//æ¨¡æ‹ŸæŒ‡æŒ¥å†›é˜Ÿï¼šä¸€å…±æœ‰5ä¸ªè¿é˜Ÿï¼Œæ¯ä¸ªè¿é˜Ÿ10äººï¼Œä»¥è¿é˜Ÿä¸ºå•ä½ï¼Œå‘æ”¾æ­¦å™¨å¼¹è¯ï¼Œå«åˆ°å·çš„å£«å…µå‰å»é¢†å–</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿é˜Ÿ"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"å¼€å§‹é¢†å–æ­¦å™¨"</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿é˜Ÿ"</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="s">"å·²ç»é¢†å–å®Œæ¯•"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">StopThread</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="c1">//ä¼šå¯¼è‡´æŸä¸ªè¿é˜Ÿä¸­æŸäº›äººæ²¡æœ‰é¢†å–åˆ°</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç”¨volatileè®¾ç½®booleanæ ‡è®°ä½</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºç”¨volatileçš„å±€é™ï¼špart1 çœ‹ä¼¼å¯è¡Œ,ä½†æ˜¯ç¨‹åºå¹¶æ²¡æœ‰åœæ­¢
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WrongWayVolatile</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">100000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°ã€‚"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">num</span><span class="o">++;</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">WrongWayVolatile</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WrongWayVolatile</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="n">r</span><span class="o">.</span><span class="na">canceled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡æ‹Ÿ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.stopthreads.volatiledemo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ArrayBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.BlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ConcurrentLinkedQueue</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºç”¨volatileçš„å±€é™part2 é™·å…¥é˜»å¡æ—¶ï¼Œvolatileæ˜¯æ— æ³•åœæ­¢çº¿ç¨‹çš„ æ­¤ä¾‹ä¸­ï¼Œç”Ÿäº§è€…çš„ç”Ÿäº§é€Ÿåº¦å¾ˆå¿«ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹é€Ÿåº¦æ…¢ï¼Œæ‰€ä»¥é˜»å¡é˜Ÿåˆ—æ»¡äº†ä»¥åï¼Œç”Ÿäº§è€…ä¼šé˜»å¡ï¼Œç­‰å¾…æ¶ˆè´¹è€…è¿›ä¸€æ­¥æ¶ˆè´¹
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WrongWayVolatileCantStop</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ArrayBlockingQueue</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

        <span class="nc">Producer</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Producer</span><span class="o">(</span><span class="n">storage</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">producerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">producer</span><span class="o">);</span>
        <span class="n">producerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

        <span class="nc">Consumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Consumer</span><span class="o">(</span><span class="n">storage</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">needMoreNums</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">take</span><span class="o">()+</span><span class="s">"è¢«æ¶ˆè´¹äº†"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹è€…ä¸éœ€è¦æ›´å¤šæ•°æ®äº†ã€‚"</span><span class="o">);</span>

        <span class="c1">//ä¸€æ—¦æ¶ˆè´¹ä¸éœ€è¦æ›´å¤šæ•°æ®äº†ï¼Œæˆ‘ä»¬åº”è¯¥è®©ç”Ÿäº§è€…ä¹Ÿåœä¸‹æ¥ï¼Œä½†æ˜¯å®é™…æƒ…å†µæ˜¯ç¨‹åºå¹¶æ²¡æœ‰ç»“æŸ</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">canceled</span><span class="o">=</span><span class="kc">true</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">producer</span><span class="o">.</span><span class="na">canceled</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Producer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">canceled</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

    <span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Producer</span><span class="o">(</span><span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">100000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">canceled</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">storage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°,è¢«æ”¾åˆ°ä»“åº“ä¸­äº†ã€‚"</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">num</span><span class="o">++;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”Ÿäº§è€…ç»“æŸè¿è¡Œ"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>

    <span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Consumer</span><span class="o">(</span><span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">needMoreNums</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æ”¹æ­£ä¸ºæ­£ç¡®åœæ­¢çº¿ç¨‹ï¼šä½¿ç”¨interruptæ¥ä¸­æ–­çº¿ç¨‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.stopthreads.volatiledemo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.ArrayBlockingQueue</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.BlockingQueue</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç”¨ä¸­æ–­æ¥ä¿®å¤åˆšæ‰çš„æ— å°½ç­‰å¾…é—®é¢˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WrongWayVolatileFixed</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">WrongWayVolatileFixed</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WrongWayVolatileFixed</span><span class="o">();</span>
        <span class="nc">ArrayBlockingQueue</span> <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>

        <span class="nc">Producer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">new</span> <span class="nf">Producer</span><span class="o">(</span><span class="n">storage</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">producerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">producer</span><span class="o">);</span>
        <span class="n">producerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

        <span class="nc">Consumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="na">new</span> <span class="nf">Consumer</span><span class="o">(</span><span class="n">storage</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">needMoreNums</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">consumer</span><span class="o">.</span><span class="na">storage</span><span class="o">.</span><span class="na">take</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è¢«æ¶ˆè´¹äº†"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹è€…ä¸éœ€è¦æ›´å¤šæ•°æ®äº†ã€‚"</span><span class="o">);</span>

		<span class="c1">//ä¸­æ–­ç”Ÿäº§è€…çº¿ç¨‹</span>
        <span class="n">producerThread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="kd">class</span> <span class="nc">Producer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Producer</span><span class="o">(</span><span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
        <span class="o">}</span>


        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">num</span> <span class="o">&lt;=</span> <span class="mi">100000</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">isInterrupted</span><span class="o">())</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">num</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">storage</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">num</span><span class="o">);</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">"æ˜¯100çš„å€æ•°,è¢«æ”¾åˆ°ä»“åº“ä¸­äº†ã€‚"</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="n">num</span><span class="o">++;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”Ÿäº§è€…ç»“æŸè¿è¡Œ"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">class</span> <span class="nc">Consumer</span> <span class="o">{</span>

        <span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Consumer</span><span class="o">(</span><span class="nc">BlockingQueue</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">needMoreNums</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æ­£ç¡®çš„ä¸­æ–­æ–¹å¼</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.stopthreads</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ³¨æ„Thread.interrupted()æ–¹æ³•çš„ç›®æ ‡å¯¹è±¡æ˜¯â€œå½“å‰çº¿ç¨‹â€ï¼Œè€Œä¸ç®¡æœ¬æ–¹æ³•æ¥è‡ªäºå“ªä¸ªå¯¹è±¡
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RightWayInterrupted</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">Thread</span> <span class="n">threadOne</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="c1">// å¯åŠ¨çº¿ç¨‹</span>
        <span class="n">threadOne</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">//è®¾ç½®ä¸­æ–­æ ‡å¿—</span>
        <span class="n">threadOne</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="c1">//è·å–ä¸­æ–­æ ‡å¿—,true</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isInterrupted: "</span> <span class="o">+</span> <span class="n">threadOne</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="c1">//è·å–ä¸­æ–­æ ‡å¿—å¹¶é‡ç½®,false</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isInterrupted: "</span> <span class="o">+</span> <span class="n">threadOne</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
        <span class="c1">//è·å–ä¸­æ–­æ ‡å¿—å¹¶é‡ç›´,false</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isInterrupted: "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">());</span>
        <span class="c1">//è·å–ä¸­æ–­æ ‡å¿—,true</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"isInterrupted: "</span> <span class="o">+</span> <span class="n">threadOne</span><span class="o">.</span><span class="na">isInterrupted</span><span class="o">());</span>
        <span class="n">threadOne</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Main thread is over."</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>é¢è¯•é—®é¢˜ï¼š</p>
  </li>
  <li>
    <p>å¦‚ä½•åœæ­¢çº¿ç¨‹ï¼Ÿ</p>

    <ul>
      <li>åŸç†ï¼šç”¨interruptæ¥è¯·æ±‚ï¼Œè€Œä¸æ˜¯stopï¼Œvolatileã€‚å¥½å¤„æ˜¯ä¿è¯æ•°æ®å®‰å…¨ï¼ŒæŠŠä¸»åŠ¨æƒäº¤ç»™è¢«ä¸­æ–­çš„çº¿ç¨‹</li>
      <li>æƒ³åœæ­¢çº¿ç¨‹ï¼Œè¦è¯·æ±‚æ–¹ï¼Œè¢«åœæ­¢æ–¹ï¼Œå­æ–¹æ³•è¢«è°ƒç”¨æ–¹ç›¸äº’é…åˆ</li>
      <li>æœ€åè¯´é”™è¯¯çš„æ–¹æ³•ï¼šstop/suspendå·²ç»åºŸå¼ƒï¼Œvolatileçš„booleanæ— æ³•å¤„ç†é•¿æ—¶é—´é˜»å¡æƒ…å†µ</li>
    </ul>
  </li>
  <li>
    <p>å¦‚ä½•å¤„ç†ä¸å¯ä¸­æ–­çš„é˜»å¡ï¼Ÿ</p>

    <p>æ²¡æœ‰é€šç”¨è§£å†³æ–¹æ¡ˆï¼Œé’ˆå¯¹ç‰¹å®šçš„æƒ…å†µç”¨ç‰¹å®šçš„æ–¹æ³•ï¼Œå°½å¯èƒ½è®©çº¿ç¨‹åšåˆ°èƒ½å¤Ÿå“åº”ä¸­æ–­</p>
  </li>
</ul>

<h3 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ">çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h3>

<ul>
  <li>
    <p>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæœ‰å“ªå…­ç§çŠ¶æ€ï¼Ÿ</p>

    <p>Newï¼ŒRunnableï¼ŒBlockedï¼ŒWaitingï¼ŒTimed Waitingï¼Œterminated</p>
  </li>
</ul>

<p><img src="https://s1.ax1x.com/2020/03/17/8aNlMF.png" alt="8aNlMF.png" /></p>

<ul>
  <li>æ¼”ç¤ºnewï¼Œrunnableï¼ŒterminatedçŠ¶æ€</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å±•ç¤ºçº¿ç¨‹çš„NEWã€RUNNABLEã€TerminatedçŠ¶æ€ã€‚å³ä½¿æ˜¯æ­£åœ¨è¿è¡Œï¼Œä¹Ÿæ˜¯RunnableçŠ¶æ€ï¼Œè€Œä¸æ˜¯Runningã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewRunnableTerminated</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">NewRunnableTerminated</span><span class="o">());</span>
        <span class="c1">//æ‰“å°å‡ºNEWçš„çŠ¶æ€</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//æ‰“å°å‡ºRUNNABLEçš„çŠ¶æ€ï¼Œå³ä½¿æ˜¯æ­£åœ¨è¿è¡Œï¼Œä¹Ÿæ˜¯RUNNABLEï¼Œè€Œä¸æ˜¯RUNNING</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//æ‰“å°å‡ºTERMINATEDçŠ¶æ€</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¼”ç¤ºblockedï¼Œwaitingï¼Œtimed_waittingçŠ¶æ€</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å±•ç¤ºBlocked, Waiting, TimedWaiting
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockedWaitingTimedWaiting</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BlockedWaitingTimedWaiting</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockedWaitingTimedWaiting</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//æ‰“å°å‡ºTimed_WaitingçŠ¶æ€ï¼Œå› ä¸ºæ­£åœ¨æ‰§è¡ŒThread.sleep(1000);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread1</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="c1">//æ‰“å°å‡ºBLOCKEDçŠ¶æ€ï¼Œå› ä¸ºthread2æƒ³æ‹¿å¾—åˆ°sync()çš„é”å´æ‹¿ä¸åˆ°</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread2</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1300</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//æ‰“å°å‡ºWAITINGçŠ¶æ€ï¼Œå› ä¸ºæ‰§è¡Œäº†wait()</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">thread1</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">syn</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">syn</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="n">wait</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>é˜»å¡çŠ¶æ€ï¼šblockedï¼ˆè¢«é˜»å¡ï¼‰ï¼Œwaittingï¼ˆç­‰å¾…ï¼‰ï¼Œtimed_waittingï¼ˆè®¡æ—¶ç­‰å¾…ï¼‰ï¼Œéƒ½å±äºé˜»å¡</li>
  <li>çº¿ç¨‹æœ‰å“ªå‡ ç§çŠ¶æ€ï¼Œç”Ÿå‘½å‘¨æœŸæ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>

<h3 id="threadå’Œobjecté‡è¦æ–¹æ³•">Threadå’ŒObjecté‡è¦æ–¹æ³•</h3>

<ul>
  <li>ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³•wait(),notify(),notifyAll()è¢«å®šä¹‰åœ¨Objectä¸­ï¼Œè€Œsleepæ–¹æ³•è¢«å®šä¹‰åœ¨Threadç±»ä¸­ï¼Ÿ</li>
  <li>æ€æ ·ç”¨ä¸‰ç§æ–¹æ³•å®ç°ç”Ÿäº§è€…æ¨¡å¼ï¼Ÿ</li>
  <li>Java SE 8å’ŒJava 1.8 å’ŒJDK 8 æ˜¯ä»€ä¹ˆå…³ç³»ï¼Œæ˜¯å¦æ˜¯åŒä¸€ç§ä¸œè¥¿ï¼Ÿ</li>
  <li>joinå’Œsleepå’ŒwaitæœŸé—´çº¿ç¨‹çš„çŠ¶æ€åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ</li>
</ul>

<h4 id="æ–¹æ³•æ¦‚è§ˆ">æ–¹æ³•æ¦‚è§ˆ</h4>

<p><img src="https://s1.ax1x.com/2020/03/22/84jmH1.png" alt="84jmH1.png" /></p>

<ul>
  <li>currentThread</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºæ‰“å°main, Thread-0, Thread-1
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CurrentThread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">CurrentThread</span><span class="o">().</span><span class="na">run</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">CurrentThread</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">CurrentThread</span><span class="o">()).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
main
Thread-0
Thread-1
*/</span>
</code></pre></div></div>

<ul>
  <li>
    <p>waitï¼Œnotifyï¼ŒnotifyAllä½œç”¨</p>
  </li>
  <li>
    <p>é˜»å¡é˜¶æ®µï¼šç›´åˆ°ä»¥ä¸‹å››ç§æƒ…å†µä¹‹ä¸€å‘ç”Ÿæ—¶ï¼Œæ‰ä¼šè¢«å”¤é†’</p>

    <p>å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„notifyæ–¹æ³•ä¸”åˆšå¥½è¢«å”¤é†’çš„çº¿ç¨‹æ˜¯æœ¬çº¿ç¨‹</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     å±•ç¤ºwaitå’Œnotifyçš„åŸºæœ¬ç”¨æ³• 1. ç ”ç©¶ä»£ç æ‰§è¡Œé¡ºåº 2. è¯æ˜waité‡Šæ”¾é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Wait</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Thread1</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¼€å§‹æ‰§è¡Œäº†"</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">object</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å–åˆ°äº†é”ã€‚"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Thread2</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">object</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">object</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è°ƒç”¨äº†notify()"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread1</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread1</span><span class="o">();</span>
        <span class="nc">Thread2</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread2</span><span class="o">();</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
çº¿ç¨‹1å¼€å§‹æ‰§è¡Œäº†
çº¿ç¨‹2è°ƒç”¨äº†notify()
çº¿ç¨‹1è·å–åˆ°äº†é”
*/</span>
</code></pre></div>    </div>

    <p>â€‹</p>

    <p>å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„notifyAllæ–¹æ³•</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     3ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹1å’Œçº¿ç¨‹2é¦–å…ˆè¢«é˜»å¡ï¼Œçº¿ç¨‹3å”¤é†’å®ƒä»¬ã€‚notify, notifyAllã€‚ startå…ˆæ‰§è¡Œä¸ä»£è¡¨çº¿ç¨‹å…ˆå¯åŠ¨ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyAll</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">resourceA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
      <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WaitNotifyAll</span><span class="o">();</span>
      <span class="nc">Thread</span> <span class="n">threadA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="nc">Thread</span> <span class="n">threadB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
      <span class="nc">Thread</span> <span class="n">threadC</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
          <span class="nd">@Override</span>
          <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
              <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceA</span><span class="o">)</span> <span class="o">{</span>
                  <span class="n">resourceA</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
                  <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadC notified."</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
      <span class="o">});</span>
      <span class="n">threadA</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="n">threadB</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      
      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
      <span class="n">threadC</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceA</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" got resourceA lock."</span><span class="o">);</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" waits to start."</span><span class="o">);</span>
              <span class="n">resourceA</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
              <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"'s waiting to end."</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>
<p>}
  /*
  çº¿ç¨‹1 got resourceA lock.
  çº¿ç¨‹1 waits to start.
  çº¿ç¨‹2 got resourceA lock.
  çº¿ç¨‹2 waits to start.
  ThreadC notified.
  çº¿ç¨‹2 â€˜s waiting to end.
  çº¿ç¨‹1 â€˜s waiting to end.
  */</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

  <span class="cm">/**
   * æè¿°ï¼š     è¯æ˜waitåªé‡Šæ”¾å½“å‰çš„é‚£æŠŠé”
   */</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyReleaseOwnMonitor</span> <span class="o">{</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">Object</span> <span class="n">resourceA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">Object</span> <span class="n">resourceB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceA</span><span class="o">)</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadA got resourceA lock."</span><span class="o">);</span>
                      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceB</span><span class="o">)</span> <span class="o">{</span>
                          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadA got resourceB lock."</span><span class="o">);</span>
                          <span class="k">try</span> <span class="o">{</span>
                              <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadA releases resourceA lock."</span><span class="o">);</span>
                              <span class="n">resourceA</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>

                          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                          <span class="o">}</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">});</span>

          <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                  <span class="k">try</span> <span class="o">{</span>
                      <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                  <span class="o">}</span>
                  <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceA</span><span class="o">)</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadB got resourceA lock."</span><span class="o">);</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadB tries to resourceB lock."</span><span class="o">);</span>

                      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">resourceB</span><span class="o">)</span> <span class="o">{</span>
                          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ThreadB got resourceB lock."</span><span class="o">);</span>
                      <span class="o">}</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">});</span>

          <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
          <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="cm">/*
  ThreadA got resourceA lock.
  ThreadA got resourceB lock.
  ThreadA releases resourceA lock.
  ThreadB got resourceA lock.
  ThreadB tries to resourceB lock.
  æ‰“å°ç»“æœå®Œæ¯•ï¼Œç¨‹åºå¹¶æ²¡æœ‰åœæ­¢è¿è¡Œ
  */</span>
</code></pre></div></div>

<p>â€‹</p>

<p>è¿‡äº†waitï¼ˆlong timeoutï¼‰è§„å®šçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœä¼ å…¥0å°±æ˜¯æ°¸ä¹…ç­‰å¾…</p>

<p>çº¿ç¨‹è‡ªèº«è°ƒç”¨äº†interruptï¼ˆï¼‰</p>

<ul>
  <li>
    <p>å”¤é†’é˜¶æ®µï¼š</p>
  </li>
  <li>
    <p>é‡åˆ°ä¸­æ–­ï¼š</p>
  </li>
  <li>
    <p>waitï¼Œnotifyï¼ŒnotifyAllç‰¹ç‚¹å’Œæ€§è´¨</p>

    <p>ç”¨å¿…é¡»å…ˆæ‹¥æœ‰monitor</p>

    <p>åªèƒ½å”¤é†’å…¶ä¸­ä¸€ä¸ª</p>

    <p>å±äºObjectç±»</p>

    <p>ç±»ä¼¼åŠŸèƒ½çš„Condition</p>
  </li>
</ul>

<h4 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼">ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</h4>

<p><img src="https://s1.ax1x.com/2020/03/22/85zWYq.png" alt="85zWYq.png" /></p>

<ul>
  <li>ä»£ç å®ç°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.LinkedList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç”¨wait/notifyæ¥å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProducerConsumerModel</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">EventStorage</span> <span class="n">eventStorage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EventStorage</span><span class="o">();</span>
        <span class="nc">Producer</span> <span class="n">producer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Producer</span><span class="o">(</span><span class="n">eventStorage</span><span class="o">);</span>
        <span class="nc">Consumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Consumer</span><span class="o">(</span><span class="n">eventStorage</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">producer</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">consumer</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Producer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">EventStorage</span> <span class="n">storage</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Producer</span><span class="o">(</span>
            <span class="nc">EventStorage</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">storage</span><span class="o">.</span><span class="na">put</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Consumer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">EventStorage</span> <span class="n">storage</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Consumer</span><span class="o">(</span>
            <span class="nc">EventStorage</span> <span class="n">storage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">storage</span> <span class="o">=</span> <span class="n">storage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">storage</span><span class="o">.</span><span class="na">take</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">EventStorage</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxSize</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">Date</span><span class="o">&gt;</span> <span class="n">storage</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">EventStorage</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maxSize</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">maxSize</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">storage</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä»“åº“é‡Œæœ‰äº†"</span> <span class="o">+</span> <span class="n">storage</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ä¸ªäº§å“ã€‚"</span><span class="o">);</span>
        <span class="n">notify</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">take</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">storage</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">wait</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ‹¿åˆ°äº†"</span> <span class="o">+</span> <span class="n">storage</span><span class="o">.</span><span class="na">poll</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ï¼Œç°åœ¨ä»“åº“è¿˜å‰©ä¸‹"</span> <span class="o">+</span> <span class="n">storage</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">notify</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="çº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°">çº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡å¶æ•°</h4>

<ul>
  <li>ä½¿ç”¨ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°0åˆ°100çš„å¥‡å¶æ•°</li>
  <li>åŸºæœ¬æ€è·¯ï¼Œä½¿ç”¨synchronizedå®ç°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°0~100çš„å¥‡å¶æ•°ï¼Œç”¨synchronizedå…³é”®å­—å®ç°
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyPrintOddEvenSyn</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="c1">//æ–°å»º2ä¸ªçº¿ç¨‹</span>
    <span class="c1">//1ä¸ªåªå¤„ç†å¶æ•°ï¼Œç¬¬äºŒä¸ªåªå¤„ç†å¥‡æ•°ï¼ˆç”¨ä½è¿ç®—ï¼‰</span>
    <span class="c1">//ç”¨synchronizedæ¥é€šä¿¡</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">count</span><span class="o">++);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"å¶æ•°"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">((</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">count</span><span class="o">++);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"å¥‡æ•°"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//è¿™ä¸ªç¨‹åºæœ‰è®¸å¤šçš„è´¹æ“ä½œï¼Œæ¯”å¦‚å¶æ•°çº¿ç¨‹è¿ç»­æ‹¿åˆ°é”ï¼Œä½†å®ƒåªä¼šæ‰§è¡Œä¸€æ¬¡ifå—å†…å®¹ï¼Œè¿™ä¸çº¿ç¨‹çš„ç«äº‰æœ‰å…³</span>
</code></pre></div></div>

<ul>
  <li>æ›´å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨waitå’Œnotifyå®ç°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>


<span class="cm">/**
 * æè¿°ï¼š     ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°0~100çš„å¥‡å¶æ•°ï¼Œç”¨waitå’Œnotify
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WaitNotifyPrintOddEveWait</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">TurningRunner</span><span class="o">(),</span> <span class="s">"å¶æ•°"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">TurningRunner</span><span class="o">(),</span> <span class="s">"å¥‡æ•°"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//1. æ‹¿åˆ°é”ï¼Œæˆ‘ä»¬å°±æ‰“å°</span>
    <span class="c1">//2. æ‰“å°å®Œï¼Œå”¤é†’å…¶ä»–çº¿ç¨‹ï¼Œè‡ªå·±å°±ä¼‘çœ </span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TurningRunner</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">//æ‹¿åˆ°é”å°±æ‰“å°</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">count</span><span class="o">++);</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">notify</span><span class="o">();</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="c1">//å¦‚æœä»»åŠ¡è¿˜æ²¡ç»“æŸï¼Œå°±è®©å‡ºå½“å‰çš„é”ï¼Œå¹¶ä¼‘çœ </span>
                            <span class="n">lock</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ä¸ºä»€ä¹ˆwaitæ–¹æ³•éœ€è¦åœ¨<strong>åŒæ­¥ä»£ç å—</strong>ä¸­ä½¿ç”¨ï¼Œè€Œsleepä¸éœ€è¦ï¼Ÿ</p>

    <p>é˜²æ­¢æ­»é”çš„å‘ç”Ÿï¼Œå¦‚æœåœ¨waitä¹‹å‰è·³åˆ°äº†å…¶ä»–çº¿ç¨‹ä¸­ï¼Œé‚£è¿™ä¸ªçº¿ç¨‹å†è·³å›æ¥æ‰§è¡Œwaitä¹‹åå°±æ²¡æœ‰å…¶ä»–çº¿ç¨‹å”¤é†’å®ƒäº†</p>
  </li>
  <li>
    <p>ä¸ºä»€ä¹ˆçº¿ç¨‹é€šä¿¡çš„æ–¹æ³•ï¼šwaitï¼Œnotifyï¼ŒnotifyAllå®šä¹‰åœ¨Objectä¸­ï¼Œè€Œsleepæ–¹æ³•å®šä¹‰åœ¨Threadä¸­ï¼Ÿ</p>

    <p>â€‹</p>
  </li>
</ul>

<h4 id="sleepè¯¦è§£">sleepè¯¦è§£</h4>

<ul>
  <li>
    <p>ä½œç”¨ï¼šåªæƒ³è®©çº¿ç¨‹åœ¨é¢„æœŸçš„æ—¶é—´æ‰§è¡Œï¼Œå…¶ä»–æ—¶é—´ä¸è¦å ç”¨CPUèµ„æº</p>
  </li>
  <li>
    <p>ä¸é‡Šæ”¾é”ï¼ˆåŒ…æ‹¬synchronizedå’Œlockï¼‰</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">sun.awt.windows.ThemeReader</span><span class="o">;</span>

<span class="cm">/**
 * å±•ç¤ºçº¿ç¨‹sleepçš„æ—¶å€™ä¸é‡Šæ”¾synchronizedçš„monitorï¼Œç­‰sleepæ—¶é—´åˆ°äº†ä»¥åï¼Œæ­£å¸¸ç»“æŸåæ‰é‡Šæ”¾é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepDontReleaseMonitor</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SleepDontReleaseMonitor</span> <span class="n">sleepDontReleaseMonitor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SleepDontReleaseMonitor</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">sleepDontReleaseMonitor</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">sleepDontReleaseMonitor</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">syn</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">syn</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å–åˆ°äº†monitorã€‚"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é€€å‡ºäº†åŒæ­¥ä»£ç å—"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
çº¿ç¨‹Thread-0è·å–åˆ°äº†monitor
çº¿ç¨‹Thread-0é€€å‡ºäº†åŒæ­¥ä»£ç å—
çº¿ç¨‹thread-1è·å–åˆ°äº†monitor
çº¿ç¨‹Thread-1é€€å‡ºäº†åŒæ­¥ä»£ç å—
*/</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºsleepä¸é‡Šæ”¾lockï¼ˆlockéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepDontReleaseLock</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å–åˆ°äº†é”"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹"</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å·²ç»è‹é†’"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SleepDontReleaseLock</span> <span class="n">sleepDontReleaseLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SleepDontReleaseLock</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">sleepDontReleaseLock</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">sleepDontReleaseLock</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
çº¿ç¨‹Thread-0è·å–åˆ°äº†é”
çº¿ç¨‹Thread-0å·²ç»è‹é†’
çº¿ç¨‹Thread-1è·å–åˆ°äº†é”
çº¿ç¨‹Thread-1å·²ç»è‹é†’
*/</span>
</code></pre></div>    </div>

    <p>â€‹</p>
  </li>
  <li>
    <p>sleepæ–¹æ³•å“åº”ä¸­æ–­</p>

    <ul>
      <li>æŠ›å‡ºInterruptedException</li>
      <li>æ¸…é™¤ä¸­æ–­çŠ¶æ€</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¯ä¸ª1ç§’é’Ÿè¾“å‡ºå½“å‰æ—¶é—´ï¼Œè¢«ä¸­æ–­ï¼Œè§‚å¯Ÿã€‚
 * Thread.sleep()
 * TimeUnit.SECONDS.sleep()
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SleepInterrupted</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">SleepInterrupted</span><span class="o">());</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">6500</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">25</span><span class="o">);</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆ‘è¢«ä¸­æ–­äº†ï¼"</span><span class="o">);</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>
  </li>
  <li>
    <p>sleepæ–¹æ³•å¯ä»¥è®©çº¿ç¨‹è¿›å…¥waitingçŠ¶æ€ï¼Œå¹¶ä¸”ä¸å ç”¨CPUèµ„æºï¼Œä½†æ˜¯ä¸é‡Šæ”¾é”ï¼Œç›´åˆ°è§„å®šçš„æ—¶é—´åå†æ‰§è¡Œï¼Œä¼‘çœ æœŸé—´å¦‚æœè¢«ä¸­æ–­ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸å¹¶æ¸…é™¤ä¸­æ–­çŠ¶æ€ã€‚</p>
  </li>
</ul>

<h4 id="joinè¯¦è§£">joinè¯¦è§£</h4>

<ul>
  <li>
    <p>ä½œç”¨ï¼šå› ä¸ºæ–°çš„çº¿ç¨‹åŠ å…¥äº†æˆ‘ä»¬ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ç­‰ä»–æ‰§è¡Œå®Œå†å‡ºå‘</p>
  </li>
  <li>
    <p>ç”¨æ³•ï¼šmainç­‰å¾…thread1æ‰§è¡Œå®Œæ¯•ï¼Œ<strong>æ³¨æ„è°ç­‰è°</strong></p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºjoinï¼Œæ³¨æ„è¯­å¥è¾“å‡ºé¡ºåºï¼Œä¼šå˜åŒ–ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Join</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"æ‰§è¡Œå®Œæ¯•"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"æ‰§è¡Œå®Œæ¯•"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¼€å§‹ç­‰å¾…å­çº¿ç¨‹è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
å¼€å§‹ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
Thread-1æ‰§è¡Œå®Œæ¯•
Thread-0æ‰§è¡Œå®Œæ¯•
æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
*/</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>é‡åˆ°ä¸­æ–­</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºjoinæœŸé—´è¢«ä¸­æ–­çš„æ•ˆæœ
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JoinInterrupt</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">mainThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">mainThread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread1 finished."</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹ä¸­æ–­"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç­‰å¾…å­çº¿ç¨‹è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"ä¸»çº¿ç¨‹ä¸­æ–­äº†"</span><span class="o">);</span>
            <span class="n">thread1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹å·²è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>
    <p>åœ¨joinæœŸé—´ï¼Œçº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼Ÿ<strong>waiting</strong></p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     å…ˆjoinå†mainThread.getState()
 * é€šè¿‡debuggerçœ‹çº¿ç¨‹joinå‰åçŠ¶æ€çš„å¯¹æ¯”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JoinThreadState</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">mainThread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">mainThread</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Thread-0è¿è¡Œç»“æŸ"</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç­‰å¾…å­çº¿ç¨‹è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>
  </li>
  <li>
    <p>joinåŸç†</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     é€šè¿‡è®²è§£joinåŸç†ï¼Œåˆ†æå‡ºjoinçš„ä»£æ›¿å†™æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JoinPrinciple</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"æ‰§è¡Œå®Œæ¯•"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>

        <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¼€å§‹ç­‰å¾…å­çº¿ç¨‹è¿è¡Œå®Œæ¯•"</span><span class="o">);</span>
        <span class="n">thread</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
      <span class="c1">//ç­‰ä»·ä»£ç </span>
<span class="c1">//        synchronized (thread) {</span>
<span class="c1">//            thread.wait();</span>
<span class="c1">//        }</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="yieldè¯¦è§£">yieldè¯¦è§£</h4>

<ul>
  <li>ä½œç”¨ï¼šé‡Šæ”¾æˆ‘çš„CPUæ—¶é—´ç‰‡</li>
  <li>å®šä½ï¼šJVMä¸ä¿è¯éµå¾ª</li>
  <li>å’ŒsleepåŒºåˆ«ï¼šæ˜¯å¦éšæ—¶å¯èƒ½å†è¢«è°ƒåº¦</li>
</ul>

<h3 id="çº¿ç¨‹å„å±æ€§">çº¿ç¨‹å„å±æ€§</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">å±æ€§åç§°</th>
      <th style="text-align: center">ç”¨é€”</th>
      <th style="text-align: center">æ³¨æ„äº‹é¡¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">ç¼–å·ï¼ˆIDï¼‰</td>
      <td style="text-align: center">æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ID,ç”¨äºæ ‡è¯†ä¸åŒçš„çº¿ç¨‹</td>
      <td style="text-align: center">å”¯ä¸€æ€§ï¼Œä¸å…è®¸è¢«ä¿®æ”¹</td>
    </tr>
    <tr>
      <td style="text-align: center">åç§°ï¼ˆNAMEï¼‰</td>
      <td style="text-align: center">åœ¨å¼€å‘ï¼Œè°ƒè¯•æˆ–è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ›´å®¹æ˜“åŒºåˆ†æ¯ä¸ªä¸åŒçš„çº¿ç¨‹ï¼Œå®šä½é—®é¢˜</td>
      <td style="text-align: center">é»˜è®¤åç§°</td>
    </tr>
    <tr>
      <td style="text-align: center">æ˜¯å¦æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ˆisDaemonï¼‰</td>
      <td style="text-align: center">trueä»£è¡¨æ˜¯ã€å®ˆæŠ¤çº¿ç¨‹ã€‘ï¼Œfalseä»£è¡¨ä¸æ˜¯ã€å®ˆæŠ¤çº¿ç¨‹ã€‘ï¼Œä¹Ÿå°±æ˜¯ã€ç”¨æˆ·çº¿ç¨‹ã€‘</td>
      <td style="text-align: center">äºŒé€‰ä¸€ï¼›ç»§æ‰¿çˆ¶çº¿ç¨‹ï¼›setDaemon</td>
    </tr>
    <tr>
      <td style="text-align: center">ä¼˜å…ˆçº§ï¼ˆPriorityï¼‰</td>
      <td style="text-align: center">å‘Šè¯‰çº¿ç¨‹è°ƒåº¦å™¨ï¼Œç”¨æˆ·å¸Œæœ›å“ªäº›çº¿ç¨‹ç›¸å¯¹å¤šè¿è¡Œï¼Œå“ªäº›å°‘è¿è¡Œ</td>
      <td style="text-align: center">é»˜è®¤å’Œçˆ¶çº¿ç¨‹çš„ä¼˜å…ˆçº§ç›¸ç­‰ï¼Œå…±æœ‰åä¸ªç­‰çº§ï¼Œé»˜è®¤å€¼5ï¼›ä¸åº”ä¾èµ–</td>
    </tr>
  </tbody>
</table>

<h4 id="çº¿ç¨‹id">çº¿ç¨‹ID</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.threadobjectclasscommonmethods</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     IDä»1å¼€å§‹ï¼ŒJVMè¿è¡Œèµ·æ¥åï¼Œæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹çš„IDæ—©å·²ä¸æ˜¯2.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Id</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹çš„ID"</span><span class="o">+</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­çº¿ç¨‹çš„ID"</span><span class="o">+</span><span class="n">thread</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="çº¿ç¨‹åç§°">çº¿ç¨‹åç§°</h4>

<ul>
  <li>é»˜è®¤çº¿ç¨‹åç§°ä½¿Thread-è‡ªå¢æ•°</li>
  <li>å¯ä»¥å¯¹çº¿ç¨‹çš„åå­—è¿›è¡Œä¿®æ”¹</li>
</ul>

<h4 id="å®ˆæŠ¤çº¿ç¨‹">å®ˆæŠ¤çº¿ç¨‹</h4>

<ul>
  <li>ä½œç”¨ï¼šç»™ç”¨æˆ·çº¿ç¨‹æä¾›æœåŠ¡</li>
  <li>ä¸‰ä¸ªç‰¹æ€§ï¼š
    <ul>
      <li>çº¿ç¨‹ç±»å‹é»˜è®¤ç»§æ‰¿è‡ªçˆ¶çº¿ç¨‹</li>
      <li>è¢«è°å¯åŠ¨</li>
      <li>ä¸å½±å“JVMé€€å‡º</li>
    </ul>
  </li>
</ul>

<h4 id="ä¼˜å…ˆçº§">ä¼˜å…ˆçº§</h4>

<ul>
  <li>ä¸€å…±æœ‰åä¸ªï¼Œé»˜è®¤æ˜¯5</li>
  <li>ç¨‹åºè®¾è®¡ä¸åº”è¯¥ä¾èµ–äºä¼˜å…ˆçº§ï¼Œå› ä¸ºä¸åŒæ“ä½œç³»ç»Ÿä¼˜å…ˆçº§ä¸ä¸€æ ·</li>
</ul>

<h3 id="æœªæ•è·å¼‚å¸¸å¦‚ä½•å¤„ç†">æœªæ•è·å¼‚å¸¸å¦‚ä½•å¤„ç†ï¼Ÿ</h3>

<h4 id="æœªæ•è·å¼‚å¸¸">æœªæ•è·å¼‚å¸¸</h4>

<ul>
  <li>æœªæ•è·å¼‚å¸¸ï¼šUncaughtException</li>
  <li>éœ€è¦ä½¿ç”¨å…¨å±€å¼‚å¸¸å¤„ç†å™¨æ•è·ï¼šUncaughtExceptionHandler
    <ul>
      <li>å› ä¸ºä¸»çº¿ç¨‹å¯ä»¥è½»æ¾å‘ç°å¼‚å¸¸ï¼Œå­çº¿ç¨‹ä¸è¡Œ</li>
      <li>å­çº¿ç¨‹å¼‚å¸¸æ— æ³•ç”¨ä¼ ç»Ÿæ–¹å¼æ•è·</li>
    </ul>
  </li>
  <li>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†å™¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.uncaughtexception</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.logging.Level</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.Logger</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     è‡ªå·±çš„MyUncaughtExceptionHanlder
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUncaughtExceptionHandler</span> <span class="kd">implements</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">UncaughtExceptionHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MyUncaughtExceptionHandler</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">uncaughtException</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">t</span><span class="o">,</span> <span class="nc">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="nc">Logger</span><span class="o">.</span><span class="na">getAnonymousLogger</span><span class="o">();</span>
        <span class="n">logger</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="nc">Level</span><span class="o">.</span><span class="na">WARNING</span><span class="o">,</span> <span class="s">"çº¿ç¨‹å¼‚å¸¸ï¼Œç»ˆæ­¢å•¦"</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">"æ•è·äº†å¼‚å¸¸"</span> <span class="o">+</span> <span class="n">t</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¼‚å¸¸"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨å¼‚å¸¸å¤„ç†å™¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">threadcoreknowledge.uncaughtexception</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ä½¿ç”¨åˆšæ‰è‡ªå·±å†™çš„UncaughtExceptionHandler
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseOwnUncaughtExceptionHandler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">setDefaultUncaughtExceptionHandler</span><span class="o">(</span><span class="k">new</span> <span class="nc">MyUncaughtExceptionHandler</span><span class="o">(</span><span class="s">"æ•è·å™¨1"</span><span class="o">));</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UseOwnUncaughtExceptionHandler</span><span class="o">(),</span> <span class="s">"MyThread-1"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UseOwnUncaughtExceptionHandler</span><span class="o">(),</span> <span class="s">"MyThread-2"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UseOwnUncaughtExceptionHandler</span><span class="o">(),</span> <span class="s">"MyThread-3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UseOwnUncaughtExceptionHandler</span><span class="o">(),</span> <span class="s">"MyThread-4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="åŒåˆƒå‰‘å¤šçº¿ç¨‹ä¼šå¯¼è‡´çš„é—®é¢˜">åŒåˆƒå‰‘ï¼šå¤šçº¿ç¨‹ä¼šå¯¼è‡´çš„é—®é¢˜</h3>

<h4 id="çº¿ç¨‹å®‰å…¨">*çº¿ç¨‹å®‰å…¨</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼šå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¦‚æœä¸ç”¨è€ƒè™‘è¿™äº›çº¿ç¨‹åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸‹çš„è°ƒåº¦å’Œäº¤æ›¿æ‰§è¡Œï¼Œä¹Ÿä¸éœ€è¦è¿›è¡Œé¢å¤–çš„åŒæ­¥ï¼Œæˆ–è€…åœ¨è°ƒç”¨æ–¹è¿›è¡Œä»»ä½•å…¶ä»–çš„åè°ƒæ“ä½œï¼Œè°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„è¡Œä¸ºéƒ½å¯ä»¥è·å¾—æ­£ç¡®çš„ç»“æœï¼Œé‚£è¿™ä¸ªå¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
  <li>ä»€ä¹ˆæ˜¯çº¿ç¨‹å®‰å…¨ï¼šä¸ç®¡ä¸šåŠ¡ä¸­é‡åˆ°æ€æ ·çš„å¤šä¸ªçº¿ç¨‹è®¿é—®æŸå¯¹è±¡æˆ–æŸæ–¹æ³•çš„æƒ…å†µï¼Œè€Œåœ¨ç¼–å†™è¿™ä¸ªä¸šåŠ¡é€»è¾‘çš„æ—¶å€™ï¼Œéƒ½ä¸éœ€è¦åšä»»ä½•é¢å¤–çš„å¤„ç†ï¼ˆä¹Ÿå°±æ˜¯å¯ä»¥åƒå•çº¿ç¨‹ç¼–ç¨‹ä¸€æ ·ï¼‰ï¼Œç¨‹åºä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼ˆä¸ä¼šå› ä¸ºå¤šçº¿ç¨‹è€Œå‡ºé”™ï¼‰ï¼Œå°±å¯ä»¥ç§°ä¸ºçº¿ç¨‹å®‰å…¨ã€‚</li>
  <li>
    <p>çº¿ç¨‹ä¸å®‰å…¨ï¼šgetåŒæ—¶setï¼Œé¢å¤–åŒæ­¥</p>
  </li>
  <li>ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</li>
</ul>

<h5 id="aæƒ…å†µ">a++æƒ…å†µ</h5>

<ul>
  <li>
    <p>è¿è¡Œç»“æœé”™è¯¯ï¼Œa++å¤šçº¿ç¨‹ä¸‹å‡ºç°æ¶ˆå¤±çš„è¯·æ±‚ç°è±¡</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.BrokenBarrierException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CyclicBarrier</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç¬¬ä¸€ç§ï¼šè¿è¡Œç»“æœå‡ºé”™ã€‚ æ¼”ç¤ºè®¡æ•°ä¸å‡†ç¡®ï¼ˆå‡å°‘ï¼‰ï¼Œæ‰¾å‡ºå…·ä½“å‡ºé”™çš„ä½ç½®ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadsError</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">MultiThreadsError</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiThreadsError</span><span class="o">();</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">AtomicInteger</span> <span class="n">realIndex</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">AtomicInteger</span> <span class="n">wrongCount</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="c1">//è®©çº¿ç¨‹æ ¹æ®æˆ‘ä»¬çš„éœ€è¦åœ¨æŸä¸ªä½ç½®è¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°æ‰€ç­‰å¾…çš„äººå‘˜éƒ½å°±ç»ªå†ä¸€èµ·è§¦å‘</span>
    <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">CyclicBarrier</span> <span class="n">cyclicBarrier1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span><span class="c1">//ç­‰å¾…ä¸¤ä¸ªçº¿ç¨‹</span>
    <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">CyclicBarrier</span> <span class="n">cyclicBarrier2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

   <span class="c1">//è®°å½•çº¿ç¨‹å‘ç”Ÿå†²çªçš„é”™è¯¯ä½ç½®</span>
    <span class="kd">final</span> <span class="kt">boolean</span><span class="o">[]</span> <span class="n">marked</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">boolean</span><span class="o">[</span><span class="mi">10000000</span><span class="o">];</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">instance</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¡¨é¢ä¸Šç»“æœæ˜¯"</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="na">index</span><span class="o">);</span><span class="c1">//è¿è¡Œç»“æœæ™®éåå°‘</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çœŸæ­£è¿è¡Œçš„æ¬¡æ•°"</span> <span class="o">+</span> <span class="n">realIndex</span><span class="o">.</span><span class="na">get</span><span class="o">());</span><span class="c1">//æ­£ç¡®ç»“æœ</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é”™è¯¯æ¬¡æ•°"</span> <span class="o">+</span> <span class="n">wrongCount</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">//ç‰¹æ®Šæƒ…å†µï¼Œå¦‚æœç¬¬ä¸€æ¬¡å°±å‘ç”Ÿäº†çº¿ç¨‹é”™è¯¯</span>
        <span class="n">marked</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//é‡ç½®</span>
                <span class="n">cyclicBarrier2</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
                <span class="c1">//ç­‰å¾…</span>
                <span class="n">cyclicBarrier1</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">index</span><span class="o">++;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">cyclicBarrier1</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
                <span class="n">cyclicBarrier2</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">realIndex</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">instance</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">marked</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="n">marked</span><span class="o">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">])</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘ç”Ÿé”™è¯¯"</span> <span class="o">+</span> <span class="n">index</span><span class="o">);</span>
                    <span class="n">wrongCount</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">marked</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p><img src="https://i.loli.net/2020/05/23/ZDnAvpzWMb6xKN1.png" alt="image.png" /></p>
  </li>
  <li>
    <p>æ´»è·ƒæ€§é—®é¢˜ï¼šæ­»é”ï¼Œæ´»é”ï¼Œé¥¥é¥¿</p>
  </li>
</ul>

<h5 id="æ­»é”">æ­»é”</h5>

<p><img src="https://i.loli.net/2020/05/23/75DPvo1MHARyXjY.png" alt="image.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç¬¬äºŒç« çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæ¼”ç¤ºæ­»é”ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadError</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MultiThreadError</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiThreadError</span><span class="o">();</span>
        <span class="nc">MultiThreadError</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiThreadError</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"flag = "</span> <span class="o">+</span> <span class="n">flag</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"0"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h5 id="å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–">å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–</h5>

<ul>
  <li>
    <p>å¯¹è±¡å‘å¸ƒå’Œåˆå§‹åŒ–çš„æ—¶å€™çš„å®‰å…¨é—®é¢˜ï¼š</p>

    <ul>
      <li>
        <p>ä»€ä¹ˆæ˜¯é€¸å‡ºï¼š</p>

        <ul>
          <li>1.æ–¹æ³•è¿”å›ä¸€ä¸ªprivateå¯¹è±¡ï¼ˆprivateçš„æœ¬æ„æ˜¯ä¸è®©å¤–éƒ¨è®¿é—®ï¼‰</li>
        </ul>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.sun.javafx.geom.Matrix3f</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     å‘å¸ƒé€¸å‡º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadsError3</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">states</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MultiThreadsError3</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">states</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">states</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="s">"å‘¨ä¸€"</span><span class="o">);</span>
        <span class="n">states</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"2"</span><span class="o">,</span> <span class="s">"å‘¨äºŒ"</span><span class="o">);</span>
        <span class="n">states</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"3"</span><span class="o">,</span> <span class="s">"å‘¨ä¸‰"</span><span class="o">);</span>
        <span class="n">states</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"4"</span><span class="o">,</span> <span class="s">"å‘¨å››"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getStates</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">states</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getStatesImproved</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">states</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MultiThreadsError3</span> <span class="n">multiThreadsError3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiThreadsError3</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">states</span> <span class="o">=</span> <span class="n">multiThreadsError3</span><span class="o">.</span><span class="na">getStates</span><span class="o">();</span>
<span class="c1">//        System.out.println(states.get("1"));</span>
<span class="c1">//        states.remove("1");mapæ˜¯æœåŠ¡äºå¾ˆå¤šä¸ªç±»çš„ï¼Œä¸èƒ½éšæ„ç¯¡æ”¹mapçš„æ•°æ®ï¼Œä¼šå‡ºç°å®‰å…¨éšæ‚£</span>
<span class="c1">//        System.out.println(states.get("1"));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">multiThreadsError3</span><span class="o">.</span><span class="na">getStatesImproved</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"1"</span><span class="o">));</span>
        <span class="n">multiThreadsError3</span><span class="o">.</span><span class="na">getStatesImproved</span><span class="o">().</span><span class="na">remove</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">multiThreadsError3</span><span class="o">.</span><span class="na">getStatesImproved</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"1"</span><span class="o">));</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>        </div>

        <p>â€‹</p>

        <ul>
          <li>2.è¿˜æœªå®Œæˆåˆå§‹åŒ–ï¼ˆæ„é€ å‡½æ•°æ²¡å®Œå…¨æ‰§è¡Œå®Œæ¯•ï¼‰å°±æŠŠå¯¹è±¡æä¾›ç»™å¤–ç•Œï¼Œæ¯”å¦‚ï¼š</li>
          <li>åœ¨æ„é€ å‡½æ•°ä¸­æœªåˆå§‹åŒ–å®Œæ¯•å°±thisèµ‹å€¼</li>
        </ul>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     åˆå§‹åŒ–æœªå®Œæ¯•ï¼Œå°±thisèµ‹å€¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadsError4</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">Point</span> <span class="n">point</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">PointMaker</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
<span class="c1">//        Thread.sleep(10);</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">105</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">point</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">point</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Point</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Point</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="kt">int</span> <span class="n">y</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
        <span class="nc">MultiThreadsError4</span><span class="o">.</span><span class="na">point</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">y</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">PointMaker</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Point</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>        </div>

        <p>â€‹</p>

        <ul>
          <li>éšå¼é€¸å‡ºâ€”â€”æ³¨å†Œç›‘å¬äº‹ä»¶</li>
        </ul>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     è§‚å¯Ÿè€…æ¨¡å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiThreadsError5</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MultiThreadsError5</span><span class="o">(</span><span class="nc">MySource</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">source</span><span class="o">.</span><span class="na">registerListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">EventListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="nc">Event</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\næˆ‘å¾—åˆ°çš„æ•°å­—æ˜¯"</span> <span class="o">+</span> <span class="n">count</span><span class="o">);</span>
            <span class="o">}</span>

        <span class="o">});</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MySource</span> <span class="n">mySource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MySource</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">mySource</span><span class="o">.</span><span class="na">eventCome</span><span class="o">(</span><span class="k">new</span> <span class="nc">Event</span><span class="o">()</span> <span class="o">{</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">MultiThreadsError5</span> <span class="n">multiThreadsError5</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MultiThreadsError5</span><span class="o">(</span><span class="n">mySource</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MySource</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">EventListener</span> <span class="n">listener</span><span class="o">;</span>

        <span class="kt">void</span> <span class="nf">registerListener</span><span class="o">(</span><span class="nc">EventListener</span> <span class="n">eventListener</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">listener</span> <span class="o">=</span> <span class="n">eventListener</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">void</span> <span class="nf">eventCome</span><span class="o">(</span><span class="nc">Event</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">listener</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">listener</span><span class="o">.</span><span class="na">onEvent</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿˜æœªåˆå§‹åŒ–å®Œæ¯•"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">interface</span> <span class="nc">EventListener</span> <span class="o">{</span>

        <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="nc">Event</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">interface</span> <span class="nc">Event</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>        </div>

        <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">background</span><span class="o">;</span>
</code></pre></div>        </div>

        <p>/**</p>
        <ul>
          <li>
            <p>æè¿°ï¼š     ç”¨å·¥å‚æ¨¡å¼ä¿®å¤åˆšæ‰çš„åˆå§‹åŒ–é—®é¢˜
 */
public class MultiThreadsError7 {</p>

            <p>int count;
 private EventListener listener;</p>

            <p>private MultiThreadsError7(MySource source) {
     listener = new EventListener() {
         @Override
         public void onEvent(MultiThreadsError5.Event e) {
             System.out.println(â€œ\næˆ‘å¾—åˆ°çš„æ•°å­—æ˜¯â€ + count);
         }</p>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> };
 for (int i = 0; i &lt; 10000; i++) {
     System.out.print(i);
 }
 count = 100;  }
</code></pre></div>            </div>

            <p>public static MultiThreadsError7 getInstance(MySource source) {
     MultiThreadsError7 safeListener = new MultiThreadsError7(source);
     source.registerListener(safeListener.listener);
     return safeListener;
 }</p>

            <p>public static void main(String[] args) {
     MySource mySource = new MySource();
     new Thread(new Runnable() {
         @Override
         public void run() {
             try {
                 Thread.sleep(10);
             } catch (InterruptedException e) {
                 e.printStackTrace();
             }
             mySource.eventCome(new MultiThreadsError5.Event() {
             });
         }
     }).start();
     MultiThreadsError7 multiThreadsError7 = new MultiThreadsError7(mySource);
 }</p>

            <p>static class MySource {</p>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> private EventListener listener;

 void registerListener(EventListener eventListener) {
     this.listener = eventListener;
 }

 void eventCome(MultiThreadsError5.Event e) {
     if (listener != null) {
         listener.onEvent(e);
     } else {
         System.out.println("è¿˜æœªåˆå§‹åŒ–å®Œæ¯•");
     }
 }
</code></pre></div>            </div>

            <p>}</p>

            <p>interface EventListener {</p>

            <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> void onEvent(MultiThreadsError5.Event e);  }
</code></pre></div>            </div>

            <p>interface Event {</p>

            <p>}
}</p>
          </li>
        </ul>

        <p>â€‹```</p>

        <p>â€‹</p>

        <ul>
          <li>æ„é€ å‡½æ•°ä¸­è¿è¡Œçº¿ç¨‹</li>
        </ul>

        <p>â€‹```java
package background;</p>

        <p>import java.util.HashMap;
import java.util.Map;</p>

        <p>/**</p>
        <ul>
          <li>
            <p>æè¿°ï¼š     æ„é€ å‡½æ•°ä¸­æ–°å»ºçº¿ç¨‹
 */
public class MultiThreadsError6 {</p>

            <p>private Map&lt;String, String&gt; states;</p>

            <p>public MultiThreadsError6() {
     new Thread(new Runnable() {
         @Override
         public void run() {
             states = new HashMap&lt;&gt;();
             states.put(â€œ1â€, â€œå‘¨ä¸€â€);
             states.put(â€œ2â€, â€œå‘¨äºŒâ€);
             states.put(â€œ3â€, â€œå‘¨ä¸‰â€);
             states.put(â€œ4â€, â€œå‘¨å››â€);
         }
     }).start();
 }</p>

            <p>public Map&lt;String, String&gt; getStates() {
     return states;
 }</p>

            <p>public static void main(String[] args) throws InterruptedException {
     MultiThreadsError6 multiThreadsError6 = new MultiThreadsError6();
     Thread.sleep(1000);
     System.out.println(multiThreadsError6.getStates().get(â€œ1â€));
 }
}</p>
          </li>
        </ul>

        <p>â€‹```</p>

        <p>â€‹</p>
      </li>
    </ul>
  </li>
  <li>
    <p>å„ç§éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„æƒ…å†µ</p>

    <ul>
      <li>è®¿é—®å…±äº«èµ„æºæˆ–å˜é‡ï¼Œä¼šæœ‰å¹¶å‘é£é™©ï¼Œæ¯”å¦‚å¯¹è±¡çš„å±æ€§ï¼Œé™æ€å˜é‡ï¼Œå…±äº«ç¼“å­˜ï¼Œæ•°æ®åº“ç­‰</li>
      <li>æ‰€æœ‰ä¾èµ–æ—¶åºçš„æ“ä½œï¼Œå³ä½¿æ¯ä¸€æ­¥æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿˜æ˜¯å­˜åœ¨å¹¶å‘é—®é¢˜ï¼šread-modify-writeã€check-then-act</li>
      <li>ä¸åŒçš„æ•°æ®ä¹‹é—´å­˜åœ¨æ†ç»‘å…³ç³»çš„æ—¶å€™</li>
      <li>æˆ‘ä»¬ä½¿ç”¨å…¶ä»–ç±»çš„æ—¶å€™ï¼Œå¦‚æœå¯¹æ–¹æ²¡æœ‰å£°æ˜è‡ªå·±æ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
    </ul>
  </li>
</ul>

<h4 id="æ€§èƒ½é—®é¢˜">æ€§èƒ½é—®é¢˜</h4>

<ul>
  <li>ä¸ºä»€ä¹ˆå¤šçº¿ç¨‹ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼š
    <ul>
      <li>è°ƒåº¦ï¼šä¸Šä¸‹æ–‡åˆ‡æ¢
        <ul>
          <li>ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ï¼Ÿ</li>
          <li>ç¼“å­˜å¼€é”€</li>
          <li>ä½•æ—¶ä¼šå¯¼è‡´å¯†é›†çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
        </ul>
      </li>
      <li>åä½œï¼šå†…å­˜åŒæ­¥</li>
    </ul>
  </li>
</ul>

<h3 id="javaå†…å­˜æ¨¡å‹">Javaå†…å­˜æ¨¡å‹</h3>

<ul>
  <li>JVMå†…å­˜ç»“æ„ï¼Œå’ŒJavaè™šæ‹Ÿæœºçš„<strong>è¿è¡Œæ—¶åŒºåŸŸ</strong>æœ‰å…³ã€‚</li>
  <li>Javaå†…å­˜æ¨¡å‹ï¼Œå’ŒJavaçš„<strong>å¹¶å‘ç¼–ç¨‹</strong>æœ‰å…³</li>
  <li>Javaå¯¹è±¡æ¨¡å‹ï¼Œå’ŒJavaå¯¹è±¡åœ¨<strong>è™šæ‹Ÿæœºä¸­çš„è¡¨ç°å½¢å¼</strong>æœ‰å…³ã€‚</li>
</ul>

<h4 id="javaå†…å­˜ç»“æ„">Javaå†…å­˜ç»“æ„</h4>

<p><img src="https://i.loli.net/2020/05/24/XLYubaPFcD2Hvsn.png" alt="image.png" /></p>

<h4 id="javaå¯¹è±¡æ¨¡å‹">Javaå¯¹è±¡æ¨¡å‹</h4>

<p><img src="https://i.loli.net/2020/05/24/91RecUBZshpAmgw.png" alt="image.png" /></p>

<ul>
  <li>Javaå¯¹è±¡è‡ªèº«çš„å­˜å‚¨æ¨¡å‹</li>
  <li>JVMä¼šç»™è¿™ä¸ªç±»åˆ›å»ºä¸€ä¸ªinstanceKlassï¼Œä¿å­˜åœ¨æ–¹æ³•åŒºï¼Œç”¨æ¥åœ¨JVMå±‚è¡¨ç¤ºè¯¥Javaç±»</li>
  <li>å½“æˆ‘ä»¬åœ¨Javaä»£ç ä¸­ï¼Œä½¿ç”¨newåˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼ŒJVMä¼šåˆ›å»ºä¸€ä¸ªinstanceOopDescå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¸­åŒ…å«äº†å¯¹è±¡å¤´ä»¥åŠå®ä¾‹æ•°æ®ã€‚</li>
</ul>

<h4 id="javaå†…å­˜æ¨¡å‹-1">Javaå†…å­˜æ¨¡å‹</h4>

<ul>
  <li>JMMï¼ˆJava memory modelï¼‰ï¼šæ˜¯ä¸€ç»„è§„èŒƒï¼Œéœ€è¦å„ä¸ªJVMçš„å®ç°æ¥éµå®ˆJMMè§„èŒƒï¼Œä»¥ä¾¿äºå¼€å‘è€…å¯ä»¥åˆ©ç”¨è¿™äº›è§„èŒƒï¼Œæ›´æ–¹ä¾¿åœ°å¼€å‘å¤šçº¿ç¨‹ç¨‹åºã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„ä¸€ä¸ªJMMå†…å­˜æ¨¡å‹æ¥è§„èŒƒï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½ç»è¿‡äº†ä¸åŒJVMçš„ä¸åŒè§„åˆ™çš„é‡æ’åºä¹‹åï¼Œå¯¼è‡´ä¸åŒçš„è™šæ‹Ÿæœºä¸Šè¿è¡Œçš„ç»“æœä¸ä¸€æ ·ï¼Œé‚£æ˜¯å¾ˆå¤§çš„é—®é¢˜ã€‚</li>
  <li>volatileï¼Œsynchronizedï¼Œlockç­‰çš„åŸç†éƒ½æ˜¯JMM</li>
  <li>å¦‚æœæ²¡æœ‰JMMï¼Œé‚£å°±éœ€è¦æˆ‘ä»¬è‡ªå·±æŒ‡å®šä»€ä¹ˆæ—¶å€™ç”¨å†…å­˜æ …æ ç­‰ï¼Œé‚£æ˜¯ç›¸å½“éº»çƒ¦çš„ï¼Œå¹¸å¥½æœ‰äº†JMMï¼Œè®©æˆ‘ä»¬åªéœ€è¦ç”¨åŒæ­¥å·¥å…·å’Œå…³é”®è¯å°±å¯ä»¥å¼€å‘å¹¶å‘ç¨‹åºã€‚</li>
  <li><strong>æœ€é‡è¦ä¸‰ç‚¹å†…å®¹ï¼šé‡æ’åºï¼Œå¯è§æ€§ï¼ŒåŸå­æ€§ã€‚</strong></li>
  <li>ä¸ºä»€ä¹ˆéœ€è¦JMMï¼Ÿ
    <ul>
      <li>cè¯­è¨€ä¸å­˜åœ¨å†…å­˜æ¨¡å‹çš„æ¦‚å¿µ</li>
      <li>ä¾èµ–å¤„ç†å™¨ï¼Œä¸åŒå¤„ç†å™¨ç»“æœä¸ä¸€æ ·</li>
      <li>æ— æ³•ä¿è¯å¹¶å‘å®‰å…¨</li>
      <li>éœ€è¦ä¸€ä¸ªæ ‡å‡†ï¼Œè®©å¤šçº¿ç¨‹è¿è¡Œçš„ç»“æœå¯é¢„æœŸ</li>
    </ul>
  </li>
</ul>

<h4 id="é‡æ’åº">é‡æ’åº</h4>

<ul>
  <li>é‡æ’åºçš„å¥½å¤„ï¼šæé«˜å¤„ç†é€Ÿåº¦</li>
  <li>é‡æ’åºçš„ä¸‰ç§æƒ…å†µï¼šç¼–è¯‘å™¨ä¼˜åŒ–ã€CPUæŒ‡ä»¤é‡æ’ã€å†…å­˜çš„â€œé‡æ’åºâ€ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">jmm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºé‡æ’åºçš„ç°è±¡ â€œç›´åˆ°è¾¾åˆ°æŸä¸ªæ¡ä»¶æ‰åœæ­¢â€ï¼Œæµ‹è¯•å°æ¦‚ç‡äº‹ä»¶
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutOfOrderExecution</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
            <span class="n">i</span><span class="o">++;</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
			<span class="c1">//é—¸é—¨å·¥å…·ç±»</span>
            <span class="nc">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>

            <span class="nc">Thread</span> <span class="n">one</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="nc">Thread</span> <span class="n">two</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>
            <span class="n">two</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">one</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
            <span class="n">one</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">two</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

            <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">"ç¬¬"</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">"æ¬¡ï¼ˆ"</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="s">")"</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>


<span class="o">}</span>
<span class="cm">/*
ç¨‹åºä¸€å…±æœ‰ä¸‰ç§æƒ…å†µï¼š
ï¼ˆ1ï¼‰ a=1;x=b(0);b=1;y=a(1),æœ€ç»ˆç»“æœä¸ºx=0,y=1ï¼›å…ˆæ‰§è¡Œoneï¼Œåæ‰§è¡Œtwo
ï¼ˆ2ï¼‰ b=1;y=a(0);a=1;x=b(1),æœ€ç»ˆç»“æœä¸ºx=1,y=0ï¼›å…ˆæ‰§è¡Œtwoï¼Œåæ‰§è¡Œone
ï¼ˆ3ï¼‰ b=1;a=1;x=b(1);y=a(1),æœ€ç»ˆç»“æœä¸ºx=1,y=1;è¿™ç§æƒ…å†µéœ€è¦ä½¿ç”¨é—¸é—¨ï¼Œå…ˆæ‰§è¡Œä¸¤ä¸ªçº¿ç¨‹çš„ç¬¬ä¸€è¡Œä»£ç 
*/</span>
</code></pre></div></div>

<ul>
  <li>æ˜¯å¦ä¼šå‡ºç°x=0ï¼Œy=0çš„æƒ…å†µï¼Ÿç­”æ¡ˆæ˜¯ä¼šçš„ï¼Œé‚£æ˜¯å› ä¸º<strong>é‡æ’åº</strong>å‘ç”Ÿäº†ï¼Œå››è¡Œä»£ç çš„æ‰§è¡Œé¡ºåºçš„å…¶ä¸­ä¸€ç§å¯èƒ½æ˜¯ï¼šy=a; a=1; x=b; b=1;</li>
  <li><strong>ä»€ä¹ˆæ˜¯é‡æ’åº</strong>ï¼šåœ¨çº¿ç¨‹1å†…éƒ¨çš„ä¸¤è¡Œä»£ç çš„<strong>å®é™…æ‰§è¡Œé¡ºåº</strong>å’Œä»£ç åœ¨<strong>Javaæ–‡ä»¶ä¸­çš„é¡ºåº</strong>ä¸ä¸€è‡´ï¼Œä»£ç æŒ‡ä»¤å¹¶ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§ä»£ç è¯­å¥é¡ºåºæ‰§è¡Œçš„ï¼Œä»–ä»¬çš„é¡ºåºè¢«æ”¹å˜äº†ï¼Œè¿™å°±æ˜¯é‡æ’åºï¼Œè¿™é‡Œè¢«é¢ å€’çš„æ˜¯y=aå’Œb=1è¿™ä¸¤è¡Œè¯­å¥ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/8RUrKhZ4MW15CYS.png" alt="image.png" /></p>

<ul>
  <li>ç¼–è¯‘å™¨ä¼˜åŒ–ï¼šåŒ…æ‹¬JVMï¼ŒJITç¼–è¯‘å™¨ç­‰ã€‚</li>
  <li>CPUæŒ‡ä»¤é‡æ’ï¼šå°±ç®—ç¼–è¯‘å™¨ä¸å‘ç”Ÿé‡æ’ï¼ŒCPUä¹Ÿå¯èƒ½å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’</li>
  <li>å†…å­˜çš„â€œé‡æ’åºâ€ï¼šçº¿ç¨‹Açš„ä¿®æ”¹æ“ä½œå¯¹äºçº¿ç¨‹Bæ¥è¯´æ˜¯çœ‹ä¸åˆ°çš„ï¼Œå¼•å‡ºå¯è§æ€§é—®é¢˜</li>
</ul>

<h4 id="å¯è§æ€§">å¯è§æ€§</h4>

<ul>
  <li>çº¿ç¨‹ä¹‹é—´çš„é€šè®¯æœ‰æ—¶é—´å»¶è¿Ÿï¼Œå¯èƒ½ä¼šå‘ç”Ÿæ•°æ®è¯»å–é”™è¯¯é—®é¢˜</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/5kthfjQ1dpDiCWe.png" alt="image.png" /></p>

<ul>
  <li>é¦–å…ˆä¿®æ”¹çº¿ç¨‹å»ä¿®æ”¹äº†xçš„å€¼ï¼Œè¿™æ—¶è¿˜æ²¡æœ‰åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œè€Œè¯»å–çº¿ç¨‹å°±å»è¯»å–ä¸»å†…å­˜ä¸­çš„xå€¼ï¼Œæ˜¾ç„¶è¯»å–åˆ°çš„å€¼æ˜¯é”™è¯¯çš„</li>
  <li>ä¸ºä»€ä¹ˆä¼šæœ‰å¯è§æ€§é—®é¢˜ï¼Ÿ
    <ul>
      <li>CPUæœ‰å¤šçº§ç¼“å­˜ï¼Œå¯¼è‡´è¯»å–çš„æ•°æ®è¿‡æœŸï¼›</li>
      <li>é«˜é€Ÿç¼“å­˜çš„å®¹é‡æ¯”ä¸»å†…å­˜å°ï¼Œä½†æ˜¯é€Ÿåº¦ä»…æ¬¡äºå¯„å­˜å™¨ï¼Œæ‰€ä»¥åœ¨CPUå’Œä¸»å­˜ä¹‹é—´å°±å¤šäº†cacheå±‚ï¼›</li>
      <li>çº¿ç¨‹é—´çš„å¯¹äºå…±äº«å˜é‡çš„å¯è§æ€§é—®é¢˜ä¸æ˜¯ç›´æ¥ç”±å¤šæ ¸å¼•èµ·çš„ï¼Œè€Œæ˜¯ç”±å¤šç¼“å­˜å¼•èµ·çš„ã€‚</li>
      <li>å¦‚æœæ‰€æœ‰ä¸ªæ ¸å¿ƒéƒ½åªç”¨ä¸€ä¸ªç¼“å­˜ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸å­˜åœ¨å†…å­˜å¯è§æ€§é—®é¢˜äº†ï¼›</li>
      <li>æ¯ä¸ªæ ¸å¿ƒéƒ½ä¼šå°†è‡ªå·±éœ€è¦çš„æ•°æ®è¯»å–åˆ°ç‹¬å ç¼“å­˜ä¸­ï¼Œæ•°æ®ä¿®æ”¹åä¹Ÿæ˜¯å†™å…¥åˆ°ç¼“å­˜ä¸­ï¼Œç„¶åç­‰å¾…åˆ·å…¥åˆ°ä¸»å­˜ä¸­ã€‚æ‰€ä»¥ä¼šå¯¼è‡´æœ‰äº›æ ¸å¿ƒè¯»å–çš„å€¼æ˜¯ä¸€ä¸ªè¿‡æœŸçš„å€¼ã€‚</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">jmm</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºå¯è§æ€§å¸¦æ¥çš„é—®é¢˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FieldVisibility</span> <span class="o">{</span>

  <span class="c1">//ä¼šå‡ºç°å¯è§æ€§é—®é¢˜</span>
     <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
     <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">change</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"b="</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s">";a="</span> <span class="o">+</span> <span class="n">a</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">FieldVisibility</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FieldVisibility</span><span class="o">();</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">test</span><span class="o">.</span><span class="na">change</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">test</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>


<span class="o">}</span>
<span class="cm">/*
a=3,b=2
a=1,b=2
a=3,b=3
a=1,b=3(å‡ºç°äº†å¯è§æ€§é—®é¢˜ï¼Œä½¿ç”¨volatileæ¥è§£å†³)
*/</span>
</code></pre></div></div>

<ul>
  <li>ç»™båŠ volatileå…³é”®å­—æ¥è§£å†³å¯è§æ€§é—®é¢˜ï¼šå¯¹bè¿›è¡Œè¯»æ“ä½œæ—¶ä¸€å®šå¯è§å¯¹bçš„å†™æ“ä½œå‰çš„æ‰€æœ‰æ“ä½œã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ä½¿ç”¨volatileè§£å†³å¯è§æ€§å¸¦æ¥çš„é—®é¢˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FieldVisibility</span> <span class="o">{</span>

  <span class="c1">//ä¼šå‡ºç°å¯è§æ€§é—®é¢˜</span>
     <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
     <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">change</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"b="</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="s">";a="</span> <span class="o">+</span> <span class="n">a</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">FieldVisibility</span> <span class="n">test</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FieldVisibility</span><span class="o">();</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">test</span><span class="o">.</span><span class="na">change</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="n">test</span><span class="o">.</span><span class="na">print</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>


<span class="o">}</span>
<span class="cm">/*
a=3,b=2
a=1,b=2
a=3,b=3
a=1,b=3(è¿™ç§æƒ…å†µå°±ä¸ä¼šå‡ºç°äº†)
*/</span>
</code></pre></div></div>

<h4 id="ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜">ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜</h4>

<ul>
  <li>Javaä½œä¸ºé«˜çº§è¯­è¨€ï¼Œå±è”½äº†è¿™äº›åº•å±‚ç»†èŠ‚ï¼Œç”¨JMMå®šä¹‰äº†ä¸€å¥—è¯»å†™å†…å­˜æ•°æ®çš„è§„èŒƒï¼Œè™½ç„¶æˆ‘ä»¬ä¸å†éœ€è¦å…³å¿ƒä¸€çº§ç¼“å­˜å’ŒäºŒçº§ç¼“å­˜çš„é—®é¢˜ï¼Œä½†æ˜¯ï¼ŒJMMæŠ½è±¡äº†ä¸»å†…å­˜å’Œæœ¬åœ°å†…å­˜çš„æ¦‚å¿µã€‚</li>
  <li>è¿™é‡Œè¯´çš„æœ¬åœ°å†…å­˜å¹¶ä¸æ˜¯çœŸçš„æ˜¯ä¸€å—ç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…çš„å†…å­˜ï¼Œè€Œæ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡ï¼Œæ˜¯å¯¹äºå¯„å­˜å™¨ã€ä¸€çº§ç¼“å­˜ã€äºŒçº§ç¼“å­˜ç­‰çš„æŠ½è±¡ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/eNb3y2pdBLC4Ra1.png" alt="image.png" /></p>

<ul>
  <li>JMMæœ‰ä»¥ä¸‹è§„å®šï¼š
    <ul>
      <li>æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ä¸­ï¼ŒåŒæ—¶æ¯ä¸ªçº¿ç¨‹ä¹Ÿæœ‰è‡ªå·±ç‹¬ç«‹çš„å·¥ä½œå†…å­˜ï¼Œå·¥ä½œå†…å­˜ä¸­çš„å˜é‡å†…å®¹æ˜¯ä¸»å†…å­˜ä¸­çš„æ‹·è´</li>
      <li>çº¿ç¨‹ä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œè€Œæ˜¯åªèƒ½æ“ä½œè‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ï¼Œç„¶åå†åŒæ­¥åˆ°ä¸»å†…å­˜ä¸­</li>
      <li>ä¸»å†…å­˜æ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œä½†çº¿ç¨‹é—´ä¸å…±äº«å·¥ä½œå†…å­˜ï¼Œå¦‚æœçº¿ç¨‹é—´éœ€è¦é€šä¿¡ï¼Œå¿…é¡»å€ŸåŠ©ä¸»å†…å­˜ä¸­è½¬æ¥å®Œæˆã€‚</li>
    </ul>
  </li>
  <li>æ‰€æœ‰çš„å…±äº«å˜é‡å­˜åœ¨äºä¸»å†…å­˜ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„æœ¬åœ°å†…å­˜ï¼Œè€Œä¸”çº¿ç¨‹è¯»å†™å…±äº«æ•°æ®ä¹Ÿæ˜¯é€šè¿‡æœ¬åœ°å†…å­˜äº¤æ¢çš„ï¼Œæ‰€ä»¥æ‰å¯¼è‡´äº†å¯è§æ€§é—®é¢˜ã€‚</li>
</ul>

<h4 id="happens-beforeè§„åˆ™">Happens-Beforeè§„åˆ™</h4>

<h5 id="å•çº¿ç¨‹è§„åˆ™">å•çº¿ç¨‹è§„åˆ™</h5>

<ul>
  <li>åœ¨å•çº¿ç¨‹ä¸­ï¼Œåé¢çš„æ“ä½œä¸€å®šçŸ¥é“å‰é¢çš„æ“ä½œ</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/1WKOREAj3ydZu2q.png" alt="image.png" /></p>

<h5 id="é”æ“ä½œ">é”æ“ä½œ</h5>

<ul>
  <li>é”åŒ…æ‹¬synchronizedå’Œlock</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/gflpO5e9SoE2XqL.png" alt="image.png" /></p>

<p><img src="https://i.loli.net/2020/05/24/amcLSxT4IUl8AMY.png" alt="image.png" /></p>

<h5 id="volatileå˜é‡">volatileå˜é‡</h5>

<ul>
  <li>å¦‚æœAæ˜¯å¯¹volatileå˜é‡çš„å†™æ“ä½œï¼ŒBæ˜¯å¯¹åŒä¸€å˜é‡çš„è¯»æ“ä½œï¼Œé‚£ä¹ˆhb(A,B)</li>
</ul>

<p><img src="https://i.loli.net/2020/05/24/MpLD9T3AbE2GWH5.png" alt="image.png" /></p>

<h5 id="çº¿ç¨‹å¯åŠ¨">çº¿ç¨‹å¯åŠ¨</h5>

<p><img src="https://i.loli.net/2020/05/24/mHR57CdvIiFlkwK.png" alt="image.png" /></p>

<h5 id="çº¿ç¨‹join">çº¿ç¨‹join</h5>

<p><img src="https://i.loli.net/2020/05/24/lvPyfzwIRq82UY9.png" alt="image.png" /></p>

<h5 id="ä¼ é€’æ€§">ä¼ é€’æ€§</h5>

<ul>
  <li>å¦‚æœhb(A,B)è€Œä¸”hb(B,C),é‚£ä¹ˆå¯ä»¥æ¨å‡ºhb(A,C)</li>
</ul>

<h5 id="ä¸­æ–­">ä¸­æ–­</h5>

<ul>
  <li>ä¸€ä¸ªçº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹interruptæ—¶ï¼Œé‚£ä¹ˆæ£€æµ‹ä¸­æ–­ï¼ˆisInterruptedï¼‰æˆ–è€…æŠ›å‡ºInterruptedExceptionä¸€å®šèƒ½çœ‹åˆ°ã€‚</li>
</ul>

<h5 id="æ„é€ æ–¹æ³•">æ„é€ æ–¹æ³•</h5>

<ul>
  <li>å¯¹è±¡æ„é€ æ–¹æ³•çš„æœ€åä¸€è¡ŒæŒ‡ä»¤happens-beforeäºfinalizeï¼ˆï¼‰æ–¹æ³•çš„ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚</li>
</ul>

<h5 id="å·¥å…·ç±»">å·¥å…·ç±»</h5>

<ul>
  <li>çº¿ç¨‹å®‰å…¨çš„å®¹å™¨getä¸€å®šèƒ½çœ‹åˆ°åœ¨æ­¤ä¹‹å‰çš„putç­‰å­˜å…¥åŠ¨ä½œ</li>
  <li>CountDownLatch</li>
  <li>Semaphore</li>
  <li>Future</li>
  <li>çº¿ç¨‹æ± </li>
  <li>CyclicBarrier</li>
</ul>

<h4 id="volatileå…³é”®å­—">volatileå…³é”®å­—</h4>

<ul>
  <li>volatileæ˜¯ä»€ä¹ˆï¼švolatileæ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œæ¯”synchronizedæˆ–è€…lockç›¸å…³ç±»æ›´è½»é‡ï¼Œå› ä¸ºä½¿ç”¨volatileå¹¶ä¸ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰å¼€é”€å¾ˆå¤§çš„è¡Œä¸º</li>
  <li>å¦‚æœä¸€ä¸ªå˜é‡è¢«ä¿®é¥°æˆvolatileï¼Œé‚£ä¹ˆJVMå°±ä¼šçŸ¥é“è¿™ä¸ªå˜é‡å¯èƒ½ä¼šè¢«å¹¶å‘ä¿®æ”¹ã€‚</li>
  <li>ä½†æ˜¯å¼€é”€å°ï¼Œç›¸åº”çš„èƒ½åŠ›ä¹Ÿå°ï¼Œè™½ç„¶è¯´volatileæ˜¯ç”¨æ¥åŒæ­¥çš„ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯volatileåšä¸åˆ°synchronizedé‚£æ ·çš„åŸå­ä¿æŠ¤ï¼Œvolatileä»…åœ¨å¾ˆæœ‰é™çš„åœºæ™¯ä¸‹æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚</li>
  <li>volatileä¸é€‚ç”¨äºa++åœºæ™¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">jmm</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ä¸é€‚ç”¨äºvolatileçš„åœºæ™¯
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NoVolatile</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">a</span><span class="o">;</span>
  <span class="c1">//åŸå­å˜é‡ï¼Œè®°å½•æ­£ç¡®çš„ç»“æœ</span>
    <span class="nc">AtomicInteger</span> <span class="n">realA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span>  <span class="k">new</span> <span class="nc">NoVolatile</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(((</span><span class="nc">NoVolatile</span><span class="o">)</span> <span class="n">r</span><span class="o">).</span><span class="na">a</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(((</span><span class="nc">NoVolatile</span><span class="o">)</span> <span class="n">r</span><span class="o">).</span><span class="na">realA</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">a</span><span class="o">++;</span>
          <span class="c1">//å¢åŠ </span>
            <span class="n">realA</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>volatileé€‚ç”¨åœºåˆ1ï¼Œä¹Ÿæ˜¯ä¸synchronizedçš„å…³ç³»ï¼šboolean flagï¼Œå¦‚æœä¸€ä¸ªå…±äº«å˜é‡è‡ªå§‹è‡³ç»ˆ<strong>åªè¢«å„ä¸ªçº¿ç¨‹èµ‹å€¼</strong>ï¼Œè€Œæ²¡æœ‰å…¶ä»–çš„æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨volatileæ¥ä»£æ›¿synchronizedæˆ–è€…ä»£æ›¿åŸå­å˜é‡ï¼Œå› ä¸ºèµ‹å€¼è‡ªèº«æ˜¯æœ‰åŸå­æ€§çš„ï¼Œè€Œvolatileåˆä¿è¯äº†å¯è§æ€§ï¼Œæ‰€ä»¥å°±è¶³ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">jmm</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">singleton.Singleton8</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     volatileé€‚ç”¨çš„æƒ…å†µ1
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UseVolatile1</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
    <span class="nc">AtomicInteger</span> <span class="n">realA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span>  <span class="k">new</span> <span class="nc">UseVolatile1</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(((</span><span class="nc">UseVolatile1</span><span class="o">)</span> <span class="n">r</span><span class="o">).</span><span class="na">done</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(((</span><span class="nc">UseVolatile1</span><span class="o">)</span> <span class="n">r</span><span class="o">).</span><span class="na">realA</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">setDone</span><span class="o">();</span>
            <span class="n">realA</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setDone</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">//åªå¯¹å˜é‡è¿›è¡Œèµ‹å€¼ï¼Œä¸”ä¸ä¾èµ–äºä»¥å‰å˜é‡çš„å€¼æ˜¯ä»€ä¹ˆ</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>é€‚ç”¨åœºæ™¯2ï¼šä½œä¸ºåˆ·æ–°ä¹‹å‰å˜é‡çš„è§¦å‘å™¨</li>
</ul>

<p><img src="https://i.loli.net/2020/05/25/jaxME6lOQvpkBiP.png" alt="image.png" /></p>

<ul>
  <li>å…¶ä¸­initializedå°±å……å½“äº†è§¦å‘å™¨ï¼Œå½“å»è¯»å–initializedæ—¶ï¼Œå¯¹initializedèµ‹å€¼ä»¥ä¸Šçš„æ“ä½œéƒ½æ˜¯å¯¹å½“å‰çº¿ç¨‹æ˜¯å¯è§çš„ã€‚</li>
</ul>

<h5 id="ä¸¤ç‚¹ä½œç”¨">ä¸¤ç‚¹ä½œç”¨</h5>

<ul>
  <li>å¯è§æ€§ï¼šè¯»å–ä¸€ä¸ªvolatileå˜é‡ä¹‹å‰ï¼Œéœ€è¦å…ˆä½¿ç›¸åº”çš„æœ¬åœ°ç¼“å­˜å¤±æ•ˆï¼Œè¿™æ ·å°±å¿…é¡»åˆ°ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼ï¼Œå†™ä¸€ä¸ªvolatileå±æ€§ä¼šç«‹å³åˆ·å…¥åˆ°ä¸»å†…å­˜ã€‚</li>
  <li>ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼šè§£å†³å•ä¾‹åŒé‡é”ä¹±åºé—®é¢˜
    <ul>
      <li>OutOfOrderExecutionç±»å˜é‡åŠ äº†volatileåï¼Œå°±ä¸ä¼šå†å‡ºç°x=0ï¼Œy=0çš„æƒ…å†µäº†</li>
    </ul>
  </li>
</ul>

<h5 id="å°ç»“">å°ç»“</h5>

<ul>
  <li>volatileä¿®é¥°ç¬¦é€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼šæŸä¸ªå±æ€§è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æ­¤å±æ€§ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³å¾—åˆ°ä¿®æ”¹åçš„å€¼ï¼Œæ¯”å¦‚boolean flagï¼›æˆ–è€…ä½œä¸ºè§¦å‘å™¨ï¼Œå®ç°è½»é‡çº§åŒæ­¥ã€‚</li>
  <li>volatileå±æ€§çš„è¯»å†™æ“ä½œéƒ½æ˜¯æ— é”çš„ï¼Œå®ƒä¸èƒ½ä»£æ›¿synchronizedï¼Œå› ä¸ºå®ƒæ²¡æœ‰æä¾›åŸå­æ€§å’Œäº’æ–¥æ€§ã€‚å› ä¸ºæ— é”ï¼Œä¸éœ€è¦èŠ±è´¹æ—¶é—´åœ¨è·å–é”å’Œé‡Šæ”¾é”ä¸Šï¼Œæ‰€ä»¥è¯´å®ƒæ˜¯ä½æˆæœ¬çš„ã€‚</li>
  <li>volatileåªèƒ½ä½œç”¨äºå±æ€§ï¼Œæˆ‘ä»¬ç”¨volatileä¿®é¥°å±æ€§ï¼Œè¿™æ ·compolerså°±ä¸ä¼šå¯¹è¿™ä¸ªå±æ€§åšæŒ‡ä»¤é‡æ’åºã€‚</li>
  <li>volatileæä¾›äº†å¯è§æ€§ï¼Œä»»ä½•ä¸€ä¸ªçº¿ç¨‹å¯¹å…¶çš„ä¿®æ”¹å°†ç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚volatileå±æ€§ä¸ä¼šè¢«çº¿ç¨‹ç¼“å­˜ï¼Œå§‹ç»ˆä»ä¸»å­˜ä¸­è¯»å–ã€‚</li>
  <li>volatileæä¾›äº†happens-beforeä¿è¯ï¼Œå¯¹volatileå˜é‡vçš„å†™å…¥happens-beforeæ‰€æœ‰å…¶ä»–çº¿ç¨‹åç»­å¯¹vçš„è¯»æ“ä½œã€‚</li>
  <li>volatileå¯ä»¥ä½¿å¾—longå’Œdoubleçš„èµ‹å€¼æ˜¯åŸå­çš„ã€‚</li>
</ul>

<h4 id="synchronized">synchronized</h4>

<ul>
  <li>synchronizedä¸ä»…ä¿è¯äº†åŸå­æ€§ï¼Œè¿˜ä¿è¯äº†å¯è§æ€§ã€‚</li>
  <li>synchronizedä¸ä»…è®©è¢«ä¿æŠ¤çš„ä»£ç å®‰å…¨ï¼Œè¿˜è¿‘æœ±è€…èµ¤</li>
</ul>

<p><img src="https://i.loli.net/2020/05/25/TPqWdI8yOMKA6gL.png" alt="image.png" /></p>

<h4 id="åŸå­æ€§">åŸå­æ€§</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯åŸå­æ€§ï¼šä¸€ç³»åˆ—çš„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°æ‰§è¡Œä¸€åŠçš„æƒ…å†µï¼Œæ˜¯ä¸å¯åˆ†å‰²çš„ã€‚å…¸å‹æ¡ˆä¾‹ä¸ºATMå–æ¬¾ã€‚</li>
  <li>i++ä¸æ˜¯åŸå­æ€§çš„ï¼Œå¯ä»¥ä½¿ç”¨synchronizedå®ç°åŸå­æ€§</li>
  <li>Javaä¸­çš„åŸå­æ“ä½œæœ‰å“ªäº›ï¼š
    <ul>
      <li>é™¤äº†longå’Œdoubleä¹‹å¤–çš„åŸºæœ¬ç±»å‹ï¼ˆint ,byte,boolean,short,char,floatï¼‰çš„èµ‹å€¼æ“ä½œï¼›</li>
      <li>æ‰€æœ‰å¼•ç”¨referenceçš„èµ‹å€¼æ“ä½œï¼Œä¸ç®¡æ˜¯32ä½çš„æœºå™¨è¿˜æ˜¯64ä½çš„æœºå™¨</li>
      <li>java.concurrent.Atomic.*åŒ…ä¸­æ‰€æœ‰çš„åŸå­æ“ä½œ</li>
    </ul>
  </li>
</ul>

<h5 id="longå’Œdouble">longå’Œdouble</h5>

<p><img src="https://i.loli.net/2020/05/25/cZTvBk1D8mzsR7N.png" alt="image.png" /></p>

<ul>
  <li>åœ¨32ä½ä¸Šçš„JVMä¸Šï¼Œlongå’Œdoubleçš„æ“ä½œä¸æ˜¯åŸå­çš„ï¼Œä½†æ˜¯åœ¨64ä½çš„JVMä¸Šæ˜¯åŸå­çš„ã€‚åœ¨å®é™…å¼€å‘å•†ç”¨Javaè™šæ‹Ÿæœºä¸­æ˜¯ä¸ä¼šå‡ºç°çš„ã€‚</li>
  <li>åŸå­æ“ä½œ+åŸå­æ“ä½œï¼=åŸå­æ“ä½œ</li>
  <li>å…¨åŒæ­¥çš„HashMapä¹Ÿä¸å®Œå…¨å®‰å…¨</li>
</ul>

<h3 id="å•ä¾‹æ¨¡å¼çš„8ç§å†™æ³•">å•ä¾‹æ¨¡å¼çš„8ç§å†™æ³•</h3>

<h4 id="é¥¿æ±‰å¼">é¥¿æ±‰å¼</h4>

<ul>
  <li>ç®€å•ï¼Œä½†æ˜¯æ²¡æœ‰æ‡’åŠ è½½ï¼Œä¼šé€ æˆèµ„æºçš„æµªè´¹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     é¥¿æ±‰å¼ï¼ˆé™æ€å¸¸é‡ï¼‰ï¼ˆå¯ç”¨ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton1</span> <span class="o">{</span>
	<span class="c1">//ç±»åœ¨åŠ è½½çš„æ—¶å€™å°±å®ä¾‹åŒ–ï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Singleton1</span> <span class="no">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton1</span><span class="o">();</span>

    <span class="kd">private</span> <span class="nf">Singleton1</span><span class="o">()</span> <span class="o">{</span>
		<span class="c1">//åˆå§‹åŒ–æ“ä½œ</span>
    <span class="o">}</span>
    <span class="c1">//å‘å¸ƒåˆ°å¤–éƒ¨æä¾›è®¿é—®</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton1</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     é¥¿æ±‰å¼ï¼ˆé™æ€ä»£ç å—ï¼‰ï¼ˆå¯ç”¨ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton2</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Singleton2</span> <span class="no">INSTANCE</span><span class="o">;</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="no">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton2</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="nf">Singleton2</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton2</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ‡’æ±‰å¼">æ‡’æ±‰å¼</h4>

<ul>
  <li>æœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton3</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Singleton3</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Singleton3</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton3</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="c1">//å¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶é€šè¿‡äº†ifæ¡ä»¶å°±ä¼šåˆ›å»ºå¤šä¸ªå®ä¾‹ï¼Œæ‰€ä»¥çº¿ç¨‹ä¸å®‰å…¨</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton3</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰ï¼ˆä¸æ¨èï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton4</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Singleton4</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Singleton4</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
	<span class="c1">//åŠ synchronizedå…³é”®å­—è™½ç„¶çº¿ç¨‹å®‰å…¨äº†ï¼Œä½†æ˜¯æ•ˆç‡å˜ä½äº†</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kd">static</span> <span class="nc">Singleton4</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton4</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ‡’æ±‰å¼ï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰ï¼ˆä¸æ¨èï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton5</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Singleton5</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Singleton5</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton5</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="c1">//åªè¦å¤šä¸ªçº¿ç¨‹åŒæ—¶è¿›å…¥äº†ifä»£ç å—ï¼Œå°±ä¸èƒ½é˜»æ­¢ä»–ä»¬åˆ›å»ºå®ä¾‹äº†ï¼Œåªä¸è¿‡æ˜¯è°å…ˆè°åçš„é—®é¢˜</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">Singleton5</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton5</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="åŒé‡æ£€æŸ¥">åŒé‡æ£€æŸ¥*</h4>

<ul>
  <li>ä¼˜ç‚¹ï¼šçº¿ç¨‹å®‰å…¨ï¼›å»¶è¿ŸåŠ è½½ï¼›æ•ˆç‡è¾ƒé«˜ã€‚</li>
  <li>ä¸ºä»€ä¹ˆè¦åŒé‡æ£€æŸ¥ï¼Ÿå› ä¸ºè¦ä¿è¯çº¿ç¨‹å®‰å…¨</li>
  <li>ä½¿ç”¨å•é‡æ£€æŸ¥è¡Œä¸è¡Œï¼Ÿè¡Œï¼Œä½†æ˜¯å½“çº¿ç¨‹æ¯”è¾ƒå¤šæ—¶æ€§èƒ½ä¸å¦‚åŒé‡æ£€æŸ¥</li>
  <li>ä¸ºä»€ä¹ˆè¦ç”¨volatileï¼Ÿ
    <ul>
      <li>é‡æ’åºä¼šå¸¦æ¥NPEï¼šæ–°å»ºå¯¹è±¡å®é™…ä¸Šæœ‰ä¸‰ä¸ªæ­¥éª¤ï¼Œå¦‚æœä¸åŠ volatileå½“åˆ›å»ºå¯¹è±¡å®ä¾‹çš„æ—¶å€™å¯èƒ½æ„é€ å‡½æ•°è¿˜æ²¡æœ‰æ‰§è¡Œå®Œç¬¬äºŒä¸ªçº¿ç¨‹å°±å»åˆ¤æ–­å¼•ç”¨æ˜¯å¦ä¸ºç©ºäº†ï¼Œè¿™æ—¶æ˜¾ç„¶ä¸æ˜¯ç©ºçš„ï¼Œä½†æ˜¯å¯¹è±¡é‡Œçš„å±æ€§å´æ˜¯ç©ºçš„ï¼Œå¦‚æœä½¿ç”¨è¿™ä¸ªå¼•ç”¨å°±ä¼šå‘é€NPE</li>
      <li>é˜²æ­¢é‡æ’åº</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     åŒé‡æ£€æŸ¥ï¼ˆæ¨èé¢è¯•ä½¿ç”¨ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton6</span> <span class="o">{</span>

  <span class="c1">//åŠ volatileé˜²æ­¢é‡æ’åºï¼Œä¿è¯å¯è§æ€§</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kd">static</span> <span class="nc">Singleton6</span> <span class="n">instance</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">Singleton6</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
	<span class="c1">//ä½¿ç”¨åŒé‡é”</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton6</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">Singleton6</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton6</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="é™æ€å†…éƒ¨ç±»">é™æ€å†…éƒ¨ç±»</h4>

<ul>
  <li>å¯ç”¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     é™æ€å†…éƒ¨ç±»æ–¹å¼ï¼Œå¯ç”¨
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Singleton7</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nf">Singleton7</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">SingletonInstance</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Singleton7</span> <span class="no">INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Singleton7</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Singleton7</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">SingletonInstance</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æšä¸¾æ¨¡å¼">æšä¸¾æ¨¡å¼*</h4>

<ul>
  <li>æœ€å¥½</li>
  <li>å†™æ³•ç®€å•</li>
  <li>çº¿ç¨‹å®‰å…¨æœ‰ä¿éšœ</li>
  <li>é¿å…ååºåˆ—åŒ–ç ´åå•ä¾‹ï¼Œé˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">singleton</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æšä¸¾å•ä¾‹
 */</span>
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">Singleton8</span> <span class="o">{</span>
    <span class="no">INSTANCE</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">whatever</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//å¤–éƒ¨è°ƒç”¨ï¼šSingleton8.INSTANCE.whatever();</span>
</code></pre></div></div>

<h3 id="æ­»é”-1">æ­»é”</h3>

<ul>
  <li>ä»€ä¹ˆæ˜¯æ­»é”ï¼šå‘ç”Ÿåœ¨å¹¶å‘ä¸­ï¼Œå½“ä¸¤ä¸ªæˆ–æ›´å¤šçº¿ç¨‹æˆ–è¿›ç¨‹ç›¸äº’æŒæœ‰å¯¹æ–¹æ‰€éœ€è¦çš„èµ„æºï¼Œåˆä¸ä¸»åŠ¨é‡Šæ”¾ï¼Œå¯¼è‡´æ‰€æœ‰äººéƒ½æ— æ³•ç»§ç»­å‰è¿›ï¼Œå¯¼è‡´ç¨‹åºé™·å…¥æ— å°½çš„é˜»å¡ï¼Œè¿™å°±æ˜¯æ­»é”ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/05/25/P6xlq7WydrEZI8o.png" alt="image.png" /></p>

<ul>
  <li>å¦‚æœå¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯ç¯å½¢ï¼Œå­˜åœ¨ç¯è·¯çš„é”çš„ä¾èµ–å…³ç³»ï¼Œé‚£ä¹ˆä¹Ÿå¯èƒ½ä¼šå‘ç”Ÿæ­»é”ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/05/25/1WutkxbP6C7Yv52.png" alt="image.png" /></p>

<ul>
  <li>æ­»é”çš„å½±å“ï¼š
    <ul>
      <li>æ­»é”çš„å½±å“åœ¨ä¸åŒç³»ç»Ÿä¸­æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™å–å†³äºç³»ç»Ÿå¯¹æ­»é”çš„å¤„ç†èƒ½åŠ›</li>
      <li>åœ¨æ•°æ®åº“ä¸­ï¼šæ£€æµ‹å¹¶æ”¾å¼ƒäº‹åŠ¡</li>
      <li>JVMä¸­ï¼šæ— æ³•è‡ªåŠ¨å¤„ç†</li>
    </ul>
  </li>
  <li>å¿…ç„¶å‘ç”Ÿæ­»é”çš„æƒ…å†µ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     å¿…å®šå‘ç”Ÿæ­»é”çš„æƒ…å†µ
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MustDeadLock</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MustDeadLock</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MustDeadLock</span><span class="o">();</span>
        <span class="nc">MustDeadLock</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MustDeadLock</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"flag = "</span> <span class="o">+</span> <span class="n">flag</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1æˆåŠŸæ‹¿åˆ°ä¸¤æŠŠé”"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2æˆåŠŸæ‹¿åˆ°ä¸¤æŠŠé”"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¨¡æ‹Ÿå¤šäººè½¬è´¦å‘ç”Ÿæ­»é”é—®é¢˜</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     è½¬è´¦æ—¶å€™é‡åˆ°æ­»é”ï¼Œä¸€æ—¦æ‰“å¼€æ³¨é‡Šï¼Œä¾¿ä¼šå‘ç”Ÿæ­»é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferMoney</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Account</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
    <span class="kd">static</span> <span class="nc">Account</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">TransferMoney</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransferMoney</span><span class="o">();</span>
        <span class="nc">TransferMoney</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransferMoney</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"açš„ä½™é¢"</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">balance</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"bçš„ä½™é¢"</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">balance</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transferMoney</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transferMoney</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">transferMoney</span><span class="o">(</span><span class="nc">Account</span> <span class="n">from</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">to</span><span class="o">,</span> <span class="kt">int</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">{</span>
          <span class="cm">/*try {
            Thread.sleep(500);
          } catch (InterruptedException e) {
            e.printStackTrace();
          }*/</span>
          <span class="kd">synchronized</span> <span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">balance</span> <span class="o">-</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä½™é¢ä¸è¶³ï¼Œè½¬è´¦å¤±è´¥ã€‚"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">from</span><span class="o">.</span><span class="na">balance</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
            <span class="n">to</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="na">balance</span> <span class="o">+</span> <span class="n">amount</span><span class="o">;</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆåŠŸè½¬è´¦"</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">+</span> <span class="s">"å…ƒ"</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="nf">Account</span><span class="o">(</span><span class="kt">int</span> <span class="n">balance</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">balance</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">balance</span><span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">deadlock.TransferMoney.Account</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     å¤šäººåŒæ—¶è½¬è´¦ï¼Œä¾ç„¶å¾ˆå±é™©
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MultiTransferMoney</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NUM_ACCOUNTS</span> <span class="o">=</span> <span class="mi">500</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NUM_MONEY</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NUM_ITERATIONS</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NUM_THREADS</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Random</span> <span class="n">rnd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
        <span class="nc">Account</span><span class="o">[]</span> <span class="n">accounts</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">[</span><span class="no">NUM_ACCOUNTS</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">accounts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">accounts</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">(</span><span class="no">NUM_MONEY</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">class</span> <span class="nc">TransferThread</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>

            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">NUM_ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">fromAcct</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="no">NUM_ACCOUNTS</span><span class="o">);</span>
                    <span class="kt">int</span> <span class="n">toAcct</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="no">NUM_ACCOUNTS</span><span class="o">);</span>
                    <span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="no">NUM_MONEY</span><span class="o">);</span>
                    <span class="nc">TransferMoney</span><span class="o">.</span><span class="na">transferMoney</span><span class="o">(</span><span class="n">accounts</span><span class="o">[</span><span class="n">fromAcct</span><span class="o">],</span> <span class="n">accounts</span><span class="o">[</span><span class="n">toAcct</span><span class="o">],</span> <span class="n">amount</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿è¡Œç»“æŸ"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="no">NUM_THREADS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">TransferThread</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ­»é”å‘ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶
    <ul>
      <li>äº’æ–¥æ¡ä»¶</li>
      <li>è¯·æ±‚ä¸ä¿æŒæ¡ä»¶</li>
      <li>ä¸å¯å‰¥å¤ºæ¡ä»¶</li>
      <li>å¾ªç¯ç­‰å¾…æ¡ä»¶</li>
    </ul>
  </li>
</ul>

<h4 id="å®šä½æ­»é”">å®šä½æ­»é”</h4>

<ul>
  <li>ä½¿ç”¨Javaçš„jstackå‘½ä»¤è¡Œå·¥å…·</li>
  <li>ä½¿ç”¨ThreadMXBean</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.management.ManagementFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.ThreadInfo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.management.ThreadMXBean</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç”¨ThreadMXBeanæ£€æµ‹æ­»é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadMXBeanDetection</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>

    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">o2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ThreadMXBeanDetection</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadMXBeanDetection</span><span class="o">();</span>
        <span class="nc">ThreadMXBeanDetection</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadMXBeanDetection</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
      <span class="c1">//å®šä½æ­»é”</span>
        <span class="nc">ThreadMXBean</span> <span class="n">threadMXBean</span> <span class="o">=</span> <span class="nc">ManagementFactory</span><span class="o">.</span><span class="na">getThreadMXBean</span><span class="o">();</span>
        <span class="kt">long</span><span class="o">[]</span> <span class="n">deadlockedThreads</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">findDeadlockedThreads</span><span class="o">();</span>
      <span class="c1">//å¦‚æœå‘ç”Ÿäº†æ­»é”</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">deadlockedThreads</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">deadlockedThreads</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">deadlockedThreads</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">ThreadInfo</span> <span class="n">threadInfo</span> <span class="o">=</span> <span class="n">threadMXBean</span><span class="o">.</span><span class="na">getThreadInfo</span><span class="o">(</span><span class="n">deadlockedThreads</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘ç°æ­»é”"</span> <span class="o">+</span> <span class="n">threadInfo</span><span class="o">.</span><span class="na">getThreadName</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"flag = "</span> <span class="o">+</span> <span class="n">flag</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1æˆåŠŸæ‹¿åˆ°ä¸¤æŠŠé”"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2æˆåŠŸæ‹¿åˆ°ä¸¤æŠŠé”"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ä¿®å¤æ­»é”">ä¿®å¤æ­»é”</h4>

<ul>
  <li>
    <p>çº¿ä¸Šå‘ç”Ÿæ­»é”åº”è¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</p>

    <ul>
      <li>ä¿å­˜æ¡ˆå‘ç°åœºç„¶åç«‹å³é‡å¯æœåŠ¡å™¨</li>
      <li>æš‚æ—¶ä¿è¯çº¿ä¸ŠæœåŠ¡çš„å®‰å…¨ï¼Œç„¶åå†åˆ©ç”¨åˆšæ‰ä¿å­˜çš„ä¿¡æ¯ï¼Œæ’æŸ¥æ­»é”ï¼Œä¿®æ”¹ä»£ç ï¼Œé‡æ–°å‘å¸ƒ</li>
    </ul>
  </li>
  <li>
    <p>å¸¸è§ä¿®å¤ç­–ç•¥</p>

    <ul>
      <li>é¿å…ç­–ç•¥ï¼šå“²å­¦å®¶å°±é¤çš„æ¢æ‰‹æ–¹æ¡ˆï¼Œè½¬è´¦æ¢åºæ–¹æ¡ˆã€‚</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     è½¬è´¦æ—¶å€™é‡åˆ°æ­»é”ï¼Œä¸€æ—¦æ‰“å¼€æ³¨é‡Šï¼Œä¾¿ä¼šå‘ç”Ÿæ­»é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransferMoney</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Account</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
    <span class="kd">static</span> <span class="nc">Account</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Account</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
    <span class="kd">static</span> <span class="nc">Object</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">TransferMoney</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransferMoney</span><span class="o">();</span>
        <span class="nc">TransferMoney</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TransferMoney</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"açš„ä½™é¢"</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">balance</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"bçš„ä½™é¢"</span> <span class="o">+</span> <span class="n">b</span><span class="o">.</span><span class="na">balance</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transferMoney</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">transferMoney</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">transferMoney</span><span class="o">(</span><span class="nc">Account</span> <span class="n">from</span><span class="o">,</span> <span class="nc">Account</span> <span class="n">to</span><span class="o">,</span> <span class="kt">int</span> <span class="n">amount</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">class</span> <span class="nc">Helper</span> <span class="o">{</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">transfer</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">from</span><span class="o">.</span><span class="na">balance</span> <span class="o">-</span> <span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä½™é¢ä¸è¶³ï¼Œè½¬è´¦å¤±è´¥ã€‚"</span><span class="o">);</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">from</span><span class="o">.</span><span class="na">balance</span> <span class="o">-=</span> <span class="n">amount</span><span class="o">;</span>
                <span class="n">to</span><span class="o">.</span><span class="na">balance</span> <span class="o">=</span> <span class="n">to</span><span class="o">.</span><span class="na">balance</span> <span class="o">+</span> <span class="n">amount</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆåŠŸè½¬è´¦"</span> <span class="o">+</span> <span class="n">amount</span> <span class="o">+</span> <span class="s">"å…ƒ"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//è®¡ç®—å“ˆå¸Œå€¼ï¼ŒæŒ‰ç…§å“ˆå¸Œå€¼çš„å¤§å°æ¥è·å–é”</span>
        <span class="c1">//å®é™…å¼€å‘ä¸­ä½¿ç”¨ä¸»é”®æ›´åŠ æ–¹ä¾¿ï¼Œå› ä¸ºä¸»é”®æ˜¯è‡ªå¢çš„ä¸é‡å¤çš„</span>
        <span class="kt">int</span> <span class="n">fromHash</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">from</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">toHash</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">identityHashCode</span><span class="o">(</span><span class="n">to</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">fromHash</span> <span class="o">&lt;</span> <span class="n">toHash</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">new</span> <span class="nf">Helper</span><span class="o">().</span><span class="na">transfer</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">fromHash</span> <span class="o">&gt;</span> <span class="n">toHash</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">new</span> <span class="nf">Helper</span><span class="o">().</span><span class="na">transfer</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span>  <span class="o">{</span>
          <span class="c1">//é¿å…å‡ºç°å“ˆå¸Œå†²çªæ—¶å‘ç”Ÿæ­»é”</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">to</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">from</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">new</span> <span class="nf">Helper</span><span class="o">().</span><span class="na">transfer</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div>    </div>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static class Account {

    public Account(int balance) {
        this.balance = balance;
    }

    int balance;

} }
</code></pre></div>    </div>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
```java
package deadlock;


/**
 * æè¿°ï¼š     æ¼”ç¤ºå“²å­¦å®¶å°±é¤é—®é¢˜å¯¼è‡´çš„æ­»é”(ä¸€ä¸ªåœ†æ¡Œï¼Œäº”ä¸ªäººï¼Œäº”æ ¹ç­·å­)
 */
public class DiningPhilosophers {

    public static class Philosopher implements Runnable {

        //å·¦ç­·å­å’Œå³ç­·å­
        private Object leftChopstick;
        private Object rightChopstick;

        public Philosopher(Object leftChopstick, Object rightChopstick) {
            this.leftChopstick = leftChopstick;
            this.rightChopstick = rightChopstick;
        }

          

        @Override
        public void run() {
            try {
                while (true) {
                  //å…ˆæ€è€ƒ
                    doAction("Thinking");
                  //è·å–å·¦ç­·å­
                    synchronized (leftChopstick) {
                        doAction("Picked up left chopstick");
                      //è·å–å³ç­·å­
                        synchronized (rightChopstick) {
                            doAction("Picked up right chopstick - eating");
                          //åƒå®Œåæ”¾ä¸‹å³ç­·å­
                            doAction("Put down right chopstick");
                        }
                      //æ”¾ä¸‹å·¦ç­·å­
                        doAction("Put down left chopstick");
                    }
                }
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
        }

        private void doAction(String action) throws InterruptedException {
            System.out.println(Thread.currentThread().getName() + " " + action);
            Thread.sleep((long) (Math.random() * 10));
        }
    }

    public static void main(String[] args) {
      //æ–°å»ºäº”ä¸ªå“²å­¦å®¶
        Philosopher[] philosophers = new Philosopher[5];
      //æ–°å»ºç­·å­ï¼Œç­‰äºå“²å­¦å®¶äººæ•°
        Object[] chopsticks = new Object[philosophers.length];
        for (int i = 0; i &lt; chopsticks.length; i++) {
            chopsticks[i] = new Object();
        }
        for (int i = 0; i &lt; philosophers.length; i++) {
            Object leftChopstick = chopsticks[i];
            Object rightChopstick = chopsticks[(i + 1) % chopsticks.length];
          //é¿å…ç­–ç•¥ï¼Œæ”¹å˜è·å–ç­·å­çš„é¡ºåº
            if (i == philosophers.length - 1) {
                philosophers[i] = new Philosopher(rightChopstick, leftChopstick);
            } else {
                philosophers[i] = new Philosopher(leftChopstick, rightChopstick);
            }
            new Thread(philosophers[i], "å“²å­¦å®¶" + (i + 1) + "å·").start();
        }
    }
}

</code></pre></div>    </div>

    <p>â€‹</p>

    <ul>
      <li>æ£€æµ‹ä¸æ¢å¤ç­–ç•¥ï¼šä¸€æ®µæ—¶é—´æ£€æµ‹æ˜¯å¦æœ‰æ­»é”ï¼Œå¦‚æœæœ‰å°±å‰¥å¤ºæŸä¸€ä¸ªèµ„æºï¼Œæ¥æ‰“å¼€æ­»é”</li>
      <li>é¸µé¸Ÿç­–ç•¥ï¼šå¦‚æœæˆ‘ä»¬å‘ç”Ÿæ­»é”çš„æ¦‚ç‡æå…¶ä½ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ç›´æ¥å¿½ç•¥ä»–ï¼Œç›´åˆ°æ­»é”å‘ç”Ÿçš„æ—¶å€™ï¼Œå†äººå·¥ä¿®å¤</li>
    </ul>
  </li>
</ul>

<h4 id="é¿å…æ­»é”">é¿å…æ­»é”</h4>

<ul>
  <li>è®¾ç½®è¶…æ—¶æ—¶é—´</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     ç”¨tryLockæ¥é¿å…æ­»é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TryLockDeadlock</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TryLockDeadlock</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TryLockDeadlock</span><span class="o">();</span>
        <span class="nc">TryLockDeadlock</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TryLockDeadlock</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r2</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lock1</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–åˆ°äº†é”1"</span><span class="o">);</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">lock2</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–åˆ°äº†é”2"</span><span class="o">);</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1æˆåŠŸè·å–åˆ°äº†ä¸¤æŠŠé”"</span><span class="o">);</span>
                            <span class="n">lock2</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="n">lock1</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1å°è¯•è·å–é”2å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                            <span class="n">lock1</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–é”1å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lock2</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">3000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–åˆ°äº†é”2"</span><span class="o">);</span>

                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">lock1</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">3000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–åˆ°äº†é”1"</span><span class="o">);</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2æˆåŠŸè·å–åˆ°äº†ä¸¤æŠŠé”"</span><span class="o">);</span>
                            <span class="n">lock1</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="n">lock2</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2å°è¯•è·å–é”1å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                            <span class="n">lock2</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–é”2å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>å¤šä½¿ç”¨å¹¶å‘ç±»ï¼Œè€Œä¸æ˜¯è‡ªå·±è®¾è®¡é”</li>
  <li>å°½é‡é™ä½é”çš„ä½¿ç”¨ç²’åº¦ï¼šç”¨ä¸åŒçš„é”è€Œä¸æ˜¯ä¸€ä¸ªé”</li>
  <li>å¦‚æœèƒ½ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼Œå°±ä¸ä½¿ç”¨åŒæ­¥æ–¹æ³•ï¼šè‡ªå·±æŒ‡å®šé”å¯¹è±¡</li>
  <li>ç»™ä½ çš„çº¿ç¨‹èµ·ä¸€ä¸ªæœ‰æ„ä¹‰çš„åå­—ï¼šdebugå’Œæ’æŸ¥æ—¶äº‹åŠåŠŸå€ï¼Œæ¡†æ¶å’ŒJDKéƒ½éµå¾ªè¿™ä¸ªæœ€ä½³å®è·µ</li>
  <li>é¿å…é”çš„åµŒå¥—ï¼šä¾‹å¦‚MustDeadLockç±»</li>
  <li>åˆ†é…èµ„æºå‰å…ˆçœ‹èƒ½ä¸èƒ½æ”¶å›æ¥</li>
  <li>å°½é‡ä¸è¦å‡ ä¸ªåŠŸèƒ½ç”¨åŒä¸€æŠŠé”ï¼šä¸“é”ä¸“ç”¨</li>
</ul>

<h4 id="æ´»æ€§æ•…éšœ">æ´»æ€§æ•…éšœ</h4>

<h5 id="æ´»é”">æ´»é”</h5>

<ul>
  <li>è™½ç„¶çº¿ç¨‹å¹¶æ²¡æœ‰é˜»å¡ï¼Œä¹Ÿå§‹ç»ˆåœ¨è¿è¡Œï¼ˆæ‰€ä»¥å«åšâ€œæ´»â€é”ï¼Œçº¿ç¨‹æ˜¯â€œæ´»â€çš„ï¼‰ï¼Œä½†æ˜¯ç¨‹åºå´å¾—ä¸åˆ°è¿›å±•ï¼Œå› ä¸ºçº¿ç¨‹å§‹ç»ˆé‡å¤åšåŒæ ·çš„äº‹ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">deadlock</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">jdk.management.resource.internal.inst.RandomAccessFileRMHooks</span><span class="o">;</span>

<span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºæ´»é”é—®é¢˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LiveLock</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Spoon</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">Diner</span> <span class="n">owner</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Spoon</span><span class="o">(</span><span class="nc">Diner</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">Diner</span> <span class="nf">getOwner</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">owner</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOwner</span><span class="o">(</span><span class="nc">Diner</span> <span class="n">owner</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="n">owner</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">use</span><span class="o">()</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"%såƒå®Œäº†!"</span><span class="o">,</span> <span class="n">owner</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>


        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Diner</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">isHungry</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Diner</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
            <span class="n">isHungry</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">eatWith</span><span class="o">(</span><span class="nc">Spoon</span> <span class="n">spoon</span><span class="o">,</span> <span class="nc">Diner</span> <span class="n">spouse</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">isHungry</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">spoon</span><span class="o">.</span><span class="na">owner</span> <span class="o">!=</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
              <span class="c1">//è§£å†³æ´»é”</span>
                <span class="nc">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Random</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">spouse</span><span class="o">.</span><span class="na">isHungry</span> <span class="o">&amp;&amp;</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">": äº²çˆ±çš„"</span> <span class="o">+</span> <span class="n">spouse</span><span class="o">.</span><span class="na">name</span> <span class="o">+</span> <span class="s">"ä½ å…ˆåƒå§"</span><span class="o">);</span>
                    <span class="n">spoon</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="n">spouse</span><span class="o">);</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>

                <span class="n">spoon</span><span class="o">.</span><span class="na">use</span><span class="o">();</span>
                <span class="n">isHungry</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">": æˆ‘åƒå®Œäº†"</span><span class="o">);</span>
                <span class="n">spoon</span><span class="o">.</span><span class="na">setOwner</span><span class="o">(</span><span class="n">spouse</span><span class="o">);</span>

            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Diner</span> <span class="n">husband</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Diner</span><span class="o">(</span><span class="s">"ç‰›éƒ"</span><span class="o">);</span>
        <span class="nc">Diner</span> <span class="n">wife</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Diner</span><span class="o">(</span><span class="s">"ç»‡å¥³"</span><span class="o">);</span>

        <span class="nc">Spoon</span> <span class="n">spoon</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Spoon</span><span class="o">(</span><span class="n">husband</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">husband</span><span class="o">.</span><span class="na">eatWith</span><span class="o">(</span><span class="n">spoon</span><span class="o">,</span> <span class="n">wife</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">wife</span><span class="o">.</span><span class="na">eatWith</span><span class="o">(</span><span class="n">spoon</span><span class="o">,</span> <span class="n">husband</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h5 id="é¥¥é¥¿">é¥¥é¥¿</h5>

<ul>
  <li>å½“çº¿ç¨‹éœ€è¦æŸäº›èµ„æºï¼ˆä¾‹å¦‚CPUï¼‰ï¼Œä½†æ˜¯å´å§‹ç»ˆå¾—ä¸åˆ°</li>
  <li>çº¿ç¨‹çš„ä¼˜å…ˆçº§è®¾ç½®çš„è¿‡äºä½ï¼Œæˆ–è€…æœ‰æŸçº¿ç¨‹æŒæœ‰é”åŒæ—¶åˆæ— é™å¾ªç¯è€Œä¸é‡Šæ”¾é”ï¼Œæˆ–è€…æŸç¨‹åºå§‹ç»ˆå ç”¨æŸæ–‡ä»¶çš„å†™é”ã€‚</li>
  <li>é¥¥é¥¿å¯èƒ½ä¼šå¯¼è‡´å“åº”æ€§èƒ½å˜å·®</li>
</ul>

<h3 id="è„‘å›¾">è„‘å›¾</h3>

<p><a href="http://naotu.baidu.com/file/07f437ff6bc3fa7939e171b00f133e17?token=6744a1c6ca6860a0">çº¿ç¨‹æ ¸å¿ƒåŸºç¡€</a></p>

<p><a href="http://naotu.baidu.com/file/60a0bdcaca7c6b92fcc5f796fe6f6bc9?token=bcdbae34bb3b0533">å†…å­˜æ¨¡å‹</a></p>

<p><a href="http://naotu.baidu.com/file/ec7748c253f4fc9d88ac1cc1e47814f3?token=bb71b5895a747d67">æ­»é”</a></p>

<p><a href="http://naotu.baidu.com/file/29942292cd032adfae23c09783676004?token=130df3d389cab703">ä½“ç³»</a></p>

<p><a href="http://naotu.baidu.com/file/3902a010470d7c1cf76fe719be124797?token=bec25304cc071bf1">å¹¶å‘å·¥å…·ç±»</a></p>

<h3 id="é¿å‘å¿…çœ‹">é¿å‘å¿…çœ‹</h3>

<h4 id="1æ¸…æ¥šé”å’Œä¿æŠ¤å¯¹è±¡çš„å±‚é¢">1æ¸…æ¥šé”å’Œä¿æŠ¤å¯¹è±¡çš„å±‚é¢</h4>

<ul>
  <li>
    <p>é™æ€å­—æ®µå±äºç±»ï¼Œç±»çº§åˆ«çš„é”æ‰èƒ½ä¿æŠ¤ï¼›è€Œéé™æ€å­—æ®µå±äºç±»å®ä¾‹ï¼Œå®ä¾‹çº§åˆ«çš„é”å°±å¯ä»¥ä¿æŠ¤ã€‚</p>
  </li>
  <li>
    <p>åœ¨ç±» Data ä¸­å®šä¹‰äº†ä¸€ä¸ªé™æ€çš„ int å­—æ®µ counter å’Œä¸€ä¸ªéé™æ€çš„ wrong æ–¹æ³•ï¼Œå®ç° counter å­—æ®µçš„ç´¯åŠ æ“ä½œã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Data</span> <span class="o">{</span>
  <span class="nd">@Getter</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">reset</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="k">return</span> <span class="n">counter</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">wrong</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">counter</span><span class="o">++;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"lockscope"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockScopeController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"count"</span><span class="o">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">"1000000"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Data</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">count</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Data</span><span class="o">().</span><span class="na">wrong</span><span class="o">());</span>
        <span class="k">return</span> <span class="nc">Data</span><span class="o">.</span><span class="na">getCounter</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">right</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"count"</span><span class="o">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">"1000000"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Data</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">count</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">Data</span><span class="o">().</span><span class="na">right</span><span class="o">());</span>
        <span class="k">return</span> <span class="nc">Data</span><span class="o">.</span><span class="na">getCounter</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>å› ä¸ºé»˜è®¤è¿è¡Œ 100 ä¸‡æ¬¡ï¼Œæ‰€ä»¥æ‰§è¡Œååº”è¯¥è¾“å‡º 100 ä¸‡ï¼Œä½†é¡µé¢è¾“å‡ºçš„æ˜¯ 639242ã€‚åœ¨éé™æ€çš„ wrong æ–¹æ³•ä¸ŠåŠ é”ï¼Œåªèƒ½ç¡®ä¿å¤šä¸ªçº¿ç¨‹æ— æ³•æ‰§è¡ŒåŒä¸€ä¸ªå®ä¾‹çš„ wrong æ–¹æ³•ï¼Œå´ä¸èƒ½ä¿è¯ä¸ä¼šæ‰§è¡Œä¸åŒå®ä¾‹çš„ wrong æ–¹æ³•ã€‚è€Œé™æ€çš„ counter åœ¨å¤šä¸ªå®ä¾‹ä¸­å…±äº«ï¼Œæ‰€ä»¥å¿…ç„¶ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p>
  </li>
  <li>
    <p>ä¿®æ­£æ–¹æ³•å°±å¾ˆæ¸…æ™°äº†ï¼šåŒæ ·åœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ª Object ç±»å‹çš„é™æ€å­—æ®µï¼Œåœ¨æ“ä½œcounter ä¹‹å‰å¯¹è¿™ä¸ªå­—æ®µåŠ é”ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Data</span> <span class="o">{</span>
  <span class="nd">@Getter</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="n">locker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">right</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">locker</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">counter</span><span class="o">++;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>æŠŠ wrong æ–¹æ³•å®šä¹‰ä¸ºé™æ€ä¸å°±å¯ä»¥äº†ï¼Œè¿™ä¸ªæ—¶å€™é”æ˜¯ç±»çº§åˆ«çš„ã€‚å¯ä»¥æ˜¯å¯ä»¥ï¼Œä½†æˆ‘ä»¬ä¸å¯èƒ½ä¸ºäº†è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜æ”¹å˜ä»£ç ç»“æ„ï¼ŒæŠŠå®ä¾‹æ–¹æ³•æ”¹ä¸ºé™æ€æ–¹æ³•ã€‚</li>
</ul>

<h4 id="2åŠ é”è¦è€ƒè™‘é”çš„åœºæ™¯å’Œç²’åº¦">2åŠ é”è¦è€ƒè™‘é”çš„åœºæ™¯å’Œç²’åº¦</h4>

<ul>
  <li>
    <p>åœ¨æ–¹æ³•ä¸ŠåŠ  synchronized å…³é”®å­—å®ç°åŠ é”ç¡®å®ç®€å•ï¼Œä¹Ÿå› æ­¤æˆ‘æ›¾çœ‹åˆ°ä¸€äº›ä¸šåŠ¡ä»£ç ä¸­å‡ ä¹æ‰€æœ‰æ–¹æ³•éƒ½åŠ äº† synchronizedï¼Œä½†è¿™ç§æ»¥ç”¨ synchronized çš„åšæ³•ï¼š</p>

    <ul>
      <li>ä¸€æ˜¯ï¼Œæ²¡å¿…è¦ã€‚é€šå¸¸æƒ…å†µä¸‹ 60% çš„ä¸šåŠ¡ä»£ç æ˜¯ä¸‰å±‚æ¶æ„ï¼Œæ•°æ®ç»è¿‡æ— çŠ¶æ€çš„Controllerã€Serviceã€Repository æµè½¬åˆ°æ•°æ®åº“ï¼Œæ²¡å¿…è¦ä½¿ç”¨ synchronized æ¥ä¿æŠ¤ä»€ä¹ˆæ•°æ®ã€‚</li>
      <li>äºŒæ˜¯ï¼Œå¯èƒ½ä¼šæå¤§åœ°é™ä½æ€§èƒ½ã€‚ä½¿ç”¨ Spring æ¡†æ¶æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ Controllerã€Serviceã€Repository æ˜¯å•ä¾‹çš„ï¼ŒåŠ ä¸Š synchronized ä¼šå¯¼è‡´æ•´ä¸ªç¨‹åºå‡ ä¹å°±åªèƒ½æ”¯æŒå•çº¿ç¨‹ï¼Œé€ æˆæå¤§çš„æ€§èƒ½é—®é¢˜ã€‚</li>
    </ul>
  </li>
  <li>
    <p>å³ä½¿æˆ‘ä»¬ç¡®å®æœ‰ä¸€äº›å…±äº«èµ„æºéœ€è¦ä¿æŠ¤ï¼Œä¹Ÿè¦å°½å¯èƒ½é™ä½é”çš„ç²’åº¦ï¼Œä»…å¯¹å¿…è¦çš„ä»£ç å—ç”šè‡³æ˜¯éœ€è¦ä¿æŠ¤çš„èµ„æºæœ¬èº«åŠ é”ã€‚</p>
  </li>
  <li>
    <p>æ¯”å¦‚ï¼Œåœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œæœ‰ä¸€ä¸ª ArrayList å› ä¸ºä¼šè¢«å¤šä¸ªçº¿ç¨‹æ“ä½œè€Œéœ€è¦ä¿æŠ¤ï¼Œåˆæœ‰ä¸€æ®µæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼ˆä»£ç ä¸­çš„ slow æ–¹æ³•ï¼‰ä¸æ¶‰åŠçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œåº”è¯¥å¦‚ä½•åŠ é”å‘¢ï¼Ÿ</p>
  </li>
  <li>
    <p>é”™è¯¯çš„åšæ³•æ˜¯ï¼Œç»™æ•´æ®µä¸šåŠ¡é€»è¾‘åŠ é”ï¼ŒæŠŠ slow æ–¹æ³•å’Œæ“ä½œ ArrayList çš„ä»£ç åŒæ—¶çº³å…¥synchronized ä»£ç å—ï¼›æ›´åˆé€‚çš„åšæ³•æ˜¯ï¼ŒæŠŠåŠ é”çš„ç²’åº¦é™åˆ°æœ€ä½ï¼Œåªåœ¨æ“ä½œ ArrayList çš„æ—¶å€™ç»™è¿™ä¸ª ArrayList åŠ é”ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"lockgranularity"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockGranularityController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">data</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

    <span class="c1">//ä¸æ¶‰åŠå…±äº«èµ„æºçš„æ…¢æ–¹æ³•</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">slow</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//é”™è¯¯çš„åŠ é”æ–¹æ³•</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1000</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">//åŠ é”ç²’åº¦å¤ªç²—äº†</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">slow</span><span class="o">();</span>
                <span class="n">data</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"took:{}"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">begin</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//æ­£ç¡®çš„åŠ é”æ–¹æ³•</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">right</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1000</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">slow</span><span class="o">();</span>
            <span class="c1">//åªå¯¹ListåŠ é”</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">data</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"took:{}"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">begin</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ‰§è¡Œè¿™æ®µä»£ç ï¼ŒåŒæ ·æ˜¯ 1000 æ¬¡ä¸šåŠ¡æ“ä½œï¼Œæ­£ç¡®åŠ é”çš„ç‰ˆæœ¬è€—æ—¶ 1.4 ç§’ï¼Œè€Œå¯¹æ•´ä¸ªä¸šåŠ¡é€»è¾‘åŠ é”çš„è¯è€—æ—¶ 11 ç§’ã€‚</p>
  </li>
  <li>
    <p><strong>å¦‚æœç²¾ç»†åŒ–è€ƒè™‘äº†é”åº”ç”¨èŒƒå›´åï¼Œæ€§èƒ½è¿˜æ— æ³•æ»¡è¶³éœ€æ±‚çš„è¯ï¼Œæˆ‘ä»¬å°±è¦è€ƒè™‘å¦ä¸€ä¸ªç»´åº¦çš„ç²’åº¦é—®é¢˜äº†ï¼Œå³ï¼šåŒºåˆ†è¯»å†™åœºæ™¯ä»¥åŠèµ„æºçš„è®¿é—®å†²çªï¼Œè€ƒè™‘ä½¿ç”¨æ‚²è§‚æ–¹å¼çš„é”è¿˜æ˜¯ä¹è§‚æ–¹å¼çš„é”ã€‚</strong></p>
  </li>
  <li>
    <p>å¯¹äºè¯»å†™æ¯”ä¾‹å·®å¼‚æ˜æ˜¾çš„åœºæ™¯ï¼Œè€ƒè™‘ä½¿ç”¨ ReentrantReadWriteLock ç»†åŒ–åŒºåˆ†è¯»å†™é”ï¼Œæ¥æé«˜æ€§èƒ½ã€‚</p>
  </li>
  <li>
    <p>å¦‚æœä½ çš„ JDK ç‰ˆæœ¬é«˜äº 1.8ã€å…±äº«èµ„æºçš„å†²çªæ¦‚ç‡ä¹Ÿæ²¡é‚£ä¹ˆå¤§çš„è¯ï¼Œè€ƒè™‘ä½¿ç”¨StampedLock çš„ä¹è§‚è¯»çš„ç‰¹æ€§ï¼Œè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚</p>
  </li>
  <li>JDK é‡Œ ReentrantLock å’Œ ReentrantReadWriteLock éƒ½æä¾›äº†å…¬å¹³é”çš„ç‰ˆæœ¬ï¼Œåœ¨æ²¡æœ‰æ˜ç¡®éœ€æ±‚çš„æƒ…å†µä¸‹ä¸è¦è½»æ˜“å¼€å¯å…¬å¹³é”ç‰¹æ€§ï¼Œåœ¨ä»»åŠ¡å¾ˆè½»çš„æƒ…å†µä¸‹å¼€å¯å…¬å¹³é”å¯èƒ½ä¼šè®©æ€§èƒ½ä¸‹é™ä¸Šç™¾å€ã€‚</li>
</ul>

<h4 id="3å°å¿ƒæ­»é”é—®é¢˜">3å°å¿ƒæ­»é”é—®é¢˜</h4>

<ul>
  <li>
    <p>é¦–å…ˆï¼Œå®šä¹‰ä¸€ä¸ªå•†å“ç±»å‹ï¼ŒåŒ…å«å•†å“åã€åº“å­˜å‰©ä½™å’Œå•†å“çš„åº“å­˜é”ä¸‰ä¸ªå±æ€§ï¼Œæ¯ä¸€ç§å•†å“é»˜è®¤åº“å­˜ 1000 ä¸ªï¼›ç„¶åï¼Œåˆå§‹åŒ– 10 ä¸ªè¿™æ ·çš„å•†å“å¯¹è±¡æ¥æ¨¡æ‹Ÿå•†å“æ¸…å•</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span> <span class="c1">//å•†å“å</span>
  <span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span> <span class="c1">//åº“å­˜å‰©ä½™</span>
  <span class="nd">@ToString</span><span class="o">.</span><span class="na">Exclude</span> <span class="c1">//ToStringä¸åŒ…å«è¿™ä¸ªå­—æ®µ</span>
  <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>åˆ›å»ºè´­ç‰©è½¦ï¼Œå†™ä¸€ä¸ªæ–¹æ³•æ¨¡æ‹Ÿåœ¨è´­ç‰©è½¦è¿›è¡Œå•†å“é€‰è´­ï¼Œæ¯æ¬¡ä»å•†å“æ¸…å•ï¼ˆitems å­—æ®µï¼‰ä¸­éšæœºé€‰è´­ä¸‰ä¸ªå•†å“ï¼ˆä¸ºäº†é€»è¾‘ç®€å•ï¼Œæˆ‘ä»¬ä¸è€ƒè™‘æ¯æ¬¡é€‰è´­å¤šä¸ªåŒç±»å•†å“çš„é€»è¾‘ï¼Œè´­ç‰©è½¦ä¸­ä¸ä½“ç°å•†å“æ•°é‡ï¼‰</p>
  </li>
  <li>
    <p>åˆ›å»ºè®¢å•ï¼Œå…ˆå£°æ˜ä¸€ä¸ª List æ¥ä¿å­˜æ‰€æœ‰è·å¾—çš„é”ï¼Œç„¶åéå†è´­ç‰©è½¦ä¸­çš„å•†å“ä¾æ¬¡å°è¯•è·å¾—å•†å“çš„é”ï¼Œæœ€é•¿ç­‰å¾… 10 ç§’ï¼Œè·å¾—å…¨éƒ¨é”ä¹‹åå†æ‰£å‡åº“å­˜ï¼›å¦‚æœæœ‰æ— æ³•è·å¾—é”çš„æƒ…å†µåˆ™è§£é”ä¹‹å‰è·å¾—çš„æ‰€æœ‰é”ï¼Œè¿”å› false ä¸‹å•å¤±è´¥ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"deadlock"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeadLockController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Item</span><span class="o">&gt;</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="nf">DeadLockController</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">items</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"item"</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Item</span><span class="o">(</span><span class="s">"item"</span> <span class="o">+</span> <span class="n">i</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="c1">//åˆ›å»ºè®¢å•</span>
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">createOrder</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å­˜æ”¾æ‰€æœ‰è·å¾—çš„é”</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ReentrantLock</span><span class="o">&gt;</span> <span class="n">locks</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>

        <span class="k">for</span> <span class="o">(</span><span class="nc">Item</span> <span class="n">item</span> <span class="o">:</span> <span class="n">order</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">//è·å¾—é”10ç§’è¶…æ—¶</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">lock</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">locks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">lock</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">locks</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">ReentrantLock:</span><span class="o">:</span><span class="n">unlock</span><span class="o">);</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="c1">//é”å…¨éƒ¨æ‹¿åˆ°ä¹‹åæ‰§è¡Œæ‰£å‡åº“å­˜ä¸šåŠ¡é€»è¾‘</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">order</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">remaining</span><span class="o">--);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">locks</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="nl">ReentrantLock:</span><span class="o">:</span><span class="n">unlock</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//åˆ›å»ºè´­ç‰©è½¦</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="nf">createCart</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
                <span class="o">.</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="s">"item"</span> <span class="o">+</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">items</span><span class="o">.</span><span class="na">size</span><span class="o">()))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="n">items</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">name</span><span class="o">)).</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">//å¤±è´¥æ¡ˆä¾‹ï¼Œä¼šå‘ç”Ÿæ­»é”</span>
    <span class="cm">/*
    å‡è®¾ä¸€ä¸ªè´­ç‰©è½¦ä¸­çš„å•†å“æ˜¯ item1 å’Œ item2ï¼Œå¦ä¸€ä¸ªè´­ç‰©è½¦ä¸­çš„å•†å“æ˜¯ item2 å’Œ item1ï¼Œä¸€ä¸ªçº¿ç¨‹å…ˆè·å–åˆ°äº†item1 çš„é”ï¼ŒåŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°äº† item2 çš„é”ï¼Œç„¶åä¸¤ä¸ªçº¿ç¨‹æ¥ä¸‹æ¥è¦åˆ†åˆ«è·å–item2 å’Œ item1 çš„é”ï¼Œè¿™ä¸ªæ—¶å€™é”å·²ç»è¢«å¯¹æ–¹è·å–äº†ï¼Œåªèƒ½ç›¸äº’ç­‰å¾…ä¸€ç›´åˆ° 10 ç§’è¶…æ—¶ã€‚
    */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">wrong</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="c1">//å¹¶å‘è¿›è¡Œ100æ¬¡ä¸‹å•æ“ä½œï¼Œç»Ÿè®¡æˆåŠŸæ¬¡æ•°</span>
        <span class="kt">long</span> <span class="n">success</span> <span class="o">=</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">100</span><span class="o">).</span><span class="na">parallel</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">cart</span> <span class="o">=</span> <span class="n">createCart</span><span class="o">();</span>
                    <span class="k">return</span> <span class="nf">createOrder</span><span class="o">(</span><span class="n">cart</span><span class="o">);</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">result</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">)</span>
                <span class="o">.</span><span class="na">count</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"success:{} totalRemaining:{} took:{}ms items:{}"</span><span class="o">,</span>
                <span class="n">success</span><span class="o">,</span>
                <span class="n">items</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">remaining</span><span class="o">).</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nl">Integer:</span><span class="o">:</span><span class="n">sum</span><span class="o">),</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">begin</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//æˆåŠŸæ¡ˆä¾‹</span>
    <span class="cm">/*
    ä¸ºè´­ç‰©è½¦ä¸­çš„å•†å“æ’ä¸€ä¸‹åºï¼Œè®©æ‰€æœ‰çš„çº¿ç¨‹ä¸€å®šæ˜¯å…ˆè·å–item1 çš„é”ç„¶åè·å– item2 çš„é”ï¼Œå°±ä¸ä¼šæœ‰é—®é¢˜äº†ã€‚
    æµ‹è¯•ä¸€ä¸‹ right æ–¹æ³•ï¼Œä¸ç®¡æ‰§è¡Œå¤šå°‘æ¬¡éƒ½æ˜¯ 100 æ¬¡æˆåŠŸä¸‹å•ï¼Œè€Œä¸”æ€§èƒ½ç›¸å½“é«˜ï¼Œè¾¾åˆ°äº†3000 ä»¥ä¸Šçš„ TPS
    */</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">right</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">begin</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="kt">long</span> <span class="n">success</span> <span class="o">=</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">100</span><span class="o">).</span><span class="na">parallel</span><span class="o">()</span>
                <span class="o">.</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Item</span><span class="o">&gt;</span> <span class="n">cart</span> <span class="o">=</span> <span class="n">createCart</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                            <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="nc">Comparator</span><span class="o">.</span><span class="na">comparing</span><span class="o">(</span><span class="nl">Item:</span><span class="o">:</span><span class="n">getName</span><span class="o">))</span>
                            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
                    <span class="k">return</span> <span class="nf">createOrder</span><span class="o">(</span><span class="n">cart</span><span class="o">);</span>
                <span class="o">})</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">result</span> <span class="o">-&gt;</span> <span class="n">result</span><span class="o">)</span>
                <span class="o">.</span><span class="na">count</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"success:{} totalRemaining:{} took:{}ms items:{}"</span><span class="o">,</span>
                <span class="n">success</span><span class="o">,</span>
                <span class="n">items</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">remaining</span><span class="o">).</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nl">Integer:</span><span class="o">:</span><span class="n">sum</span><span class="o">),</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">begin</span><span class="o">,</span> <span class="n">items</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">success</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//å®ä½“ç±»</span>
    <span class="nd">@Data</span>
    <span class="nd">@RequiredArgsConstructor</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Item</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">remaining</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
        <span class="nd">@ToString</span><span class="o">.</span><span class="na">Exclude</span>
        <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¦‚æœä¸šåŠ¡é€»è¾‘ä¸­é”çš„å®ç°æ¯”è¾ƒå¤æ‚çš„è¯ï¼Œè¦ä»”ç»†çœ‹çœ‹åŠ é”å’Œé‡Šæ”¾æ˜¯å¦é…å¯¹ï¼Œæ˜¯å¦æœ‰é—æ¼é‡Šæ”¾æˆ–é‡å¤é‡Šæ”¾çš„å¯èƒ½æ€§ï¼›å¹¶ä¸”è¦è€ƒè™‘é”è‡ªåŠ¨è¶…æ—¶é‡Šæ”¾äº†ï¼Œè€Œä¸šåŠ¡é€»è¾‘å´è¿˜åœ¨è¿›è¡Œçš„æƒ…å†µä¸‹ï¼Œå¦‚æœåˆ«çš„çº¿ç¨‹æˆ–è¿›ç¨‹æ‹¿åˆ°äº†ç›¸åŒçš„é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´é‡å¤æ‰§è¡Œã€‚</li>
</ul>
:ET