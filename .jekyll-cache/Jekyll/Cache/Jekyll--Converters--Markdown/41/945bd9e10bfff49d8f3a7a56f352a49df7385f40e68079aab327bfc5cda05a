I"w½<ul id="markdown-toc">
  <li><a href="#æ–‡ä»¶ä¸Šä¼ " id="markdown-toc-æ–‡ä»¶ä¸Šä¼ ">æ–‡ä»¶ä¸Šä¼ </a>    <ul>
      <li><a href="#æ–‡ä»¶è¿‡æ»¤" id="markdown-toc-æ–‡ä»¶è¿‡æ»¤">æ–‡ä»¶è¿‡æ»¤</a></li>
      <li><a href="#å¸¸é‡é…ç½®" id="markdown-toc-å¸¸é‡é…ç½®">å¸¸é‡é…ç½®</a></li>
    </ul>
  </li>
  <li><a href="#æ–‡ä»¶ä¸‹è½½" id="markdown-toc-æ–‡ä»¶ä¸‹è½½">æ–‡ä»¶ä¸‹è½½</a></li>
  <li><a href="#æ–‡ä»¶ä¸‹è½½æ¬¡æ•°" id="markdown-toc-æ–‡ä»¶ä¸‹è½½æ¬¡æ•°">æ–‡ä»¶ä¸‹è½½æ¬¡æ•°</a></li>
</ul>
<h3 id="æ–‡ä»¶ä¸Šä¼ ">æ–‡ä»¶ä¸Šä¼ </h3>

<ul>
  <li>select.jsp</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ taglib </span><span class="na">prefix=</span><span class="s">"s"</span><span class="na"> uri=</span><span class="s">"/struts-tags"</span> <span class="nt">%&gt;</span>
<span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> import=</span><span class="s">"java.util.*"</span><span class="na"> language=</span><span class="s">"java"</span><span class="na"> pageEncoding=</span><span class="s">"UTF-8"</span> <span class="nt">%&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>upload_test<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;s:form </span><span class="na">action=</span><span class="s">"upload"</span><span class="na"> method=</span><span class="s">"post"</span><span class="na"> theme=</span><span class="s">"simple"</span><span class="na"> enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
        è¾“å…¥å¸å·ï¼š<span class="nt">&lt;s:textfield </span><span class="na">name=</span><span class="s">"uid"</span><span class="nt">/&gt;&lt;br&gt;</span>
        é€‰æ‹©å¤´åƒï¼š<span class="nt">&lt;s:file </span><span class="na">name=</span><span class="s">"headImage"</span><span class="nt">/&gt;&lt;br&gt;</span>
        <span class="nt">&lt;s:submit </span><span class="na">value=</span><span class="s">"æäº¤"</span><span class="nt">/&gt;</span>
ã€€ã€€ã€€ã€€
ã€€ã€€ã€€ã€€  <span class="c">&lt;!--æ˜¾ç¤ºä¸Šä¼ é”™è¯¯æç¤ºä¿¡æ¯--&gt;</span>
ã€€ã€€ã€€ã€€ã€€<span class="nt">&lt;s:fielderror/&gt;</span>
ã€€ã€€ã€€ã€€
    <span class="nt">&lt;/s:form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<ul>
  <li>action</li>
  <li>ç±»å‹ä¸ºjava.io.Fileçš„xxxå±æ€§æ¥å°è£…<strong><em>æ–‡ä»¶åŸŸçš„ä¿¡æ¯</em></strong></li>
  <li>ç±»å‹ä¸ºStringçš„xxxFileNameå±æ€§å°è£…äº†è¯¥æ–‡ä»¶åŸŸå¯¹åº”çš„<strong><em>æ–‡æœ¬å†…å®¹</em></strong></li>
  <li>ç±»å‹ä¸ºStringçš„xxxContentTypeå±æ€§å°è£…äº†è¯¥æ–‡ä»¶åŸŸå¯¹åº”çš„<strong><em>æ–‡ä»¶ç±»å‹</em></strong></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">action</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.opensymphony.xwork2.ActionSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.io.FileUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.struts2.ServletActionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UploadAction</span> <span class="kd">extends</span> <span class="nc">ActionSupport</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">uid</span><span class="o">;</span>        <span class="err">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="c1">// å°è£…å¸å·ï¼ˆuidï¼‰è¯·æ±‚å‚æ•°å±æ€§</span>
    <span class="kd">private</span> <span class="nc">File</span> <span class="n">headImage</span><span class="o">;</span>     <span class="err">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</span><span class="c1">// å°è£…ä¸Šä¼ æ–‡ä»¶åŸŸå±æ€§</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">headImageContentType</span><span class="o">;</span>     <span class="c1">// å°è£…ä¸Šä¼ æ–‡ä»¶ç±»å‹çš„å±æ€§</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">headImageFileName</span><span class="o">;</span><span class="err">ã€€ã€€ã€€</span> <span class="err">ã€€</span><span class="c1">// å°è£…ä¸Šä¼ æ–‡ä»¶å±æ€§</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getUid</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">uid</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUid</span><span class="o">(</span><span class="nc">String</span> <span class="n">uid</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">uid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">File</span> <span class="nf">getHeadImage</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">headImage</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeadImage</span><span class="o">(</span><span class="nc">File</span> <span class="n">headImage</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">headImage</span> <span class="o">=</span> <span class="n">headImage</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getHeadImageContentType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">headImageContentType</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeadImageContentType</span><span class="o">(</span><span class="nc">String</span> <span class="n">headImageContentType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">headImageContentType</span> <span class="o">=</span> <span class="n">headImageContentType</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getHeadImageFileName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">headImageFileName</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHeadImageFileName</span><span class="o">(</span><span class="nc">String</span> <span class="n">headImageFileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">headImageFileName</span> <span class="o">=</span> <span class="n">headImageFileName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// ä¸Šä¼ æ–‡ä»¶çš„ä¿å­˜ä½ç½®åœ¨â€œ/imageâ€,è¯¥ä½ç½®åœ¨tomcatæœåŠ¡å™¨çš„â€œwebappsâ€ä¹‹ä¸­</span>
        <span class="nc">String</span>  <span class="n">realpath</span><span class="o">=</span> <span class="nc">ServletActionContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/image"</span><span class="o">);</span>

        <span class="c1">// å£°æ˜æ–‡ä»¶ç›®å½•imageï¼Œå¦‚æœæ–‡ä»¶åä¸å­˜åœ¨å°±å»ºä¸€ä¸ªå‘—ï½</span>
        <span class="nc">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">realpath</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(!</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">()){</span>
            <span class="n">file</span><span class="o">.</span><span class="na">mkdirs</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// å®ç°æ–‡ä»¶ä¸Šä¼ ï¼Œä¹Ÿå°±æ˜¯åšäº†ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ï½</span>
        <span class="nc">FileUtils</span><span class="o">.</span><span class="na">copyFile</span><span class="o">(</span><span class="n">headImage</span><span class="o">,</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">file</span><span class="o">,</span><span class="n">headImageFileName</span><span class="o">));</span>
        <span class="k">return</span> <span class="no">SUCCESS</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>struts.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="cp">&lt;!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.5//EN"
        "http://struts.apache.org/dtds/struts-2.5.dtd"&gt;</span>

<span class="nt">&lt;struts&gt;</span>
    <span class="c">&lt;!--æŒ‡å®šå›½é™…åŒ–èµ„æºæ–‡ä»¶ï¼ˆä¸‹ä¸€ç« ä¼šè®²åˆ°ï¼‰--&gt;</span>
    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.custom.i18n.resources"</span> <span class="na">value=</span><span class="s">"messageResource"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!--è®¾ç½®Strutsåº”ç”¨çš„è§£ç é›†--&gt;</span>
    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.i18n.encoding"</span> <span class="na">value=</span><span class="s">"utf-8"</span><span class="nt">/&gt;</span>
ã€€ã€€ 
ã€€ã€€<span class="c">&lt;!-- ---  åŒ…é…ç½®  ---- --&gt;</span>
    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"default"</span> <span class="na">namespace=</span><span class="s">"/"</span> <span class="na">extends=</span><span class="s">"struts-default"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"upload"</span> <span class="na">class=</span><span class="s">"action.UploadAction"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;result&gt;</span>/uploadSuccess.jsp<span class="nt">&lt;/result&gt;</span>
        <span class="nt">&lt;/action&gt;</span>
    <span class="nt">&lt;/package&gt;</span>
<span class="nt">&lt;/struts&gt;</span>
</code></pre></div></div>

<ul>
  <li>uploadSuccess.jsp</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">contentType=</span><span class="s">"text/html;charset=UTF-8"</span><span class="na"> language=</span><span class="s">"java"</span> <span class="nt">%&gt;</span>

<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>ä¸Šä¼ åˆå§‹é¡µ<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
    ä¸Šä¼ æˆåŠŸ!<span class="nt">&lt;br&gt;</span>

    <span class="c">&lt;!--è¾“å…¥è¡¨å•é‡Œçš„ç”¨æˆ·å¸å·å±æ€§--&gt;</span>
    ç”¨æˆ·å¸å·ï¼š<span class="nt">&lt;s:property </span><span class="na">value=</span><span class="s">"uid"</span><span class="nt">/&gt;&lt;br&gt;</span>

    <span class="c">&lt;!--æ ¹æ®ä¸Šä¼ æ–‡ä»¶åå­—,æ˜¾ç¤ºä¸Šä¼ å¤´åƒ--&gt;</span>
    æ‚¨çš„å¤´åƒï¼š<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"</span><span class="nt">&lt;s:property </span><span class="na">value=</span><span class="s">"'image/' + headImageFileName"</span><span class="nt">/&gt;</span><span class="s"> "</span> <span class="na">alt=</span><span class="s">"å›¾åƒæ— æ³•æ˜¾ç¤º"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h4 id="æ–‡ä»¶è¿‡æ»¤">æ–‡ä»¶è¿‡æ»¤</h4>

<ul>
  <li>Struts2æä¾›äº†ä¸€ä¸ªåä¸ºfileUploadæ‹¦æˆªå™¨ï¼Œé€šè¿‡é…ç½®è¯¥æ‹¦æˆªå™¨å¯ä»¥è½»æ¾åœ°å®ç°æ–‡ä»¶è¿‡æ»¤</li>
  <li>allowTypesï¼šè¯¥å‚æ•°æŒ‡å®šå…è®¸ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹ï¼Œå¤šä¸ªæ–‡ä»¶ç±»å‹ä¹‹é—´ä»¥è‹±æ–‡é€—å·éš”å¼€</li>
  <li>maximumSizeï¼šè¯¥å‚æ•°æŒ‡å®šå…è®¸ä¸Šä¼ æ–‡ä»¶çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚</li>
  <li>å½“æ–‡ä»¶è¿‡æ»¤å¤±è´¥åï¼Œç³»ç»Ÿè‡ªåŠ¨è½¬å…¥inputé€»è¾‘è§†å›¾ï¼Œå› æ­¤å¿…é¡»ä¸ºActioné…ç½®åä¸ºinputçš„é€»è¾‘è§†å›¾</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="cp">&lt;!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.5//EN"
        "http://struts.apache.org/dtds/struts-2.5.dtd"&gt;</span>

<span class="nt">&lt;struts&gt;</span>
    <span class="c">&lt;!--æŒ‡å®šå›½é™…åŒ–èµ„æºæ–‡ä»¶ï¼ˆä¸‹ä¸€è®²ä¼šè®²åˆ°ï¼‰--&gt;</span>
    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.custom.i18n.resources"</span> <span class="na">value=</span><span class="s">"messageResource"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!--è®¾ç½®Strutsåº”ç”¨çš„è§£ç é›†--&gt;</span>
    <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.i18n.encoding"</span> <span class="na">value=</span><span class="s">"utf-8"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!--packageä¸­åŠ å…¥æ‹¦æˆªå™¨--&gt;</span>
    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"default"</span> <span class="na">namespace=</span><span class="s">"/"</span> <span class="na">extends=</span><span class="s">"struts-default"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;interceptors&gt;</span>
            <span class="c">&lt;!--é…ç½®æ‹¦æˆªå™¨æ ˆ(åœ¨æ‹¦æˆªå™¨ç« èŠ‚æœ‰è®²è¿°)--&gt;</span>
            <span class="nt">&lt;interceptor-stack</span> <span class="na">name=</span><span class="s">"myStack"</span><span class="nt">&gt;</span>
                <span class="c">&lt;!--é…ç½®fileUploadæ‹¦æˆªå™¨--&gt;</span>
                <span class="nt">&lt;interceptor-ref</span> <span class="na">name=</span><span class="s">"fileUpload"</span><span class="nt">&gt;</span>
                    <span class="c">&lt;!--é…ç½®å…è®¸ä¸Šä¼ æ–‡ä»¶çš„ç±»å‹ï¼ˆæ­¤å¤„è¦æ³¨æ„çš„æ˜¯pngå›¾ç‰‡åœ¨ieæµè§ˆå™¨ä¸­æ˜¯image/x-pngç±»å‹ï¼‰--&gt;</span>
                    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"allowedTypes"</span><span class="nt">&gt;</span>image/x-png,image/bmp,image/gif,image/jpeg,image/jpg<span class="nt">&lt;/param&gt;</span>
                    <span class="c">&lt;!--é…ç½®å…è®¸ä¸Šä¼ æ–‡ä»¶å¤§å°æ‹¦æˆªå™¨ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼ˆ2çš„16æ¬¡å¹‚=65536ï¼ˆ64kï¼‰ï¼‰--&gt;</span>
                    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"maximumSize"</span><span class="nt">&gt;</span>65536<span class="nt">&lt;/param&gt;</span>
                <span class="nt">&lt;/interceptor-ref&gt;</span>
                <span class="nt">&lt;interceptor-ref</span> <span class="na">name=</span><span class="s">"defaultStack"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/interceptor-stack&gt;</span>
        <span class="nt">&lt;/interceptors&gt;</span>

        <span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"upload"</span> <span class="na">class=</span><span class="s">"action.UploadAction"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--ä½¿ç”¨æ‹¦æˆªå™¨æ ˆ--&gt;</span>
            <span class="nt">&lt;interceptor-ref</span> <span class="na">name=</span><span class="s">"myStack"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;result&gt;</span>/uploadSuccess.jsp<span class="nt">&lt;/result&gt;</span>

            <span class="c">&lt;!--è¿‡æ»¤å¤±è´¥ï¼Œç³»ç»Ÿä¼šè½¬å…¥inputé€»è¾‘è§†å›¾ï¼Œè¿™é‡Œé…ç½®å…¶è¿”å›é€‰æ‹©ç•Œé¢--&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">name=</span><span class="s">"input"</span><span class="nt">&gt;</span>/select.jsp<span class="nt">&lt;/result&gt;</span>
        <span class="nt">&lt;/action&gt;</span>
    <span class="nt">&lt;/package&gt;</span>
<span class="nt">&lt;/struts&gt;</span>
</code></pre></div></div>

<h4 id="å¸¸é‡é…ç½®">å¸¸é‡é…ç½®</h4>

<ul>
  <li>ä¸Šä¼ æ–‡ä»¶æ—¶ï¼Œç³»ç»Ÿé»˜è®¤ä½¿ç”¨webæœåŠ¡å™¨çš„å·¥ä½œè·¯å¾„ä½œä¸ºä¸´æ—¶è·¯å¾„ã€‚ä¸ºäº†é¿å…æ–‡ä»¶ä¸Šä¼ æ—¶å€™ä½¿ç”¨WebæœåŠ¡å™¨çš„å·¥ä½œè·¯å¾„ä½œä¸ºä¸´æ—¶è·¯å¾„ï¼Œåˆ™åº”è¯¥è®¾ç½®struts.multipart.saveDirå¸¸é‡ã€‚è¯¥å¸¸é‡æŒ‡å®šä¸Šä¼ æ–‡ä»¶çš„ä¸´æ—¶ä¿å­˜è·¯å¾„</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.multipart.saveDir"</span> <span class="na">value=</span><span class="s">"HOME/....(å†™ä¸Šè·¯å¾„)..."</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<ul>
  <li>è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ çš„å¸¸é‡struts.multipart.maxSizeã€‚è¯¥å¸¸é‡æŒ‡å®šstruts.mutipart.maxSizeã€‚è¯¥å¸¸é‡æŒ‡å®šåœ¨struts2æ–‡ä»¶ä¸Šä¼ ä¸­æ•´ä¸ªè¯·æ±‚å†…å®¹æ‰€å…è®¸çš„æœ€å¤§å­—èŠ‚æ•°ï¼Œé»˜è®¤ä¸º2097152ï¼ˆå³2MBï¼‰</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;constant</span> <span class="na">name=</span><span class="s">"struts.multipart.maxSize"</span> <span class="na">value=</span><span class="s">"209971520"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<h3 id="æ–‡ä»¶ä¸‹è½½">æ–‡ä»¶ä¸‹è½½</h3>

<ul>
  <li>index.jsp</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%@ page </span><span class="na">language=</span><span class="s">"java"</span><span class="na"> import=</span><span class="s">"java.util.*"</span><span class="na"> pageEncoding=</span><span class="s">"utf-8"</span><span class="nt">%&gt;</span>


<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span>test_download<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
  ã€€ã€€è¯·ä¸‹è½½ä¸­æ–‡è¯¾ä»¶ï¼š<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"downLoad.action?downPath=ç¬¬ä¸€ç« èŠ‚.doc"</span><span class="nt">&gt;</span>ä¸­<span class="nt">&lt;/a&gt;&lt;br&gt;</span>
  ã€€ã€€è¯·ä¸‹è½½è‹±æ–‡è¯¾ä»¶ï¼š<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"downLoad.action?downPath=chapter01.doc"</span><span class="nt">&gt;</span>è‹±<span class="nt">&lt;/a&gt;&lt;br&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<ul>
  <li>DownLoadAction.java</li>
  <li>éœ€è¦æä¾›ä¸€ä¸ªè¿”å›InputStreamæµæ–¹æ³•ï¼Œè¯¥è¾“å…¥æµä»£è¡¨äº†è¢«ä¸‹è½½æ–‡ä»¶çš„å…¥å£</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">action</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.opensymphony.xwork2.ActionSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.struts2.ServletActionContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">util.MyUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownLoadAction</span> <span class="kd">extends</span> <span class="nc">ActionSupport</span><span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="n">downPath</span><span class="o">;</span>        <span class="c1">// ä¸‹è½½æ—¶çš„æ–‡ä»¶å</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">contentType</span><span class="o">;</span>     <span class="c1">// ä¿å­˜æ–‡ä»¶ç±»å‹</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">filename</span><span class="o">;</span>        <span class="c1">// ä¿å­˜æ—¶çš„æ–‡ä»¶å</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContentType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">contentType</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentType</span><span class="o">(</span><span class="nc">String</span> <span class="n">contentType</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">contentType</span> <span class="o">=</span> <span class="n">contentType</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getFilename</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">filename</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFilename</span><span class="o">(</span><span class="nc">String</span> <span class="n">filename</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDownPath</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">downPath</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDownPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">downPath</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// è§£å†³ä¸‹è½½æ—¶å€™çš„ä¸­æ–‡æ–‡ä»¶ä¹±ç é—®é¢˜</span>
            <span class="n">downPath</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">downPath</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"ISO-8859-1"</span><span class="o">),</span><span class="s">"UTF-8"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">downPath</span> <span class="o">=</span> <span class="n">downPath</span><span class="o">;</span>
    <span class="o">}</span>

   <span class="cm">/*
    *ä¸‹è½½ç”¨çš„Actionè¿”å›ä¸€ä¸ªInputStringå®ä¾‹ï¼Œè¯¥æ–¹æ³•å¯¹åº”Actioné…ç½®
    *é‡Œé¢çš„resultçš„inputNameå‚æ•°ï¼Œå€¼ä¸ºinputString
    *
    */</span>

   <span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputString</span><span class="o">(){</span>
       <span class="k">return</span> <span class="nc">ServletActionContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">downPath</span><span class="o">);</span>
   <span class="o">}</span>

   <span class="kd">public</span> <span class="nc">String</span> <span class="nf">execute</span><span class="o">(){</span>
       <span class="c1">// ä¸‹è½½ä¿å­˜æ—¶çš„æ–‡ä»¶åå’Œè¢«ä¸‹è½½çš„æ–‡ä»¶åä¸€æ ·</span>
       <span class="n">filename</span> <span class="o">=</span> <span class="n">downPath</span><span class="o">;</span>
       <span class="c1">// ä¸‹è½½çš„æ–‡ä»¶è·¯å¾„ï¼Œè¯·åœ¨webappsç›®å½•ä¸‹åˆ›å»ºimages</span>
       <span class="n">downPath</span> <span class="o">=</span> <span class="s">"images/"</span> <span class="o">+</span> <span class="n">downPath</span><span class="o">;</span>
       <span class="c1">// ä¿å­˜æ–‡ä»¶çš„ç±»å‹</span>

       <span class="n">contentType</span> <span class="o">=</span> <span class="s">"application/x-msdownload"</span><span class="o">;</span>

       <span class="cm">/*
        *å¯¹ä¸‹è½½çš„æ–‡ä»¶åæŒ‰ç…§UTF-8è¿›è¡Œç¼–ç ï¼Œè§£å†³ä¸‹è½½çª—å£ä¸­çš„ä¸­æ–‡ä¹±ç é—®é¢˜
        * å…¶ä¸­,MyUtilæ˜¯è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªç±»
        */</span>

       <span class="n">filename</span> <span class="o">=</span> <span class="nc">MyUtil</span><span class="o">.</span><span class="na">toUTF8String</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
       <span class="k">return</span> <span class="no">SUCCESS</span><span class="o">;</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>MyUtil.java</li>
  <li>è¯¥ç±»ä¸­æœ‰ä¸€ä¸ªé™æ€æ–¹æ³•toUTF8Stringå®ç°å¯¹ä¸‹è½½çš„æ–‡ä»¶åæŒ‰ç…§UTF-8è¿›è¡Œç¼–ç ï¼Œè§£å†³ä¸‹è½½çª—å£ä¸­ä¸­æ–‡ä¹±ç çš„é—®é¢˜</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">util</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.UnsupportedEncodingException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyUtil</span> <span class="o">{</span>
    <span class="c1">// å¯¹ä¸‹è½½æ–‡ä»¶æŒ‰ç…§ UTF-8 è¿›è¡Œç¼–ç </span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">toUTF8String</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">){</span>
        <span class="nc">StringBuffer</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuffer</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
        <span class="o">{</span>
            <span class="c1">// å–å‡ºå­—ç¬¦ä¸­çš„æ¯ä¸ªå­—ç¬¦</span>
            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
            <span class="c1">// Unicodeç å€¼åœ¨0ï½255ä¹‹é—´ï¼Œä¸åšå¤„ç†</span>
            <span class="k">if</span><span class="o">(</span><span class="n">c</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="o">){</span>
                <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="c1">// è½¬æ¢ UTF-8 ç¼–ç </span>
                <span class="kt">byte</span> <span class="n">b</span><span class="o">[];</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="nc">Character</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">c</span><span class="o">).</span><span class="na">getBytes</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
                <span class="o">}</span><span class="k">catch</span><span class="o">(</span><span class="nc">UnsupportedEncodingException</span> <span class="n">e</span><span class="o">){</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="c1">// è½¬æ¢ä¸º%HHçš„å­—ç¬¦ä¸²å½¢å¼</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">.</span><span class="na">length</span> <span class="o">;</span> <span class="n">j</span><span class="o">++){</span>
                    <span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="n">b</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="n">k</span> <span class="o">&amp;=</span> <span class="mi">255</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">"%"</span> <span class="o">+</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">k</span><span class="o">).</span><span class="na">toUpperCase</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>struts.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>

<span class="cp">&lt;!DOCTYPE struts PUBLIC
        "-//Apache Software Foundation//DTD Struts Configuration 2.5//EN"
        "http://struts.apache.org/dtds/struts-2.5.dtd"&gt;</span>

<span class="nt">&lt;struts&gt;</span>
    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"default"</span> <span class="na">namespace=</span><span class="s">"/"</span> <span class="na">extends=</span><span class="s">"struts-default"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"downLoad"</span> <span class="na">class=</span><span class="s">"action.DownLoadAction"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--ç»“æœç±»å‹ä¸ºString--&gt;</span>
            <span class="nt">&lt;result</span> <span class="na">type=</span><span class="s">"stream"</span><span class="nt">&gt;</span>
				<span class="c">&lt;!--æŒ‡å®šè¢«ä¸‹è½½æ–‡ä»¶çš„æ–‡ä»¶ç±»å‹--&gt;</span>
                <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"contentType"</span><span class="nt">&gt;</span>${contentType}<span class="nt">&lt;/param&gt;</span>
                
                <span class="c">&lt;!--æŒ‡å®šè¢«ä¸‹è½½æ–‡ä»¶çš„å…¥å£è¾“å…¥æµ,é»˜è®¤å°±æ˜¯inputStream,å®ƒå°†ä¼šæŒ‡ç¤ºStreamResulté€šè¿‡
                  inputNameå±æ€§å€¼çš„getterå’Œsetteræ–¹æ³•ï¼Œå¦‚è¿™é‡Œå°±æ˜¯
                  getInputStream()æ¥è·å–ä¸‹è½½æ–‡ä»¶çš„å†…å®¹,æ„å‘³ç€Action
                  è¦æœ‰è¿™ä¸ªæ–¹æ³•
                  --&gt;</span>
                <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"inputName"</span><span class="nt">&gt;</span>inputStream<span class="nt">&lt;/param&gt;</span>
                
                 <span class="c">&lt;!--æŒ‡å®šä¸‹è½½çš„æ–‡ä»¶å,é»˜è®¤ä¸ºinlineï¼ˆåœ¨çº¿æ‰“å¼€ï¼‰,è®¾ç½®ä¸ºattachmentå°†ä¼šå‘Šè¯‰æµè§ˆå™¨ä¸‹è½½
                     è¯¥æ–‡ä»¶,filenameæŒ‡å®šä¸‹è½½æ–‡ä»¶æ—¶çš„æ–‡ä»¶åï¼Œè‹¥æœªæŒ‡å®šå°†ä¼šä»¥æµè§ˆå™¨
                     é¡µé¢åä½œä¸ºæ–‡ä»¶å,å¦‚ï¼šä»¥download.actionä½œä¸ºæ–‡ä»¶å
                   --&gt;</span>
                <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"contentDisposition"</span><span class="nt">&gt;</span>attachment;filename=${filename}<span class="nt">&lt;/param&gt;</span>
                
                <span class="c">&lt;!--æŒ‡å®šä¸‹è½½æ–‡ä»¶çš„ç¼“å†²å¤§å°--&gt;</span>
                <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"bufferSize"</span><span class="nt">&gt;</span>4096<span class="nt">&lt;/param&gt;</span>

            <span class="nt">&lt;/result&gt;</span>
        <span class="nt">&lt;/action&gt;</span>
    <span class="nt">&lt;/package&gt;</span>
</code></pre></div></div>

<h3 id="æ–‡ä»¶ä¸‹è½½æ¬¡æ•°">æ–‡ä»¶ä¸‹è½½æ¬¡æ•°</h3>

<ul>
  <li>struts.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="cp">&lt;!DOCTYPE struts PUBLIC
    "-//Apache Software Foundation//DTD Struts Configuration 2.0//EN"
    "http://struts.apache.org/dtds/struts-2.0.dtd"&gt;</span>

<span class="nt">&lt;struts&gt;</span>
    <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"default"</span> <span class="na">extends=</span><span class="s">"struts-default"</span><span class="nt">&gt;</span>    	
		<span class="nt">&lt;action</span> <span class="na">name=</span><span class="s">"downloadFileCount"</span> <span class="na">class=</span><span class="s">"example.struts2.DownloadFileCountAction"</span><span class="nt">&gt;</span>
			<span class="nt">&lt;result</span> <span class="na">name=</span><span class="s">"success"</span> <span class="na">type=</span><span class="s">"stream"</span><span class="nt">&gt;</span>
				<span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"contentType"</span><span class="nt">&gt;</span>${contentType}<span class="nt">&lt;/param&gt;</span>
				<span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"inputName"</span><span class="nt">&gt;</span>inputStream<span class="nt">&lt;/param&gt;</span>
				<span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"contentDisposition"</span><span class="nt">&gt;</span>
					attachment;filename=${fileName}
				<span class="nt">&lt;/param&gt;</span>
			<span class="nt">&lt;/result&gt;</span>
		<span class="nt">&lt;/action&gt;</span>
    <span class="nt">&lt;/package&gt;</span>
<span class="nt">&lt;/struts&gt;</span>

</code></pre></div></div>

<ul>
  <li>DownloadFileCountAction</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">example.struts2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.commons.io.FileUtils</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.struts2.ServletActionContext</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.opensymphony.xwork2.ActionSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadFileCountAction</span> <span class="kd">extends</span> <span class="nc">ActionSupport</span><span class="o">{</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">downloadPath</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">contentType</span><span class="o">;</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getDownloadPath</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">downloadPath</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDownloadPath</span><span class="o">(</span><span class="nc">String</span> <span class="n">downloadPath</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">downloadPath</span> <span class="o">=</span> <span class="n">downloadPath</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getContentType</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">contentType</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContentType</span><span class="o">(</span><span class="nc">String</span> <span class="n">contentType</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">contentType</span> <span class="o">=</span> <span class="n">contentType</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">getFileName</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">fileName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setFileNAme</span><span class="o">(</span><span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">execute</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="n">downloadPath</span><span class="o">=</span><span class="nc">ServletActionContext</span><span class="o">.</span><span class="na">getRequest</span><span class="o">().</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"download"</span><span class="o">);</span>
		<span class="kt">int</span> <span class="n">position</span><span class="o">=</span><span class="n">downloadPath</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"/"</span><span class="o">);</span>
		<span class="nc">String</span> <span class="n">downloadFilePath</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">position</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">fileName</span><span class="o">=</span><span class="n">downloadPath</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
			<span class="n">downloadFilePath</span><span class="o">=</span><span class="n">downloadPath</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">position</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">fileName</span><span class="o">=</span><span class="n">downloadPath</span><span class="o">;</span>
			<span class="n">downloadFilePath</span><span class="o">=</span><span class="s">""</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="kt">int</span> <span class="n">extPos</span><span class="o">=</span> <span class="n">fileName</span><span class="o">.</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">"."</span><span class="o">);</span>
		<span class="nc">String</span> <span class="n">contentTypeKey</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">extPos</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">contentTypeKey</span><span class="o">=</span><span class="s">"struts.contentType"</span><span class="o">+</span><span class="n">fileName</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">extPos</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">else</span> <span class="o">{</span>
			<span class="n">contentTypeKey</span><span class="o">=</span><span class="s">"struts.contentType.txt"</span><span class="o">;</span>
		<span class="o">}</span>
		
		<span class="n">contentType</span><span class="o">=</span><span class="n">getText</span><span class="o">(</span><span class="n">contentTypeKey</span><span class="o">);</span>
		<span class="nc">String</span> <span class="n">counterFile</span><span class="o">=</span> <span class="n">genNewFileName</span><span class="o">(</span><span class="n">downloadFilePath</span><span class="o">,</span><span class="n">fileName</span><span class="o">);</span>
		<span class="n">setDownloadCount</span><span class="o">(</span><span class="n">counterFile</span><span class="o">);</span>
		<span class="k">return</span> <span class="no">SUCCESS</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="nc">InputStream</span> <span class="nf">getInputStream</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="k">return</span> <span class="nc">ServletActionContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="n">downloadPath</span><span class="o">);</span>
		
	<span class="o">}</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="nf">genNewFileName</span><span class="o">(</span><span class="nc">String</span> <span class="n">filePath</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="nc">String</span> <span class="n">serverRealPath</span><span class="o">=</span><span class="nc">ServletActionContext</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="n">filePath</span><span class="o">)+</span><span class="s">"/DownloadCounter"</span><span class="o">;</span>
		<span class="nc">File</span>  <span class="n">dir</span><span class="o">=</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">serverRealPath</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">dir</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">dir</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>
		<span class="o">}</span>
		<span class="nc">String</span> <span class="n">downloadCountFile</span><span class="o">=</span><span class="n">serverRealPath</span><span class="o">+</span><span class="n">fileName</span><span class="o">+</span><span class="s">".txt"</span><span class="o">;</span>
		<span class="k">return</span> <span class="n">downloadCountFile</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="kd">private</span> <span class="kt">void</span> <span class="nf">setDownloadCount</span><span class="o">(</span><span class="nc">String</span> <span class="n">fullFileName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="c1">// TODO Auto-generated method stub</span>
		<span class="kt">int</span> <span class="n">curCount</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span>
		<span class="nc">File</span> <span class="n">file</span><span class="o">=</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fullFileName</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">curCount</span><span class="o">=</span><span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="nc">FileUtils</span><span class="o">.</span><span class="na">readFileToString</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">fullFileName</span><span class="o">)))+</span><span class="mi">1</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="nc">FileUtils</span><span class="o">.</span><span class="na">writeStringToFile</span><span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">curCount</span><span class="o">));</span>
		
	<span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>åœ¨webRootç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶å¤¹Uploadï¼Œåœ¨æ–‡ä»¶å¤¹é‡Œåˆ›å»ºæ–‡ä»¶Readme.txt</li>
  <li>å¯åŠ¨é¡¹ç›®è®¿é—®<code class="language-plaintext highlighter-rouge">downloadFileCount?download=/Upload/Readme.txt</code></li>
</ul>
:ET