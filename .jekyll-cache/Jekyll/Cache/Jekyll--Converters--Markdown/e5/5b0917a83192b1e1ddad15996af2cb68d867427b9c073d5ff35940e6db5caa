I"—º<ul id="markdown-toc">
  <li><a href="#é›†æˆspringboot" id="markdown-toc-é›†æˆspringboot">é›†æˆspringboot</a>    <ul>
      <li><a href="#pom" id="markdown-toc-pom">pom</a></li>
      <li><a href="#springå®¹å™¨" id="markdown-toc-springå®¹å™¨">springå®¹å™¨</a></li>
      <li><a href="#servlet-contexté…ç½®" id="markdown-toc-servlet-contexté…ç½®">Servlet Contexté…ç½®</a></li>
      <li><a href="#å®‰å…¨é…ç½®" id="markdown-toc-å®‰å…¨é…ç½®">å®‰å…¨é…ç½®</a></li>
      <li><a href="#controller" id="markdown-toc-controller">controller</a></li>
    </ul>
  </li>
  <li><a href="#å·¥ä½œåŸç†" id="markdown-toc-å·¥ä½œåŸç†">å·¥ä½œåŸç†</a>    <ul>
      <li><a href="#ç»“æ„æ€»è§ˆ" id="markdown-toc-ç»“æ„æ€»è§ˆ">ç»“æ„æ€»è§ˆ</a></li>
      <li><a href="#è®¤è¯æµç¨‹" id="markdown-toc-è®¤è¯æµç¨‹">è®¤è¯æµç¨‹</a></li>
      <li><a href="#authenticationprovider" id="markdown-toc-authenticationprovider">AuthenticationProvider</a></li>
      <li><a href="#userdetailsservice" id="markdown-toc-userdetailsservice">UserDetailsService</a></li>
      <li><a href="#passwordencoder" id="markdown-toc-passwordencoder">PasswordEncoder</a></li>
    </ul>
  </li>
  <li><a href="#æˆæƒæµç¨‹" id="markdown-toc-æˆæƒæµç¨‹">æˆæƒæµç¨‹</a></li>
</ul>
<h3 id="é›†æˆspringboot">é›†æˆspringboot</h3>

<ul>
  <li>åˆ›å»ºmavenå·¥ç¨‹ security-spring-boot</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/mDw8r6jTY4o3UFB.png" alt="image.png" /></p>

<h4 id="pom">pom</h4>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>security-springboot<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.1.3.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯&gt;spring bootä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯&gt;spring securityä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="c">&lt;!-- ä»¥ä¸‹æ˜¯jspä¾èµ–--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--jspé¡µé¢ä½¿ç”¨jstlæ ‡ç­¾ --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>jstl<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-tomcat<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--ç”¨äºç¼–è¯‘jsp --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.embed<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>tomcat-embed-jasper<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
         <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.18.0<span class="nt">&lt;/version&gt;</span>
          <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;finalName&gt;</span>security-springboot<span class="nt">&lt;/finalName&gt;</span>
        <span class="nt">&lt;pluginManagement&gt;</span>
            <span class="nt">&lt;plugins&gt;</span>
                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.tomcat.maven<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>tomcat7-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;version&gt;</span>2.2<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>
                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;configuration&gt;</span>
                        <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
                        <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
                    <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>

                <span class="nt">&lt;plugin&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
                    <span class="nt">&lt;configuration&gt;</span>
                        <span class="nt">&lt;encoding&gt;</span>utf-8<span class="nt">&lt;/encoding&gt;</span>
                        <span class="nt">&lt;useDefaultDelimiters&gt;</span>true<span class="nt">&lt;/useDefaultDelimiters&gt;</span>
                        <span class="nt">&lt;resources&gt;</span>
                            <span class="nt">&lt;resource&gt;</span>
                                <span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
                                <span class="nt">&lt;filtering&gt;</span>true<span class="nt">&lt;/filtering&gt;</span>
                                <span class="nt">&lt;includes&gt;</span>
                                    <span class="nt">&lt;include&gt;</span>**/*<span class="nt">&lt;/include&gt;</span>
                                <span class="nt">&lt;/includes&gt;</span>
                            <span class="nt">&lt;/resource&gt;</span>
                            <span class="nt">&lt;resource&gt;</span>
                                <span class="nt">&lt;directory&gt;</span>src/main/java<span class="nt">&lt;/directory&gt;</span>
                                <span class="nt">&lt;includes&gt;</span>
                                    <span class="nt">&lt;include&gt;</span>**/*.xml<span class="nt">&lt;/include&gt;</span>
                                <span class="nt">&lt;/includes&gt;</span>
                            <span class="nt">&lt;/resource&gt;</span>
                        <span class="nt">&lt;/resources&gt;</span>
                    <span class="nt">&lt;/configuration&gt;</span>
                <span class="nt">&lt;/plugin&gt;</span>
            <span class="nt">&lt;/plugins&gt;</span>
        <span class="nt">&lt;/pluginManagement&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<h4 id="springå®¹å™¨">springå®¹å™¨</h4>

<ul>
  <li>SpringBootå·¥ç¨‹å¯åŠ¨ä¼šè‡ªåŠ¨æ‰«æå¯åŠ¨ç±»æ‰€åœ¨åŒ…ä¸‹çš„æ‰€æœ‰Beanï¼ŒåŠ è½½åˆ°springå®¹å™¨ã€‚</li>
  <li>1ï¼‰Spring Booté…ç½®æ–‡ä»¶ï¼šåœ¨resourcesä¸‹æ·»åŠ application.properties</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">server.port</span><span class="p">=</span><span class="s">8080</span>
<span class="py">server.servlet.context-path</span><span class="p">=</span><span class="s">/security-springboot</span>
<span class="py">spring.application.name</span> <span class="p">=</span> <span class="s">security-springboot</span>
</code></pre></div></div>

<ul>
  <li>2ï¼‰Spring Boot å¯åŠ¨ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SecuritySpringBootApp</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SecuritySpringBootApp</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="servlet-contexté…ç½®">Servlet Contexté…ç½®</h4>

<ul>
  <li>ç”±äºSpring boot starterè‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œè¿™é‡Œæ— éœ€ä½¿ç”¨@EnableWebMvcä¸@ComponentScanï¼ŒWebConfigå¦‚ä¸‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>

    <span class="c1">//é»˜è®¤Urlæ ¹è·¯å¾„è·³è½¬åˆ°/loginï¼Œæ­¤urlä¸ºspring securityæä¾›</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addViewControllers</span><span class="o">(</span><span class="nc">ViewControllerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addViewController</span><span class="o">(</span><span class="s">"/"</span><span class="o">).</span><span class="na">setViewName</span><span class="o">(</span><span class="s">"redirect:/login"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è§†å›¾è§£æå™¨é…ç½®åœ¨application.propertiesä¸­</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.mvc.view.prefix</span><span class="p">=</span><span class="s">/WEB-INF/views/</span>
<span class="py">spring.mvc.view.suffix</span><span class="p">=</span><span class="s">.jsp</span>
</code></pre></div></div>

<h4 id="å®‰å…¨é…ç½®">å®‰å…¨é…ç½®</h4>

<ul>
  <li>ç”±äºSpring boot starterè‡ªåŠ¨è£…é…æœºåˆ¶ï¼Œè¿™é‡Œæ— éœ€ä½¿ç”¨@EnableWebSecurityï¼ŒWebSecurityConfigå†…å®¹å¦‚ä¸‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>
<span class="c1">//é…ç½®ç”¨æˆ·ä¿¡æ¯æœåŠ¡</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">UserDetailsService</span> <span class="nf">userDetailsService</span><span class="o">()</span>  <span class="o">{</span>
        <span class="c1">//åœ¨userDetailsService()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è¿”å›äº†ä¸€ä¸ªUserDetailsServiceç»™springå®¹å™¨ï¼ŒSpring Securityä¼šä½¿ç”¨å®ƒæ¥è·å–ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬æš‚æ—¶ä½¿ç”¨InMemoryUserDetailsManagerå®ç°ç±»ï¼Œå¹¶åœ¨å…¶ä¸­åˆ†åˆ«åˆ›å»ºäº†zhangsanã€lisiä¸¤ä¸ªç”¨æˆ·ï¼Œå¹¶è®¾ç½®å¯†ç å’Œæƒé™ã€‚</span>
        <span class="nc">InMemoryUserDetailsManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InMemoryUserDetailsManager</span><span class="o">();</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
        <span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"lisi"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"456"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p2"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">manager</span><span class="o">;</span>
<span class="o">}</span>
    <span class="c1">//å¯†ç ç¼–ç å™¨</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//å…ˆä½¿ç”¨ä¸åŠ å¯†çš„å¯†ç ç¼–ç å™¨</span>
        <span class="k">return</span>  <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//é…ç½®å®‰å…¨æ‹¦æˆªæœºåˆ¶</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span> <span class="c1">//æ‰€æœ‰çš„/r/**è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span>             <span class="c1">//é™¤äº†/r/**ä»¥å¤–çš„è¯·æ±‚éƒ½å¯ä»¥ç›´æ¥è®¿é—®</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span><span class="c1">//å…è®¸è¡¨å•ç™»å½•</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">().</span><span class="na">successForwardUrl</span><span class="o">(</span><span class="s">"/login-success"</span><span class="o">);</span><span class="c1">//è‡ªå®šä¹‰ç™»å½•æˆåŠŸåçš„è·³è½¬åœ°å€</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="controller">controller</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/login-success"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">loginSuccess</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" ç™»å½•æˆåŠŸ"</span><span class="o">;</span>
<span class="o">}</span>
<span class="cm">/**
 * æµ‹è¯•èµ„æº1
 * @return
 */</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r1"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">r1</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" è®¿é—®èµ„æº1"</span><span class="o">;</span>
<span class="o">}</span>

<span class="cm">/**
 * æµ‹è¯•èµ„æº2
 * @return
 */</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r/r2"</span><span class="o">,</span><span class="n">produces</span> <span class="o">=</span> <span class="o">{</span><span class="s">"text/plain;charset=UTF-8"</span><span class="o">})</span>
<span class="kd">public</span> <span class="nc">String</span> <span class="nf">r2</span><span class="o">(){</span>
    <span class="k">return</span> <span class="s">" è®¿é—®èµ„æº2"</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å·¥ä½œåŸç†">å·¥ä½œåŸç†</h3>

<h4 id="ç»“æ„æ€»è§ˆ">ç»“æ„æ€»è§ˆ</h4>

<ul>
  <li>Spring Securityæ‰€è§£å†³çš„é—®é¢˜å°±æ˜¯<strong>å®‰å…¨è®¿é—®æ§åˆ¶</strong>ï¼Œè€Œå®‰å…¨è®¿é—®æ§åˆ¶åŠŸèƒ½å…¶å®å°±æ˜¯å¯¹æ‰€æœ‰è¿›å…¥ç³»ç»Ÿçš„è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œæ ¡éªŒæ¯ä¸ªè¯·æ±‚æ˜¯å¦èƒ½å¤Ÿè®¿é—®å®ƒæ‰€æœŸæœ›çš„èµ„æºã€‚</li>
  <li>å¯ä»¥é€šè¿‡Filteræˆ–AOPç­‰æŠ€æœ¯æ¥å®ç°ï¼ŒSpring Securityå¯¹Webèµ„æºçš„ä¿æŠ¤æ˜¯é Filterå®ç°çš„</li>
  <li>å½“åˆå§‹åŒ–Spring Securityæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º<code class="language-plaintext highlighter-rouge">SpringSecurityFilterChain</code>çš„Servletè¿‡æ»¤å™¨ï¼Œç±»å‹ä¸º org.springframework.security.web.FilterChainProxyï¼Œå®ƒå®ç°äº†javax.servlet.Filterï¼Œå› æ­¤å¤–éƒ¨çš„è¯·æ±‚ä¼šç»è¿‡æ­¤ç±»</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/UXrMlHCoE5iPnOg.png" alt="image.png" /></p>

<ul>
  <li>FilterChainProxyæ˜¯ä¸€ä¸ªä»£ç†ï¼ŒçœŸæ­£èµ·ä½œç”¨çš„æ˜¯FilterChainProxyä¸­SecurityFilterChainæ‰€åŒ…å«çš„å„ä¸ªFilter</li>
  <li>åŒæ—¶è¿™äº›Filterä½œä¸ºBeanè¢«Springç®¡ç†ï¼Œå®ƒä»¬æ˜¯Spring Securityæ ¸å¿ƒï¼Œå„æœ‰å„çš„èŒè´£ï¼Œä½†ä»–ä»¬å¹¶ä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>è®¤è¯</strong>ï¼Œä¹Ÿä¸ç›´æ¥å¤„ç†ç”¨æˆ·çš„<strong>æˆæƒ</strong>ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬äº¤ç»™äº†<strong>è®¤è¯ç®¡ç†å™¨</strong>ï¼ˆAuthenticationManagerï¼‰å’Œ<strong>å†³ç­–ç®¡ç†å™¨</strong>ï¼ˆAccessDecisionManagerï¼‰è¿›è¡Œå¤„ç†</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/3JWCQYZ74KFfomy.png" alt="image.png" /></p>

<ul>
  <li><strong>SecurityContextPersistenceFilter</strong> ï¼šè¿™ä¸ªFilteræ˜¯æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹çš„å…¥å£å’Œå‡ºå£ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªæ‹¦æˆªå™¨ï¼‰ï¼Œä¼šåœ¨è¯·æ±‚å¼€å§‹æ—¶ä»é…ç½®å¥½çš„ SecurityContextRepository ä¸­è·å– SecurityContextï¼Œç„¶åæŠŠå®ƒè®¾ç½®ç»™ SecurityContextHolderã€‚åœ¨è¯·æ±‚å®Œæˆåå°† SecurityContextHolder æŒæœ‰çš„ SecurityContext å†ä¿å­˜åˆ°é…ç½®å¥½çš„ SecurityContextRepositoryï¼ŒåŒæ—¶æ¸…é™¤ securityContextHolder æ‰€æŒæœ‰çš„ SecurityContextï¼›</li>
  <li><strong>UsernamePasswordAuthenticationFilter</strong> ç”¨äºå¤„ç†æ¥è‡ªè¡¨å•æäº¤çš„è®¤è¯ã€‚è¯¥è¡¨å•å¿…é¡»æä¾›å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå…¶å†…éƒ¨è¿˜æœ‰ç™»å½•æˆåŠŸæˆ–å¤±è´¥åè¿›è¡Œå¤„ç†çš„ AuthenticationSuccessHandler å’Œ AuthenticationFailureHandlerï¼Œè¿™äº›éƒ½å¯ä»¥æ ¹æ®éœ€æ±‚åšç›¸å…³æ”¹å˜ï¼›</li>
  <li><strong>FilterSecurityInterceptor</strong> æ˜¯ç”¨äºä¿æŠ¤webèµ„æºçš„ï¼Œä½¿ç”¨AccessDecisionManagerå¯¹å½“å‰ç”¨æˆ·è¿›è¡Œæˆæƒè®¿é—®</li>
  <li><strong>ExceptionTranslationFilter</strong> èƒ½å¤Ÿæ•è·æ¥è‡ª FilterChain æ‰€æœ‰çš„å¼‚å¸¸ï¼Œå¹¶è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å®ƒåªä¼šå¤„ç†ä¸¤ç±»å¼‚å¸¸ï¼šAuthenticationException å’Œ AccessDeniedExceptionï¼Œå…¶å®ƒçš„å¼‚å¸¸å®ƒä¼šç»§ç»­æŠ›å‡ºã€‚</li>
</ul>

<h4 id="è®¤è¯æµç¨‹">è®¤è¯æµç¨‹</h4>

<p><img src="https://i.loli.net/2020/02/22/rdeuIJ8gGq6DKom.png" alt="image.png" /></p>

<ul>
  <li>ä»”ç»†åˆ†æè®¤è¯è¿‡ç¨‹ï¼š
    <ul>
      <li>ç”¨æˆ·æäº¤ç”¨æˆ·åã€å¯†ç è¢«SecurityFilterChainä¸­çš„<code class="language-plaintext highlighter-rouge">UsernamePasswordAuthenticationFilter</code>è¿‡æ»¤å™¨è·å–åˆ°ï¼Œå°è£…ä¸ºè¯·æ±‚Authenticationï¼Œé€šå¸¸æƒ…å†µä¸‹æ˜¯UsernamePasswordAuthenticationTokenè¿™ä¸ªå®ç°ç±»</li>
      <li>ç„¶åè¿‡æ»¤å™¨å°†Authenticationæäº¤è‡³è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰è¿›è¡Œè®¤è¯</li>
      <li>è®¤è¯æˆåŠŸåï¼Œ<code class="language-plaintext highlighter-rouge">AuthenticationManager</code>èº«ä»½ç®¡ç†å™¨è¿”å›ä¸€ä¸ªè¢«å¡«å……æ»¡äº†ä¿¡æ¯çš„ï¼ˆåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æƒé™ä¿¡æ¯ï¼Œèº«ä»½ä¿¡æ¯ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œä½†å¯†ç é€šå¸¸ä¼šè¢«ç§»é™¤ï¼‰<code class="language-plaintext highlighter-rouge">Authentication</code>å®ä¾‹</li>
      <li><code class="language-plaintext highlighter-rouge">SecurityContextHolder</code>å®‰å…¨ä¸Šä¸‹æ–‡å®¹å™¨å°†ç¬¬3æ­¥å¡«å……äº†ä¿¡æ¯çš„<code class="language-plaintext highlighter-rouge">Authentication</code>ï¼Œé€šè¿‡SecurityContextHolder.getContext().setAuthentication(â€¦)æ–¹æ³•ï¼Œè®¾ç½®åˆ°å…¶ä¸­ã€‚</li>
    </ul>
  </li>
  <li>å¯ä»¥çœ‹å‡ºAuthenticationManageræ¥å£ï¼ˆè®¤è¯ç®¡ç†å™¨ï¼‰æ˜¯è®¤è¯ç›¸å…³çš„æ ¸å¿ƒæ¥å£ï¼Œä¹Ÿæ˜¯å‘èµ·è®¤è¯çš„å‡ºå‘ç‚¹ï¼Œå®ƒçš„å®ç°ç±»ä¸ºProviderManagerã€‚è€ŒSpring Securityæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œå› æ­¤ProviderManagerç»´æŠ¤ç€ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">List&lt;AuthenticationProvider&gt;</code>åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œæœ€ç»ˆå®é™…çš„è®¤è¯å·¥ä½œæ˜¯ç”±AuthenticationProviderå®Œæˆçš„ã€‚</li>
  <li>webè¡¨å•çš„å¯¹åº”çš„AuthenticationProviderå®ç°ç±»ä¸ºDaoAuthenticationProviderï¼Œå®ƒçš„å†…éƒ¨åˆç»´æŠ¤ç€ä¸€ä¸ªUserDetailsServiceè´Ÿè´£UserDetailsçš„è·å–ã€‚æœ€ç»ˆAuthenticationProviderå°†UserDetailså¡«å……è‡³Authenticationã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/FqVJ4PhoX3bAs5L.png" alt="image.png" /></p>

<h4 id="authenticationprovider">AuthenticationProvider</h4>

<ul>
  <li>
    <p>è®¤è¯ç®¡ç†å™¨ï¼ˆAuthenticationManagerï¼‰å§”æ‰˜AuthenticationProviderå®Œæˆè®¤è¯å·¥ä½œã€‚</p>
  </li>
  <li>
    <p>AuthenticationProvideræ˜¯ä¸€ä¸ªæ¥å£</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationProvider</span> <span class="o">{</span>
    <span class="nc">Authentication</span> <span class="nf">authenticate</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">;</span>
    <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">var1</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li><strong>authenticate</strong>()æ–¹æ³•å®šä¹‰äº†<strong>è®¤è¯çš„å®ç°è¿‡ç¨‹</strong>ï¼Œå®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢åŒ…å«äº†ç™»å½•ç”¨æˆ·æ‰€æäº¤çš„ç”¨æˆ·ã€å¯†ç ç­‰ã€‚è€Œè¿”å›å€¼ä¹Ÿæ˜¯ä¸€ä¸ªAuthenticationï¼Œè¿™ä¸ªAuthenticationåˆ™æ˜¯åœ¨è®¤è¯æˆåŠŸåï¼Œå°†ç”¨æˆ·çš„æƒé™åŠå…¶ä»–ä¿¡æ¯é‡æ–°ç»„è£…åç”Ÿæˆã€‚</li>
    </ul>
  </li>
  <li>Spring Securityä¸­ç»´æŠ¤ç€ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">List&lt;AuthenticationProvider&gt;</code>åˆ—è¡¨ï¼Œå­˜æ”¾å¤šç§è®¤è¯æ–¹å¼ï¼Œä¸åŒçš„è®¤è¯æ–¹å¼ä½¿ç”¨ä¸åŒçš„AuthenticationProviderã€‚å¦‚ä½¿ç”¨ç”¨æˆ·åå¯†ç ç™»å½•æ—¶ï¼Œä½¿ç”¨AuthenticationProvider1ï¼ŒçŸ­ä¿¡ç™»å½•æ—¶ä½¿ç”¨AuthenticationProvider2ç­‰ç­‰è¿™æ ·çš„ä¾‹å­å¾ˆå¤šã€‚</li>
  <li>æ¯ä¸ªAuthenticationProvideréœ€è¦å®ç°<strong>supportsï¼ˆï¼‰</strong>æ–¹æ³•æ¥è¡¨æ˜è‡ªå·±æ”¯æŒçš„è®¤è¯æ–¹å¼ï¼Œå¦‚æˆ‘ä»¬ä½¿ç”¨è¡¨å•æ–¹å¼è®¤è¯ï¼Œåœ¨æäº¤è¯·æ±‚æ—¶Spring Securityä¼šç”ŸæˆUsernamePasswordAuthenticationTokenï¼Œå®ƒæ˜¯ä¸€ä¸ªAuthenticationï¼Œé‡Œé¢å°è£…ç€ç”¨æˆ·æäº¤çš„ç”¨æˆ·åã€å¯†ç ä¿¡æ¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//DaoAuthenticationProviderçš„åŸºç±»AbstractUserDetailsAuthenticationProvider</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">authentication</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>ä¹Ÿå°±æ˜¯è¯´å½“webè¡¨å•æäº¤ç”¨æˆ·åå¯†ç æ—¶ï¼ŒSpring Securityç”±DaoAuthenticationProviderå¤„ç†ã€‚</strong></li>
  <li>Authenticationæ˜¯spring securityåŒ…ä¸­çš„æ¥å£ï¼Œç›´æ¥ç»§æ‰¿è‡ªPrincipalç±»ï¼Œè€ŒPrincipalæ˜¯ä½äº<code class="language-plaintext highlighter-rouge">java.security</code>åŒ…ä¸­çš„ã€‚å®ƒæ˜¯è¡¨ç¤ºç€ä¸€ä¸ªæŠ½è±¡ä¸»ä½“èº«ä»½ï¼Œä»»ä½•ä¸»ä½“éƒ½æœ‰ä¸€ä¸ªåç§°ï¼Œå› æ­¤åŒ…å«ä¸€ä¸ªgetName()æ–¹æ³•ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Authentication</span> <span class="kd">extends</span> <span class="nc">Principal</span><span class="o">,</span> <span class="nc">Serializable</span> <span class="o">{</span>         <span class="err">ï¼ˆ</span><span class="mi">1</span><span class="err">ï¼‰</span>
 
    <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>              <span class="err">ï¼ˆ</span><span class="mi">2</span><span class="err">ï¼‰</span>
    
  	<span class="nc">Object</span> <span class="nf">getCredentials</span><span class="o">();</span>										  <span class="err">ï¼ˆ</span><span class="mi">3</span><span class="err">ï¼‰</span>				

    <span class="nc">Object</span> <span class="nf">getDetails</span><span class="o">();</span>                                                  <span class="err">ï¼ˆ</span><span class="mi">4</span><span class="err">ï¼‰</span>

    <span class="nc">Object</span> <span class="nf">getPrincipal</span><span class="o">();</span>                                                <span class="err">ï¼ˆ</span><span class="mi">5</span><span class="err">ï¼‰</span>

    <span class="kt">boolean</span> <span class="nf">isAuthenticated</span><span class="o">();</span>                                            

    <span class="kt">void</span> <span class="nf">setAuthenticated</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">var1</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IllegalArgumentException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ï¼ˆ2ï¼‰getAuthorities()ï¼Œæƒé™ä¿¡æ¯åˆ—è¡¨ï¼Œé»˜è®¤æ˜¯GrantedAuthorityæ¥å£çš„ä¸€äº›å®ç°ç±»ï¼Œé€šå¸¸æ˜¯ä»£è¡¨æƒé™ä¿¡æ¯çš„ä¸€ç³»åˆ—å­—ç¬¦ä¸²ã€‚</li>
  <li>ï¼ˆ3ï¼‰getCredentials()ï¼Œå‡­è¯ä¿¡æ¯ï¼Œç”¨æˆ·è¾“å…¥çš„å¯†ç å­—ç¬¦ä¸²ï¼Œåœ¨è®¤è¯è¿‡åé€šå¸¸ä¼šè¢«ç§»é™¤ï¼Œç”¨äºä¿éšœå®‰å…¨ã€‚</li>
  <li>ï¼ˆ4ï¼‰getDetails()ï¼Œç»†èŠ‚ä¿¡æ¯ï¼Œwebåº”ç”¨ä¸­çš„å®ç°æ¥å£é€šå¸¸ä¸º WebAuthenticationDetailsï¼Œå®ƒè®°å½•äº†è®¿é—®è€…çš„ipåœ°å€å’ŒsessionIdçš„å€¼ã€‚</li>
  <li>ï¼ˆ5ï¼‰<strong>getPrincipal()</strong>ï¼Œèº«ä»½ä¿¡æ¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿”å›çš„æ˜¯UserDetailsæ¥å£çš„å®ç°ç±»ï¼ŒUserDetailsä»£è¡¨ç”¨æˆ·çš„è¯¦ç»†ä¿¡æ¯ï¼Œé‚£ä»Authenticationä¸­å–å‡ºæ¥çš„UserDetailså°±æ˜¯å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå®ƒä¹Ÿæ˜¯æ¡†æ¶ä¸­çš„å¸¸ç”¨æ¥å£ä¹‹ä¸€ã€‚</li>
</ul>

<h4 id="userdetailsservice">UserDetailsService</h4>

<ul>
  <li>å’±ä»¬ç°åœ¨çŸ¥é“DaoAuthenticationProviderå¤„ç†äº†webè¡¨å•çš„è®¤è¯é€»è¾‘ï¼Œè®¤è¯æˆåŠŸåæ—¢å¾—åˆ°ä¸€ä¸ªAuthentication(UsernamePasswordAuthenticationTokenå®ç°)ï¼Œé‡Œé¢åŒ…å«äº†èº«ä»½ä¿¡æ¯ï¼ˆPrincipalï¼‰ã€‚è¿™ä¸ªèº«ä»½ä¿¡æ¯å°±æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Object</code> ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹å®ƒå¯ä»¥è¢«å¼ºè½¬ä¸ºUserDetailså¯¹è±¡ã€‚</li>
  <li>DaoAuthenticationProviderä¸­åŒ…å«äº†ä¸€ä¸ªUserDetailsServiceå®ä¾‹ï¼Œå®ƒè´Ÿè´£æ ¹æ®ç”¨æˆ·åæå–ç”¨æˆ·ä¿¡æ¯UserDetails(åŒ…å«å¯†ç )ï¼Œè€ŒåDaoAuthenticationProviderä¼šå»å¯¹æ¯”UserDetailsServiceæå–çš„ç”¨æˆ·å¯†ç ä¸ç”¨æˆ·æäº¤çš„å¯†ç æ˜¯å¦åŒ¹é…ä½œä¸ºè®¤è¯æˆåŠŸçš„å…³é”®ä¾æ®ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å°†è‡ªå®šä¹‰çš„<code class="language-plaintext highlighter-rouge">UserDetailsService</code>å…¬å¼€ä¸ºspring beanæ¥å®šä¹‰è‡ªå®šä¹‰èº«ä»½éªŒè¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>    
	<span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>UserDetailsServiceåªè´Ÿè´£ä»ç‰¹å®šçš„åœ°æ–¹ï¼ˆé€šå¸¸æ˜¯æ•°æ®åº“ï¼‰åŠ è½½ç”¨æˆ·ä¿¡æ¯ï¼Œä»…æ­¤è€Œå·²ã€‚è€ŒDaoAuthenticationProviderçš„èŒè´£æ›´å¤§ï¼Œå®ƒå®Œæˆå®Œæ•´çš„è®¤è¯æµç¨‹ï¼ŒåŒæ—¶ä¼šæŠŠUserDetailså¡«å……è‡³Authenticationã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDetails</span> <span class="kd">extends</span> <span class="nc">Serializable</span> <span class="o">{</span>

   <span class="nc">Collection</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">GrantedAuthority</span><span class="o">&gt;</span> <span class="nf">getAuthorities</span><span class="o">();</span>

   <span class="nc">String</span> <span class="nf">getPassword</span><span class="o">();</span>

   <span class="nc">String</span> <span class="nf">getUsername</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">();</span>

   <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Authenticationçš„getCredentials()ä¸UserDetailsä¸­çš„getPassword()éœ€è¦è¢«åŒºåˆ†å¯¹å¾…ï¼Œå‰è€…æ˜¯ç”¨æˆ·æäº¤çš„å¯†ç å‡­è¯ï¼Œåè€…æ˜¯ç”¨æˆ·å®é™…å­˜å‚¨çš„å¯†ç ï¼Œè®¤è¯å…¶å®å°±æ˜¯å¯¹è¿™ä¸¤è€…çš„æ¯”å¯¹ã€‚</li>
  <li>Authenticationä¸­çš„getAuthorities()å®é™…æ˜¯ç”±UserDetailsçš„getAuthorities()ä¼ é€’è€Œå½¢æˆçš„ã€‚</li>
  <li>é€šè¿‡å®ç°UserDetailsServiceå’ŒUserDetailsï¼Œæˆ‘ä»¬å¯ä»¥å®Œæˆå¯¹ç”¨æˆ·ä¿¡æ¯è·å–æ–¹å¼ä»¥åŠç”¨æˆ·ä¿¡æ¯å­—æ®µçš„æ‰©å±•</li>
  <li>Spring Securityæä¾›çš„InMemoryUserDetailsManager(å†…å­˜è®¤è¯)ï¼ŒJdbcUserDetailsManager(jdbcè®¤è¯)å°±æ˜¯UserDetailsServiceçš„å®ç°ç±»ï¼Œä¸»è¦åŒºåˆ«æ— éå°±æ˜¯ä»å†…å­˜è¿˜æ˜¯ä»æ•°æ®åº“åŠ è½½ç”¨æˆ·ã€‚</li>
  <li>è‡ªå®šä¹‰UserDetailsService</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringDataUserDetailsService</span> <span class="kd">implements</span> <span class="nc">UserDetailsService</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
        <span class="c1">//ç™»å½•è´¦å·</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"username="</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
        <span class="c1">//æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...</span>
        <span class="c1">//è¿™é‡Œæš‚æ—¶ä½¿ç”¨é™æ€æ•°æ®</span>
        <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="n">username</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"123"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="c1">//å±è”½å®‰å…¨é…ç½®ç±»ä¸­UserDetailsServiceçš„å®šä¹‰</span>
<span class="cm">/*    @Bean
    public UserDetailsService userDetailsService()  {
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        manager.createUser(User.withUsername("zhangsan").password("123").authorities("p1").build());
        manager.createUser(User.withUsername("lisi").password("456").authorities("p2").build());
        return manager;
}*/</span>
</code></pre></div></div>

<h4 id="passwordencoder">PasswordEncoder</h4>

<ul>
  <li>Spring Securityä¸ºäº†é€‚åº”å¤šç§å¤šæ ·çš„åŠ å¯†ç±»å‹ï¼Œåˆåšäº†æŠ½è±¡ï¼ŒDaoAuthenticationProvideré€šè¿‡PasswordEncoderæ¥å£çš„matchesæ–¹æ³•è¿›è¡Œå¯†ç çš„å¯¹æ¯”ï¼Œè€Œå…·ä½“çš„å¯†ç å¯¹æ¯”ç»†èŠ‚å–å†³äºå®ç°ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PasswordEncoder</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">encode</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">var1</span><span class="o">);</span>

    <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="nc">CharSequence</span> <span class="n">var1</span><span class="o">,</span> <span class="nc">String</span> <span class="n">var2</span><span class="o">);</span>

    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">upgradeEncoding</span><span class="o">(</span><span class="nc">String</span> <span class="n">encodedPassword</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è€ŒSpring Securityæä¾›å¾ˆå¤šå†…ç½®çš„PasswordEncoderï¼Œèƒ½å¤Ÿå¼€ç®±å³ç”¨ï¼Œä½¿ç”¨æŸç§PasswordEncoderåªéœ€è¦è¿›è¡Œå¦‚ä¸‹å£°æ˜å³å¯ï¼Œå¦‚ä¸‹ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span>  <span class="nc">NoOpPasswordEncoder</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>NoOpPasswordEncoderé‡‡ç”¨å­—ç¬¦ä¸²åŒ¹é…æ–¹æ³•ï¼Œä¸å¯¹å¯†ç è¿›è¡ŒåŠ å¯†æ¯”è¾ƒå¤„ç†ï¼Œå¯†ç æ¯”è¾ƒæµç¨‹å¦‚ä¸‹ï¼š
    <ul>
      <li>1ã€ç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆæ˜æ–‡ ï¼‰</li>
      <li>2ã€DaoAuthenticationProviderè·å–UserDetailsï¼ˆå…¶ä¸­å­˜å‚¨äº†ç”¨æˆ·çš„æ­£ç¡®å¯†ç ï¼‰</li>
      <li>3ã€DaoAuthenticationProviderä½¿ç”¨PasswordEncoderå¯¹è¾“å…¥çš„å¯†ç å’Œæ­£ç¡®çš„å¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¯†ç ä¸€è‡´åˆ™æ ¡éªŒé€šè¿‡ï¼Œå¦åˆ™æ ¡éªŒå¤±è´¥ã€‚</li>
    </ul>
  </li>
  <li>
    <p>å®é™…é¡¹ç›®ä¸­æ¨èä½¿ç”¨BCryptPasswordEncoder, Pbkdf2PasswordEncoder, SCryptPasswordEncoderç­‰</p>
  </li>
  <li>
    <p>ä½¿ç”¨BCryptPasswordEncoder</p>

    <ul>
      <li>1ã€åœ¨å®‰å…¨é…ç½®ç±»ä¸­é…ç½®BCryptPasswordEncoder</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>æ·»åŠ ä¾èµ–ï¼š</li>
    </ul>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div>    </div>

    <ul>
      <li>æµ‹è¯•</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBCrypt</span> <span class="o">{</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
        <span class="c1">//å¯¹åŸå§‹å¯†ç åŠ å¯†</span>
        <span class="nc">String</span> <span class="n">hashpw</span> <span class="o">=</span> <span class="nc">BCrypt</span><span class="o">.</span><span class="na">hashpw</span><span class="o">(</span><span class="s">"123"</span><span class="o">,</span><span class="nc">BCrypt</span><span class="o">.</span><span class="na">gensalt</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">hashpw</span><span class="o">);</span>
        <span class="c1">//æ ¡éªŒåŸå§‹å¯†ç å’ŒBCryptå¯†ç æ˜¯å¦ä¸€è‡´</span>
        <span class="kt">boolean</span> <span class="n">checkpw</span> <span class="o">=</span> <span class="nc">BCrypt</span><span class="o">.</span><span class="na">checkpw</span><span class="o">(</span><span class="s">"123"</span><span class="o">,</span> <span class="s">"$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">checkpw</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>

    <ul>
      <li>ä¿®æ”¹å®‰å…¨é…ç½®ç±»ï¼Œå®é™…é¡¹ç›®ä¸­å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç å¹¶ä¸æ˜¯åŸå§‹å¯†ç ï¼Œéƒ½æ˜¯ç»è¿‡åŠ å¯†å¤„ç†çš„å¯†ç ã€‚</li>
    </ul>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">manager</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="s">"zhangsan"</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="s">"$2a$10$1b5mIkehqv5c4KRrX9bUj.A4Y2hug3IGCnMCL5i4RpQrYV12xNKye"</span><span class="o">).</span><span class="na">authorities</span><span class="o">(</span><span class="s">"p1"</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="æˆæƒæµç¨‹">æˆæƒæµç¨‹</h3>

<ul>
  <li>Spring Securityå¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">http.authorizeRequests()</code>å¯¹webè¯·æ±‚è¿›è¡Œæˆæƒä¿æŠ¤ã€‚Spring Securityä½¿ç”¨æ ‡å‡†Filterå»ºç«‹äº†å¯¹webè¯·æ±‚çš„æ‹¦æˆªï¼Œæœ€ç»ˆå®ç°å¯¹èµ„æºçš„æˆæƒè®¿é—®ã€‚</li>
  <li>Spring Securityçš„æˆæƒæµç¨‹å¦‚ä¸‹ï¼š
    <ul>
      <li><strong>æ‹¦æˆªè¯·æ±‚</strong>ï¼Œå·²è®¤è¯ç”¨æˆ·è®¿é—®å—ä¿æŠ¤çš„webèµ„æºå°†è¢«SecurityFilterChainä¸­çš„<code class="language-plaintext highlighter-rouge">FilterSecurityInterceptor</code>çš„å­ç±»æ‹¦æˆªã€‚</li>
      <li><strong>è·å–èµ„æºè®¿é—®ç­–ç•¥</strong>ï¼ŒFilterSecurityInterceptorä¼šä»<code class="language-plaintext highlighter-rouge">SecurityMetadataSource</code>çš„å­ç±»<code class="language-plaintext highlighter-rouge">DefaultFilterInvocationSecurityMetadataSource</code>è·å–è¦è®¿é—®å½“å‰èµ„æºæ‰€éœ€è¦çš„æƒé™<code class="language-plaintext highlighter-rouge">Collection&lt;ConfigAttribute&gt;</code>ã€‚</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/aTW3FGwodSMRsQ6.png" alt="image.png" /></p>

<ul>
  <li>SecurityMetadataSourceå…¶å®å°±æ˜¯è¯»å–è®¿é—®ç­–ç•¥çš„æŠ½è±¡ï¼Œè€Œè¯»å–çš„å†…å®¹ï¼Œå…¶å®å°±æ˜¯æˆ‘ä»¬é…ç½®çš„è®¿é—®è§„åˆ™ï¼Œ è¯»å–è®¿é—®ç­–ç•¥å¦‚ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">http</span>
   	<span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>                                                           
           <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r1"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p1"</span><span class="o">)</span>                                      
           <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r2"</span><span class="o">).</span><span class="na">hasAuthority</span><span class="o">(</span><span class="s">"p2"</span><span class="o">)</span>
           <span class="o">...</span>
</code></pre></div></div>

<ul>
  <li>æœ€åï¼ŒFilterSecurityInterceptorä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">AccessDecisionManager</code>è¿›è¡Œæˆæƒå†³ç­–ï¼Œè‹¥å†³ç­–é€šè¿‡ï¼Œåˆ™å…è®¸è®¿é—®èµ„æºï¼Œå¦åˆ™å°†ç¦æ­¢è®¿é—®ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AccessDecisionManager</span> <span class="o">{</span>
  	<span class="cm">/**
  	* é€šè¿‡ä¼ é€’çš„å‚æ•°æ¥å†³å®šç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™
  	*/</span>
    <span class="kt">void</span> <span class="nf">decide</span><span class="o">(</span><span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">,</span> <span class="nc">Object</span> <span class="n">object</span><span class="o">,</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ConfigAttribute</span><span class="o">&gt;</span> <span class="n">configAttributes</span> <span class="o">)</span> <span class="kd">throws</span> <span class="nc">AccessDeniedException</span><span class="o">,</span> <span class="nc">InsufficientAuthenticationException</span><span class="o">;</span>
	 <span class="c1">//ç•¥..</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç€é‡è¯´æ˜ä¸€ä¸‹decideçš„å‚æ•°ï¼š
    <ul>
      <li>authenticationï¼šè¦è®¿é—®èµ„æºçš„è®¿é—®è€…çš„èº«ä»½</li>
      <li>objectï¼šè¦è®¿é—®çš„å—ä¿æŠ¤èµ„æºï¼Œwebè¯·æ±‚å¯¹åº”FilterInvocation</li>
      <li>configAttributesï¼šæ˜¯å—ä¿æŠ¤èµ„æºçš„è®¿é—®ç­–ç•¥ï¼Œé€šè¿‡SecurityMetadataSourceè·å–ã€‚</li>
    </ul>
  </li>
  <li><strong>decideæ¥å£å°±æ˜¯ç”¨æ¥é‰´å®šå½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®å¯¹åº”å—ä¿æŠ¤èµ„æºçš„æƒé™ã€‚</strong></li>
</ul>
:ET