I"Ã<ul id="markdown-toc">
  <li><a href="#java-api" id="markdown-toc-java-api">java api</a>    <ul>
      <li><a href="#ä¼šè¯è¿æ¥ä¸æ¢å¤" id="markdown-toc-ä¼šè¯è¿æ¥ä¸æ¢å¤">ä¼šè¯è¿æ¥ä¸æ¢å¤</a></li>
      <li><a href="#èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥" id="markdown-toc-èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥">èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥</a></li>
    </ul>
  </li>
  <li><a href="#curatorå®¢æˆ·ç«¯" id="markdown-toc-curatorå®¢æˆ·ç«¯">curatorå®¢æˆ·ç«¯</a></li>
  <li><a href="#dubbo" id="markdown-toc-dubbo">dubbo</a>    <ul>
      <li><a href="#ä»å•ä½“åˆ°åˆ†å±‚" id="markdown-toc-ä»å•ä½“åˆ°åˆ†å±‚">ä»å•ä½“åˆ°åˆ†å±‚</a></li>
      <li><a href="#æœåŠ¡æ‹†åˆ†" id="markdown-toc-æœåŠ¡æ‹†åˆ†">æœåŠ¡æ‹†åˆ†</a></li>
    </ul>
  </li>
  <li><a href="#zookeeperåˆ†å¸ƒå¼é”" id="markdown-toc-zookeeperåˆ†å¸ƒå¼é”">zookeeperåˆ†å¸ƒå¼é”</a>    <ul>
      <li><a href="#curatoræ•´åˆspring" id="markdown-toc-curatoræ•´åˆspring">curatoræ•´åˆspring</a></li>
      <li><a href="#åˆ†å¸ƒå¼é”" id="markdown-toc-åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</a></li>
    </ul>
  </li>
</ul>
<h3 id="java-api">java api</h3>

<h4 id="ä¼šè¯è¿æ¥ä¸æ¢å¤">ä¼šè¯è¿æ¥ä¸æ¢å¤</h4>

<ul>
  <li>è¿æ¥</li>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKConnect.java">è¿æ¥</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @Title: ZKConnectDemo.java
 * @Package com.imooc.zk.demo
 * @Description: zookeeper è¿æ¥demoæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKConnect</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
         
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ZKConnect</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
<span class="c1">// public static final String zkServerPath = "192.168.1.111:2181,192.168.1.111:2182,192.168.1.111:2183";</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="cm">/**
          * å®¢æˆ·ç«¯å’ŒzkæœåŠ¡ç«¯é“¾æ¥æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è¿‡ç¨‹
          * å½“è¿æ¥æˆåŠŸååï¼Œå®¢æˆ·ç«¯ä¼šæ”¶çš„ä¸€ä¸ªwatché€šçŸ¥
          * 
          * å‚æ•°ï¼š
          * connectStringï¼šè¿æ¥æœåŠ¡å™¨çš„ipå­—ç¬¦ä¸²ï¼Œ
          *      æ¯”å¦‚: "192.168.1.1:2181,192.168.1.2:2181,192.168.1.3:2181"
          *      å¯ä»¥æ˜¯ä¸€ä¸ªipï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªipï¼Œä¸€ä¸ªipä»£è¡¨å•æœºï¼Œå¤šä¸ªipä»£è¡¨é›†ç¾¤
          *      ä¹Ÿå¯ä»¥åœ¨ipååŠ è·¯å¾„
          * sessionTimeoutï¼šè¶…æ—¶æ—¶é—´ï¼Œå¿ƒè·³æ”¶ä¸åˆ°äº†ï¼Œé‚£å°±è¶…æ—¶
          * watcherï¼šé€šçŸ¥äº‹ä»¶ï¼Œå¦‚æœæœ‰å¯¹åº”çš„äº‹ä»¶è§¦å‘ï¼Œåˆ™ä¼šæ”¶åˆ°ä¸€ä¸ªé€šçŸ¥ï¼›å¦‚æœä¸éœ€è¦ï¼Œé‚£å°±è®¾ç½®ä¸ºnull
          * canBeReadOnlyï¼šå¯è¯»ï¼Œå½“è¿™ä¸ªç‰©ç†æœºèŠ‚ç‚¹æ–­å¼€åï¼Œè¿˜æ˜¯å¯ä»¥è¯»åˆ°æ•°æ®çš„ï¼Œåªæ˜¯ä¸èƒ½å†™ï¼Œ
          *                          æ­¤æ—¶æ•°æ®è¢«è¯»å–åˆ°çš„å¯èƒ½æ˜¯æ—§æ•°æ®ï¼Œæ­¤å¤„å»ºè®®è®¾ç½®ä¸ºfalseï¼Œä¸æ¨èä½¿ç”¨
          * sessionIdï¼šä¼šè¯çš„id
          * sessionPasswdï¼šä¼šè¯å¯†ç  å½“ä¼šè¯ä¸¢å¤±åï¼Œå¯ä»¥ä¾æ® sessionId å’Œ sessionPasswd é‡æ–°è·å–ä¼šè¯
          */</span>
         <span class="nc">ZooKeeper</span> <span class="n">zk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKConnect</span><span class="o">());</span>
         
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯å¼€å§‹è¿æ¥zookeeperæœåŠ¡å™¨..."</span><span class="o">);</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"è¿æ¥çŠ¶æ€ï¼š{}"</span><span class="o">,</span> <span class="n">zk</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
         
         <span class="k">new</span> <span class="nf">Thread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
         
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"è¿æ¥çŠ¶æ€ï¼š{}"</span><span class="o">,</span> <span class="n">zk</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"æ¥å—åˆ°watché€šçŸ¥ï¼š{}"</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKConnectSessionWatcher.java">é‡è¿</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 
 * @Title: ZKConnectDemo.java
 * @Description: zookeeper æ¢å¤ä¹‹å‰çš„ä¼šè¯è¿æ¥demoæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKConnectSessionWatcher</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
    
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">ZKConnectSessionWatcher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         
         <span class="nc">ZooKeeper</span> <span class="n">zk</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKConnectSessionWatcher</span><span class="o">());</span>
         
         <span class="kt">long</span> <span class="n">sessionId</span> <span class="o">=</span> <span class="n">zk</span><span class="o">.</span><span class="na">getSessionId</span><span class="o">();</span>
         <span class="nc">String</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">"0x"</span> <span class="o">+</span> <span class="nc">Long</span><span class="o">.</span><span class="na">toHexString</span><span class="o">(</span><span class="n">sessionId</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ssid</span><span class="o">);</span>
         <span class="kt">byte</span><span class="o">[]</span> <span class="n">sessionPassword</span> <span class="o">=</span> <span class="n">zk</span><span class="o">.</span><span class="na">getSessionPasswd</span><span class="o">();</span>
         
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯å¼€å§‹è¿æ¥zookeeperæœåŠ¡å™¨..."</span><span class="o">);</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"è¿æ¥çŠ¶æ€ï¼š{}"</span><span class="o">,</span> <span class="n">zk</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
         <span class="k">new</span> <span class="nf">Thread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"è¿æ¥çŠ¶æ€ï¼š{}"</span><span class="o">,</span> <span class="n">zk</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
         
         <span class="k">new</span> <span class="nf">Thread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
         
         <span class="c1">// å¼€å§‹ä¼šè¯é‡è¿</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"å¼€å§‹ä¼šè¯é‡è¿..."</span><span class="o">);</span>
         
         <span class="nc">ZooKeeper</span> <span class="n">zkSession</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">,</span> 
                                                <span class="n">timeout</span><span class="o">,</span> 
                                                <span class="k">new</span> <span class="nf">ZKConnectSessionWatcher</span><span class="o">(),</span> 
                                                <span class="n">sessionId</span><span class="o">,</span> 
                                                <span class="n">sessionPassword</span><span class="o">);</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"é‡æ–°è¿æ¥çŠ¶æ€zkSessionï¼š{}"</span><span class="o">,</span> <span class="n">zkSession</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
         <span class="k">new</span> <span class="nf">Thread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"é‡æ–°è¿æ¥çŠ¶æ€zkSessionï¼š{}"</span><span class="o">,</span> <span class="n">zkSession</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         <span class="n">log</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"æ¥å—åˆ°watché€šçŸ¥ï¼š{}"</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥">èŠ‚ç‚¹å¢åˆ æ”¹æŸ¥</h4>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKNodeOperator.java">åˆ›å»ºèŠ‚ç‚¹</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 
 * @Title: ZKConnectDemo.java
 * @Description: zookeeper æ“ä½œdemoæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKNodeOperator</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ZooKeeper</span> <span class="n">zookeeper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeOperator</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeOperator</span><span class="o">(</span><span class="nc">String</span> <span class="n">connectString</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="n">zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">connectString</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKNodeOperator</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">zookeeper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">try</span> <span class="o">{</span>
                      <span class="n">zookeeper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * 
     * @Title: ZKOperatorDemo.java
     * @Description: åˆ›å»ºzkèŠ‚ç‚¹
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createZKNode</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">ACL</span><span class="o">&gt;</span> <span class="n">acls</span><span class="o">)</span> <span class="o">{</span>
         
         <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="cm">/**
              * åŒæ­¥æˆ–è€…å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹ï¼Œéƒ½ä¸æ”¯æŒå­èŠ‚ç‚¹çš„é€’å½’åˆ›å»ºï¼Œå¼‚æ­¥æœ‰ä¸€ä¸ªcallbackå‡½æ•°
              * å‚æ•°ï¼š
              * pathï¼šåˆ›å»ºçš„è·¯å¾„
              * dataï¼šå­˜å‚¨çš„æ•°æ®çš„byte[]
              * aclï¼šæ§åˆ¶æƒé™ç­–ç•¥
              *           Ids.OPEN_ACL_UNSAFE --&gt; world:anyone:cdrwa
              *           CREATOR_ALL_ACL --&gt; auth:user:password:cdrwa
              * createModeï¼šèŠ‚ç‚¹ç±»å‹, æ˜¯ä¸€ä¸ªæšä¸¾
              *           PERSISTENTï¼šæŒä¹…èŠ‚ç‚¹
              *           PERSISTENT_SEQUENTIALï¼šæŒä¹…é¡ºåºèŠ‚ç‚¹
              *           EPHEMERALï¼šä¸´æ—¶èŠ‚ç‚¹
              *           EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶é¡ºåºèŠ‚ç‚¹
              */</span>
             <span class="n">result</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">acls</span><span class="o">,</span> <span class="nc">CreateMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>
             
<span class="c1">//          String ctx = "{'create':'success'}";</span>
<span class="c1">//          zookeeper.create(path, data, acls, CreateMode.PERSISTENT, new CreateCallBack(), ctx);</span>
             
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»ºèŠ‚ç‚¹ï¼š\t"</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\tæˆåŠŸ..."</span><span class="o">);</span>
             <span class="k">new</span> <span class="nf">Thread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="nc">ZKNodeOperator</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKNodeOperator</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
         
         <span class="c1">// åˆ›å»ºzkèŠ‚ç‚¹</span>
<span class="c1">//      zkServer.createZKNode("/testnode", "testnode".getBytes(), Ids.OPEN_ACL_UNSAFE);</span>
         
         <span class="cm">/**ä¿®æ”¹èŠ‚ç‚¹æ•°æ®
          * å‚æ•°ï¼š
          * pathï¼šèŠ‚ç‚¹è·¯å¾„
          * dataï¼šæ•°æ®
          * versionï¼šæ•°æ®çŠ¶æ€
          */</span>
<span class="c1">//      Stat status  = zkServer.getZookeeper().setData("/testnode", "xyz".getBytes(), 2);</span>
<span class="c1">//      System.out.println(status.getVersion());</span>
         
         <span class="cm">/**åˆ é™¤èŠ‚ç‚¹æ•°æ®
          * å‚æ•°ï¼š
          * pathï¼šèŠ‚ç‚¹è·¯å¾„
          * versionï¼šæ•°æ®çŠ¶æ€
          */</span>
         <span class="n">zkServer</span><span class="o">.</span><span class="na">createZKNode</span><span class="o">(</span><span class="s">"/test-delete-node"</span><span class="o">,</span> <span class="s">"123"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="nc">Ids</span><span class="o">.</span><span class="na">OPEN_ACL_UNSAFE</span><span class="o">);</span>
<span class="c1">//      zkServer.getZookeeper().delete("/test-delete-node", 2);</span>
         
         <span class="nc">String</span> <span class="n">ctx</span> <span class="o">=</span> <span class="s">"{'delete':'success'}"</span><span class="o">;</span>
         <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">delete</span><span class="o">(</span><span class="s">"/test-delete-node"</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="nc">DeleteCallBack</span><span class="o">(),</span> <span class="n">ctx</span><span class="o">);</span>
         <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nc">ZooKeeper</span> <span class="nf">getZookeeper</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZookeeper</span><span class="o">(</span><span class="nc">ZooKeeper</span> <span class="n">zookeeper</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">zookeeper</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/countdown/CheckStartUp.java">countDownLatch</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CheckStartUp</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">DangerCenter</span><span class="o">&gt;</span> <span class="n">stationList</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CountDownLatch</span> <span class="n">countDown</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">CheckStartUp</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">checkAllStations</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
 
         <span class="c1">// åˆå§‹åŒ–3ä¸ªè°ƒåº¦ç«™</span>
         <span class="n">countDown</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
         
         <span class="c1">// æŠŠæ‰€æœ‰ç«™ç‚¹æ·»åŠ è¿›list</span>
         <span class="n">stationList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
         <span class="n">stationList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">StationBeijingIMooc</span><span class="o">(</span><span class="n">countDown</span><span class="o">));</span>
         <span class="n">stationList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">StationJiangsuSanling</span><span class="o">(</span><span class="n">countDown</span><span class="o">));</span>
         <span class="n">stationList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nc">StationShandongChangchuan</span><span class="o">(</span><span class="n">countDown</span><span class="o">));</span>
         
         <span class="c1">// ä½¿ç”¨çº¿ç¨‹æ± </span>
         <span class="nc">Executor</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">stationList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
         
         <span class="k">for</span> <span class="o">(</span><span class="nc">DangerCenter</span> <span class="n">center</span> <span class="o">:</span> <span class="n">stationList</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">center</span><span class="o">);</span>
         <span class="o">}</span>
         
         <span class="c1">// ç­‰å¾…çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span>
         <span class="n">countDown</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
         
         <span class="k">for</span> <span class="o">(</span><span class="nc">DangerCenter</span> <span class="n">center</span> <span class="o">:</span> <span class="n">stationList</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">if</span> <span class="o">(!</span><span class="n">center</span><span class="o">.</span><span class="na">isOk</span><span class="o">())</span> <span class="o">{</span>
                 <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
             <span class="o">}</span>
         <span class="o">}</span>
         
         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="nc">CheckStartUp</span><span class="o">.</span><span class="na">checkAllStations</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç›‘æ§ä¸­å¿ƒé’ˆå¯¹æ‰€æœ‰å±åŒ–å“è°ƒåº¦ç«™ç‚¹çš„æ£€æŸ¥ç»“æœä¸ºï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKGetNodeData.java">è·å–èŠ‚ç‚¹æ•°æ®</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 
 * @Description: zookeeper è·å–èŠ‚ç‚¹æ•°æ®çš„demoæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKGetNodeData</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ZooKeeper</span> <span class="n">zookeeper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Stat</span> <span class="n">stat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Stat</span><span class="o">();</span>
    
    <span class="kd">public</span> <span class="nf">ZKGetNodeData</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="nf">ZKGetNodeData</span><span class="o">(</span><span class="nc">String</span> <span class="n">connectString</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="n">zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">connectString</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKGetNodeData</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">zookeeper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">try</span> <span class="o">{</span>
                      <span class="n">zookeeper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CountDownLatch</span> <span class="n">countDown</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
         <span class="nc">ZKGetNodeData</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKGetNodeData</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
         
         <span class="cm">/**
          * å‚æ•°ï¼š
          * pathï¼šèŠ‚ç‚¹è·¯å¾„
          * watchï¼štrueæˆ–è€…falseï¼Œæ³¨å†Œä¸€ä¸ªwatchäº‹ä»¶
          * statï¼šçŠ¶æ€
          */</span>
         <span class="kt">byte</span><span class="o">[]</span> <span class="n">resByte</span> <span class="o">=</span> <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">getData</span><span class="o">(</span><span class="s">"/imooc"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">stat</span><span class="o">);</span>
         <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">resByte</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰å€¼:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
         <span class="n">countDown</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDataChanged</span><span class="o">){</span>
                 <span class="nc">ZKGetNodeData</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKGetNodeData</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
                 <span class="kt">byte</span><span class="o">[]</span> <span class="n">resByte</span> <span class="o">=</span> <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">getData</span><span class="o">(</span><span class="s">"/imooc"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">stat</span><span class="o">);</span>
                 <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">resByte</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ›´æ”¹åçš„å€¼:"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç‰ˆæœ¬å·å˜åŒ–dversionï¼š"</span> <span class="o">+</span> <span class="n">stat</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>
                 <span class="n">countDown</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeCreated</span><span class="o">)</span> <span class="o">{</span>
                 
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeChildrenChanged</span><span class="o">)</span> <span class="o">{</span>
                 
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDeleted</span><span class="o">)</span> <span class="o">{</span>
                 
             <span class="o">}</span> 
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">KeeperException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> 
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nc">ZooKeeper</span> <span class="nf">getZookeeper</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZookeeper</span><span class="o">(</span><span class="nc">ZooKeeper</span> <span class="n">zookeeper</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">zookeeper</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKGetChildrenList.java">è·å–å­èŠ‚ç‚¹åˆ—è¡¨</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @Description: zookeeper è·å–å­èŠ‚ç‚¹æ•°æ®çš„demoæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKGetChildrenList</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ZooKeeper</span> <span class="n">zookeeper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ZKGetChildrenList</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="nf">ZKGetChildrenList</span><span class="o">(</span><span class="nc">String</span> <span class="n">connectString</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="n">zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">connectString</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKGetChildrenList</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">zookeeper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">try</span> <span class="o">{</span>
                      <span class="n">zookeeper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CountDownLatch</span> <span class="n">countDown</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
         <span class="nc">ZKGetChildrenList</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKGetChildrenList</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
         
         <span class="cm">/**
          * å‚æ•°ï¼š
          * pathï¼šçˆ¶èŠ‚ç‚¹è·¯å¾„
          * watchï¼štrueæˆ–è€…falseï¼Œæ³¨å†Œä¸€ä¸ªwatchäº‹ä»¶
          */</span>
<span class="c1">//      List&lt;String&gt; strChildList = zkServer.getZookeeper().getChildren("/imooc", true);</span>
<span class="c1">//      for (String s : strChildList) {</span>
<span class="c1">//          System.out.println(s);</span>
<span class="c1">//      }</span>
         
         <span class="c1">// å¼‚æ­¥è°ƒç”¨</span>
         <span class="nc">String</span> <span class="n">ctx</span> <span class="o">=</span> <span class="s">"{'callback':'ChildrenCallback'}"</span><span class="o">;</span>
<span class="c1">//      zkServer.getZookeeper().getChildren("/imooc", true, new ChildrenCallBack(), ctx);</span>
         <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">getChildren</span><span class="o">(</span><span class="s">"/imooc"</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Children2CallBack</span><span class="o">(),</span> <span class="n">ctx</span><span class="o">);</span>
         
         <span class="n">countDown</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()==</span><span class="nc">EventType</span><span class="o">.</span><span class="na">NodeChildrenChanged</span><span class="o">){</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NodeChildrenChanged"</span><span class="o">);</span>
                 <span class="nc">ZKGetChildrenList</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKGetChildrenList</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
                 <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">strChildList</span> <span class="o">=</span> <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">getChildren</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="kc">false</span><span class="o">);</span>
                 <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">strChildList</span><span class="o">)</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
                 <span class="o">}</span>
                 <span class="n">countDown</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeCreated</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NodeCreated"</span><span class="o">);</span>
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDataChanged</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NodeDataChanged"</span><span class="o">);</span>
             <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDeleted</span><span class="o">)</span> <span class="o">{</span>
                 <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"NodeDeleted"</span><span class="o">);</span>
             <span class="o">}</span> 
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">KeeperException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nc">ZooKeeper</span> <span class="nf">getZookeeper</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZookeeper</span><span class="o">(</span><span class="nc">ZooKeeper</span> <span class="n">zookeeper</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">zookeeper</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKNodeExist.java">åˆ¤æ–­èŠ‚ç‚¹å­˜åœ¨</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * @Description: zookeeper åˆ¤æ–­é˜¶æ®µæ˜¯å¦å­˜åœ¨demo
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKNodeExist</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ZooKeeper</span> <span class="n">zookeeper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeExist</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeExist</span><span class="o">(</span><span class="nc">String</span> <span class="n">connectString</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="n">zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">connectString</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKNodeExist</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">zookeeper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">try</span> <span class="o">{</span>
                      <span class="n">zookeeper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CountDownLatch</span> <span class="n">countDown</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
         <span class="nc">ZKNodeExist</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKNodeExist</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
         
         <span class="cm">/**
          * å‚æ•°ï¼š
          * pathï¼šèŠ‚ç‚¹è·¯å¾„
          * watchï¼šwatch
          */</span>
         <span class="nc">Stat</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">exists</span><span class="o">(</span><span class="s">"/imooc-fake"</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æŸ¥è¯¢çš„èŠ‚ç‚¹ç‰ˆæœ¬ä¸ºdataVersionï¼š"</span> <span class="o">+</span> <span class="n">stat</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¯¥èŠ‚ç‚¹ä¸å­˜åœ¨..."</span><span class="o">);</span>
         <span class="o">}</span>
         
         <span class="n">countDown</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeCreated</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"èŠ‚ç‚¹åˆ›å»º"</span><span class="o">);</span>
             <span class="n">countDown</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDataChanged</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"èŠ‚ç‚¹æ•°æ®æ”¹å˜"</span><span class="o">);</span>
             <span class="n">countDown</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="nc">EventType</span><span class="o">.</span><span class="na">NodeDeleted</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"èŠ‚ç‚¹åˆ é™¤"</span><span class="o">);</span>
             <span class="n">countDown</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="nc">ZooKeeper</span> <span class="nf">getZookeeper</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZookeeper</span><span class="o">(</span><span class="nc">ZooKeeper</span> <span class="n">zookeeper</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">zookeeper</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/blob/master/imooc_code/imooc-zookeeper-starter/src/com/imooc/zk/demo/ZKNodeAcl.java">watchä¸acl</a></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 
 * @Description: zookeeper æ“ä½œèŠ‚ç‚¹aclæ¼”ç¤º
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKNodeAcl</span> <span class="kd">implements</span> <span class="nc">Watcher</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ZooKeeper</span> <span class="n">zookeeper</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">;</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeAcl</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="kd">public</span> <span class="nf">ZKNodeAcl</span><span class="o">(</span><span class="nc">String</span> <span class="n">connectString</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="n">zookeeper</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZooKeeper</span><span class="o">(</span><span class="n">connectString</span><span class="o">,</span> <span class="n">timeout</span><span class="o">,</span> <span class="k">new</span> <span class="nc">ZKNodeAcl</span><span class="o">());</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
             <span class="k">if</span> <span class="o">(</span><span class="n">zookeeper</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                 <span class="k">try</span> <span class="o">{</span>
                      <span class="n">zookeeper</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                 <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e1</span><span class="o">)</span> <span class="o">{</span>
                      <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createZKNode</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="no">ACL</span><span class="o">&gt;</span> <span class="n">acls</span><span class="o">)</span> <span class="o">{</span>
         
         <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="s">""</span><span class="o">;</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="cm">/**
              * åŒæ­¥æˆ–è€…å¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹ï¼Œéƒ½ä¸æ”¯æŒå­èŠ‚ç‚¹çš„é€’å½’åˆ›å»ºï¼Œå¼‚æ­¥æœ‰ä¸€ä¸ªcallbackå‡½æ•°
              * å‚æ•°ï¼š
              * pathï¼šåˆ›å»ºçš„è·¯å¾„
              * dataï¼šå­˜å‚¨çš„æ•°æ®çš„byte[]
              * aclï¼šæ§åˆ¶æƒé™ç­–ç•¥
              *           Ids.OPEN_ACL_UNSAFE --&gt; world:anyone:cdrwa
              *           CREATOR_ALL_ACL --&gt; auth:user:password:cdrwa
              * createModeï¼šèŠ‚ç‚¹ç±»å‹, æ˜¯ä¸€ä¸ªæšä¸¾
              *           PERSISTENTï¼šæŒä¹…èŠ‚ç‚¹
              *           PERSISTENT_SEQUENTIALï¼šæŒä¹…é¡ºåºèŠ‚ç‚¹
              *           EPHEMERALï¼šä¸´æ—¶èŠ‚ç‚¹
              *           EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶é¡ºåºèŠ‚ç‚¹
              */</span>
             <span class="n">result</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">data</span><span class="o">,</span> <span class="n">acls</span><span class="o">,</span> <span class="nc">CreateMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ›å»ºèŠ‚ç‚¹ï¼š\t"</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\tæˆåŠŸ..."</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">KeeperException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span> 
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    
         <span class="nc">ZKNodeAcl</span> <span class="n">zkServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ZKNodeAcl</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">);</span>
         
         <span class="cm">/**
          * ======================  åˆ›å»ºnode start  ======================  
          */</span>
         <span class="c1">// acl ä»»ä½•äººéƒ½å¯ä»¥è®¿é—®</span>
<span class="c1">//      zkServer.createZKNode("/aclimooc", "test".getBytes(), Ids.OPEN_ACL_UNSAFE);</span>
         
         <span class="c1">// è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯è®¿é—®</span>
<span class="c1">//      List&lt;ACL&gt; acls = new ArrayList&lt;ACL&gt;();</span>
<span class="c1">//      Id imooc1 = new Id("digest", AclUtils.getDigestUserPwd("imooc1:123456"));</span>
<span class="c1">//      Id imooc2 = new Id("digest", AclUtils.getDigestUserPwd("imooc2:123456"));</span>
<span class="c1">//      acls.add(new ACL(Perms.ALL, imooc1));</span>
<span class="c1">//      acls.add(new ACL(Perms.READ, imooc2));</span>
<span class="c1">//      acls.add(new ACL(Perms.DELETE | Perms.CREATE, imooc2));</span>
<span class="c1">//      zkServer.createZKNode("/aclimooc/testdigest", "testdigest".getBytes(), acls);</span>
         
         <span class="c1">// æ³¨å†Œè¿‡çš„ç”¨æˆ·å¿…é¡»é€šè¿‡addAuthInfoæ‰èƒ½æ“ä½œèŠ‚ç‚¹ï¼Œå‚è€ƒå‘½ä»¤è¡Œ addauth</span>
<span class="c1">//      zkServer.getZookeeper().addAuthInfo("digest", "imooc1:123456".getBytes());</span>
<span class="c1">//      zkServer.createZKNode("/aclimooc/testdigest/childtest", "childtest".getBytes(), Ids.CREATOR_ALL_ACL);</span>
<span class="c1">//      Stat stat = new Stat();</span>
<span class="c1">//      byte[] data = zkServer.getZookeeper().getData("/aclimooc/testdigest", false, stat);</span>
<span class="c1">//      System.out.println(new String(data));</span>
<span class="c1">//      zkServer.getZookeeper().setData("/aclimooc/testdigest", "now".getBytes(), 1);</span>
         
         <span class="c1">// ipæ–¹å¼çš„acl</span>
<span class="c1">//      List&lt;ACL&gt; aclsIP = new ArrayList&lt;ACL&gt;();</span>
<span class="c1">//      Id ipId1 = new Id("ip", "192.168.1.6");</span>
<span class="c1">//      aclsIP.add(new ACL(Perms.ALL, ipId1));</span>
<span class="c1">//      zkServer.createZKNode("/aclimooc/iptest6", "iptest".getBytes(), aclsIP);</span>
 
         <span class="c1">// éªŒè¯ipæ˜¯å¦æœ‰æƒé™</span>
         <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">setData</span><span class="o">(</span><span class="s">"/aclimooc/iptest6"</span><span class="o">,</span> <span class="s">"now"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="mi">1</span><span class="o">);</span>
         <span class="nc">Stat</span> <span class="n">stat</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Stat</span><span class="o">();</span>
         <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span> <span class="o">=</span> <span class="n">zkServer</span><span class="o">.</span><span class="na">getZookeeper</span><span class="o">().</span><span class="na">getData</span><span class="o">(</span><span class="s">"/aclimooc/iptest6"</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">stat</span><span class="o">);</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">data</span><span class="o">));</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">stat</span><span class="o">.</span><span class="na">getVersion</span><span class="o">());</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nc">ZooKeeper</span> <span class="nf">getZookeeper</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setZookeeper</span><span class="o">(</span><span class="nc">ZooKeeper</span> <span class="n">zookeeper</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">this</span><span class="o">.</span><span class="na">zookeeper</span> <span class="o">=</span> <span class="n">zookeeper</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
         
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="curatorå®¢æˆ·ç«¯">curatorå®¢æˆ·ç«¯</h3>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-zk-curator-maven">æºç </a></li>
  <li>CuratorOperator</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CuratorOperator</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="nc">CuratorFramework</span> <span class="n">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
 
    <span class="cm">/**
     * å®ä¾‹åŒ–zkå®¢æˆ·ç«¯
     */</span>
    <span class="kd">public</span> <span class="nf">CuratorOperator</span><span class="o">()</span> <span class="o">{</span>
         <span class="cm">/**
          * åŒæ­¥åˆ›å»ºzkç¤ºä¾‹ï¼ŒåŸç”Ÿapiæ˜¯å¼‚æ­¥çš„
          * 
          * curatoré“¾æ¥zookeeperçš„ç­–ç•¥:ExponentialBackoffRetry
          * baseSleepTimeMsï¼šåˆå§‹sleepçš„æ—¶é—´
          * maxRetriesï¼šæœ€å¤§é‡è¯•æ¬¡æ•°
          * maxSleepMsï¼šæœ€å¤§é‡è¯•æ—¶é—´
          */</span>
<span class="c1">//      RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 5);</span>
         
         <span class="cm">/**
          * curatoré“¾æ¥zookeeperçš„ç­–ç•¥:RetryNTimes
          * nï¼šé‡è¯•çš„æ¬¡æ•°
          * sleepMsBetweenRetriesï¼šæ¯æ¬¡é‡è¯•é—´éš”çš„æ—¶é—´
          */</span>
         <span class="nc">RetryPolicy</span> <span class="n">retryPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RetryNTimes</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
         
         <span class="cm">/**
          * curatoré“¾æ¥zookeeperçš„ç­–ç•¥:RetryOneTime
          * sleepMsBetweenRetry:æ¯æ¬¡é‡è¯•é—´éš”çš„æ—¶é—´
          */</span>
<span class="c1">//      RetryPolicy retryPolicy2 = new RetryOneTime(3000);</span>
         
         <span class="cm">/**
          * æ°¸è¿œé‡è¯•ï¼Œä¸æ¨èä½¿ç”¨
          */</span>
<span class="c1">//      RetryPolicy retryPolicy3 = new RetryForever(retryIntervalMs)</span>
         
         <span class="cm">/**
          * curatoré“¾æ¥zookeeperçš„ç­–ç•¥:RetryUntilElapsed
          * maxElapsedTimeMs:æœ€å¤§é‡è¯•æ—¶é—´
          * sleepMsBetweenRetries:æ¯æ¬¡é‡è¯•é—´éš”
          * é‡è¯•æ—¶é—´è¶…è¿‡maxElapsedTimeMsåï¼Œå°±ä¸å†é‡è¯•
          */</span>
<span class="c1">//      RetryPolicy retryPolicy4 = new RetryUntilElapsed(2000, 3000);</span>
         
         <span class="n">client</span> <span class="o">=</span> <span class="nc">CuratorFrameworkFactory</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">connectString</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">sessionTimeoutMs</span><span class="o">(</span><span class="mi">10000</span><span class="o">).</span><span class="na">retryPolicy</span><span class="o">(</span><span class="n">retryPolicy</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">namespace</span><span class="o">(</span><span class="s">"workspace"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
         <span class="n">client</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * 
     * @Description: å…³é—­zkå®¢æˆ·ç«¯è¿æ¥
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeZKClient</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="c1">// å®ä¾‹åŒ–</span>
         <span class="nc">CuratorOperator</span> <span class="n">cto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CuratorOperator</span><span class="o">();</span>
         <span class="kt">boolean</span> <span class="n">isZkCuratorStarted</span> <span class="o">=</span> <span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">isStarted</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰å®¢æˆ·çš„çŠ¶æ€ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isZkCuratorStarted</span> <span class="o">?</span> <span class="s">"è¿æ¥ä¸­"</span> <span class="o">:</span> <span class="s">"å·²å…³é—­"</span><span class="o">));</span>
         
         <span class="c1">// åˆ›å»ºèŠ‚ç‚¹</span>
         <span class="nc">String</span> <span class="n">nodePath</span> <span class="o">=</span> <span class="s">"/super/imooc"</span><span class="o">;</span>
<span class="c1">//      byte[] data = "superme".getBytes();</span>
<span class="c1">//      cto.client.create().creatingParentsIfNeeded()</span>
<span class="c1">//          .withMode(CreateMode.PERSISTENT)</span>
<span class="c1">//          .withACL(Ids.OPEN_ACL_UNSAFE)</span>
<span class="c1">//          .forPath(nodePath, data);</span>
         
         <span class="c1">// æ›´æ–°èŠ‚ç‚¹æ•°æ®</span>
<span class="c1">//      byte[] newData = "batman".getBytes();</span>
<span class="c1">//      cto.client.setData().withVersion(0).forPath(nodePath, newData);</span>
         
         <span class="c1">// åˆ é™¤èŠ‚ç‚¹</span>
<span class="c1">//      cto.client.delete()</span>
<span class="c1">//                .guaranteed()                     // å¦‚æœåˆ é™¤å¤±è´¥ï¼Œé‚£ä¹ˆåœ¨åç«¯è¿˜æ˜¯ç»§ç»­ä¼šåˆ é™¤ï¼Œç›´åˆ°æˆåŠŸ</span>
<span class="c1">//                .deletingChildrenIfNeeded()    // å¦‚æœæœ‰å­èŠ‚ç‚¹ï¼Œå°±åˆ é™¤</span>
<span class="c1">//                .withVersion(0)</span>
<span class="c1">//                .forPath(nodePath);</span>
         
         
         
         <span class="c1">// è¯»å–èŠ‚ç‚¹æ•°æ®</span>
<span class="c1">//      Stat stat = new Stat();</span>
<span class="c1">//      byte[] data = cto.client.getData().storingStatIn(stat).forPath(nodePath);</span>
<span class="c1">//      System.out.println("èŠ‚ç‚¹" + nodePath + "çš„æ•°æ®ä¸º: " + new String(data));</span>
<span class="c1">//      System.out.println("è¯¥èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ä¸º: " + stat.getVersion());</span>
         
         
         <span class="c1">// æŸ¥è¯¢å­èŠ‚ç‚¹</span>
<span class="c1">//      List&lt;String&gt; childNodes = cto.client.getChildren()</span>
<span class="c1">//                                             .forPath(nodePath);</span>
<span class="c1">//      System.out.println("å¼€å§‹æ‰“å°å­èŠ‚ç‚¹ï¼š");</span>
<span class="c1">//      for (String s : childNodes) {</span>
<span class="c1">//          System.out.println(s);</span>
<span class="c1">//      }</span>
         
                 
         <span class="c1">// åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨,å¦‚æœä¸å­˜åœ¨åˆ™ä¸ºç©º</span>
<span class="c1">//      Stat statExist = cto.client.checkExists().forPath(nodePath + "/abc");</span>
<span class="c1">//      System.out.println(statExist);</span>
         
         
         <span class="c1">// watcher äº‹ä»¶  å½“ä½¿ç”¨usingWatcherçš„æ—¶å€™ï¼Œç›‘å¬åªä¼šè§¦å‘ä¸€æ¬¡ï¼Œç›‘å¬å®Œæ¯•åå°±é”€æ¯</span>
<span class="c1">//      cto.client.getData().usingWatcher(new MyCuratorWatcher()).forPath(nodePath);</span>
<span class="c1">//      cto.client.getData().usingWatcher(new MyWatcher()).forPath(nodePath);</span>
         
         <span class="c1">// ä¸ºèŠ‚ç‚¹æ·»åŠ watcher</span>
         <span class="c1">// NodeCache: ç›‘å¬æ•°æ®èŠ‚ç‚¹çš„å˜æ›´ï¼Œä¼šè§¦å‘äº‹ä»¶</span>
<span class="c1">//      final NodeCache nodeCache = new NodeCache(cto.client, nodePath);</span>
<span class="c1">//      // buildInitial : åˆå§‹åŒ–çš„æ—¶å€™è·å–nodeçš„å€¼å¹¶ä¸”ç¼“å­˜</span>
<span class="c1">//      nodeCache.start(true);</span>
<span class="c1">//      if (nodeCache.getCurrentData() != null) {</span>
<span class="c1">//          System.out.println("èŠ‚ç‚¹åˆå§‹åŒ–æ•°æ®ä¸ºï¼š" + new String(nodeCache.getCurrentData().getData()));</span>
<span class="c1">//      } else {</span>
<span class="c1">//          System.out.println("èŠ‚ç‚¹åˆå§‹åŒ–æ•°æ®ä¸ºç©º...");</span>
<span class="c1">//      }</span>
<span class="c1">//      nodeCache.getListenable().addListener(new NodeCacheListener() {</span>
<span class="c1">//          public void nodeChanged() throws Exception {</span>
<span class="c1">//              if (nodeCache.getCurrentData() == null) {</span>
<span class="c1">//                   System.out.println("ç©º");</span>
<span class="c1">//                   return;</span>
<span class="c1">//              }</span>
<span class="c1">//              String data = new String(nodeCache.getCurrentData().getData());</span>
<span class="c1">//              System.out.println("èŠ‚ç‚¹è·¯å¾„ï¼š" + nodeCache.getCurrentData().getPath() + "æ•°æ®ï¼š" + data);</span>
<span class="c1">//          }</span>
<span class="c1">//      });</span>
         
         
         <span class="c1">// ä¸ºå­èŠ‚ç‚¹æ·»åŠ watcher</span>
         <span class="c1">// PathChildrenCache: ç›‘å¬æ•°æ®èŠ‚ç‚¹çš„å¢åˆ æ”¹ï¼Œä¼šè§¦å‘äº‹ä»¶</span>
         <span class="nc">String</span> <span class="n">childNodePathCache</span> <span class="o">=</span>  <span class="n">nodePath</span><span class="o">;</span>
         <span class="c1">// cacheData: è®¾ç½®ç¼“å­˜èŠ‚ç‚¹çš„æ•°æ®çŠ¶æ€</span>
         <span class="kd">final</span> <span class="nc">PathChildrenCache</span> <span class="n">childrenCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PathChildrenCache</span><span class="o">(</span><span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">,</span> <span class="n">childNodePathCache</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
         <span class="cm">/**
          * StartMode: åˆå§‹åŒ–æ–¹å¼
          * POST_INITIALIZED_EVENTï¼šå¼‚æ­¥åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¹‹åä¼šè§¦å‘äº‹ä»¶
          * NORMALï¼šå¼‚æ­¥åˆå§‹åŒ–
          * BUILD_INITIAL_CACHEï¼šåŒæ­¥åˆå§‹åŒ–
          */</span>
         <span class="n">childrenCache</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="nc">StartMode</span><span class="o">.</span><span class="na">POST_INITIALIZED_EVENT</span><span class="o">);</span>
         
         <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ChildData</span><span class="o">&gt;</span> <span class="n">childDataList</span> <span class="o">=</span> <span class="n">childrenCache</span><span class="o">.</span><span class="na">getCurrentData</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰æ•°æ®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ•°æ®åˆ—è¡¨ï¼š"</span><span class="o">);</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">ChildData</span> <span class="n">cd</span> <span class="o">:</span> <span class="n">childDataList</span><span class="o">)</span> <span class="o">{</span>
             <span class="nc">String</span> <span class="n">childData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">cd</span><span class="o">.</span><span class="na">getData</span><span class="o">());</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">childData</span><span class="o">);</span>
         <span class="o">}</span>
         
         <span class="n">childrenCache</span><span class="o">.</span><span class="na">getListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">PathChildrenCacheListener</span><span class="o">()</span> <span class="o">{</span>
             <span class="kd">public</span> <span class="kt">void</span> <span class="nf">childEvent</span><span class="o">(</span><span class="nc">CuratorFramework</span> <span class="n">client</span><span class="o">,</span> <span class="nc">PathChildrenCacheEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                 <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">PathChildrenCacheEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">INITIALIZED</span><span class="o">)){</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­èŠ‚ç‚¹åˆå§‹åŒ–ok..."</span><span class="o">);</span>
                 <span class="o">}</span>
                 
                 <span class="k">else</span> <span class="nf">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">PathChildrenCacheEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CHILD_ADDED</span><span class="o">)){</span>
                      <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
                      <span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="no">ADD_PATH</span><span class="o">))</span> <span class="o">{</span>
                          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ·»åŠ å­èŠ‚ç‚¹:"</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
                          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å­èŠ‚ç‚¹æ•°æ®:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getData</span><span class="o">()));</span>
                      <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"/super/imooc/e"</span><span class="o">))</span> <span class="o">{</span>
                          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ·»åŠ ä¸æ­£ç¡®..."</span><span class="o">);</span>
                      <span class="o">}</span>
                      
                 <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">PathChildrenCacheEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CHILD_REMOVED</span><span class="o">)){</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ é™¤å­èŠ‚ç‚¹:"</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
                 <span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">PathChildrenCacheEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CHILD_UPDATED</span><span class="o">)){</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¿®æ”¹å­èŠ‚ç‚¹è·¯å¾„:"</span> <span class="o">+</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPath</span><span class="o">());</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¿®æ”¹å­èŠ‚ç‚¹æ•°æ®:"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getData</span><span class="o">()));</span>
                 <span class="o">}</span>
             <span class="o">}</span>
         <span class="o">});</span>
         
         <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100000</span><span class="o">);</span>
         
         <span class="n">cto</span><span class="o">.</span><span class="na">closeZKClient</span><span class="o">();</span>
         <span class="kt">boolean</span> <span class="n">isZkCuratorStarted2</span> <span class="o">=</span> <span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">isStarted</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰å®¢æˆ·çš„çŠ¶æ€ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isZkCuratorStarted2</span> <span class="o">?</span> <span class="s">"è¿æ¥ä¸­"</span> <span class="o">:</span> <span class="s">"å·²å…³é—­"</span><span class="o">));</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">ADD_PATH</span> <span class="o">=</span> <span class="s">"/super/imooc/d"</span><span class="o">;</span>
    
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>CuratorAcl</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CuratorAcl</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="nc">CuratorFramework</span> <span class="n">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="n">zkServerPath</span> <span class="o">=</span> <span class="s">"192.168.1.110:2181"</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">CuratorAcl</span><span class="o">()</span> <span class="o">{</span>
         <span class="nc">RetryPolicy</span> <span class="n">retryPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RetryNTimes</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">5000</span><span class="o">);</span>
         <span class="n">client</span> <span class="o">=</span> <span class="nc">CuratorFrameworkFactory</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">authorization</span><span class="o">(</span><span class="s">"digest"</span><span class="o">,</span> <span class="s">"imooc1:123456"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">())</span>
                 <span class="o">.</span><span class="na">connectString</span><span class="o">(</span><span class="n">zkServerPath</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">sessionTimeoutMs</span><span class="o">(</span><span class="mi">10000</span><span class="o">).</span><span class="na">retryPolicy</span><span class="o">(</span><span class="n">retryPolicy</span><span class="o">)</span>
                 <span class="o">.</span><span class="na">namespace</span><span class="o">(</span><span class="s">"workspace"</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
         <span class="n">client</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeZKClient</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
             <span class="k">this</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
         <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
         <span class="c1">// å®ä¾‹åŒ–</span>
         <span class="nc">CuratorAcl</span> <span class="n">cto</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CuratorAcl</span><span class="o">();</span>
         <span class="kt">boolean</span> <span class="n">isZkCuratorStarted</span> <span class="o">=</span> <span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">isStarted</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰å®¢æˆ·çš„çŠ¶æ€ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isZkCuratorStarted</span> <span class="o">?</span> <span class="s">"è¿æ¥ä¸­"</span> <span class="o">:</span> <span class="s">"å·²å…³é—­"</span><span class="o">));</span>
         
         <span class="nc">String</span> <span class="n">nodePath</span> <span class="o">=</span> <span class="s">"/acl/father/child/sub"</span><span class="o">;</span>
         
         <span class="nc">List</span><span class="o">&lt;</span><span class="no">ACL</span><span class="o">&gt;</span> <span class="n">acls</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="no">ACL</span><span class="o">&gt;();</span>
         <span class="nc">Id</span> <span class="n">imooc1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Id</span><span class="o">(</span><span class="s">"digest"</span><span class="o">,</span> <span class="nc">AclUtils</span><span class="o">.</span><span class="na">getDigestUserPwd</span><span class="o">(</span><span class="s">"imooc1:123456"</span><span class="o">));</span>
         <span class="nc">Id</span> <span class="n">imooc2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Id</span><span class="o">(</span><span class="s">"digest"</span><span class="o">,</span> <span class="nc">AclUtils</span><span class="o">.</span><span class="na">getDigestUserPwd</span><span class="o">(</span><span class="s">"imooc2:123456"</span><span class="o">));</span>
         <span class="n">acls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="no">ACL</span><span class="o">(</span><span class="nc">Perms</span><span class="o">.</span><span class="na">ALL</span><span class="o">,</span> <span class="n">imooc1</span><span class="o">));</span>
         <span class="n">acls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="no">ACL</span><span class="o">(</span><span class="nc">Perms</span><span class="o">.</span><span class="na">READ</span><span class="o">,</span> <span class="n">imooc2</span><span class="o">));</span>
         <span class="n">acls</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="no">ACL</span><span class="o">(</span><span class="nc">Perms</span><span class="o">.</span><span class="na">DELETE</span> <span class="o">|</span> <span class="nc">Perms</span><span class="o">.</span><span class="na">CREATE</span><span class="o">,</span> <span class="n">imooc2</span><span class="o">));</span>
         
         <span class="c1">// åˆ›å»ºèŠ‚ç‚¹</span>
<span class="c1">//      byte[] data = "spiderman".getBytes();</span>
<span class="c1">//      cto.client.create().creatingParentsIfNeeded()</span>
<span class="c1">//              .withMode(CreateMode.PERSISTENT)</span>
<span class="c1">//              .withACL(acls, true)</span>
<span class="c1">//              .forPath(nodePath, data);</span>
         
 
         <span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">setACL</span><span class="o">().</span><span class="na">withACL</span><span class="o">(</span><span class="n">acls</span><span class="o">).</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/curatorNode"</span><span class="o">);</span>
         
         <span class="c1">// æ›´æ–°èŠ‚ç‚¹æ•°æ®</span>
<span class="c1">//      byte[] newData = "batman".getBytes();</span>
<span class="c1">//      cto.client.setData().withVersion(0).forPath(nodePath, newData);</span>
         
         <span class="c1">// åˆ é™¤èŠ‚ç‚¹</span>
<span class="c1">//      cto.client.delete().guaranteed().deletingChildrenIfNeeded().withVersion(0).forPath(nodePath);</span>
         
         <span class="c1">// è¯»å–èŠ‚ç‚¹æ•°æ®</span>
<span class="c1">//      Stat stat = new Stat();</span>
<span class="c1">//      byte[] data = cto.client.getData().storingStatIn(stat).forPath(nodePath);</span>
<span class="c1">//      System.out.println("èŠ‚ç‚¹" + nodePath + "çš„æ•°æ®ä¸º: " + new String(data));</span>
<span class="c1">//      System.out.println("è¯¥èŠ‚ç‚¹çš„ç‰ˆæœ¬å·ä¸º: " + stat.getVersion());</span>
         
         
         <span class="n">cto</span><span class="o">.</span><span class="na">closeZKClient</span><span class="o">();</span>
         <span class="kt">boolean</span> <span class="n">isZkCuratorStarted2</span> <span class="o">=</span> <span class="n">cto</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">isStarted</span><span class="o">();</span>
         <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å½“å‰å®¢æˆ·çš„çŠ¶æ€ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">isZkCuratorStarted2</span> <span class="o">?</span> <span class="s">"è¿æ¥ä¸­"</span> <span class="o">:</span> <span class="s">"å·²å…³é—­"</span><span class="o">));</span>
    <span class="o">}</span>
    
<span class="o">}</span>

</code></pre></div></div>

<h3 id="dubbo">dubbo</h3>

<ul>
  <li>æ¶æ„æ¼”è¿›</li>
</ul>

<p><img src="https://i.loli.net/2020/09/06/Lj5WeU2gNZA7QKy.png" alt="image.png" /></p>

<ul>
  <li>ç³»ç»Ÿè°ƒç”¨æ–¹å¼
    <ul>
      <li>WebService-wsdl</li>
      <li>HttpClient</li>
      <li>rpcï¼ˆdubboï¼‰/ restfulï¼ˆspringcloud ï¼‰</li>
    </ul>
  </li>
  <li>dubboå¯ä»¥æœ€å¤§ç¨‹åº¦è§£è€¦,é™ä½ç³»ç»Ÿè€¦åˆæ€§</li>
</ul>

<p><img src="https://i.loli.net/2020/09/06/U6n5KNXmfjgOveJ.png" alt="image.png" /></p>

<ul>
  <li>dubboåŸºäºç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼ã€‚zookeeperä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œadminä¸ºç›‘æ§ä¸­å¿ƒï¼Œåè®®æ”¯æŒ</li>
</ul>

<h4 id="ä»å•ä½“åˆ°åˆ†å±‚">ä»å•ä½“åˆ°åˆ†å±‚</h4>

<p><img src="https://i.loli.net/2020/09/06/CXFmwHQYtr7cIeB.png" alt="image.png" /></p>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-single-mvc">æºç </a></li>
</ul>

<h4 id="æœåŠ¡æ‹†åˆ†">æœåŠ¡æ‹†åˆ†</h4>

<ul>
  <li>é‡æ„å•†å“æœåŠ¡ï¼ŒæŠ½å–æŠ½è±¡å·¥ç¨‹</li>
  <li>
    <p><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo/imooc-dubbo-item-api">ä»£ç </a></p>
  </li>
  <li>é‡æ„å•†å“æœåŠ¡ï¼Œæš´éœ²å•†å“æœåŠ¡<a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo/imooc-dubbo-item-service">ä»£ç </a></li>
  <li>dubboä¸‰ç§å¯åŠ¨æ–¹å¼
    <ul>
      <li>tomcatå¯åŠ¨</li>
      <li>mainçº¿ç¨‹å¯åŠ¨</li>
      <li>jaråŒ…å¯åŠ¨</li>
    </ul>
  </li>
  <li>é‡æ„è®¢å•æœåŠ¡
    <ul>
      <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo/imooc-dubbo-order-api">api</a></li>
      <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo/imooc-dubbo-order-service">orderService</a></li>
    </ul>
  </li>
  <li>æ¶ˆè´¹æ–¹å¯¹å•†å“å’Œè®¢å•è¿›è¡Œå¼•ç”¨
    <ul>
      <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo/imooc-dubbo-web">web</a></li>
    </ul>
  </li>
</ul>

<h3 id="zookeeperåˆ†å¸ƒå¼é”">zookeeperåˆ†å¸ƒå¼é”</h3>

<p><img src="https://i.loli.net/2020/09/06/VhExPqsuGBT8JUS.png" alt="image.png" /></p>

<ul>
  <li>æ•°æ®ä¸ä¸€è‡´æ€§</li>
</ul>

<p><img src="https://i.loli.net/2020/09/06/gPUpLOt71yCkc4e.png" alt="image.png" /></p>

<ul>
  <li>â€‹</li>
</ul>

<h4 id="curatoræ•´åˆspring">curatoræ•´åˆspring</h4>

<ul>
  <li><a href="https://github.com/BaiWeiJieKu/MK-zookeeper-dubbo/tree/master/imooc_code/imooc-dubbo-lock">ä»£ç </a></li>
  <li>xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
       <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:util=</span><span class="s">"http://www.springframework.org/schema/util"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.2.xsd
         http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.2.xsd
         http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.2.xsd
         http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.2.xsd
         http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.2.xsd"</span><span class="nt">&gt;</span>
 
    <span class="nt">&lt;description&gt;</span>zkä¸springå®¹å™¨æ•´åˆï¼Œå¯åŠ¨é¡¹ç›®åŠ è½½æ—¶å»ºç«‹ä¸zkçš„è¿æ¥<span class="nt">&lt;/description&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"retryPolicy"</span> <span class="na">class=</span><span class="s">"org.apache.curator.retry.RetryNTimes"</span><span class="nt">&gt;</span>
         <span class="c">&lt;!--é‡è¯•æ¬¡æ•°--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"10"</span><span class="nt">/&gt;</span>
         <span class="c">&lt;!--æ¯æ¬¡é—´éš”--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"5000"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
 
    <span class="c">&lt;!--zookeeperå®¢æˆ·ç«¯--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"client"</span> <span class="na">class=</span><span class="s">"org.apache.curator.framework.CuratorFrameworkFactory"</span>
    <span class="na">factory-method=</span><span class="s">"newClient"</span> <span class="na">init-method=</span><span class="s">"start"</span><span class="nt">&gt;</span>
         <span class="c">&lt;!--zkæœåŠ¡åœ°å€ï¼Œé›†ç¾¤ç”¨","åˆ†éš”--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"127.0.0.1:2181"</span><span class="nt">/&gt;</span>
         <span class="c">&lt;!--session timeout ä¼šè¯è¶…æ—¶æ—¶é—´--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"1"</span> <span class="na">value=</span><span class="s">"10000"</span><span class="nt">/&gt;</span>
         <span class="c">&lt;!--connectionTimeoutMs åˆ›å»ºè¿æ¥è¶…æ—¶æ—¶é—´--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"2"</span> <span class="na">value=</span><span class="s">"5000"</span><span class="nt">/&gt;</span>
         <span class="c">&lt;!--é‡è¯•ç­–ç•¥--&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"3"</span> <span class="na">ref=</span><span class="s">"retryPolicy"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
 
    <span class="c">&lt;!--æ³¨å…¥zkå®¢æˆ·ç«¯--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"zkCurator"</span> <span class="na">class=</span><span class="s">"com.imooc.curator.utils.ZKCurator"</span> <span class="na">init-method=</span><span class="s">"init"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"client"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<ul>
  <li>ZKCurator</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.imooc.curator.utils</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.apache.curator.framework.CuratorFramework</span><span class="o">;</span>
 
<span class="cm">/**
 * Created by helei on 2019/1/5.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZKCurator</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">CuratorFramework</span> <span class="n">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">//zkå®¢æˆ·ç«¯</span>
 
    <span class="kd">public</span> <span class="nf">ZKCurator</span><span class="o">(</span><span class="nc">CuratorFramework</span> <span class="n">client</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="cm">/**
     * åˆå§‹åŒ–æ“ä½œ
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(){</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">usingNamespace</span><span class="o">(</span><span class="s">"zk-curator-connector"</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="cm">/**
     * åˆ¤æ–­zkæ˜¯å¦è¿æ¥
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isZKAlive</span><span class="o">(){</span>
        <span class="k">return</span> <span class="n">client</span><span class="o">.</span><span class="na">isStarted</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>controller</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">ZKCurator</span> <span class="n">zkCurator</span><span class="o">;</span>

<span class="c1">//åˆ¤æ–­zkæ˜¯å¦è¿æ¥</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"isZKAlive"</span><span class="o">)</span>
<span class="nd">@ResponseBody</span>
<span class="kd">public</span> <span class="nc">IMoocJSONResult</span> <span class="nf">isZKAlive</span><span class="o">(){</span>
  <span class="kt">boolean</span> <span class="n">isAlive</span> <span class="o">=</span> <span class="n">zkCurator</span><span class="o">.</span><span class="na">isZKAlive</span><span class="o">();</span>
  <span class="nc">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">isAlive</span><span class="o">?</span><span class="s">"è¿æ¥"</span><span class="o">:</span><span class="s">"æ–­å¼€"</span><span class="o">;</span>
  <span class="k">return</span> <span class="nc">IMoocJSONResult</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="åˆ†å¸ƒå¼é”">åˆ†å¸ƒå¼é”</h4>

<ul>
  <li>xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c">&lt;!--æ³¨å…¥åˆ†å¸ƒå¼é”å·¥å…·ç±»--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"distributedLock"</span> <span class="na">class=</span><span class="s">"com.imooc.curator.utils.DistributedLock"</span> <span class="na">init-method=</span><span class="s">"init"</span><span class="nt">&gt;</span>
         <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">ref=</span><span class="s">"client"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<ul>
  <li>DistributedLock</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.imooc.curator.utils</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.apache.curator.framework.CuratorFramework</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.curator.framework.recipes.cache.PathChildrenCache</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.curator.framework.recipes.cache.PathChildrenCacheEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.curator.framework.recipes.cache.PathChildrenCacheListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.zookeeper.CreateMode</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.zookeeper.ZooDefs</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>
 
<span class="cm">/**
 * Created by helei on 2019/1/5.
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DistributedLock</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">CuratorFramework</span> <span class="n">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">//zkå®¢æˆ·ç«¯</span>
 
    <span class="kd">final</span> <span class="kd">static</span> <span class="nc">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="nc">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="nc">DistributedLock</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
 
    <span class="c1">// ç”¨äºæŒ‚èµ·å½“å‰è¯·æ±‚ï¼Œå¹¶ä¸”ç­‰å¾…ä¸Šä¸€ä¸ªåˆ†å¸ƒå¼é”é‡Šæ”¾</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">CountDownLatch</span> <span class="n">zkLocklatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
 
    <span class="c1">// åˆ†å¸ƒå¼é”çš„æ€»ç»“ç‚¹å</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ZK_LOCK_PROJECT</span> <span class="o">=</span> <span class="s">"imooc-locks"</span><span class="o">;</span>
    <span class="c1">// åˆ†å¸ƒå¼é”èŠ‚ç‚¹</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DISTRIBUTED_LOCK</span> <span class="o">=</span> <span class="s">"distributed_lock"</span><span class="o">;</span>
 
    <span class="c1">//æ„é€ æ–¹æ³•</span>
    <span class="kd">public</span> <span class="nf">DistributedLock</span><span class="o">(</span><span class="nc">CuratorFramework</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//ä½¿ç”¨å‘½åç©ºé—´</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">usingNamespace</span><span class="o">(</span><span class="s">"ZKLocks-Namespace"</span><span class="o">);</span>
 
        <span class="cm">/**
         * åˆ›å»ºzké”çš„æ€»èŠ‚ç‚¹
         *      ZKLocks-Namespace
         *          - imooc-locks
         *              - distributed_lock
         */</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">checkExists</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">client</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">creatingParentsIfNeeded</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withMode</span><span class="o">(</span><span class="nc">CreateMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withACL</span><span class="o">(</span><span class="nc">ZooDefs</span><span class="o">.</span><span class="na">Ids</span><span class="o">.</span><span class="na">OPEN_ACL_UNSAFE</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// é’ˆå¯¹zkçš„åˆ†å¸ƒå¼é”èŠ‚ç‚¹ï¼Œåˆ›å»ºç›¸åº”çš„ watch äº‹ä»¶ç›‘å¬</span>
            <span class="n">addwatcherToLocker</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯è¿æ¥zookeeperæœåŠ¡å™¨é”™è¯¯... è¯·é‡è¯•..."</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="cm">/**
     *  åˆ›å»ºwatcherç›‘å¬
     * @param path
     * @throws Exception
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addwatcherToLocker</span><span class="o">(</span><span class="nc">String</span> <span class="n">path</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="kd">final</span> <span class="nc">PathChildrenCache</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PathChildrenCache</span><span class="o">(</span><span class="n">client</span><span class="o">,</span><span class="n">path</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="nc">PathChildrenCache</span><span class="o">.</span><span class="na">StartMode</span><span class="o">.</span><span class="na">POST_INITIALIZED_EVENT</span><span class="o">);</span>
        <span class="n">cache</span><span class="o">.</span><span class="na">getListenable</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">PathChildrenCacheListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">childEvent</span><span class="o">(</span><span class="nc">CuratorFramework</span> <span class="n">client</span><span class="o">,</span> <span class="nc">PathChildrenCacheEvent</span> <span class="n">event</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="nc">PathChildrenCacheEvent</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">CHILD_REMOVED</span><span class="o">)){</span>
                    <span class="nc">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getData</span><span class="o">().</span><span class="na">getPath</span><span class="o">();</span>
                    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"ä¸Šä¸€ä¸ªä¼šè¯å·²é‡Šæ”¾é”æˆ–è¯¥ä¼šè¯å·²æ–­å¼€ï¼ŒèŠ‚ç‚¹è·¯å¾„ä¸ºï¼š"</span> <span class="o">+</span> <span class="n">path</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="no">DISTRIBUTED_LOCK</span><span class="o">)){</span>
                        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"é‡Šæ”¾è®¡æ•°å™¨ï¼Œè®©å½“å‰è¯·æ±‚æ¥è·å¾—åˆ†å¸ƒå¼é”..."</span><span class="o">);</span>
                        <span class="n">zkLocklatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>
 
    <span class="cm">/**
     * è·å–é”
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">getLock</span><span class="o">(){</span>
        <span class="c1">//ä½¿ç”¨æ­»å¾ªç¯ï¼Œå½“ä¸”ä»…å½“ä¸Šä¸€ä¸ªé”é‡Šæ”¾å¹¶ä¸”å½“å‰è¯·æ±‚è·å¾—é”æˆåŠŸåæ‰ä¼šè·³å‡º</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">client</span><span class="o">.</span><span class="na">create</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">creatingParentsIfNeeded</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">withMode</span><span class="o">(</span><span class="nc">CreateMode</span><span class="o">.</span><span class="na">EPHEMERAL</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">withACL</span><span class="o">(</span><span class="nc">ZooDefs</span><span class="o">.</span><span class="na">Ids</span><span class="o">.</span><span class="na">OPEN_ACL_UNSAFE</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="no">DISTRIBUTED_LOCK</span><span class="o">);</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è·å¾—åˆ†å¸ƒå¼é”æˆåŠŸ..."</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è·å¾— åˆ†å¸ƒå¼é”å¤±è´¥..."</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">// å¦‚æœæ²¡æœ‰è·å¾—åˆ°é”ï¼Œéœ€è¦é‡æ–°è®¾ç½®åŒæ­¥èµ„æºå€¼</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">zkLocklatch</span><span class="o">.</span><span class="na">getCount</span><span class="o">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="n">zkLocklatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="c1">// é˜»å¡çº¿ç¨‹</span>
                    <span class="n">zkLocklatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e1</span><span class="o">){</span>
                    <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="cm">/**
     * é‡Šæ”¾åˆ†å¸ƒå¼é”
     * @return
     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">releaseLock</span><span class="o">(){</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">checkExists</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="no">DISTRIBUTED_LOCK</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">client</span><span class="o">.</span><span class="na">delete</span><span class="o">().</span><span class="na">forPath</span><span class="o">(</span><span class="s">"/"</span> <span class="o">+</span> <span class="no">ZK_LOCK_PROJECT</span> <span class="o">+</span> <span class="s">"/"</span> <span class="o">+</span> <span class="no">DISTRIBUTED_LOCK</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"åˆ†å¸ƒå¼é”é‡Šæ”¾å®Œæ¯•"</span><span class="o">);</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>displayBuy</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">displayBuy</span><span class="o">(</span><span class="nc">String</span> <span class="n">itemId</span><span class="o">)</span> <span class="o">{</span>
 
         <span class="c1">// æ‰§è¡Œè®¢å•æµç¨‹ä¹‹å‰ä½¿å½“å‰ä¸šåŠ¡è·å¾—åˆ†å¸ƒå¼é”</span>
         <span class="n">distributedLock</span><span class="o">.</span><span class="na">getLock</span><span class="o">();</span>
         
         <span class="kt">int</span> <span class="n">buyCounts</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>
         
         <span class="c1">// 1. åˆ¤æ–­åº“å­˜</span>
         <span class="kt">int</span> <span class="n">stockCounts</span> <span class="o">=</span> <span class="n">itemService</span><span class="o">.</span><span class="na">getItemCounts</span><span class="o">(</span><span class="n">itemId</span><span class="o">);</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">stockCounts</span> <span class="o">&lt;</span> <span class="n">buyCounts</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"åº“å­˜å‰©ä½™{}ä»¶ï¼Œç”¨æˆ·éœ€æ±‚é‡{}ä»¶ï¼Œåº“å­˜ä¸è¶³ï¼Œè®¢å•åˆ›å»ºå¤±è´¥..."</span><span class="o">,</span> 
                      <span class="n">stockCounts</span><span class="o">,</span> <span class="n">buyCounts</span><span class="o">);</span>
             <span class="c1">//é‡Šæ”¾é”</span>
             <span class="n">distributedLock</span><span class="o">.</span><span class="na">releaseLock</span><span class="o">();</span>
             <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
         <span class="o">}</span>
         
         <span class="c1">// 2. åˆ›å»ºè®¢å•</span>
         <span class="kt">boolean</span> <span class="n">isOrderCreated</span> <span class="o">=</span> <span class="n">ordersService</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="n">itemId</span><span class="o">);</span>
 
         <span class="c1">//æ¨¡æ‹Ÿå¤„ç†ä¸šåŠ¡éœ€è¦3ç§’</span>
         <span class="k">try</span> <span class="o">{</span>
             <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
         <span class="o">}</span>
 
         <span class="c1">// 3. åˆ›å»ºè®¢å•æˆåŠŸåï¼Œæ‰£é™¤åº“å­˜</span>
         <span class="k">if</span> <span class="o">(</span><span class="n">isOrderCreated</span><span class="o">)</span> <span class="o">{</span>
             <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è®¢å•åˆ›å»ºæˆåŠŸ..."</span><span class="o">);</span>
             <span class="n">itemService</span><span class="o">.</span><span class="na">displayReduceCounts</span><span class="o">(</span><span class="n">itemId</span><span class="o">,</span> <span class="n">buyCounts</span><span class="o">);</span>
         <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
             <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"è®¢å•åˆ›å»ºå¤±è´¥..."</span><span class="o">);</span>
             <span class="c1">//é‡Šæ”¾é”</span>
             <span class="n">distributedLock</span><span class="o">.</span><span class="na">releaseLock</span><span class="o">();</span>
             <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
         <span class="o">}</span>
         <span class="c1">//é‡Šæ”¾é”</span>
         <span class="n">distributedLock</span><span class="o">.</span><span class="na">releaseLock</span><span class="o">();</span>
         <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

</code></pre></div></div>

:ET