I"¬<ul id="markdown-toc">
  <li><a href="#ç¯å¢ƒæ­å»º" id="markdown-toc-ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</a>    <ul>
      <li><a href="#æ•°æ®æº" id="markdown-toc-æ•°æ®æº">æ•°æ®æº</a></li>
      <li><a href="#ä¸šåŠ¡å±‚" id="markdown-toc-ä¸šåŠ¡å±‚">ä¸šåŠ¡å±‚</a></li>
    </ul>
  </li>
  <li><a href="#æ€»ç»“" id="markdown-toc-æ€»ç»“">æ€»ç»“</a></li>
  <li><a href="#æºç åˆ†æ" id="markdown-toc-æºç åˆ†æ">æºç åˆ†æ</a></li>
  <li><a href="#é¿å‘æŒ‡å—" id="markdown-toc-é¿å‘æŒ‡å—">é¿å‘æŒ‡å—</a>    <ul>
      <li><a href="#é˜²æ­¢äº‹åŠ¡ä¸ç”Ÿæ•ˆ" id="markdown-toc-é˜²æ­¢äº‹åŠ¡ä¸ç”Ÿæ•ˆ">é˜²æ­¢äº‹åŠ¡ä¸ç”Ÿæ•ˆ</a></li>
      <li><a href="#äº‹åŠ¡å³ä¾¿ç”Ÿæ•ˆä¹Ÿä¸ä¸€å®šå›æ»š" id="markdown-toc-äº‹åŠ¡å³ä¾¿ç”Ÿæ•ˆä¹Ÿä¸ä¸€å®šå›æ»š">äº‹åŠ¡å³ä¾¿ç”Ÿæ•ˆä¹Ÿä¸ä¸€å®šå›æ»š</a></li>
      <li><a href="#ç¡®è®¤äº‹åŠ¡ä¼ æ’­é…ç½®æ˜¯å¦ç¬¦åˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘" id="markdown-toc-ç¡®è®¤äº‹åŠ¡ä¼ æ’­é…ç½®æ˜¯å¦ç¬¦åˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘">ç¡®è®¤äº‹åŠ¡ä¼ æ’­é…ç½®æ˜¯å¦ç¬¦åˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</a></li>
      <li><a href="#mybatisé…åˆäº‹åŠ¡" id="markdown-toc-mybatisé…åˆäº‹åŠ¡">mybatisé…åˆäº‹åŠ¡</a></li>
    </ul>
  </li>
</ul>
<h3 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        &lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-context --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
            &lt;version&gt;4.3.12.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;
            &lt;version&gt;4.3.12.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework&lt;/groupId&gt;
            &lt;artifactId&gt;spring-jdbc&lt;/artifactId&gt;
            &lt;version&gt;4.3.12.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;

</code></pre></div></div>

<h4 id="æ•°æ®æº">æ•°æ®æº</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
     å£°æ˜å¼äº‹åŠ¡ï¼š

    ç¯å¢ƒæ­å»ºï¼š
        1.å¯¼å…¥ç›¸å…³ä¾èµ–ï¼šæ•°æ®æºã€æ•°æ®åº“é©±åŠ¨ã€Spring-jdbcæ¨¡å—
        2.é…ç½®æ•°æ®æºã€JdbcTemplateï¼ˆSpringæä¾›ç®€åŒ–æ•°æ®åº“æ“ä½œçš„å·¥å…·ï¼‰æ“ä½œæ•°æ®
        3.ç»™æ–¹æ³•ä¸Šæ ‡æ³¨@Transactionalæ³¨è§£è¡¨ç¤ºå½“å‰çš„æ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼›
        4.@EnableTransactionManagement å¼€å¯åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†åŠŸèƒ½ï¼›
        5.é…ç½®äº‹åŠ¡ç®¡ç†å™¨æ¥æ§åˆ¶äº‹åŠ¡
 */</span>
<span class="nd">@ComponentScan</span><span class="o">({</span><span class="s">"com.ldc.tx"</span><span class="o">})</span>
<span class="nd">@PropertySource</span><span class="o">({</span><span class="s">"classpath:dbconfig.properties"</span><span class="o">})</span>
<span class="nd">@Configuration</span>
<span class="nd">@EnableTransactionManagement</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TxConfig</span> <span class="o">{</span>

    <span class="c1">//æ•°æ®æº</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PropertyVetoException</span> <span class="o">{</span>
        <span class="nc">ComboPooledDataSource</span> <span class="n">dataSource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ComboPooledDataSource</span><span class="o">();</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">"root"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">"12358"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setDriverClass</span><span class="o">(</span><span class="s">"com.mysql.jdbc.Driver"</span><span class="o">);</span>
        <span class="n">dataSource</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">"jdbc:mysql://localhost:3306/test"</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">dataSource</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JdbcTemplate</span> <span class="nf">jdbcTemplate</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PropertyVetoException</span> <span class="o">{</span>
        <span class="c1">//Springä¼šçš„@Configurationç±»ä¼šåšç‰¹æ®Šçš„å¤„ç†ï¼šç»™å®¹å™¨ä¸­æ·»åŠ ç»„ä»¶ï¼Œå¤šæ¬¡è°ƒç”¨éƒ½æ˜¯ä»å®¹å™¨ä¸­æ‰¾ç»„ä»¶</span>
        <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcTemplate</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">jdbcTemplate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//æ³¨å†Œäº‹åŠ¡ç®¡ç†å™¨åœ¨å®¹å™¨ä¸­</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PropertyVetoException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h4 id="ä¸šåŠ¡å±‚">ä¸šåŠ¡å±‚</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Repository</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDao</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JdbcTemplate</span> <span class="n">jdbcTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insert</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"INSERT INTO `tbl_user` (username,age)VALUES(?,?)"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
        <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">username</span><span class="o">,</span> <span class="mi">19</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">insertUser</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">userDao</span><span class="o">.</span><span class="na">insert</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ’å…¥å®Œæˆ..."</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test01</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">AnnotationConfigApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AnnotationConfigApplicationContext</span><span class="o">(</span><span class="nc">TxConfig</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">UserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">UserService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">insertUser</span><span class="o">();</span>
    <span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å†æ¥è¿è¡Œæµ‹è¯•æ–¹æ³•ï¼Œæ•°æ®å°±æ²¡æœ‰æ’å…¥æˆåŠŸäº†ï¼Œäº‹åŠ¡å°±å·²ç»ç”Ÿæ•ˆäº†ï¼›</li>
</ul>

<h3 id="æ€»ç»“">æ€»ç»“</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="n">å£°æ˜å¼äº‹åŠ¡</span><span class="err">ï¼š</span>

    <span class="n">ç¯å¢ƒæ­å»º</span><span class="err">ï¼š</span>
        <span class="mi">1</span><span class="o">.</span><span class="na">å¯¼å…¥ç›¸å…³ä¾èµ–</span><span class="err">ï¼š</span><span class="n">æ•°æ®æº</span><span class="err">ã€</span><span class="n">æ•°æ®åº“é©±åŠ¨</span><span class="err">ã€</span><span class="nc">Spring</span><span class="o">-</span><span class="n">jdbcæ¨¡å—</span>
        <span class="mi">2</span><span class="o">.</span><span class="na">é…ç½®æ•°æ®æº</span><span class="err">ã€</span><span class="nc">JdbcTemplate</span><span class="err">ï¼ˆ</span><span class="nc">Springæä¾›ç®€åŒ–æ•°æ®åº“æ“ä½œçš„å·¥å…·</span><span class="err">ï¼‰</span><span class="n">æ“ä½œæ•°æ®</span>
        <span class="mi">3</span><span class="o">.</span><span class="na">ç»™æ–¹æ³•ä¸Šæ ‡æ³¨</span><span class="nd">@Transactionalæ³¨è§£è¡¨ç¤ºå½“å‰çš„æ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•</span><span class="err">ï¼›</span>
        <span class="mi">4</span><span class="o">.</span><span class="nd">@EnableTransactionManagement</span> <span class="n">å¼€å¯åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†åŠŸèƒ½</span><span class="err">ï¼›</span>
        <span class="mi">5</span><span class="o">.</span><span class="na">é…ç½®äº‹åŠ¡ç®¡ç†å™¨æ¥æ§åˆ¶äº‹åŠ¡</span><span class="err">ï¼ˆ</span><span class="n">å¿…é¡»è¦æœ‰è¿™ä¸€æ­¥</span><span class="err">ï¼‰</span>
         <span class="c1">//æ³¨å†Œäº‹åŠ¡ç®¡ç†å™¨åœ¨å®¹å™¨ä¸­</span>
         <span class="nd">@Bean</span>
         <span class="kd">public</span> <span class="nc">PlatformTransactionManager</span> <span class="nf">transactionManager</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">PropertyVetoException</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">DataSourceTransactionManager</span><span class="o">(</span><span class="n">dataSource</span><span class="o">());</span>
         <span class="o">}</span>

</code></pre></div></div>

<h3 id="æºç åˆ†æ">æºç åˆ†æ</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  å£°æ˜å¼äº‹åŠ¡ï¼š
 
  ç¯å¢ƒæ­å»ºï¼š
  1ã€å¯¼å…¥ç›¸å…³ä¾èµ–
  		æ•°æ®æºã€æ•°æ®åº“é©±åŠ¨ã€Spring-jdbcæ¨¡å—
  2ã€é…ç½®æ•°æ®æºã€JdbcTemplateï¼ˆSpringæä¾›çš„ç®€åŒ–æ•°æ®åº“æ“ä½œçš„å·¥å…·ï¼‰æ“ä½œæ•°æ®
  3ã€ç»™æ–¹æ³•ä¸Šæ ‡æ³¨ @Transactional è¡¨ç¤ºå½“å‰æ–¹æ³•æ˜¯ä¸€ä¸ªäº‹åŠ¡æ–¹æ³•ï¼›
  4ã€ @EnableTransactionManagement å¼€å¯åŸºäºæ³¨è§£çš„äº‹åŠ¡ç®¡ç†åŠŸèƒ½ï¼›
  		@EnableXXX
  5ã€é…ç½®äº‹åŠ¡ç®¡ç†å™¨æ¥æ§åˆ¶äº‹åŠ¡;
  		@Bean
  		public PlatformTransactionManager transactionManager()
 
 
  åŸç†ï¼š
  1ï¼‰ã€@EnableTransactionManagement
  			åˆ©ç”¨TransactionManagementConfigurationSelectorç»™å®¹å™¨ä¸­ä¼šå¯¼å…¥ç»„ä»¶
  			å¯¼å…¥ä¸¤ä¸ªç»„ä»¶
  			AutoProxyRegistrar
  			ProxyTransactionManagementConfiguration
  2ï¼‰ã€AutoProxyRegistrarï¼š
  			ç»™å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ª InfrastructureAdvisorAutoProxyCreator ç»„ä»¶ï¼›
  			InfrastructureAdvisorAutoProxyCreatorï¼šï¼Ÿ
  			åˆ©ç”¨åç½®å¤„ç†å™¨æœºåˆ¶åœ¨å¯¹è±¡åˆ›å»ºä»¥åï¼ŒåŒ…è£…å¯¹è±¡ï¼Œè¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ˆå¢å¼ºå™¨ï¼‰ï¼Œä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•åˆ©ç”¨æ‹¦æˆªå™¨é“¾è¿›è¡Œè°ƒç”¨ï¼›
 
  3ï¼‰ã€ProxyTransactionManagementConfiguration åšäº†ä»€ä¹ˆï¼Ÿ
  			1ã€ç»™å®¹å™¨ä¸­æ³¨å†Œäº‹åŠ¡å¢å¼ºå™¨ï¼›
  				1ï¼‰ã€äº‹åŠ¡å¢å¼ºå™¨è¦ç”¨äº‹åŠ¡æ³¨è§£çš„ä¿¡æ¯ï¼ŒAnnotationTransactionAttributeSourceè§£æäº‹åŠ¡æ³¨è§£
  				2ï¼‰ã€äº‹åŠ¡æ‹¦æˆªå™¨ï¼š
  					TransactionInterceptorï¼›ä¿å­˜äº†äº‹åŠ¡å±æ€§ä¿¡æ¯ï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼›
  					ä»–æ˜¯ä¸€ä¸ª MethodInterceptorï¼›
  					åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼›
  						æ‰§è¡Œæ‹¦æˆªå™¨é“¾ï¼›
  						äº‹åŠ¡æ‹¦æˆªå™¨ï¼š
  							1ï¼‰ã€å…ˆè·å–äº‹åŠ¡ç›¸å…³çš„å±æ€§
  							2ï¼‰ã€å†è·å–PlatformTransactionManagerï¼Œå¦‚æœäº‹å…ˆæ²¡æœ‰æ·»åŠ æŒ‡å®šä»»ä½•transactionmanger
  								æœ€ç»ˆä¼šä»å®¹å™¨ä¸­æŒ‰ç…§ç±»å‹è·å–ä¸€ä¸ªPlatformTransactionManagerï¼›
  							3ï¼‰ã€æ‰§è¡Œç›®æ ‡æ–¹æ³•
  								å¦‚æœå¼‚å¸¸ï¼Œè·å–åˆ°äº‹åŠ¡ç®¡ç†å™¨ï¼Œåˆ©ç”¨äº‹åŠ¡ç®¡ç†å›æ»šæ“ä½œï¼›
  								å¦‚æœæ­£å¸¸ï¼Œåˆ©ç”¨äº‹åŠ¡ç®¡ç†å™¨ï¼Œæäº¤äº‹åŠ¡

</code></pre></div></div>

<h3 id="é¿å‘æŒ‡å—">é¿å‘æŒ‡å—</h3>

<h4 id="é˜²æ­¢äº‹åŠ¡ä¸ç”Ÿæ•ˆ">é˜²æ­¢äº‹åŠ¡ä¸ç”Ÿæ•ˆ</h4>

<ul>
  <li>
    <p>å› ä¸ºé…ç½®ä¸æ­£ç¡®ï¼Œå¯¼è‡´æ–¹æ³•ä¸Šçš„äº‹åŠ¡æ²¡ç”Ÿæ•ˆã€‚æˆ‘ä»¬åŠ¡å¿…ç¡®è®¤è°ƒç”¨ @Transactional æ³¨
è§£æ ‡è®°çš„æ–¹æ³•æ˜¯ public çš„ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡ Spring æ³¨å…¥çš„ Bean è¿›è¡Œè°ƒç”¨çš„ã€‚</p>
  </li>
  <li>
    <p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªå…·æœ‰ ID å’Œå§“åå±æ€§çš„ UserEntity</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Entity</span>
  <span class="nd">@Data</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserEntity</span> <span class="o">{</span>
    <span class="nd">@Id</span>
    <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">strategy</span> <span class="o">=</span> <span class="no">AUTO</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">UserEntity</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">UserEntity</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    	<span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨ Spring JPA åšæ•°æ®åº“è®¿é—®ï¼Œå®ç°è¿™æ ·ä¸€ä¸ª Repositoryï¼Œæ–°å¢ä¸€ä¸ªæ ¹æ®ç”¨æˆ·åæŸ¥è¯¢æ‰€æœ‰æ•°æ®çš„æ–¹æ³•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Repository</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserRepository</span> <span class="kd">extends</span> <span class="nc">JpaRepository</span><span class="o">&lt;</span><span class="nc">UserEntity</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>
  	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">UserEntity</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>å®šä¹‰ä¸€ä¸ª UserService ç±»ï¼Œè´Ÿè´£ä¸šåŠ¡é€»è¾‘å¤„ç†,ç”¨æˆ·åˆ›å»ºæ“ä½œå¤±è´¥ï¼ŒæœŸæœ›äº‹åŠ¡å¯ä»¥å›æ»š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@Service</span>
  <span class="nd">@Slf4j</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
      <span class="nd">@Autowired</span>
      <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>
      <span class="nd">@Autowired</span>
      <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">self</span><span class="o">;</span>

      <span class="nd">@PostConstruct</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
          <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"this {} self {}"</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">self</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="c1">//ä¸€ä¸ªå…¬å…±æ–¹æ³•ä¾›Controllerè°ƒç”¨ï¼Œå†…éƒ¨è°ƒç”¨äº‹åŠ¡æ€§çš„ç§æœ‰æ–¹æ³•</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">createUserWrong1</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="k">this</span><span class="o">.</span><span class="na">createUserPrivate</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed because {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
      <span class="o">}</span>



      <span class="c1">//æ ‡è®°äº†@Transactionalçš„privateæ–¹æ³•</span>
      <span class="nd">@Transactional</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createUserPrivate</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"invalid username!"</span><span class="o">);</span>
      <span class="o">}</span>



      <span class="c1">//é‡æ–°æ³¨å…¥è‡ªå·±</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">createUserRight</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="n">self</span><span class="o">.</span><span class="na">createUserPublic</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed because {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
      <span class="o">}</span>


      <span class="c1">//ä¸å‡ºå¼‚å¸¸</span>
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">createUserWrong3</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="k">this</span><span class="o">.</span><span class="na">createUserPublic</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed because {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
      <span class="o">}</span>
    
      <span class="c1">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·æ•°</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getUserCount</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä¸‹é¢æ˜¯ Controller çš„å®ç°ï¼Œåªæ˜¯è°ƒç”¨ä¸€ä¸‹åˆšæ‰å®šä¹‰çš„ UserService ä¸­çš„å…¥å£æ–¹æ³•createUserWrong1</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@RestController</span>
  <span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"transactionproxyfailed"</span><span class="o">)</span>
  <span class="nd">@Slf4j</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionProxyFailedController</span> <span class="o">{</span>

      <span class="nd">@Autowired</span>
      <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

      <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong1"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong1</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">createUserWrong1</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong2"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong2</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">createUserWrong2</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong3"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong3</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">createUserWrong3</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right1"</span><span class="o">)</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">right1</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">createUserRight</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
      <span class="o">}</span>



  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>è°ƒç”¨æ¥å£åå‘ç°ï¼Œå³ä¾¿ç”¨æˆ·åä¸åˆæ³•ï¼Œç”¨æˆ·ä¹Ÿèƒ½åˆ›å»ºæˆåŠŸã€‚</p>
  </li>
  <li>
    <p><strong>@Transactional ç”Ÿæ•ˆåŸåˆ™ 1</strong>ï¼Œé™¤éç‰¹æ®Šé…ç½®ï¼ˆæ¯”å¦‚ä½¿ç”¨ AspectJ é™æ€ç»‡å…¥å®ç°AOPï¼‰ï¼Œå¦åˆ™<strong>åªæœ‰å®šä¹‰åœ¨ public æ–¹æ³•ä¸Šçš„ @Transactional æ‰èƒ½ç”Ÿæ•ˆ</strong>ã€‚åŸå› æ˜¯ï¼ŒSpringé»˜è®¤é€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç° AOPï¼Œå¯¹ç›®æ ‡æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œprivate æ–¹æ³•æ— æ³•ä»£ç†åˆ°ï¼ŒSpring è‡ªç„¶ä¹Ÿæ— æ³•åŠ¨æ€å¢å¼ºäº‹åŠ¡å¤„ç†é€»è¾‘ã€‚</p>
  </li>
  <li>
    <p>æŠŠæ ‡è®°äº†äº‹åŠ¡æ³¨è§£çš„ createUserPrivate æ–¹æ³•æ”¹ä¸º publicå³å¯ã€‚åœ¨ UserService ä¸­å†å»ºä¸€ä¸ªå…¥å£æ–¹æ³• createUserWrong2ï¼Œæ¥è°ƒç”¨è¿™ä¸ª public æ–¹æ³•å†æ¬¡å°è¯•</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1">//è‡ªè°ƒç”¨</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">createUserWrong2</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="k">this</span><span class="o">.</span><span class="na">createUserPublic</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
              <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed because {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="c1">//å¯ä»¥ä¼ æ’­å‡ºå¼‚å¸¸</span>
      <span class="nd">@Transactional</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserPublic</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">contains</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
              <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"invalid username!"</span><span class="o">);</span>
      <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>æµ‹è¯•å‘ç°ï¼Œè°ƒç”¨æ–°çš„ createUserWrong2 æ–¹æ³•äº‹åŠ¡åŒæ ·ä¸ç”Ÿæ•ˆã€‚</p>
  </li>
  <li>
    <p><strong>@Transactional ç”Ÿæ•ˆåŸåˆ™ 2</strong>ï¼Œå¿…é¡»é€šè¿‡ä»£ç†è¿‡çš„ç±»ä»å¤–éƒ¨è°ƒç”¨ç›®æ ‡æ–¹æ³•æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
  </li>
  <li>
    <p>è®© Controller ç›´æ¥è°ƒç”¨ä¹‹å‰å®šä¹‰çš„ UserService çš„ createUserPublicæ–¹æ³•</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right2"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">right2</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">userService</span><span class="o">.</span><span class="na">createUserPublic</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed because {}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUserCount</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>this è‡ªè°ƒç”¨ã€é€šè¿‡ self è°ƒç”¨ï¼Œä»¥åŠåœ¨ Controller ä¸­è°ƒç”¨UserService ä¸‰ç§å®ç°çš„åŒºåˆ«</li>
</ul>

<p>é€šè¿‡ this è‡ªè°ƒç”¨ï¼Œæ²¡æœ‰æœºä¼šèµ°åˆ° Spring çš„ä»£ç†ç±»</p>

<p>åä¸¤ç§æ”¹è¿›æ–¹æ¡ˆè°ƒç”¨çš„æ˜¯ Spring æ³¨å…¥çš„ UserServiceï¼Œé€šè¿‡ä»£ç†è°ƒç”¨æ‰æœ‰æœºä¼šå¯¹ createUserPublic æ–¹æ³•è¿›è¡ŒåŠ¨æ€å¢å¼ºã€‚</p>

<ul>
  <li>å¼ºçƒˆå»ºè®®ä½ åœ¨å¼€å‘æ—¶æ‰“å¼€ç›¸å…³çš„ Debug æ—¥å¿—ï¼Œä»¥æ–¹ä¾¿äº†è§£Spring äº‹åŠ¡å®ç°çš„ç»†èŠ‚ï¼Œå¹¶åŠæ—¶åˆ¤æ–­äº‹åŠ¡çš„æ‰§è¡Œæƒ…å†µ</li>
</ul>

<h4 id="äº‹åŠ¡å³ä¾¿ç”Ÿæ•ˆä¹Ÿä¸ä¸€å®šå›æ»š">äº‹åŠ¡å³ä¾¿ç”Ÿæ•ˆä¹Ÿä¸ä¸€å®šå›æ»š</h4>

<ul>
  <li>
    <p>å› ä¸ºå¼‚å¸¸å¤„ç†ä¸æ­£ç¡®ï¼Œå¯¼è‡´äº‹åŠ¡è™½ç„¶ç”Ÿæ•ˆä½†å‡ºç°å¼‚å¸¸æ—¶æ²¡å›æ»šã€‚Spring é»˜è®¤åªä¼šå¯¹
æ ‡è®° @Transactional æ³¨è§£çš„æ–¹æ³•å‡ºç°äº† RuntimeException å’Œ Error çš„æ—¶å€™å›æ»šï¼Œå¦‚æœ
æˆ‘ä»¬çš„æ–¹æ³•æ•è·äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆéœ€è¦é€šè¿‡æ‰‹åŠ¨ç¼–ç å¤„ç†äº‹åŠ¡å›æ»šã€‚å¦‚æœå¸Œæœ› Spring é’ˆå¯¹å…¶ä»–
å¼‚å¸¸ä¹Ÿå¯ä»¥å›æ»šï¼Œé‚£ä¹ˆå¯ä»¥ç›¸åº”é…ç½® @Transactional æ³¨è§£çš„ rollbackFor å’Œ
noRollbackFor å±æ€§æ¥è¦†ç›–å…¶é»˜è®¤è®¾ç½®ã€‚</p>
  </li>
  <li>é€šè¿‡ AOP å®ç°äº‹åŠ¡å¤„ç†å¯ä»¥ç†è§£ä¸ºï¼Œä½¿ç”¨ tryâ€¦catchâ€¦æ¥åŒ…è£¹æ ‡è®°äº† @Transactional æ³¨
è§£çš„æ–¹æ³•ï¼Œå½“æ–¹æ³•å‡ºç°äº†å¼‚å¸¸å¹¶ä¸”æ»¡è¶³ä¸€å®šæ¡ä»¶çš„æ—¶å€™ï¼Œåœ¨ catch é‡Œé¢æˆ‘ä»¬å¯ä»¥è®¾ç½®äº‹åŠ¡
å›æ»šï¼Œæ²¡æœ‰å¼‚å¸¸åˆ™ç›´æ¥æäº¤äº‹åŠ¡ã€‚</li>
  <li><strong>ç¬¬ä¸€ï¼Œåªæœ‰å¼‚å¸¸ä¼ æ’­å‡ºäº†æ ‡è®°äº† @Transactional æ³¨è§£çš„æ–¹æ³•ï¼Œäº‹åŠ¡æ‰èƒ½å›æ»šã€‚</strong></li>
  <li><strong>ç¬¬äºŒï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå‡ºç° RuntimeExceptionï¼ˆéå—æ£€å¼‚å¸¸ï¼‰æˆ– Error çš„æ—¶å€™ï¼ŒSpringæ‰ä¼šå›æ»šäº‹åŠ¡ã€‚</strong>å—æ£€å¼‚å¸¸ä¸€èˆ¬æ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œæˆ–è€…è¯´æ˜¯ç±»ä¼¼å¦ä¸€ç§æ–¹æ³•çš„è¿”å›å€¼ï¼Œå‡ºç°è¿™æ ·çš„å¼‚å¸¸å¯èƒ½ä¸šåŠ¡è¿˜èƒ½å®Œæˆï¼Œæ‰€ä»¥ä¸ä¼šä¸»åŠ¨å›æ»šï¼›è€ŒError æˆ– RuntimeException ä»£è¡¨äº†éé¢„æœŸçš„ç»“æœï¼Œåº”è¯¥å›æ»š</li>
  <li>åœ¨ createUserWrong1 æ–¹æ³•ä¸­ä¼šæŠ›å‡ºä¸€ä¸ª RuntimeExceptionï¼Œä½†ç”±äºæ–¹æ³•å†… catch äº†
æ‰€æœ‰å¼‚å¸¸ï¼Œå¼‚å¸¸æ— æ³•ä»æ–¹æ³•ä¼ æ’­å‡ºå»ï¼Œäº‹åŠ¡è‡ªç„¶æ— æ³•å›æ»šã€‚</li>
  <li>åœ¨ createUserWrong2 æ–¹æ³•ä¸­ï¼Œæ³¨å†Œç”¨æˆ·çš„åŒæ—¶ä¼šæœ‰ä¸€æ¬¡ otherTask æ–‡ä»¶è¯»å–æ“ä½œï¼Œ
å¦‚æœæ–‡ä»¶è¯»å–å¤±è´¥ï¼Œæˆ‘ä»¬å¸Œæœ›ç”¨æˆ·æ³¨å†Œçš„æ•°æ®åº“æ“ä½œå›æ»šã€‚è™½ç„¶è¿™é‡Œæ²¡æœ‰æ•è·å¼‚å¸¸ï¼Œä½†
å› ä¸º otherTask æ–¹æ³•æŠ›å‡ºçš„æ˜¯å—æ£€å¼‚å¸¸ï¼ŒcreateUserWrong2 ä¼ æ’­å‡ºå»çš„ä¹Ÿæ˜¯å—æ£€å¼‚
å¸¸ï¼Œäº‹åŠ¡åŒæ ·ä¸ä¼šå›æ»šã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="c1">//å¼‚å¸¸æ— æ³•ä¼ æ’­å‡ºæ–¹æ³•ï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•å›æ»š</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserWrong1</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"error"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//å³ä½¿å‡ºäº†å—æ£€å¼‚å¸¸ä¹Ÿæ— æ³•è®©äº‹åŠ¡å›æ»š</span>
    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserWrong2</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
        <span class="n">otherTask</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//å› ä¸ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¸€å®šä¼šæŠ›å‡ºä¸€ä¸ªIOException</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">otherTask</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">Files</span><span class="o">.</span><span class="na">readAllLines</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"file-that-not-exist"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Controller ä¸­çš„å®ç°ï¼Œä»…ä»…æ˜¯è°ƒç”¨ UserService çš„ createUserWrong1 å’ŒcreateUserWrong2 æ–¹æ³•ï¼Œè¿™ 2 ä¸ªæ–¹æ³•çš„å®ç°å’Œè°ƒç”¨ï¼Œè™½ç„¶å®Œå…¨é¿å¼€äº†äº‹åŠ¡ä¸ç”Ÿæ•ˆçš„å‘ï¼Œä½†å› ä¸ºå¼‚å¸¸å¤„ç†ä¸å½“ï¼Œå¯¼è‡´ç¨‹åºæ²¡æœ‰å¦‚æˆ‘ä»¬æœŸæœ›çš„æ–‡ä»¶æ“ä½œå‡ºç°å¼‚å¸¸æ—¶å›æ»šäº‹åŠ¡ã€‚</li>
  <li>ç¬¬ä¸€ï¼Œå¦‚æœä½ å¸Œæœ›è‡ªå·±æ•è·å¼‚å¸¸è¿›è¡Œå¤„ç†çš„è¯ï¼Œä¹Ÿæ²¡å…³ç³»ï¼Œå¯ä»¥æ‰‹åŠ¨è®¾ç½®è®©å½“å‰äº‹åŠ¡å¤„äºå›æ»šçŠ¶æ€ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserRight1</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"error"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user failed"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
            <span class="nc">TransactionAspectSupport</span><span class="o">.</span><span class="na">currentTransactionStatus</span><span class="o">().</span><span class="na">setRollbackOnly</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"result {} "</span><span class="o">,</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">());</span><span class="c1">//ä¸ºä»€ä¹ˆè¿™é‡Œæ˜¯1ä½ èƒ½æƒ³æ˜ç™½å—ï¼Ÿ</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç¬¬äºŒï¼Œåœ¨æ³¨è§£ä¸­å£°æ˜ï¼ŒæœŸæœ›é‡åˆ°æ‰€æœ‰çš„ Exception éƒ½å›æ»šäº‹åŠ¡ï¼ˆæ¥çªç ´é»˜è®¤ä¸å›æ»šå—æ£€å¼‚
å¸¸çš„é™åˆ¶ï¼‰ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//DefaultTransactionAttribute</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">rollbackFor</span> <span class="o">=</span> <span class="nc">Exception</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserRight2</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
        <span class="n">otherTask</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="ç¡®è®¤äº‹åŠ¡ä¼ æ’­é…ç½®æ˜¯å¦ç¬¦åˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘">ç¡®è®¤äº‹åŠ¡ä¼ æ’­é…ç½®æ˜¯å¦ç¬¦åˆè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘</h4>

<ul>
  <li>
    <p>å¦‚æœæ–¹æ³•æ¶‰åŠå¤šæ¬¡æ•°æ®åº“æ“ä½œï¼Œå¹¶å¸Œæœ›å°†å®ƒä»¬ä½œä¸ºç‹¬ç«‹çš„äº‹åŠ¡è¿›è¡Œæäº¤æˆ–å›æ»šï¼Œé‚£ä¹ˆ
æˆ‘ä»¬éœ€è¦è€ƒè™‘è¿›ä¸€æ­¥ç»†åŒ–é…ç½®äº‹åŠ¡ä¼ æ’­æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ @Transactional æ³¨è§£çš„
Propagation å±æ€§ã€‚</p>
  </li>
  <li>æœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼šä¸€ä¸ªç”¨æˆ·æ³¨å†Œçš„æ“ä½œï¼Œä¼šæ’å…¥ä¸€ä¸ªä¸»ç”¨æˆ·åˆ°ç”¨æˆ·è¡¨ï¼Œè¿˜ä¼šæ³¨å†Œä¸€ä¸ªå…³è”çš„
å­ç”¨æˆ·ã€‚æˆ‘ä»¬å¸Œæœ›å°†å­ç”¨æˆ·æ³¨å†Œçš„æ•°æ®åº“æ“ä½œä½œä¸ºä¸€ä¸ªç‹¬ç«‹äº‹åŠ¡æ¥å¤„ç†ï¼Œå³ä½¿å¤±è´¥ä¹Ÿä¸ä¼šå½±
å“ä¸»æµç¨‹ï¼Œå³ä¸å½±å“ä¸»ç”¨æˆ·çš„æ³¨å†Œã€‚</li>
  <li>æ¨¡æ‹Ÿä¸€ä¸ªå®ç°ç±»ä¼¼ä¸šåŠ¡é€»è¾‘çš„ UserServiceï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SubUserService</span> <span class="n">subUserService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserWrong</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">createMainUser</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="n">subUserService</span><span class="o">.</span><span class="na">createSubUserWithExceptionWrong</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getUserCount</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="na">size</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createMainUser</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"createMainUser finish"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>SubUserService çš„ createSubUserWithExceptionWrong å®ç°æ­£å¦‚å…¶åï¼Œå› ä¸ºæœ€åæˆ‘ä»¬æŠ›å‡ºäº†ä¸€ä¸ªè¿è¡Œæ—¶å¼‚å¸¸ï¼Œé”™è¯¯åŸå› æ˜¯ç”¨æˆ·çŠ¶æ€æ— æ•ˆï¼Œæ‰€ä»¥å­ç”¨æˆ·çš„æ³¨å†Œè‚¯å®šæ˜¯å¤±è´¥çš„ã€‚æˆ‘ä»¬æœŸæœ›å­ç”¨æˆ·çš„æ³¨å†Œä½œä¸ºä¸€ä¸ªäº‹åŠ¡å•ç‹¬å›æ»šï¼Œä¸å½±å“ä¸»ç”¨æˆ·çš„æ³¨å†Œï¼Œè¿™æ ·çš„é€»è¾‘å¯ä»¥å®ç°å—ï¼Ÿ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubUserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserRepository</span> <span class="n">userRepository</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createSubUserWithExceptionWrong</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"createSubUserWithExceptionWrong start"</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"invalid status"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æˆ‘ä»¬åœ¨ Controller é‡Œå®ç°ä¸€æ®µæµ‹è¯•ä»£ç ï¼Œè°ƒç”¨ UserService</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"transactionpropagation"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TransactionPropagationController</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">wrong</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userService</span><span class="o">.</span><span class="na">createUserWrong</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserEntity</span><span class="o">(</span><span class="n">name</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"createUserWrong failed, reason:{}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUserCount</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>è°ƒç”¨åå¾ˆæ˜æ˜¾äº‹åŠ¡å›æ»šäº†ï¼Œå› ä¸ºè¿è¡Œæ—¶å¼‚å¸¸é€ƒå‡ºäº† @Transactional æ³¨è§£æ ‡è®°çš„
createUserWrong æ–¹æ³•ï¼ŒSpring å½“ç„¶ä¼šå›æ»šäº‹åŠ¡äº†ã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›ä¸»æ–¹æ³•ä¸å›æ»šï¼Œåº”è¯¥
æŠŠå­æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸æ•è·äº†ã€‚ä¹Ÿå°±æ˜¯è¿™ä¹ˆæ”¹ï¼ŒæŠŠ subUserService.createSubUserWithExceptionWrong åŒ…è£¹ä¸Šcatchï¼Œè¿™æ ·å¤–å±‚ä¸»æ–¹æ³•å°±ä¸ä¼šå‡ºç°å¼‚å¸¸äº†</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserWrong2</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">createMainUser</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subUserService</span><span class="o">.</span><span class="na">createSubUserWithExceptionWrong</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// è™½ç„¶æ•è·äº†å¼‚å¸¸ï¼Œä½†æ˜¯å› ä¸ºæ²¡æœ‰å¼€å¯æ–°äº‹åŠ¡ï¼Œè€Œå½“å‰äº‹åŠ¡å› ä¸ºå¼‚å¸¸å·²ç»è¢«æ ‡è®°ä¸ºrollbackäº†ï¼Œæ‰€ä»¥æœ€ç»ˆè¿˜æ˜¯ä¼šå›æ»šã€‚</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create sub user error:{}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æˆ‘ä»¬ä¹‹å‰è¯´ï¼Œå‡ºäº†å¼‚å¸¸äº‹åŠ¡ä¸ä¸€å®šå›æ»šï¼Œè¿™é‡Œè¯´çš„å´æ˜¯ä¸å‡ºå¼‚å¸¸ï¼Œäº‹åŠ¡ä¹Ÿä¸
ä¸€å®šå¯ä»¥æäº¤ã€‚åŸå› æ˜¯ï¼Œ<strong>ä¸»æ–¹æ³•æ³¨å†Œä¸»ç”¨æˆ·çš„é€»è¾‘å’Œå­æ–¹æ³•æ³¨å†Œå­ç”¨æˆ·çš„é€»è¾‘æ˜¯åŒä¸€ä¸ªäº‹</strong>
<strong>åŠ¡</strong>ï¼Œå­é€»è¾‘æ ‡è®°äº†äº‹åŠ¡éœ€è¦å›æ»šï¼Œä¸»é€»è¾‘è‡ªç„¶ä¹Ÿä¸èƒ½æäº¤äº†ã€‚</li>
  <li>ä¿®å¤æ–¹å¼å°±å¾ˆæ˜ç¡®äº†ï¼Œæƒ³åŠæ³•è®©å­é€»è¾‘åœ¨ç‹¬ç«‹äº‹åŠ¡ä¸­è¿è¡Œï¼Œä¹Ÿå°±æ˜¯æ”¹ä¸€ä¸‹
SubUserService æ³¨å†Œå­ç”¨æˆ·çš„æ–¹æ³•ï¼Œä¸ºæ³¨è§£åŠ ä¸Š propagation =
Propagation.REQUIRES_NEW æ¥è®¾ç½® REQUIRES_NEW æ–¹å¼çš„äº‹åŠ¡ä¼ æ’­ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯æ‰§
è¡Œåˆ°è¿™ä¸ªæ–¹æ³•æ—¶éœ€è¦å¼€å¯æ–°çš„äº‹åŠ¡ï¼Œå¹¶æŒ‚èµ·å½“å‰äº‹åŠ¡</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createSubUserWithExceptionRight</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"createSubUserWithExceptionRight start"</span><span class="o">);</span>
        <span class="n">userRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"invalid status"</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä¸»æ–¹æ³•æ²¡ä»€ä¹ˆå˜åŒ–ï¼ŒåŒæ ·éœ€è¦æ•è·å¼‚å¸¸ï¼Œé˜²æ­¢å¼‚å¸¸æ¼å‡ºå»å¯¼è‡´ä¸»äº‹åŠ¡å›æ»šï¼Œé‡æ–°å‘½åä¸º
createUserRight</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUserRight</span><span class="o">(</span><span class="nc">UserEntity</span> <span class="n">entity</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">createMainUser</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subUserService</span><span class="o">.</span><span class="na">createSubUserWithExceptionRight</span><span class="o">(</span><span class="n">entity</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// æ•è·å¼‚å¸¸ï¼Œé˜²æ­¢ä¸»æ–¹æ³•å›æ»š</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create sub user error:{}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>
    <p>æ”¹é€ åï¼Œé‡æ–°è¿è¡Œç¨‹åºå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„å…³é”®æ—¥å¿—ï¼š</p>

    <p>ç¬¬ 1 è¡Œæ—¥å¿—æç¤ºæˆ‘ä»¬é’ˆå¯¹ createUserRight æ–¹æ³•å¼€å¯äº†ä¸»æ–¹æ³•çš„äº‹åŠ¡ï¼›
ç¬¬ 2 è¡Œæ—¥å¿—æç¤ºåˆ›å»ºä¸»ç”¨æˆ·å®Œæˆï¼›
ç¬¬ 3 è¡Œæ—¥å¿—å¯ä»¥çœ‹åˆ°ä¸»äº‹åŠ¡æŒ‚èµ·äº†ï¼Œå¼€å¯äº†ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œé’ˆå¯¹
createSubUserWithExceptionRight æ–¹æ¡ˆï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„åˆ›å»ºå­ç”¨æˆ·çš„é€»è¾‘ï¼›
ç¬¬ 4 è¡Œæ—¥å¿—æç¤ºå­æ–¹æ³•äº‹åŠ¡å›æ»šï¼›
ç¬¬ 5 è¡Œæ—¥å¿—æç¤ºå­æ–¹æ³•äº‹åŠ¡å®Œæˆï¼Œç»§ç»­ä¸»æ–¹æ³•ä¹‹å‰æŒ‚èµ·çš„äº‹åŠ¡ï¼›
ç¬¬ 6 è¡Œæ—¥å¿—æç¤ºä¸»æ–¹æ³•æ•è·åˆ°äº†å­æ–¹æ³•çš„å¼‚å¸¸ï¼›
ç¬¬ 8 è¡Œæ—¥å¿—æç¤ºä¸»æ–¹æ³•çš„äº‹åŠ¡æäº¤äº†ï¼Œéšåæˆ‘ä»¬åœ¨ Controller é‡Œæ²¡çœ‹åˆ°é™é»˜å›æ»šçš„å¼‚
å¸¸ã€‚</p>
  </li>
  <li>
    <p>è¿è¡Œæµ‹è¯•ç¨‹åºçœ‹åˆ°å¦‚ä¸‹ç»“æœï¼ŒgetUserCount å¾—åˆ°çš„ç”¨æˆ·æ•°é‡ä¸º 1ï¼Œä»£è¡¨åªæœ‰ä¸€ä¸ªç”¨æˆ·ä¹Ÿå°±
æ˜¯ä¸»ç”¨æˆ·æ³¨å†Œå®Œæˆäº†ï¼Œç¬¦åˆé¢„æœŸ</p>
  </li>
</ul>

<h4 id="mybatisé…åˆäº‹åŠ¡">mybatisé…åˆäº‹åŠ¡</h4>

<ul>
  <li>userData</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserData</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">source</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>userDataMapper</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">UserDataMapper</span> <span class="o">{</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">"insert into userdata(name,source)values(#{name},#{source})"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="nd">@Param</span><span class="o">(</span><span class="s">"source"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">source</span><span class="o">);</span>

    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select count(*) from userdata where name=#{name}"</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">count</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">"name"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">name</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>userService</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserDataMapper</span> <span class="n">userDataMapper</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">SubUserService</span> <span class="n">subUserService</span><span class="o">;</span>


    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">createMainUser</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">subUserService</span><span class="o">.</span><span class="na">createSubUser</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create sub user error:{}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="c1">//å¦‚æœcreateSubUseræ˜¯NESTEDæ¨¡å¼ï¼Œè¿™é‡ŒæŠ›å‡ºå¼‚å¸¸ä¼šå¯¼è‡´åµŒå¥—äº‹åŠ¡æ— æ³•ã€æäº¤ã€</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"create main user error"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">createMainUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userDataMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"main"</span><span class="o">);</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getUserCount</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">userDataMapper</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>subUserService</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SubUserService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserDataMapper</span> <span class="n">userDataMapper</span><span class="o">;</span>

    <span class="c1">//æ¯”è¾ƒåˆ‡æ¢ä¸ºREQUIRES_NEWï¼Œè¿™é‡Œçš„createSubUserå¯ä»¥æ’å…¥æ•°æ®æˆåŠŸ</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span> <span class="o">=</span> <span class="nc">Propagation</span><span class="o">.</span><span class="na">NESTED</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createSubUser</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userDataMapper</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="s">"sub"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>controller</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Slf4j</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"nested"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NestedController</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">right</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"create user {}"</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">userService</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"create user error:{}"</span><span class="o">,</span> <span class="n">ex</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUserCount</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

:ET