I"cÇ<ul id="markdown-toc">
  <li><a href="#åˆ†å¸ƒå¼ç³»ç»Ÿ" id="markdown-toc-åˆ†å¸ƒå¼ç³»ç»Ÿ">åˆ†å¸ƒå¼ç³»ç»Ÿ</a>    <ul>
      <li><a href="#åˆ†å¸ƒå¼è®¤è¯" id="markdown-toc-åˆ†å¸ƒå¼è®¤è¯">åˆ†å¸ƒå¼è®¤è¯</a></li>
      <li><a href="#é€‰å‹åˆ†æ" id="markdown-toc-é€‰å‹åˆ†æ">é€‰å‹åˆ†æ</a></li>
      <li><a href="#æŠ€æœ¯æ–¹æ¡ˆ" id="markdown-toc-æŠ€æœ¯æ–¹æ¡ˆ">æŠ€æœ¯æ–¹æ¡ˆ</a></li>
    </ul>
  </li>
  <li><a href="#oauth20" id="markdown-toc-oauth20">OAuth2.0</a>    <ul>
      <li><a href="#ä»‹ç»" id="markdown-toc-ä»‹ç»">ä»‹ç»</a></li>
    </ul>
  </li>
  <li><a href="#spring-cloud-security-oauth2" id="markdown-toc-spring-cloud-security-oauth2">Spring Cloud Security OAuth2</a>    <ul>
      <li><a href="#ç¯å¢ƒä»‹ç»" id="markdown-toc-ç¯å¢ƒä»‹ç»">ç¯å¢ƒä»‹ç»</a></li>
      <li><a href="#æ­å»ºçˆ¶å·¥ç¨‹" id="markdown-toc-æ­å»ºçˆ¶å·¥ç¨‹">æ­å»ºçˆ¶å·¥ç¨‹</a></li>
      <li><a href="#åˆ›å»ºuaaæˆæƒæœåŠ¡å·¥ç¨‹" id="markdown-toc-åˆ›å»ºuaaæˆæƒæœåŠ¡å·¥ç¨‹">åˆ›å»ºUAAæˆæƒæœåŠ¡å·¥ç¨‹</a></li>
      <li><a href="#åˆ›å»ºorderèµ„æºæœåŠ¡å·¥ç¨‹" id="markdown-toc-åˆ›å»ºorderèµ„æºæœåŠ¡å·¥ç¨‹">åˆ›å»ºOrderèµ„æºæœåŠ¡å·¥ç¨‹</a></li>
      <li><a href="#æˆæƒæœåŠ¡å™¨é…ç½®" id="markdown-toc-æˆæƒæœåŠ¡å™¨é…ç½®">æˆæƒæœåŠ¡å™¨é…ç½®</a>        <ul>
          <li><a href="#enableauthorizationserver" id="markdown-toc-enableauthorizationserver">EnableAuthorizationServer</a></li>
          <li><a href="#é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯" id="markdown-toc-é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯">é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯</a></li>
          <li><a href="#ç®¡ç†ä»¤ç‰Œ" id="markdown-toc-ç®¡ç†ä»¤ç‰Œ">ç®¡ç†ä»¤ç‰Œ</a></li>
          <li><a href="#ä»¤ç‰Œè®¿é—®ç«¯ç‚¹é…ç½®" id="markdown-toc-ä»¤ç‰Œè®¿é—®ç«¯ç‚¹é…ç½®">ä»¤ç‰Œè®¿é—®ç«¯ç‚¹é…ç½®</a></li>
          <li><a href="#ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ" id="markdown-toc-ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ">ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ</a></li>
          <li><a href="#webå®‰å…¨é…ç½®" id="markdown-toc-webå®‰å…¨é…ç½®">webå®‰å…¨é…ç½®</a></li>
        </ul>
      </li>
      <li><a href="#æˆæƒç æ¨¡å¼" id="markdown-toc-æˆæƒç æ¨¡å¼">æˆæƒç æ¨¡å¼</a></li>
      <li><a href="#ç®€åŒ–æ¨¡å¼" id="markdown-toc-ç®€åŒ–æ¨¡å¼">ç®€åŒ–æ¨¡å¼</a></li>
      <li><a href="#å¯†ç æ¨¡å¼" id="markdown-toc-å¯†ç æ¨¡å¼">å¯†ç æ¨¡å¼</a></li>
      <li><a href="#å®¢æˆ·ç«¯æ¨¡å¼" id="markdown-toc-å®¢æˆ·ç«¯æ¨¡å¼">å®¢æˆ·ç«¯æ¨¡å¼</a></li>
      <li><a href="#èµ„æºæœåŠ¡å™¨é…ç½®" id="markdown-toc-èµ„æºæœåŠ¡å™¨é…ç½®">èµ„æºæœåŠ¡å™¨é…ç½®</a>        <ul>
          <li><a href="#éªŒè¯token" id="markdown-toc-éªŒè¯token">éªŒè¯token</a></li>
          <li><a href="#ç¼–å†™èµ„æº" id="markdown-toc-ç¼–å†™èµ„æº">ç¼–å†™èµ„æº</a></li>
          <li><a href="#æ·»åŠ å®‰å…¨è®¿é—®æ§åˆ¶" id="markdown-toc-æ·»åŠ å®‰å…¨è®¿é—®æ§åˆ¶">æ·»åŠ å®‰å…¨è®¿é—®æ§åˆ¶</a></li>
        </ul>
      </li>
      <li><a href="#æµ‹è¯•oauthæˆæƒè®¤è¯" id="markdown-toc-æµ‹è¯•oauthæˆæƒè®¤è¯">æµ‹è¯•OAuthæˆæƒè®¤è¯</a></li>
    </ul>
  </li>
  <li><a href="#jwtä»¤ç‰Œ" id="markdown-toc-jwtä»¤ç‰Œ">JWTä»¤ç‰Œ</a>    <ul>
      <li><a href="#ä»‹ç»-1" id="markdown-toc-ä»‹ç»-1">ä»‹ç»</a></li>
      <li><a href="#é…ç½®ä»¤ç‰ŒæœåŠ¡" id="markdown-toc-é…ç½®ä»¤ç‰ŒæœåŠ¡">é…ç½®ä»¤ç‰ŒæœåŠ¡</a></li>
      <li><a href="#ç”Ÿæˆjwtä»¤ç‰Œ" id="markdown-toc-ç”Ÿæˆjwtä»¤ç‰Œ">ç”ŸæˆJWTä»¤ç‰Œ</a></li>
      <li><a href="#æ ¡éªŒjwtä»¤ç‰Œ" id="markdown-toc-æ ¡éªŒjwtä»¤ç‰Œ">æ ¡éªŒJWTä»¤ç‰Œ</a></li>
      <li><a href="#æµ‹è¯•" id="markdown-toc-æµ‹è¯•">æµ‹è¯•</a></li>
      <li><a href="#å®Œå–„ç¯å¢ƒé…ç½®" id="markdown-toc-å®Œå–„ç¯å¢ƒé…ç½®">å®Œå–„ç¯å¢ƒé…ç½®</a></li>
    </ul>
  </li>
  <li><a href="#spring-securityå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæˆæƒ" id="markdown-toc-spring-securityå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæˆæƒ">Spring Securityå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæˆæƒ</a>    <ul>
      <li><a href="#éœ€æ±‚åˆ†æ" id="markdown-toc-éœ€æ±‚åˆ†æ">éœ€æ±‚åˆ†æ</a></li>
      <li><a href="#æ³¨å†Œä¸­å¿ƒ" id="markdown-toc-æ³¨å†Œä¸­å¿ƒ">æ³¨å†Œä¸­å¿ƒ</a></li>
      <li><a href="#ç½‘å…³" id="markdown-toc-ç½‘å…³">ç½‘å…³</a></li>
      <li><a href="#è½¬å‘æ˜æ–‡token" id="markdown-toc-è½¬å‘æ˜æ–‡token">è½¬å‘æ˜æ–‡token</a></li>
      <li><a href="#å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª" id="markdown-toc-å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª">å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª</a></li>
      <li><a href="#é›†æˆæµ‹è¯•" id="markdown-toc-é›†æˆæµ‹è¯•">é›†æˆæµ‹è¯•</a></li>
      <li><a href="#æ‰©å±•ç”¨æˆ·ä¿¡æ¯" id="markdown-toc-æ‰©å±•ç”¨æˆ·ä¿¡æ¯">æ‰©å±•ç”¨æˆ·ä¿¡æ¯</a></li>
    </ul>
  </li>
</ul>
<h3 id="åˆ†å¸ƒå¼ç³»ç»Ÿ">åˆ†å¸ƒå¼ç³»ç»Ÿ</h3>

<ul>
  <li>å…·æœ‰åˆ†å¸ƒå¼æ¶æ„çš„ç³»ç»Ÿå«åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„è¿è¡Œé€šå¸¸ä¾èµ–ç½‘ç»œï¼Œå®ƒå°†å•ä½“ç»“æ„çš„ç³»ç»Ÿåˆ†ä¸ºè‹¥å¹²æœåŠ¡ï¼ŒæœåŠ¡ä¹‹é—´é€šè¿‡ç½‘ç»œäº¤äº’æ¥å®Œæˆç”¨æˆ·çš„ä¸šåŠ¡å¤„ç†ï¼Œå½“å‰æµè¡Œçš„å¾®æœåŠ¡æ¶æ„å°±æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„ï¼Œå¦‚ä¸‹å›¾ï¼š</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/w5Ner6XfDSOYKUz.png" alt="image.png" /></p>

<ul>
  <li>åˆ†å¸ƒå¼ç³»ç»Ÿå…·ä½“å¦‚ä¸‹åŸºæœ¬ç‰¹ç‚¹ï¼š
    <ul>
      <li>1ã€åˆ†å¸ƒæ€§ï¼šæ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼ŒæœåŠ¡ä¹‹é—´äº¤äº’é€šè¿‡ç½‘ç»œè¿›è¡Œé€šä¿¡ï¼Œæ¯”å¦‚ï¼šè®¢å•æœåŠ¡ã€å•†å“æœåŠ¡ã€‚</li>
      <li>2ã€ä¼¸ç¼©æ€§ï¼šæ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥é›†ç¾¤æ–¹å¼éƒ¨ç½²ï¼Œå¹¶å¯é’ˆå¯¹éƒ¨åˆ†ç»“ç‚¹è¿›è¡Œç¡¬ä»¶åŠè½¯ä»¶æ‰©å®¹ï¼Œå…·æœ‰ä¸€å®šçš„ä¼¸ç¼©èƒ½åŠ›ã€‚</li>
      <li>3ã€å…±äº«æ€§ï¼šæ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥ä½œä¸ºå…±äº«èµ„æºå¯¹å¤–æä¾›æœåŠ¡ï¼Œå¤šä¸ªéƒ¨åˆ†å¯èƒ½æœ‰æ“ä½œå…±äº«èµ„æºçš„æƒ…å†µã€‚</li>
      <li>4ã€å¼€æ”¾æ€§ï¼šæ¯ä¸ªéƒ¨åˆ†æ ¹æ®éœ€æ±‚éƒ½å¯ä»¥å¯¹å¤–å‘å¸ƒå…±äº«èµ„æºçš„è®¿é—®æ¥å£ï¼Œå¹¶å¯å…è®¸ç¬¬ä¸‰æ–¹ç³»ç»Ÿè®¿é—®ã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="åˆ†å¸ƒå¼è®¤è¯">åˆ†å¸ƒå¼è®¤è¯</h4>

<ul>
  <li>åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ¯ä¸ªæœåŠ¡éƒ½ä¼šæœ‰è®¤è¯ã€æˆæƒçš„éœ€æ±‚ï¼Œå¦‚æœæ¯ä¸ªæœåŠ¡éƒ½å®ç°ä¸€å¥—è®¤è¯æˆæƒé€»è¾‘ä¼šéå¸¸å†—ä½™ï¼Œè€ƒè™‘åˆ†å¸ƒå¼ç³»ç»Ÿå…±äº«æ€§çš„ç‰¹ç‚¹ï¼Œéœ€è¦ç”±ç‹¬ç«‹çš„è®¤è¯æœåŠ¡å¤„ç†ç³»ç»Ÿè®¤è¯æˆæƒçš„è¯·æ±‚ï¼›è€ƒè™‘åˆ†å¸ƒå¼ç³»ç»Ÿå¼€æ”¾æ€§çš„ç‰¹ç‚¹ï¼Œä¸ä»…å¯¹ç³»ç»Ÿå†…éƒ¨æœåŠ¡æä¾›è®¤è¯ï¼Œå¯¹ç¬¬ä¸‰æ–¹ç³»ç»Ÿä¹Ÿè¦æä¾›è®¤è¯ã€‚</li>
  <li><strong>ç»Ÿä¸€è®¤è¯æˆæƒ</strong>ï¼šæä¾›ç‹¬ç«‹çš„è®¤è¯æœåŠ¡ï¼Œç»Ÿä¸€å¤„ç†è®¤è¯æˆæƒã€‚æ— è®ºæ˜¯ä¸åŒç±»å‹çš„ç”¨æˆ·ï¼Œè¿˜æ˜¯ä¸åŒç§ç±»çš„å®¢æˆ·ç«¯(webç«¯ï¼ŒH5ã€APP)ï¼Œå‡é‡‡ç”¨ä¸€è‡´çš„è®¤è¯ã€æƒé™ã€ä¼šè¯æœºåˆ¶ï¼Œå®ç°ç»Ÿä¸€è®¤è¯æˆæƒã€‚è¦å®ç°ç»Ÿä¸€åˆ™è®¤è¯æ–¹å¼å¿…é¡»å¯æ‰©å±•ï¼Œæ”¯æŒå„ç§è®¤è¯éœ€æ±‚ï¼Œæ¯”å¦‚ï¼šç”¨æˆ·åå¯†ç è®¤è¯ã€çŸ­ä¿¡éªŒè¯ç ã€äºŒç»´ç ã€äººè„¸è¯†åˆ«ç­‰è®¤è¯æ–¹å¼ï¼Œå¹¶å¯ä»¥éå¸¸çµæ´»çš„åˆ‡æ¢ã€‚</li>
  <li><strong>åº”ç”¨æ¥å…¥è®¤è¯</strong>ï¼šåº”æä¾›æ‰©å±•å’Œå¼€æ”¾èƒ½åŠ›ï¼Œæä¾›å®‰å…¨çš„ç³»ç»Ÿå¯¹æ¥æœºåˆ¶ï¼Œå¹¶å¯å¼€æ”¾éƒ¨åˆ†APIç»™æ¥å…¥ç¬¬ä¸‰æ–¹ä½¿ç”¨ï¼Œä¸€æ–¹åº”ç”¨ï¼ˆå†…éƒ¨ ç³»ç»ŸæœåŠ¡ï¼‰å’Œä¸‰æ–¹åº”ç”¨ï¼ˆç¬¬ä¸‰æ–¹åº”ç”¨ï¼‰å‡é‡‡ç”¨ç»Ÿä¸€æœºåˆ¶æ¥å…¥ã€‚</li>
</ul>

<h4 id="é€‰å‹åˆ†æ">é€‰å‹åˆ†æ</h4>

<ul>
  <li>1ã€<strong>åŸºäºsessionçš„è®¤è¯æ–¹å¼</strong>ï¼šåœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼ŒåŸºäºsessionçš„è®¤è¯ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ªåº”ç”¨æœåŠ¡éƒ½éœ€è¦åœ¨sessionä¸­å­˜å‚¨ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œé€šè¿‡è´Ÿè½½å‡è¡¡å°†æœ¬åœ°çš„è¯·æ±‚åˆ†é…åˆ°å¦ä¸€ä¸ªåº”ç”¨æœåŠ¡éœ€è¦å°†sessionä¿¡æ¯å¸¦è¿‡å»ï¼Œå¦åˆ™ä¼šé‡æ–°è®¤è¯ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/WgNtHA6mMbIwGXK.png" alt="image.png" /></p>

<ul>
  <li>è¿™ä¸ªæ—¶å€™ï¼Œé€šå¸¸çš„åšæ³•æœ‰ä¸‹é¢å‡ ç§ï¼š
    <ul>
      <li><strong>Sessionå¤åˆ¶</strong>ï¼šå¤šå°åº”ç”¨æœåŠ¡å™¨ä¹‹é—´åŒæ­¥sessionï¼Œä½¿sessionä¿æŒä¸€è‡´ï¼Œå¯¹å¤–é€æ˜ã€‚</li>
      <li><strong>Sessioné»è´´</strong>ï¼šå½“ç”¨æˆ·è®¿é—®é›†ç¾¤ä¸­æŸå°æœåŠ¡å™¨åï¼Œå¼ºåˆ¶æŒ‡å®šåç»­æ‰€æœ‰è¯·æ±‚å‡è½åˆ°æ­¤æœºå™¨ä¸Šã€‚</li>
      <li><strong>Sessioné›†ä¸­å­˜å‚¨</strong>ï¼šå°†Sessionå­˜å…¥åˆ†å¸ƒå¼ç¼“å­˜ä¸­ï¼Œæ‰€æœ‰æœåŠ¡å™¨åº”ç”¨å®ä¾‹ç»Ÿä¸€ä»åˆ†å¸ƒå¼ç¼“å­˜ä¸­å­˜å–Sessionã€‚</li>
    </ul>
  </li>
  <li>
    <p>æ€»ä½“æ¥è®²ï¼ŒåŸºäºsessionè®¤è¯çš„è®¤è¯æ–¹å¼ï¼Œå¯ä»¥æ›´å¥½çš„åœ¨æœåŠ¡ç«¯å¯¹ä¼šè¯è¿›è¡Œæ§åˆ¶ï¼Œä¸”å®‰å…¨æ€§è¾ƒé«˜ã€‚ä½†æ˜¯ï¼Œsessionæœºåˆ¶æ–¹å¼åŸºäºcookieï¼Œåœ¨å¤æ‚å¤šæ ·çš„ç§»åŠ¨å®¢æˆ·ç«¯ä¸Šä¸èƒ½æœ‰æ•ˆçš„ä½¿ç”¨ï¼Œå¹¶ä¸”æ— æ³•è·¨åŸŸï¼Œå¦å¤–éšç€ç³»ç»Ÿçš„æ‰©å±•éœ€æé«˜sessionçš„å¤åˆ¶ã€é»è´´åŠå­˜å‚¨çš„å®¹é”™æ€§ã€‚</p>
  </li>
  <li><strong>2ã€åŸºäºtokençš„è®¤è¯æ–¹å¼</strong>ï¼šåŸºäºtokençš„è®¤è¯æ–¹å¼ï¼ŒæœåŠ¡ç«¯ä¸ç”¨å­˜å‚¨è®¤è¯æ•°æ®ï¼Œæ˜“ç»´æŠ¤æ‰©å±•æ€§å¼ºï¼Œ å®¢æˆ·ç«¯å¯ä»¥æŠŠtoken å­˜åœ¨ä»»æ„åœ°æ–¹ï¼Œå¹¶ä¸”å¯ä»¥å®ç°webå’Œappç»Ÿä¸€è®¤è¯æœºåˆ¶ã€‚å…¶ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œtokenç”±äºè‡ªåŒ…å«ä¿¡æ¯ï¼Œå› æ­¤ä¸€èˆ¬æ•°æ®é‡è¾ƒå¤§ï¼Œè€Œä¸”æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦ä¼ é€’ï¼Œå› æ­¤æ¯”è¾ƒå å¸¦å®½ã€‚å¦å¤–ï¼Œtokençš„ç­¾åéªŒç­¾æ“ä½œä¹Ÿä¼šç»™cpuå¸¦æ¥é¢å¤–çš„å¤„ç†è´Ÿæ‹…ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/nh6woNYavKkTGrE.png" alt="image.png" /></p>

<h4 id="æŠ€æœ¯æ–¹æ¡ˆ">æŠ€æœ¯æ–¹æ¡ˆ</h4>

<ul>
  <li>æ ¹æ® é€‰å‹çš„åˆ†æï¼Œå†³å®šé‡‡ç”¨åŸºäºtokençš„è®¤è¯æ–¹å¼ï¼Œå®ƒçš„ä¼˜ç‚¹æ˜¯ï¼š
    <ul>
      <li>1ã€é€‚åˆç»Ÿä¸€è®¤è¯çš„æœºåˆ¶ï¼Œå®¢æˆ·ç«¯ã€ä¸€æ–¹åº”ç”¨ã€ä¸‰æ–¹åº”ç”¨éƒ½éµå¾ªä¸€è‡´çš„è®¤è¯æœºåˆ¶ã€‚</li>
      <li>2ã€tokenè®¤è¯æ–¹å¼å¯¹ç¬¬ä¸‰æ–¹åº”ç”¨æ¥å…¥æ›´é€‚åˆï¼Œå› ä¸ºå®ƒæ›´å¼€æ”¾ï¼Œå¯ä½¿ç”¨å½“å‰æœ‰æµè¡Œçš„å¼€æ”¾åè®®Oauth2.0ã€JWTç­‰ã€‚</li>
      <li>3ã€ä¸€èˆ¬æƒ…å†µæœåŠ¡ç«¯æ— éœ€å­˜å‚¨ä¼šè¯ä¿¡æ¯ï¼Œå‡è½»äº†æœåŠ¡ç«¯çš„å‹åŠ›ã€‚</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/02/22/rtpwgYBR5AT8Mkv.png" alt="image.png" /></p>

<ul>
  <li>æµç¨‹æè¿°ï¼š
    <ul>
      <li>ï¼ˆ1ï¼‰ç”¨æˆ·é€šè¿‡æ¥å…¥æ–¹ï¼ˆåº”ç”¨ï¼‰ç™»å½•ï¼Œæ¥å…¥æ–¹é‡‡å–OAuth2.0æ–¹å¼åœ¨ç»Ÿä¸€è®¤è¯æœåŠ¡(UAA)ä¸­è®¤è¯ã€‚</li>
      <li>ï¼ˆ2ï¼‰è®¤è¯æœåŠ¡(UAA)è°ƒç”¨éªŒè¯è¯¥ç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ï¼Œå¹¶è·å–ç”¨æˆ·æƒé™ä¿¡æ¯ã€‚</li>
      <li>ï¼ˆ3ï¼‰è®¤è¯æœåŠ¡(UAA)è·å–æ¥å…¥æ–¹æƒé™ä¿¡æ¯ï¼Œå¹¶éªŒè¯æ¥å…¥æ–¹æ˜¯å¦åˆæ³•ã€‚</li>
      <li>ï¼ˆ4ï¼‰è‹¥ç™»å½•ç”¨æˆ·ä»¥åŠæ¥å…¥æ–¹éƒ½åˆæ³•ï¼Œè®¤è¯æœåŠ¡ç”Ÿæˆjwtä»¤ç‰Œè¿”å›ç»™æ¥å…¥æ–¹ï¼Œå…¶ä¸­jwtä¸­åŒ…å«äº†ç”¨æˆ·æƒé™åŠæ¥å…¥æ–¹æƒé™ã€‚</li>
      <li>ï¼ˆ5ï¼‰åç»­ï¼Œæ¥å…¥æ–¹æºå¸¦jwtä»¤ç‰Œå¯¹APIç½‘å…³å†…çš„å¾®æœåŠ¡èµ„æºè¿›è¡Œè®¿é—®ã€‚</li>
      <li>ï¼ˆ6ï¼‰APIç½‘å…³å¯¹ä»¤ç‰Œè§£æã€å¹¶éªŒè¯æ¥å…¥æ–¹çš„æƒé™æ˜¯å¦èƒ½å¤Ÿè®¿é—®æœ¬æ¬¡è¯·æ±‚çš„å¾®æœåŠ¡ã€‚</li>
      <li>ï¼ˆ7ï¼‰å¦‚æœæ¥å…¥æ–¹çš„æƒé™æ²¡é—®é¢˜ï¼ŒAPIç½‘å…³å°†åŸè¯·æ±‚headerä¸­é™„åŠ è§£æåçš„æ˜æ–‡Tokenï¼Œå¹¶å°†è¯·æ±‚è½¬å‘è‡³å¾®æœåŠ¡ã€‚</li>
      <li>ï¼ˆ8ï¼‰å¾®æœåŠ¡æ”¶åˆ°è¯·æ±‚ï¼Œæ˜æ–‡tokenä¸­åŒ…å«ç™»å½•ç”¨æˆ·çš„èº«ä»½å’Œæƒé™ä¿¡æ¯ã€‚å› æ­¤åç»­å¾®æœåŠ¡è‡ªå·±å¯ä»¥å¹²ä¸¤ä»¶äº‹ï¼š1ï¼Œç”¨æˆ·æˆæƒæ‹¦æˆªï¼ˆçœ‹å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥èµ„æºï¼‰2ï¼Œå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨è¿›å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆæœ‰åˆ©äºåç»­ä¸šåŠ¡é€»è¾‘éšæ—¶è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼‰</li>
    </ul>
  </li>
  <li><strong>ç»Ÿä¸€è®¤è¯æœåŠ¡(UAA)</strong>ï¼š å®ƒæ‰¿è½½äº†OAuth2.0æ¥å…¥æ–¹è®¤è¯ã€ç™»å…¥ç”¨æˆ·çš„è®¤è¯ã€æˆæƒä»¥åŠç”Ÿæˆä»¤ç‰Œçš„èŒè´£ï¼Œå®Œæˆå®é™…çš„ç”¨æˆ·è®¤è¯ã€æˆæƒåŠŸèƒ½ã€‚</li>
  <li><strong>APIç½‘å…³</strong>ï¼š ä½œä¸ºç³»ç»Ÿçš„å”¯ä¸€å…¥å£ï¼ŒAPIç½‘å…³ä¸ºæ¥å…¥æ–¹æä¾›å®šåˆ¶çš„APIé›†åˆï¼Œå®ƒå¯èƒ½è¿˜å…·æœ‰å…¶å®ƒèŒè´£ï¼Œå¦‚èº«ä»½éªŒè¯ã€ç›‘æ§ã€è´Ÿè½½å‡è¡¡ã€ç¼“å­˜ç­‰ã€‚APIç½‘å…³æ–¹å¼çš„æ ¸å¿ƒè¦ç‚¹æ˜¯ï¼Œæ‰€æœ‰çš„æ¥å…¥æ–¹å’Œæ¶ˆè´¹ç«¯éƒ½é€šè¿‡ç»Ÿä¸€çš„ç½‘å…³æ¥å…¥å¾®æœåŠ¡ï¼Œåœ¨ç½‘å…³å±‚å¤„ç†æ‰€æœ‰çš„éä¸šåŠ¡åŠŸèƒ½ã€‚</li>
</ul>

<h3 id="oauth20">OAuth2.0</h3>

<h4 id="ä»‹ç»">ä»‹ç»</h4>

<ul>
  <li>
    <p>OAuthï¼ˆå¼€æ”¾æˆæƒï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œå…è®¸ç”¨æˆ·æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®ä»–ä»¬å­˜å‚¨åœ¨å¦å¤–çš„æœåŠ¡æä¾›è€…ä¸Šçš„ä¿¡æ¯ï¼Œè€Œä¸éœ€è¦å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨æˆ–åˆ†äº«ä»–ä»¬æ•°æ®çš„æ‰€æœ‰å†…å®¹ã€‚</p>
  </li>
  <li>
    <p>Oauthåè®®ï¼šhttps://tools.ietf.org/html/rfc6749</p>
  </li>
  <li>
    <p>Oauth2è®¤è¯çš„ä¾‹å­ï¼š</p>

    <ul>
      <li>1ã€<strong>å®¢æˆ·ç«¯è¯·æ±‚ç¬¬ä¸‰æ–¹æˆæƒ</strong>ï¼šç”¨æˆ·è¿›å…¥é»‘é©¬ç¨‹åºçš„ç™»å½•é¡µé¢ï¼Œç‚¹å‡»å¾®ä¿¡çš„å›¾æ ‡ä»¥å¾®ä¿¡è´¦å·ç™»å½•ç³»ç»Ÿï¼Œç”¨æˆ·æ˜¯è‡ªå·±åœ¨å¾®ä¿¡é‡Œä¿¡æ¯çš„èµ„æºæ‹¥æœ‰è€…ã€‚ç‚¹å‡»â€œå¾®ä¿¡â€å‡ºç°ä¸€ä¸ªäºŒç»´ç ï¼Œæ­¤æ—¶ç”¨æˆ·æ‰«æäºŒç»´ç ï¼Œå¼€å§‹ç»™é»‘é©¬ç¨‹åºå‘˜æˆæƒã€‚</li>
      <li>2ã€<strong>èµ„æºæ‹¥æœ‰è€…åŒæ„ç»™å®¢æˆ·ç«¯æˆæƒ</strong>ï¼šèµ„æºæ‹¥æœ‰è€…æ‰«æäºŒç»´ç è¡¨ç¤ºèµ„æºæ‹¥æœ‰è€…åŒæ„ç»™å®¢æˆ·ç«¯æˆæƒï¼Œå¾®ä¿¡ä¼šå¯¹èµ„æºæ‹¥æœ‰è€…çš„èº«ä»½è¿›è¡ŒéªŒè¯ï¼Œ éªŒè¯é€šè¿‡åï¼Œå¾®ä¿¡ä¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦ç»™æˆæƒé»‘é©¬ç¨‹åºå‘˜è®¿é—®è‡ªå·±çš„å¾®ä¿¡æ•°æ®ï¼Œç”¨æˆ·ç‚¹å‡»â€œç¡®è®¤ç™»å½•â€è¡¨ç¤ºåŒæ„æˆæƒï¼Œå¾®ä¿¡è®¤è¯æœåŠ¡å™¨ä¼šé¢å‘ä¸€ä¸ªæˆæƒç ï¼Œå¹¶é‡å®šå‘åˆ°é»‘é©¬ç¨‹åºå‘˜çš„ç½‘ç«™ã€‚</li>
      <li>3ã€<strong>å®¢æˆ·ç«¯è·å–åˆ°æˆæƒç ï¼Œè¯·æ±‚è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œ</strong>ï¼šæ­¤è¿‡ç¨‹ç”¨æˆ·çœ‹ä¸åˆ°ï¼Œå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºè¯·æ±‚è®¤è¯æœåŠ¡å™¨ï¼Œè¯·æ±‚æºå¸¦æˆæƒç ã€‚</li>
      <li>4ã€<strong>è®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å“åº”ä»¤ç‰Œ</strong>ï¼šå¾®ä¿¡è®¤è¯æœåŠ¡å™¨éªŒè¯äº†å®¢æˆ·ç«¯è¯·æ±‚çš„æˆæƒç ï¼Œå¦‚æœåˆæ³•åˆ™ç»™å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œï¼Œä»¤ç‰Œæ˜¯å®¢æˆ·ç«¯è®¿é—®èµ„æºçš„é€šè¡Œè¯ã€‚æ­¤äº¤äº’è¿‡ç¨‹ç”¨æˆ·çœ‹ä¸åˆ°ï¼Œå½“å®¢æˆ·ç«¯æ‹¿åˆ°ä»¤ç‰Œåï¼Œç”¨æˆ·åœ¨é»‘é©¬ç¨‹åºå‘˜çœ‹åˆ°å·²ç»ç™»å½•æˆåŠŸã€‚</li>
      <li>5ã€<strong>å®¢æˆ·ç«¯è¯·æ±‚èµ„æºæœåŠ¡å™¨çš„èµ„æº</strong>ï¼šå®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡å™¨çš„èµ„æºã€‚é»‘é©¬ç¨‹åºå‘˜ç½‘ç«™æºå¸¦ä»¤ç‰Œè¯·æ±‚è®¿é—®å¾®ä¿¡æœåŠ¡å™¨è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ã€‚</li>
      <li>6ã€<strong>èµ„æºæœåŠ¡å™¨è¿”å›å—ä¿æŠ¤èµ„æº</strong>ï¼šèµ„æºæœåŠ¡å™¨æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ï¼Œå¦‚æœåˆæ³•åˆ™å‘ç”¨æˆ·å“åº”èµ„æºä¿¡æ¯å†…å®¹ã€‚</li>
    </ul>

    <p><img src="https://i.loli.net/2020/02/22/oHWTDqQEk2vJMeF.png" alt="image.png" /></p>
  </li>
  <li>
    <p>OAuth2.0è®¤è¯æµç¨‹ï¼š</p>

    <p><img src="https://i.loli.net/2020/02/22/RQbEL1jm6rIxywO.png" alt="image.png" /></p>

    <ul>
      <li>1ã€<strong>å®¢æˆ·ç«¯</strong>ï¼šæœ¬èº«ä¸å­˜å‚¨èµ„æºï¼Œéœ€è¦é€šè¿‡èµ„æºæ‹¥æœ‰è€…çš„æˆæƒå»è¯·æ±‚èµ„æºæœåŠ¡å™¨çš„èµ„æºï¼Œæ¯”å¦‚ï¼šAndroidå®¢æˆ·ç«¯ã€Webå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ç«¯ï¼‰ã€å¾®ä¿¡å®¢æˆ·ç«¯ç­‰ã€‚</li>
      <li>2ã€<strong>èµ„æºæ‹¥æœ‰è€…</strong>ï¼šé€šå¸¸ä¸ºç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥æ˜¯åº”ç”¨ç¨‹åºï¼Œå³è¯¥èµ„æºçš„æ‹¥æœ‰è€…ã€‚</li>
      <li>3ã€<strong>æˆæƒæœåŠ¡å™¨ï¼ˆä¹Ÿç§°è®¤è¯æœåŠ¡å™¨ï¼‰</strong>ï¼šç”¨äºæœåŠ¡æä¾›å•†å¯¹èµ„æºæ‹¥æœ‰çš„èº«ä»½è¿›è¡Œè®¤è¯ã€å¯¹è®¿é—®èµ„æºè¿›è¡Œæˆæƒï¼Œè®¤è¯æˆåŠŸåä¼šç»™å®¢æˆ·ç«¯å‘æ”¾ä»¤ç‰Œï¼ˆaccess_tokenï¼‰ï¼Œä½œä¸ºå®¢æˆ·ç«¯è®¿é—®èµ„æºæœåŠ¡å™¨çš„å‡­æ®ã€‚æœ¬ä¾‹ä¸ºå¾®ä¿¡çš„è®¤è¯æœåŠ¡å™¨ã€‚</li>
      <li>4ã€èµ„æºæœåŠ¡å™¨ï¼šå­˜å‚¨èµ„æºçš„æœåŠ¡å™¨ï¼Œæœ¬ä¾‹å­ä¸ºå¾®ä¿¡å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯ã€‚</li>
    </ul>
  </li>
  <li>
    <p>ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒæœåŠ¡æä¾›å•†èƒ½å…è®¸éšä¾¿ä¸€ä¸ª<strong>å®¢æˆ·ç«¯</strong>å°±æ¥å…¥åˆ°å®ƒçš„<strong>æˆæƒæœåŠ¡å™¨</strong>å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ŒæœåŠ¡æä¾›å•†ä¼šç»™å‡†å…¥çš„æ¥å…¥æ–¹ä¸€ä¸ªèº«ä»½ï¼Œç”¨äºæ¥å…¥æ—¶çš„å‡­æ®:</p>

    <p><strong>client_id</strong>ï¼šå®¢æˆ·ç«¯æ ‡è¯†</p>

    <p><strong>client_secret</strong>ï¼šå®¢æˆ·ç«¯ç§˜é’¥</p>

    <p>å› æ­¤ï¼Œå‡†ç¡®æ¥è¯´ï¼Œ<strong>æˆæƒæœåŠ¡å™¨</strong>å¯¹ä¸¤ç§OAuth2.0ä¸­çš„ä¸¤ä¸ªè§’è‰²è¿›è¡Œè®¤è¯æˆæƒï¼Œåˆ†åˆ«æ˜¯<strong>èµ„æºæ‹¥æœ‰è€…</strong>ã€<strong>å®¢æˆ·ç«¯</strong>ã€‚</p>
  </li>
</ul>

<h3 id="spring-cloud-security-oauth2">Spring Cloud Security OAuth2</h3>

<h4 id="ç¯å¢ƒä»‹ç»">ç¯å¢ƒä»‹ç»</h4>

<ul>
  <li>
    <p>Spring-Security-OAuth2æ˜¯å¯¹OAuth2çš„ä¸€ç§å®ç°ï¼Œå¹¶ä¸”è·Ÿæˆ‘ä»¬ä¹‹å‰å­¦ä¹ çš„Spring Securityç›¸è¾…ç›¸æˆï¼Œä¸Spring Cloudä½“ç³»çš„é›†æˆä¹Ÿéå¸¸ä¾¿åˆ©</p>
  </li>
  <li>
    <p>OAuth2.0çš„æœåŠ¡æä¾›æ–¹æ¶µç›–ä¸¤ä¸ªæœåŠ¡ï¼Œå³æˆæƒæœåŠ¡ (Authorization Serverï¼Œä¹Ÿå«è®¤è¯æœåŠ¡) å’Œèµ„æºæœåŠ¡ (Resource Server)ï¼Œä½¿ç”¨ Spring Security OAuth2 çš„æ—¶å€™ä½ å¯ä»¥é€‰æ‹©æŠŠå®ƒä»¬åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­å®ç°ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©å»ºç«‹ä½¿ç”¨åŒä¸€ä¸ªæˆæƒæœåŠ¡çš„å¤šä¸ªèµ„æºæœåŠ¡ã€‚</p>
  </li>
  <li>
    <p><strong>æˆæƒæœåŠ¡ (Authorization Serverï¼‰</strong>åº”åŒ…å«å¯¹æ¥å…¥ç«¯ä»¥åŠç™»å…¥ç”¨æˆ·çš„åˆæ³•æ€§è¿›è¡ŒéªŒè¯å¹¶é¢å‘tokenç­‰åŠŸèƒ½ï¼Œå¯¹ä»¤ç‰Œçš„è¯·æ±‚ç«¯ç‚¹ç”± Spring MVC æ§åˆ¶å™¨è¿›è¡Œå®ç°ï¼Œä¸‹é¢æ˜¯é…ç½®ä¸€ä¸ªè®¤è¯æœåŠ¡å¿…é¡»è¦å®ç°çš„endpointsï¼š</p>

    <ul>
      <li><strong>AuthorizationEndpoint</strong> æœåŠ¡äºè®¤è¯è¯·æ±‚ã€‚é»˜è®¤ URLï¼š <code class="language-plaintext highlighter-rouge">/oauth/authorize</code>ã€‚</li>
      <li><strong>TokenEndpoint</strong> æœåŠ¡äºè®¿é—®ä»¤ç‰Œçš„è¯·æ±‚ã€‚é»˜è®¤ URLï¼š <code class="language-plaintext highlighter-rouge">/oauth/token</code>ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>èµ„æºæœåŠ¡ (Resource Server)</strong>ï¼Œåº”åŒ…å«å¯¹èµ„æºçš„ä¿æŠ¤åŠŸèƒ½ï¼Œå¯¹éæ³•è¯·æ±‚è¿›è¡Œæ‹¦æˆªï¼Œå¯¹è¯·æ±‚ä¸­tokenè¿›è¡Œè§£æé‰´æƒç­‰ï¼Œä¸‹é¢çš„è¿‡æ»¤å™¨ç”¨äºå®ç° OAuth 2.0 èµ„æºæœåŠ¡ï¼š</p>

    <ul>
      <li>OAuth2AuthenticationProcessingFilterç”¨æ¥å¯¹è¯·æ±‚ç»™å‡ºçš„èº«ä»½ä»¤ç‰Œè§£æé‰´æƒã€‚</li>
    </ul>
  </li>
  <li>
    <p>æœ¬æ¡ˆä¾‹åˆ†åˆ«åˆ›å»ºuaaæˆæƒæœåŠ¡ï¼ˆä¹Ÿå¯å«è®¤è¯æœåŠ¡ï¼‰å’Œorderè®¢å•èµ„æºæœåŠ¡ã€‚</p>

    <p><img src="https://i.loli.net/2020/02/22/U1lKzkdnI28AgeQ.png" alt="image.png" /></p>

    <ul>
      <li>1ã€å®¢æˆ·ç«¯è¯·æ±‚UAAæˆæƒæœåŠ¡è¿›è¡Œè®¤è¯ã€‚</li>
      <li>2ã€è®¤è¯é€šè¿‡åç”±UAAé¢å‘ä»¤ç‰Œã€‚</li>
      <li>3ã€å®¢æˆ·ç«¯æºå¸¦ä»¤ç‰ŒTokenè¯·æ±‚èµ„æºæœåŠ¡ã€‚</li>
      <li>4ã€èµ„æºæœåŠ¡æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ï¼Œåˆæ³•å³è¿”å›èµ„æºä¿¡æ¯ã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="æ­å»ºçˆ¶å·¥ç¨‹">æ­å»ºçˆ¶å·¥ç¨‹</h4>

<ul>
  <li>åˆ›å»ºmavenå·¥ç¨‹ä½œä¸ºçˆ¶å·¥ç¨‹ï¼Œä¾èµ–å¦‚ä¸‹ï¼š</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>distributed-security<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>pom<span class="nt">&lt;/packaging&gt;</span>

    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.1.3.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.reporting.outputEncoding&gt;</span>
        <span class="nt">&lt;java.version&gt;</span>1.8<span class="nt">&lt;/java.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>

            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>Greenwich.RELEASE<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>


            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>javax.servlet<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>javax.servlet-api<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>3.1.0<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>

            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>javax.interceptor<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>javax.interceptor-api<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>

            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>1.2.47<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>

            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>1.18.0<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>

            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>5.1.47<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>


            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>1.0.10.RELEASE<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>


            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.security.oauth.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-security-oauth2-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.1.3.RELEASE<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>



    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;finalName&gt;</span>${project.name}<span class="nt">&lt;/finalName&gt;</span>
        <span class="nt">&lt;resources&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory&gt;</span>src/main/resources<span class="nt">&lt;/directory&gt;</span>
                <span class="nt">&lt;filtering&gt;</span>true<span class="nt">&lt;/filtering&gt;</span>
                <span class="nt">&lt;includes&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*<span class="nt">&lt;/include&gt;</span>
                <span class="nt">&lt;/includes&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory&gt;</span>src/main/java<span class="nt">&lt;/directory&gt;</span>
                <span class="nt">&lt;includes&gt;</span>
                    <span class="nt">&lt;include&gt;</span>**/*.xml<span class="nt">&lt;/include&gt;</span>
                <span class="nt">&lt;/includes&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;/resources&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="c">&lt;!--&lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;--&gt;</span>

            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
                    <span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>

            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>maven-resources-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;encoding&gt;</span>utf-8<span class="nt">&lt;/encoding&gt;</span>
                    <span class="nt">&lt;useDefaultDelimiters&gt;</span>true<span class="nt">&lt;/useDefaultDelimiters&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<h4 id="åˆ›å»ºuaaæˆæƒæœåŠ¡å·¥ç¨‹">åˆ›å»ºUAAæˆæƒæœåŠ¡å·¥ç¨‹</h4>

<ul>
  <li>1ã€åœ¨çˆ¶å·¥ç¨‹ä¸Šåˆ›å»ºdistributed-security-uaaçš„model</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>distributed-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>distributed-security-uaa<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>

       <span class="c">&lt;!--&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;--&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-ribbon<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.netflix.hystrix<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hystrix-javanica<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.retry<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-retry<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-freemarker<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.data<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-data-commons<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.interceptor<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.interceptor-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></div></div>

<p><img src="https://i.loli.net/2020/02/22/1vwAGsPaxFQnfIe.png" alt="image.png" /></p>

<ul>
  <li>2ã€å¯åŠ¨ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@EnableHystrix</span>
<span class="nd">@EnableFeignClients</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span><span class="s">"com.pbteach.security.distributed.uaa"</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UAAServer</span> <span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">UAAServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>3ã€é…ç½®æ–‡ä»¶:åœ¨resourcesä¸‹åˆ›å»ºapplication.properties</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.application.name</span><span class="p">=</span><span class="s">uaa-service</span>
<span class="py">server.port</span><span class="p">=</span><span class="s">53020</span>
<span class="py">spring.main.allow-bean-definition-overriding</span> <span class="p">=</span> <span class="s">true</span>

<span class="py">logging.level.root</span> <span class="p">=</span> <span class="s">debug</span>
<span class="py">logging.level.org.springframework.web</span> <span class="p">=</span> <span class="s">info</span>

<span class="py">spring.http.encoding.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.http.encoding.charset</span> <span class="p">=</span> <span class="s">UTF-8</span>
<span class="py">spring.http.encoding.force</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">server.tomcat.remote_ip_header</span> <span class="p">=</span> <span class="s">x-forwarded-for</span>
<span class="py">server.tomcat.protocol_header</span> <span class="p">=</span> <span class="s">x-forwarded-proto</span>
<span class="py">server.use-forward-headers</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">server.servlet.context-path</span> <span class="p">=</span> <span class="s">/uaa</span>

<span class="py">spring.freemarker.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.freemarker.suffix</span> <span class="p">=</span> <span class="s">.html</span>
<span class="py">spring.freemarker.request-context-attribute</span> <span class="p">=</span> <span class="s">rc</span>
<span class="py">spring.freemarker.content-type</span> <span class="p">=</span> <span class="s">text/html</span>
<span class="py">spring.freemarker.charset</span> <span class="p">=</span> <span class="s">UTF-8</span>
<span class="py">spring.mvc.throw-exception-if-no-handler-found</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.resources.add-mappings</span> <span class="p">=</span> <span class="s">false</span>

<span class="py">spring.datasource.url</span> <span class="p">=</span> <span class="s">jdbc:mysql://localhost:3306/user_db?useUnicode=true</span>
<span class="py">spring.datasource.username</span> <span class="p">=</span> <span class="s">root</span>
<span class="py">spring.datasource.password</span> <span class="p">=</span> <span class="s">mysql</span>
<span class="py">spring.datasource.driver-class-name</span> <span class="p">=</span> <span class="s">com.mysql.jdbc.Driver</span>

<span class="c">#eureka.client.serviceUrl.defaultZone = http://localhost:53000/eureka/
#eureka.instance.preferIpAddress = true
#eureka.instance.instance-id = ${spring.application.name}:${spring.cloud.client.ip-address}:${spring.application.instance_id:${server.port}}
</span><span class="py">management.endpoints.web.exposure.include</span> <span class="p">=</span> <span class="s">refresh,health,info,env</span>

<span class="py">feign.hystrix.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">feign.compression.request.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="err">feign.compression.request.mime-types[0]</span> <span class="err">=</span> <span class="err">text/xml</span>
<span class="err">feign.compression.request.mime-types[1]</span> <span class="err">=</span> <span class="err">application/xml</span>
<span class="err">feign.compression.request.mime-types[2]</span> <span class="err">=</span> <span class="err">application/json</span>
<span class="py">feign.compression.request.min-request-size</span> <span class="p">=</span> <span class="s">2048</span>
<span class="py">feign.compression.response.enabled</span> <span class="p">=</span> <span class="s">true</span>
</code></pre></div></div>

<h4 id="åˆ›å»ºorderèµ„æºæœåŠ¡å·¥ç¨‹">åˆ›å»ºOrderèµ„æºæœåŠ¡å·¥ç¨‹</h4>

<ul>
  <li>æœ¬å·¥ç¨‹ä¸ºOrderè®¢å•æœåŠ¡å·¥ç¨‹ï¼Œè®¿é—®æœ¬å·¥ç¨‹çš„èµ„æºéœ€è¦è®¤è¯é€šè¿‡ã€‚</li>
  <li>æœ¬å·¥ç¨‹çš„ç›®çš„ä¸»è¦æ˜¯æµ‹è¯•è®¤è¯æˆæƒçš„åŠŸèƒ½ï¼Œæ‰€ä»¥ä¸æ¶‰åŠè®¢å•ç®¡ç†ç›¸å…³ä¸šåŠ¡ã€‚</li>
  <li>1ã€åœ¨çˆ¶å·¥ç¨‹ä¸Šåˆ›å»ºdistributed-security-orderçš„model</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>distributed-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>distributed-security-order<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>

        <span class="c">&lt;!--&lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;
        &lt;/dependency&gt;--&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.interceptor<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.interceptor-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>


    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></div></div>

<p><img src="https://i.loli.net/2020/02/22/mgoAZy2UrX8wDfS.png" alt="image.png" /></p>

<ul>
  <li>3ã€é…ç½®æ–‡ä»¶:åœ¨resourcesä¸­åˆ›å»ºapplication.properties</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.application.name</span><span class="p">=</span><span class="s">order-service</span>
<span class="py">server.port</span><span class="p">=</span><span class="s">53021</span>
<span class="py">spring.main.allow-bean-definition-overriding</span> <span class="p">=</span> <span class="s">true</span>

<span class="py">logging.level.root</span> <span class="p">=</span> <span class="s">debug</span>
<span class="py">logging.level.org.springframework.web</span> <span class="p">=</span> <span class="s">info</span>
<span class="py">spring.http.encoding.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.http.encoding.charset</span> <span class="p">=</span> <span class="s">UTF-8</span>
<span class="py">spring.http.encoding.force</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">server.tomcat.remote_ip_header</span> <span class="p">=</span> <span class="s">x-forwarded-for</span>
<span class="py">server.tomcat.protocol_header</span> <span class="p">=</span> <span class="s">x-forwarded-proto</span>
<span class="py">server.use-forward-headers</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">server.servlet.context-path</span> <span class="p">=</span> <span class="s">/order</span>


<span class="py">spring.freemarker.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.freemarker.suffix</span> <span class="p">=</span> <span class="s">.html</span>
<span class="py">spring.freemarker.request-context-attribute</span> <span class="p">=</span> <span class="s">rc</span>
<span class="py">spring.freemarker.content-type</span> <span class="p">=</span> <span class="s">text/html</span>
<span class="py">spring.freemarker.charset</span> <span class="p">=</span> <span class="s">UTF-8</span>
<span class="py">spring.mvc.throw-exception-if-no-handler-found</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">spring.resources.add-mappings</span> <span class="p">=</span> <span class="s">false</span>


<span class="c">#eureka.client.serviceUrl.defaultZone = http://localhost:53000/eureka/
#eureka.instance.preferIpAddress = true
#eureka.instance.instance-id = ${spring.application.name}:${spring.cloud.client.ip-address}:${spring.application.instance_id:${server.port}}
</span><span class="py">management.endpoints.web.exposure.include</span> <span class="p">=</span> <span class="s">refresh,health,info,env</span>

<span class="py">feign.hystrix.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">feign.compression.request.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="err">feign.compression.request.mime-types[0]</span> <span class="err">=</span> <span class="err">text/xml</span>
<span class="err">feign.compression.request.mime-types[1]</span> <span class="err">=</span> <span class="err">application/xml</span>
<span class="err">feign.compression.request.mime-types[2]</span> <span class="err">=</span> <span class="err">application/json</span>
<span class="py">feign.compression.request.min-request-size</span> <span class="p">=</span> <span class="s">2048</span>
<span class="py">feign.compression.response.enabled</span> <span class="p">=</span> <span class="s">true</span>
</code></pre></div></div>

<h4 id="æˆæƒæœåŠ¡å™¨é…ç½®">æˆæƒæœåŠ¡å™¨é…ç½®</h4>

<h5 id="enableauthorizationserver">EnableAuthorizationServer</h5>

<ul>
  <li>å¯ä»¥ç”¨ @EnableAuthorizationServer æ³¨è§£å¹¶ç»§æ‰¿AuthorizationServerConfigurerAdapteræ¥é…ç½®OAuth2.0 æˆæƒæœåŠ¡å™¨ã€‚</li>
  <li>åœ¨uaaé¡¹ç›®çš„ConfigåŒ…ä¸‹åˆ›å»ºAuthorizationServerï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableAuthorizationServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServer</span> <span class="kd">extends</span>
      <span class="nc">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>
        <span class="c1">//ç•¥...</span>
 <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>AuthorizationServerConfigurerAdapterè¦æ±‚é…ç½®ä»¥ä¸‹å‡ ä¸ªç±»ï¼Œè¿™å‡ ä¸ªç±»æ˜¯ç”±Springåˆ›å»ºçš„ç‹¬ç«‹çš„é…ç½®å¯¹è±¡ï¼Œå®ƒä»¬ä¼šè¢«Springä¼ å…¥AuthorizationServerConfigurerä¸­è¿›è¡Œé…ç½®ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServerConfigurerAdapter</span> <span class="kd">implements</span> <span class="nc">AuthorizationServerConfigurer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">AuthorizationServerConfigurerAdapter</span><span class="o">()</span> <span class="o">{}</span>
    
    <span class="c1">//AuthorizationServerSecurityConfigurerï¼šç”¨æ¥é…ç½®ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ.</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{}</span>
    
    <span class="cm">/*
    ClientDetailsServiceConfigurerï¼šç”¨æ¥é…ç½®å®¢æˆ·ç«¯è¯¦æƒ…æœåŠ¡ï¼ˆClientDetailsServiceï¼‰ï¼Œå®¢æˆ·ç«¯è¯¦æƒ…ä¿¡æ¯åœ¨è¿™é‡Œè¿›è¡Œåˆå§‹åŒ–ï¼Œä½ èƒ½å¤ŸæŠŠå®¢æˆ·ç«¯è¯¦æƒ…ä¿¡æ¯å†™æ­»åœ¨è¿™é‡Œæˆ–è€…æ˜¯é€šè¿‡æ•°æ®åº“æ¥å­˜å‚¨è°ƒå–è¯¦æƒ…ä¿¡æ¯ã€‚
    */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{}</span>
    
    <span class="cm">/*
    AuthorizationServerEndpointsConfigurerï¼šç”¨æ¥é…ç½®ä»¤ç‰Œï¼ˆtokenï¼‰çš„è®¿é—®ç«¯ç‚¹å’Œä»¤ç‰ŒæœåŠ¡(token services)ã€‚
    */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯">é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯</h5>

<ul>
  <li>ClientDetailsServiceConfigurer èƒ½å¤Ÿä½¿ç”¨å†…å­˜æˆ–è€…JDBCæ¥å®ç°å®¢æˆ·ç«¯è¯¦æƒ…æœåŠ¡ï¼ˆClientDetailsServiceï¼‰ï¼ŒClientDetailsServiceè´Ÿè´£æŸ¥æ‰¾ClientDetailsï¼Œè€ŒClientDetailsæœ‰å‡ ä¸ªé‡è¦çš„å±æ€§å¦‚ä¸‹åˆ—è¡¨ï¼š</li>
  <li>clientIdï¼šï¼ˆå¿…é¡»çš„ï¼‰ç”¨æ¥æ ‡è¯†å®¢æˆ·çš„Idã€‚</li>
  <li>secretï¼šï¼ˆéœ€è¦å€¼å¾—ä¿¡ä»»çš„å®¢æˆ·ç«¯ï¼‰å®¢æˆ·ç«¯å®‰å…¨ç ï¼Œå¦‚æœæœ‰çš„è¯ã€‚</li>
  <li>scopeï¼šç”¨æ¥é™åˆ¶å®¢æˆ·ç«¯çš„è®¿é—®èŒƒå›´ï¼Œå¦‚æœä¸ºç©ºï¼ˆé»˜è®¤ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯æ‹¥æœ‰å…¨éƒ¨çš„è®¿é—®èŒƒå›´ã€‚</li>
  <li>authorizedGrantTypesï¼šæ­¤å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨çš„æˆæƒç±»å‹ï¼Œé»˜è®¤ä¸ºç©ºã€‚</li>
  <li>authoritiesï¼šæ­¤å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨çš„æƒé™ï¼ˆåŸºäºSpring Security authoritiesï¼‰ã€‚</li>
  <li>å®¢æˆ·ç«¯è¯¦æƒ…ï¼ˆClient Detailsï¼‰èƒ½å¤Ÿåœ¨åº”ç”¨ç¨‹åºè¿è¡Œçš„æ—¶å€™è¿›è¡Œæ›´æ–°ï¼Œå¯ä»¥é€šè¿‡è®¿é—®åº•å±‚çš„å­˜å‚¨æœåŠ¡ï¼ˆä¾‹å¦‚å°†å®¢æˆ·ç«¯è¯¦æƒ…å­˜å‚¨åœ¨ä¸€ä¸ªå…³ç³»æ•°æ®åº“çš„è¡¨ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ JdbcClientDetailsServiceï¼‰æˆ–è€…é€šè¿‡è‡ªå·±å®ç°ClientRegistrationServiceæ¥å£ï¼ˆåŒæ—¶ä½ ä¹Ÿå¯ä»¥å®ç° ClientDetailsService æ¥å£ï¼‰æ¥è¿›è¡Œç®¡ç†ã€‚</li>
  <li>æˆ‘ä»¬æš‚æ—¶ä½¿ç”¨å†…å­˜æ–¹å¼å­˜å‚¨å®¢æˆ·ç«¯è¯¦æƒ…ä¿¡æ¯ï¼ŒAuthorizationServeré…ç½®å¦‚ä¸‹:</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//é…ç½®å®¢æˆ·ç«¯è¯¦ç»†ä¿¡æ¯</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="c1">//		clients.withClientDetails(clientDetailsService);</span>
    <span class="c1">//æš‚æ—¶ä½¿ç”¨å†…å­˜å­˜å‚¨æ–¹å¼</span>
    <span class="n">clients</span><span class="o">.</span><span class="na">inMemory</span><span class="o">()</span><span class="c1">// ä½¿ç”¨in-memoryå­˜å‚¨</span>
        <span class="o">.</span><span class="na">withClient</span><span class="o">(</span><span class="s">"c1"</span><span class="o">)</span><span class="c1">// client_id</span>
        <span class="o">.</span><span class="na">secret</span><span class="o">(</span><span class="k">new</span> <span class="nc">BCryptPasswordEncoder</span><span class="o">().</span><span class="na">encode</span><span class="o">(</span><span class="s">"secret"</span><span class="o">))</span><span class="c1">//å®¢æˆ·ç«¯ç§˜é’¥</span>
        <span class="o">.</span><span class="na">resourceIds</span><span class="o">(</span><span class="s">"res1"</span><span class="o">)</span><span class="c1">//å®¢æˆ·ç«¯å¯è®¿é—®çš„èµ„æºåˆ—è¡¨</span>
        <span class="o">.</span><span class="na">authorizedGrantTypes</span><span class="o">(</span><span class="s">"authorization_code"</span><span class="o">,</span> <span class="s">"password"</span><span class="o">,</span><span class="s">"client_credentials"</span><span class="o">,</span><span class="s">"implicit"</span><span class="o">,</span><span class="s">"refresh_token"</span><span class="o">)</span><span class="c1">// è¯¥clientå…è®¸çš„æˆæƒç±»å‹authorization_code,password,refresh_token,implicit,client_credentials</span>
        <span class="o">.</span><span class="na">scopes</span><span class="o">(</span><span class="s">"all"</span><span class="o">)</span><span class="c1">// å…è®¸çš„æˆæƒèŒƒå›´</span>
        <span class="o">.</span><span class="na">autoApprove</span><span class="o">(</span><span class="kc">false</span><span class="o">)</span><span class="c1">//false è·³è½¬åˆ°æˆæƒé¡µé¢ã€‚true ç›´æ¥é¢å‘ä»¤ç‰Œ</span>
        <span class="c1">//åŠ ä¸ŠéªŒè¯å›è°ƒåœ°å€</span>
        <span class="o">.</span><span class="na">redirectUris</span><span class="o">(</span><span class="s">"http://www.baidu.com"</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="ç®¡ç†ä»¤ç‰Œ">ç®¡ç†ä»¤ç‰Œ</h5>

<ul>
  <li>AuthorizationServerTokenServices æ¥å£å®šä¹‰äº†ä¸€äº›æ“ä½œä½¿å¾—ä½ å¯ä»¥å¯¹ä»¤ç‰Œè¿›è¡Œä¸€äº›å¿…è¦çš„ç®¡ç†ï¼Œä»¤ç‰Œå¯ä»¥è¢«ç”¨æ¥åŠ è½½èº«ä»½ä¿¡æ¯ï¼Œé‡Œé¢åŒ…å«äº†è¿™ä¸ªä»¤ç‰Œçš„ç›¸å…³æƒé™ã€‚</li>
  <li>è‡ªå·±å¯ä»¥åˆ›å»º AuthorizationServerTokenServices è¿™ä¸ªæ¥å£çš„å®ç°ï¼Œåˆ™éœ€è¦ç»§æ‰¿ DefaultTokenServices è¿™ä¸ªç±»ï¼Œé‡Œé¢åŒ…å«äº†ä¸€äº›æœ‰ç”¨å®ç°ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥ä¿®æ”¹ä»¤ç‰Œçš„æ ¼å¼å’Œä»¤ç‰Œçš„å­˜å‚¨ã€‚é»˜è®¤çš„ï¼Œå½“å®ƒå°è¯•åˆ›å»ºä¸€ä¸ªä»¤ç‰Œçš„æ—¶å€™ï¼Œæ˜¯ä½¿ç”¨éšæœºå€¼æ¥è¿›è¡Œå¡«å……çš„ï¼Œé™¤äº†æŒä¹…åŒ–ä»¤ç‰Œæ˜¯å§”æ‰˜ä¸€ä¸ª TokenStore æ¥å£æ¥å®ç°ä»¥å¤–ï¼Œè¿™ä¸ªç±»å‡ ä¹å¸®ä½ åšäº†æ‰€æœ‰çš„äº‹æƒ…ã€‚å¹¶ä¸” TokenStore è¿™ä¸ªæ¥å£æœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ï¼Œå®ƒå°±æ˜¯ InMemoryTokenStore ï¼Œå¦‚å…¶å‘½åï¼Œæ‰€æœ‰çš„ä»¤ç‰Œæ˜¯è¢«ä¿å­˜åœ¨äº†å†…å­˜ä¸­ã€‚é™¤äº†ä½¿ç”¨è¿™ä¸ªç±»ä»¥å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸€äº›å…¶ä»–çš„é¢„å®šä¹‰å®ç°ï¼Œä¸‹é¢æœ‰å‡ ä¸ªç‰ˆæœ¬ï¼Œå®ƒä»¬éƒ½å®ç°äº†TokenStoreæ¥å£ï¼š
    <ul>
      <li><strong>InMemoryTokenStore</strong>ï¼šè¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ˜¯è¢«é»˜è®¤é‡‡ç”¨çš„ï¼Œå®ƒå¯ä»¥å®Œç¾çš„å·¥ä½œåœ¨å•æœåŠ¡å™¨ä¸Šï¼ˆå³è®¿é—®å¹¶å‘é‡å‹åŠ›ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œå¹¶ä¸”å®ƒåœ¨å¤±è´¥çš„æ—¶å€™ä¸ä¼šè¿›è¡Œå¤‡ä»½ï¼‰ï¼Œå¤§å¤šæ•°çš„é¡¹ç›®éƒ½å¯ä»¥ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ¥è¿›è¡Œå°è¯•ï¼Œä½ å¯ä»¥åœ¨å¼€å‘çš„æ—¶å€™ä½¿ç”¨å®ƒæ¥è¿›è¡Œç®¡ç†ï¼Œå› ä¸ºä¸ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œæ‰€ä»¥æ›´æ˜“äºè°ƒè¯•ã€‚</li>
      <li><strong>JdbcTokenStore</strong>ï¼šè¿™æ˜¯ä¸€ä¸ªåŸºäºJDBCçš„å®ç°ç‰ˆæœ¬ï¼Œä»¤ç‰Œä¼šè¢«ä¿å­˜è¿›å…³ç³»å‹æ•°æ®åº“ã€‚ä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„å®ç°æ—¶ï¼Œä½ å¯ä»¥åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¹‹é—´å…±äº«ä»¤ç‰Œä¿¡æ¯ï¼Œä½¿ç”¨è¿™ä¸ªç‰ˆæœ¬çš„æ—¶å€™è¯·æ³¨æ„æŠŠâ€spring-jdbcâ€è¿™ä¸ªä¾èµ–åŠ å…¥åˆ°ä½ çš„classpathå½“ä¸­ã€‚</li>
      <li><strong>JwtTokenStore</strong>ï¼šè¿™ä¸ªç‰ˆæœ¬çš„å…¨ç§°æ˜¯ JSON Web Tokenï¼ˆJWTï¼‰ï¼Œå®ƒå¯ä»¥æŠŠä»¤ç‰Œç›¸å…³çš„æ•°æ®è¿›è¡Œç¼–ç ï¼ˆå› æ­¤å¯¹äºåç«¯æœåŠ¡æ¥è¯´ï¼Œå®ƒä¸éœ€è¦è¿›è¡Œå­˜å‚¨ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªé‡å¤§ä¼˜åŠ¿ï¼‰ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯æ’¤é”€ä¸€ä¸ªå·²ç»æˆæƒä»¤ç‰Œå°†ä¼šéå¸¸å›°éš¾ï¼Œæ‰€ä»¥å®ƒé€šå¸¸ç”¨æ¥å¤„ç†ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„ä»¤ç‰Œä»¥åŠæ’¤é”€åˆ·æ–°ä»¤ç‰Œï¼ˆrefresh_tokenï¼‰ã€‚å¦å¤–ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯è¿™ä¸ªä»¤ç‰Œå ç”¨çš„ç©ºé—´ä¼šæ¯”è¾ƒå¤§ï¼Œå¦‚æœä½ åŠ å…¥äº†æ¯”è¾ƒå¤šç”¨æˆ·å‡­è¯ä¿¡æ¯ã€‚JwtTokenStore ä¸ä¼šä¿å­˜ä»»ä½•æ•°æ®ï¼Œä½†æ˜¯å®ƒåœ¨è½¬æ¢ä»¤ç‰Œå€¼ä»¥åŠæˆæƒä¿¡æ¯æ–¹é¢ä¸ DefaultTokenServices æ‰€æ‰®æ¼”çš„è§’è‰²æ˜¯ä¸€æ ·çš„ã€‚</li>
    </ul>
  </li>
  <li>1ã€å®šä¹‰TokenConfigï¼šåœ¨configåŒ…ä¸‹å®šä¹‰TokenConfigï¼Œæˆ‘ä»¬æš‚æ—¶å…ˆä½¿ç”¨InMemoryTokenStoreï¼Œç”Ÿæˆä¸€ä¸ªæ™®é€šçš„ä»¤ç‰Œã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenConfig</span> <span class="o">{</span>
	<span class="c1">//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥</span>
      <span class="nd">@Bean</span>
      <span class="kd">public</span> <span class="nc">TokenStore</span> <span class="nf">tokenStore</span><span class="o">()</span> <span class="o">{</span>
          <span class="c1">//å†…å­˜æ–¹å¼ï¼Œç”Ÿæˆæ™®é€šä»¤ç‰Œ</span>
          <span class="k">return</span> <span class="k">new</span> <span class="nf">InMemoryTokenStore</span><span class="o">();</span>
      <span class="o">}</span>

  <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>2ã€å®šä¹‰AuthorizationServerTokenServicesï¼šåœ¨AuthorizationServerä¸­å®šä¹‰AuthorizationServerTokenServices</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

<span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">ClientDetailsService</span> <span class="n">clientDetailsService</span><span class="o">;</span>
<span class="c1">//ä»¤ç‰Œç®¡ç†æœåŠ¡</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">AuthorizationServerTokenServices</span> <span class="nf">tokenService</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">DefaultTokenServices</span> <span class="n">service</span><span class="o">=</span><span class="k">new</span> <span class="nc">DefaultTokenServices</span><span class="o">();</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setClientDetailsService</span><span class="o">(</span><span class="n">clientDetailsService</span><span class="o">);</span><span class="c1">//å®¢æˆ·ç«¯ä¿¡æ¯æœåŠ¡</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setSupportRefreshToken</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span><span class="c1">//æ˜¯å¦äº§ç”Ÿåˆ·æ–°ä»¤ç‰Œ</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setTokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">);</span><span class="c1">//ä»¤ç‰Œå­˜å‚¨ç­–ç•¥</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="o">(</span><span class="mi">7200</span><span class="o">);</span> <span class="c1">// ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="o">(</span><span class="mi">259200</span><span class="o">);</span> <span class="c1">// åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤©</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="ä»¤ç‰Œè®¿é—®ç«¯ç‚¹é…ç½®">ä»¤ç‰Œè®¿é—®ç«¯ç‚¹é…ç½®</h5>

<ul>
  <li>AuthorizationServerEndpointsConfigurer è¿™ä¸ªå¯¹è±¡çš„å®ä¾‹å¯ä»¥å®Œæˆä»¤ç‰ŒæœåŠ¡ä»¥åŠä»¤ç‰Œendpointé…ç½®ã€‚</li>
</ul>

<p><strong>é…ç½®æˆæƒç±»å‹ï¼ˆGrant Typesï¼‰</strong></p>

<ul>
  <li>AuthorizationServerEndpointsConfigurer é€šè¿‡è®¾å®šä»¥ä¸‹å±æ€§å†³å®šæ”¯æŒçš„<strong>æˆæƒç±»å‹ï¼ˆGrant Typesï¼‰:</strong>
    <ul>
      <li><strong>authenticationManager</strong>ï¼šè®¤è¯ç®¡ç†å™¨ï¼Œå½“ä½ é€‰æ‹©äº†èµ„æºæ‰€æœ‰è€…å¯†ç ï¼ˆpasswordï¼‰æˆæƒç±»å‹çš„æ—¶å€™ï¼Œè¯·è®¾ç½®è¿™ä¸ªå±æ€§æ³¨å…¥ä¸€ä¸ª AuthenticationManager å¯¹è±¡ã€‚</li>
      <li><strong>userDetailsService</strong>ï¼šå¦‚æœä½ è®¾ç½®äº†è¿™ä¸ªå±æ€§çš„è¯ï¼Œé‚£è¯´æ˜ä½ æœ‰ä¸€ä¸ªè‡ªå·±çš„ UserDetailsService æ¥å£çš„å®ç°ï¼Œæˆ–è€…ä½ å¯ä»¥æŠŠè¿™ä¸ªä¸œè¥¿è®¾ç½®åˆ°å…¨å±€åŸŸä¸Šé¢å»ï¼ˆä¾‹å¦‚ GlobalAuthenticationManagerConfigurer è¿™ä¸ªé…ç½®å¯¹è±¡ï¼‰ï¼Œå½“ä½ è®¾ç½®äº†è¿™ä¸ªä¹‹åï¼Œé‚£ä¹ˆ â€œrefresh_tokenâ€ å³åˆ·æ–°ä»¤ç‰Œæˆæƒç±»å‹æ¨¡å¼çš„æµç¨‹ä¸­å°±ä¼šåŒ…å«ä¸€ä¸ªæ£€æŸ¥ï¼Œç”¨æ¥ç¡®ä¿è¿™ä¸ªè´¦å·æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼Œå‡å¦‚è¯´ä½ ç¦ç”¨äº†è¿™ä¸ªè´¦æˆ·çš„è¯ã€‚</li>
      <li><strong>authorizationCodeServices</strong>ï¼šè¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥è®¾ç½®æˆæƒç æœåŠ¡çš„ï¼ˆå³ AuthorizationCodeServices çš„å®ä¾‹å¯¹è±¡ï¼‰ï¼Œä¸»è¦ç”¨äº â€œauthorization_codeâ€ æˆæƒç ç±»å‹æ¨¡å¼ã€‚</li>
      <li><strong>implicitGrantService</strong>ï¼šè¿™ä¸ªå±æ€§ç”¨äºè®¾ç½®éšå¼æˆæƒæ¨¡å¼ï¼Œç”¨æ¥ç®¡ç†éšå¼æˆæƒæ¨¡å¼çš„çŠ¶æ€ã€‚</li>
      <li><strong>tokenGranter</strong>ï¼šå½“ä½ è®¾ç½®äº†è¿™ä¸ªä¸œè¥¿ï¼ˆå³ TokenGranter æ¥å£å®ç°ï¼‰ï¼Œé‚£ä¹ˆæˆæƒå°†ä¼šäº¤ç”±ä½ æ¥å®Œå…¨æŒæ§ï¼Œå¹¶ä¸”ä¼šå¿½ç•¥æ‰ä¸Šé¢çš„è¿™å‡ ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¸€èˆ¬æ˜¯ç”¨ä½œæ‹“å±•ç”¨é€”çš„ï¼Œå³æ ‡å‡†çš„å››ç§æˆæƒæ¨¡å¼å·²ç»æ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚çš„æ—¶å€™ï¼Œæ‰ä¼šè€ƒè™‘ä½¿ç”¨è¿™ä¸ªã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>é…ç½®æˆæƒç«¯ç‚¹çš„URLï¼ˆEndpoint URLsï¼‰ï¼š</strong></p>

<ul>
  <li>AuthorizationServerEndpointsConfigurer è¿™ä¸ªé…ç½®å¯¹è±¡æœ‰ä¸€ä¸ªå«åš pathMapping() çš„æ–¹æ³•ç”¨æ¥é…ç½®ç«¯ç‚¹URLé“¾æ¥ï¼Œå®ƒæœ‰ä¸¤ä¸ªå‚æ•°ï¼š
    <ul>
      <li>ç¬¬ä¸€ä¸ªå‚æ•°ï¼šString ç±»å‹çš„ï¼Œè¿™ä¸ªç«¯ç‚¹URLçš„é»˜è®¤é“¾æ¥ã€‚</li>
      <li>ç¬¬äºŒä¸ªå‚æ•°ï¼šString ç±»å‹çš„ï¼Œä½ è¦è¿›è¡Œæ›¿ä»£çš„URLé“¾æ¥ã€‚</li>
    </ul>
  </li>
  <li>ä»¥ä¸Šçš„å‚æ•°éƒ½å°†ä»¥ â€œ/â€ å­—ç¬¦ä¸ºå¼€å§‹çš„å­—ç¬¦ä¸²ï¼Œæ¡†æ¶çš„é»˜è®¤URLé“¾æ¥å¦‚ä¸‹åˆ—è¡¨ï¼Œå¯ä»¥ä½œä¸ºè¿™ä¸ª pathMapping() æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼š
    <ul>
      <li>/oauth/authorizeï¼šæˆæƒç«¯ç‚¹ã€‚</li>
      <li>/oauth/tokenï¼šä»¤ç‰Œç«¯ç‚¹ã€‚</li>
      <li>/oauth/confirm_accessï¼šç”¨æˆ·ç¡®è®¤æˆæƒæäº¤ç«¯ç‚¹ã€‚</li>
      <li>/oauth/errorï¼šæˆæƒæœåŠ¡é”™è¯¯ä¿¡æ¯ç«¯ç‚¹ã€‚</li>
      <li>/oauth/check_tokenï¼šç”¨äºèµ„æºæœåŠ¡è®¿é—®çš„ä»¤ç‰Œè§£æç«¯ç‚¹ã€‚</li>
      <li>/oauth/token_keyï¼šæä¾›å…¬æœ‰å¯†åŒ™çš„ç«¯ç‚¹ï¼Œå¦‚æœä½ ä½¿ç”¨JWTä»¤ç‰Œçš„è¯ã€‚</li>
    </ul>
  </li>
  <li>éœ€è¦æ³¨æ„çš„æ˜¯æˆæƒç«¯ç‚¹è¿™ä¸ªURLåº”è¯¥è¢«Spring Securityä¿æŠ¤èµ·æ¥åªä¾›æˆæƒç”¨æˆ·è®¿é—®.</li>
  <li>åœ¨AuthorizationServeré…ç½®ä»¤ç‰Œè®¿é—®ç«¯ç‚¹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>

<span class="kd">private</span> <span class="nc">AuthorizationCodeServices</span> <span class="n">authorizationCodeServices</span><span class="o">;</span>

<span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>

<span class="c1">//ä»¤ç‰Œè®¿é—®ç«¯ç‚¹</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">{</span>

    <span class="n">endpoints</span>
        <span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">)</span><span class="c1">//å¯†ç æ¨¡å¼éœ€è¦</span>
        <span class="o">.</span><span class="na">authorizationCodeServices</span><span class="o">(</span><span class="n">authorizationCodeServices</span><span class="o">)</span><span class="c1">//æˆæƒç æ¨¡å¼éœ€è¦</span>
        <span class="o">.</span><span class="na">tokenServices</span><span class="o">(</span><span class="n">tokenService</span><span class="o">())</span><span class="c1">//ä»¤ç‰Œç®¡ç†æœåŠ¡</span>
        <span class="o">.</span><span class="na">allowedTokenEndpointRequestMethods</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">);</span><span class="c1">//å…è®¸postæäº¤</span>

<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">AuthorizationCodeServices</span> <span class="nf">authorizationCodeServices</span><span class="o">()</span> <span class="o">{</span> <span class="c1">//è®¾ç½®æˆæƒç æ¨¡å¼çš„æˆæƒç å¦‚ä½•å­˜å–ï¼Œæš‚æ—¶é‡‡ç”¨å†…å­˜æ–¹å¼</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">InMemoryAuthorizationCodeServices</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ">ä»¤ç‰Œç«¯ç‚¹çš„å®‰å…¨çº¦æŸ</h5>

<ul>
  <li><strong>AuthorizationServerSecurityConfigurer</strong>ï¼šç”¨æ¥é…ç½®ä»¤ç‰Œç«¯ç‚¹(Token Endpoint)çš„å®‰å…¨çº¦æŸï¼Œåœ¨AuthorizationServerä¸­é…ç½®å¦‚ä¸‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">){</span>
   <span class="n">security</span>
   <span class="o">.</span><span class="na">tokenKeyAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span>					<span class="o">(</span><span class="mi">1</span><span class="o">)</span>
   <span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span>					<span class="o">(</span><span class="mi">2</span><span class="o">)</span>
   <span class="o">.</span><span class="na">allowFormAuthenticationForClients</span><span class="o">()</span>				<span class="o">(</span><span class="mi">3</span><span class="o">)</span>
   <span class="o">;</span>
<span class="o">}</span>
<span class="cm">/*
ï¼ˆ1ï¼‰tokenkeyè¿™ä¸ªendpointå½“ä½¿ç”¨JwtTokenä¸”ä½¿ç”¨éå¯¹ç§°åŠ å¯†æ—¶ï¼Œèµ„æºæœåŠ¡ç”¨äºè·å–å…¬é’¥è€Œå¼€æ”¾çš„ï¼Œè¿™é‡ŒæŒ‡è¿™ä¸ªendpointå®Œå…¨å…¬å¼€ã€‚
ï¼ˆ2ï¼‰checkTokenè¿™ä¸ªendpointå®Œå…¨å…¬å¼€
ï¼ˆ3ï¼‰ å…è®¸è¡¨å•è®¤è¯,ç”³è¯·ä»¤ç‰Œ
*/</span>
</code></pre></div></div>

<ul>
  <li><strong>æˆæƒæœåŠ¡é…ç½®æ€»ç»“</strong>ï¼šæˆæƒæœåŠ¡é…ç½®åˆ†æˆä¸‰å¤§å—ï¼Œå¯ä»¥å…³è”è®°å¿†ã€‚</li>
  <li>æ—¢ç„¶è¦å®Œæˆè®¤è¯ï¼Œå®ƒé¦–å…ˆå¾—çŸ¥é“å®¢æˆ·ç«¯ä¿¡æ¯ä»å“ªå„¿è¯»å–ï¼Œå› æ­¤è¦è¿›è¡Œå®¢æˆ·ç«¯è¯¦æƒ…é…ç½®ã€‚</li>
  <li>æ—¢ç„¶è¦é¢å‘tokenï¼Œé‚£å¿…é¡»å¾—å®šä¹‰tokençš„ç›¸å…³endpointï¼Œä»¥åŠtokenå¦‚ä½•å­˜å–ï¼Œä»¥åŠå®¢æˆ·ç«¯æ”¯æŒå“ªäº›ç±»å‹çš„tokenã€‚</li>
  <li>æ—¢ç„¶æš´éœ²é™¤äº†ä¸€äº›endpointï¼Œé‚£å¯¹è¿™äº›endpointå¯ä»¥å®šä¹‰ä¸€äº›å®‰å…¨ä¸Šçš„çº¦æŸç­‰ã€‚</li>
</ul>

<h5 id="webå®‰å…¨é…ç½®">webå®‰å…¨é…ç½®</h5>

<ul>
  <li>å°†Spring-Bootå·¥ç¨‹ä¸­çš„WebSecurityConfigæ‹·è´åˆ°UAAå·¥ç¨‹ä¸­ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AuthenticationManager</span> <span class="nf">authenticationManagerBean</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">authenticationManagerBean</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//å®‰å…¨æ‹¦æˆªæœºåˆ¶ï¼ˆæœ€é‡è¦ï¼‰</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/r1"</span><span class="o">).</span><span class="na">hasAnyAuthority</span><span class="o">(</span><span class="s">"p1"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/login*"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">authenticated</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">()</span>
                <span class="o">.</span><span class="na">formLogin</span><span class="o">()</span>
        <span class="o">;</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="æˆæƒç æ¨¡å¼">æˆæƒç æ¨¡å¼</h4>

<p><img src="https://i.loli.net/2020/02/22/JWowy86dLm1S3PF.png" alt="image.png" /></p>

<ul>
  <li>
    <p><strong>ï¼ˆ1ï¼‰èµ„æºæ‹¥æœ‰è€…æ‰“å¼€å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦æ±‚èµ„æºæ‹¥æœ‰è€…ç»™äºˆæˆæƒï¼Œå®ƒå°†æµè§ˆå™¨è¢«é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼Œé‡å®šå‘æ—¶ä¼šé™„åŠ å®¢æˆ·ç«¯çš„èº«ä»½ä¿¡æ¯ã€‚å¦‚ï¼š</strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/uaa/oauth/authorize?client_id=c1&amp;response_type=code&amp;scope=all&amp;redirect_uri=http://www.baidu.com
</code></pre></div>    </div>

    <ul>
      <li>
        <p>å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
      </li>
      <li>client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚</li>
      <li>response_typeï¼šæˆæƒç æ¨¡å¼å›ºå®šä¸ºcodeã€‚</li>
      <li>scopeï¼šå®¢æˆ·ç«¯æƒé™ã€‚</li>
      <li>redirect_uriï¼šè·³è½¬uriï¼Œå½“æˆæƒç ç”³è¯·æˆåŠŸåä¼šè·³è½¬åˆ°æ­¤åœ°å€ï¼Œå¹¶åœ¨åè¾¹å¸¦ä¸Šcodeå‚æ•°ï¼ˆæˆæƒç ï¼‰ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>ï¼ˆ2ï¼‰æµè§ˆå™¨å‡ºç°å‘æˆæƒæœåŠ¡å™¨æˆæƒé¡µé¢ï¼Œä¹‹åå°†ç”¨æˆ·åŒæ„æˆæƒã€‚</strong></p>
  </li>
  <li>
    <p><strong>ï¼ˆ3ï¼‰æˆæƒæœåŠ¡å™¨å°†æˆæƒç ï¼ˆAuthorizationCodeï¼‰è½¬ç»æµè§ˆå™¨å‘é€ç»™client(é€šè¿‡redirect_uri)ã€‚</strong></p>
  </li>
  <li>
    <p><strong>ï¼ˆ4ï¼‰å®¢æˆ·ç«¯æ‹¿ç€æˆæƒç å‘æˆæƒæœåŠ¡å™¨ç´¢è¦è®¿é—®access_tokenï¼Œè¯·æ±‚å¦‚ä¸‹ï¼š</strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/uaa/oauth/token?client_id=c1&amp;client_secret=secret&amp;grant_type=authorization_code&amp;code=5PgfcD&amp;redirect_uri=http://www.baidu.com
</code></pre></div>    </div>

    <ul>
      <li>
        <p>å‚æ•°åˆ—è¡¨å¦‚ä¸‹</p>
      </li>
      <li>client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚</li>
      <li>client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚</li>
      <li>grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™authorization_codeï¼Œè¡¨ç¤ºæˆæƒç æ¨¡å¼</li>
      <li>codeï¼šæˆæƒç ï¼Œå°±æ˜¯åˆšåˆšè·å–çš„æˆæƒç ï¼Œæ³¨æ„ï¼šæˆæƒç åªä½¿ç”¨ä¸€æ¬¡å°±æ— æ•ˆäº†ï¼Œéœ€è¦é‡æ–°ç”³è¯·ã€‚</li>
      <li>redirect_uriï¼šç”³è¯·æˆæƒç æ—¶çš„è·³è½¬urlï¼Œä¸€å®šå’Œç”³è¯·æˆæƒç æ—¶ç”¨çš„redirect_uriä¸€è‡´ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>ï¼ˆ5ï¼‰æˆæƒæœåŠ¡å™¨è¿”å›ä»¤ç‰Œ(access_token)</strong></p>
  </li>
  <li>
    <p>è¿™ç§æ¨¡å¼æ˜¯å››ç§æ¨¡å¼ä¸­æœ€å®‰å…¨çš„ä¸€ç§æ¨¡å¼ã€‚ä¸€èˆ¬ç”¨äºclientæ˜¯WebæœåŠ¡å™¨ç«¯åº”ç”¨æˆ–ç¬¬ä¸‰æ–¹çš„åŸç”ŸAppè°ƒç”¨èµ„æºæœåŠ¡çš„æ—¶å€™ã€‚å› ä¸ºåœ¨è¿™ç§æ¨¡å¼ä¸­access_tokenä¸ä¼šç»è¿‡æµè§ˆå™¨æˆ–ç§»åŠ¨ç«¯çš„Appï¼Œè€Œæ˜¯ç›´æ¥ä»æœåŠ¡ç«¯å»äº¤æ¢ï¼Œè¿™æ ·å°±æœ€å¤§é™åº¦çš„å‡å°äº†ä»¤ç‰Œæ³„æ¼çš„é£é™©ã€‚</p>
  </li>
</ul>

<h4 id="ç®€åŒ–æ¨¡å¼">ç®€åŒ–æ¨¡å¼</h4>

<p><img src="https://i.loli.net/2020/02/22/J7wnpS6siXv4jt9.png" alt="image.png" /></p>

<ul>
  <li>
    <p><strong>ï¼ˆ1ï¼‰èµ„æºæ‹¥æœ‰è€…æ‰“å¼€å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¦æ±‚èµ„æºæ‹¥æœ‰è€…ç»™äºˆæˆæƒï¼Œå®ƒå°†æµè§ˆå™¨è¢«é‡å®šå‘åˆ°æˆæƒæœåŠ¡å™¨ï¼Œé‡å®šå‘æ—¶ä¼šé™„åŠ å®¢æˆ·ç«¯çš„èº«ä»½ä¿¡æ¯</strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/uaa/oauth/authorize?client_id=c1&amp;response_type=token&amp;scope=all&amp;redirect_uri=http://www.baidu.com
</code></pre></div>    </div>

    <p>å‚æ•°æè¿°åŒ<strong>æˆæƒç æ¨¡å¼</strong> ï¼Œæ³¨æ„response_type=tokenï¼Œè¯´æ˜æ˜¯ç®€åŒ–æ¨¡å¼ã€‚</p>
  </li>
  <li>
    <p><strong>ï¼ˆ2ï¼‰æµè§ˆå™¨å‡ºç°å‘æˆæƒæœåŠ¡å™¨æˆæƒé¡µé¢ï¼Œä¹‹åå°†ç”¨æˆ·åŒæ„æˆæƒã€‚</strong></p>
  </li>
  <li>
    <p>ï¼ˆ<strong>3ï¼‰æˆæƒæœåŠ¡å™¨å°†æˆæƒç å°†ä»¤ç‰Œï¼ˆaccess_tokenï¼‰ä»¥Hashçš„å½¢å¼å­˜æ”¾åœ¨é‡å®šå‘uriçš„fargmentä¸­å‘é€ç»™æµè§ˆå™¨ã€‚</strong></p>
  </li>
  <li>
    <p>fragment ä¸»è¦æ˜¯ç”¨æ¥æ ‡è¯† URI æ‰€æ ‡è¯†èµ„æºé‡Œçš„æŸä¸ªèµ„æºï¼Œåœ¨ URI çš„æœ«å°¾é€šè¿‡ ï¼ˆ#ï¼‰ä½œä¸º fragment çš„å¼€å¤´ï¼Œå…¶ä¸­ # ä¸å±äº fragment çš„å€¼ã€‚å¦‚https://domain/index#L18è¿™ä¸ª URI ä¸­ <code class="language-plaintext highlighter-rouge">L18</code> å°±æ˜¯ fragment çš„å€¼ã€‚å¤§å®¶åªéœ€è¦çŸ¥é“jsé€šè¿‡å“åº”æµè§ˆå™¨åœ°å€æ å˜åŒ–çš„æ–¹å¼èƒ½è·å–åˆ°fragment å°±è¡Œäº†ã€‚</p>
  </li>
  <li>
    <p>ä¸€èˆ¬æ¥è¯´ï¼Œç®€åŒ–æ¨¡å¼ç”¨äºæ²¡æœ‰æœåŠ¡å™¨ç«¯çš„ç¬¬ä¸‰æ–¹å•é¡µé¢åº”ç”¨ï¼Œå› ä¸ºæ²¡æœ‰æœåŠ¡å™¨ç«¯å°±æ— æ³•æ¥æ”¶æˆæƒç ã€‚</p>
  </li>
</ul>

<h4 id="å¯†ç æ¨¡å¼">å¯†ç æ¨¡å¼</h4>

<p><img src="https://i.loli.net/2020/02/22/ptuUb1yeXoTw7nL.png" alt="image.png" /></p>

<ul>
  <li>
    <p><strong>ï¼ˆ1ï¼‰èµ„æºæ‹¥æœ‰è€…å°†ç”¨æˆ·åã€å¯†ç å‘é€ç»™å®¢æˆ·ç«¯</strong></p>
  </li>
  <li>
    <p><strong>ï¼ˆ2ï¼‰å®¢æˆ·ç«¯æ‹¿ç€èµ„æºæ‹¥æœ‰è€…çš„ç”¨æˆ·åã€å¯†ç å‘æˆæƒæœåŠ¡å™¨è¯·æ±‚ä»¤ç‰Œï¼ˆaccess_tokenï¼‰</strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/uaa/oauth/token?client_id=c1&amp;client_secret=secret&amp;grant_type=password&amp;username=shangsan&amp;password=123
</code></pre></div>    </div>

    <p>å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

    <ul>
      <li>client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚</li>
      <li>client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚</li>
      <li>grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™passwordè¡¨ç¤ºå¯†ç æ¨¡å¼</li>
      <li>usernameï¼šèµ„æºæ‹¥æœ‰è€…ç”¨æˆ·åã€‚</li>
      <li>passwordï¼šèµ„æºæ‹¥æœ‰è€…å¯†ç ã€‚</li>
    </ul>
  </li>
  <li>
    <p><strong>ï¼ˆ3ï¼‰æˆæƒæœåŠ¡å™¨å°†ä»¤ç‰Œï¼ˆaccess_tokenï¼‰å‘é€ç»™client</strong></p>
  </li>
  <li>
    <p>è¿™ç§æ¨¡å¼ååˆ†ç®€å•ï¼Œä½†æ˜¯å´æ„å‘³ç€ç›´æ¥å°†ç”¨æˆ·æ•æ„Ÿä¿¡æ¯æ³„æ¼ç»™äº†clientï¼Œå› æ­¤è¿™å°±è¯´æ˜è¿™ç§æ¨¡å¼åªèƒ½ç”¨äºclientæ˜¯æˆ‘ä»¬è‡ªå·±å¼€å‘çš„æƒ…å†µä¸‹ã€‚å› æ­¤å¯†ç æ¨¡å¼ä¸€èˆ¬ç”¨äºæˆ‘ä»¬è‡ªå·±å¼€å‘çš„ï¼Œç¬¬ä¸€æ–¹åŸç”ŸAppæˆ–ç¬¬ä¸€æ–¹å•é¡µé¢åº”ç”¨ã€‚</p>
  </li>
</ul>

<h4 id="å®¢æˆ·ç«¯æ¨¡å¼">å®¢æˆ·ç«¯æ¨¡å¼</h4>

<p><img src="https://i.loli.net/2020/02/22/XdovzaUsS5TlKMO.png" alt="image.png" /></p>

<ul>
  <li>
    <p><strong>ï¼ˆ1ï¼‰å®¢æˆ·ç«¯å‘æˆæƒæœåŠ¡å™¨å‘é€è‡ªå·±çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶è¯·æ±‚ä»¤ç‰Œï¼ˆaccess_tokenï¼‰</strong></p>
  </li>
  <li>
    <p><strong>ï¼ˆ2ï¼‰ç¡®è®¤å®¢æˆ·ç«¯èº«ä»½æ— è¯¯åï¼Œå°†ä»¤ç‰Œï¼ˆaccess_tokenï¼‰å‘é€ç»™client</strong></p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/uaa/oauth/token?client_id=c1&amp;client_secret=secret&amp;grant_type=client_credentials
</code></pre></div>    </div>

    <p>å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

    <ul>
      <li>client_idï¼šå®¢æˆ·ç«¯å‡†å…¥æ ‡è¯†ã€‚</li>
      <li>client_secretï¼šå®¢æˆ·ç«¯ç§˜é’¥ã€‚</li>
      <li>grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™client_credentialsè¡¨ç¤ºå®¢æˆ·ç«¯æ¨¡å¼</li>
    </ul>
  </li>
  <li>
    <p>è¿™ç§æ¨¡å¼æ˜¯æœ€æ–¹ä¾¿ä½†æœ€ä¸å®‰å…¨çš„æ¨¡å¼ã€‚å› æ­¤è¿™å°±è¦æ±‚æˆ‘ä»¬å¯¹clientå®Œå…¨çš„ä¿¡ä»»ï¼Œè€Œclientæœ¬èº«ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚å› æ­¤è¿™ç§æ¨¡å¼ä¸€èˆ¬ç”¨æ¥æä¾›ç»™æˆ‘ä»¬å®Œå…¨ä¿¡ä»»çš„æœåŠ¡å™¨ç«¯æœåŠ¡ã€‚æ¯”å¦‚ï¼Œåˆä½œæ–¹ç³»ç»Ÿå¯¹æ¥ï¼Œæ‹‰å–ä¸€ç»„ç”¨æˆ·ä¿¡æ¯ã€‚</p>
  </li>
</ul>

<h4 id="èµ„æºæœåŠ¡å™¨é…ç½®">èµ„æºæœåŠ¡å™¨é…ç½®</h4>

<ul>
  <li>
    <p>æœ¬é¡¹ç›®ä¸­çš„orderé¡¹ç›®å°±æ˜¯ä¸€ä¸ªèµ„æºæœåŠ¡å™¨</p>
  </li>
  <li>@EnableResourceServer æ³¨è§£åˆ°ä¸€ä¸ª @Configuration é…ç½®ç±»ä¸Šï¼Œå¹¶ä¸”å¿…é¡»ä½¿ç”¨ ResourceServerConfigurer è¿™ä¸ªé…ç½®å¯¹è±¡æ¥è¿›è¡Œé…ç½®ï¼ˆå¯ä»¥é€‰æ‹©ç»§æ‰¿è‡ª ResourceServerConfigurerAdapter ç„¶åè¦†å†™å…¶ä¸­çš„æ–¹æ³•ï¼Œå‚æ•°å°±æ˜¯è¿™ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼‰</li>
  <li>ResourceServerSecurityConfigurerä¸­ä¸»è¦åŒ…æ‹¬ï¼š
    <ul>
      <li>tokenServicesï¼šResourceServerTokenServices ç±»çš„å®ä¾‹ï¼Œç”¨æ¥å®ç°ä»¤ç‰ŒæœåŠ¡ã€‚</li>
      <li>tokenStoreï¼šTokenStoreç±»çš„å®ä¾‹ï¼ŒæŒ‡å®šä»¤ç‰Œå¦‚ä½•è®¿é—®ï¼Œä¸tokenServicesé…ç½®å¯é€‰</li>
      <li>resourceIdï¼šè¿™ä¸ªèµ„æºæœåŠ¡çš„IDï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯é€‰çš„ï¼Œä½†æ˜¯æ¨èè®¾ç½®å¹¶åœ¨æˆæƒæœåŠ¡ä¸­è¿›è¡ŒéªŒè¯ã€‚</li>
      <li>å…¶ä»–çš„æ‹“å±•å±æ€§ä¾‹å¦‚ tokenExtractor ä»¤ç‰Œæå–å™¨ç”¨æ¥æå–è¯·æ±‚ä¸­çš„ä»¤ç‰Œã€‚</li>
    </ul>
  </li>
  <li>HttpSecurityé…ç½®è¿™ä¸ªä¸Spring Securityç±»ä¼¼ï¼š
    <ul>
      <li>è¯·æ±‚åŒ¹é…å™¨ï¼Œç”¨æ¥è®¾ç½®éœ€è¦è¿›è¡Œä¿æŠ¤çš„èµ„æºè·¯å¾„ï¼Œé»˜è®¤çš„æƒ…å†µä¸‹æ˜¯ä¿æŠ¤èµ„æºæœåŠ¡çš„å…¨éƒ¨è·¯å¾„ã€‚</li>
      <li>é€šè¿‡http.authorizeRequests()æ¥è®¾ç½®å—ä¿æŠ¤èµ„æºçš„è®¿é—®è§„åˆ™</li>
      <li>å…¶ä»–çš„è‡ªå®šä¹‰æƒé™ä¿æŠ¤è§„åˆ™é€šè¿‡ HttpSecurity æ¥è¿›è¡Œé…ç½®ã€‚</li>
    </ul>
  </li>
  <li>@EnableResourceServer æ³¨è§£è‡ªåŠ¨å¢åŠ äº†ä¸€ä¸ªç±»å‹ä¸º OAuth2AuthenticationProcessingFilter çš„è¿‡æ»¤å™¨é“¾</li>
  <li>åœ¨orderé¡¹ç›®ä¸­ç¼–å†™ResouceServerConfigï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableResourceServer</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResouceServerConfig</span> <span class="kd">extends</span>
        <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RESOURCE_ID</span> <span class="o">=</span> <span class="s">"res1"</span><span class="o">;</span> 

   
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">resources</span><span class="o">.</span><span class="na">resourceId</span><span class="o">(</span><span class="no">RESOURCE_ID</span><span class="o">)</span> <span class="c1">//èµ„æºid</span>
                <span class="o">.</span><span class="na">tokenServices</span><span class="o">(</span><span class="n">tokenService</span><span class="o">())</span> <span class="c1">//éªŒè¯ä»¤ç‰Œçš„æœåŠ¡</span>
                <span class="o">.</span><span class="na">stateless</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"#oauth2.hasScope('all')"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                 <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="éªŒè¯token">éªŒè¯token</h5>

<ul>
  <li>ResourceServerTokenServices æ˜¯ç»„æˆæˆæƒæœåŠ¡çš„å¦ä¸€åŠï¼Œå¦‚æœä½ çš„æˆæƒæœåŠ¡å’Œèµ„æºæœåŠ¡åœ¨åŒä¸€ä¸ªåº”ç”¨ç¨‹åºä¸Šçš„è¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ DefaultTokenServices ï¼Œè¿™æ ·çš„è¯ï¼Œä½ å°±ä¸ç”¨è€ƒè™‘å…³äºå®ç°æ‰€æœ‰å¿…è¦çš„æ¥å£çš„ä¸€è‡´æ€§é—®é¢˜ã€‚å¦‚æœä½ çš„èµ„æºæœåŠ¡å™¨æ˜¯åˆ†ç¦»å¼€çš„ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»è¦ç¡®ä¿èƒ½å¤Ÿæœ‰åŒ¹é…æˆæƒæœåŠ¡æä¾›çš„ ResourceServerTokenServicesï¼Œå®ƒçŸ¥é“å¦‚ä½•å¯¹ä»¤ç‰Œè¿›è¡Œè§£ç ã€‚</li>
  <li>ä»¤ç‰Œè§£ææ–¹æ³•ï¼š ä½¿ç”¨ DefaultTokenServices åœ¨èµ„æºæœåŠ¡å™¨æœ¬åœ°é…ç½®ä»¤ç‰Œå­˜å‚¨ã€è§£ç ã€è§£ææ–¹å¼ ä½¿ç”¨ RemoteTokenServices èµ„æºæœåŠ¡å™¨é€šè¿‡ HTTP è¯·æ±‚æ¥è§£ç ä»¤ç‰Œï¼Œæ¯æ¬¡éƒ½è¯·æ±‚æˆæƒæœåŠ¡å™¨ç«¯ç‚¹ /oauth/check_token</li>
  <li>ä½¿ç”¨<strong>æˆæƒæœåŠ¡</strong>çš„ /oauth/check_token ç«¯ç‚¹ä½ éœ€è¦åœ¨æˆæƒæœåŠ¡å°†è¿™ä¸ªç«¯ç‚¹æš´éœ²å‡ºå»ï¼Œä»¥ä¾¿èµ„æºæœåŠ¡å¯ä»¥è¿›è¡Œè®¿é—®ï¼Œè¿™åœ¨å’±ä»¬æˆæƒæœåŠ¡é…ç½®ä¸­å·²ç»æåˆ°äº†ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­,åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åœ¨æˆæƒæœåŠ¡ä¸­é…ç½®äº† /oauth/check_token å’Œ /oauth/token_key è¿™ä¸¤ä¸ªç«¯ç‚¹ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">security</span>
				<span class="o">.</span><span class="na">tokenKeyAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span><span class="c1">// /oauth/token_key å®‰å…¨é…ç½®</span>
				<span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span> <span class="c1">// /oauth/check_token å®‰å…¨é…ç½®</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>åœ¨<strong>èµ„æºæœåŠ¡</strong>é…ç½®RemoteTokenServices ï¼Œåœ¨ResouceServerConfigä¸­é…ç½®ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//èµ„æºæœåŠ¡ä»¤ç‰Œè§£ææœåŠ¡</span>
<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ResourceServerTokenServices</span> <span class="nf">tokenService</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//ä½¿ç”¨è¿œç¨‹æœåŠ¡è¯·æ±‚æˆæƒæœåŠ¡å™¨æ ¡éªŒtoken,å¿…é¡»æŒ‡å®šæ ¡éªŒtoken çš„urlã€client_idï¼Œclient_secret</span>
    <span class="nc">RemoteTokenServices</span> <span class="n">service</span><span class="o">=</span><span class="k">new</span> <span class="nc">RemoteTokenServices</span><span class="o">();</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setCheckTokenEndpointUrl</span><span class="o">(</span><span class="s">"http://localhost:53020/uaa/oauth/check_token"</span><span class="o">);</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setClientId</span><span class="o">(</span><span class="s">"c1"</span><span class="o">);</span>
    <span class="n">service</span><span class="o">.</span><span class="na">setClientSecret</span><span class="o">(</span><span class="s">"secret"</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
<span class="o">}</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">resources</span><span class="o">.</span><span class="na">resourceId</span><span class="o">(</span><span class="no">RESOURCE_ID</span><span class="o">)</span>
		<span class="o">.</span><span class="na">tokenServices</span><span class="o">(</span><span class="n">tokenService</span><span class="o">())</span>
		<span class="o">.</span><span class="na">stateless</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h5 id="ç¼–å†™èµ„æº">ç¼–å†™èµ„æº</h5>

<ul>
  <li>åœ¨controlleråŒ…ä¸‹ç¼–å†™OrderControllerï¼Œæ­¤controllerè¡¨ç¤ºè®¢å•èµ„æºçš„è®¿é—®ç±»ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r1"</span><span class="o">)</span>
    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAnyAuthority('p1')"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">r1</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">"è®¿é—®èµ„æº1"</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h5 id="æ·»åŠ å®‰å…¨è®¿é—®æ§åˆ¶">æ·»åŠ å®‰å…¨è®¿é—®æ§åˆ¶</h5>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">securedEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>


    <span class="c1">//å®‰å…¨æ‹¦æˆªæœºåˆ¶ï¼ˆæœ€é‡è¦ï¼‰</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="n">http</span><span class="o">.</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
<span class="c1">//                .antMatchers("/r/r1").hasAuthority("p2")</span>
<span class="c1">//                .antMatchers("/r/r2").hasAuthority("p2")</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/r/**"</span><span class="o">).</span><span class="na">authenticated</span><span class="o">()</span><span class="c1">//æ‰€æœ‰/r/**çš„è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡</span>
                <span class="o">.</span><span class="na">anyRequest</span><span class="o">().</span><span class="na">permitAll</span><span class="o">()</span><span class="c1">//é™¤äº†/r/**ï¼Œå…¶å®ƒçš„è¯·æ±‚å¯ä»¥è®¿é—®</span>
                <span class="o">;</span>


    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="æµ‹è¯•oauthæˆæƒè®¤è¯">æµ‹è¯•OAuthæˆæƒè®¤è¯</h4>

<ul>
  <li>
    <p>1ã€ç”³è¯·ä»¤ç‰Œ</p>

    <ul>
      <li>ä½¿ç”¨å¯†ç æ¨¡å¼ç”³è¯·ä»¤ç‰Œï¼Œå“åº”ç»“æœä¸º</li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "access_token": "e3360db3-2d85-41c9-ac5e-b9adba48e26c",
    "token_type": "bearer",
    "expires_in": 7199,
    "scope": "all"
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>2ã€è¯·æ±‚èµ„æº</p>

    <ul>
      <li>
        <p>æŒ‰ç…§oauth2.0åè®®è¦æ±‚ï¼Œè¯·æ±‚èµ„æºéœ€è¦æºå¸¦tokenï¼Œtokençš„å‚æ•°åç§°ä¸ºï¼šAuthorizationï¼Œå€¼ä¸ºï¼šBearer tokenå€¼</p>

        <p><img src="https://i.loli.net/2020/02/22/bOodjmfJeT2AIwl.png" alt="image.png" /></p>
      </li>
      <li>
        <p>å¦‚æœtokené”™è¯¯ï¼Œåˆ™æˆæƒå¤±è´¥ï¼Œå¦‚ä¸‹ï¼š</p>
      </li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "error": "invalid_token",
    "error_description": "f3360db3-2d85-41c9-ac5e-b9adba48e26c"
}
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="jwtä»¤ç‰Œ">JWTä»¤ç‰Œ</h3>

<h4 id="ä»‹ç»-1">ä»‹ç»</h4>

<ul>
  <li>
    <p>å½“èµ„æºæœåŠ¡å’ŒæˆæƒæœåŠ¡ä¸åœ¨ä¸€èµ·æ—¶èµ„æºæœåŠ¡ä½¿ç”¨RemoteTokenServices è¿œç¨‹è¯·æ±‚æˆæƒæœåŠ¡éªŒè¯tokenï¼Œå¦‚æœè®¿é—®é‡è¾ƒå¤§å°†ä¼šå½±å“ç³»ç»Ÿçš„æ€§èƒ½ ã€‚</p>
  </li>
  <li>
    <p>ä»¤ç‰Œé‡‡ç”¨JWTæ ¼å¼å³å¯è§£å†³ä¸Šè¾¹çš„é—®é¢˜ï¼Œç”¨æˆ·è®¤è¯é€šè¿‡ä¼šå¾—åˆ°ä¸€ä¸ªJWTä»¤ç‰Œï¼ŒJWTä»¤ç‰Œä¸­å·²ç»åŒ…æ‹¬äº†ç”¨æˆ·ç›¸å…³çš„ä¿¡æ¯ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æºå¸¦JWTè®¿é—®èµ„æºæœåŠ¡ï¼Œèµ„æºæœåŠ¡æ ¹æ®äº‹å…ˆçº¦å®šçš„ç®—æ³•è‡ªè¡Œå®Œæˆä»¤ç‰Œæ ¡éªŒï¼Œæ— éœ€æ¯æ¬¡éƒ½è¯·æ±‚è®¤è¯æœåŠ¡å®Œæˆæˆæƒã€‚</p>
  </li>
  <li>
    <p>JSON Web Tokenï¼ˆJWTï¼‰æ˜¯ä¸€ä¸ªå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ï¼ˆRFC 7519ï¼‰ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ç®€ä»‹çš„ã€è‡ªåŒ…å«çš„åè®®æ ¼å¼ï¼Œç”¨äºåœ¨é€šä¿¡åŒæ–¹ä¼ é€’jsonå¯¹è±¡ï¼Œä¼ é€’çš„ä¿¡æ¯ç»è¿‡æ•°å­—ç­¾åå¯ä»¥è¢«éªŒè¯å’Œä¿¡ä»»ã€‚JWTå¯ä»¥ä½¿ç”¨HMACç®—æ³•æˆ–ä½¿ç”¨RSAçš„å…¬é’¥/ç§é’¥å¯¹æ¥ç­¾åï¼Œé˜²æ­¢è¢«ç¯¡æ”¹ã€‚</p>
  </li>
  <li>
    <p>JWTä»¤ç‰Œçš„ä¼˜ç‚¹ï¼š</p>

    <p>1ï¼‰jwtåŸºäºjsonï¼Œéå¸¸æ–¹ä¾¿è§£æã€‚</p>

    <p>2ï¼‰å¯ä»¥åœ¨ä»¤ç‰Œä¸­è‡ªå®šä¹‰ä¸°å¯Œçš„å†…å®¹ï¼Œæ˜“æ‰©å±•ã€‚</p>

    <p>3ï¼‰é€šè¿‡éå¯¹ç§°åŠ å¯†ç®—æ³•åŠæ•°å­—ç­¾åæŠ€æœ¯ï¼ŒJWTé˜²æ­¢ç¯¡æ”¹ï¼Œå®‰å…¨æ€§é«˜ã€‚</p>

    <p>4ï¼‰èµ„æºæœåŠ¡ä½¿ç”¨JWTå¯ä¸ä¾èµ–è®¤è¯æœåŠ¡å³å¯å®Œæˆæˆæƒã€‚</p>
  </li>
  <li>
    <p>ç¼ºç‚¹ï¼š</p>

    <p>ï¼‘ï¼‰JWTä»¤ç‰Œè¾ƒé•¿ï¼Œå å­˜å‚¨ç©ºé—´æ¯”è¾ƒå¤§ã€‚</p>
  </li>
  <li>
    <p>JWTä»¤ç‰Œç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œæ¯éƒ¨åˆ†ä¸­é—´ä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰åˆ†éš”ï¼Œæ¯”å¦‚ï¼šxxxxx.yyyyy.zzzzz</p>
  </li>
  <li>
    <p>Headerï¼š</p>

    <p>å¤´éƒ¨åŒ…æ‹¬ä»¤ç‰Œçš„ç±»å‹ï¼ˆå³JWTï¼‰åŠä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ï¼ˆå¦‚HMAC SHA256æˆ–RSAï¼‰</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "alg": "HS256",
    "typ": "JWT"
}
</code></pre></div>    </div>

    <p>å°†ä¸Šè¾¹çš„å†…å®¹ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>
  </li>
  <li>
    <p>Payload:</p>

    <p>ç¬¬äºŒéƒ¨åˆ†æ˜¯è´Ÿè½½ï¼Œå†…å®¹ä¹Ÿæ˜¯ä¸€ä¸ªjsonå¯¹è±¡ï¼Œå®ƒæ˜¯å­˜æ”¾æœ‰æ•ˆä¿¡æ¯çš„åœ°æ–¹ï¼Œå®ƒå¯ä»¥å­˜æ”¾jwtæä¾›çš„ç°æˆå­—æ®µï¼Œæ¯”å¦‚ï¼šissï¼ˆç­¾å‘è€…ï¼‰,expï¼ˆè¿‡æœŸæ—¶é—´æˆ³ï¼‰, subï¼ˆé¢å‘çš„ç”¨æˆ·ï¼‰ç­‰ï¼Œä¹Ÿå¯è‡ªå®šä¹‰å­—æ®µã€‚</p>

    <p>æ­¤éƒ¨åˆ†ä¸å»ºè®®å­˜æ”¾æ•æ„Ÿä¿¡æ¯ï¼Œå› ä¸ºæ­¤éƒ¨åˆ†å¯ä»¥è§£ç è¿˜åŸåŸå§‹å†…å®¹ã€‚</p>

    <p>æœ€åå°†ç¬¬äºŒéƒ¨åˆ†è´Ÿè½½ä½¿ç”¨Base64Urlç¼–ç ï¼Œå¾—åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²å°±æ˜¯JWTä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "sub": "1234567890",
    "name": "456",
    "admin": true
}
</code></pre></div>    </div>
  </li>
  <li>
    <p>Signature:</p>

    <p>ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾åï¼Œæ­¤éƒ¨åˆ†ç”¨äºé˜²æ­¢jwtå†…å®¹è¢«ç¯¡æ”¹ã€‚</p>

    <p>è¿™ä¸ªéƒ¨åˆ†ä½¿ç”¨base64urlå°†å‰ä¸¤éƒ¨åˆ†è¿›è¡Œç¼–ç ï¼Œç¼–ç åä½¿ç”¨ç‚¹ï¼ˆ.ï¼‰è¿æ¥ç»„æˆå­—ç¬¦ä¸²ï¼Œæœ€åä½¿ç”¨headerä¸­å£°æ˜ç­¾åç®—æ³•è¿›è¡Œç­¾åã€‚</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HMACSHA256(
    base64UrlEncode(header) + "." +
    base64UrlEncode(payload),
    secret)
</code></pre></div>    </div>

    <p>base64UrlEncode(header)ï¼šjwtä»¤ç‰Œçš„ç¬¬ä¸€éƒ¨åˆ†ã€‚</p>

    <p>base64UrlEncode(payload)ï¼šjwtä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†ã€‚</p>

    <p>secretï¼šç­¾åæ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚</p>
  </li>
</ul>

<h4 id="é…ç½®ä»¤ç‰ŒæœåŠ¡">é…ç½®ä»¤ç‰ŒæœåŠ¡</h4>

<ul>
  <li>åœ¨uaaä¸­é…ç½®jwtä»¤ç‰ŒæœåŠ¡ï¼Œå³å¯å®ç°ç”Ÿæˆjwtæ ¼å¼çš„ä»¤ç‰Œã€‚</li>
  <li>1ã€TokenConfig</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenConfig</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">String</span> <span class="no">SIGNING_KEY</span> <span class="o">=</span> <span class="s">"uaa123"</span><span class="o">;</span> <span class="c1">//å¯¹ç§°åŠ å¯†å­—ç¬¦ä¸²ï¼Œåœ¨æˆæƒæœåŠ¡å’Œèµ„æºæœåŠ¡ä¸­è¦ä¿æŒä¸€è‡´</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TokenStore</span> <span class="nf">tokenStore</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//JWTä»¤ç‰Œå­˜å‚¨æ–¹æ¡ˆ</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JwtTokenStore</span><span class="o">(</span><span class="n">accessTokenConverter</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JwtAccessTokenConverter</span> <span class="nf">accessTokenConverter</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JwtAccessTokenConverter</span><span class="o">();</span>
        <span class="n">converter</span><span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="no">SIGNING_KEY</span><span class="o">);</span> <span class="c1">//å¯¹ç§°ç§˜é’¥ï¼Œèµ„æºæœåŠ¡å™¨ä½¿ç”¨è¯¥ç§˜é’¥æ¥éªŒè¯</span>
        <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>2ã€å®šä¹‰JWTä»¤ç‰ŒæœåŠ¡ï¼šAuthorizationServeré…ç½®ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Autowired</span>
<span class="kd">private</span> <span class="nc">JwtAccessTokenConverter</span> <span class="n">accessTokenConverter</span><span class="o">;</span>

 <span class="nd">@Bean</span>
 <span class="kd">public</span> <span class="nc">AuthorizationServerTokenServices</span> <span class="nf">tokenService</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">DefaultTokenServices</span> <span class="n">service</span><span class="o">=</span><span class="k">new</span> <span class="nc">DefaultTokenServices</span><span class="o">();</span>
      <span class="n">service</span><span class="o">.</span><span class="na">setClientDetailsService</span><span class="o">(</span><span class="n">clientDetailsService</span><span class="o">);</span>
      <span class="n">service</span><span class="o">.</span><span class="na">setSupportRefreshToken</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
      <span class="n">service</span><span class="o">.</span><span class="na">setTokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">);</span>

     <span class="c1">//ä»¤ç‰Œå¢å¼º</span>
<span class="nc">TokenEnhancerChain</span> <span class="n">tokenEnhancerChain</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TokenEnhancerChain</span><span class="o">();</span>
<span class="n">tokenEnhancerChain</span><span class="o">.</span><span class="na">setTokenEnhancers</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">accessTokenConverter</span><span class="o">));</span>
<span class="n">service</span><span class="o">.</span><span class="na">setTokenEnhancer</span><span class="o">(</span><span class="n">tokenEnhancerChain</span><span class="o">);</span>

      <span class="n">service</span><span class="o">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="o">(</span><span class="mi">7200</span><span class="o">);</span> <span class="c1">// ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶</span>
      <span class="n">service</span><span class="o">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="o">(</span><span class="mi">259200</span><span class="o">);</span> <span class="c1">// åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤©</span>
      <span class="k">return</span> <span class="n">service</span><span class="o">;</span>
  <span class="o">}</span>
</code></pre></div></div>

<h4 id="ç”Ÿæˆjwtä»¤ç‰Œ">ç”ŸæˆJWTä»¤ç‰Œ</h4>

<p><img src="https://i.postimg.cc/hGPKMCCd/image.png" alt="" /></p>

<h4 id="æ ¡éªŒjwtä»¤ç‰Œ">æ ¡éªŒJWTä»¤ç‰Œ</h4>

<ul>
  <li>èµ„æºæœåŠ¡éœ€è¦å’ŒæˆæƒæœåŠ¡æ‹¥æœ‰ä¸€è‡´çš„ç­¾å­—ã€ä»¤ç‰ŒæœåŠ¡ç­‰ï¼š</li>
  <li>1ã€å°†æˆæƒæœåŠ¡ä¸­çš„TokenConfigç±»æ‹·è´åˆ°èµ„æº æœåŠ¡ä¸­</li>
  <li>2ã€å±è”½èµ„æº æœåŠ¡åŸæ¥çš„ä»¤ç‰ŒæœåŠ¡ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableResourceServer</span>
<span class="nd">@EnableGlobalMethodSecurity</span><span class="o">(</span><span class="n">prePostEnabled</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResouceServerConfig</span> <span class="kd">extends</span>
        <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RESOURCE_ID</span> <span class="o">=</span> <span class="s">"res1"</span><span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">resources</span><span class="o">.</span><span class="na">resourceId</span><span class="o">(</span><span class="no">RESOURCE_ID</span><span class="o">)</span>
                <span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">)</span> <span class="c1">//é‡‡ç”¨JWTä»¤ç‰Œæ¨¡å¼</span>
                <span class="o">.</span><span class="na">stateless</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h4 id="æµ‹è¯•">æµ‹è¯•</h4>

<ul>
  <li>1ï¼‰ç”³è¯·jwtä»¤ç‰Œ</li>
  <li>2ï¼‰ä½¿ç”¨ä»¤ç‰Œè¯·æ±‚èµ„æº</li>
</ul>

<p><img src="https://i.postimg.cc/SNNVSCtG/image.png" alt="" /></p>

<h4 id="å®Œå–„ç¯å¢ƒé…ç½®">å®Œå–„ç¯å¢ƒé…ç½®</h4>

<ul>
  <li>
    <p>æˆªæ­¢ç›®å‰<strong>å®¢æˆ·ç«¯ä¿¡æ¯</strong>å’Œ<strong>æˆæƒç </strong>ä»ç„¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œç”Ÿäº§ç¯å¢ƒä¸­é€šè¿‡ä¼šå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œä¸‹è¾¹å®Œå–„ç¯å¢ƒçš„é…ç½®ï¼š</p>
  </li>
  <li>
    <p>åˆ›å»ºè¡¨</p>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`oauth_client_details`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`oauth_client_details`</span>  <span class="p">(</span>
  <span class="nv">`client_id`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'å®¢æˆ·ç«¯æ ‡è¯†'</span><span class="p">,</span>
  <span class="nv">`resource_ids`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'æ¥å…¥èµ„æºåˆ—è¡¨'</span><span class="p">,</span>
  <span class="nv">`client_secret`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span> <span class="k">COMMENT</span> <span class="s1">'å®¢æˆ·ç«¯ç§˜é’¥'</span><span class="p">,</span>
  <span class="nv">`scope`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`authorized_grant_types`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`web_server_redirect_uri`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`authorities`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`access_token_validity`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`refresh_token_validity`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`additional_information`</span> <span class="nb">longtext</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`create_time`</span> <span class="nb">timestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">ON</span> <span class="k">UPDATE</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
  <span class="nv">`archived`</span> <span class="nb">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`trusted`</span> <span class="nb">tinyint</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`autoapprove`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="nv">`client_id`</span><span class="p">)</span> <span class="k">USING</span> <span class="n">BTREE</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="o">=</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="o">=</span> <span class="n">utf8_general_ci</span> <span class="k">COMMENT</span> <span class="o">=</span> <span class="s1">'æ¥å…¥å®¢æˆ·ç«¯ä¿¡æ¯'</span> <span class="n">ROW_FORMAT</span> <span class="o">=</span> <span class="k">Dynamic</span><span class="p">;</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`oauth_client_details`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'c1'</span><span class="p">,</span> <span class="s1">'res1'</span><span class="p">,</span> <span class="s1">'$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm'</span><span class="p">,</span> <span class="s1">'ROLE_ADMIN,ROLE_USER,ROLE_API'</span><span class="p">,</span> <span class="s1">'client_credentials,password,authorization_code,implicit,refresh_token'</span><span class="p">,</span> <span class="s1">'http://www.baidu.com'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="mi">7200</span><span class="p">,</span> <span class="mi">259200</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'2019-09-09 16:04:28'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'false'</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`oauth_client_details`</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'c2'</span><span class="p">,</span> <span class="s1">'res2'</span><span class="p">,</span> <span class="s1">'$2a$10$NlBC84MVb7F95EXYTXwLneXgCca6/GipyWR5NHm8K0203bSQMLpvm'</span><span class="p">,</span> <span class="s1">'ROLE_API'</span><span class="p">,</span> <span class="s1">'client_credentials,password,authorization_code,implicit,refresh_token'</span><span class="p">,</span> <span class="s1">'http://www.baidu.com'</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="mi">31536000</span><span class="p">,</span> <span class="mi">2592000</span><span class="p">,</span> <span class="k">NULL</span><span class="p">,</span> <span class="s1">'2019-09-09 21:48:51'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'false'</span><span class="p">);</span>
</code></pre></div>    </div>

    <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">DROP</span> <span class="k">TABLE</span> <span class="n">IF</span> <span class="k">EXISTS</span> <span class="nv">`oauth_code`</span><span class="p">;</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="nv">`oauth_code`</span>  <span class="p">(</span>
  <span class="nv">`create_time`</span> <span class="nb">timestamp</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">CURRENT_TIMESTAMP</span><span class="p">,</span>
  <span class="nv">`code`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="n">utf8_general_ci</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="nv">`authentication`</span> <span class="nb">blob</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">INDEX</span> <span class="nv">`code_index`</span><span class="p">(</span><span class="nv">`code`</span><span class="p">)</span> <span class="k">USING</span> <span class="n">BTREE</span>
<span class="p">)</span> <span class="n">ENGINE</span> <span class="o">=</span> <span class="n">InnoDB</span> <span class="nb">CHARACTER</span> <span class="k">SET</span> <span class="o">=</span> <span class="n">utf8</span> <span class="k">COLLATE</span> <span class="o">=</span> <span class="n">utf8_general_ci</span> <span class="n">ROW_FORMAT</span> <span class="o">=</span> <span class="n">Compact</span><span class="p">;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>é…ç½®æˆæƒæœåŠ¡</p>
  </li>
  <li>
    <p><strong>ï¼ˆ1ï¼‰ä¿®æ”¹AuthorizationServerï¼š</strong>ClientDetailsServiceå’ŒAuthorizationCodeServicesä»æ•°æ®åº“è¯»å–æ•°æ®ã€‚</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="nd">@EnableAuthorizationServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthorizationServer</span> <span class="kd">extends</span>
		<span class="nc">AuthorizationServerConfigurerAdapter</span> <span class="o">{</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">JwtAccessTokenConverter</span> <span class="n">accessTokenConverter</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">ClientDetailsService</span> <span class="n">clientDetailsService</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">AuthorizationCodeServices</span> <span class="n">authorizationCodeServices</span><span class="o">;</span>

	<span class="nd">@Autowired</span>
	<span class="kd">private</span> <span class="nc">AuthenticationManager</span> <span class="n">authenticationManager</span><span class="o">;</span>

	<span class="cm">/**
	 * 1.å®¢æˆ·ç«¯è¯¦æƒ…ç›¸å…³é…ç½®
	 */</span>
	<span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">PasswordEncoder</span> <span class="nf">passwordEncoder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">BCryptPasswordEncoder</span><span class="o">();</span>
    <span class="o">}</span>
  
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">ClientDetailsService</span> <span class="nf">clientDetailsService</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span>
		<span class="nc">ClientDetailsService</span> <span class="n">clientDetailsService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JdbcClientDetailsService</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span>
		<span class="o">((</span><span class="nc">JdbcClientDetailsService</span><span class="o">)</span> <span class="n">clientDetailsService</span><span class="o">).</span><span class="na">setPasswordEncoder</span><span class="o">(</span><span class="n">passwordEncoder</span><span class="o">());</span>
		<span class="k">return</span> <span class="n">clientDetailsService</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ClientDetailsServiceConfigurer</span> <span class="n">clients</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
		<span class="n">clients</span><span class="o">.</span><span class="na">withClientDetails</span><span class="o">(</span><span class="n">clientDetailsService</span><span class="o">);</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * 2.é…ç½®ä»¤ç‰ŒæœåŠ¡(token services)
	 */</span>
	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">AuthorizationServerTokenServices</span> <span class="nf">tokenService</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">DefaultTokenServices</span> <span class="n">service</span><span class="o">=</span><span class="k">new</span> <span class="nc">DefaultTokenServices</span><span class="o">();</span>
		<span class="n">service</span><span class="o">.</span><span class="na">setClientDetailsService</span><span class="o">(</span><span class="n">clientDetailsService</span><span class="o">);</span>
		<span class="n">service</span><span class="o">.</span><span class="na">setSupportRefreshToken</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span><span class="c1">//æ”¯æŒåˆ·æ–°ä»¤ç‰Œ</span>
		<span class="n">service</span><span class="o">.</span><span class="na">setTokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">);</span> <span class="c1">//ç»‘å®štokenStore</span>

		<span class="nc">TokenEnhancerChain</span> <span class="n">tokenEnhancerChain</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TokenEnhancerChain</span><span class="o">();</span>
		<span class="n">tokenEnhancerChain</span><span class="o">.</span><span class="na">setTokenEnhancers</span><span class="o">(</span><span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">accessTokenConverter</span><span class="o">));</span>
		<span class="n">service</span><span class="o">.</span><span class="na">setTokenEnhancer</span><span class="o">(</span><span class="n">tokenEnhancerChain</span><span class="o">);</span>

		<span class="n">service</span><span class="o">.</span><span class="na">setAccessTokenValiditySeconds</span><span class="o">(</span><span class="mi">7200</span><span class="o">);</span> <span class="c1">// ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ2å°æ—¶</span>
		<span class="n">service</span><span class="o">.</span><span class="na">setRefreshTokenValiditySeconds</span><span class="o">(</span><span class="mi">259200</span><span class="o">);</span> <span class="c1">// åˆ·æ–°ä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸ3å¤©</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">;</span>
	<span class="o">}</span>


	<span class="cm">/**
	 * 3.é…ç½®ä»¤ç‰Œï¼ˆtokenï¼‰çš„è®¿é—®ç«¯ç‚¹
	 */</span>

	<span class="nd">@Bean</span>
	<span class="kd">public</span> <span class="nc">AuthorizationCodeServices</span> <span class="nf">authorizationCodeServices</span><span class="o">(</span><span class="nc">DataSource</span> <span class="n">dataSource</span><span class="o">)</span> <span class="o">{</span> 
		<span class="k">return</span> <span class="k">new</span> <span class="nf">JdbcAuthorizationCodeServices</span><span class="o">(</span><span class="n">dataSource</span><span class="o">);</span><span class="c1">//è®¾ç½®æˆæƒç æ¨¡å¼çš„æˆæƒç å¦‚ä½•å­˜å–</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerEndpointsConfigurer</span> <span class="n">endpoints</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">endpoints</span><span class="o">.</span><span class="na">authenticationManager</span><span class="o">(</span><span class="n">authenticationManager</span><span class="o">)</span>
				<span class="o">.</span><span class="na">authorizationCodeServices</span><span class="o">(</span><span class="n">authorizationCodeServices</span><span class="o">)</span>
				<span class="o">.</span><span class="na">tokenServices</span><span class="o">(</span><span class="n">tokenService</span><span class="o">())</span>
				<span class="o">.</span><span class="na">allowedTokenEndpointRequestMethods</span><span class="o">(</span><span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 4.é…ç½®ä»¤ç‰Œç«¯ç‚¹(Token Endpoint)çš„å®‰å…¨çº¦æŸ
	 */</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">AuthorizationServerSecurityConfigurer</span> <span class="n">security</span><span class="o">){</span>
		<span class="n">security</span>
				<span class="o">.</span><span class="na">tokenKeyAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">checkTokenAccess</span><span class="o">(</span><span class="s">"permitAll()"</span><span class="o">)</span>
				<span class="o">.</span><span class="na">allowFormAuthenticationForClients</span><span class="o">()</span><span class="c1">//å…è®¸è¡¨å•è®¤è¯</span>
		<span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="spring-securityå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæˆæƒ">Spring Securityå®ç°åˆ†å¸ƒå¼ç³»ç»Ÿæˆæƒ</h3>

<h4 id="éœ€æ±‚åˆ†æ">éœ€æ±‚åˆ†æ</h4>

<p><img src="https://i.postimg.cc/KvFDCjw8/image.png" alt="" /></p>

<ul>
  <li>1ã€UAAè®¤è¯æœåŠ¡è´Ÿè´£è®¤è¯æˆæƒã€‚</li>
  <li>2ã€æ‰€æœ‰è¯·æ±‚ç»è¿‡ ç½‘å…³åˆ°è¾¾å¾®æœåŠ¡</li>
  <li>3ã€ç½‘å…³è´Ÿè´£é‰´æƒå®¢æˆ·ç«¯ä»¥åŠè¯·æ±‚è½¬å‘</li>
  <li>4ã€ç½‘å…³å°†tokenè§£æåä¼ ç»™å¾®æœåŠ¡ï¼Œå¾®æœåŠ¡è¿›è¡Œæˆæƒã€‚</li>
</ul>

<h4 id="æ³¨å†Œä¸­å¿ƒ">æ³¨å†Œä¸­å¿ƒ</h4>

<ul>
  <li>æ‰€æœ‰å¾®æœåŠ¡çš„è¯·æ±‚éƒ½ç»è¿‡ç½‘å…³ï¼Œç½‘å…³ä»æ³¨å†Œä¸­å¿ƒè¯»å–å¾®æœåŠ¡çš„åœ°å€ï¼Œå°†è¯·æ±‚è½¬å‘è‡³å¾®æœåŠ¡ã€‚</li>
  <li>æœ¬èŠ‚å®Œæˆæ³¨å†Œä¸­å¿ƒçš„æ­å»ºï¼Œæ³¨å†Œä¸­å¿ƒé‡‡ç”¨Eurekaã€‚</li>
  <li>1ã€åˆ›å»ºmavenå·¥ç¨‹</li>
</ul>

<p><img src="https://i.postimg.cc/hvhCQYDm/image.png" alt="image.png" /></p>

<ul>
  <li>2ã€pom.xmlä¾èµ–å¦‚ä¸‹</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>distributed-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>distributed-security-discovery<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<ul>
  <li>3ã€é…ç½®æ–‡ä»¶:åœ¨resourcesä¸­é…ç½®application.yml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
    <span class="na">application</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">distributed-discovery</span>

<span class="na">server</span><span class="pi">:</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">53000</span> <span class="c1">#å¯åŠ¨ç«¯å£</span>

<span class="na">eureka</span><span class="pi">:</span>
  <span class="na">server</span><span class="pi">:</span>
    <span class="na">enable-self-preservation</span><span class="pi">:</span> <span class="no">false</span>    <span class="c1">#å…³é—­æœåŠ¡å™¨è‡ªæˆ‘ä¿æŠ¤ï¼Œå®¢æˆ·ç«¯å¿ƒè·³æ£€æµ‹15åˆ†é’Ÿå†…é”™è¯¯è¾¾åˆ°80%æœåŠ¡ä¼šä¿æŠ¤ï¼Œå¯¼è‡´åˆ«äººè¿˜è®¤ä¸ºæ˜¯å¥½ç”¨çš„æœåŠ¡</span>
    <span class="na">eviction-interval-timer-in-ms</span><span class="pi">:</span> <span class="m">10000</span> <span class="c1">#æ¸…ç†é—´éš”ï¼ˆå•ä½æ¯«ç§’ï¼Œé»˜è®¤æ˜¯60*1000ï¼‰5ç§’å°†å®¢æˆ·ç«¯å‰”é™¤çš„æœåŠ¡åœ¨æœåŠ¡æ³¨å†Œåˆ—è¡¨ä¸­å‰”é™¤# </span>
    <span class="na">shouldUseReadOnlyResponseCache</span><span class="pi">:</span> <span class="no">true</span> <span class="c1">#eurekaæ˜¯CAPç†è®ºç§åŸºäºAPç­–ç•¥ï¼Œä¸ºäº†ä¿è¯å¼ºä¸€è‡´æ€§å…³é—­æ­¤åˆ‡æ¢CP é»˜è®¤ä¸å…³é—­ falseå…³é—­</span>
  <span class="na">client</span><span class="pi">:</span> 
    <span class="na">register-with-eureka</span><span class="pi">:</span> <span class="no">false</span>  <span class="c1">#false:ä¸ä½œä¸ºä¸€ä¸ªå®¢æˆ·ç«¯æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒ</span>
    <span class="na">fetch-registry</span><span class="pi">:</span> <span class="no">false</span>      <span class="c1">#ä¸ºtrueæ—¶ï¼Œå¯ä»¥å¯åŠ¨ï¼Œä½†æŠ¥å¼‚å¸¸ï¼šCannot execute request on any known server</span>
    <span class="na">instance-info-replication-interval-seconds</span><span class="pi">:</span> <span class="s">10</span> 
    <span class="na">serviceUrl</span><span class="pi">:</span> 
      <span class="na">defaultZone</span><span class="pi">:</span> <span class="s">http://localhost:${server.port}/eureka/</span>
  <span class="na">instance</span><span class="pi">:</span>
    <span class="na">hostname</span><span class="pi">:</span> <span class="s">${spring.cloud.client.ip-address}</span>
    <span class="na">prefer-ip-address</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">instance-id</span><span class="pi">:</span> <span class="s">${spring.application.name}:${spring.cloud.client.ip-address}:${spring.application.instance_id:${server.port}}</span>

    
</code></pre></div></div>

<ul>
  <li>å¯åŠ¨ç±»ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.pbteach.security.distributed.discovery</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DiscoveryServer</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DiscoveryServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>

   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ç½‘å…³">ç½‘å…³</h4>

<ul>
  <li>ç½‘å…³æ•´åˆ OAuth2.0 æœ‰<strong>ä¸¤ç§æ€è·¯</strong>ï¼Œä¸€ç§æ˜¯è®¤è¯æœåŠ¡å™¨ç”Ÿæˆjwtä»¤ç‰Œ, æ‰€æœ‰è¯·æ±‚ç»Ÿä¸€åœ¨ç½‘å…³å±‚éªŒè¯ï¼Œåˆ¤æ–­æƒé™ç­‰æ“ä½œï¼›å¦ä¸€ç§æ˜¯ç”±å„èµ„æºæœåŠ¡å¤„ç†ï¼Œç½‘å…³åªåšè¯·æ±‚è½¬å‘ã€‚</li>
  <li>æˆ‘ä»¬é€‰ç”¨ç¬¬ä¸€ç§ã€‚æˆ‘ä»¬æŠŠAPIç½‘å…³ä½œä¸ºOAuth2.0çš„èµ„æºæœåŠ¡å™¨è§’è‰²ï¼Œå®ç°æ¥å…¥å®¢æˆ·ç«¯æƒé™æ‹¦æˆªã€ä»¤ç‰Œè§£æå¹¶è½¬å‘å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯(jsonToken)ç»™å¾®æœåŠ¡ï¼Œè¿™æ ·ä¸‹æ¸¸å¾®æœåŠ¡å°±ä¸éœ€è¦å…³å¿ƒä»¤ç‰Œæ ¼å¼è§£æä»¥åŠOAuth2.0ç›¸å…³æœºåˆ¶äº†ã€‚</li>
  <li>APIç½‘å…³åœ¨è®¤è¯æˆæƒä½“ç³»é‡Œä¸»è¦è´Ÿè´£ä¸¤ä»¶äº‹ï¼š
    <ul>
      <li>ï¼ˆ1ï¼‰ä½œä¸ºOAuth2.0çš„<strong>èµ„æºæœåŠ¡å™¨</strong>è§’è‰²ï¼Œå®ç°æ¥å…¥æ–¹æƒé™æ‹¦æˆªã€‚</li>
      <li>ï¼ˆ2ï¼‰ä»¤ç‰Œè§£æå¹¶è½¬å‘å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜æ–‡tokenï¼‰ç»™å¾®æœåŠ¡</li>
    </ul>
  </li>
  <li>å¾®æœåŠ¡æ‹¿åˆ°æ˜æ–‡token(æ˜æ–‡tokenä¸­åŒ…å«ç™»å½•ç”¨æˆ·çš„èº«ä»½å’Œæƒé™ä¿¡æ¯)åä¹Ÿéœ€è¦åšä¸¤ä»¶äº‹ï¼š
    <ul>
      <li>ï¼ˆ1ï¼‰ç”¨æˆ·æˆæƒæ‹¦æˆªï¼ˆçœ‹å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®è¯¥èµ„æºï¼‰</li>
      <li>ï¼ˆ2ï¼‰å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨è¿›å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼ˆæœ‰åˆ©äºåç»­ä¸šåŠ¡é€»è¾‘éšæ—¶è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼‰</li>
    </ul>
  </li>
  <li>åˆ›å»ºå·¥ç¨‹</li>
</ul>

<p><img src="https://i.postimg.cc/52mkGLR6/image.png" alt="image.png" /></p>

<ul>
  <li>1ã€pom.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>distributed-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.pbteach.security<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>distributed-security-gateway<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;dependencies&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-ribbon<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.netflix.hystrix<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hystrix-javanica<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.retry<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-retry<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-zuul<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-security<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-oauth2<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.security<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-security-jwt<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>javax.interceptor<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>javax.interceptor-api<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>fastjson<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>

</code></pre></div></div>

<ul>
  <li>2ã€é…ç½®æ–‡ä»¶:é…ç½®application.properties</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">spring.application.name</span><span class="p">=</span><span class="s">gateway-server</span>
<span class="py">server.port</span><span class="p">=</span><span class="s">53010</span>
<span class="py">spring.main.allow-bean-definition-overriding</span> <span class="p">=</span> <span class="s">true</span>

<span class="py">logging.level.root</span> <span class="p">=</span> <span class="s">info</span>
<span class="py">logging.level.org.springframework</span> <span class="p">=</span> <span class="s">info</span>

<span class="py">zuul.retryable</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">zuul.ignoredServices</span> <span class="p">=</span> <span class="s">*</span>
<span class="py">zuul.add-host-header</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">zuul.sensitiveHeaders</span> <span class="p">=</span> <span class="s">*</span>

<span class="py">zuul.routes.uaa-service.stripPrefix</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">zuul.routes.uaa-service.path</span> <span class="p">=</span> <span class="s">/uaa/**</span>

<span class="py">zuul.routes.order-service.stripPrefix</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">zuul.routes.order-service.path</span> <span class="p">=</span> <span class="s">/order/**</span>

<span class="py">eureka.client.serviceUrl.defaultZone</span> <span class="p">=</span> <span class="s">http://localhost:53000/eureka/</span>
<span class="py">eureka.instance.preferIpAddress</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">eureka.instance.instance-id</span> <span class="p">=</span> <span class="s">${spring.application.name}:${spring.cloud.client.ip-address}:${spring.application.instance_id:${server.port}}</span>
<span class="py">management.endpoints.web.exposure.include</span> <span class="p">=</span> <span class="s">refresh,health,info,env</span>

<span class="py">feign.hystrix.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">feign.compression.request.enabled</span> <span class="p">=</span> <span class="s">true</span>
<span class="err">feign.compression.request.mime-types[0]</span> <span class="err">=</span> <span class="err">text/xml</span>
<span class="err">feign.compression.request.mime-types[1]</span> <span class="err">=</span> <span class="err">application/xml</span>
<span class="err">feign.compression.request.mime-types[2]</span> <span class="err">=</span> <span class="err">application/json</span>
<span class="py">feign.compression.request.min-request-size</span> <span class="p">=</span> <span class="s">2048</span>
<span class="py">feign.compression.response.enabled</span> <span class="p">=</span> <span class="s">true</span>
</code></pre></div></div>

<ul>
  <li>ç»Ÿä¸€è®¤è¯æœåŠ¡ï¼ˆUAAï¼‰ä¸ç»Ÿä¸€ç”¨æˆ·æœåŠ¡éƒ½æ˜¯ç½‘å…³ä¸‹å¾®æœåŠ¡ï¼Œéœ€è¦åœ¨ç½‘å…³ä¸Šæ–°å¢è·¯ç”±é…ç½®ï¼š</li>
</ul>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">zuul.routes.uaa-service.stripPrefix</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">zuul.routes.uaa-service.path</span> <span class="p">=</span> <span class="s">/uaa/**</span>

<span class="py">zuul.routes.user-service.stripPrefix</span> <span class="p">=</span> <span class="s">false</span>
<span class="py">zuul.routes.user-service.path</span> <span class="p">=</span> <span class="s">/order/**</span>
</code></pre></div></div>

<ul>
  <li>ä¸Šé¢é…ç½®äº†ç½‘å…³æ¥æ”¶çš„è¯·æ±‚urlè‹¥ç¬¦åˆ/order/**è¡¨è¾¾å¼ï¼Œå°†è¢«è¢«è½¬å‘è‡³order-service(ç»Ÿä¸€ç”¨æˆ·æœåŠ¡)ã€‚</li>
  <li>å¯åŠ¨ç±»ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableZuulProxy</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GatewayServer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">GatewayServer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>tokené…ç½®ï¼š<strong>èµ„æºæœåŠ¡å™¨</strong>ç”±äºéœ€è¦éªŒè¯å¹¶è§£æä»¤ç‰Œï¼Œå¾€å¾€å¯ä»¥é€šè¿‡åœ¨æˆæƒæœåŠ¡å™¨æš´éœ²check_tokençš„Endpointæ¥å®Œæˆï¼Œè€Œæˆ‘ä»¬åœ¨æˆæƒæœåŠ¡å™¨ä½¿ç”¨çš„æ˜¯å¯¹ç§°åŠ å¯†çš„jwtï¼Œå› æ­¤çŸ¥é“å¯†é’¥å³å¯ï¼Œèµ„æºæœåŠ¡ä¸æˆæƒæœåŠ¡æœ¬å°±æ˜¯å¯¹ç§°è®¾è®¡ï¼Œé‚£æˆ‘ä»¬æŠŠæˆæƒæœåŠ¡çš„TokenConfigä¸¤ä¸ªç±»æ‹·è´è¿‡æ¥å°±è¡Œ ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.pbteach.security.distributed.gateway.config</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.TokenStore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.security.oauth2.provider.token.store.JwtTokenStore</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenConfig</span> <span class="o">{</span>


  <span class="kd">private</span> <span class="nc">String</span> <span class="no">SIGNING_KEY</span> <span class="o">=</span> <span class="s">"uaa123"</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TokenStore</span> <span class="nf">tokenStore</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JwtTokenStore</span><span class="o">(</span><span class="n">accessTokenConverter</span><span class="o">());</span>
    <span class="o">}</span>

   <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">JwtAccessTokenConverter</span> <span class="nf">accessTokenConverter</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">JwtAccessTokenConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">JwtAccessTokenConverter</span><span class="o">();</span>
        <span class="n">converter</span><span class="o">.</span><span class="na">setSigningKey</span><span class="o">(</span><span class="no">SIGNING_KEY</span><span class="o">);</span> <span class="c1">//å¯¹ç§°ç§˜é’¥ï¼Œèµ„æºæœåŠ¡å™¨ä½¿ç”¨è¯¥ç§˜é’¥æ¥è§£å¯†</span>
        <span class="k">return</span> <span class="n">converter</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>é…ç½®èµ„æºæœåŠ¡ï¼šåœ¨ResouceServerConfigä¸­å®šä¹‰èµ„æºæœåŠ¡é…ç½®ï¼Œä¸»è¦é…ç½®çš„å†…å®¹å°±æ˜¯å®šä¹‰ä¸€äº›åŒ¹é…è§„åˆ™ï¼Œæè¿°æŸä¸ªæ¥å…¥å®¢æˆ·ç«¯éœ€è¦ä»€ä¹ˆæ ·çš„æƒé™æ‰èƒ½è®¿é—®æŸä¸ªå¾®æœåŠ¡ï¼Œå¦‚ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ResouceServerConfig</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">RESOURCE_ID</span> <span class="o">=</span> <span class="s">"res1"</span><span class="o">;</span>

    <span class="cm">/**
     * ç»Ÿä¸€è®¤è¯æœåŠ¡(UAA) èµ„æºæ‹¦æˆª
     */</span>
    <span class="nd">@Configuration</span>
    <span class="nd">@EnableResourceServer</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">UAAServerConfig</span> <span class="kd">extends</span>
            <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>

        <span class="nd">@Autowired</span>
        <span class="kd">private</span> <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">){</span>
            <span class="n">resources</span><span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">).</span><span class="na">resourceId</span><span class="o">(</span><span class="no">RESOURCE_ID</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">stateless</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
            <span class="n">http</span><span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/uaa/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="cm">/**
     *  è®¢å•æœåŠ¡
     */</span>
    <span class="nd">@Configuration</span>
    <span class="nd">@EnableResourceServer</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderServerConfig</span> <span class="kd">extends</span>
        <span class="nc">ResourceServerConfigurerAdapter</span> <span class="o">{</span>
            <span class="nd">@Autowired</span>
            <span class="kd">private</span> <span class="nc">TokenStore</span> <span class="n">tokenStore</span><span class="o">;</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">ResourceServerSecurityConfigurer</span> <span class="n">resources</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">resources</span><span class="o">.</span><span class="na">tokenStore</span><span class="o">(</span><span class="n">tokenStore</span><span class="o">).</span><span class="na">resourceId</span><span class="o">(</span><span class="no">RESOURCE_ID</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">stateless</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

            <span class="n">http</span>
                    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/order/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"#oauth2.hasScope('ROLE_API')"</span><span class="o">);</span>

        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä¸Šé¢å®šä¹‰äº†ä¸¤ä¸ªå¾®æœåŠ¡çš„èµ„æºï¼Œå…¶ä¸­ï¼šUAAServerConfigæŒ‡å®šäº†è‹¥è¯·æ±‚åŒ¹é…/uaa/<strong>ç½‘å…³ä¸è¿›è¡Œæ‹¦æˆªã€‚OrderServerConfigæŒ‡å®šäº†è‹¥è¯·æ±‚åŒ¹é…/order/</strong>ï¼Œä¹Ÿå°±æ˜¯è®¿é—®ç»Ÿä¸€ç”¨æˆ·æœåŠ¡ï¼Œæ¥å…¥å®¢æˆ·ç«¯éœ€è¦æœ‰scopeä¸­åŒ…å«readï¼Œå¹¶ä¸”authorities(æƒé™)ä¸­éœ€è¦åŒ…å«ROLE_USERã€‚ç”±äºres1è¿™ä¸ªæ¥å…¥å®¢æˆ·ç«¯ï¼ŒreadåŒ…æ‹¬ROLE_ADMIN,ROLE_USER,ROLE_APIä¸‰ä¸ªæƒé™ã€‚</li>
  <li>å®‰å…¨é…ç½®ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebSecurityConfig</span> <span class="kd">extends</span> <span class="nc">WebSecurityConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="n">http</span>
                <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
                <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
                <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="è½¬å‘æ˜æ–‡token">è½¬å‘æ˜æ–‡token</h4>

<ul>
  <li>è½¬å‘æ˜æ–‡tokenç»™å¾®æœåŠ¡ï¼šé€šè¿‡Zuulè¿‡æ»¤å™¨çš„æ–¹å¼å®ç°ï¼Œç›®çš„æ˜¯è®©ä¸‹æ¸¸å¾®æœåŠ¡èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„è·å–åˆ°å½“å‰çš„ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆæ˜æ–‡tokenï¼‰</li>
  <li><strong>ï¼ˆ1ï¼‰å®ç°Zuulå‰ç½®è¿‡æ»¤å™¨ï¼Œå®Œæˆå½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯æå–ï¼Œå¹¶æ”¾å…¥è½¬å‘å¾®æœåŠ¡çš„requestä¸­</strong></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * tokenä¼ é€’æ‹¦æˆª
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AuthFilter</span> <span class="kd">extends</span> <span class="nc">ZuulFilter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">shouldFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">filterType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"pre"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">filterOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="cm">/**
         * 1.è·å–ä»¤ç‰Œå†…å®¹
         */</span>
        <span class="nc">RequestContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="nc">RequestContext</span><span class="o">.</span><span class="na">getCurrentContext</span><span class="o">();</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(!(</span><span class="n">authentication</span> <span class="k">instanceof</span> <span class="nc">OAuth2Authentication</span><span class="o">)){</span> <span class="c1">// æ— tokenè®¿é—®ç½‘å…³å†…èµ„æºçš„æƒ…å†µï¼Œç›®å‰ä»…æœ‰uuaæœåŠ¡ç›´æ¥æš´éœ²</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">OAuth2Authentication</span> <span class="n">oauth2Authentication</span>  <span class="o">=</span> <span class="o">(</span><span class="nc">OAuth2Authentication</span><span class="o">)</span><span class="n">authentication</span><span class="o">;</span>
        <span class="nc">Authentication</span> <span class="n">userAuthentication</span> <span class="o">=</span> <span class="n">oauth2Authentication</span><span class="o">.</span><span class="na">getUserAuthentication</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">userAuthentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="cm">/**
         * 2.ç»„è£…æ˜æ–‡tokenï¼Œè½¬å‘ç»™å¾®æœåŠ¡ï¼Œæ”¾å…¥headerï¼Œåç§°ä¸ºjson-token
         */</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">();</span>
        <span class="n">userAuthentication</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span><span class="n">authorities</span><span class="o">.</span><span class="na">add</span><span class="o">(((</span><span class="nc">GrantedAuthority</span><span class="o">)</span> <span class="n">s</span><span class="o">).</span><span class="na">getAuthority</span><span class="o">()));</span>

        <span class="nc">OAuth2Request</span> <span class="n">oAuth2Request</span> <span class="o">=</span> <span class="n">oauth2Authentication</span><span class="o">.</span><span class="na">getOAuth2Request</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">requestParameters</span> <span class="o">=</span> <span class="n">oAuth2Request</span><span class="o">.</span><span class="na">getRequestParameters</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">jsonToken</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;(</span><span class="n">requestParameters</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">userAuthentication</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>

            <span class="n">jsonToken</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"principal"</span><span class="o">,</span><span class="n">userAuthentication</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">jsonToken</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"authorities"</span><span class="o">,</span><span class="n">authorities</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">addZuulRequestHeader</span><span class="o">(</span><span class="s">"json-token"</span><span class="o">,</span> <span class="nc">EncryptUtil</span><span class="o">.</span><span class="na">encodeUTF8StringBase64</span><span class="o">(</span><span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">jsonToken</span><span class="o">)));</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>ï¼ˆ2ï¼‰å°†filterçº³å…¥spring å®¹å™¨ï¼š</strong>é…ç½®AuthFilter</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.pbteach.security.distributed.gateway.config</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">com.pbteach.security.distributed.gateway.filter.AuthFilter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.web.servlet.FilterRegistrationBean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.core.Ordered</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.cors.CorsConfiguration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.cors.UrlBasedCorsConfigurationSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.filter.CorsFilter</span><span class="o">;</span>


<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ZuulConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">AuthFilter</span> <span class="nf">preFileter</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">AuthFilter</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">FilterRegistrationBean</span> <span class="nf">corsFilter</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="nc">UrlBasedCorsConfigurationSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UrlBasedCorsConfigurationSource</span><span class="o">();</span>
        <span class="kd">final</span> <span class="nc">CorsConfiguration</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorsConfiguration</span><span class="o">();</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setAllowCredentials</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedOrigin</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedHeader</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">addAllowedMethod</span><span class="o">(</span><span class="s">"*"</span><span class="o">);</span>
        <span class="n">config</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">18000L</span><span class="o">);</span>
        <span class="n">source</span><span class="o">.</span><span class="na">registerCorsConfiguration</span><span class="o">(</span><span class="s">"/**"</span><span class="o">,</span> <span class="n">config</span><span class="o">);</span>
        <span class="nc">CorsFilter</span> <span class="n">corsFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CorsFilter</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
        <span class="nc">FilterRegistrationBean</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterRegistrationBean</span><span class="o">(</span><span class="n">corsFilter</span><span class="o">);</span>
        <span class="n">bean</span><span class="o">.</span><span class="na">setOrder</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª">å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª</h4>

<ul>
  <li>å½“å¾®æœåŠ¡æ”¶åˆ°æ˜æ–‡tokenæ—¶ï¼Œåº”è¯¥æ€ä¹ˆé‰´æƒæ‹¦æˆªå‘¢ï¼Ÿè‡ªå·±å®ç°ä¸€ä¸ªfilterï¼Ÿè‡ªå·±è§£ææ˜æ–‡tokenï¼Œè‡ªå·±å®šä¹‰ä¸€å¥—èµ„æºè®¿é—®ç­–ç•¥ï¼Ÿ</li>
  <li>èƒ½ä¸èƒ½é€‚é…Spring Securityå‘¢ï¼Œæ˜¯ä¸æ˜¯çªç„¶æƒ³èµ·äº†å‰é¢æˆ‘ä»¬å®ç°çš„Spring SecurityåŸºäºtokenè®¤è¯ä¾‹å­ã€‚å’±ä»¬è¿˜æ‹¿ç»Ÿä¸€ç”¨æˆ·æœåŠ¡ä½œä¸ºç½‘å…³ä¸‹æ¸¸å¾®æœåŠ¡ï¼Œå¯¹å®ƒè¿›è¡Œæ”¹é€ ï¼Œå¢åŠ <strong>å¾®æœåŠ¡ç”¨æˆ·é‰´æƒæ‹¦æˆª</strong>åŠŸèƒ½ã€‚</li>
  <li><strong>ï¼ˆ1ï¼‰å¢åŠ æµ‹è¯•èµ„æº</strong>ï¼šOrderControllerå¢åŠ ä»¥ä¸‹endpoint</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('p1')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r1"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">r1</span><span class="o">(){</span>
        <span class="nc">UserDTO</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserDTO</span><span class="o">)</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span>
         <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è®¿é—®èµ„æº1"</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@PreAuthorize</span><span class="o">(</span><span class="s">"hasAuthority('p2')"</span><span class="o">)</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/r2"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">r2</span><span class="o">(){</span><span class="c1">//é€šè¿‡Spring Security APIè·å–å½“å‰ç™»å½•ç”¨æˆ·</span>
        <span class="nc">UserDTO</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="nc">UserDTO</span><span class="o">)</span><span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">().</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="na">getUsername</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è®¿é—®èµ„æº2"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>ï¼ˆ2ï¼‰Spring Securityé…ç½®</strong>:å¼€å¯æ–¹æ³•ä¿æŠ¤ï¼Œå¹¶å¢åŠ Springé…ç½®ç­–ç•¥ï¼Œé™¤äº†/loginæ–¹æ³•ä¸å—ä¿æŠ¤(ç»Ÿä¸€è®¤è¯è¦è°ƒç”¨)ï¼Œå…¶ä»–èµ„æºå…¨éƒ¨éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">(</span><span class="nc">HttpSecurity</span> <span class="n">http</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

  <span class="n">http</span>
    <span class="o">.</span><span class="na">authorizeRequests</span><span class="o">()</span>
    <span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">access</span><span class="o">(</span><span class="s">"#oauth2.hasScope('ROLE_ADMIN')"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">and</span><span class="o">().</span><span class="na">csrf</span><span class="o">().</span><span class="na">disable</span><span class="o">()</span>
    <span class="o">.</span><span class="na">sessionManagement</span><span class="o">().</span><span class="na">sessionCreationPolicy</span><span class="o">(</span><span class="nc">SessionCreationPolicy</span><span class="o">.</span><span class="na">STATELESS</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç»¼åˆä¸Šé¢çš„é…ç½®ï¼Œå’±ä»¬å…±å®šä¹‰äº†ä¸‰ä¸ªèµ„æºäº†ï¼Œæ‹¥æœ‰p1æƒé™å¯ä»¥è®¿é—®r1èµ„æºï¼Œæ‹¥æœ‰p2æƒé™å¯ä»¥è®¿é—®r2èµ„æºï¼Œåªè¦è®¤è¯é€šè¿‡å°±èƒ½è®¿é—®r3èµ„æºã€‚</li>
  <li>ï¼ˆ3ï¼‰å®šä¹‰filteræ‹¦æˆªtokenï¼Œå¹¶å½¢æˆSpring Securityçš„Authenticationå¯¹è±¡</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenAuthenticationFilter</span> <span class="kd">extends</span> <span class="nc">OncePerRequestFilter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doFilterInternal</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">httpServletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="nc">String</span> <span class="n">token</span> <span class="o">=</span> <span class="n">httpServletRequest</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">"json-token"</span><span class="o">);</span>


        <span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="c1">//1.è§£ætoken</span>
            <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="nc">EncryptUtil</span><span class="o">.</span><span class="na">decodeUTF8StringBase64</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="nc">JSONObject</span> <span class="n">userJson</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
            <span class="nc">UserDTO</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UserDTO</span><span class="o">();</span>
            <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="n">userJson</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"principal"</span><span class="o">));</span>
            <span class="nc">JSONArray</span> <span class="n">authoritiesArray</span> <span class="o">=</span> <span class="n">userJson</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"authorities"</span><span class="o">);</span>

            <span class="nc">String</span>  <span class="o">[]</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">authoritiesArray</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">authoritiesArray</span><span class="o">.</span><span class="na">size</span><span class="o">()]);</span>


            <span class="c1">//2.æ–°å»ºå¹¶å¡«å……authentication</span>
            <span class="nc">UsernamePasswordAuthenticationToken</span> <span class="n">authentication</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordAuthenticationToken</span><span class="o">(</span>
                    <span class="n">user</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="nc">AuthorityUtils</span><span class="o">.</span><span class="na">createAuthorityList</span><span class="o">(</span><span class="n">authorities</span><span class="o">));</span>
            <span class="n">authentication</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="k">new</span> <span class="nc">WebAuthenticationDetailsSource</span><span class="o">().</span><span class="na">buildDetails</span><span class="o">(</span>
                    <span class="n">httpServletRequest</span><span class="o">));</span>
            <span class="c1">//3.å°†authenticationä¿å­˜è¿›å®‰å…¨ä¸Šä¸‹æ–‡</span>
            <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">setAuthentication</span><span class="o">(</span><span class="n">authentication</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">httpServletRequest</span><span class="o">,</span> <span class="n">httpServletResponse</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ç»è¿‡ä¸Šè¾¹çš„è¿‡è™‘ å™¨ï¼Œèµ„æº æœåŠ¡ä¸­å°±å¯ä»¥æ–¹ä¾¿åˆ°çš„è·å–ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼š</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">UserDTO user = (UserDTO) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</code></p>

<ul>
  <li>
    <p>è¿˜æ˜¯ä¸‰ä¸ªæ­¥éª¤ï¼š</p>

    <p>1.è§£ætoken</p>

    <p>2.æ–°å»ºå¹¶å¡«å……authentication</p>

    <p>3.å°†authenticationä¿å­˜è¿›å®‰å…¨ä¸Šä¸‹æ–‡</p>

    <p>å‰©ä¸‹çš„äº‹å„¿å°±äº¤ç»™Spring Securityå¥½äº†</p>
  </li>
</ul>

<h4 id="é›†æˆæµ‹è¯•">é›†æˆæµ‹è¯•</h4>

<ul>
  <li>
    <p>æœ¬æ¡ˆä¾‹æµ‹è¯•è¿‡ç¨‹æè¿°ï¼š</p>

    <p>1ã€é‡‡ç”¨OAuth2.0çš„å¯†ç æ¨¡å¼ä»UAAè·å–token</p>

    <p>2ã€ä½¿ç”¨è¯¥tokené€šè¿‡ç½‘å…³è®¿é—®è®¢å•æœåŠ¡çš„æµ‹è¯•èµ„æº</p>
  </li>
  <li>
    <p>ï¼ˆ1ï¼‰<strong>è¿‡ç½‘å…³</strong>è®¿é—®uaaçš„æˆæƒåŠè·å–ä»¤ç‰Œï¼Œè·å–tokenã€‚æ³¨æ„ç«¯å£æ˜¯53010ï¼Œç½‘å…³çš„ç«¯å£ã€‚</p>

    <p>å¦‚æˆæƒendpointï¼š<code class="language-plaintext highlighter-rouge">http://localhost:53010/uaa/oauth/authorize?response_type=code&amp;client_id=c1</code></p>

    <p>ä»¤ç‰Œendpoint:<code class="language-plaintext highlighter-rouge">http://localhost:53010/uaa/oauth/token</code></p>
  </li>
  <li>
    <p>ï¼ˆ2ï¼‰ä½¿ç”¨Tokenè¿‡ç½‘å…³è®¿é—®è®¢å•æœåŠ¡ä¸­çš„r1-r2æµ‹è¯•èµ„æºè¿›è¡Œæµ‹è¯•ã€‚</p>
  </li>
  <li>
    <p>ç»“æœï¼š</p>

    <p>ä½¿ç”¨å¼ ä¸‰tokenè®¿é—®p1ï¼Œè®¿é—®æˆåŠŸ</p>

    <p>ä½¿ç”¨å¼ ä¸‰tokenè®¿é—®p2ï¼Œè®¿é—®å¤±è´¥</p>

    <p>ä½¿ç”¨æå››tokenè®¿é—®p1ï¼Œè®¿é—®å¤±è´¥</p>

    <p>ä½¿ç”¨æå››tokenè®¿é—®p2ï¼Œè®¿é—®æˆåŠŸ</p>

    <p>ç¬¦åˆé¢„æœŸç»“æœã€‚</p>
  </li>
  <li>
    <p>ï¼ˆ3ï¼‰ç ´åtokenæµ‹è¯•</p>

    <p>æ— tokenæµ‹è¯•è¿”å›å†…å®¹ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "error": "unauthorized",
    "error_description": "Full authentication is required to access this resource"
}
</code></pre></div>    </div>

    <p>ç ´åtokenæµ‹è¯•è¿”å›å†…å®¹ï¼š</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "error": "invalid_token",
    "error_description": "Cannot convert access token to JSON"
}
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="æ‰©å±•ç”¨æˆ·ä¿¡æ¯">æ‰©å±•ç”¨æˆ·ä¿¡æ¯</h4>

<ul>
  <li>
    <p>éœ€æ±‚åˆ†æï¼šç›®å‰jwtä»¤ç‰Œå­˜å‚¨äº†ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ã€æƒé™ä¿¡æ¯ï¼Œç½‘å…³å°†tokenæ˜æ–‡åŒ–è½¬å‘ç»™å¾®æœåŠ¡ä½¿ç”¨ï¼Œç›®å‰ç”¨æˆ·èº«ä»½ä¿¡æ¯ä»…åŒ…æ‹¬äº†ç”¨æˆ·çš„è´¦å·ï¼Œå¾®æœåŠ¡è¿˜éœ€è¦ç”¨æˆ·çš„IDã€æ‰‹æœºå·ç­‰é‡è¦ä¿¡æ¯ã€‚æ‰€ä»¥ï¼Œæœ¬æ¡ˆä¾‹å°†æä¾›æ‰©å±•ç”¨æˆ·ä¿¡æ¯çš„æ€è·¯å’Œæ–¹æ³•ï¼Œæ»¡è¶³å¾®æœåŠ¡ä½¿ç”¨ç”¨æˆ·ä¿¡æ¯çš„éœ€æ±‚ã€‚</p>
  </li>
  <li>
    <p>ä¸‹è¾¹åˆ†æJWTä»¤ç‰Œä¸­æ‰©å±•ç”¨æˆ·ä¿¡æ¯çš„æ–¹æ¡ˆï¼š</p>

    <p>åœ¨è®¤è¯é˜¶æ®µDaoAuthenticationProviderä¼šè°ƒç”¨UserDetailServiceæŸ¥è¯¢ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿™é‡Œæ˜¯å¯ä»¥è·å–åˆ°é½å…¨çš„ç”¨æˆ·ä¿¡æ¯çš„ã€‚ç”±äºJWTä»¤ç‰Œä¸­ç”¨æˆ·èº«ä»½ä¿¡æ¯æ¥æºäºUserDetailsï¼ŒUserDetailsä¸­ä»…å®šä¹‰äº†usernameä¸ºç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ªæ€è·¯ï¼šç¬¬ä¸€æ˜¯å¯ä»¥æ‰©å±•UserDetailsï¼Œä½¿ä¹‹åŒ…æ‹¬æ›´å¤šçš„è‡ªå®šä¹‰å±æ€§ï¼Œç¬¬äºŒä¹Ÿå¯ä»¥æ‰©å±•usernameçš„å†…å®¹ ï¼Œæ¯”å¦‚å­˜å…¥jsonæ•°æ®å†…å®¹ä½œä¸ºusernameçš„å†…å®¹ã€‚ç›¸æ¯”è¾ƒè€Œè¨€ï¼Œæ–¹æ¡ˆäºŒæ¯”è¾ƒç®€å•è¿˜ä¸ç”¨ç ´åUserDetailsçš„ç»“æ„ï¼Œæˆ‘ä»¬é‡‡ç”¨æ–¹æ¡ˆäºŒã€‚</p>
  </li>
  <li>
    <p>ä¿®æ”¹UserDetailServiceï¼šä»æ•°æ®åº“æŸ¥è¯¢åˆ°userï¼Œå°†æ•´ä½“userè½¬æˆjsonå­˜å…¥userDetailså¯¹è±¡ã€‚</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="nc">UserDetails</span> <span class="nf">loadUserByUsername</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">UsernameNotFoundException</span> <span class="o">{</span>
    <span class="c1">//ç™»å½•è´¦å·</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"username="</span><span class="o">+</span><span class="n">username</span><span class="o">);</span>
    <span class="c1">//æ ¹æ®è´¦å·å»æ•°æ®åº“æŸ¥è¯¢...</span>
    <span class="nc">UserDto</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">getUserByUsername</span><span class="o">(</span><span class="n">username</span><span class="o">);</span>
    <span class="k">if</span><span class="o">(</span><span class="n">user</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="c1">//æŸ¥è¯¢ç”¨æˆ·æƒé™</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findPermissionsByUserId</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="nc">String</span><span class="o">[]</span> <span class="n">perarray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[</span><span class="n">permissions</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
    <span class="n">permissions</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">perarray</span><span class="o">);</span>
    <span class="c1">//åˆ›å»ºuserDetails</span>
    <span class="c1">//è¿™é‡Œå°†userè½¬ä¸ºjsonï¼Œå°†æ•´ä½“userå­˜å…¥userDetails</span>
    <span class="nc">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="nc">User</span><span class="o">.</span><span class="na">withUsername</span><span class="o">(</span><span class="n">principal</span><span class="o">).</span><span class="na">password</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getPassword</span><span class="o">()).</span><span class="na">authorities</span><span class="o">(</span><span class="n">perarray</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
    <span class="k">return</span> <span class="n">userDetails</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ä¿®æ”¹èµ„æºæœåŠ¡è¿‡æ»¤å™¨ï¼šèµ„æºæœåŠ¡ä¸­çš„è¿‡è™‘ å™¨è´Ÿè´£ ä»headerä¸­è§£æjson-tokenï¼Œä»ä¸­å³å¯æ‹¿ç½‘å…³æ”¾å…¥çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œéƒ¨åˆ†å…³é”®ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">...</span>
<span class="k">if</span> <span class="o">(</span><span class="n">token</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
    <span class="c1">//1.è§£ætoken</span>
    <span class="nc">String</span> <span class="n">json</span> <span class="o">=</span> <span class="nc">EncryptUtil</span><span class="o">.</span><span class="na">decodeUTF8StringBase64</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
    <span class="nc">JSONObject</span> <span class="n">userJson</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">json</span><span class="o">);</span>
    <span class="c1">//å–å‡ºç”¨æˆ·èº«ä»½ä¿¡æ¯</span>
    <span class="nc">String</span> <span class="n">principal</span> <span class="o">=</span> <span class="n">userJson</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"principal"</span><span class="o">);</span>
    <span class="c1">//å°†jsonè½¬æˆå¯¹è±¡</span>
    <span class="nc">UserDTO</span> <span class="n">userDTO</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">principal</span><span class="o">,</span> <span class="nc">UserDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">JSONArray</span> <span class="n">authoritiesArray</span> <span class="o">=</span> <span class="n">userJson</span><span class="o">.</span><span class="na">getJSONArray</span><span class="o">(</span><span class="s">"authorities"</span><span class="o">);</span>
    <span class="o">...</span>
</code></pre></div></div>

<ul>
  <li>ä»¥ä¸Šè¿‡ç¨‹å°±å®Œæˆè‡ªå®šä¹‰ç”¨æˆ·èº«ä»½ä¿¡æ¯çš„æ–¹æ¡ˆã€‚</li>
</ul>
:ET