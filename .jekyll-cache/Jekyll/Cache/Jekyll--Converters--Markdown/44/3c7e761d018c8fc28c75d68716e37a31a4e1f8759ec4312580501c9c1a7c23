I"!¿<ul id="markdown-toc">
  <li><a href="#ä»€ä¹ˆæ˜¯juc" id="markdown-toc-ä»€ä¹ˆæ˜¯juc">ä»€ä¹ˆæ˜¯JUC</a>    <ul>
      <li><a href="#è¿›ç¨‹ä¸çº¿ç¨‹" id="markdown-toc-è¿›ç¨‹ä¸çº¿ç¨‹">è¿›ç¨‹ä¸çº¿ç¨‹</a></li>
      <li><a href="#waitä¸sleep" id="markdown-toc-waitä¸sleep">waitä¸sleep</a></li>
      <li><a href="#å¹¶å‘ä¸å¹¶è¡Œ" id="markdown-toc-å¹¶å‘ä¸å¹¶è¡Œ">å¹¶å‘ä¸å¹¶è¡Œ</a></li>
    </ul>
  </li>
  <li><a href="#äº†è§£threadlocal" id="markdown-toc-äº†è§£threadlocal">äº†è§£ThreadLocal</a>    <ul>
      <li><a href="#ä¸»è¦æ–¹æ³•" id="markdown-toc-ä¸»è¦æ–¹æ³•">ä¸»è¦æ–¹æ³•</a></li>
      <li><a href="#å†…å­˜æ³„éœ²ä¸ç©ºæŒ‡é’ˆ" id="markdown-toc-å†…å­˜æ³„éœ²ä¸ç©ºæŒ‡é’ˆ">å†…å­˜æ³„éœ²ä¸ç©ºæŒ‡é’ˆ</a></li>
    </ul>
  </li>
  <li><a href="#äº†è§£volatile" id="markdown-toc-äº†è§£volatile">äº†è§£volatile</a>    <ul>
      <li><a href="#jmm" id="markdown-toc-jmm">JMM</a></li>
      <li><a href="#åº”ç”¨åœºæ™¯" id="markdown-toc-åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</a></li>
    </ul>
  </li>
  <li><a href="#äº†è§£final" id="markdown-toc-äº†è§£final">äº†è§£final</a></li>
  <li><a href="#cas" id="markdown-toc-cas">CAS</a>    <ul>
      <li><a href="#æ¯”è¾ƒäº¤æ¢" id="markdown-toc-æ¯”è¾ƒäº¤æ¢">æ¯”è¾ƒäº¤æ¢</a></li>
      <li><a href="#åº•å±‚åŸç†" id="markdown-toc-åº•å±‚åŸç†">åº•å±‚åŸç†</a></li>
      <li><a href="#ç¼ºç‚¹" id="markdown-toc-ç¼ºç‚¹">ç¼ºç‚¹</a></li>
      <li><a href="#abaé—®é¢˜" id="markdown-toc-abaé—®é¢˜">ABAé—®é¢˜</a></li>
    </ul>
  </li>
  <li><a href="#åŸå­ç±»" id="markdown-toc-åŸå­ç±»">åŸå­ç±»</a>    <ul>
      <li><a href="#åŸºæœ¬ç±»å‹åŸå­ç±»" id="markdown-toc-åŸºæœ¬ç±»å‹åŸå­ç±»">åŸºæœ¬ç±»å‹åŸå­ç±»</a></li>
      <li><a href="#å¼•ç”¨ç±»å‹åŸå­ç±»" id="markdown-toc-å¼•ç”¨ç±»å‹åŸå­ç±»">å¼•ç”¨ç±»å‹åŸå­ç±»</a></li>
      <li><a href="#å˜é‡å‡çº§åŸå­ç±»" id="markdown-toc-å˜é‡å‡çº§åŸå­ç±»">å˜é‡å‡çº§åŸå­ç±»</a></li>
      <li><a href="#ç´¯åŠ å™¨" id="markdown-toc-ç´¯åŠ å™¨">ç´¯åŠ å™¨</a></li>
    </ul>
  </li>
  <li><a href="#é”æœºåˆ¶" id="markdown-toc-é”æœºåˆ¶">é”æœºåˆ¶</a>    <ul>
      <li><a href="#é”çš„åˆ†ç±»" id="markdown-toc-é”çš„åˆ†ç±»">é”çš„åˆ†ç±»</a></li>
      <li><a href="#ä¹è§‚é”å’Œæ‚²è§‚é”" id="markdown-toc-ä¹è§‚é”å’Œæ‚²è§‚é”">ä¹è§‚é”å’Œæ‚²è§‚é”</a></li>
      <li><a href="#å…¬å¹³ä¸éå…¬å¹³é”" id="markdown-toc-å…¬å¹³ä¸éå…¬å¹³é”">å…¬å¹³ä¸éå…¬å¹³é”</a></li>
      <li><a href="#å¯é‡å…¥å’Œéå¯é‡å…¥é”é€’å½’é”" id="markdown-toc-å¯é‡å…¥å’Œéå¯é‡å…¥é”é€’å½’é”">å¯é‡å…¥å’Œéå¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰</a></li>
      <li><a href="#è‡ªæ—‹é”" id="markdown-toc-è‡ªæ—‹é”">è‡ªæ—‹é”</a></li>
      <li><a href="#ç‹¬å å…±äº«ä¸äº’æ–¥é”" id="markdown-toc-ç‹¬å å…±äº«ä¸äº’æ–¥é”">ç‹¬å ï¼Œå…±äº«ä¸äº’æ–¥é”</a></li>
      <li><a href="#å¯ä¸­æ–­é”" id="markdown-toc-å¯ä¸­æ–­é”">å¯ä¸­æ–­é”</a></li>
      <li><a href="#é”çš„å‡é™çº§" id="markdown-toc-é”çš„å‡é™çº§">é”çš„å‡é™çº§</a></li>
      <li><a href="#é”çš„ä¼˜åŒ–" id="markdown-toc-é”çš„ä¼˜åŒ–">é”çš„ä¼˜åŒ–</a></li>
    </ul>
  </li>
  <li><a href="#lockæ¥å£" id="markdown-toc-lockæ¥å£">Lockæ¥å£</a>    <ul>
      <li><a href="#synchronized" id="markdown-toc-synchronized">synchronized</a></li>
      <li><a href="#reentrantlock" id="markdown-toc-reentrantlock">ReentrantLock</a></li>
      <li><a href="#å¯¹æ¯”" id="markdown-toc-å¯¹æ¯”">å¯¹æ¯”</a></li>
    </ul>
  </li>
  <li><a href="#çº¿ç¨‹é€šè®¯" id="markdown-toc-çº¿ç¨‹é€šè®¯">çº¿ç¨‹é€šè®¯</a>    <ul>
      <li><a href="#syncwaitnotifyå®ç°" id="markdown-toc-syncwaitnotifyå®ç°">sync+wait+notifyå®ç°</a></li>
      <li><a href="#è™šå‡å”¤é†’" id="markdown-toc-è™šå‡å”¤é†’">è™šå‡å”¤é†’</a></li>
      <li><a href="#lockconditionsignalå®ç°" id="markdown-toc-lockconditionsignalå®ç°">lock+condition+signalå®ç°</a></li>
    </ul>
  </li>
  <li><a href="#çº¿ç¨‹å…«é”" id="markdown-toc-çº¿ç¨‹å…«é”">çº¿ç¨‹å…«é”</a>    <ul>
      <li><a href="#æ­»é”" id="markdown-toc-æ­»é”">æ­»é”</a></li>
    </ul>
  </li>
  <li><a href="#é›†åˆä¸å®‰å…¨" id="markdown-toc-é›†åˆä¸å®‰å…¨">é›†åˆä¸å®‰å…¨</a>    <ul>
      <li><a href="#concurrenthashmap" id="markdown-toc-concurrenthashmap">ConcurrentHashMap</a></li>
      <li><a href="#jucå†™æ—¶å¤åˆ¶copyonwrite" id="markdown-toc-jucå†™æ—¶å¤åˆ¶copyonwrite">JUCå†™æ—¶å¤åˆ¶CopyOnWrite</a></li>
    </ul>
  </li>
  <li><a href="#callableåˆ›å»ºçº¿ç¨‹" id="markdown-toc-callableåˆ›å»ºçº¿ç¨‹">Callableåˆ›å»ºçº¿ç¨‹</a>    <ul>
      <li><a href="#futureå’Œfuturetask" id="markdown-toc-futureå’Œfuturetask">Futureå’ŒFutureTask</a></li>
    </ul>
  </li>
  <li><a href="#jucè¾…åŠ©ç±»" id="markdown-toc-jucè¾…åŠ©ç±»">JUCè¾…åŠ©ç±»</a>    <ul>
      <li><a href="#countdownlatchå‡å°‘è®¡æ•°" id="markdown-toc-countdownlatchå‡å°‘è®¡æ•°">CountDownLatchå‡å°‘è®¡æ•°</a></li>
      <li><a href="#cyclicbarrierå¾ªç¯æ …æ " id="markdown-toc-cyclicbarrierå¾ªç¯æ …æ ">CyclicBarrierå¾ªç¯æ …æ </a></li>
      <li><a href="#semaphoreä¿¡å·ç¯" id="markdown-toc-semaphoreä¿¡å·ç¯">Semaphoreä¿¡å·ç¯</a></li>
      <li><a href="#conditionæ¥å£" id="markdown-toc-conditionæ¥å£">Conditionæ¥å£</a></li>
    </ul>
  </li>
  <li><a href="#aqs" id="markdown-toc-aqs">AQS</a>    <ul>
      <li><a href="#ä¸‰è¦ç´ " id="markdown-toc-ä¸‰è¦ç´ ">ä¸‰è¦ç´ </a></li>
      <li><a href="#åœ¨countdownlatchä¸­åº”ç”¨" id="markdown-toc-åœ¨countdownlatchä¸­åº”ç”¨">åœ¨CountDownLatchä¸­åº”ç”¨</a></li>
      <li><a href="#åœ¨semaphoreä¸­åº”ç”¨" id="markdown-toc-åœ¨semaphoreä¸­åº”ç”¨">åœ¨Semaphoreä¸­åº”ç”¨</a></li>
      <li><a href="#åœ¨reentrantlockä¸­åº”ç”¨" id="markdown-toc-åœ¨reentrantlockä¸­åº”ç”¨">åœ¨ReentrantLockä¸­åº”ç”¨</a></li>
    </ul>
  </li>
  <li><a href="#jucè¯»å†™é”" id="markdown-toc-jucè¯»å†™é”">JUCè¯»å†™é”</a></li>
  <li><a href="#jucé˜»å¡é˜Ÿåˆ—" id="markdown-toc-jucé˜»å¡é˜Ÿåˆ—">JUCé˜»å¡é˜Ÿåˆ—</a>    <ul>
      <li><a href="#ç§ç±»åˆ†æ" id="markdown-toc-ç§ç±»åˆ†æ">ç§ç±»åˆ†æ</a></li>
      <li><a href="#æ ¸å¿ƒæ–¹æ³•" id="markdown-toc-æ ¸å¿ƒæ–¹æ³•">æ ¸å¿ƒæ–¹æ³•</a></li>
    </ul>
  </li>
  <li><a href="#threadpoolçº¿ç¨‹æ± " id="markdown-toc-threadpoolçº¿ç¨‹æ± ">ThreadPoolçº¿ç¨‹æ± </a>    <ul>
      <li><a href="#ä¸‰ç§å¸¸ç”¨çº¿ç¨‹æ± " id="markdown-toc-ä¸‰ç§å¸¸ç”¨çº¿ç¨‹æ± ">ä¸‰ç§å¸¸ç”¨çº¿ç¨‹æ± </a></li>
      <li><a href="#ä¸ƒå¤§å‚æ•°" id="markdown-toc-ä¸ƒå¤§å‚æ•°">ä¸ƒå¤§å‚æ•°</a></li>
      <li><a href="#åº•å±‚åŸç†-1" id="markdown-toc-åº•å±‚åŸç†-1">åº•å±‚åŸç†</a></li>
      <li><a href="#åˆç†è®¾ç½®çº¿ç¨‹æ± å‚æ•°" id="markdown-toc-åˆç†è®¾ç½®çº¿ç¨‹æ± å‚æ•°">åˆç†è®¾ç½®çº¿ç¨‹æ± å‚æ•°</a></li>
    </ul>
  </li>
  <li><a href="#java8æµå¼è®¡ç®—" id="markdown-toc-java8æµå¼è®¡ç®—">java8æµå¼è®¡ç®—</a></li>
  <li><a href="#åˆ†æ”¯åˆå¹¶æ¡†æ¶" id="markdown-toc-åˆ†æ”¯åˆå¹¶æ¡†æ¶">åˆ†æ”¯åˆå¹¶æ¡†æ¶</a></li>
  <li><a href="#å¼‚æ­¥å›è°ƒ" id="markdown-toc-å¼‚æ­¥å›è°ƒ">å¼‚æ­¥å›è°ƒ</a></li>
  <li><a href="#æ‰“é€ é«˜æ€§èƒ½ç¼“å­˜" id="markdown-toc-æ‰“é€ é«˜æ€§èƒ½ç¼“å­˜">æ‰“é€ é«˜æ€§èƒ½ç¼“å­˜</a>    <ul>
      <li><a href="#hashmap" id="markdown-toc-hashmap">HashMap</a></li>
      <li><a href="#concurrenthashmap-1" id="markdown-toc-concurrenthashmap-1">ConcurrentHashMap</a></li>
      <li><a href="#future" id="markdown-toc-future">Future</a></li>
      <li><a href="#ç¼“å­˜è¿‡æœŸ" id="markdown-toc-ç¼“å­˜è¿‡æœŸ">ç¼“å­˜è¿‡æœŸ</a></li>
    </ul>
  </li>
  <li><a href="#é¿å‘å¿…çœ‹" id="markdown-toc-é¿å‘å¿…çœ‹">é¿å‘å¿…çœ‹</a>    <ul>
      <li><a href="#1çº¿ç¨‹é‡ç”¨å¯¼è‡´ä¿¡æ¯é”™ä¹±" id="markdown-toc-1çº¿ç¨‹é‡ç”¨å¯¼è‡´ä¿¡æ¯é”™ä¹±">1çº¿ç¨‹é‡ç”¨å¯¼è‡´ä¿¡æ¯é”™ä¹±</a></li>
      <li><a href="#2ä½¿ç”¨å¹¶å‘å®‰å…¨å·¥å…·å¹¶ä¸ä¸€å®šå®‰å…¨" id="markdown-toc-2ä½¿ç”¨å¹¶å‘å®‰å…¨å·¥å…·å¹¶ä¸ä¸€å®šå®‰å…¨">2ä½¿ç”¨å¹¶å‘å®‰å…¨å·¥å…·å¹¶ä¸ä¸€å®šå®‰å…¨</a></li>
      <li><a href="#3å‘æŒ¥concurrenthashmapçœŸæ­£å®åŠ›" id="markdown-toc-3å‘æŒ¥concurrenthashmapçœŸæ­£å®åŠ›">3å‘æŒ¥concurrentHashMapçœŸæ­£å®åŠ›</a></li>
      <li><a href="#4é”™è¯¯çš„ä½¿ç”¨copyonwrite" id="markdown-toc-4é”™è¯¯çš„ä½¿ç”¨copyonwrite">4é”™è¯¯çš„ä½¿ç”¨CopyOnWrite</a></li>
      <li><a href="#5æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± " id="markdown-toc-5æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± ">5æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± </a></li>
      <li><a href="#6çº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¯å¤ç”¨çš„" id="markdown-toc-6çº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¯å¤ç”¨çš„">6çº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¯å¤ç”¨çš„</a></li>
      <li><a href="#7çº¿ç¨‹æ± çš„æ··ç”¨ç­–ç•¥" id="markdown-toc-7çº¿ç¨‹æ± çš„æ··ç”¨ç­–ç•¥">7çº¿ç¨‹æ± çš„æ··ç”¨ç­–ç•¥</a></li>
    </ul>
  </li>
</ul>
<h3 id="ä»€ä¹ˆæ˜¯juc">ä»€ä¹ˆæ˜¯JUC</h3>

<ul>
  <li>java.util.concurrentåœ¨å¹¶å‘ç¼–ç¨‹ä¸­ä½¿ç”¨çš„å·¥å…·ç±»</li>
</ul>

<h4 id="è¿›ç¨‹ä¸çº¿ç¨‹">è¿›ç¨‹ä¸çº¿ç¨‹</h4>

<ul>
  <li><strong>è¿›ç¨‹</strong>ï¼šè¿›ç¨‹æ˜¯ä¸€ä¸ªå…·æœ‰ä¸€å®š<strong>ç‹¬ç«‹åŠŸèƒ½</strong>çš„ç¨‹åºå…³äºæŸä¸ªæ•°æ®é›†åˆçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨ã€‚å®ƒæ˜¯æ“ä½œç³»ç»ŸåŠ¨æ€æ‰§è¡Œçš„åŸºæœ¬å•å…ƒï¼Œåœ¨ä¼ ç»Ÿçš„æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æ—¢æ˜¯åŸºæœ¬çš„åˆ†é…å•å…ƒï¼Œä¹Ÿæ˜¯åŸºæœ¬çš„æ‰§è¡Œå•å…ƒã€‚</li>
  <li>å¤§å››çš„æ—¶å€™å†™è®ºæ–‡ï¼Œç”¨wordå†™è®ºæ–‡ï¼ŒåŒæ—¶ç”¨QQéŸ³ä¹æ”¾éŸ³ä¹ï¼ŒåŒæ—¶ç”¨QQèŠå¤©ï¼Œå¤šä¸ªè¿›ç¨‹ã€‚</li>
  <li><strong>çº¿ç¨‹</strong>ï¼šé€šå¸¸åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­å¯ä»¥åŒ…å«è‹¥å¹²ä¸ªçº¿ç¨‹ï¼Œå½“ç„¶ä¸€ä¸ªè¿›ç¨‹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸ç„¶æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ã€‚çº¿ç¨‹å¯ä»¥åˆ©ç”¨è¿›ç¨‹æ‰€æ‹¥æœ‰çš„èµ„æºï¼Œåœ¨å¼•å…¥çº¿ç¨‹çš„æ“ä½œç³»ç»Ÿä¸­ï¼Œé€šå¸¸éƒ½æ˜¯æŠŠè¿›ç¨‹ä½œä¸ºåˆ†é…èµ„æºçš„åŸºæœ¬å•ä½ï¼Œè€ŒæŠŠçº¿ç¨‹ä½œä¸ºç‹¬ç«‹è¿è¡Œå’Œç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œç”±äºçº¿ç¨‹æ¯”è¿›ç¨‹æ›´å°ï¼ŒåŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œæ•…å¯¹å®ƒçš„è°ƒåº¦æ‰€ä»˜å‡ºçš„å¼€é”€å°±ä¼šå°å¾—å¤šï¼Œèƒ½æ›´é«˜æ•ˆçš„æé«˜ç³»ç»Ÿå¤šä¸ªç¨‹åºé—´å¹¶å‘æ‰§è¡Œçš„ç¨‹åº¦ã€‚</li>
  <li>wordå¦‚æ²¡æœ‰ä¿å­˜ï¼Œåœç”µå…³æœºï¼Œå†é€šç”µåæ‰“å¼€wordå¯ä»¥æ¢å¤ä¹‹å‰æœªä¿å­˜çš„æ–‡æ¡£ï¼Œwordä¹Ÿä¼šæ£€æŸ¥ä½ çš„æ‹¼å†™ï¼Œä¸¤ä¸ªçº¿ç¨‹ï¼šå®¹ç¾å¤‡ä»½ï¼Œè¯­æ³•æ£€æŸ¥</li>
  <li>çº¿ç¨‹çš„å‡ ç§çŠ¶æ€</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Thread</span><span class="o">.</span><span class="na">State</span>
 
 
 
<span class="kd">public</span> <span class="kd">enum</span> <span class="nc">State</span> <span class="o">{</span>
    <span class="cm">/**
     * Thread state for a thread which has not yet started.
     */</span>
    <span class="no">NEW</span><span class="o">,(</span><span class="n">æ–°å»º</span><span class="o">)</span>

    <span class="cm">/**
     * Thread state for a runnable thread.  A thread in the runnable
     * state is executing in the Java virtual machine but it may
     * be waiting for other resources from the operating system
     * such as processor.
     */</span>
    <span class="no">RUNNABLE</span><span class="o">,</span><span class="err">ï¼ˆ</span><span class="n">å‡†å¤‡å°±ç»ª</span><span class="err">ï¼‰</span>

    <span class="cm">/**
     * Thread state for a thread blocked waiting for a monitor lock.
     * A thread in the blocked state is waiting for a monitor lock
     * to enter a synchronized block/method or
     * reenter a synchronized block/method after calling
     * {@link Object#wait() Object.wait}.
     */</span>
    <span class="no">BLOCKED</span><span class="o">,</span><span class="err">ï¼ˆ</span><span class="n">é˜»å¡</span><span class="err">ï¼‰</span>

    <span class="cm">/**
     * Thread state for a waiting thread.
     * A thread is in the waiting state due to calling one of the
     * following methods:
     * &lt;ul&gt;
     *   &lt;li&gt;{@link Object#wait() Object.wait} with no timeout&lt;/li&gt;
     *   &lt;li&gt;{@link #join() Thread.join} with no timeout&lt;/li&gt;
     *   &lt;li&gt;{@link LockSupport#park() LockSupport.park}&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * &lt;p&gt;A thread in the waiting state is waiting for another thread to
     * perform a particular action.
     *
     * For example, a thread that has called &lt;tt&gt;Object.wait()&lt;/tt&gt;
     * on an object is waiting for another thread to call
     * &lt;tt&gt;Object.notify()&lt;/tt&gt; or &lt;tt&gt;Object.notifyAll()&lt;/tt&gt; on
     * that object. A thread that has called &lt;tt&gt;Thread.join()&lt;/tt&gt;
     * is waiting for a specified thread to terminate.
     */</span>
    <span class="no">WAITING</span><span class="o">,</span><span class="err">ï¼ˆ</span><span class="n">ä¸è§ä¸æ•£</span><span class="err">ï¼‰</span>

    <span class="cm">/**
     * Thread state for a waiting thread with a specified waiting time.
     * A thread is in the timed waiting state due to calling one of
     * the following methods with a specified positive waiting time:
     * &lt;ul&gt;
     *   &lt;li&gt;{@link #sleep Thread.sleep}&lt;/li&gt;
     *   &lt;li&gt;{@link Object#wait(long) Object.wait} with timeout&lt;/li&gt;
     *   &lt;li&gt;{@link #join(long) Thread.join} with timeout&lt;/li&gt;
     *   &lt;li&gt;{@link LockSupport#parkNanos LockSupport.parkNanos}&lt;/li&gt;
     *   &lt;li&gt;{@link LockSupport#parkUntil LockSupport.parkUntil}&lt;/li&gt;
     * &lt;/ul&gt;
     */</span>
    <span class="no">TIMED_WAITING</span><span class="o">,</span><span class="err">ï¼ˆ</span><span class="n">è¿‡æ—¶ä¸å€™</span><span class="err">ï¼‰</span>

    <span class="cm">/**
     * Thread state for a terminated thread.
     * The thread has completed execution.
     */</span>
    <span class="no">TERMINATED</span><span class="o">;(</span><span class="n">ç»ˆç»“</span><span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="waitä¸sleep">waitä¸sleep</h4>

<ul>
  <li>waitæ”¾å¼€æ‰‹å»ç¡ï¼Œæ”¾å¼€æ‰‹é‡Œçš„é”</li>
  <li>sleepæ¡ç´§æ‰‹å»ç¡ï¼Œé†’äº†æ‰‹é‡Œè¿˜æœ‰é”</li>
</ul>

<h4 id="å¹¶å‘ä¸å¹¶è¡Œ">å¹¶å‘ä¸å¹¶è¡Œ</h4>

<ul>
  <li>å¹¶å‘ï¼šåŒä¸€æ—¶åˆ»å¤šä¸ªçº¿ç¨‹åœ¨è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªç‚¹
    <ul>
      <li>ä¾‹å­ï¼šå°ç±³9ä»Šå¤©ä¸Šåˆ10ç‚¹ï¼Œé™é‡æŠ¢è´­ï¼Œæ˜¥è¿æŠ¢ç¥¨ï¼Œç”µå•†ç§’æ€</li>
    </ul>
  </li>
  <li>å¹¶è¡Œï¼šå¤šé¡¹å·¥ä½œä¸€èµ·æ‰§è¡Œï¼Œä¹‹åå†æ±‡æ€»
    <ul>
      <li>ä¾‹å­ï¼šæ³¡æ–¹ä¾¿é¢ï¼Œç”µæ°´å£¶çƒ§æ°´ï¼Œä¸€è¾¹æ’•è°ƒæ–™å€’å…¥æ¡¶ä¸­</li>
    </ul>
  </li>
</ul>

<h3 id="äº†è§£threadlocal">äº†è§£ThreadLocal</h3>

<ul>
  <li>
    <p>ThreadLocalMapç±»æ˜¯æ¯ä¸ªçº¿ç¨‹Threadç±»é‡Œè¾¹çš„å˜é‡ï¼Œé‡Œé¢æœ€é‡è¦çš„ä¸€ä¸ªé”®å€¼å¯¹æ•°ç»„Entry[] tableï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªmap</p>

    <p>é”®ï¼šè¿™ä¸ªThreadLocal</p>

    <p>å€¼ï¼šå®é™…éœ€è¦çš„æˆå‘˜å˜é‡ï¼Œæ¯”å¦‚useræˆ–simpleDateFormatå¯¹è±¡</p>
  </li>
  <li>
    <p>ä½¿ç”¨åœºæ™¯</p>

    <p>æ¯ä¸ªçº¿ç¨‹éœ€è¦ä¸€ä¸ªç‹¬äº«çš„å¯¹è±¡ï¼ˆé€šå¸¸æ˜¯å·¥å…·ç±»ï¼Œæ¯”å¦‚SimpleDateFormatï¼ŒRandomï¼‰</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     åˆ©ç”¨ThreadLocalï¼Œç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…è‡ªå·±çš„dateFormatå¯¹è±¡ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œé«˜æ•ˆåˆ©ç”¨å†…å­˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalNormalUsage05</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">finalI</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocalNormalUsage05</span><span class="o">().</span><span class="na">date</span><span class="o">(</span><span class="n">finalI</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
        <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
   
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">date</span><span class="o">(</span><span class="kt">int</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//å‚æ•°çš„å•ä½æ˜¯æ¯«ç§’ï¼Œä»1970.1.1 00:00:00 GMTè®¡æ—¶</span>
        <span class="nc">Date</span> <span class="n">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="o">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">seconds</span><span class="o">);</span>
<span class="c1">//        SimpleDateFormat dateFormat = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");</span>
        <span class="nc">SimpleDateFormat</span> <span class="n">dateFormat</span> <span class="o">=</span> <span class="nc">ThreadSafeFormatter</span><span class="o">.</span><span class="na">dateFormatThreadLocal2</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">dateFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">date</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">ThreadSafeFormatter</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">SimpleDateFormat</span><span class="o">&gt;</span> <span class="n">dateFormatThreadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">SimpleDateFormat</span><span class="o">&gt;()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">protected</span> <span class="nc">SimpleDateFormat</span> <span class="nf">initialValue</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
      
    <span class="c1">//java8</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">SimpleDateFormat</span><span class="o">&gt;</span> <span class="n">dateFormatThreadLocal2</span> <span class="o">=</span> <span class="nc">ThreadLocal</span>
            <span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">SimpleDateFormat</span><span class="o">(</span><span class="s">"yyyy-MM-dd HH:mm:ss"</span><span class="o">));</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>

    <p>æ¯ä¸ªçº¿ç¨‹å†…éœ€è¦ä¿å­˜å…¨å±€å˜é‡ï¼Œä¾‹å¦‚åœ¨æ‹¦æˆªå™¨ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥è®©ä¸åŒæ–¹æ³•ç›´æ¥è°ƒç”¨ï¼Œé¿å…å‚æ•°ä¼ é€’çš„éº»çƒ¦</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºThreadLocalç”¨æ³•2ï¼šé¿å…ä¼ é€’å‚æ•°çš„éº»çƒ¦
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalNormalUsage06</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Service1</span><span class="o">().</span><span class="na">process</span><span class="o">(</span><span class="s">""</span><span class="o">);</span>
   
    <span class="o">}</span>
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">Service1</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"è¶…å“¥"</span><span class="o">);</span>
        <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">holder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Service2</span><span class="o">().</span><span class="na">process</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">Service2</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">holder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="nc">ThreadSafeFormatter</span><span class="o">.</span><span class="na">dateFormatThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Service2æ‹¿åˆ°ç”¨æˆ·åï¼š"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Service3</span><span class="o">().</span><span class="na">process</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">Service3</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">holder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Service3æ‹¿åˆ°ç”¨æˆ·åï¼š"</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="nc">UserContextHolder</span><span class="o">.</span><span class="na">holder</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">UserContextHolder</span> <span class="o">{</span>
   
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">holder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>
   
   
<span class="o">}</span>
   
<span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
   
    <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
   
    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div>    </div>

    <p>â€‹</p>
  </li>
</ul>

<h4 id="ä¸»è¦æ–¹æ³•">ä¸»è¦æ–¹æ³•</h4>

<ul>
  <li>
    <p>initialValue</p>

    <p>è¯¥æ–¹æ³•ä¼šè¿”å›å½“å‰çº¿ç¨‹å¯¹åº”çš„åˆå§‹å€¼ï¼Œè¿™æ˜¯ä¸€ä¸ªå»¶è¿ŸåŠ è½½çš„æ–¹æ³•ï¼Œåªæœ‰åœ¨è°ƒç”¨getæ–¹æ³•æ—¶è§¦å‘</p>

    <p>å¦‚æœè°ƒç”¨removeæ–¹æ³•åå†è°ƒç”¨getï¼Œåˆ™å¯ä»¥å†æ¬¡è°ƒç”¨æ­¤æ–¹æ³•</p>

    <p>å¦‚æœä¸é‡å†™æ­¤æ–¹æ³•ï¼Œå°±ä¼šè¿”å›null</p>
  </li>
  <li>
    <p>setï¼šä¸ºè¿™ä¸ªçº¿ç¨‹è®¾ç½®ä¸€ä¸ªæ–°å€¼</p>
  </li>
  <li>
    <p>get</p>

    <p>å¾—åˆ°è¿™ä¸ªçº¿ç¨‹å¯¹åº”çš„value</p>

    <p>å…ˆå–å‡ºå½“å‰çº¿ç¨‹çš„ThreadLocalMapï¼Œç„¶åè°ƒç”¨map.getEntryæ–¹æ³•ï¼ŒæŠŠæœ¬ThreadLocaldçš„å¼•ç”¨ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå–å‡ºmapä¸­å±äºæœ¬ThreadLocalçš„å€¼</p>

    <p>mapä¸­çš„é”®å€¼å¯¹æ˜¯å­˜æ”¾åœ¨çº¿ç¨‹ä¸­çš„ï¼Œè€Œä¸æ˜¯åœ¨ThreadLocalä¸­</p>
  </li>
  <li>
    <p>removeï¼šåˆ é™¤çº¿ç¨‹å¯¹åº”çš„å€¼</p>
  </li>
</ul>

<h4 id="å†…å­˜æ³„éœ²ä¸ç©ºæŒ‡é’ˆ">å†…å­˜æ³„éœ²ä¸ç©ºæŒ‡é’ˆ</h4>

<ul>
  <li>
    <p>threadLocalMapçš„æ¯ä¸ªEntryéƒ½æ˜¯ä¸€ä¸ªå¯¹keyçš„å¼±å¼•ç”¨ï¼ŒåŒæ—¶æ¯ä¸ªEntryéƒ½åŒ…å«äº†ä¸€ä¸ªå¯¹valueçš„å¼ºå¼•ç”¨ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“çº¿ç¨‹ç»ˆæ­¢ï¼Œä¿å­˜åœ¨threadLocalä¸­çš„valueä¼šè¢«åƒåœ¾å›æ”¶ï¼Œå› ä¸ºæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨äº†ï¼Œä½†æ˜¯ï¼Œå¦‚æœçº¿ç¨‹ä¸ç»ˆæ­¢ï¼Œé‚£ä¹ˆkeyå¯¹åº”çš„valueå°±ä¸èƒ½è¢«å›æ”¶ï¼Œå› ä¸ºæœ‰ä»¥ä¸‹è°ƒç”¨é“¾</p>

    <p>Threadâ€”ThreadLocalMapâ€”Entryï¼ˆkeyä¸ºnullï¼‰â€”value</p>
  </li>
  <li>
    <p>JDKè€ƒè™‘åˆ°è¿™ç‚¹ï¼Œåœ¨setï¼Œremoveï¼Œrehashæ–¹æ³•ä¸­ä¼šæ‰«ækeyä¸ºnullçš„Entryï¼Œå¹¶æŠŠå¯¹åº”çš„valueä¹Ÿè®¾ç½®ä¸ºnullï¼Œè¿™æ ·valueå°±å¯ä»¥è¢«å›æ”¶äº†</p>
  </li>
  <li>
    <p>è°ƒç”¨removeæ–¹æ³•ï¼Œå°±ä¼šåˆ é™¤å¯¹åº”çš„Entryå¯¹è±¡ï¼Œå¯ä»¥é¿å…å†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥<strong>ä½¿ç”¨å®ŒThreadLocalåï¼Œåº”è¯¥è°ƒç”¨removeæ–¹æ³•ã€‚</strong></p>
  </li>
  <li>
    <p>ç©ºæŒ‡é’ˆé—®é¢˜</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     TODO
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalNPE</span> <span class="o">{</span>
 
    <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="n">longThreadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;();</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">longThreadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>
    
    <span class="c1">//è‡ªåŠ¨æ‹†ç®±å¯¼è‡´ç©ºæŒ‡é’ˆ</span>
    <span class="kd">public</span> <span class="kt">long</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">longThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ThreadLocalNPE</span> <span class="n">threadLocalNPE</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocalNPE</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocalNPE</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">threadLocalNPE</span><span class="o">.</span><span class="na">set</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">threadLocalNPE</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="äº†è§£volatile">äº†è§£volatile</h3>

<ul>
  <li>volatileæ˜¯javaè™šæ‹Ÿæœºæä¾›çš„è½»é‡çº§åŒæ­¥æœºåˆ¶</li>
  <li>volatileå¯ä»¥ä¿è¯å¯è§æ€§ï¼Œä½†æ˜¯ä¸ä¿è¯åŸå­æ€§ï¼Œè¿˜å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>
 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">volatileVisibilityDemo</span><span class="o">();</span>
        <span class="n">atomicDemo</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">atomicDemo</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åŸå­æ€§æµ‹è¯•"</span><span class="o">);</span>
        <span class="nc">MyData</span> <span class="n">myData</span><span class="o">=</span><span class="k">new</span> <span class="nc">MyData</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span><span class="mi">1000</span> <span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">myData</span><span class="o">.</span><span class="na">addPlusPlus</span><span class="o">();</span>
                    <span class="n">myData</span><span class="o">.</span><span class="na">addAtomic</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">},</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">while</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">activeCount</span><span class="o">()&gt;</span><span class="mi">2</span><span class="o">){</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t int type finally number value: "</span><span class="o">+</span><span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t AtomicInteger type finally number value: "</span><span class="o">+</span><span class="n">myData</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="c1">//volatileå¯ä»¥ä¿è¯å¯è§æ€§ï¼ŒåŠæ—¶é€šçŸ¥å…¶å®ƒçº¿ç¨‹ä¸»ç‰©ç†å†…å­˜çš„å€¼å·²è¢«ä¿®æ”¹</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">volatileVisibilityDemo</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¯è§æ€§æµ‹è¯•"</span><span class="o">);</span>
        <span class="nc">MyData</span> <span class="n">myData</span><span class="o">=</span><span class="k">new</span> <span class="nc">MyData</span><span class="o">();</span><span class="c1">//èµ„æºç±»</span>
        <span class="c1">//å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ“ä½œå…±äº«æ•°æ®</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t come in"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span>
                <span class="n">myData</span><span class="o">.</span><span class="na">setTo60</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t update number value: "</span><span class="o">+</span><span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
            <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"AAA"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
 
        <span class="k">while</span> <span class="o">(</span><span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">==</span><span class="mi">0</span><span class="o">){</span>
            <span class="c1">//mainçº¿ç¨‹æŒæœ‰å…±äº«æ•°æ®çš„æ‹·è´ï¼Œä¸€ç›´ä¸º0</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t mission is over. main get number value: "</span><span class="o">+</span><span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">MyData</span><span class="o">{</span>
    <span class="kt">int</span> <span class="n">number</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
    <span class="c1">//volatile int number=0;</span>
 
    <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span><span class="o">=</span><span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTo60</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span><span class="o">=</span><span class="mi">60</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="c1">//æ­¤æ—¶numberå‰é¢å·²ç»åŠ äº†volatileï¼Œä½†æ˜¯ä¸ä¿è¯åŸå­æ€§</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPlusPlus</span><span class="o">(){</span>
        <span class="n">number</span><span class="o">++;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addAtomic</span><span class="o">(){</span>
        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="jmm">JMM</h4>

<ul>
  <li>JMM(javaå†…å­˜æ¨¡å‹java memory model)æœ¬èº«æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µ<strong>å¹¶ä¸çœŸå®å­˜åœ¨</strong>ï¼Œä»–æè¿°çš„æ˜¯ä¸€ç»„è§„èŒƒæˆ–è§„åˆ™ï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼ã€‚</li>
  <li>JMMå…³äºåŒæ­¥çš„è§„å®šï¼š
    <ul>
      <li>çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„å€¼åˆ·æ–°å›ä¸»å†…å­˜</li>
      <li>çº¿ç¨‹åŠ é”å‰ï¼Œå¿…é¡»è¯»å–ä¸»å†…å­˜çš„æœ€æ–°å€¼åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ã€‚</li>
      <li>åŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”ã€‚</li>
    </ul>
  </li>
  <li>ç”±äºJVMè¿è¡Œç¨‹åºçš„å®ä½“æ˜¯çº¿ç¨‹ï¼Œè€Œæ¯ä¸ªçº¿ç¨‹åˆ›å»ºæ—¶JVMéƒ½ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ªå·¥ä½œå†…å­˜ï¼ˆæœ‰äº›åœ°æ–¹ç§°ä¸ºæ ˆç©ºé—´ï¼‰ï¼Œå·¥ä½œå†…å­˜æ˜¯æ¯ä¸ªçº¿ç¨‹çš„ç§æœ‰æ•°æ®åŒºåŸŸï¼Œè€Œjavaå†…å­˜æ¨¡å‹ä¸­è§„å®šæ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼Œä¸»å†…å­˜æ˜¯å…±äº«å†…å­˜åŒºåŸŸï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ï¼Œä½†çº¿ç¨‹å¯¹å˜é‡çš„æ“ä½œï¼ˆè¯»å–å’Œèµ‹å€¼ç­‰ï¼‰å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œé¦–å…ˆéœ€è¦å°†å˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ç©ºé—´ï¼Œç„¶åå¯¹å˜é‡è¿›è¡Œæ“ä½œï¼Œæ“ä½œå®Œæˆåå†å°†å˜é‡å†™å›ä¸»å†…å­˜ï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œå„ä¸ªçº¿ç¨‹ä¸­çš„å·¥ä½œå†…å­˜ä¸­å­˜å‚¨ç€å†…å­˜ä¸­çš„å˜é‡å‰¯æœ¬æ‹·è´ï¼Œå› æ­¤ä¸åŒçš„çº¿ç¨‹é—´æ— æ³•è®¿é—®å¯¹æ–¹çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ å€¼ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/HY2PAsOG5UQaEhi.png" alt="image.png" /></p>

<ul>
  <li>å¯è§æ€§é—®é¢˜ï¼šå¯èƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹AAAä¿®æ”¹äº†å…±äº«å˜é‡Xçš„å€¼ä½†æœªå†™å›ä¸»å†…å­˜æ—¶ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹BBBåˆå¯¹ä¸»å†…å­˜ä¸­åŒä¸€ä¸ªå…±äº«å˜é‡Xè¿›è¡Œæ“ä½œï¼Œä½†æ­¤æ—¶AAAçº¿ç¨‹å·¥ä½œå†…å­˜ä¸­å…±äº«å˜é‡Xå¯¹çº¿ç¨‹BBBæ¥è¯´å¹¶ä¸å¯è§ï¼Œè¿™ç§å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿç°è±¡å°±é€ æˆäº†å¯è§æ€§é—®é¢˜ã€‚</li>
  <li>åŸå­æ€§ï¼šnumber++åœ¨å¤šçº¿ç¨‹ä¸‹æ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œä¸ºä½•ä¸åŠ synchronizedè§£å†³ï¼Ÿ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyData</span><span class="o">{</span>
    <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
    <span class="nc">Object</span> <span class="n">object</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addTo60</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span> <span class="o">=</span> <span class="mi">60</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addPlusPlus</span><span class="o">(){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">number</span><span class="o">++;</span>
    <span class="o">}</span>

    <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addAtomic</span><span class="o">(){</span>
        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * éªŒè¯volatileçš„å¯è§æ€§
 * 1.å½“numberæœªè¢«volatileä¿®é¥°æ—¶ï¼Œnew Threadå°†numberå€¼æ”¹ä¸º60ï¼Œä½†mainçº¿ç¨‹å¹¶ä¸çŸ¥é“ï¼Œä¼šä¸€ç›´åœ¨å¾ªç¯ä¸­å‡ºä¸æ¥
 * 2.å½“numberä½¿ç”¨volatileä¿®é¥°ï¼Œnew Threadæ”¹å˜numberå€¼åï¼Œä¼šé€šçŸ¥mainçº¿ç¨‹ä¸»å†…å­˜çš„å€¼å·²è¢«ä¿®æ”¹ï¼Œç»“æŸä»»åŠ¡ã€‚ä½“ç°äº†å¯è§æ€§
 *
 * éªŒè¯volatileä¸ä¿è¯åŸå­æ€§
 * 1.åŸå­æ€§æ˜¯æŒ‡ï¼ŒæŸä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒæŸé¡¹ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯è¢«åŠ å¡æˆ–åˆ†å‰²ï¼Œéœ€è¦æ•´ä½“å®Œæ•´ã€‚è¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥
 *
 * å¦‚ä½•è§£å†³å‘¢ï¼Ÿ
 * 1.ä½¿ç”¨synchronize
 * 2.ä½¿ç”¨AtomicInteger
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">VolatileDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//seeByVolatile();</span>
        <span class="n">atomic</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">//éªŒè¯åŸå­æ€§</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">atomic</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MyData</span> <span class="n">myData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyData</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                        <span class="cm">/*synchronized (myData.object){
                            myData.addPlusPlus();
                        }*/</span>
                        <span class="n">myData</span><span class="o">.</span><span class="na">addPlusPlus</span><span class="o">();</span>
                        <span class="n">myData</span><span class="o">.</span><span class="na">addAtomic</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">//ç­‰å¾…ä¸Šé¢20ä¸ªçº¿ç¨‹å…¨éƒ¨è®¡ç®—ç»“æŸ</span>
        <span class="k">while</span> <span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">activeCount</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">){</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">yield</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"int finally number is "</span> <span class="o">+</span> <span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"AtomicInteger finally number is "</span> <span class="o">+</span> <span class="n">myData</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//éªŒè¯å¯è§æ€§çš„æ–¹æ³•</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">seeByVolatile</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">MyData</span> <span class="n">myData</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyData</span><span class="o">();</span>
        <span class="c1">//ç¬¬ä¸€ä¸ªçº¿ç¨‹</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" come in"</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">myData</span><span class="o">.</span><span class="na">addTo60</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">" update number to "</span> <span class="o">+</span> <span class="n">myData</span><span class="o">.</span><span class="na">number</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">//ç¬¬äºŒä¸ªçº¿ç¨‹ main</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">myData</span><span class="o">.</span><span class="na">number</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>

        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"mission is over"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æœ‰åºæ€§ï¼š
    <ul>
      <li>è®¡ç®—æœºåœ¨æ‰§è¡Œç¨‹åºæ—¶ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºï¼Œä¸€èˆ¬åˆ†ä¸ºä¸‰ç§ï¼šæºä»£ç â€”ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’â€”æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’â€”å†…å­˜ç³»ç»Ÿçš„é‡æ’â€”æœ€ç»ˆæ‰§è¡Œçš„æŒ‡ä»¤</li>
      <li>å•çº¿ç¨‹ç¯å¢ƒé‡Œé¢ç¡®ä¿ç¨‹åºæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºæ‰§è¡Œçš„ç»“æœä¸€è‡´</li>
      <li>å¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶å¿…é¡»è¦è€ƒè™‘æŒ‡ä»¤ä¹‹é—´çš„<strong>æ•°æ®ä¾èµ–æ€§</strong></li>
      <li>å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œä½†ç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’çš„å­˜åœ¨ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨çš„å˜é‡èƒ½å¦ä¿è¯ä¸€è‡´æ€§æ˜¯æ— æ³•ç¡®å®šçš„ï¼Œç»“æœæ— æ³•é¢„æµ‹ã€‚</li>
    </ul>
  </li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  int x = 11;//1
  int y = 12;//2
  x = x + 5;//3
  y = x * x;//4
}
1234
2134
1324

é—®é¢˜ï¼šè¯·é—®è¯­å¥4å¯ä»¥é‡æ’åå˜æˆç¬¬ä¸€æ¡å—ï¼Ÿ
ä¸è¡Œï¼Œå› ä¸ºå­˜åœ¨æ•°æ®ä¾èµ–æ€§
</code></pre></div></div>

<p><img src="https://i.loli.net/2020/06/23/ou7gn5l2wTYxAhf.png" alt="image.png" /></p>

<ul>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReSortSeqDemo</span><span class="o">{</span>
  <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="kt">boolean</span> <span class="n">flag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method1</span><span class="o">(){</span>
    <span class="n">a</span><span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">//è¯­å¥1</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span> <span class="c1">//è¯­å¥2</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">method2</span><span class="o">(){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">flag</span><span class="o">){</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="mi">5</span><span class="o">;</span> <span class="c1">//è¯­å¥3</span>
      <span class="n">sout</span><span class="o">(</span><span class="s">"***retValue:"</span><span class="o">+</span><span class="n">a</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="c1">//çº¿ç¨‹æ“ä½œèµ„æºç±»ï¼Œçº¿ç¨‹1è®¿é—®method1ï¼Œçº¿ç¨‹2è®¿é—®method2ï¼Œæ­£å¸¸æƒ…å†µé¡ºåºæ‰§è¡Œï¼Œa=6</span>
<span class="c1">//å¤šçº¿ç¨‹ä¸‹å‡è®¾å‡ºç°äº†æŒ‡ä»¤é‡æ’ï¼Œè¯­å¥2åœ¨è¯­å¥1ä¹‹å‰ï¼Œå½“æ‰§è¡Œå®Œflag=trueåï¼Œå¦ä¸€ä¸ªçº¿ç¨‹é©¬ä¸Šæ‰§è¡Œmethod2ï¼Œa=5</span>

</code></pre></div></div>

<ul>
  <li>volatileå®ç°ç¦æ­¢æŒ‡ä»¤é‡æ’ä¼˜åŒ–ï¼Œä»è€Œé¿å…å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç¨‹åºå‡ºç°ä¹±åºæ‰§è¡Œçš„ç°è±¡ã€‚</li>
  <li>å†…å­˜å±éšœï¼ˆmemory barrierï¼‰åˆç§°ä¸ºå†…å­˜æ …æ ï¼Œæ˜¯ä¸€ä¸ªCPUæŒ‡ä»¤ï¼Œä»–çš„ä½œç”¨æœ‰ä¸¤ä¸ª
    <ul>
      <li>ä¸€æ˜¯ä¿è¯ç‰¹å®šæ“ä½œçš„æ‰§è¡Œé¡ºåº</li>
      <li>äºŒæ˜¯ä¿è¯æŸäº›å˜é‡çš„å†…å­˜å¯è§æ€§ï¼ˆåˆ©ç”¨è¯¥ç‰¹æ€§å®ç°volatileçš„å†…å­˜å¯è§æ€§ï¼‰</li>
    </ul>
  </li>
  <li>ç”±äºç¼–è¯‘å™¨å’Œå¤„ç†å™¨éƒ½èƒ½æ‰§è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–ã€‚å¦‚æœåœ¨æŒ‡ä»¤é—´æ’å…¥ä¸€æ¡å†…å­˜å±éšœåˆ™ä¼šå‘Šè¯‰ç¼–è¯‘å™¨å’ŒCPUï¼Œä¸ç®¡ä»€ä¹ˆæŒ‡ä»¤éƒ½ä¸èƒ½å’Œè¿™æ¡å†…å­˜å±éšœæŒ‡ä»¤é‡æ’åºï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´é€šè¿‡æ’å…¥å†…å­˜å±éšœç¦æ­¢åœ¨å†…å­˜å±éšœå‰åçš„æŒ‡ä»¤æ‰§è¡Œé‡æ’åºä¼˜åŒ–</strong>ã€‚å†…å­˜å±éšœå¦å¤–ä¸€ä¸ªä½œç”¨æ˜¯å¼ºåˆ¶åˆ·å‡ºå„ç§CPUçš„ç¼“å­˜æ•°æ®ï¼Œå› æ­¤ä»»ä½•CPUä¸Šçš„çº¿ç¨‹éƒ½èƒ½è¯»å–åˆ°è¿™äº›æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/PwqNGQfF4bISazd.png" alt="image.png" /></p>

<ul>
  <li>çº¿ç¨‹å®‰å…¨æ€§è·å¾—ä¿è¯ï¼š
    <ul>
      <li>å·¥ä½œå†…å­˜å’Œä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿç°è±¡å¯¼è‡´çš„å¯è§æ€§é—®é¢˜å¯ä»¥ä½¿ç”¨synchronizedæˆ–volatileå…³é”®å­—è§£å†³ï¼Œä»–ä»¬éƒ½å¯ä»¥ä½¿ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹åçš„å˜é‡ç«‹å³å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚</li>
      <li>å¯¹äºæŒ‡ä»¤é‡æ’å¯¼è‡´çš„å¯è§æ€§é—®é¢˜å’Œæœ‰åºæ€§é—®é¢˜ï¼Œå¯ä»¥åˆ©ç”¨volatileå…³é”®å­—è§£å†³ï¼Œå› ä¸ºvolatileçš„å¦ä¸€ä¸ªä½œç”¨å°±æ˜¯ç¦æ­¢é‡æ’åºä¼˜åŒ–ã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="åº”ç”¨åœºæ™¯">åº”ç”¨åœºæ™¯</h4>

<ul>
  <li>å•ä¾‹æ¨¡å¼DCL</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonDemo</span> <span class="o">{</span>
    <span class="c1">//åŠ volatileç¦æ­¢æŒ‡ä»¤é‡æ’</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="nc">SingletonDemo</span> <span class="n">instance</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">SingletonDemo</span><span class="o">(){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"æ„é€ æ–¹æ³•"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//DCLåŒç«¯åŠ é”æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯åŒé‡æ£€æŸ¥é”</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">SingletonDemo</span> <span class="nf">getInstance</span><span class="o">(){</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="nc">SingletonDemo</span><span class="o">.</span><span class="na">class</span><span class="o">){</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">instance</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
                    <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SingletonDemo</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//è¿™ç§å†™æ³•åœ¨å¤šçº¿ç¨‹æ¡ä»¶ä¸‹å¯èƒ½æ­£ç¡®ç‡ä¸º99.999999%ï¼Œä½†å¯èƒ½ç”±äºæŒ‡ä»¤é‡æ’å‡ºé”™</span>
</code></pre></div></div>

<ul>
  <li>å•ä¾‹æ¨¡å¼volatileåˆ†æ
    <ul>
      <li>æŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œä¸€è‡´æ€§ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä½†å¹¶ä¸ä¼šå…³å¿ƒå¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§ã€‚</li>
      <li>å½“ä¸€æ¡çº¿ç¨‹è®¿é—®instanceä¸ä¸ºnullæ—¶ï¼Œç”±äºinstanceå®ä¾‹æœªå¿…å·²åˆå§‹åŒ–å®Œæˆï¼Œä¹Ÿå°±é€ æˆäº†çº¿ç¨‹å®‰å…¨é—®é¢˜</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/1uS25eA48HMmZQF.png" alt="image.png" /></p>

<h3 id="äº†è§£final">äº†è§£final</h3>

<ul>
  <li>å¦‚æœå¯¹è±¡åœ¨è¢«åˆ›å»ºåï¼ŒçŠ¶æ€å°±ä¸èƒ½è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆä»–å°±æ˜¯ä¸å¯å˜çš„ã€‚</li>
  <li>å…·æœ‰ä¸å˜æ€§çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹å…¶é‡‡å–ä»»ä½•é¢å¤–çš„å®‰å…¨æªæ–½ï¼Œä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>

<h3 id="cas">CAS</h3>

<ul>
  <li>æˆ‘è®¤ä¸ºVçš„å€¼åº”è¯¥æ˜¯Aï¼Œå¦‚æœæ˜¯çš„è¯å°±æŠŠä»–æ”¹æˆBï¼Œå¦‚æœä¸æ˜¯Aï¼ˆè¯´æ˜è¢«åˆ«äººä¿®æ”¹è¿‡ï¼‰ï¼Œé‚£æˆ‘å°±ä¸ä¿®æ”¹äº†ï¼Œé¿å…å¤šäººåŒæ—¶ä¿®æ”¹å¯¼è‡´å‡ºé”™</li>
  <li>CASæœ‰ä¸‰ä¸ªæ“ä½œæ•°ï¼Œå†…å­˜å€¼Vï¼Œé¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„å€¼Bã€‚ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vç›¸ç­‰æ—¶ï¼Œæ‰å°†å†…å­˜å€¼ä¿®æ”¹ä¸ºBï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œæœ€åè¿”å›ç°åœ¨çš„Vå€¼ã€‚</li>
  <li>ä½¿ç”¨åœºæ™¯ï¼šåŸå­ç±»ï¼Œå¹¶å‘å·¥å…·</li>
  <li>ä½¿ç”¨volatileæ¥ä¿®é¥°valueå­—æ®µï¼Œä¿è¯å¯è§æ€§</li>
</ul>

<h4 id="æ¯”è¾ƒäº¤æ¢">æ¯”è¾ƒäº¤æ¢</h4>

<p><img src="https://i.loli.net/2020/06/23/KwVruZXCx4ga8On.png" alt="image.png" /></p>

<p><img src="https://i.loli.net/2020/06/23/woDUg9jENMOQH7c.png" alt="image.png" /></p>

<ul>
  <li>this.getIntVolatile(var1,var2) è·å–var1è¿™ä¸ªå¯¹è±¡åœ¨var2è¿™ä¸ªåœ°å€ä¸Šçš„å€¼</li>
  <li>getandIncrement()æ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯Unsafeç±»çš„getAndAddInt()æ–¹æ³•ï¼Œåº•å±‚æ˜¯CASæ€æƒ³ï¼Œå¦‚æœæ¯”è¾ƒæˆåŠŸï¼ŒåŠ 1ï¼›å¦åˆ™ï¼Œé‡æ–°è·å¾—å†æ¯”è¾ƒï¼Œç›´è‡³æˆåŠŸ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 1.CASæ˜¯ä»€ä¹ˆï¼Ÿ  --&gt;compareAndSet
 *      æ¯”è¾ƒå¹¶äº¤æ¢
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CASDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
      <span class="c1">//æœŸæœ›ç»“æœä¸º5ï¼Œè‹¥ç¬¦åˆï¼Œæ›¿æ¢å€¼ä¸º2019</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">2019</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">2020</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="c1">//true</span>
<span class="c1">//false</span>

</code></pre></div></div>

<ul>
  <li>ç­‰ä»·ä»£ç </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¨¡æ‹ŸCASæ“ä½œï¼Œç­‰ä»·ä»£ç 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TwoThreadsCompetition</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">int</span> <span class="nf">compareAndSwap</span><span class="o">(</span><span class="kt">int</span> <span class="n">expectedValue</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">oldValue</span> <span class="o">==</span> <span class="n">expectedValue</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">newValue</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">TwoThreadsCompetition</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TwoThreadsCompetition</span><span class="o">();</span>
        <span class="n">r</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="s">"Thread 1"</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">,</span><span class="s">"Thread 2"</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">compareAndSwap</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="åº•å±‚åŸç†">åº•å±‚åŸç†</h4>

<ul>
  <li>ä»¥atomicInteger.getAndIncrement()æ¥è¯´æ˜</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">unsafe</span><span class="o">.</span><span class="na">getAndAddInt</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">valueOffset</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
<span class="o">}</span>
<span class="cm">/*
this :å½“å‰å¯¹è±¡
valueOffset :å†…å­˜åç§»é‡ï¼ˆå†…å­˜åœ°å€ï¼‰
ä¸ºä»€ä¹ˆAtomicIntegerèƒ½è§£å†³i++å¤šçº¿ç¨‹ä¸‹ä¸å®‰å…¨çš„é—®é¢˜ï¼Œé çš„å°±æ˜¯åº•å±‚çš„Unsafeç±»
*/</span>
</code></pre></div></div>

<ul>
  <li>Unsafeç±»è¯¦è§£</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/5CUwPIAOy2Wa3sq.png" alt="image.png" /></p>

<p><img src="https://i.loli.net/2020/06/23/1pZNO9wPlEStfbx.png" alt="image.png" /></p>

<ul>
  <li>unsafe.getAndAddInt</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/VKYhcvb2T3OigWd.png" alt="image.png" /></p>

<p><img src="https://i.loli.net/2020/06/23/yOnF46CiYfGu1vW.png" alt="image.png" /></p>

<p><img src="https://i.loli.net/2020/06/23/rcZlh6jGAkWpw5X.png" alt="image.png" /></p>

<ul>
  <li>å°æ€»ç»“</li>
  <li>CASï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒï¼Œç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ä¸­çš„å€¼ä¸€è‡´ä¸ºæ­¢ã€‚</li>
  <li>CASåº”ç”¨ï¼šCASæœ‰3ä¸ªæ“ä½œæ•°ï¼Œå†…å­˜å€¼Vï¼Œæ—§çš„é¢„æœŸå€¼Aï¼Œè¦ä¿®æ”¹çš„æ›´æ–°å€¼Bã€‚å½“ä¸”ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vç›¸åŒæ—¶ï¼Œå°†å†…å­˜å€¼Vä¿®æ”¹ä¸ºBï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšã€‚</li>
</ul>

<h4 id="ç¼ºç‚¹">ç¼ºç‚¹</h4>

<ul>
  <li>å¾ªç¯æ—¶é—´é•¿ï¼Œå¼€é”€å¾ˆå¤§</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/BLx1mi5HFAK74v8.png" alt="image.png" /></p>

<ul>
  <li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼šå½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œã€‚ä½†æ˜¯ï¼Œå¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”æ¥ä¿è¯åŸå­æ€§ã€‚</li>
  <li>CASä¼šå¼•èµ·ABAé—®é¢˜</li>
</ul>

<h4 id="abaé—®é¢˜">ABAé—®é¢˜</h4>

<ul>
  <li>
    <p>ABAé—®é¢˜çš„äº§ç”Ÿ</p>

    <p>CASç®—æ³•å®ç°ä¸€ä¸ªé‡è¦å‰æå°±æ˜¯éœ€è¦å–å‡ºå†…å­˜ä¸­æŸæ—¶åˆ»çš„æ•°æ®å¹¶åœ¨å½“ä¸‹æ—¶åˆ»æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ—¶é—´å·®ä¸­ä¼šå¯¼è‡´æ•°æ®çš„å˜åŒ–</p>

    <p>æ¯”å¦‚ä¸€ä¸ªçº¿ç¨‹oneä»å†…å­˜ä½ç½®Vå–å‡ºAï¼Œè¿™æ—¶å¦ä¸€ä¸ªçº¿ç¨‹twoä¹Ÿä»å†…å­˜ä¸­å–å‡ºAï¼Œå¹¶ä¸”çº¿ç¨‹twoè¿›è¡Œäº†ä¸€äº›æ“ä½œå°†å€¼å˜æˆäº†Bï¼Œç„¶åçº¿ç¨‹twoåˆå°†Vä½ç½®çš„æ•°æ®å˜æˆAï¼Œè¿™æ—¶å€™çº¿ç¨‹oneè¿›è¡ŒCASæ“ä½œå‘ç°å†…å­˜ä¸­ä¾ç„¶æ˜¯Aï¼Œç„¶åçº¿ç¨‹oneæ“ä½œæˆåŠŸã€‚</p>

    <p>å°½ç®¡çº¿ç¨‹oneçš„CASæ“ä½œæˆåŠŸï¼Œä½†æ˜¯å¹¶ä¸ä»£è¡¨è¿™ä¸ªè¿‡ç¨‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p>
  </li>
  <li>
    <p>åŸå­å¼•ç”¨ï¼šAtomicReference</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">User</span><span class="o">{</span>
    <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">age</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">,</span> <span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">age</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">age</span> <span class="o">=</span> <span class="n">age</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"User{"</span> <span class="o">+</span>
                <span class="s">"name='"</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">'\''</span> <span class="o">+</span>
                <span class="s">", age="</span> <span class="o">+</span> <span class="n">age</span> <span class="o">+</span>
                <span class="sc">'}'</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicReferenceDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">User</span> <span class="n">z3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"z3"</span><span class="o">,</span> <span class="mi">22</span><span class="o">);</span>
        <span class="nc">User</span> <span class="n">l4</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">(</span><span class="s">"l4"</span><span class="o">,</span> <span class="mi">25</span><span class="o">);</span>

        <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">atomicReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;();</span>
        <span class="n">atomicReference</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">z3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">z3</span><span class="o">,</span> <span class="n">l4</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">atomicReference</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">z3</span><span class="o">,</span> <span class="n">l4</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">atomicReference</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="c1">//true  User{name='l4', age=25}</span>
<span class="c1">//false User{name='l4', age=25}</span>

</code></pre></div></div>

<ul>
  <li>è§£å†³ABAé—®é¢˜çš„æ–¹æ³•ï¼šä½¿ç”¨æ—¶é—´æˆ³åŸå­å¼•ç”¨AtomicStampedReference</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/9aLuiZEwgOJA5IH.png" alt="image.png" /></p>

<ul>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ABAé—®é¢˜çš„è§£å†³     AtomicStampedReference
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ABADemo</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">atomicReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;(</span><span class="mi">100</span><span class="o">);</span>
    <span class="kd">static</span> <span class="nc">AtomicStampedReference</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">atomicStampedReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicStampedReference</span><span class="o">&lt;&gt;(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------ABAé—®é¢˜çš„äº§ç”Ÿ--------------------"</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t1"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">101</span><span class="o">);</span>
                <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t2"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">//çº¿ç¨‹t2ä¼‘çœ 1ç§’é’Ÿ,ç¡®ä¿t1å®Œæˆä¸€æ¬¡ABAæ“ä½œ</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">2020</span><span class="o">)</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">atomicReference</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------ABAé—®é¢˜çš„è§£å†³--------------------"</span><span class="o">);</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t3"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">//t3çº¿ç¨‹ä¼‘çœ 1ç§’ä¸­,ç¡®ä¿t4ä¹Ÿæ‹¿åˆ°åˆå§‹çš„ç‰ˆæœ¬å·</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">101</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tç¬¬äºŒæ¬¡ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
                <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">101</span><span class="o">,</span> <span class="mi">100</span><span class="o">,</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">(),</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tç¬¬ä¸‰æ¬¡ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t4"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">stamp</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">stamp</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="c1">//t4çº¿ç¨‹ä¼‘çœ 3ç§’ä¸­,ç¡®ä¿t3å®Œæˆä¸€æ¬¡ABAæ“ä½œ</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="mi">100</span><span class="o">,</span> <span class="mi">2020</span><span class="o">,</span> <span class="n">stamp</span><span class="o">,</span> <span class="n">stamp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæ˜¯å¦ä¿®æ”¹æˆåŠŸ,"</span> <span class="o">+</span> <span class="n">result</span> <span class="o">+</span> <span class="s">"\tå½“å‰æœ€æ–°å®é™…ç‰ˆæœ¬å·ï¼š"</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getStamp</span><span class="o">());</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tå½“å‰å®é™…æœ€æ–°å€¼ï¼š"</span> <span class="o">+</span> <span class="n">atomicStampedReference</span><span class="o">.</span><span class="na">getReference</span><span class="o">());</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
-----------------ABAé—®é¢˜çš„äº§ç”Ÿ--------------------
true  2020
-----------------ABAé—®é¢˜çš„è§£å†³--------------------
t3 ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·ï¼š1
t4 ç¬¬ä¸€æ¬¡ç‰ˆæœ¬å·ï¼š1
t3 ç¬¬äºŒæ¬¡ç‰ˆæœ¬å·ï¼š2
t3 ç¬¬ä¸‰æ¬¡ç‰ˆæœ¬å·ï¼š3
t4 æ˜¯å¦ä¿®æ”¹æˆåŠŸ,false å½“å‰æœ€æ–°å®é™…ç‰ˆæœ¬å·ï¼š3
t4 å½“å‰å®é™…æœ€æ–°å€¼ï¼š100
*/</span>
</code></pre></div></div>

<h3 id="åŸå­ç±»">åŸå­ç±»</h3>

<ul>
  <li>åŸå­ç±»çš„ä½œç”¨å’Œé”ç±»ä¼¼ï¼Œæ˜¯ä¸ºäº†ä¿è¯å¹¶å‘æƒ…å†µä¸‹çº¿ç¨‹å®‰å…¨ã€‚</li>
  <li>ç²’åº¦æ›´ç»†ï¼šåŸå­å˜é‡å¯ä»¥æŠŠç«äº‰èŒƒå›´ç¼©å°åˆ°å˜é‡çº§åˆ«ï¼Œé€šå¸¸é”çš„ç²’åº¦éƒ½è¦å¤§äºåŸå­å˜é‡çš„ç²’åº¦ã€‚</li>
  <li>æ•ˆç‡æ›´é«˜ï¼šä½¿ç”¨åŸå­ç±»çš„æ•ˆç‡ä¼šæ¯”ä½¿ç”¨é”çš„æ•ˆç‡æ›´é«˜ï¼Œé™¤äº†é«˜åº¦ç«äº‰çš„æƒ…å†µã€‚</li>
</ul>

<table>
  <thead>
    <tr>
      <th>åŸå­ç±»</th>
      <th>å®ç°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Atomic*åŸºæœ¬åŸå­ç±»</td>
      <td>AtomicInteger<br />AtomicLong<br />AtomicBoolean</td>
    </tr>
    <tr>
      <td>Atomic*Arrayæ•°ç»„ç±»å‹åŸå­ç±»</td>
      <td>AtomicIntegerArray<br />AtomicLongArray<br />AtomicReferenceArray</td>
    </tr>
    <tr>
      <td>Atomic*Referenceå¼•ç”¨ç±»å‹åŸå­ç±»</td>
      <td>AtomicReference<br />AtomicStampedReference<br />AtomicMarkableReference</td>
    </tr>
    <tr>
      <td>Atomic*FieldUpdaterå‡çº§ç±»å‹åŸå­ç±»</td>
      <td>AtomicIntegerFieldUpdater<br />AtomicLongFieldUpdater<br />AtomicReferenceFieldUpdater</td>
    </tr>
    <tr>
      <td>Adderç´¯åŠ å™¨</td>
      <td>LongAdder<br />DoubleAdder</td>
    </tr>
    <tr>
      <td>Accumulatorç´¯åŠ å™¨</td>
      <td>LongAccumulator<br />DoubleAccumulator</td>
    </tr>
  </tbody>
</table>

<h4 id="åŸºæœ¬ç±»å‹åŸå­ç±»">åŸºæœ¬ç±»å‹åŸå­ç±»</h4>

<ul>
  <li>ActomicIntegerä¸»è¦æ–¹æ³•ï¼š
    <ul>
      <li>public final int get()ï¼šè·å–å½“å‰çš„å€¼</li>
      <li>public final int getAndSet(int newValue)ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è®¾ç½®æ–°çš„å€¼</li>
      <li>public final int getAndIncrement()ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå¢</li>
      <li>public final int getAndDecrement()ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶è‡ªå‡</li>
      <li>public final int getAndAdd(int data)ï¼šè·å–å½“å‰çš„å€¼ï¼Œå¹¶åŠ ä¸Šé¢„æœŸçš„å€¼</li>
      <li>boolean compareAndSet(int expect,int update)ï¼šå¦‚æœå½“å‰çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥å€¼ï¼ˆupdateï¼‰</li>
    </ul>
  </li>
  <li>æ¼”ç¤ºActomicInteger</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºAtomicIntegerçš„åŸºæœ¬ç”¨æ³•ï¼Œå¯¹æ¯”éåŸå­ç±»çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½¿ç”¨äº†åŸå­ç±»ä¹‹åï¼Œä¸éœ€è¦åŠ é”ï¼Œä¹Ÿå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerDemo1</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicInteger</span><span class="o">();</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">incrementAtomic</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">atomicInteger</span><span class="o">.</span><span class="na">getAndAdd</span><span class="o">(-</span><span class="mi">90</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">basicCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">incrementBasic</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">basicCount</span><span class="o">++;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">AtomicIntegerDemo1</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicIntegerDemo1</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åŸå­ç±»çš„ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ™®é€šå˜é‡çš„ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">basicCount</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">incrementAtomic</span><span class="o">();</span>
            <span class="n">incrementBasic</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>åŸå­æ•°ç»„</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºåŸå­æ•°ç»„çš„ä½¿ç”¨æ–¹æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicArrayDemo</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">AtomicIntegerArray</span> <span class="n">atomicIntegerArray</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicIntegerArray</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="nc">Incrementer</span> <span class="n">incrementer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Incrementer</span><span class="o">(</span><span class="n">atomicIntegerArray</span><span class="o">);</span>
        <span class="nc">Decrementer</span> <span class="n">decrementer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Decrementer</span><span class="o">(</span><span class="n">atomicIntegerArray</span><span class="o">);</span>
        <span class="nc">Thread</span><span class="o">[]</span> <span class="n">threadsIncrementer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
        <span class="nc">Thread</span><span class="o">[]</span> <span class="n">threadsDecrementer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">threadsDecrementer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">decrementer</span><span class="o">);</span>
            <span class="n">threadsIncrementer</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">incrementer</span><span class="o">);</span>
            <span class="n">threadsDecrementer</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
            <span class="n">threadsIncrementer</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
 
<span class="c1">//        Thread.sleep(10000);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">threadsDecrementer</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
                <span class="n">threadsIncrementer</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">join</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
 
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
<span class="c1">//            if (atomicIntegerArray.get(i)!=0) {</span>
<span class="c1">//                System.out.println("å‘ç°äº†é”™è¯¯"+i);</span>
<span class="c1">//            }</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">atomicIntegerArray</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿è¡Œç»“æŸ"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">Decrementer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">AtomicIntegerArray</span> <span class="n">array</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">Decrementer</span><span class="o">(</span><span class="nc">AtomicIntegerArray</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">array</span><span class="o">.</span><span class="na">getAndDecrement</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">Incrementer</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">AtomicIntegerArray</span> <span class="n">array</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">Incrementer</span><span class="o">(</span><span class="nc">AtomicIntegerArray</span> <span class="n">array</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">array</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="å¼•ç”¨ç±»å‹åŸå­ç±»">å¼•ç”¨ç±»å‹åŸå­ç±»</h4>

<ul>
  <li>AtomicReferenceå¯ä»¥è®©ä¸€ä¸ªå¯¹è±¡ä¿è¯åŸå­æ€§ï¼Œç”¨æ³•å’ŒAtomicIntegerç±»ä¼¼</li>
</ul>

<h4 id="å˜é‡å‡çº§åŸå­ç±»">å˜é‡å‡çº§åŸå­ç±»</h4>

<ul>
  <li>å¶å°”éœ€è¦ä¸€ä¸ªåŸå­get-setæ“ä½œ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºAtomicIntegerFieldUpdaterçš„ç”¨æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicIntegerFieldUpdaterDemo</span> <span class="kd">implements</span> <span class="nc">Runnable</span><span class="o">{</span>
 
    <span class="kd">static</span> <span class="nc">Candidate</span> <span class="n">tom</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Candidate</span> <span class="n">peter</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">AtomicIntegerFieldUpdater</span><span class="o">&lt;</span><span class="nc">Candidate</span><span class="o">&gt;</span> <span class="n">scoreUpdater</span> <span class="o">=</span> <span class="nc">AtomicIntegerFieldUpdater</span>
            <span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span><span class="nc">Candidate</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">"score"</span><span class="o">);</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">peter</span><span class="o">.</span><span class="na">score</span><span class="o">++;</span>
            <span class="n">scoreUpdater</span><span class="o">.</span><span class="na">getAndIncrement</span><span class="o">(</span><span class="n">tom</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Candidate</span> <span class="o">{</span>
 
        <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">score</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">tom</span><span class="o">=</span><span class="k">new</span> <span class="nc">Candidate</span><span class="o">();</span>
        <span class="n">peter</span><span class="o">=</span><span class="k">new</span> <span class="nc">Candidate</span><span class="o">();</span>
        <span class="nc">AtomicIntegerFieldUpdaterDemo</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicIntegerFieldUpdaterDemo</span><span class="o">();</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ™®é€šå˜é‡ï¼š"</span><span class="o">+</span><span class="n">peter</span><span class="o">.</span><span class="na">score</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡çº§åçš„ç»“æœ"</span><span class="o">+</span> <span class="n">tom</span><span class="o">.</span><span class="na">score</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ç´¯åŠ å™¨">ç´¯åŠ å™¨</h4>

<ul>
  <li>
    <p>é«˜å¹¶å‘ä¸‹LongAdderæ¯”AtomicIntegeræ•ˆç‡é«˜ï¼Œæœ¬è´¨æ˜¯ç©ºé—´æ¢æ—¶é—´</p>
  </li>
  <li>
    <p>ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼ŒLongAdderæŠŠä¸åŒçº¿ç¨‹å¯¹åº”åˆ°ä¸åŒçš„Cellä¸Šè¿›è¡Œä¿®æ”¹ï¼Œé™ä½äº†å†²çªçš„æ¦‚ç‡ï¼Œæ˜¯å¤šæ®µé”çš„æ¦‚å¿µï¼Œæé«˜äº†å¹¶å‘æ€§ã€‚</p>
  </li>
  <li>
    <p>AtomicIntegerçš„å®ç°åŸç†æ˜¯æ¯ä¸€æ¬¡åŠ æ³•éƒ½éœ€è¦åšåŒæ­¥ï¼Œæ‰€ä»¥åœ¨é«˜å¹¶å‘æ—¶ä¼šå¯¼è‡´å†²çªæ¯”è¾ƒå¤šï¼Œé™ä½äº†æ•ˆç‡</p>
  </li>
  <li>
    <p>LongAdderï¼Œæ¯ä¸ªçº¿ç¨‹ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„è®¡æ•°å™¨ï¼Œä»…ç”¨æ¥åœ¨è‡ªå·±çº¿ç¨‹å†…è®¡æ•°ï¼Œè¿™æ ·ä¸€æ¥å°±ä¸ä¼šå’Œå…¶ä»–çº¿ç¨‹çš„è®¡æ•°å™¨å¹²æ‰°</p>
  </li>
  <li>
    <p>LongAdderå¼•å…¥åˆ†æ®µç´¯åŠ æ¦‚å¿µï¼Œå†…éƒ¨æœ‰ä¸€ä¸ªbaseå˜é‡å’Œä¸€ä¸ªCell[]æ•°ç»„å…±åŒå‚ä¸è®¡æ•°</p>

    <p>baseå˜é‡ï¼šç«äº‰ä¸æ¿€çƒˆï¼Œç›´æ¥ç´¯åŠ åˆ°è¯¥å˜é‡ä¸Š</p>

    <p>Cellæ•°ç»„ï¼šç«äº‰æ¿€çƒˆï¼Œå„ä¸ªçº¿ç¨‹åˆ†æ•£ç´¯åŠ åˆ°è‡ªå·±çš„æ§½Cell[i]ä¸­</p>
  </li>
  <li>
    <p>LongAdderé€‚ç”¨äºç»Ÿè®¡æ±‚å’Œè®¡æ•°çš„åœºæ™¯</p>
  </li>
  <li>
    <p>AtomicLong</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒLongAdderæ¯”AtomicLongæ€§èƒ½å¥½
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AtomicLongDemo</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">AtomicLong</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">counter</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">service</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">service</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
 
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"AtomicLongè€—æ—¶ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">));</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
        <span class="kd">private</span> <span class="nc">AtomicLong</span> <span class="n">counter</span><span class="o">;</span>
 
        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">AtomicLong</span> <span class="n">counter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
        <span class="o">}</span>
 
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">counter</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>LongAdder</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºé«˜å¹¶å‘åœºæ™¯ä¸‹ï¼ŒLongAdderæ¯”AtomicLongæ€§èƒ½å¥½
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAdderDemo</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">LongAdder</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LongAdder</span><span class="o">();</span>
        <span class="nc">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="nc">Task</span><span class="o">(</span><span class="n">counter</span><span class="o">));</span>
        <span class="o">}</span>
        <span class="n">service</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">service</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
 
        <span class="o">}</span>
        <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">counter</span><span class="o">.</span><span class="na">sum</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"LongAdderè€—æ—¶ï¼š"</span> <span class="o">+</span> <span class="o">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="o">));</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Task</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
        <span class="kd">private</span> <span class="nc">LongAdder</span> <span class="n">counter</span><span class="o">;</span>
 
        <span class="kd">public</span> <span class="nf">Task</span><span class="o">(</span><span class="nc">LongAdder</span> <span class="n">counter</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">counter</span> <span class="o">=</span> <span class="n">counter</span><span class="o">;</span>
        <span class="o">}</span>
 
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">counter</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>LongAccumulator</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºLongAccumulatorçš„ç”¨æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LongAccumulatorDemo</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">LongAccumulator</span> <span class="n">accumulator</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LongAccumulator</span><span class="o">((</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">8</span><span class="o">);</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">accumulator</span><span class="o">.</span><span class="na">accumulate</span><span class="o">(</span><span class="n">i</span><span class="o">)));</span>
 
        <span class="n">executor</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
 
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">accumulator</span><span class="o">.</span><span class="na">getThenReset</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="é”æœºåˆ¶">é”æœºåˆ¶</h3>

<h4 id="é”çš„åˆ†ç±»">é”çš„åˆ†ç±»</h4>

<h4 id="ä¹è§‚é”å’Œæ‚²è§‚é”">ä¹è§‚é”å’Œæ‚²è§‚é”</h4>

<ul>
  <li>
    <p>å¸¸è§çš„æ‚²è§‚é”å°±æ˜¯synchronizedå’Œlockã€‚åœ¨æ•°æ®åº“ä¸­ä½“ç°ä¸º select for update</p>
  </li>
  <li>
    <p>æ‚²è§‚é”çš„åŠ£åŠ¿ï¼š</p>

    <p>é˜»å¡å’Œå”¤é†’å¸¦æ¥çš„æ€§èƒ½åŠ£åŠ¿</p>

    <p>æ°¸ä¹…é˜»å¡ï¼Œå¦‚æœæŒæœ‰é”çš„çº¿ç¨‹è¢«æ°¸ä¹…é˜»å¡ï¼Œæ¯”å¦‚é‡åˆ°æ— é™å¾ªç¯ï¼Œæ­»é”ç­‰æ´»è·ƒæ€§é—®é¢˜ï¼Œé‚£ä¹ˆç­‰å¾…è¯¥çº¿ç¨‹é‡Šæ”¾é”çš„é‚£å‡ ä¸ªçº¿ç¨‹å°†æ°¸è¿œå¾—ä¸åˆ°æ‰§è¡Œ</p>
  </li>
  <li>
    <p>ä¹è§‚é”</p>

    <p>è®¤ä¸ºè‡ªå·±åœ¨å¤„ç†æ“ä½œçš„æ—¶å€™ä¸ä¼šæœ‰å…¶ä»–çº¿ç¨‹æ¥å¹²æ‰°ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šé”ä½è¢«æ“ä½œå¯¹è±¡</p>

    <p>åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œå»å¯¹æ¯”åœ¨æˆ‘ä¿®æ”¹æ•°æ®æœŸé—´æœ‰æ²¡æœ‰å…¶ä»–äººä¿®æ”¹è¿‡ï¼Œè‹¥æ²¡è¢«ä¿®æ”¹ï¼Œå°±è¯´æ˜åªæœ‰æˆ‘åœ¨æ“ä½œï¼Œé‚£æˆ‘å°±å»æ­£å¸¸ä¿®æ”¹æ•°æ®</p>

    <p>å¦‚æœæ•°æ®å’Œæˆ‘ä¸€å¼€å§‹æ‹¿åˆ°çš„ä¸ä¸€æ ·äº†ï¼Œè¯´æ˜å…¶ä»–äººåœ¨è¿™æ®µæ—¶é—´å†…æ”¹è¿‡æ•°æ®ï¼Œé‚£æˆ‘å°±ä¸èƒ½ç»§ç»­åˆšæ‰çš„æ›´æ”¹æ•°æ®è¿‡ç¨‹äº†ã€‚ä¼šé€‰æ‹©æ”¾å¼ƒï¼ŒæŠ¥é”™ï¼Œé‡è¯•ç­‰ç­–ç•¥ã€‚</p>

    <p>ä¹è§‚é”çš„å®ç°ä¸€èˆ¬éƒ½æ˜¯ç”¨CASç®—æ³•å®ç°çš„</p>

    <p>å…¸å‹çš„ä¹è§‚é”æ˜¯åŸå­ç±»å’Œå¹¶å‘å®¹å™¨</p>

    <p>åœ¨æ•°æ®åº“ä¸­ç”¨ä¸€ä¸ªversionå­—æ®µå°±æ˜¯ä¹è§‚é”</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å…ˆæŸ¥è¯¢è¿™ä¸ªæ›´æ–°è¯­å¥çš„versionï¼šselect * from table
ç„¶åæ›´æ–°ï¼šupdate set sum = 2,version = version+1 where version = 1 and id = 5;
å¦‚æœversionè¢«æ›´æ–°äº†ç­‰äº2ï¼Œä¸ä¸€æ ·å°±ä¼šæŠ¥é”™ï¼Œ
</code></pre></div>    </div>
  </li>
  <li>
    <p>å¼€é”€å¯¹æ¯”</p>

    <ul>
      <li>æ‚²è§‚é”çš„åŸå§‹å¼€é”€è¦é«˜äºä¹è§‚é”ï¼Œä½†æ˜¯ç‰¹ç‚¹æ˜¯ä¸€åŠ³æ°¸é€¸ï¼Œä¸´ç•ŒåŒºæŒé”æ—¶é—´å°±ç®—è¶Šæ¥è¶Šå·®ï¼Œä¹Ÿä¸ä¼šå¯¹äº’æ–¥é”çš„å¼€é”€äº§ç”Ÿå½±å“ã€‚</li>
      <li>è™½ç„¶ä¹è§‚é”çš„å¼€é”€ä¸€å¼€å§‹æ¯”æ‚²è§‚é”å°ï¼Œä½†æ˜¯å¦‚æœè‡ªæ—‹æ—¶é—´è¶Šé•¿æˆ–é‡è¯•æ¬¡æ•°è¶Šå¤šï¼Œé‚£ä¹ˆæ¶ˆè€—çš„èµ„æºä¹Ÿè¶Šå¤šã€‚</li>
      <li>æ‚²è§‚é”é€‚åˆå¹¶å‘å†™å…¥å¤šçš„æƒ…å†µï¼Œé€‚ç”¨äºä¸´ç•ŒåŒºæŒé”æ—¶é—´æ¯”è¾ƒé•¿çš„æƒ…å†µï¼Œæ‚²è§‚é”å¯ä»¥é¿å…å¤§é‡æ— ç”¨è‡ªæ—‹ç­‰æ¶ˆè€—</li>
      <li>ä¹è§‚é”é€‚åˆå¹¶å‘å†™å…¥å°‘ï¼Œå¤§éƒ¨åˆ†æ˜¯è¯»å–çš„åœºæ™¯ï¼Œä¸åŠ é”èƒ½è®©è¯»å–æ€§èƒ½æé«˜</li>
    </ul>
  </li>
</ul>

<h4 id="å…¬å¹³ä¸éå…¬å¹³é”">å…¬å¹³ä¸éå…¬å¹³é”</h4>

<ul>
  <li>å…¬å¹³é”ï¼šæ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”ï¼Œç±»ä¼¼æ’é˜Ÿä¹°é¥­ï¼Œå…ˆæ¥ååˆ°ã€‚</li>
  <li>å…¬å¹³æƒ…å†µï¼šå‡è®¾çº¿ç¨‹1234æ˜¯æŒ‰ç…§é¡ºåºè°ƒç”¨lockçš„ï¼Œåç»­ç­‰å¾…çš„çº¿ç¨‹ä¼šè¿›å…¥wait queueä¸­ï¼ŒæŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚åœ¨çº¿ç¨‹1æ‰§è¡Œunlocké‡Šæ”¾é”åï¼Œç”±äºæ­¤æ—¶çº¿ç¨‹2çš„ç­‰å¾…æ—¶é—´æœ€ä¹…ï¼Œæ‰€ä»¥çº¿ç¨‹2å…ˆå¾—åˆ°æ‰§è¡Œï¼Œç„¶åæ˜¯çº¿ç¨‹3å’Œ4</li>
  <li>éå…¬å¹³é”ï¼šæ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºå¹¶ä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œæœ‰å¯èƒ½åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å–é”ï¼Œåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ï¼Œæœ‰å¯èƒ½é€ æˆä¼˜å…ˆçº§åè½¬æˆ–è€…é¥¥é¥¿ç°è±¡ã€‚ä¼˜åŠ¿ï¼šæ›´å¿«ï¼Œååé‡æ›´å¤§</li>
  <li>éå…¬å¹³ä¹ŸåŒæ ·ä¸æå€¡æ’é˜Ÿè¡Œä¸ºï¼Œè¿™é‡Œçš„éå…¬å¹³æ˜¯æŒ‡åœ¨åˆé€‚çš„æ—¶æœºæ’é˜Ÿï¼Œè€Œä¸æ˜¯ç›²ç›®æ’é˜Ÿã€‚</li>
  <li>éå…¬å¹³æƒ…å†µï¼šå¦‚æœåœ¨çº¿ç¨‹1é‡Šæ”¾é”çš„æ—¶å€™ï¼Œçº¿ç¨‹5æ°å¥½å»æ‰§è¡Œlockæ“ä½œï¼Œç”±äºReentrantLockå‘ç°æ­¤æ—¶å¹¶æ²¡æœ‰çº¿ç¨‹æŒæœ‰lockè¿™æŠŠé”ï¼ˆçº¿ç¨‹2è¿˜æ²¡æ¥å¾—åŠè·å–åˆ°ï¼Œå› ä¸ºè·å–éœ€è¦æ—¶é—´ï¼‰ï¼Œçº¿ç¨‹5å¯ä»¥æ’é˜Ÿï¼Œç›´æ¥æ‹¿åˆ°è¿™æŠŠé”ï¼Œè¿™ä¹Ÿæ˜¯ReentrantLocké»˜è®¤çš„å…¬å¹³ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸å…¬å¹³</li>
  <li>å¹¶å‘åŒ…ä¸­ReentrantLockçš„åˆ›å»ºå¯ä»¥æŒ‡å®šæ„é€ å‡½æ•°çš„booleanç±»å‹æ¥å¾—åˆ°å…¬å¹³é”æˆ–éå…¬å¹³é”ï¼Œé»˜è®¤æ˜¯éå…¬å¹³é”ã€‚å¦‚æœåœ¨åˆ›å»ºReentrantLockæ—¶å‚æ•°å¡«å†™ä¸ºtrueï¼Œé‚£ä¹ˆè¿™å°±æ˜¯å…¬å¹³é”</li>
  <li>é’ˆå¯¹tryLockæ–¹æ³•ï¼Œå®ƒä¸éµå®ˆè®¾å®šçš„å…¬å¹³è§„åˆ™ï¼Œå½“æœ‰çº¿ç¨‹æ‰§è¡ŒtryLockçš„æ—¶å€™ï¼Œä¸€æ—¦æœ‰çº¿ç¨‹é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆè¿™ä¸ªæ­£åœ¨tryockçš„çº¿ç¨‹å°±ä¼šè·å–åˆ°é”ï¼Œå³ä½¿åœ¨å®ƒä¹‹å‰å·²ç»æœ‰å…¶ä»–çº¿ç¨‹åœ¨ç­‰å¾…é˜Ÿåˆ—é‡Œäº†ã€‚</li>
  <li>ä¸¤è€…åŒºåˆ«ï¼š
    <ul>
      <li>å…¬å¹³é”ï¼šåœ¨å¹¶å‘ç¯å¢ƒä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹åœ¨è·å–é”æ—¶ä¼šå…ˆæŸ¥çœ‹æ­¤é”ç»´æŠ¤çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœæ˜¯ç©ºï¼Œæˆ–è€…å½“å‰çº¿ç¨‹æ˜¯ç­‰å¾…é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªï¼Œå°±å æœ‰é”ï¼Œå¦åˆ™å°±ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œä»¥åä¼šæŒ‰ç…§FIFOçš„è§„åˆ™ä»é˜Ÿåˆ—ä¸­å–åˆ°è‡ªå·±ã€‚</li>
      <li>éå…¬å¹³é”ï¼šçº¿ç¨‹ä¸€å¼€å§‹å°±å°è¯•å æœ‰é”ï¼Œå¦‚æœå°è¯•å¤±è´¥ï¼Œå°±å†é‡‡ç”¨ç±»ä¼¼å…¬å¹³é”çš„é‚£ç§æ–¹å¼ã€‚éå…¬å¹³é”çš„ä¼˜ç‚¹åœ¨äºååé‡æ¯”å…¬å¹³é”å¤§ã€‚å¯¹äºsynchronizedè€Œè¨€ï¼Œä¹Ÿæ˜¯ä¸€ç§éå…¬å¹³é”ã€‚</li>
    </ul>
  </li>
  <li>æ¼”ç¤ºè¯»é”å’Œå†™é”</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CinemaReadWrite</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">reentrantReadWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†è¯»é”ï¼Œæ­£åœ¨è¯»å–"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾è¯»é”"</span><span class="o">);</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†å†™é”ï¼Œæ­£åœ¨å†™å…¥"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾å†™é”"</span><span class="o">);</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread1"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread2"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="c1">//=========================================================================</span>
 
<span class="cm">/**
 * æè¿°ï¼š     TODO
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CinemaReadWriteQueue</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">reentrantReadWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†è¯»é”ï¼Œæ­£åœ¨è¯»å–"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾è¯»é”"</span><span class="o">);</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†å†™é”ï¼Œæ­£åœ¨å†™å…¥"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾å†™é”"</span><span class="o">);</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread1"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread2"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread5"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¼”ç¤ºå…¬å¹³å’Œéå…¬å¹³</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºéå…¬å¹³å’Œå…¬å¹³çš„ReentrantReadWriteLockçš„ç­–ç•¥
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NonfairBargeDemo</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">reentrantReadWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">(</span>
            <span class="kc">true</span><span class="o">);</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¼€å§‹å°è¯•è·å–è¯»é”"</span><span class="o">);</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°è¯»é”ï¼Œæ­£åœ¨è¯»å–"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">20</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾è¯»é”"</span><span class="o">);</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¼€å§‹å°è¯•è·å–å†™é”"</span><span class="o">);</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°å†™é”ï¼Œæ­£åœ¨å†™å…¥"</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">40</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾å†™é”"</span><span class="o">);</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread1"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread2"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">write</span><span class="o">(),</span><span class="s">"Thread4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;</span><span class="n">read</span><span class="o">(),</span><span class="s">"Thread5"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">Thread</span> <span class="n">thread</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">[</span><span class="mi">1000</span><span class="o">];</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">thread</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">read</span><span class="o">(),</span> <span class="s">"å­çº¿ç¨‹åˆ›å»ºçš„Thread"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">thread</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">start</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="å¯é‡å…¥å’Œéå¯é‡å…¥é”é€’å½’é”">å¯é‡å…¥å’Œéå¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰</h4>

<ul>
  <li>å¯é‡å…¥é”æŒ‡çš„æ˜¯åŒä¸€çº¿ç¨‹å¤–å±‚å‡½æ•°è·å¾—é”ä¹‹åï¼Œå†…å±‚é€’å½’å‡½æ•°ä»ç„¶èƒ½è·å¾—è¯¥é”çš„ä»£ç ï¼Œåœ¨åŒä¸€çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™ï¼Œåœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>çº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—</strong>ã€‚</li>
  <li>ReentrantLockå’Œsynchronizedå°±æ˜¯ä¸€ç§å…¸å‹çš„å¯é‡å…¥é”ã€‚</li>
  <li>å¯é‡å…¥é”çš„æœ€å¤§ä½œç”¨å°±æ˜¯é¿å…æ­»é”</li>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰
 */</span>

<span class="kd">class</span> <span class="nc">Phone</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">sendSMS</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t invoked sendSMS()"</span><span class="o">);</span>
        <span class="n">sendEmail</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">sendEmail</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t invoked sendEmail()"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//----------------------------------------------------------------------------------------</span>

    <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">get</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">get</span><span class="o">(){</span>
        <span class="c1">//å¯ä»¥å†™å¤šæ¬¡,ä½†åŠ å‡ æ¬¡ã€è§£å‡ æ¬¡</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t invoked get()"</span><span class="o">);</span>
            <span class="n">set</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(){</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t invoked set()"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * demo 1 è¯æ˜synchronizedæ˜¯å¯é‡å…¥é”
 * t1  invoked sendSMS()      t1çº¿ç¨‹åœ¨å¤–å±‚æ–¹æ³•è·å–é”çš„æ—¶å€™
 * t1  invoked sendEmail()    t1åœ¨è¿›å…¥å†…å±‚æ–¹æ³•ä¼šè‡ªåŠ¨è·å–é”
 * t2  invoked sendSMS()
 * t2  invoked sendEmail()
 * --------------------------------------------------------
 * demo 2 è¯æ˜ReentranLockæ˜¯å¯é‡å…¥é”
 * t3  invoked get()
 * t3  invoked set()
 * t4  invoked get()
 * t4  invoked set()
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReenterLockDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">Phone</span> <span class="n">phone</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Phone</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t1"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">phone</span><span class="o">.</span><span class="na">sendSMS</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t2"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">phone</span><span class="o">.</span><span class="na">sendSMS</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>

        <span class="nc">Thread</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">phone</span><span class="o">,</span> <span class="s">"t3"</span><span class="o">);</span>
        <span class="n">t3</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">Thread</span> <span class="n">t4</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">phone</span><span class="o">,</span> <span class="s">"t4"</span><span class="o">);</span>
        <span class="n">t4</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
 <span class="cm">/*
t1 invoked sendSMS()
t1 invoked sendEmail()
t2 invoked sendSMS()
t2 invoked sendEmail()
 
t3 invoked get()
t3 invoked set()
t4 invoked get()
t4 invoked set()
 */</span>
</code></pre></div></div>

<ul>
  <li>isHeldByCurrentThreadæ–¹æ³•å¯ä»¥çœ‹å‡ºé”æ˜¯å¦è¢«å½“å‰çº¿ç¨‹æŒæœ‰</li>
  <li>getQueueLengthæ–¹æ³•å¯ä»¥è¿”å›å½“å‰æ­£åœ¨ç­‰å¾…è¿™æŠŠé”çš„é˜Ÿåˆ—é•¿åº¦</li>
  <li>ä½¿ç”¨  getHoldCount()æ–¹æ³•å¯ä»¥è·å¾—æŒæœ‰é”çš„æ¬¡æ•°ï¼Œlockä¸€æ¬¡å°±åŠ ä¸€ï¼Œunlockä¸€æ¬¡å°±å‡ä¸€</li>
</ul>

<h4 id="è‡ªæ—‹é”">è‡ªæ—‹é”</h4>

<ul>
  <li>é˜»å¡æˆ–å”¤é†’ä¸€ä¸ªjavaçº¿ç¨‹éœ€è¦æ“ä½œç³»ç»Ÿåˆ‡æ¢CPUæ¥å®ç°ï¼Œè¿™ç§çŠ¶æ€è½¬æ¢éœ€è¦æ¶ˆè€—å¤„ç†å™¨æ—¶é—´ã€‚</li>
  <li>å¦‚æœåŒæ­¥ä»£ç å—ä¸­çš„å†…å®¹è¿‡äºç®€å•ï¼ŒçŠ¶æ€è½¬æ¢æ¶ˆè€—çš„æ—¶é—´æœ‰å¯èƒ½æ¯”ç”¨æˆ·æ‰§è¡Œä»£ç çš„æ—¶é—´è¿˜è¦é•¿ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸­ï¼ŒåŒæ­¥èµ„æºçš„é”å®šæ—¶é—´å¾ˆçŸ­ï¼Œä¸ºäº†è¿™ä¸€å°æ®µæ—¶é—´å»åˆ‡æ¢çº¿ç¨‹ï¼Œçº¿ç¨‹çš„æŒ‚èµ·å’Œæ¢å¤çš„èŠ±è´¹å¯èƒ½è®©ç³»ç»Ÿå¾—ä¸å¿å¤±</li>
  <li>å¦‚æœæœ‰ç‰©ç†æœºæœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œèƒ½è®©ä¸¤ä¸ªæˆ–ä»¥ä¸Šçº¿ç¨‹åŒæ—¶å¹¶è¡Œæ‰§è¡Œï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©åé¢é‚£ä¸ªè¯·æ±‚é”çš„çº¿ç¨‹ä¸æ”¾å¼ƒCPUçš„æ‰§è¡Œæ—¶é—´ï¼Œçœ‹çœ‹æŒæœ‰é”çš„çº¿ç¨‹ä¼šå¦å¾ˆå¿«é‡Šæ”¾é”</li>
  <li>ä¸ºäº†è®©å½“å‰çº¿ç¨‹ç¨ç­‰ä¸€ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦è®©å½“å‰çº¿ç¨‹è‡ªæ—‹ï¼Œå¦‚æœåœ¨è‡ªæ—‹å®Œæˆåå‰é¢é”å®šåŒæ­¥èµ„æºçš„çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å°±å¯ä»¥ä¸å¿…é˜»å¡è€Œç›´æ¥è·å–åŒæ­¥èµ„æºï¼Œä»è€Œé¿å…åˆ‡æ¢çº¿ç¨‹çš„å¼€é”€ï¼Œè¿™å°±æ˜¯è‡ªæ—‹é”ã€‚</li>
  <li>
    <p>å¦‚æœé”è¢«å ç”¨å¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„çº¿ç¨‹åªä¼šç™½æµªè´¹å¤„ç†å™¨èµ„æºã€‚åœ¨è‡ªæ—‹è¿‡ç¨‹ä¸­ï¼Œä¸€ç›´æ¶ˆè€—CPUï¼Œæ‰€ä»¥è™½ç„¶è‡ªæ—‹é”çš„èµ·å§‹æ¶ˆè€—ä½äºæ‚²è§‚é”ï¼Œä½†æ˜¯éšç€è‡ªæ—‹æ—¶é—´çš„å¢é•¿ï¼Œå¼€é”€ä¹Ÿæ˜¯çº¿æ€§å¢é•¿çš„ã€‚</p>
  </li>
  <li>æ˜¯æŒ‡å°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œè€Œæ˜¯é‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—ï¼Œç¼ºç‚¹æ˜¯å¾ªç¯ä¼šæ¶ˆè€—CPUã€‚</li>
  <li>unsafeç±»çš„getAndAddItæ–¹æ³•å°±æ˜¯å…¸å‹çš„è‡ªæ—‹é”</li>
</ul>

<p><img src="https://i.loli.net/2020/06/23/yOnF46CiYfGu1vW.png" alt="image.png" /></p>

<ul>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * è‡ªæ—‹é”ï¼šå¾ªç¯æ¯”è¾ƒè·å–ç›´åˆ°æˆåŠŸä¸ºæ­¢,æ²¡æœ‰ç±»ä¼¼waitçš„é˜»å¡
 *
 * é€šè¿‡CASæ“ä½œå®Œæˆè‡ªæ—‹é”,Açº¿ç¨‹å…ˆè¿›æ¥è°ƒç”¨myLockæ–¹æ³•è‡ªå·±æŒæœ‰é”5ç§’é’Ÿ,Béšåè¿›æ¥åå‘ç°
 * å½“å‰æœ‰çº¿ç¨‹æŒæœ‰é”,ä¸æ˜¯null,æ‰€ä»¥åªèƒ½é€šè¿‡è‡ªæ—‹ç­‰å¾…,ç›´åˆ°Aé‡Šæ”¾é”åBæŠ¢åˆ°
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpinLockDemo</span> <span class="o">{</span>

    <span class="c1">//åŸå­å¼•ç”¨çº¿ç¨‹</span>
    <span class="nc">AtomicReference</span><span class="o">&lt;</span><span class="nc">Thread</span><span class="o">&gt;</span> <span class="n">atomicReference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AtomicReference</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myLock</span><span class="o">(){</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tcome in."</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">thread</span><span class="o">)){</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">myUnlock</span><span class="o">(){</span>
        <span class="nc">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
        <span class="n">atomicReference</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">thread</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tinvoke myUnlock()."</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpinLockDemo</span> <span class="n">demo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SpinLockDemo</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t1"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">demo</span><span class="o">.</span><span class="na">myLock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">demo</span><span class="o">.</span><span class="na">myUnlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="s">"t2"</span><span class="o">){</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="n">demo</span><span class="o">.</span><span class="na">myLock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">demo</span><span class="o">.</span><span class="na">myUnlock</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
 <span class="cm">/*
t1come in.
---1så-----
t2come in.
---5så-----
t1invoke myUnlock().
t2invoke myUnlock().
*/</span>
</code></pre></div></div>

<ul>
  <li>
    <p>ä½¿ç”¨åœºæ™¯ï¼š</p>

    <p>è‡ªæ—‹é”ä¸€èˆ¬ç”¨äºå¤šæ ¸æœåŠ¡å™¨ï¼Œåœ¨å¹¶å‘åº¦ä¸æ˜¯ç‰¹åˆ«é«˜çš„æƒ…å†µä¸‹ï¼Œæ¯”é˜»å¡é”çš„æ•ˆç‡é«˜ã€‚</p>

    <p>è‡ªæ—‹é”é€‚ç”¨äºä¸´ç•ŒåŒºæ¯”è¾ƒçŸ­å°çš„æƒ…å†µï¼Œå¦åˆ™å¦‚æœä¸´ç•ŒåŒºå¾ˆå¤§ï¼ˆçº¿å±‚ä¸€æ—¦æ‹¿åˆ°é”ï¼Œå¾ˆä¹…ä»¥åæ‰ä¼šé‡Šæ”¾ï¼‰ï¼Œé‚£ä¹Ÿæ˜¯ä¸åˆé€‚çš„ã€‚</p>
  </li>
</ul>

<h4 id="ç‹¬å å…±äº«ä¸äº’æ–¥é”">ç‹¬å ï¼Œå…±äº«ä¸äº’æ–¥é”</h4>

<ul>
  <li>ç‹¬å é”ï¼šæ˜¯æŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¯¹ReentrantLockå’Œsynchronizedè€Œè¨€éƒ½æ˜¯ç‹¬å é”</li>
  <li>å…±äº«é”ï¼šæ˜¯æŒ‡é”å¯è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚</li>
  <li>ä»¥ReentrantReadWriteLockè¯»å†™é”ä¸ºä¾‹ï¼Œå®ç°äº†ReadWriteLockæ¥å£ï¼Œä½¿ç”¨readLock()æ–¹æ³•æ¥è·å–è¯»é”ï¼Œç”¨writeLock()æ–¹æ³•æ¥è·å–å†™é”ã€‚å…¶ä¸­è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯æ’å®ƒé”ã€‚åœ¨è¯»çš„åœ°æ–¹ä½¿ç”¨è¯»é”ï¼Œå†™çš„åœ°æ–¹ä½¿ç”¨å†™é”ï¼Œå¦‚æœæ²¡æœ‰å†™é”çš„æƒ…å†µä¸‹ï¼Œè¯»æ˜¯æ— é˜»å¡çš„ï¼Œæé«˜ç¨‹åºæ‰§è¡Œæ•ˆç‡ã€‚</li>
  <li>è¯»é”çš„å…±äº«é”å¯ä¿è¯å¹¶å‘è¯»æ˜¯éå¸¸é«˜æ•ˆçš„ï¼Œè¯»å†™ï¼Œå†™è¯»ï¼Œå†™å†™è¿‡ç¨‹æ˜¯äº’æ–¥çš„ã€‚</li>
  <li>è¯»å†™é”çš„è§„åˆ™
    <ul>
      <li>å¤šä¸ªçº¿ç¨‹éƒ½ç”³è¯·è¯»é”ï¼Œéƒ½å¯ä»¥ç”³è¯·åˆ°</li>
      <li>å¦‚æœå·²ç»æœ‰ä¸€ä¸ªçº¿ç¨‹å æœ‰äº†è¯»é”ï¼Œæ­¤æ—¶å¦‚æœå…¶ä»–çº¿ç¨‹å»ç”³è¯·å†™é”ï¼Œåˆ™ç”³è¯·å†™é”çš„çº¿ç¨‹ä¸€ç›´ç­‰å¾…è¯»é”é‡Šæ”¾</li>
      <li>è‹¥å·²ç»æœ‰çº¿ç¨‹å æœ‰äº†å†™é”ï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹å»ç”³è¯·å†™é”æˆ–è¯»é”ï¼Œéƒ½ä¼šç­‰å¾…ï¼Œç›´åˆ°å†™é”è¢«é‡Šæ”¾</li>
      <li>ä¸€å¥è¯æ€»ç»“ï¼šè¦ä¹ˆæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åŒæ—¶æœ‰è¯»é”ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªçº¿ç¨‹æœ‰å†™é”ï¼Œä½†æ˜¯ä¸¤è€…ä¸ä¼šåŒæ—¶å‡ºç°ï¼ˆè¦ä¹ˆå¤šè¯»ï¼Œè¦ä¹ˆä¸€å†™ï¼‰</li>
    </ul>
  </li>
  <li>è¯»é”æ’é˜Ÿç­–ç•¥
    <ul>
      <li>å…¬å¹³é”ï¼šä¸å…è®¸æ’é˜Ÿã€‚</li>
      <li>éå…¬å¹³ï¼šå‡è®¾çº¿ç¨‹2å’Œçº¿ç¨‹4æ­£åœ¨åŒæ—¶è¯»å–ï¼Œçº¿ç¨‹3æƒ³è¦å†™å…¥ï¼Œæ‹¿ä¸åˆ°é”ï¼Œäºæ˜¯è¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œçº¿ç¨‹5ä¸åœ¨é˜Ÿåˆ—ä¸­ï¼Œç°åœ¨è¿‡æ¥æƒ³è¦è¯»å–ã€‚
ç­–ç•¥1ï¼šè¯»å¯ä»¥æ’é˜Ÿï¼Œæé«˜æ•ˆç‡ï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´å†™å…¥çº¿ç¨‹é¥¥é¥¿ã€‚
ç­–ç•¥2ï¼šè¯»ä¸å¯ä»¥æ’é˜Ÿï¼Œå¿…é¡»è¿›å…¥é˜Ÿåˆ—è¿›è¡Œç­‰å¾…ï¼Œå¯ä»¥é¿å…é¥¥é¥¿ã€‚
ReentrantReadWriteLocké€‰ç”¨çš„æ˜¯ç­–ç•¥2ã€‚</li>
    </ul>
  </li>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">MyCache</span> <span class="o">{</span>  <span class="c1">//èµ„æºç±»</span>

     <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæ­£åœ¨å†™å…¥ï¼š"</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tå†™å…¥å®Œæˆ"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæ­£åœ¨è¯»å–ï¼š"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tè¯»å–å®Œæˆï¼š"</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="cm">/**
 * å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡é—®é¢˜,æ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡,è¯»å–å…±äº«èµ„æºè¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ
 * ä½†æ˜¯,
 * å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æº,å°±ä¸è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™
 * å†™æ“ä½œï¼šåŸå­+ç‹¬å ,æ•´ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»Ÿä¸€ä½“,ä¸­é—´ä¸å…è®¸è¢«åˆ†å‰²ã€è¢«æ‰“æ–­
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteLockDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">MyCache</span> <span class="n">myCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCache</span><span class="o">();</span>

        <span class="c1">//5ä¸ªçº¿ç¨‹å†™</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">myCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tempInt</span><span class="o">),</span> <span class="n">tempInt</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">//5ä¸ªçº¿ç¨‹è¯»</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">myCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tempInt</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
2 æ­£åœ¨å†™å…¥ï¼š2
1 æ­£åœ¨å†™å…¥ï¼š1
3 æ­£åœ¨å†™å…¥ï¼š3
4 æ­£åœ¨å†™å…¥ï¼š4
5 æ­£åœ¨å†™å…¥ï¼š5
1 æ­£åœ¨è¯»å–ï¼š
2 æ­£åœ¨è¯»å–ï¼š
3 æ­£åœ¨è¯»å–ï¼š
4 æ­£åœ¨è¯»å–ï¼š
5 æ­£åœ¨è¯»å–ï¼š
1 å†™å…¥å®Œæˆ
3 å†™å…¥å®Œæˆ
4 å†™å…¥å®Œæˆ
5 å†™å…¥å®Œæˆ
2 å†™å…¥å®Œæˆ
3 è¯»å–å®Œæˆï¼šnull
1 è¯»å–å®Œæˆï¼š1
2 è¯»å–å®Œæˆï¼š2
5 è¯»å–å®Œæˆï¼š5
4 è¯»å–å®Œæˆï¼š4
 */</span>
 
<span class="kd">class</span> <span class="nc">MyCache</span> <span class="o">{</span>  <span class="c1">//èµ„æºç±»</span>

    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

    <span class="kd">private</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">readWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">){</span>
        <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæ­£åœ¨å†™å…¥ï¼š"</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tå†™å…¥å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">readWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">){</span>
        <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæ­£åœ¨è¯»å–ï¼š"</span><span class="o">);</span>
            <span class="cm">/*try {
                Thread.sleep(300);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }*/</span>
            <span class="nc">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tè¯»å–å®Œæˆï¼š"</span> <span class="o">+</span> <span class="n">value</span><span class="o">);</span>
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">readWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/**
 * å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡é—®é¢˜,æ‰€ä»¥ä¸ºäº†æ»¡è¶³å¹¶å‘é‡,è¯»å–å…±äº«èµ„æºè¯¥å¯ä»¥åŒæ—¶è¿›è¡Œ
 * ä½†æ˜¯,
 * å¦‚æœæœ‰ä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æº,å°±ä¸è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™
 * å†™æ“ä½œï¼šåŸå­+ç‹¬å ,æ•´ä¸ªè¿‡ç¨‹å¿…é¡»æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç»Ÿä¸€ä½“,ä¸­é—´ä¸å…è®¸è¢«åˆ†å‰²ã€è¢«æ‰“æ–­
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteLockDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="nc">MyCache</span> <span class="n">myCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCache</span><span class="o">();</span>

        <span class="c1">//5ä¸ªçº¿ç¨‹å†™</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">myCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tempInt</span><span class="o">),</span> <span class="n">tempInt</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">//5ä¸ªçº¿ç¨‹è¯»</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">myCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">tempInt</span><span class="o">));</span>
                <span class="o">}</span>
            <span class="o">}.</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
2 æ­£åœ¨å†™å…¥ï¼š2
2 å†™å…¥å®Œæˆ
1 æ­£åœ¨å†™å…¥ï¼š1
1 å†™å…¥å®Œæˆ
3 æ­£åœ¨å†™å…¥ï¼š3
3 å†™å…¥å®Œæˆ
5 æ­£åœ¨å†™å…¥ï¼š5
5 å†™å…¥å®Œæˆ
4 æ­£åœ¨å†™å…¥ï¼š4
4 å†™å…¥å®Œæˆ
2 æ­£åœ¨è¯»å–ï¼š
2 è¯»å–å®Œæˆï¼š2
1 æ­£åœ¨è¯»å–ï¼š
1 è¯»å–å®Œæˆï¼š1
4 æ­£åœ¨è¯»å–ï¼š
5 æ­£åœ¨è¯»å–ï¼š
5 è¯»å–å®Œæˆï¼š5
3 æ­£åœ¨è¯»å–ï¼š
3 è¯»å–å®Œæˆï¼š3
4 è¯»å–å®Œæˆï¼š4
*/</span>
</code></pre></div></div>

<h4 id="å¯ä¸­æ–­é”">å¯ä¸­æ–­é”</h4>

<ul>
  <li>synchronizedæ˜¯ä¸å¯ä¸­æ–­é”ï¼ŒLockæ˜¯å¯ä¸­æ–­é”ï¼Œå› ä¸ºtryLock(time)å’ŒlockInterruptibly()éƒ½èƒ½å“åº”ä¸­æ–­ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">LockInterruptibly</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">LockInterruptibly</span> <span class="n">lockInterruptibly</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LockInterruptibly</span><span class="o">();</span>
    <span class="nc">Thread</span> <span class="n">thread0</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">lockInterruptibly</span><span class="o">);</span>
    <span class="nc">Thread</span> <span class="n">thread1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="n">lockInterruptibly</span><span class="o">);</span>
    <span class="n">thread0</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="n">thread1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
 
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="n">thread1</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
<span class="o">}</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å°è¯•è·å–é”"</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">lockInterruptibly</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å–åˆ°äº†é”"</span><span class="o">);</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ç¡çœ æœŸé—´è¢«ä¸­æ–­äº†"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾äº†é”"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å¾—é”æœŸé—´è¢«ä¸­æ–­äº†"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="é”çš„å‡é™çº§">é”çš„å‡é™çº§</h4>

<ul>
  <li>æ”¯æŒé”çš„é™çº§ï¼Œä¸æ”¯æŒå‡çº§ï¼Œé¿å…æ­»é”</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºReentrantReadWriteLockå¯ä»¥é™çº§ï¼Œä¸èƒ½å‡çº§
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Upgrading</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span> <span class="n">reentrantReadWriteLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">(</span>
            <span class="kc">false</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">ReadLock</span> <span class="n">readLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">.</span><span class="na">WriteLock</span> <span class="n">writeLock</span> <span class="o">=</span> <span class="n">reentrantReadWriteLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">();</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">readUpgrading</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†è¯»é”ï¼Œæ­£åœ¨è¯»å–"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡çº§ä¼šå¸¦æ¥é˜»å¡"</span><span class="o">);</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"è·å–åˆ°äº†å†™é”ï¼Œå‡çº§æˆåŠŸ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾è¯»é”"</span><span class="o">);</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">writeDowngrading</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">writeLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å¾—åˆ°äº†å†™é”ï¼Œæ­£åœ¨å†™å…¥"</span><span class="o">);</span>
            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åœ¨ä¸é‡Šæ”¾å†™é”çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è·å–è¯»é”ï¼ŒæˆåŠŸé™çº§"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">readLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"é‡Šæ”¾å†™é”"</span><span class="o">);</span>
            <span class="n">writeLock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
<span class="c1">//        System.out.println("å…ˆæ¼”ç¤ºé™çº§æ˜¯å¯ä»¥çš„");</span>
<span class="c1">//        Thread thread1 = new Thread(() -&gt; writeDowngrading(), "Thread1");</span>
<span class="c1">//        thread1.start();</span>
<span class="c1">//        thread1.join();</span>
<span class="c1">//        System.out.println("------------------");</span>
<span class="c1">//        System.out.println("æ¼”ç¤ºå‡çº§æ˜¯ä¸è¡Œçš„");</span>
        <span class="nc">Thread</span> <span class="n">thread2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">readUpgrading</span><span class="o">(),</span> <span class="s">"Thread2"</span><span class="o">);</span>
        <span class="n">thread2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="é”çš„ä¼˜åŒ–">é”çš„ä¼˜åŒ–</h4>

<p>1ï¼šç¼©å°åŒæ­¥ä»£ç å—
2ï¼šå°½é‡ä¸è¦é”ä½æ–¹æ³•
3ï¼šå‡å°‘è¯·æ±‚é”çš„æ¬¡æ•°
4ï¼šé¿å…äººä¸ºåˆ¶é€ â€œçƒ­ç‚¹â€
5ï¼šé”ä¸­å°½é‡ä¸è¦åŒ…å«é”
6ï¼šé€‰æ‹©é€‚åˆåœºæ™¯çš„é”</p>

<h3 id="lockæ¥å£">Lockæ¥å£</h3>

<ul>
  <li>Lockå¹¶ä¸æ˜¯ç”¨æ¥æ›¿ä»£synchronizedçš„ï¼Œè€Œæ˜¯å½“å®ƒä¸æ»¡è¶³éœ€æ±‚æ—¶ï¼Œç”¨æ¥æä¾›é«˜çº§åŠŸèƒ½çš„ã€‚</li>
  <li>Lockæ¥å£æœ€å¸¸è§çš„å®ç°ç±»æ˜¯ReentrantLockï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼ŒLockåªå…è®¸ä¸€ä¸ªçº¿ç¨‹æ¥è®¿é—®å…±äº«èµ„æºï¼Œä¸è¿‡æœ‰æ—¶å€™ä¸€äº›ç‰¹æ®Šçš„å®ç°ä¹Ÿå¯å…è®¸å¹¶å‘è®¿é—®ï¼Œæ¯”å¦‚ReadWriteLocké‡Œçš„ReadLockã€‚</li>
  <li>lockä¸ä¼šåƒsynchronizedä¸€æ ·åœ¨å¼‚å¸¸æ—¶è‡ªåŠ¨é‡Šæ”¾é”</li>
  <li>synchronizedæ•ˆç‡ä½ï¼Œé”çš„é‡Šæ”¾æƒ…å†µå°‘ï¼Œè¯•å›¾è·å–é”æ—¶ä¸èƒ½è®¾å®šè¶…æ—¶ï¼Œä¸èƒ½ä¸­æ–­ä¸€ä¸ªæ­£åœ¨è¯•å›¾è·å–é”çš„çº¿ç¨‹</li>
  <li>synchronizedä¸å¤Ÿçµæ´»ï¼ˆè¯»å†™é”æ›´çµæ´»ï¼‰ï¼ŒåŠ é”å’Œé‡Šæ”¾çš„æ—¶æœºå•ä¸€ï¼Œæ¯ä¸ªé”ä»…æœ‰å•ä¸€çš„æ¡ä»¶ï¼ˆæŸä¸ªå¯¹è±¡ï¼‰ï¼Œå¯èƒ½æ˜¯ä¸å¤Ÿçš„ï¼Œå¹¶ä¸”æ— æ³•çŸ¥é“æ˜¯å¦æˆåŠŸè·å–åˆ°äº†é”</li>
  <li>â€‹</li>
</ul>

<h4 id="synchronized">synchronized</h4>

<ul>
  <li>åŸåˆ™ï¼šé«˜å†…èšä½è€¦åˆ</li>
  <li>å¥—è·¯ï¼šçº¿ç¨‹æ“ä½œèµ„æºç±»</li>
  <li>å®ç°æ­¥éª¤ï¼š
    <ul>
      <li>åˆ›å»ºèµ„æºç±»</li>
      <li>èµ„æºç±»é‡Œåˆ›å»ºåŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥ä»£ç å—</li>
    </ul>
  </li>
  <li>æ¡ˆä¾‹ï¼šå–ç¥¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
 
<span class="cm">/**
 * é¢˜ç›®ï¼šä¸‰ä¸ªå”®ç¥¨å‘˜å–30å¼ ç¥¨
 * å¤šçº¿ç¨‹ä¼ä¸šçº§å¥—è·¯åŠ æ¨¡æ¿
 * åœ¨é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼ˆçº¿ç¨‹ï¼Œæ“ä½œï¼Œèµ„æºç±»ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaleTicket1</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Ticket</span> <span class="n">ticket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Ticket</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"C"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">Ticket</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">saleTicket</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\tå–å‡ºç¬¬ï¼š"</span><span class="o">+(</span><span class="n">number</span><span class="o">--)+</span><span class="s">"\tè¿˜å‰©ä¸‹ï¼š"</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
            <span class="o">}</span>
 
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 

</code></pre></div></div>

<h4 id="reentrantlock">ReentrantLock</h4>

<ul>
  <li>ä¸€ä¸ªå¯é‡å…¥äº’æ–¥Lockå…·æœ‰ä¸ä½¿ç”¨synchronizedæ–¹æ³•å’Œè¯­å¥è®¿é—®çš„éšå¼ç›‘è§†é”ç›¸åŒçš„åŸºæœ¬è¡Œä¸ºå’Œè¯­ä¹‰ï¼Œä½†å…·æœ‰æ‰©å±•åŠŸèƒ½ã€‚</li>
  <li>
    <p>ReentrantLockç”±çº¿ç¨‹æ‹¥æœ‰ ï¼Œæœ€åæˆåŠŸé”å®šï¼Œä½†å°šæœªè§£é”ã€‚ è°ƒç”¨lockçš„çº¿ç¨‹å°†è¿”å›ï¼ŒæˆåŠŸè·å–é”ï¼Œå½“é”ä¸æ˜¯ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ã€‚ å¦‚æœå½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰è¯¥é”ï¼Œè¯¥æ–¹æ³•å°†ç«‹å³è¿”å›ã€‚ è¿™å¯ä»¥ä½¿ç”¨æ–¹æ³•isHeldByCurrentThread()å’ŒgetHoldCount()è¿›è¡Œæ£€æŸ¥ã€‚</p>
  </li>
  <li>é”å®ç°æä¾›äº†æ¯”ä½¿ç”¨åŒæ­¥æ–¹æ³•å’Œè¯­å¥å¯ä»¥è·å¾—çš„æ›´å¹¿æ³›çš„é”æ“ä½œã€‚å®ƒä»¬å…è®¸æ›´çµæ´»çš„ç»“æ„ï¼Œå¯èƒ½å…·æœ‰éå¸¸ä¸åŒçš„å±æ€§ï¼Œå¹¶ä¸”å¯èƒ½æ”¯æŒå¤šä¸ªå…³è”çš„æ¡ä»¶å¯¹è±¡ã€‚</li>
  <li>å»ºè®®çš„åšæ³•æ˜¯å§‹ç»ˆç«‹å³è·Ÿéšlockä¸tryå—çš„é€šè¯ï¼Œæœ€å¸¸è§çš„æ˜¯åœ¨ä¹‹å‰/ä¹‹åçš„å»ºè®¾ï¼Œå¦‚ï¼š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">X</span> <span class="o">{</span>
   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
   <span class="c1">// ...</span>
 
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">m</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>  <span class="c1">// block until condition holds</span>
     <span class="k">try</span> <span class="o">{</span>
       <span class="c1">// ... method body</span>
     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">()</span>
     <span class="o">}</span>
   <span class="o">}</span>
 <span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç”¨tryLockæ¥é¿å…æ­»é”</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ç”¨tryLockæ¥é¿å…æ­»é”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TryLockDeadlock</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
 
    <span class="kt">int</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">static</span> <span class="nc">Lock</span> <span class="n">lock2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">TryLockDeadlock</span> <span class="n">r1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TryLockDeadlock</span><span class="o">();</span>
        <span class="nc">TryLockDeadlock</span> <span class="n">r2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TryLockDeadlock</span><span class="o">();</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">r1</span><span class="o">.</span><span class="na">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r1</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">r2</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
 
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lock1</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–åˆ°äº†é”1"</span><span class="o">);</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">lock2</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–åˆ°äº†é”2"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1æˆåŠŸè·å–åˆ°äº†ä¸¤æŠŠé”"</span><span class="o">);</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                                    <span class="n">lock2</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–é”2å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">lock1</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹1è·å–é”1å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
            <span class="k">if</span> <span class="o">(</span><span class="n">flag</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">lock2</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">3000</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–åˆ°äº†é”2"</span><span class="o">);</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">lock1</span><span class="o">.</span><span class="na">tryLock</span><span class="o">(</span><span class="mi">800</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">))</span> <span class="o">{</span>
                                <span class="k">try</span> <span class="o">{</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–åˆ°äº†é”1"</span><span class="o">);</span>
                                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2æˆåŠŸè·å–åˆ°äº†ä¸¤æŠŠé”"</span><span class="o">);</span>
                                    <span class="k">break</span><span class="o">;</span>
                                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                                    <span class="n">lock1</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                                <span class="o">}</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–é”1å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                            <span class="o">}</span>
                        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                            <span class="n">lock2</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"çº¿ç¨‹2è·å–é”2å¤±è´¥ï¼Œå·²é‡è¯•"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="å¯¹æ¯”">å¯¹æ¯”</h4>

<ul>
  <li>å¯¹æ¯”synchronizedï¼š
    <ul>
      <li>é¦–å…ˆsynchronizedæ˜¯javaå†…ç½®å…³é”®å­—ï¼Œå±äºjvmå±‚é¢ï¼Œmonitorenterï¼ˆåº•å±‚é€šè¿‡monitorå¯¹è±¡æ¥å®Œæˆï¼Œå…¶å®wait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–äºmonitorå¯¹è±¡ï¼Œåªæœ‰åœ¨åŒæ­¥ä»£ç å—æˆ–åŒæ­¥æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨wait/notifyç­‰æ–¹æ³•ï¼‰ï¼Œmonitorexitã€‚</li>
      <li>Lockæ˜¯ä¸ªjavaç±»ï¼ˆjava.util.concurrent.locks.lockï¼‰æ˜¯apiå±‚é¢çš„é”ï¼›</li>
      <li>synchronizedæ— æ³•åˆ¤æ–­æ˜¯å¦è·å–é”çš„çŠ¶æ€ï¼ŒLockå¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°é”ï¼›</li>
      <li>synchronizedä¸å¯ä¸­æ–­ï¼Œé™¤éæŠ›å‡ºå¼‚å¸¸æˆ–æ­£å¸¸æ‰§è¡Œç»“æŸã€‚</li>
      <li>ReentrantLockå¯ä¸­æ–­ï¼Œ è®¾ç½®è¶…æ—¶æ–¹æ³•tryLock(long timeout, TimeUnit unit)</li>
      <li>synchronizedä¼šè‡ªåŠ¨é‡Šæ”¾é”(a çº¿ç¨‹æ‰§è¡Œå®ŒåŒæ­¥ä»£ç ä¼šé‡Šæ”¾é” ï¼›b çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ä¼šé‡Šæ”¾é”)ï¼ŒLockéœ€åœ¨finallyä¸­æ‰‹å·¥é‡Šæ”¾é”ï¼ˆunlock()æ–¹æ³•é‡Šæ”¾é”ï¼‰ï¼Œå¦åˆ™å®¹æ˜“é€ æˆçº¿ç¨‹æ­»é”ï¼›</li>
      <li>synchronizedçš„é”å¯é‡å…¥ã€ä¸å¯ä¸­æ–­ã€éå…¬å¹³ï¼Œè€ŒLocké”å¯é‡å…¥ã€å¯åˆ¤æ–­ã€å¯å…¬å¹³ï¼ˆä¸¤è€…çš†å¯ï¼‰</li>
      <li>synchronizedæ²¡æœ‰é”çš„ç»‘å®šæ¡ä»¶ï¼›ReentrantLockç”¨conditionæ¥å®ç°åˆ†ç»„å”¤é†’éœ€è¦å”¤é†’çš„çº¿ç¨‹ï¼Œå¯ä»¥ç²¾ç¡®å”¤é†’ï¼Œè€Œä¸æ˜¯åƒsynchronizedéšå³å”¤é†’ä¸€ä¸ªæˆ–è€…å…¨éƒ¨å”¤é†’ã€‚</li>
      <li>Locké”é€‚åˆå¤§é‡åŒæ­¥çš„ä»£ç çš„åŒæ­¥é—®é¢˜ï¼Œsynchronizedé”é€‚åˆä»£ç å°‘é‡çš„åŒæ­¥é—®é¢˜ã€‚</li>
    </ul>
  </li>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
 
<span class="cm">/**
 * é¢˜ç›®ï¼šä¸‰ä¸ªå”®ç¥¨å‘˜å–30å¼ ç¥¨
 * å¤šçº¿ç¨‹ä¼ä¸šçº§å¥—è·¯åŠ æ¨¡æ¿
 * åœ¨é«˜å†…èšä½è€¦åˆå‰æä¸‹ï¼ˆçº¿ç¨‹ï¼Œæ“ä½œï¼Œèµ„æºç±»ï¼‰
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaleTicket1</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Ticket</span> <span class="n">ticket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Ticket</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">ticket</span><span class="o">.</span><span class="na">saleTicket</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"C"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="kd">class</span> <span class="nc">Ticket</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">30</span><span class="o">;</span>
    <span class="c1">//jucå¯é‡å…¥é”</span>
    <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saleTicket</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\tå–å‡ºç¬¬ï¼š"</span><span class="o">+(</span><span class="n">number</span><span class="o">--)+</span><span class="s">"\tè¿˜å‰©ä¸‹ï¼š"</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
            <span class="o">}</span>
 
        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="çº¿ç¨‹é€šè®¯">çº¿ç¨‹é€šè®¯</h3>

<ul>
  <li>çº¿ç¨‹é—´é€šä¿¡ï¼š1ã€ç”Ÿäº§è€…+æ¶ˆè´¹è€…2ã€é€šçŸ¥ç­‰å¾…å”¤é†’æœºåˆ¶</li>
</ul>

<h4 id="syncwaitnotifyå®ç°">sync+wait+notifyå®ç°</h4>

<ul>
  <li>ä¸¤ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå˜é‡å¾ªç¯åŠ å‡</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.atguigu.thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
 
<span class="cm">/**
 * 
 * @Description:
 *ç°åœ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œ
 * å¯ä»¥æ“ä½œåˆå§‹å€¼ä¸ºé›¶çš„ä¸€ä¸ªå˜é‡ï¼Œ
 * å®ç°ä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡åŠ 1ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡å‡1ï¼Œ
 * äº¤æ›¿ï¼Œæ¥10è½®ã€‚ 
 * @author xialei
 *
 *  * ç¬”è®°ï¼šJavaé‡Œé¢å¦‚ä½•è¿›è¡Œå·¥ç¨‹çº§åˆ«çš„å¤šçº¿ç¨‹ç¼–å†™
 * 1 å¤šçº¿ç¨‹å˜æˆæ¨¡æ¿ï¼ˆå¥—è·¯ï¼‰-----ä¸Š
 *     1.1  çº¿ç¨‹    æ“ä½œ    èµ„æºç±»  
 *     1.2  é«˜å†…èš  ä½è€¦åˆ
 * 2 å¤šçº¿ç¨‹å˜æˆæ¨¡æ¿ï¼ˆå¥—è·¯ï¼‰-----ä¸‹
 *     2.1  åˆ¤æ–­
 *     2.2  å¹²æ´»
 *     2.3  é€šçŸ¥
 * 3 é˜²æ­¢è™šå‡å”¤é†’ç”¨while
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotifyWaitDemoOne</span>
<span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
     <span class="nc">ShareDataOne</span> <span class="n">sd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShareDataOne</span><span class="o">();</span>
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">decrement</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">ShareDataOne</span><span class="c1">//èµ„æºç±»</span>
<span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//åˆå§‹å€¼ä¸ºé›¶çš„ä¸€ä¸ªå˜é‡</span>
 
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> 
  <span class="o">{</span>
     <span class="c1">//1åˆ¤æ–­</span>
    <span class="c1">//è¿™é‡Œä¼šå­˜åœ¨è™šå‡å”¤é†’é—®é¢˜</span>
     <span class="k">if</span><span class="o">(</span><span class="n">number</span> <span class="o">!=</span><span class="mi">0</span> <span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
     <span class="o">}</span>
     <span class="c1">//2å¹²æ´»</span>
     <span class="o">++</span><span class="n">number</span><span class="o">;</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t"</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
     <span class="c1">//3é€šçŸ¥</span>
     <span class="k">this</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
  <span class="o">}</span>
  
  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">decrement</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> 
  <span class="o">{</span>
     <span class="c1">// 1åˆ¤æ–­</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
     <span class="o">}</span>
     <span class="c1">// 2å¹²æ´»</span>
     <span class="o">--</span><span class="n">number</span><span class="o">;</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">number</span><span class="o">);</span>
     <span class="c1">// 3é€šçŸ¥</span>
     <span class="k">this</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/*
A  1
B  0
A  1
B  0
A  1
B  0
A  1
B  0
A  1
B  0

*/</span>
</code></pre></div></div>

<h4 id="è™šå‡å”¤é†’">è™šå‡å”¤é†’</h4>

<ul>
  <li>æ¢æˆ4ä¸ªçº¿ç¨‹ï¼ˆä¸¤ä¸ªçº¿ç¨‹åŠ ï¼Œä¸¤ä¸ªçº¿ç¨‹å‡ï¼‰ä¼šå¯¼è‡´é”™è¯¯ï¼Œè™šå‡å”¤é†’ã€‚åŸå› ï¼šåœ¨javaå¤šçº¿ç¨‹åˆ¤æ–­æ—¶ï¼Œä¸èƒ½ç”¨ifï¼Œç¨‹åºå‡ºäº‹å‡ºåœ¨äº†åˆ¤æ–­ä¸Šé¢ï¼Œ
çªç„¶æœ‰ä¸€æ·»åŠ çš„çº¿ç¨‹è¿›åˆ°ifäº†ï¼Œçªç„¶ä¸­æ–­äº†äº¤å‡ºæ§åˆ¶æƒï¼Œæ²¡æœ‰è¿›è¡ŒéªŒè¯ï¼Œè€Œæ˜¯ç›´æ¥èµ°ä¸‹å»äº†ï¼ŒåŠ äº†ä¸¤æ¬¡ï¼Œç”šè‡³å¤šæ¬¡</li>
  <li>ä¸­æ–­å’Œè™šå‡å”¤é†’æ˜¯å¯èƒ½äº§ç”Ÿçš„ï¼Œæ‰€ä»¥è¦ç”¨loopå¾ªç¯ï¼Œifåªåˆ¤æ–­ä¸€æ¬¡ï¼Œwhileæ˜¯åªè¦å”¤é†’å°±è¦æ‹‰å›æ¥å†åˆ¤æ–­ä¸€æ¬¡ã€‚ifæ¢æˆwhile</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">//åˆ¤æ–­</span>
     <span class="k">while</span><span class="o">(</span><span class="n">number</span><span class="o">!=</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">this</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
     <span class="o">}</span>
     <span class="c1">//å¹²æ´»</span>
     <span class="o">--</span><span class="n">number</span><span class="o">;</span>
     <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" \t "</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
     <span class="c1">//é€šçŸ¥</span>
     <span class="k">this</span><span class="o">.</span><span class="na">notifyAll</span><span class="o">();</span>

</code></pre></div></div>

<h4 id="lockconditionsignalå®ç°">lock+condition+signalå®ç°</h4>

<ul>
  <li>Lockæ›¿æ¢synchronizedæ–¹æ³•å’Œè¯­å¥çš„ä½¿ç”¨ï¼Œ Conditionå–ä»£äº†å¯¹è±¡ç›‘è§†å™¨æ–¹æ³•çš„ä½¿ç”¨ã€‚</li>
  <li>ä¸€ä¸ªConditionå®ä¾‹æœ¬è´¨ä¸Šç»‘å®šåˆ°ä¸€ä¸ªé”ã€‚ è¦è·å¾—ç‰¹å®šConditionå®ä¾‹çš„Conditionå®ä¾‹ï¼Œè¯·ä½¿ç”¨å…¶newCondition()æ–¹æ³•ã€‚</li>
  <li>å®˜æ–¹æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">BoundedBuffer</span> <span class="o">{</span>
   <span class="kd">final</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
   <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">notFull</span>  <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span> 
   <span class="kd">final</span> <span class="nc">Condition</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span> 
 
   <span class="kd">final</span> <span class="nc">Object</span><span class="o">[]</span> <span class="n">items</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[</span><span class="mi">100</span><span class="o">];</span>
   <span class="kt">int</span> <span class="n">putptr</span><span class="o">,</span> <span class="n">takeptr</span><span class="o">,</span> <span class="n">count</span><span class="o">;</span>
 
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">Object</span> <span class="n">x</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
     <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
     <span class="k">try</span> <span class="o">{</span>
       <span class="k">while</span> <span class="o">(</span><span class="n">count</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span>
         <span class="n">notFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
       <span class="n">items</span><span class="o">[</span><span class="n">putptr</span><span class="o">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">(++</span><span class="n">putptr</span> <span class="o">==</span> <span class="n">items</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="n">putptr</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
       <span class="o">++</span><span class="n">count</span><span class="o">;</span>
       <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
     <span class="o">}</span>
   <span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¡ˆä¾‹å®ç°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>

<span class="cm">/**
 * å¤šçº¿ç¨‹ä¹‹é—´æŒ‰é¡ºåºè°ƒç”¨
 * å®ç°A-B-C
 * AAæ‰“å°5æ¬¡ï¼ŒBBæ‰“å°10æ¬¡ï¼ŒCCæ‰“å°15æ¬¡ï¼Œå¾ªç¯10è½®
 *
 * æ”¹å˜æ ‡å¿—ä½ï¼Œç”¨lockå®ç°ç²¾å‡†å”¤é†’
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadOrderAccess3</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Resource</span> <span class="n">resource</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Resource</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">resource</span><span class="o">.</span><span class="na">print5</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">resource</span><span class="o">.</span><span class="na">print10</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">resource</span><span class="o">.</span><span class="na">print15</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="s">"C"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Resource</span> <span class="o">{</span>
    <span class="c1">//æ ‡å¿—ä½</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="c1">//1:A,2:B,3:C</span>
    <span class="c1">//é”</span>
    <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="c1">//é’¥åŒ™</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition1</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition2</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition3</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print5</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">condition1</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
            <span class="n">condition2</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print10</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">condition2</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">3</span><span class="o">;</span>
            <span class="n">condition3</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print15</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">number</span> <span class="o">!=</span> <span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">condition3</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
            <span class="n">condition1</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.atguigu.thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Condition</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.Lock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantLock</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">org.omg.IOP.Codec</span><span class="o">;</span>
 
<span class="cm">/**
 * 
 * @Description:
 *ç°åœ¨ä¸¤ä¸ªçº¿ç¨‹ï¼Œ
 * å¯ä»¥æ“ä½œåˆå§‹å€¼ä¸ºé›¶çš„ä¸€ä¸ªå˜é‡ï¼Œ
 * å®ç°ä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡åŠ 1ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹è¯¥å˜é‡å‡1ï¼Œ
 * äº¤æ›¿ï¼Œæ¥10è½®ã€‚ 
 *
 *  * ç¬”è®°ï¼šJavaé‡Œé¢å¦‚ä½•è¿›è¡Œå·¥ç¨‹çº§åˆ«çš„å¤šçº¿ç¨‹ç¼–å†™
 * 1 å¤šçº¿ç¨‹å˜æˆæ¨¡æ¿ï¼ˆå¥—è·¯ï¼‰-----ä¸Š
 *     1.1  çº¿ç¨‹    æ“ä½œ    èµ„æºç±»  
 *     1.2  é«˜å†…èš  ä½è€¦åˆ
 * 2 å¤šçº¿ç¨‹å˜æˆæ¨¡æ¿ï¼ˆå¥—è·¯ï¼‰-----ä¸‹
 *     2.1  åˆ¤æ–­
 *     2.2  å¹²æ´»
 *     2.3  é€šçŸ¥
 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NotifyWaitDemo</span>
<span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
     <span class="nc">ShareData</span> <span class="n">sd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ShareData</span><span class="o">();</span>
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
 
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
     
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
 
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">decrement</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
 
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">increment</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"C"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
     <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
 
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sd</span><span class="o">.</span><span class="na">decrement</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">}</span>
     <span class="o">},</span> <span class="s">"D"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
     
  <span class="o">}</span>
<span class="o">}</span>


<span class="kd">class</span> <span class="nc">ShareData</span><span class="c1">//èµ„æºç±»</span>
<span class="o">{</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//åˆå§‹å€¼ä¸ºé›¶çš„ä¸€ä¸ªå˜é‡</span>
 
  <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
  <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition</span>  <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span> 
   
  <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">increment</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> 
  <span class="o">{</span>
     
      <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
         <span class="k">try</span> <span class="o">{</span>
          <span class="c1">//åˆ¤æ–­</span>
          <span class="k">while</span><span class="o">(</span><span class="n">number</span><span class="o">!=</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="c1">//å¹²æ´»</span>
          <span class="o">++</span><span class="n">number</span><span class="o">;</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" \t "</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
          <span class="c1">//é€šçŸ¥</span>
          <span class="n">condition</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
     <span class="o">}</span>
     
  <span class="o">}</span>
  
  
  <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">decrement</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> 
  <span class="o">{</span>
      
      <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
         <span class="k">try</span> <span class="o">{</span>
          <span class="c1">//åˆ¤æ–­</span>
          <span class="k">while</span><span class="o">(</span><span class="n">number</span><span class="o">!=</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="c1">//å¹²æ´»</span>
          <span class="o">--</span><span class="n">number</span><span class="o">;</span>
          <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" \t "</span><span class="o">+</span><span class="n">number</span><span class="o">);</span>
          <span class="c1">//é€šçŸ¥</span>
          <span class="n">condition</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
     <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
       <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
     <span class="o">}</span>
     
  <span class="o">}</span>
<span class="o">}</span>
 
</code></pre></div></div>

<h3 id="çº¿ç¨‹å…«é”">çº¿ç¨‹å…«é”</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/**
 * é¢˜ç›®ï¼šå¤šçº¿ç¨‹8é”
 *
 * 1 æ ‡å‡†è®¿é—®ï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆé‚®ä»¶ï¼‰
 * 2 é‚®ä»¶æ–¹æ³•æš‚åœå››ç§’ï¼ˆåç»­æƒ…å†µéƒ½æ˜¯æš‚åœå››ç§’ï¼‰ï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆé‚®ä»¶ï¼‰
 * 3 æ–°å¢ä¸€ä¸ªæ²¡æœ‰synchronizedçš„æ™®é€šæ–¹æ³•hello(),å…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯helloï¼Ÿï¼ˆhelloï¼‰
 * 4 ä¸¤éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆçŸ­ä¿¡ï¼‰
 * 5 ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸€éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆé‚®ä»¶ï¼‰
 * 6 ä¸¤ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸¤éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆé‚®ä»¶ï¼‰
 * 7 1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸€éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆçŸ­ä¿¡ï¼‰
 * 8 1ä¸ªæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œ1ä¸ªé™æ€åŒæ­¥æ–¹æ³•ï¼Œä¸¤éƒ¨æ‰‹æœºï¼Œå…ˆæ‰“å°é‚®ä»¶è¿˜æ˜¯çŸ­ä¿¡ï¼Ÿï¼ˆçŸ­ä¿¡ï¼‰
 *
 *
 * ç¬”è®°
 * ä¸€ä¸ªå¯¹è±¡é‡Œè¾¹å¦‚æœæœ‰å¤šä¸ªsynchronizedæ–¹æ³•ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªè¦ä¸€ä¸ªçº¿ç¨‹å»è°ƒç”¨å…¶ä¸­ä¸€ä¸ªsynchronizedæ–¹æ³•äº†ï¼Œ
 * å…¶ä»–çº¿ç¨‹éƒ½åªèƒ½ç­‰å¾…ï¼Œæ¢å¥è¯è¯´ï¼ŒæŸä¸€ä¸ªæ—¶åˆ»å†…ï¼Œåªèƒ½æœ‰å”¯ä¸€ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®è¿™äº›synchronizedæ–¹æ³•ï¼Œ
 * é”çš„æ˜¯å½“å‰å¯¹è±¡thisï¼Œè¢«é”å®šåï¼Œå…¶ä»–çš„çº¿ç¨‹éƒ½ä¸èƒ½è¿›å…¥åˆ°å½“å‰å¯¹è±¡çš„å…¶ä»–synchronizedæ–¹æ³•
 *
 * åŠ ä¸ªæ™®é€šæ–¹æ³•åï¼Œå‘ç°å’ŒåŒæ­¥é”æ— å…³
 * æ¢æˆä¸¤ä¸ªå¯¹è±¡åï¼Œä¸æ˜¯åŒä¸€æŠŠé”äº†ï¼Œæ‰€ä»¥äº’ä¸å½±å“
 *
 * æ¢æˆé™æ€åŒæ­¥æ–¹æ³•åï¼Œæƒ…å†µå‘ç”Ÿæ”¹å˜ï¼Œæ­¤æ—¶é”çš„æ˜¯æ•´ä¸ªç±»ï¼ˆclassï¼‰
 *
 * æ‰€æœ‰çš„éé™æ€åŒæ­¥æ–¹æ³•ç”¨çš„éƒ½æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£å°±æ˜¯å®ä¾‹å¯¹è±¡æœ¬èº«
 *
 * synchronizedå®ç°åŒæ­¥çš„åŸºç¡€ï¼Œjavaä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”
 * å…·ä½“è¡¨ç°ä¸ºä»¥ä¸‹ä¸‰ç§å½¢å¼
 * å¯¹äºæ™®é€šåŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯å½“å‰å®ä¾‹å¯¹è±¡
 * å¯¹äºé™æ€åŒæ­¥æ–¹æ³•ï¼Œé”çš„æ˜¯å½“å‰ç±»çš„classå¯¹è±¡
 * å¯¹äºåŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯synchronizedæ‹¬å·é‡Œçš„å¯¹è±¡
 *
 * å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è®¿é—®åŒæ­¥ä»£ç å—æ—¶ï¼Œå®ƒé¦–å…ˆå¿…é¡»å¾—åˆ°é”ï¼Œé€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸æ—¶å¿…é¡»é‡Šæ”¾é”
 *
 * ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œè¯¥å®ä¾‹å¯¹è±¡çš„å…¶ä»–éé™æ€åŒæ­¥æ–¹æ³•å¿…é¡»ç­‰å¾…è·å–é”çš„æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å–é”
 * å¯æ˜¯å…¶ä»–å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•å› ä¸ºè·Ÿè¯¥å®ä¾‹å¯¹è±¡çš„éé™æ€åŒæ­¥æ–¹æ³•ç”¨çš„æ˜¯ä¸åŒçš„é”
 * æ‰€ä»¥æ— éœ€ç­‰å¾…è¯¥å®ä¾‹å¯¹è±¡å·²è·å¾—é”çš„éé™æ€åŒæ­¥æ–¹æ³•é‡Šæ”¾é”å°±å¯ä»¥è·å–ä»–ä»¬è‡ªå·±çš„é”
 *
 * æ‰€æœ‰çš„é™æ€åŒæ­¥æ–¹æ³•ç”¨çš„ä¹Ÿæ˜¯åŒä¸€æŠŠé”ï¼šç±»å¯¹è±¡æœ¬èº«
 * è¿™ä¸¤æŠŠé”ï¼ˆthisï¼Œclassï¼‰æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œæ‰€ä»¥é™æ€åŒæ­¥æ–¹æ³•å’Œéé™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´æ˜¯ä¸ä¼šæœ‰ç«äº‰çš„
 * ä½†æ˜¯ä¸€æ—¦ä¸€ä¸ªé™æ€åŒæ­¥æ–¹æ³•è·å–é”åï¼Œå…¶ä»–çš„é™æ€åŒæ­¥æ–¹æ³•éƒ½å¿…é¡»ç­‰å¾…è¯¥æ–¹æ³•é‡Šæ”¾é”åæ‰èƒ½è·å¾—é”
 * è€Œä¸ç®¡æ˜¯åŒä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œè¿˜æ˜¯ä¸åŒå®ä¾‹å¯¹è±¡çš„é™æ€åŒæ­¥æ–¹æ³•ä¹‹é—´ï¼Œåªè¦ä»–ä»¬åŒä¸€ä¸ªç±»çš„å®ä¾‹å¯¹è±¡
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Lock4</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Phone</span> <span class="n">phone</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Phone</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">phone</span><span class="o">.</span><span class="na">sendEmail</span><span class="o">();</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">phone</span><span class="o">.</span><span class="na">sendSMS</span><span class="o">();</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Phone</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">sendEmail</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----email"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">sendSMS</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----sms"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ­»é”">æ­»é”</h4>

<ul>
  <li>æ­»é”æ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„çº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›å¹²æ¶‰é‚£ä»–ä»¬éƒ½å°†æ— æ³•è¿è¡Œä¸‹å»ï¼Œå¦‚æœç³»ç»Ÿèµ„æºå……è¶³ï¼Œçº¿ç¨‹çš„èµ„æºè¯·æ±‚éƒ½èƒ½å¾—åˆ°æ»¡è¶³ï¼Œæ­»é”å‡ºç°çš„å¯èƒ½æ€§å°±å¾ˆä½ï¼Œå¦åˆ™å°±ä¼šå› äº‰å¤ºæœ‰é™çš„èµ„æºè€Œé™·å…¥æ­»é”ã€‚</li>
</ul>

<p><img src="https://i.loli.net/2020/06/24/zrG1ciJTAjbgZwh.png" alt="image.png" /></p>

<ul>
  <li>æ‰‹å†™ä¸€ä¸ªæ­»é”</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HoldLockThread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lockA</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">lockB</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">HoldLockThread</span><span class="o">(</span><span class="nc">String</span> <span class="n">lockA</span><span class="o">,</span> <span class="nc">String</span> <span class="n">lockB</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockA</span> <span class="o">=</span> <span class="n">lockA</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">lockB</span> <span class="o">=</span> <span class="n">lockB</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lockA</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæŒæœ‰"</span> <span class="o">+</span> <span class="n">lockA</span> <span class="o">+</span> <span class="s">",æƒ³è¦è·å¾—"</span> <span class="o">+</span> <span class="n">lockB</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lockB</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tæŒæœ‰"</span> <span class="o">+</span> <span class="n">lockB</span> <span class="o">+</span> <span class="s">",æƒ³è¦è·å¾—"</span> <span class="o">+</span> <span class="n">lockA</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeadLockDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">lockA</span> <span class="o">=</span> <span class="s">"lockA"</span><span class="o">;</span>
        <span class="nc">String</span> <span class="n">lockB</span> <span class="o">=</span> <span class="s">"lockB"</span><span class="o">;</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">HoldLockThread</span><span class="o">(</span><span class="n">lockA</span><span class="o">,</span> <span class="n">lockB</span><span class="o">),</span> <span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">HoldLockThread</span><span class="o">(</span><span class="n">lockB</span><span class="o">,</span> <span class="n">lockA</span><span class="o">),</span> <span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/*
A æŒæœ‰lockAï¼Œæƒ³è¦è·å¾—lockB
B æŒæœ‰lockBï¼Œæƒ³è¦è·å¾—lockA
*/</span>
</code></pre></div></div>

<ul>
  <li>æ’æŸ¥æ­»é”
    <ul>
      <li>ä½¿ç”¨jpså‘½ä»¤å®šä½è¿›ç¨‹å·</li>
      <li><img src="https://i.loli.net/2020/06/24/4X6QsjfykT3gU5I.png" alt="image.png" /></li>
      <li>ä½¿ç”¨jstackæ‰¾åˆ°æ­»é”ä½ç½®</li>
      <li><img src="https://i.loli.net/2020/06/24/WAu5VOHEFBNm2Tk.png" alt="image.png" /></li>
    </ul>
  </li>
</ul>

<h3 id="é›†åˆä¸å®‰å…¨">é›†åˆä¸å®‰å…¨</h3>

<h4 id="concurrenthashmap">ConcurrentHashMap</h4>

<ul>
  <li>
    <p>HashMapåœ¨é«˜å¹¶å‘æƒ…å†µä¸‹ä¼šå‘ç”Ÿæ­»å¾ªç¯ï¼ˆä»…åœ¨JDK7ä»¥å‰å­˜åœ¨ï¼‰</p>
  </li>
  <li>
    <p>java7ä¸­çš„ConcurrentHashMapæœ€å¤–å±‚æ˜¯å¤šä¸ªsegmentï¼Œæ¯ä¸ªsegmentçš„åº•å±‚æ•°æ®ç»“æ„ä¸HashMapç±»ä¼¼ï¼Œä»ç„¶æ˜¯æ•°ç»„å’Œé“¾è¡¨ç»„æˆçš„æ‹‰é“¾æ³•ã€‚æ¯ä¸ªsegmentä¸Šæœ‰ä¸ªç‹¬ç«‹çš„ReentrantLocké”ï¼Œæ¯ä¸ªsegmentä¹‹é—´äº’ä¸å½±å“ï¼Œæé«˜äº†å¹¶å‘æ•ˆç‡ã€‚</p>
  </li>
  <li>
    <p>ConcurrentHashMapé»˜è®¤æœ‰16ä¸ªsegmentï¼Œæœ€å¤šå¯åŒæ—¶æ”¯æŒ16ä¸ªçº¿ç¨‹å¹¶å‘å†™ï¼ˆæ“ä½œåˆ†åˆ«åˆ†å¸ƒåœ¨ä¸åŒçš„segmentä¸Šï¼‰ï¼Œè¿™ä¸ªé»˜è®¤å€¼å¯ä»¥åœ¨åˆå§‹åŒ–çš„æ—¶å€™è®¾ç½®ä¸ºå…¶ä»–å€¼ï¼Œä½†æ˜¯ä¸€æ—¦åˆå§‹åŒ–ä¹‹åï¼Œæ˜¯ä¸å¯ä»¥æ‰©å®¹çš„</p>
  </li>
  <li>
    <p>putValueæµç¨‹</p>

    <p>åˆ¤æ–­keyï¼Œvalueä¸ä¸ºç©º</p>

    <p>è®¡ç®—hashå€¼</p>

    <p>æ ¹æ®å¯¹åº”ä½ç½®èŠ‚ç‚¹çš„ç±»å‹ï¼Œæ¥èµ‹å€¼ï¼Œæˆ–è€…helpTransferï¼Œæˆ–è€…å¢é•¿é“¾è¡¨ï¼Œæˆ–è€…ç»™çº¢é»‘æ ‘å¢åŠ èŠ‚ç‚¹</p>

    <p>æ£€æŸ¥æ»¡è¶³é˜ˆå€¼å°±çº¢é»‘æ ‘åŒ–</p>

    <p>è¿”å›oldValue</p>
  </li>
  <li>
    <p>getæµç¨‹</p>

    <p>è®¡ç®—hashå€¼</p>

    <p>æ‰¾åˆ°å¯¹åº”ä½ç½®ï¼Œæ ¹æ®æƒ…å†µè¿›è¡Œï¼š</p>

    <p>ç›´æ¥å–å€¼</p>

    <p>çº¢é»‘æ ‘é‡Œæ‰¾å€¼</p>

    <p>éå†é“¾è¡¨å–å€¼</p>

    <p>è¿”å›æ‰¾åˆ°çš„ç»“æœ</p>
  </li>
  <li>
    <p>ç»„åˆæ“ä½œä¸å®‰å…¨</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ç»„åˆæ“ä½œå¹¶ä¸ä¿è¯çº¿ç¨‹å®‰å…¨
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OptionsNotSafe</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">scores</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;();</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">scores</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"å°æ˜"</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="nc">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">OptionsNotSafe</span><span class="o">());</span>
        <span class="nc">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">OptionsNotSafe</span><span class="o">());</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">scores</span><span class="o">);</span>
    <span class="o">}</span>
 
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Integer</span> <span class="n">score</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"å°æ˜"</span><span class="o">);</span>
                <span class="nc">Integer</span> <span class="n">newScore</span> <span class="o">=</span> <span class="n">score</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">b</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"å°æ˜"</span><span class="o">,</span> <span class="n">score</span><span class="o">,</span> <span class="n">newScore</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
 
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ConcurrentHashMap åªèƒ½ä¿è¯æä¾›çš„åŸå­æ€§è¯»å†™æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashSet</span><span class="o">&lt;&gt;();</span><span class="c1">//çº¿ç¨‹ä¸å®‰å…¨</span>
<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArraySet</span><span class="o">&lt;&gt;();</span><span class="c1">//çº¿ç¨‹å®‰å…¨</span>
<span class="c1">//HashSetåº•å±‚æ•°æ®ç»“æ„æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯HashMapã€‚ä½†HashSetçš„addæ˜¯æ”¾ä¸€ä¸ªå€¼ï¼Œè€ŒHashMapæ˜¯æ”¾Kã€Vé”®å€¼å¯¹</span>
 <span class="kd">public</span> <span class="nf">HashSet</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
<span class="o">}</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Object</span> <span class="no">PRESENT</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">();</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="no">PRESENT</span><span class="o">)==</span><span class="kc">null</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//------------------------------------------------------------</span>
<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//çº¿ç¨‹ä¸å®‰å…¨</span>

<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span><span class="c1">//çº¿ç¨‹å®‰å…¨</span>
</code></pre></div></div>

<ul>
  <li>ArrayListåœ¨è¿­ä»£çš„æ—¶å€™å¦‚æœåŒæ—¶å¯¹å…¶è¿›è¡Œä¿®æ”¹å°±ä¼šæŠ›å‡ºjava.util.ConcurrentModificationExceptionå¼‚å¸¸
å¹¶å‘ä¿®æ”¹å¼‚å¸¸</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="mi">30</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">8</span><span class="o">));</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">list</span><span class="o">);</span>
            <span class="o">},</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
 
<span class="c1">//çœ‹ArrayListçš„æºç </span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">ensureCapacityInternal</span><span class="o">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>  <span class="c1">// Increments modCount!!</span>
    <span class="n">elementData</span><span class="o">[</span><span class="n">size</span><span class="o">++]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
<span class="o">}</span>
<span class="c1">//æ²¡æœ‰synchronizedçº¿ç¨‹ä¸å®‰å…¨</span>

</code></pre></div></div>

<ul>
  <li>
    <p>è§£å†³æ–¹æ¡ˆï¼š</p>

    <ul>
      <li>ä½¿ç”¨vector</li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>List&lt;String&gt; list = new Vector&lt;&gt;();
çœ‹Vectorçš„æºç 
public synchronized boolean add(E e) {
    modCount++;
    ensureCapacityHelper(elementCount + 1);
    elementData[elementCount++] = e;
    return true;
}
æœ‰synchronizedçº¿ç¨‹å®‰å…¨

</code></pre></div>    </div>

    <ul>
      <li>ä½¿ç”¨Collections</li>
    </ul>

    <p><img src="https://i.loli.net/2020/06/17/J1l2OsgbSXMrpEZ.png" alt="image.png" /></p>

    <ul>
      <li>å†™æ—¶å¤åˆ¶ï¼šCopyOnWriteArrayListæ˜¯arraylistçš„ä¸€ç§çº¿ç¨‹å®‰å…¨å˜ä½“ï¼Œ
å…¶ä¸­æ‰€æœ‰å¯å˜æ“ä½œï¼ˆaddã€setç­‰ï¼‰éƒ½æ˜¯é€šè¿‡ç”Ÿæˆåº•å±‚æ•°ç»„çš„æ–°å‰¯æœ¬æ¥å®ç°çš„ã€‚</li>
    </ul>

    <p><img src="https://i.loli.net/2020/06/17/bXB4RTAMyjnlcai.png" alt="image.png" /></p>
  </li>
</ul>

<h4 id="jucå†™æ—¶å¤åˆ¶copyonwrite">JUCå†™æ—¶å¤åˆ¶CopyOnWrite</h4>

<ul>
  <li>åˆ›å»ºæ–°å‰¯æœ¬ï¼Œè¯»å†™åˆ†ç¦»</li>
  <li>ä»£æ›¿Vectorå’ŒSynchronizedListï¼Œå°±å’ŒConcurrentHashMapä»£æ›¿SynchronizedMapçš„åŸå› ä¸€æ ·</li>
  <li>è¯»å†™é”è§„åˆ™å‡çº§ï¼šè¯»å–æ˜¯å®Œå…¨ä¸ç”¨åŠ é”çš„ï¼Œå†™å…¥ä¹Ÿä¸ä¼šé˜»å¡è¯»å–æ“ä½œï¼Œåªæœ‰å†™å…¥å’Œå†™å…¥ä¹‹é—´éœ€è¦è¿›è¡ŒåŒæ­¥ç­‰å¾…ï¼›</li>
  <li>æ•°æ®ä¸€è‡´æ€§é—®é¢˜ï¼šCopyOnWriteå®¹å™¨åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸èƒ½ä¿è¯æ•°æ®çš„å®æ—¶ä¸€è‡´æ€§ï¼Œå¦‚æœå¸Œæœ›å†™å…¥çš„æ•°æ®é©¬ä¸Šèƒ½è¯»åˆ°ï¼Œå°±ä¸è¦ä½¿ç”¨CopyOnWriteå®¹å™¨</li>
  <li>
    <p>å†…å­˜å ç”¨é—®é¢˜ï¼šå› ä¸ºCopyOnWriteçš„å†™æ˜¯å¤åˆ¶æœºåˆ¶ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œå†…å­˜ä¸­ä¼šåŒæ—¶é©»æ‰ä¸¤ä¸ªå¯¹è±¡çš„å†…å­˜ã€‚</p>
  </li>
  <li>ä¸åŠ é”æ€§èƒ½æå‡ï¼Œå‡ºé”™è¯¯ï¼ŒåŠ é”æ•°æ®ä¸€è‡´æ€§èƒ½ä¸‹é™</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
<span class="cm">/**
 * Appends the specified element to the end of this list.
 *
 * @param e element to be appended to this list
 * @return {@code true} (as specified by {@link Collection#add})
 */</span>
<span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">add</span><span class="o">(</span><span class="no">E</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">lock</span><span class="o">;</span>
    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">getArray</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">elements</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
        <span class="nc">Object</span><span class="o">[]</span> <span class="n">newElements</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">elements</span><span class="o">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="n">newElements</span><span class="o">[</span><span class="n">len</span><span class="o">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">setArray</span><span class="o">(</span><span class="n">newElements</span><span class="o">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 
 
 <span class="cm">/*
CopyOnWriteå®¹å™¨å³å†™æ—¶å¤åˆ¶çš„å®¹å™¨ã€‚å¾€ä¸€ä¸ªå®¹å™¨æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¾€å½“å‰å®¹å™¨Object[]æ·»åŠ ï¼Œ
è€Œæ˜¯å…ˆå°†å½“å‰å®¹å™¨Object[]è¿›è¡ŒCopyï¼Œå¤åˆ¶å‡ºä¸€ä¸ªæ–°çš„å®¹å™¨Object[] newElementsï¼Œç„¶åå‘æ–°çš„å®¹å™¨Object[] newElementsé‡Œæ·»åŠ å…ƒç´ ã€‚
æ·»åŠ å…ƒç´ åï¼Œå†å°†åŸå®¹å™¨çš„å¼•ç”¨æŒ‡å‘æ–°çš„å®¹å™¨setArray(newElements)ã€‚
è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥å¯¹CopyOnWriteå®¹å™¨è¿›è¡Œå¹¶å‘çš„è¯»ï¼Œè€Œä¸éœ€è¦åŠ é”ï¼Œå› ä¸ºå½“å‰å®¹å™¨ä¸ä¼šæ·»åŠ ä»»ä½•å…ƒç´ ã€‚
æ‰€ä»¥CopyOnWriteå®¹å™¨ä¹Ÿæ˜¯ä¸€ç§è¯»å†™åˆ†ç¦»çš„æ€æƒ³ï¼Œè¯»å’Œå†™ä¸åŒçš„å®¹å™¨ã€‚
 */</span>
 
</code></pre></div></div>

<ul>
  <li>å¯ä»¥ä¿®æ”¹æ•°ç»„å†…å®¹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼šæ¼”ç¤ºCopyOnWriteArrayListå¯ä»¥åœ¨è¿­ä»£çš„è¿‡ç¨‹ä¸­ä¿®æ”¹æ•°ç»„å†…å®¹ï¼Œä½†æ˜¯ArrayListä¸è¡Œï¼Œå¯¹æ¯”
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CopyOnWriteArrayListDemo1</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;();</span>
        <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
 
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"2"</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"3"</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"4"</span><span class="o">);</span>
        <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"5"</span><span class="o">);</span>
 
        <span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">list</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
 
        <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"list is"</span> <span class="o">+</span> <span class="n">list</span><span class="o">);</span>
            <span class="nc">String</span> <span class="n">next</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">next</span><span class="o">);</span>
 
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"2"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="s">"5"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">next</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"3"</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"3 found"</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="callableåˆ›å»ºçº¿ç¨‹">Callableåˆ›å»ºçº¿ç¨‹</h3>

<ul>
  <li>Callableæ¥å£ç±»ä¼¼äºRunnable ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ä¸ºå…¶å®ä¾‹å¯èƒ½ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ç±»è®¾è®¡çš„ã€‚ ç„¶è€Œï¼ŒRunnableä¸è¿”å›ç»“æœï¼Œä¹Ÿä¸èƒ½æŠ›å‡ºè¢«æ£€æŸ¥çš„å¼‚å¸¸ã€‚</li>
  <li>è¿™æ˜¯ä¸€ä¸ªå‡½æ•°å¼æ¥å£ï¼Œå› æ­¤å¯ä»¥ç”¨ä½œlambdaè¡¨è¾¾å¼æˆ–æ–¹æ³•å¼•ç”¨çš„èµ‹å€¼å¯¹è±¡ã€‚</li>
  <li>å¯¹æ¯”runnableï¼š
    <ul>
      <li>æ˜¯å¦æœ‰è¿”å›å€¼</li>
      <li>æ˜¯å¦æŠ›å¼‚å¸¸</li>
      <li>è½åœ°æ–¹æ³•ä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ˜¯runï¼Œä¸€ä¸ªæ˜¯call</li>
    </ul>
  </li>
</ul>

<h4 id="futureå’Œfuturetask">Futureå’ŒFutureTask</h4>

<ul>
  <li>
    <p>å¯ä»¥ç”¨Future.getæ¥è·å–Callableæ¥å£è¿”å›çš„æ‰§è¡Œç»“æœï¼Œå¯ä»¥é€šè¿‡Future.isDone()æ¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆã€‚</p>
  </li>
  <li>
    <p>åœ¨callæ–¹æ³•æœªæ‰§è¡Œå®Œæ¯•ä¹‹å‰ï¼Œè°ƒç”¨getæ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°callæ–¹æ³•è¿”å›äº†ç»“æœåï¼Œæ­¤æ—¶Future.get()æ‰ä¼šå¾—åˆ°ç»“æœï¼Œç„¶åä¸»çº¿ç¨‹æ‰åˆ‡æ¢åˆ°runnableçŠ¶æ€</p>
  </li>
  <li>
    <p>Futureæ˜¯ä¸€ä¸ªå­˜å‚¨å™¨ï¼Œå®ƒå­˜å‚¨äº†callè¿™ä¸ªä»»åŠ¡çš„ç»“æœï¼Œè€Œè¿™ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ä¸ç¡®å®šçš„ã€‚</p>
  </li>
  <li>
    <p>forå¾ªç¯æ‰¹é‡è·å–futureç»“æœæ—¶ï¼Œå®¹æ˜“å‘ç”Ÿä¸€éƒ¨åˆ†çº¿ç¨‹å¾ˆæ…¢çš„æƒ…å†µï¼Œgetæ–¹æ³•è°ƒç”¨æ—¶åº”è¯¥ä½¿ç”¨timeouté™åˆ¶</p>
  </li>
  <li>
    <p>Futureçš„ç”Ÿå‘½å‘¨æœŸä¸èƒ½åé€€ï¼Œå’Œçº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·ï¼Œä¸€æ—¦å…¨éƒ¨æ‰§è¡Œå®Œæ¯•å°±æ°¸ä¹…åœåœ¨å·²å®ŒæˆçŠ¶æ€ã€‚</p>
  </li>
  <li>
    <p>getæ–¹æ³•çš„è¡Œä¸ºå–å†³äºCallableçš„çŠ¶æ€ï¼Œä¸»è¦åˆ†ä¸ºäº”ç§</p>

    <p>ä»»åŠ¡æ­£å¸¸å®Œæˆï¼Œgetæ–¹æ³•ç«‹åˆ»è¿”å›ç»“æœ</p>

    <p>ä»»åŠ¡å°šæœªå®Œæˆï¼ˆæœªå¼€å§‹æˆ–æ‰§è¡Œä¸­ï¼‰ï¼Œgetå°†é˜»å¡ç›´åˆ°ä»»åŠ¡å®Œæˆ</p>

    <p>ä»»åŠ¡æ‰§è¡Œä¸­æŠ›å‡ºExceptionï¼Œgetæ–¹æ³•ä¼šæŠ›å‡ºExecutionException</p>

    <p>ä»»åŠ¡è¢«å–æ¶ˆï¼Œgetæ–¹æ³•æŠ›å‡ºCancellationException</p>

    <p>ä»»åŠ¡è¶…æ—¶ï¼Œgetæ–¹æ³•æœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´é‡è½½æ–¹æ³•ï¼Œè‹¥åˆ°äº†æ—¶é—´è¿˜æœªè·å–åˆ°ç»“æœï¼Œgetæ–¹æ³•æŠ›å‡ºTimeoutExceptionã€‚</p>
  </li>
  <li>
    <p>cancleæ–¹æ³•ï¼šå–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œ</p>

    <p>å¦‚æœè¿™ä¸ªä»»åŠ¡è¿˜æ²¡å¼€å§‹æ‰§è¡Œï¼Œä»»åŠ¡ä¼šè¢«æ­£å¸¸å–æ¶ˆï¼Œæœªæ¥ä¹Ÿä¸ä¼šæ‰§è¡Œï¼Œè¿”å›true</p>

    <p>è‹¥ä»»åŠ¡å·²å®Œæˆæˆ–å·²å–æ¶ˆï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¼šæ‰§è¡Œå¤±è´¥ï¼Œè¿”å›false</p>

    <p>è‹¥ä»»åŠ¡å·²ç»å¼€å§‹æ‰§è¡Œï¼Œåˆ™ä¸ä¼šç›´æ¥å–æ¶ˆä»»åŠ¡ï¼Œè€Œæ˜¯æ ¹æ®å‚æ•°mayInterruptIfRunningåšåˆ¤æ–­</p>
  </li>
  <li>
    <p>FutureTaskæœªæ¥çš„ä»»åŠ¡ï¼Œç”¨å®ƒå°±å¹²ä¸€ä»¶äº‹ï¼Œå¼‚æ­¥è°ƒç”¨</p>
  </li>
  <li>
    <p>mainæ–¹æ³•å°±åƒä¸€ä¸ªå†°ç³–è‘«èŠ¦ï¼Œä¸€ä¸ªä¸ªæ–¹æ³•ç”±mainä¸²èµ·æ¥ã€‚ä½†è§£å†³ä¸äº†ä¸€ä¸ªé—®é¢˜ï¼šæ­£å¸¸è°ƒç”¨æŒ‚èµ·å µå¡é—®é¢˜</p>
  </li>
  <li>
    <p>åœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦æ‰§è¡Œæ¯”è¾ƒè€—æ—¶çš„æ“ä½œæ—¶ï¼Œä½†åˆä¸æƒ³é˜»å¡ä¸»çº¿ç¨‹æ—¶ï¼Œå¯ä»¥æŠŠè¿™äº›ä½œä¸šäº¤ç»™Futureå¯¹è±¡åœ¨åå°å®Œæˆ
å½“ä¸»çº¿ç¨‹å°†æ¥éœ€è¦æ—¶ï¼Œå°±å¯ä»¥é€šè¿‡Futureå¯¹è±¡è·å¾—åå°ä½œä¸šçš„è®¡ç®—ç»“æœæˆ–è€…æ‰§è¡ŒçŠ¶æ€ã€‚</p>

    <p>ä¸€èˆ¬FutureTaskå¤šç”¨äºè€—æ—¶çš„è®¡ç®—ï¼Œä¸»çº¿ç¨‹å¯ä»¥åœ¨å®Œæˆè‡ªå·±çš„ä»»åŠ¡åï¼Œå†å»è·å–ç»“æœã€‚</p>

    <p>ä»…åœ¨è®¡ç®—å®Œæˆæ—¶æ‰èƒ½æ£€ç´¢ç»“æœï¼›å¦‚æœè®¡ç®—å°šæœªå®Œæˆï¼Œåˆ™é˜»å¡ get æ–¹æ³•ã€‚ä¸€æ—¦è®¡ç®—å®Œæˆï¼Œå°±ä¸èƒ½å†é‡æ–°å¼€å§‹æˆ–å–æ¶ˆè®¡ç®—ã€‚getæ–¹æ³•è€Œè·å–ç»“æœåªæœ‰åœ¨è®¡ç®—å®Œæˆæ—¶è·å–ï¼Œå¦åˆ™ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ä»»åŠ¡è½¬å…¥å®ŒæˆçŠ¶æ€ï¼Œç„¶åä¼šè¿”å›ç»“æœæˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚</p>

    <p>åªè®¡ç®—ä¸€æ¬¡ï¼Œgetæ–¹æ³•æ”¾åˆ°æœ€å</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.FutureTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">MyThread2</span> <span class="kd">implements</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"come in callable"</span><span class="o">);</span>
        <span class="k">return</span> <span class="mi">200</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CallableDemo</span> <span class="o">{</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>

        <span class="c1">//FutureTask&lt;Integer&gt; futureTask = new FutureTask(new MyThread2());</span>
        <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">futureTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">(()-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"  come in callable"</span><span class="o">);</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
            <span class="k">return</span> <span class="mi">1024</span><span class="o">;</span>
        <span class="o">});</span>
        <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">futureTask2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">(()-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"  come in callable"</span><span class="o">);</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
            <span class="k">return</span> <span class="mi">2048</span><span class="o">;</span>
        <span class="o">});</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">futureTask</span><span class="o">,</span><span class="s">"zhang3"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="n">futureTask2</span><span class="o">,</span><span class="s">"li4"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">//System.out.println(futureTask.get());</span>
        <span class="c1">//System.out.println(futureTask2.get());</span>
        <span class="c1">//1ã€ä¸€èˆ¬æ”¾åœ¨ç¨‹åºåé¢ï¼Œç›´æ¥è·å–ç»“æœ</span>
        <span class="c1">//2ã€åªä¼šè®¡ç®—ç»“æœä¸€æ¬¡</span>

        <span class="k">while</span><span class="o">(!</span><span class="n">futureTask</span><span class="o">.</span><span class="na">isDone</span><span class="o">()){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"***wait"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">futureTask</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">" come over"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
 
</code></pre></div></div>

<h3 id="jucè¾…åŠ©ç±»">JUCè¾…åŠ©ç±»</h3>

<ul>
  <li>æ§åˆ¶å¹¶å‘æµç¨‹çš„å·¥å…·ç±»ï¼Œä½œç”¨å°±æ˜¯å¸®åŠ©çº¿ç¨‹ä¹‹é—´çš„åˆä½œ</li>
  <li>â€‹</li>
</ul>

<h4 id="countdownlatchå‡å°‘è®¡æ•°">CountDownLatchå‡å°‘è®¡æ•°</h4>

<ul>
  <li>
    <p>æ•°é‡é€’å‡åˆ°0æ—¶è§¦å‘ï¼Œè®©ä¸€äº›çº¿ç¨‹é˜»å¡ç›´åˆ°å¦ä¸€äº›çº¿ç¨‹å®Œæˆä¸€ç³»åˆ—æ“ä½œåæ‰è¢«å”¤é†’ã€‚</p>
  </li>
  <li>CountDownLatchä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå½“ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹è°ƒç”¨awaitæ–¹æ³•æ—¶ï¼Œè¿™äº›çº¿ç¨‹ä¼šé˜»å¡ã€‚</li>
  <li>å…¶å®ƒçº¿ç¨‹è°ƒç”¨countDownæ–¹æ³•ä¼šå°†è®¡æ•°å™¨å‡1(è°ƒç”¨countDownæ–¹æ³•çš„çº¿ç¨‹ä¸ä¼šé˜»å¡)ï¼Œå½“è®¡æ•°å™¨çš„å€¼å˜ä¸º0æ—¶ï¼Œå› awaitæ–¹æ³•é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œç»§ç»­æ‰§è¡Œã€‚</li>
  <li>CountDownLatchæ˜¯ä¸èƒ½é‡ç”¨çš„ï¼Œå¦‚æœéœ€è¦é‡æ–°è®¡æ•°ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨CyclicBarrieræˆ–è€…åˆ›å»ºæ–°çš„CountDownLatchå®ä¾‹ã€‚</li>
  <li>ä¸€ç­‰å¤š</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.atguigu.thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>
 
<span class="cm">/**
 * 
 * è§£é‡Šï¼š6ä¸ªåŒå­¦é™†ç»­ç¦»å¼€æ•™å®¤åå€¼ç­åŒå­¦æ‰å¯ä»¥å…³é—¨ã€‚
 * 
 * mainä¸»çº¿ç¨‹å¿…é¡»è¦ç­‰å‰é¢6ä¸ªçº¿ç¨‹å®Œæˆå…¨éƒ¨å·¥ä½œåï¼Œè‡ªå·±æ‰èƒ½å¼€å¹² 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchDemo</span>
<span class="o">{</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span>
   <span class="o">{</span>
         <span class="nc">CountDownLatch</span> <span class="n">countDownLatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">6</span><span class="o">);</span>
       
       <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span><span class="mi">6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="c1">//6ä¸ªä¸Šè‡ªä¹ çš„åŒå­¦ï¼Œå„è‡ªç¦»å¼€æ•™å®¤çš„æ—¶é—´ä¸ä¸€è‡´</span>
       <span class="o">{</span>
          <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t å·åŒå­¦ç¦»å¼€æ•™å®¤"</span><span class="o">);</span>
              <span class="c1">//è®¡æ•°å™¨å‡ä¸€</span>
              <span class="n">countDownLatch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
          <span class="o">},</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
       <span class="o">}</span>
       <span class="c1">//ç›´åˆ°è®¡æ•°å™¨å‡ä¸º0æ‰ç»§ç»­è¿è¡Œ</span>
       <span class="n">countDownLatch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
       <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t****** ç­é•¿å…³é—¨èµ°äººï¼Œmainçº¿ç¨‹æ˜¯ç­é•¿"</span><span class="o">);</span>
          
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>å¤šç­‰ä¸€</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¨¡æ‹Ÿ100ç±³è·‘æ­¥ï¼Œ5åé€‰æ‰‹éƒ½å‡†å¤‡å¥½äº†ï¼Œåªç­‰è£åˆ¤å‘˜ä¸€å£°ä»¤ä¸‹ï¼Œæ‰€æœ‰äººåŒæ—¶å¼€å§‹è·‘æ­¥ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchDemo2</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">CountDownLatch</span> <span class="n">begin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">no</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
            <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No."</span> <span class="o">+</span> <span class="n">no</span> <span class="o">+</span> <span class="s">"å‡†å¤‡å®Œæ¯•ï¼Œç­‰å¾…å‘ä»¤æª"</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">begin</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No."</span> <span class="o">+</span> <span class="n">no</span> <span class="o">+</span> <span class="s">"å¼€å§‹è·‘æ­¥äº†"</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//è£åˆ¤å‘˜æ£€æŸ¥å‘ä»¤æª...</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘ä»¤æªå“ï¼Œæ¯”èµ›å¼€å§‹ï¼"</span><span class="o">);</span>
        <span class="n">begin</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç»“åˆ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¨¡æ‹Ÿ100ç±³è·‘æ­¥ï¼Œ5åé€‰æ‰‹éƒ½å‡†å¤‡å¥½äº†ï¼Œåªç­‰è£åˆ¤å‘˜ä¸€å£°ä»¤ä¸‹ï¼Œæ‰€æœ‰äººåŒæ—¶å¼€å§‹è·‘æ­¥ã€‚å½“æ‰€æœ‰äººéƒ½åˆ°ç»ˆç‚¹åï¼Œæ¯”èµ›ç»“æŸã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CountDownLatchDemo1And2</span> <span class="o">{</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">CountDownLatch</span> <span class="n">begin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
 
        <span class="nc">CountDownLatch</span> <span class="n">end</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CountDownLatch</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="nc">ExecutorService</span> <span class="n">service</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">no</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
            <span class="nc">Runnable</span> <span class="n">runnable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No."</span> <span class="o">+</span> <span class="n">no</span> <span class="o">+</span> <span class="s">"å‡†å¤‡å®Œæ¯•ï¼Œç­‰å¾…å‘ä»¤æª"</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">begin</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No."</span> <span class="o">+</span> <span class="n">no</span> <span class="o">+</span> <span class="s">"å¼€å§‹è·‘æ­¥äº†"</span><span class="o">);</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">((</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="o">));</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"No."</span> <span class="o">+</span> <span class="n">no</span> <span class="o">+</span> <span class="s">"è·‘åˆ°ç»ˆç‚¹äº†"</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">end</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">};</span>
            <span class="n">service</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">runnable</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//è£åˆ¤å‘˜æ£€æŸ¥å‘ä»¤æª...</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘ä»¤æªå“ï¼Œæ¯”èµ›å¼€å§‹ï¼"</span><span class="o">);</span>
        <span class="n">begin</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
 
        <span class="n">end</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ‰€æœ‰äººåˆ°è¾¾ç»ˆç‚¹ï¼Œæ¯”èµ›ç»“æŸ"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="cyclicbarrierå¾ªç¯æ …æ ">CyclicBarrierå¾ªç¯æ …æ </h4>

<ul>
  <li>
    <p>å’ŒCountDownLatchçš„åŒºåˆ«åœ¨äºï¼šCountDownLatchç”¨äºäº‹ä»¶ï¼ŒCyclicBarrierç”¨äºçº¿ç¨‹ã€‚CountDownLatchåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼ŒCyclicBarrierå¯ä»¥å¾ªç¯ä½¿ç”¨</p>
  </li>
  <li>å…è®¸ä¸€ç»„çº¿ç¨‹å…¨éƒ¨ç­‰å¾…å½¼æ­¤è¾¾åˆ°å…±åŒå±éšœç‚¹çš„åŒæ­¥è¾…åŠ©ã€‚ å¾ªç¯é˜»å¡åœ¨æ¶‰åŠå›ºå®šå¤§å°çš„çº¿ç¨‹æ–¹çš„ç¨‹åºä¸­å¾ˆæœ‰ç”¨ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»å¶å°”ç­‰å¾…å½¼æ­¤ã€‚ å±éšœè¢«ç§°ä¸ºå¾ªç¯ ï¼Œå› ä¸ºå®ƒå¯ä»¥åœ¨ç­‰å¾…çš„çº¿ç¨‹è¢«é‡Šæ”¾ä¹‹åé‡æ–°ä½¿ç”¨ã€‚</li>
  <li>çº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„await()æ–¹æ³•ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.atguigu.thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.concurrent.BrokenBarrierException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.CyclicBarrier</span><span class="o">;</span>
 
<span class="cm">/**
 * CyclicBarrier
 * çš„å­—é¢æ„æ€æ˜¯å¯å¾ªç¯ï¼ˆCyclicï¼‰ä½¿ç”¨çš„å±éšœï¼ˆBarrierï¼‰ã€‚å®ƒè¦åšçš„äº‹æƒ…æ˜¯ï¼Œ
 * è®©ä¸€ç»„çº¿ç¨‹åˆ°è¾¾ä¸€ä¸ªå±éšœï¼ˆä¹Ÿå¯ä»¥å«åŒæ­¥ç‚¹ï¼‰æ—¶è¢«é˜»å¡ï¼Œ
 * ç›´åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœæ—¶ï¼Œå±éšœæ‰ä¼šå¼€é—¨ï¼Œæ‰€æœ‰
 * è¢«å±éšœæ‹¦æˆªçš„çº¿ç¨‹æ‰ä¼šç»§ç»­å¹²æ´»ã€‚
 * çº¿ç¨‹è¿›å…¥å±éšœé€šè¿‡CyclicBarrierçš„await()æ–¹æ³•ã€‚
 * 
 * é›†é½7é¢—é¾™ç å°±å¯ä»¥å¬å”¤ç¥é¾™
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CyclicBarrierDemo</span>
<span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">NUMBER</span> <span class="o">=</span> <span class="mi">7</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
     <span class="c1">//CyclicBarrier(int parties, Runnable barrierAction) </span>
     
     <span class="nc">CyclicBarrier</span> <span class="n">cyclicBarrier</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CyclicBarrier</span><span class="o">(</span><span class="no">NUMBER</span><span class="o">,</span> <span class="o">()-&gt;{</span><span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"*****é›†é½7é¢—é¾™ç å°±å¯ä»¥å¬å”¤ç¥é¾™"</span><span class="o">);})</span> <span class="o">;</span>
     
     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
       <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t æ˜Ÿé¾™ç è¢«æ”¶é›† "</span><span class="o">);</span>
            <span class="c1">//åœ¨æ …æ å‰ç­‰å¾…å…¶ä»–çº¿ç¨‹ï¼Œå½“å‡‘å¤Ÿ7ä¸ªçº¿ç¨‹åœ¨æ­¤ç­‰å¾…æ—¶æ‰ä¼šå¼€é—¨</span>
            <span class="n">cyclicBarrier</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="o">|</span> <span class="nc">BrokenBarrierException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// TODO Auto-generated catch block</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span>
       
       <span class="o">},</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
     <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
æ”¶é›†åˆ°ç¬¬1é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬5é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬2é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬6é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬3é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬4é¢—é¾™ç .
æ”¶é›†åˆ°ç¬¬7é¢—é¾™ç .
å¬å”¤ç¥é¾™
*/</span>
</code></pre></div></div>

<h4 id="semaphoreä¿¡å·ç¯">Semaphoreä¿¡å·ç¯</h4>

<ul>
  <li>å¯ä»¥ç”¨æ¥é™åˆ¶æˆ–ç®¡ç†æ•°é‡æœ‰é™èµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚</li>
  <li>
    <p>ä¿¡å·é‡çš„ä½œç”¨æ˜¯ç»´æŠ¤ä¸€ä¸ªâ€œè®¸å¯è¯â€çš„è®¡æ•°</p>
  </li>
  <li>acquireï¼ˆè·å–ï¼‰ å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨acquireæ“ä½œæ—¶ï¼Œå®ƒè¦ä¹ˆé€šè¿‡æˆåŠŸè·å–ä¿¡å·é‡ï¼ˆä¿¡å·é‡å‡1ï¼‰ï¼Œè¦ä¹ˆä¸€ç›´ç­‰ä¸‹å»ï¼Œç›´åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡ï¼Œæˆ–è¶…æ—¶ã€‚</li>
  <li>releaseï¼ˆé‡Šæ”¾ï¼‰å®é™…ä¸Šä¼šå°†ä¿¡å·é‡çš„å€¼åŠ 1ï¼Œç„¶åå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚</li>
  <li>è·å–å’Œé‡Šæ”¾çš„è®¸å¯è¯æ•°é‡å¿…é¡»ä¸€è‡´ï¼Œæ³¨æ„åœ¨åˆå§‹åŒ–æ—¶è®¾ç½®å…¬å¹³æ€§</li>
  <li>ä¿¡å·é‡ä¸»è¦ç”¨äºä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç”¨äº<strong>å¤šä¸ªå…±äº«èµ„æºçš„äº’æ–¥ä½¿ç”¨</strong>ï¼Œå¦ä¸€ä¸ªç”¨äº<strong>å¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶</strong>ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.atguigu.thread</span><span class="o">;</span>
 
<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Semaphore</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
 
<span class="cm">/**
 * åœ¨ä¿¡å·é‡ä¸Šæˆ‘ä»¬å®šä¹‰ä¸¤ç§æ“ä½œï¼š
 * acquireï¼ˆè·å–ï¼‰ å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨acquireæ“ä½œæ—¶ï¼Œå®ƒè¦ä¹ˆé€šè¿‡æˆåŠŸè·å–ä¿¡å·é‡ï¼ˆä¿¡å·é‡å‡1ï¼‰ï¼Œ
 *             è¦ä¹ˆä¸€ç›´ç­‰ä¸‹å»ï¼Œç›´åˆ°æœ‰çº¿ç¨‹é‡Šæ”¾ä¿¡å·é‡ï¼Œæˆ–è¶…æ—¶ã€‚
 * releaseï¼ˆé‡Šæ”¾ï¼‰å®é™…ä¸Šä¼šå°†ä¿¡å·é‡çš„å€¼åŠ 1ï¼Œç„¶åå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ã€‚
 * 
 * ä¿¡å·é‡ä¸»è¦ç”¨äºä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç”¨äºå¤šä¸ªå…±äº«èµ„æºçš„äº’æ–¥ä½¿ç”¨ï¼Œå¦ä¸€ä¸ªç”¨äºå¹¶å‘çº¿ç¨‹æ•°çš„æ§åˆ¶ã€‚
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SemaphoreDemo</span>
<span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
  <span class="o">{</span>
     <span class="nc">Semaphore</span> <span class="n">semaphore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Semaphore</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span><span class="c1">//æ¨¡æ‹Ÿ3ä¸ªåœè½¦ä½</span>
     
     <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span><span class="mi">6</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="c1">//æ¨¡æ‹Ÿ6éƒ¨æ±½è½¦</span>
     <span class="o">{</span>
       <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
          <span class="k">try</span> 
          <span class="o">{</span>
            <span class="c1">//ä¿¡å·é‡å‡ä¸€</span>
            <span class="n">semaphore</span><span class="o">.</span><span class="na">acquire</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t æŠ¢åˆ°äº†è½¦ä½"</span><span class="o">);</span>
            <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="k">new</span> <span class="nc">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">5</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t------- ç¦»å¼€"</span><span class="o">);</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
          <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="c1">//ä¿¡å·é‡åŠ ä¸€</span>
            <span class="n">semaphore</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
          <span class="o">}</span>
       <span class="o">},</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
     <span class="o">}</span>
     
  <span class="o">}</span>
<span class="o">}</span>

<span class="cm">/*
1  æŠ¢åˆ°è½¦ä½.
3  æŠ¢åˆ°è½¦ä½.
2  æŠ¢åˆ°è½¦ä½.
1  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.
3  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.
6  æŠ¢åˆ°è½¦ä½.
4  æŠ¢åˆ°è½¦ä½.
2  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.
5  æŠ¢åˆ°è½¦ä½.
4  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.
6  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.
5  åœè½¦3ç§’é’Ÿåç¦»å¼€è½¦ä½.

*/</span>
</code></pre></div></div>

<h4 id="conditionæ¥å£">Conditionæ¥å£</h4>

<ul>
  <li>å½“çº¿ç¨‹1éœ€è¦ç­‰å¾…æŸä¸ªæ¡ä»¶æ—¶ï¼Œå®ƒå°±å»æ‰§è¡Œcondition.await()æ–¹æ³•ï¼Œä¸€æ—¦æ‰§è¡Œäº†await()æ–¹æ³•ï¼Œçº¿ç¨‹å°±ä¼šè¿›å…¥awaitçŠ¶æ€ã€‚</li>
  <li>ç„¶åé€šå¸¸ä¼šæœ‰å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œå‡è®¾æ˜¯çº¿ç¨‹2ï¼Œå»æ‰§è¡Œå¯¹åº”çš„æ¡ä»¶ï¼Œç›´åˆ°è¿™ä¸ªæ¡ä»¶è¾¾æˆçš„æ—¶å€™ï¼Œçº¿ç¨‹2å°±ä¼šå»æ‰§è¡Œcondition.signal()æ–¹æ³•ï¼Œè¿™æ—¶JVMå°±ä¼šä»è¢«é˜»å¡çš„çº¿ç¨‹é‡Œæ‰¾å“ªäº›ç­‰å¾…è¯¥conditionçš„çº¿ç¨‹ï¼Œå½“çº¿ç¨‹1æ”¶åˆ°å¯æ‰§è¡Œä¿¡å·æ—¶ï¼Œä»–å°±ä¼šå˜ä¸ºrunnableå¯æ‰§è¡ŒçŠ¶æ€ã€‚</li>
  <li>signalAllä¼šå”¤é†’æ‰€æœ‰åœ¨ç­‰å¾…çš„çº¿ç¨‹</li>
  <li>signalæ˜¯å…¬å¹³çš„ï¼Œåªä¼šå”¤é†’é‚£ä¸ªç­‰å¾…æ—¶é—´æœ€é•¿çš„</li>
  <li>Lockç”¨æ¥ä»£æ›¿synchronizedï¼Œconditionæ¥ä»£æ›¿Object.await/notifyï¼›awaitè‡ªåŠ¨é‡Šæ”¾æ‰€æŒæœ‰çš„locké”ï¼Œè°ƒç”¨awaitå¿…é¡»æŒæœ‰é”ï¼Œå¦åˆ™æŠ¥é”™ã€‚</li>
  <li>åŸºæœ¬ä½¿ç”¨</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºConditionçš„åŸºæœ¬ç”¨æ³•
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConditionDemo1</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">ReentrantLock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
 
    <span class="kt">void</span> <span class="nf">method1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¼€å§‹await"</span><span class="o">);</span>
            <span class="n">condition</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¡ä»¶æ»¡è¶³äº†ï¼Œå¼€å§‹æ‰§è¡Œåç»­çš„ä»»åŠ¡"</span><span class="o">);</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kt">void</span> <span class="nf">method2</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span><span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡†å¤‡å·¥ä½œå®Œæˆï¼Œå”¤é†’å…¶ä»–çš„çº¿ç¨‹"</span><span class="o">);</span>
            <span class="n">condition</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ConditionDemo1</span> <span class="n">conditionDemo1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConditionDemo1</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                    <span class="n">conditionDemo1</span><span class="o">.</span><span class="na">method2</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="n">conditionDemo1</span><span class="o">.</span><span class="na">method1</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æ¼”ç¤ºç”¨Conditionå®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å¼
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConditionDemo2</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">queueSize</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PriorityQueue</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;(</span><span class="n">queueSize</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantLock</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">notFull</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
    <span class="kd">private</span> <span class="nc">Condition</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ConditionDemo2</span> <span class="n">conditionDemo2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConditionDemo2</span><span class="o">();</span>
        <span class="nc">Producer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">conditionDemo2</span><span class="o">.</span><span class="na">new</span> <span class="nf">Producer</span><span class="o">();</span>
        <span class="nc">Consumer</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">conditionDemo2</span><span class="o">.</span><span class="na">new</span> <span class="nf">Consumer</span><span class="o">();</span>
        <span class="n">producer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">consumer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
 
    <span class="kd">class</span> <span class="nc">Consumer</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
 
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">consume</span><span class="o">();</span>
        <span class="o">}</span>
 
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">consume</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é˜Ÿåˆ—ç©ºï¼Œç­‰å¾…æ•°æ®"</span><span class="o">);</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">notEmpty</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">poll</span><span class="o">();</span>
                    <span class="n">notFull</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä»é˜Ÿåˆ—é‡Œå–èµ°äº†ä¸€ä¸ªæ•°æ®ï¼Œé˜Ÿåˆ—å‰©ä½™"</span> <span class="o">+</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">"ä¸ªå…ƒç´ "</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">class</span> <span class="nc">Producer</span> <span class="kd">extends</span> <span class="nc">Thread</span> <span class="o">{</span>
 
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">produce</span><span class="o">();</span>
        <span class="o">}</span>
 
        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">produce</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="n">queueSize</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"é˜Ÿåˆ—æ»¡ï¼Œç­‰å¾…æœ‰ç©ºä½™"</span><span class="o">);</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">notFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="n">notEmpty</span><span class="o">.</span><span class="na">signalAll</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‘é˜Ÿåˆ—æ’å…¥äº†ä¸€ä¸ªå…ƒç´ ï¼Œé˜Ÿåˆ—å‰©ä½™ç©ºé—´"</span> <span class="o">+</span> <span class="o">(</span><span class="n">queueSize</span> <span class="o">-</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<h3 id="aqs">AQS</h3>

<ul>
  <li>AQSæ˜¯ä¸€ä¸ªç”¨æ¥æ„å»ºé”ï¼ŒåŒæ­¥å™¨ï¼Œåä½œå·¥å…·ç±»çš„å·¥å…·ç±»ï¼ˆæ¡†æ¶ï¼‰ã€‚</li>
  <li>AQSå…¨åä¸ºAbstractQueuedSynchronizerï¼Œä»java5åŠ å…¥çš„ä¸€ä¸ªåŸºäºFIFOç­‰å¾…é˜Ÿåˆ—å®ç°çš„ä¸€ä¸ªåŒæ­¥å™¨çš„åŸºç¡€æ¡†æ¶ã€‚</li>
</ul>

<h4 id="ä¸‰è¦ç´ ">ä¸‰è¦ç´ </h4>

<ul>
  <li>
    <p>AQSæœ€æ ¸å¿ƒçš„ä¸‰å¤§éƒ¨åˆ†</p>

    <p>state</p>

    <p>æ§åˆ¶çº¿ç¨‹æŠ¢é”çš„FIFOé˜Ÿåˆ—</p>

    <p>åä½œå·¥å…·ç±»å»å®ç°è·å–å’Œé‡Šæ”¾ç­‰æ–¹æ³•</p>
  </li>
  <li>
    <p>stateä¼šæ ¹æ®å®ç°ç±»çš„ä¸åŒè€Œä¸åŒã€‚åœ¨Semaphoreé‡Œä»£è¡¨â€œå‰©ä½™çš„è®¸å¯è¯æ•°é‡â€ï¼›åœ¨CountDownLatchä¸­è¡¨ç¤ºâ€œè¿˜éœ€è¦å€’æ•°çš„æ•°é‡â€ã€‚stateæ˜¯ç”¨volatileä¿®é¥°çš„ï¼Œä¼šè¢«å¹¶å‘çš„ä¿®æ”¹ï¼Œæ‰€æœ‰ä¿®æ”¹stateçš„æ–¹æ³•ï¼ˆgetStateï¼ŒsetStateï¼ŒcompareAndSetStateï¼‰éƒ½è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼›åœ¨ReentrantLockä¸­è¡¨ç¤ºé”çš„å æœ‰æƒ…å†µï¼ŒåŒ…æ‹¬å¯é‡å…¥è®¡æ•°ã€‚å½“stateä¸º0æ—¶ï¼Œæ ‡è¯†è¿™ä¸ªlockä¸è¢«ä»»ä½•çº¿ç¨‹æ‰€æŒæœ‰ï¼›</p>
  </li>
  <li>
    <p>è¿™ä¸ªFIFOé˜Ÿåˆ—æ˜¯ç”¨æ¥å­˜æ”¾â€œç­‰å¾…çš„çº¿ç¨‹â€ï¼ŒAQSå°±æ˜¯æ’é˜Ÿç®¡ç†å™¨ï¼Œå½“å¤šä¸ªçº¿ç¨‹å¾ç”¨åŒä¸€æŠŠé”æ—¶ï¼Œå¿…é¡»æœ‰æ’é˜Ÿæœºåˆ¶å°†é‚£äº›æ²¡èƒ½æ‹¿åˆ°é”çš„çº¿ç¨‹ä¸²è”åœ¨ä¸€èµ·ï¼Œå½“é”é‡Šæ”¾æ—¶ï¼Œé”ç®¡ç†å™¨å°±ä¼šæŒ‘é€‰ä¸€ä¸ªåˆé€‚çš„çº¿ç¨‹æ¥å æœ‰è¿™ä¸ªåˆšåˆšé‡Šæ”¾çš„é”ã€‚</p>
  </li>
</ul>

<h4 id="åœ¨countdownlatchä¸­åº”ç”¨">åœ¨CountDownLatchä¸­åº”ç”¨</h4>

<ul>
  <li>è°ƒç”¨awaitæ–¹æ³•æ—¶ï¼Œä¾¿ä¼šå°è¯•è·å–â€œå…±äº«é”â€ï¼Œä½†æ˜¯ä¸€å¼€å§‹æ˜¯è·å–ä¸åˆ°é”çš„ï¼Œçº¿ç¨‹è¢«é˜»å¡ã€‚</li>
  <li>å…±äº«é”è¢«è·å–åˆ°çš„æ¡ä»¶å°±æ˜¯é”è®¡æ•°å™¨çš„å€¼ä¸º0ï¼›é”è®¡æ•°å™¨çš„åˆå§‹å€¼ä¸ºcountï¼Œæ¯å½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨countDownæ–¹æ³•æ—¶ï¼Œæ‰å°†é”è®¡æ•°å™¨å‡ä¸€ã€‚</li>
  <li>countä¸ªçº¿ç¨‹è°ƒç”¨countDownåï¼Œé”è®¡æ•°å™¨æ‰ä¸º0ï¼Œå‰é¢ç­‰å¾…é”çš„çº¿ç¨‹æ‰èƒ½ç»§ç»­è¿è¡Œã€‚</li>
</ul>

<h4 id="åœ¨semaphoreä¸­åº”ç”¨">åœ¨Semaphoreä¸­åº”ç”¨</h4>

<ul>
  <li>åœ¨Semaphoreä¸­ï¼Œstateè¡¨ç¤ºè®¸å¯è¯çš„å‰©ä½™æ•°é‡</li>
  <li>tryAcquireæ–¹æ³•ï¼Œåˆ¤æ–­nofairTryAcquireSharedå¤§äºç­‰äº0çš„è¯ï¼Œè¡¨ç¤ºæˆåŠŸã€‚</li>
  <li>å…ˆæ£€æŸ¥å‰©ä½™è®¸å¯è¯æ•°é‡å¤Ÿä¸å¤Ÿè¿™æ¬¡éœ€è¦çš„ï¼Œç”¨å‡æ³•è®¡ç®—ï¼Œå¦‚æœä¸å¤Ÿå°±è¿”å›è´Ÿæ•°ï¼Œè¡¨ç¤ºå¤±è´¥ï¼Œå¦‚æœå¤Ÿäº†ï¼Œå°±ç”¨è‡ªæ—‹åŠ compareAndSetStateæ¥æ”¹å˜stateçŠ¶æ€ï¼Œç›´åˆ°æ”¹å˜æˆåŠŸå°±è¿”å›æ­£æ•°ã€‚å¦‚æœæœŸé—´è¢«äººä¿®æ”¹å¯¼è‡´æ•°é‡ä¸è¶³ä¹Ÿè¿”å›è´Ÿæ•°ã€‚</li>
</ul>

<h4 id="åœ¨reentrantlockä¸­åº”ç”¨">åœ¨ReentrantLockä¸­åº”ç”¨</h4>

<ul>
  <li>é‡Šæ”¾é”çš„æ–¹æ³•tryReleaseï¼šç”±äºæ˜¯å¯é‡å…¥çš„ï¼Œæ‰€ä»¥stateä»£è¡¨å†²å…¥çš„æ¬¡æ•°ï¼Œæ¯æ¬¡é‡Šæ”¾é”ï¼Œå…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯å½“å‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾çš„ï¼Œå¦‚æœä¸æ˜¯å°±æŠ›å¼‚å¸¸ï¼Œå¦‚æœæ˜¯å°±é‡å…¥æ¬¡æ•°å‡ä¸€ï¼Œå¦‚æœå‡åˆ°äº†0ï¼Œå°±è¯´æ˜å®Œå…¨é‡Šæ”¾äº†ï¼Œäºæ˜¯freeå°±æ˜¯trueï¼Œå¹¶ä¸”æŠŠstateè®¾ç½®ä¸º0ã€‚</li>
</ul>

<h3 id="jucè¯»å†™é”">JUCè¯»å†™é”</h3>

<ul>
  <li>å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å’Œå†™ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">MyCache</span><span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span><span class="nc">Object</span> <span class="n">value</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t æ­£åœ¨å†™"</span><span class="o">+</span><span class="n">key</span><span class="o">);</span>
        <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹</span>
        <span class="k">try</span> <span class="o">{</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span><span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> <span class="o">}</span>
        <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t å†™å®Œäº†"</span><span class="o">+</span><span class="n">key</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">){</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t æ­£åœ¨è¯»"</span><span class="o">+</span><span class="n">key</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span><span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span><span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span> <span class="o">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t è¯»å®Œäº†"</span><span class="o">+</span><span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteLockDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyCache</span> <span class="n">myCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCache</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
                <span class="n">myCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">num</span><span class="o">+</span><span class="s">""</span><span class="o">,</span><span class="n">num</span><span class="o">+</span><span class="s">""</span><span class="o">);</span>
            <span class="o">},</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()-&gt;{</span>
                <span class="n">myCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">num</span><span class="o">+</span><span class="s">""</span><span class="o">);</span>
            <span class="o">},</span><span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ReadWriteLockç»´æŠ¤ä¸€å¯¹å…³è”çš„locks ï¼Œä¸€ä¸ªç”¨äºåªè¯»æ“ä½œï¼Œä¸€ä¸ªç”¨äºå†™å…¥ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReadWriteLock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.locks.ReentrantReadWriteLock</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">MyCache</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="kd">private</span> <span class="nc">ReadWriteLock</span> <span class="n">rwLock</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ReentrantReadWriteLock</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">rwLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t æ­£åœ¨å†™"</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
            <span class="c1">//æš‚åœä¸€ä¼šå„¿çº¿ç¨‹</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">map</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t å†™å®Œäº†"</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">rwLock</span><span class="o">.</span><span class="na">writeLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="nc">Object</span> <span class="nf">get</span><span class="o">(</span><span class="nc">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">rwLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">lock</span><span class="o">();</span>
        <span class="nc">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t æ­£åœ¨è¯»"</span> <span class="o">+</span> <span class="n">key</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t è¯»å®Œäº†"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">rwLock</span><span class="o">.</span><span class="na">readLock</span><span class="o">().</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteLockDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MyCache</span> <span class="n">myCache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyCache</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">myCache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">""</span><span class="o">,</span> <span class="n">num</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
            <span class="o">},</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="n">myCache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
            <span class="o">},</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
</code></pre></div></div>

<h3 id="jucé˜»å¡é˜Ÿåˆ—">JUCé˜»å¡é˜Ÿåˆ—</h3>

<ul>
  <li>å½“é˜Ÿåˆ—æ˜¯ç©ºçš„ï¼Œä»é˜Ÿåˆ—ä¸­è·å–å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡</li>
  <li>å½“é˜Ÿåˆ—æ˜¯æ»¡çš„ï¼Œä»é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ çš„æ“ä½œå°†ä¼šè¢«é˜»å¡</li>
  <li>åœ¨å¤šçº¿ç¨‹é¢†åŸŸï¼šæ‰€è°“é˜»å¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ä¼šæŒ‚èµ·çº¿ç¨‹ï¼ˆå³é˜»å¡ï¼‰ï¼Œä¸€æ—¦æ¡ä»¶æ»¡è¶³ï¼Œè¢«æŒ‚èµ·çš„çº¿ç¨‹åˆä¼šè‡ªåŠ¨è¢«å”¤èµ·</li>
  <li>å¥½å¤„æ˜¯æˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»€ä¹ˆæ—¶å€™éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºè¿™ä¸€åˆ‡BlockingQueueéƒ½ç»™ä½ ä¸€æ‰‹åŒ…åŠäº†ã€‚åœ¨concurrentåŒ…å‘å¸ƒä»¥å‰ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬æ¯ä¸ªç¨‹åºå‘˜éƒ½å¿…é¡»å»è‡ªå·±æ§åˆ¶è¿™äº›ç»†èŠ‚ï¼Œå°¤å…¶è¿˜è¦å…¼é¡¾æ•ˆç‡å’Œçº¿ç¨‹å®‰å…¨ï¼Œè€Œè¿™ä¼šç»™æˆ‘ä»¬çš„ç¨‹åºå¸¦æ¥ä¸å°çš„å¤æ‚åº¦ã€‚</li>
</ul>

<h4 id="ç§ç±»åˆ†æ">ç§ç±»åˆ†æ</h4>

<ul>
  <li><strong>ArrayBlockingQueue</strong>ï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
  <li><strong>LinkedBlockingQueue</strong>ï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œï¼ˆä½†å¤§å°é»˜è®¤å€¼ä¸ºinteger.MAX_VALUEï¼‰é˜»å¡é˜Ÿåˆ—ã€‚</li>
  <li>PriorityBlockingQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
  <li>DelayQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
  <li><strong>SynchronousQueue</strong>ï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œä¹Ÿå³å•ä¸ªå…ƒç´ çš„é˜Ÿåˆ—ã€‚æ²¡æœ‰å®¹é‡ï¼Œæ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»è¦ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ï¼Œåä¹‹äº¦ç„¶ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SynchronousQueueDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;&gt;();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t put 1."</span><span class="o">);</span>
                <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"1"</span><span class="o">);</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t put 2."</span><span class="o">);</span>
                <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"2"</span><span class="o">);</span>

                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t put 3."</span><span class="o">);</span>
                <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"3"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"A"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>

        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t take"</span> <span class="o">+</span> <span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>

                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t take"</span> <span class="o">+</span> <span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>

                <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t take"</span> <span class="o">+</span> <span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">},</span> <span class="s">"B"</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
 <span class="cm">/*
A  put 1.
3så
B  take1
A  put 2.
3så
B  take2
A  put 3.
3så
B  take3
*/</span>
</code></pre></div></div>

<ul>
  <li>LinkedTransferQueueï¼šç”±é“¾è¡¨ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚</li>
  <li>LinkedBlockingDequeï¼šç”±é“¾è¡¨ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚</li>
</ul>

<h4 id="æ ¸å¿ƒæ–¹æ³•">æ ¸å¿ƒæ–¹æ³•</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æ–¹æ³•ç±»å‹</th>
      <th style="text-align: center">æŠ›å‡ºå¼‚å¸¸</th>
      <th style="text-align: center">ç‰¹æ®Šå€¼</th>
      <th style="text-align: center">é˜»å¡</th>
      <th style="text-align: center">è¶…æ—¶</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">æ’å…¥</td>
      <td style="text-align: center">add(e)</td>
      <td style="text-align: center">offer(e)</td>
      <td style="text-align: center">put(e)</td>
      <td style="text-align: center">offer(e,time,unit)</td>
    </tr>
    <tr>
      <td style="text-align: center">ç§»é™¤</td>
      <td style="text-align: center">remove()</td>
      <td style="text-align: center">poll()</td>
      <td style="text-align: center">take()</td>
      <td style="text-align: center">poll(time,unit)</td>
    </tr>
    <tr>
      <td style="text-align: center">æ£€æŸ¥</td>
      <td style="text-align: center">element</td>
      <td style="text-align: center">peek()</td>
      <td style="text-align: center">ä¸å¯ç”¨</td>
      <td style="text-align: center">ä¸å¯ç”¨</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æŠ›å‡ºå¼‚å¸¸</th>
      <th style="text-align: center">å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œaddæ’å…¥å…ƒç´ ä¼šæŠ›IllegalStateException:Queue fullã€‚å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œå†å¾€é˜Ÿåˆ—é‡Œremoveç§»é™¤å…ƒç´ ä¼šæŠ›NoSuchElementException</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">ç‰¹æ®Šå€¼</td>
      <td style="text-align: center">æ’å…¥æ–¹æ³•ï¼ŒæˆåŠŸtureå¤±è´¥falseã€‚ç§»é™¤æ–¹æ³•ï¼ŒæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—çš„å…ƒç´ ï¼Œé˜Ÿåˆ—é‡Œæ²¡æœ‰å°±è¿”å›null</td>
    </tr>
    <tr>
      <td style="text-align: center">ä¸€ç›´é˜»å¡</td>
      <td style="text-align: center">å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç»§ç»­å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ç›´åˆ°putæ•°æ®orå“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—å¯ç”¨</td>
    </tr>
    <tr>
      <td style="text-align: center">è¶…æ—¶é€€å‡º</td>
      <td style="text-align: center">å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">"main"</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">:</span> <span class="nc">Queue</span> <span class="n">full</span>
<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">element</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">remove</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">"main"</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">NoSuchElementException</span>
<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">peek</span><span class="o">());</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">false</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="kc">null</span>
<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>
        <span class="n">blockingQueue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"a"</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">take</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="mi">2</span><span class="n">så</span><span class="err">ï¼Œ</span>
<span class="kc">false</span>
<span class="o">-------------------------------------------------------------------------</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BlockingQueueDemo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">blockingQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="s">"a"</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">blockingQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="kc">true</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="n">a</span>
<span class="mi">2</span><span class="n">så</span><span class="err">ï¼Œ</span>
<span class="kc">null</span>

</code></pre></div></div>

<h3 id="threadpoolçº¿ç¨‹æ± ">ThreadPoolçº¿ç¨‹æ± </h3>

<ul>
  <li>çº¿ç¨‹æ± åšçš„å·¥ä½œåªè¦æ˜¯<strong>æ§åˆ¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡</strong>ï¼Œå¤„ç†è¿‡ç¨‹ä¸­å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œç„¶ååœ¨çº¿ç¨‹åˆ›å»ºåå¯åŠ¨è¿™äº›ä»»åŠ¡ï¼Œå¦‚æœçº¿ç¨‹æ•°é‡è¶…è¿‡äº†æœ€å¤§æ•°é‡ï¼Œè¶…å‡ºæ•°é‡çš„çº¿ç¨‹æ’é˜Ÿç­‰å€™ï¼Œç­‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡æ¥æ‰§è¡Œã€‚</li>
  <li>å®ƒçš„ä¸»è¦ç‰¹ç‚¹ä¸ºï¼šçº¿ç¨‹å¤ç”¨;æ§åˆ¶æœ€å¤§å¹¶å‘æ•°;ç®¡ç†çº¿ç¨‹ã€‚</li>
  <li>ç¬¬ä¸€ï¼šé™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„é”€è€—ã€‚</li>
  <li>ç¬¬äºŒï¼šæé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰å¾…çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚</li>
  <li>ç¬¬ä¸‰ï¼šæé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šé”€è€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚</li>
  <li>Javaä¸­çš„çº¿ç¨‹æ± æ˜¯é€šè¿‡Executoræ¡†æ¶å®ç°çš„ï¼Œè¯¥æ¡†æ¶ä¸­ç”¨åˆ°äº†Executorï¼ŒExecutorsï¼ŒExecutorServiceï¼ŒThreadPoolExecutorè¿™å‡ ä¸ªç±»</li>
</ul>

<p><img src="https://i.loli.net/2020/06/17/145rbgGZymc2ieK.png" alt="image.png" /></p>

<ul>
  <li>â€‹</li>
</ul>

<h4 id="ä¸‰ç§å¸¸ç”¨çº¿ç¨‹æ± ">ä¸‰ç§å¸¸ç”¨çº¿ç¨‹æ± </h4>

<ul>
  <li>
    <p>Executors.newFixedThreadPool(int)ï¼š</p>

    <p>æ‰§è¡Œé•¿æœŸä»»åŠ¡æ€§èƒ½å¥½ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸€æ± æœ‰Nä¸ªå›ºå®šçš„çº¿ç¨‹ï¼Œæœ‰å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newFixedThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="n">nThreads</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">,</span>
                                  <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                                  <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span>
<span class="o">}</span>
   
<span class="c1">//newFixedThreadPoolåˆ›å»ºçš„çº¿ç¨‹æ± corePoolSizeå’ŒmaximumPoolSizeå€¼æ˜¯ç›¸ç­‰çš„ï¼Œå®ƒä½¿ç”¨çš„æ˜¯LinkedBlockingQueue</span>
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ç¬¬4ç§è·å¾—/ä½¿ç”¨javaå¤šçº¿ç¨‹çš„æ–¹å¼â€”â€”çº¿ç¨‹æ± 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThreadPoolDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
       <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>   <span class="c1">//å‡è®¾é“¶è¡Œ5ä¸ªçª—å£</span>
      
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>    <span class="c1">//10ä¸ªäººæ¥åŠä¸šåŠ¡</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tåŠç†ä¸šåŠ¡."</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
pool-1-thread-1    åŠç†ä¸šåŠ¡.
pool-1-thread-3    åŠç†ä¸šåŠ¡.
pool-1-thread-4    åŠç†ä¸šåŠ¡.
pool-1-thread-2    åŠç†ä¸šåŠ¡.
pool-1-thread-4    åŠç†ä¸šåŠ¡.
pool-1-thread-3    åŠç†ä¸šåŠ¡.
pool-1-thread-1    åŠç†ä¸šåŠ¡.
pool-1-thread-5    åŠç†ä¸šåŠ¡.
pool-1-thread-4    åŠç†ä¸šåŠ¡.
pool-1-thread-2    åŠç†ä¸šåŠ¡.
*/</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Executors.newSingleThreadExecutor()</p>

    <p>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹åŒ–çš„çº¿ç¨‹æ± ï¼Œå®ƒåªä¼šç”¨å”¯ä¸€çš„å·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§æŒ‡å®šçš„é¡ºåºæ‰§è¡Œã€‚</p>

    <p>corePoolSizeå’ŒmaximumPoolSizeéƒ½è®¾ç½®ä¸º1ï¼Œå®ƒä½¿ç”¨çš„LinkedBlockingQueueã€‚</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newSingleThreadExecutor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">FinalizableDelegatedExecutorService</span>
        <span class="o">(</span><span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
                                <span class="mi">0L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">,</span>
                                <span class="k">new</span> <span class="nc">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;()));</span>
<span class="o">}</span>
   
<span class="c1">//newSingleThreadExecutor åˆ›å»ºçš„çº¿ç¨‹æ± corePoolSizeå’ŒmaximumPoolSizeå€¼éƒ½æ˜¯1ï¼Œå®ƒä½¿ç”¨çš„æ˜¯LinkedBlockingQueue</span>
</code></pre></div>    </div>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ç¬¬4ç§è·å¾—/ä½¿ç”¨javaå¤šçº¿ç¨‹çš„æ–¹å¼â€”â€”çº¿ç¨‹æ± 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThreadPoolDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
       <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newSingleThreadExecutor</span><span class="o">();</span>   <span class="c1">//å‘¨æœ«é“¶è¡Œåªæœ‰1ä¸ªçª—å£å€¼ç­</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>    <span class="c1">//10ä¸ªäººæ¥åŠä¸šåŠ¡</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tåŠç†ä¸šåŠ¡."</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
*/</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Executors.newCachedThreadPool()</p>

    <p>æ‰§è¡Œå¾ˆå¤šçŸ­æœŸå¼‚æ­¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æ ¹æ®éœ€è¦åˆ›å»ºæ–°çº¿ç¨‹ï¼Œ
ä½†åœ¨å…ˆå‰æ„å»ºçš„çº¿ç¨‹å¯ç”¨æ—¶å°†é‡ç”¨å®ƒä»¬ã€‚å¯æ‰©å®¹ï¼Œé‡å¼ºåˆ™å¼º</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="nc">ExecutorService</span> <span class="nf">newCachedThreadPool</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span>
                                  <span class="mi">60L</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                                  <span class="k">new</span> <span class="nc">SynchronousQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;());</span>
<span class="o">}</span>
<span class="c1">//newCachedThreadPoolåˆ›å»ºçš„çº¿ç¨‹æ± å°†corePoolSizeè®¾ç½®ä¸º0ï¼Œå°†maximumPoolSizeè®¾ç½®ä¸ºInteger.MAX_VALUEï¼Œå®ƒä½¿ç”¨çš„æ˜¯SynchronousQueueï¼Œä¹Ÿå°±æ˜¯è¯´æ¥äº†ä»»åŠ¡å°±åˆ›å»ºçº¿ç¨‹è¿è¡Œï¼Œå½“çº¿ç¨‹ç©ºé—²è¶…è¿‡60ç§’ï¼Œå°±é”€æ¯çº¿ç¨‹ã€‚</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æ¡ˆä¾‹</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ç¬¬4ç§è·å¾—/ä½¿ç”¨javaå¤šçº¿ç¨‹çš„æ–¹å¼â€”â€”çº¿ç¨‹æ± 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThreadPoolDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>   <span class="c1">//ä¸€æ± å¤šä¸ªçº¿ç¨‹,æ ¹æ®å®é™…ä¸šåŠ¡æ‰©å®¹å˜åŠ¨</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>    <span class="c1">//10ä¸ªäººæ¥åŠä¸šåŠ¡</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\tåŠç†ä¸šåŠ¡."</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
pool-1-thread-1åŠç†ä¸šåŠ¡.
pool-1-thread-3åŠç†ä¸šåŠ¡.
pool-1-thread-2åŠç†ä¸šåŠ¡.
pool-1-thread-4åŠç†ä¸šåŠ¡.
pool-1-thread-5åŠç†ä¸šåŠ¡.
pool-1-thread-2åŠç†ä¸šåŠ¡.
pool-1-thread-4åŠç†ä¸šåŠ¡.
pool-1-thread-7åŠç†ä¸šåŠ¡.
pool-1-thread-6åŠç†ä¸šåŠ¡.
pool-1-thread-1åŠç†ä¸šåŠ¡.
  
*/</span>
</code></pre></div></div>

<h4 id="ä¸ƒå¤§å‚æ•°">ä¸ƒå¤§å‚æ•°</h4>

<ul>
  <li>
    <p><strong>corePoolSize</strong>ï¼šçº¿ç¨‹æ± ä¸­çš„å¸¸é©»æ ¸å¿ƒçº¿ç¨‹æ•°</p>

    <p>åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œå½“æœ‰è¯·æ±‚ä»»åŠ¡æ¥ä¹‹åï¼Œå°±ä¼šå®‰æ’æ± ä¸­çš„çº¿ç¨‹å»æ‰§è¡Œè¯·æ±‚ä»»åŠ¡ï¼Œè¿‘ä¼¼ç†è§£ä¸ºä»Šæ—¥å½“å€¼çº¿ç¨‹</p>

    <p>å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ç›®è¾¾åˆ°corePoolSizeåï¼Œå°±ä¼šæŠŠåˆ°è¾¾çš„ä»»åŠ¡æ”¾åˆ°ç¼“å­˜é˜Ÿåˆ—å½“ä¸­ã€‚</p>
  </li>
  <li>
    <p><strong>maximumPoolSize</strong>ï¼šçº¿ç¨‹æ± ä¸­èƒ½å¤Ÿå®¹çº³åŒæ—¶æ‰§è¡Œçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ­¤å€¼å¿…é¡»å¤§äºç­‰äº1</p>
  </li>
  <li>
    <p><strong>keepAliveTime</strong>ï¼šå¤šä½™çš„ç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´å½“å‰æ± ä¸­çº¿ç¨‹æ•°é‡è¶…è¿‡corePoolSizeæ—¶ï¼Œå½“ç©ºé—²æ—¶é—´è¾¾åˆ°keepAliveTimeæ—¶ï¼Œå¤šä½™çº¿ç¨‹ä¼šè¢«é”€æ¯ç›´åˆ°åªå‰©ä¸‹corePoolSizeä¸ªçº¿ç¨‹ä¸ºæ­¢</p>
  </li>
  <li>
    <p><strong>unit</strong>ï¼škeepAliveTimeçš„å•ä½</p>
  </li>
  <li>
    <p><strong>workQueue</strong>ï¼šä»»åŠ¡é˜Ÿåˆ—ï¼Œè¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</p>
  </li>
  <li>
    <p><strong>threadFactory</strong>ï¼šè¡¨ç¤ºç”Ÿæˆçº¿ç¨‹æ± ä¸­å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºçº¿ç¨‹ï¼Œä¸€èˆ¬é»˜è®¤çš„å³å¯</p>
  </li>
  <li>
    <p><strong>handler</strong>ï¼šæ‹’ç»ç­–ç•¥ï¼Œè¡¨ç¤ºå½“é˜Ÿåˆ—æ»¡äº†ï¼Œå¹¶ä¸”å·¥ä½œçº¿ç¨‹å¤§äºç­‰äºçº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°ï¼ˆmaximumPoolSizeï¼‰æ—¶å¦‚ä½•æ¥æ‹’ç»è¯·æ±‚æ‰§è¡Œçš„runnableçš„ç­–ç•¥</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ThreadPoolExecutor</span><span class="o">(</span><span class="kt">int</span> <span class="n">corePoolSize</span><span class="o">,</span>
                          <span class="kt">int</span> <span class="n">maximumPoolSize</span><span class="o">,</span>
                          <span class="kt">long</span> <span class="n">keepAliveTime</span><span class="o">,</span>
                          <span class="nc">TimeUnit</span> <span class="n">unit</span><span class="o">,</span>
                          <span class="nc">BlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;</span> <span class="n">workQueue</span><span class="o">,</span>
                          <span class="nc">ThreadFactory</span> <span class="n">threadFactory</span><span class="o">,</span>
                          <span class="nc">RejectedExecutionHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">corePoolSize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">maximumPoolSize</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span>
        <span class="n">maximumPoolSize</span> <span class="o">&lt;</span> <span class="n">corePoolSize</span> <span class="o">||</span>
        <span class="n">keepAliveTime</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">workQueue</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">threadFactory</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">handler</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NullPointerException</span><span class="o">();</span>
    <span class="k">this</span><span class="o">.</span><span class="na">corePoolSize</span> <span class="o">=</span> <span class="n">corePoolSize</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">maximumPoolSize</span> <span class="o">=</span> <span class="n">maximumPoolSize</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">workQueue</span> <span class="o">=</span> <span class="n">workQueue</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">keepAliveTime</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">keepAliveTime</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">threadFactory</span> <span class="o">=</span> <span class="n">threadFactory</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="åº•å±‚åŸç†-1">åº•å±‚åŸç†</h4>

<ul>
  <li>åœ¨åˆ›å»ºäº†çº¿ç¨‹æ± åï¼Œå¼€å§‹ç­‰å¾…è¯·æ±‚ã€‚</li>
  <li>å½“è°ƒç”¨execute()æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå‡ºå¦‚ä¸‹åˆ¤æ–­ï¼š
    <ul>
      <li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äºcorePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›</li>
      <li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºcorePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼›</li>
      <li>å¦‚æœè¿™ä¸ªæ—¶å€™é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äºmaximumPoolSizeï¼Œé‚£ä¹ˆè¿˜æ˜¯è¦åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡ï¼›</li>
      <li>å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äºmaximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œæ‹’ç»ç­–ç•¥æ¥æ‰§è¡Œã€‚</li>
    </ul>
  </li>
  <li>å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œå®ƒä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œã€‚</li>
  <li>å½“ä¸€ä¸ªçº¿ç¨‹æ— äº‹å¯åšè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹ä¼šåˆ¤æ–­ï¼š
    <ul>
      <li>å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äºcorePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ã€‚</li>
      <li>æ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåï¼Œå®ƒæœ€ç»ˆä¼šæ”¶ç¼©åˆ°corePoolSizeçš„å¤§å°ã€‚</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/06/17/GKFRva23pWbx8Iy.png" alt="image.png" /></p>

<ul>
  <li>éªŒè¯ä»coreæ‰©å®¹åˆ°maximumåï¼Œç«‹å³è¿è¡Œå½“å‰åˆ°è¾¾çš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯é˜Ÿåˆ—ä¸­çš„</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">T1</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span>
                <span class="mi">2</span><span class="o">,</span>
                <span class="mi">5</span><span class="o">,</span>
                <span class="mi">100</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">LinkedBlockingDeque</span><span class="o">&lt;&gt;(</span><span class="mi">3</span><span class="o">),</span>
                <span class="nc">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span>
                <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">AbortPolicy</span><span class="o">()</span>
        <span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="kd">final</span> <span class="kt">int</span> <span class="n">tempInt</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢"</span> <span class="o">+</span> <span class="n">tempInt</span><span class="o">);</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
 
<span class="cm">/*
core=2ï¼Œæ‰€ä»¥1å·çª—å£å¯¹åº”1å·é¡¾å®¢ï¼Œ2å·çª—å£å¯¹åº”2å·é¡¾å®¢ï¼Œä½†æ˜¯æ¥ä¸‹æ¥ï¼Œ3ã€4ã€5å·é¡¾å®¢åˆæ¥äº†ï¼Œè¿›å…¥å®¹é‡ä¸º3çš„é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œæ¥ä¸‹æ¥6ã€7ã€8å·é¡¾å®¢åˆæ¥äº†ï¼Œ1ã€2å·çª—å£æ­£åœ¨æœåŠ¡ï¼Œä¸”é˜Ÿåˆ—ä¹Ÿæ»¡äº†ï¼Œæ­¤æ—¶åº”è¯¥å¼€å¯3ã€4ã€5å·çª—å£æ¥æä¾›æœåŠ¡ï¼Œä¸º6ã€7ã€8å·é¡¾å®¢æä¾›æœåŠ¡ï¼Œç„¶åå†ç”±è¿™5ä¸ªçª—å£ä¸º3ã€4ã€5å·é¡¾å®¢æä¾›æœåŠ¡
pool-1-thread-1å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢1
pool-1-thread-3å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢6
pool-1-thread-4å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢7
pool-1-thread-5å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢8
pool-1-thread-2å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢2
3såï¼Œ
pool-1-thread-4å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢3
pool-1-thread-5å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢4
pool-1-thread-2å·çª—å£ï¼ŒæœåŠ¡é¡¾å®¢5
*/</span>
</code></pre></div></div>

<h4 id="åˆç†è®¾ç½®çº¿ç¨‹æ± å‚æ•°">åˆç†è®¾ç½®çº¿ç¨‹æ± å‚æ•°</h4>

<ul>
  <li>æ‹’ç»ç­–ç•¥ï¼šç­‰å¾…é˜Ÿåˆ—å·²ç»æ’æ»¡äº†ï¼Œå†ä¹Ÿå¡ä¸ä¸‹æ–°ä»»åŠ¡äº†åŒæ—¶ï¼Œçº¿ç¨‹æ± ä¸­çš„maxçº¿ç¨‹ä¹Ÿè¾¾åˆ°äº†ï¼Œæ— æ³•ç»§ç»­ä¸ºæ–°ä»»åŠ¡æœåŠ¡ã€‚è¿™ä¸ªæ˜¯æ—¶å€™æˆ‘ä»¬å°±éœ€è¦æ‹’ç»ç­–ç•¥æœºåˆ¶åˆç†çš„å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚</li>
  <li>JDKå†…ç½®çš„æ‹’ç»ç­–ç•¥ï¼š
    <ul>
      <li>AbortPolicy(é»˜è®¤)ï¼šç›´æ¥æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸é˜»æ­¢ç³»ç»Ÿæ­£å¸¸è¿è¡Œ</li>
      <li>CallerRunsPolicyï¼šâ€œè°ƒç”¨è€…è¿è¡Œâ€ä¸€ç§è°ƒèŠ‚æœºåˆ¶ï¼Œè¯¥ç­–ç•¥æ—¢ä¸ä¼šæŠ›å¼ƒä»»åŠ¡ï¼Œä¹Ÿä¸
ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯å°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…ï¼Œä»è€Œé™ä½æ–°ä»»åŠ¡çš„æµé‡ã€‚</li>
      <li>DiscardOldestPolicyï¼šæŠ›å¼ƒé˜Ÿåˆ—ä¸­ç­‰å¾…æœ€ä¹…çš„ä»»åŠ¡ï¼Œç„¶åæŠŠå½“å‰ä»»åŠ¡åŠ äººé˜Ÿåˆ—ä¸­
å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡ã€‚</li>
      <li>DiscardPolicyï¼šè¯¥ç­–ç•¥é»˜é»˜åœ°ä¸¢å¼ƒæ— æ³•å¤„ç†çš„ä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸ã€‚
å¦‚æœå…è®¸ä»»åŠ¡ä¸¢å¤±ï¼Œè¿™æ˜¯æœ€å¥½çš„ä¸€ç§ç­–ç•¥ã€‚</li>
      <li>ä»¥ä¸Šå†…ç½®æ‹’ç»ç­–ç•¥å‡å®ç°äº†RejectedExecutionHandleæ¥å£</li>
    </ul>
  </li>
  <li>æ¨èè‡ªå®šä¹‰çº¿ç¨‹æ± </li>
</ul>

<p><img src="https://i.loli.net/2020/06/17/Yce29m8R6yjQPgs.png" alt="image.png" /></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.*</span><span class="o">;</span>

<span class="cm">/**
 * çº¿ç¨‹æ± 
 * Arrays
 * Collections
 * Executors
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyThreadPoolDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ExecutorService</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span>
                <span class="mi">2</span><span class="o">,</span>
                <span class="mi">5</span><span class="o">,</span>
                <span class="mi">2L</span><span class="o">,</span>
                <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;</span><span class="nc">Runnable</span><span class="o">&gt;(</span><span class="mi">3</span><span class="o">),</span>
                <span class="nc">Executors</span><span class="o">.</span><span class="na">defaultThreadFactory</span><span class="o">(),</span>
                <span class="c1">//new ThreadPoolExecutor.AbortPolicy()</span>
                <span class="c1">//new ThreadPoolExecutor.CallerRunsPolicy()</span>
                <span class="c1">//new ThreadPoolExecutor.DiscardOldestPolicy()</span>
                <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">.</span><span class="na">DiscardOldestPolicy</span><span class="o">()</span>
        <span class="o">);</span>
        <span class="c1">//10ä¸ªé¡¾å®¢è¯·æ±‚</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\t åŠç†ä¸šåŠ¡"</span><span class="o">);</span>
                <span class="o">});</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>CPUå¯†é›†å‹ï¼šè¯¥ä»»åŠ¡éœ€è¦å¤§é‡çš„è¿ç®—ï¼Œè€Œæ²¡æœ‰é˜»å¡ï¼ŒCPUä¼šä¸€ç›´å…¨é€Ÿè¿è¡Œã€‚CPUå¯†é›†ä»»åŠ¡åªæœ‰åœ¨çœŸæ­£çš„å¤šæ ¸CPUä¸Šæ‰èƒ½å¾—åˆ°åŠ é€Ÿï¼ˆé€šè¿‡å¤šçº¿å±‚ï¼‰ï¼Œè€Œåœ¨å•æ ¸CPUä¸Šï¼Œæ— è®ºä½ å¼€å‡ ä¸ªæ¨¡æ‹Ÿçš„å¤šçº¿ç¨‹è¯¥ä»»åŠ¡éƒ½ä¸å¯èƒ½å¾—åˆ°åŠ é€Ÿï¼Œå› ä¸ºCPUæ€»çš„è¿ç®—èƒ½åŠ›å°±é‚£äº›ã€‚<strong>CPUå¯†é›†å‹ä»»åŠ¡é…ç½®å°½å¯èƒ½å°‘çš„çº¿ç¨‹æ•°é‡ï¼šä¸€èˆ¬å…¬å¼ï¼šCPUæ ¸æ•°+1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚</strong></li>
  <li>IOå¯†é›†å‹ï¼šç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™åº”è¯¥é…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚CPUæ ¸æ•°*2</li>
</ul>

<p><img src="https://i.loli.net/2020/06/24/9AFkwNlMoTs5iD4.png" alt="image.png" /></p>

<ul>
  <li>â€‹</li>
</ul>

<h3 id="java8æµå¼è®¡ç®—">java8æµå¼è®¡ç®—</h3>

<ul>
  <li>å››å¤§å‡½æ•°å¼æ¥å£</li>
</ul>

<p><img src="https://i.loli.net/2020/06/17/5owXvIa1FRHLSUk.png" alt="image.png" /></p>

<ul>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//R apply(T t);å‡½æ•°å‹æ¥å£ï¼Œä¸€ä¸ªå‚æ•°ï¼Œä¸€ä¸ªè¿”å›å€¼</span>
<span class="nc">Function</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">function</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-&gt;{</span><span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">length</span><span class="o">();};</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">function</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="s">"abcd"</span><span class="o">));</span>

<span class="c1">//boolean test(T t);æ–­å®šå‹æ¥å£ï¼Œä¸€ä¸ªå‚æ•°ï¼Œè¿”å›boolean</span>
<span class="nc">Predicate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;{</span><span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"a"</span><span class="o">);};</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">predicate</span><span class="o">.</span><span class="na">test</span><span class="o">(</span><span class="s">"a"</span><span class="o">));</span>

<span class="c1">// void accept(T t);æ¶ˆè´¹å‹æ¥å£ï¼Œä¸€ä¸ªå‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼</span>
<span class="nc">Consumer</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">consumer</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
<span class="o">};</span>
<span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="s">"javaXXXX"</span><span class="o">);</span>

<span class="c1">//T get(); ä¾›ç»™å‹æ¥å£ï¼Œæ— å‚æ•°ï¼Œæœ‰è¿”å›å€¼</span>
<span class="nc">Supplier</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">supplier</span> <span class="o">=()-&gt;{</span><span class="k">return</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();};</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">supplier</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>streamæµçš„ç‰¹ç‚¹</p>

    <ul>
      <li>Stream è‡ªå·±ä¸ä¼šå­˜å‚¨å…ƒç´ </li>
      <li>Stream ä¸ä¼šæ”¹å˜æºå¯¹è±¡ã€‚ç›¸åï¼Œä»–ä»¬ä¼šè¿”å›ä¸€ä¸ªæŒæœ‰ç»“æœçš„æ–°Stream</li>
      <li>Stream æ“ä½œæ˜¯å»¶è¿Ÿæ‰§è¡Œçš„ã€‚è¿™æ„å‘³ç€ä»–ä»¬ä¼šç­‰åˆ°éœ€è¦ç»“æœçš„æ—¶å€™æ‰æ‰§è¡Œã€‚</li>
    </ul>
  </li>
  <li>
    <p>streamä½¿ç”¨æµç¨‹</p>

    <ul>
      <li>åˆ›å»ºä¸€ä¸ªStreamï¼šä¸€ä¸ªæ•°æ®æºï¼ˆæ•°ç»„ã€é›†åˆï¼‰</li>
      <li>ä¸­é—´æ“ä½œï¼šä¸€ä¸ªä¸­é—´æ“ä½œï¼Œå¤„ç†æ•°æ®æºæ•°æ®</li>
      <li>ç»ˆæ­¢æ“ä½œï¼šä¸€ä¸ªç»ˆæ­¢æ“ä½œï¼Œæ‰§è¡Œä¸­é—´æ“ä½œé“¾ï¼Œäº§ç”Ÿç»“æœ</li>
    </ul>
  </li>
</ul>

<h3 id="åˆ†æ”¯åˆå¹¶æ¡†æ¶">åˆ†æ”¯åˆå¹¶æ¡†æ¶</h3>

<ul>
  <li>
    <p>Forkï¼šæŠŠä¸€ä¸ªå¤æ‚ä»»åŠ¡è¿›è¡Œåˆ†æ‹†ï¼Œå¤§äº‹åŒ–å°</p>
  </li>
  <li>
    <p>Joinï¼šæŠŠåˆ†æ‹†ä»»åŠ¡çš„ç»“æœè¿›è¡Œåˆå¹¶</p>
  </li>
  <li>
    <p>ç›¸å…³ç±»</p>

    <ul>
      <li>ForkJoinPool</li>
    </ul>

    <p><img src="https://i.loli.net/2020/06/17/gPHhrZEnp7CKU1X.png" alt="image.png" /></p>

    <ul>
      <li>ForkJoinTask</li>
    </ul>

    <p><img src="https://i.loli.net/2020/06/17/MeaiGzsYbR8OodD.png" alt="image.png" /></p>

    <ul>
      <li>RecursiveTask</li>
    </ul>

    <p><img src="https://i.loli.net/2020/06/17/tkfCZ1gEa5hnWB8.png" alt="image.png" /></p>
  </li>
  <li>
    <p>å®ä¾‹</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinPool</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ForkJoinTask</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.RecursiveTask</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">MyTask</span> <span class="kd">extends</span> <span class="nc">RecursiveTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Integer</span> <span class="no">ADJUST_VALUE</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">begin</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">end</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MyTask</span><span class="o">(</span><span class="kt">int</span> <span class="n">begin</span><span class="o">,</span> <span class="kt">int</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">begin</span> <span class="o">=</span> <span class="n">begin</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">((</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="o">)&lt;=</span><span class="no">ADJUST_VALUE</span><span class="o">){</span>
           <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span><span class="n">begin</span><span class="o">;</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">i</span><span class="o">;</span>
           <span class="o">}</span>
        <span class="o">}</span><span class="k">else</span><span class="o">{</span>
            <span class="kt">int</span> <span class="n">middle</span> <span class="o">=</span> <span class="o">(</span><span class="n">begin</span> <span class="o">+</span> <span class="n">end</span><span class="o">)/</span><span class="mi">2</span><span class="o">;</span>
            <span class="nc">MyTask</span> <span class="n">task01</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTask</span><span class="o">(</span><span class="n">begin</span><span class="o">,</span><span class="n">middle</span><span class="o">);</span>
            <span class="nc">MyTask</span> <span class="n">task02</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTask</span><span class="o">(</span><span class="n">middle</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span><span class="n">end</span><span class="o">);</span>
            <span class="n">task01</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
            <span class="n">task02</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">task01</span><span class="o">.</span><span class="na">join</span><span class="o">()</span> <span class="o">+</span> <span class="n">task02</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
        <span class="o">}</span>


        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>


<span class="cm">/**
 * åˆ†æ”¯åˆå¹¶ä¾‹å­
 * ForkJoinPool
 * ForkJoinTask
 * RecursiveTask
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ForkJoinDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>

        <span class="nc">MyTask</span> <span class="n">myTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyTask</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">100</span><span class="o">);</span>
        <span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">();</span>
        <span class="nc">ForkJoinTask</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">forkJoinTask</span> <span class="o">=</span> <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">myTask</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">forkJoinTask</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>

        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="å¼‚æ­¥å›è°ƒ">å¼‚æ­¥å›è°ƒ</h3>

<ul>
  <li>CompletableFuture</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">java.util.concurrent.CompletableFuture</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CompletableFutureDemo</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//åŒæ­¥ï¼Œå¼‚æ­¥ï¼Œå¼‚æ­¥å›è°ƒ</span>

        <span class="c1">//åŒæ­¥</span>
<span class="c1">//        CompletableFuture&lt;Void&gt; completableFuture1 = CompletableFuture.runAsync(()-&gt;{</span>
<span class="c1">//            System.out.println(Thread.currentThread().getName()+"\t completableFuture1");</span>
<span class="c1">//        });</span>
<span class="c1">//        completableFuture1.get();</span>

        <span class="c1">//å¼‚æ­¥å›è°ƒ</span>
        <span class="nc">CompletableFuture</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">completableFuture2</span> <span class="o">=</span> <span class="nc">CompletableFuture</span><span class="o">.</span><span class="na">supplyAsync</span><span class="o">(()-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()+</span><span class="s">"\t completableFuture2"</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="o">/</span><span class="mi">0</span><span class="o">;</span>
            <span class="k">return</span> <span class="mi">1024</span><span class="o">;</span>
        <span class="o">});</span>

        <span class="n">completableFuture2</span><span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">t</span><span class="o">,</span><span class="n">u</span><span class="o">)-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------t="</span><span class="o">+</span><span class="n">t</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-------u="</span><span class="o">+</span><span class="n">u</span><span class="o">);</span>
        <span class="o">}).</span><span class="na">exceptionally</span><span class="o">(</span><span class="n">f</span><span class="o">-&gt;{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----exception:"</span><span class="o">+</span><span class="n">f</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
            <span class="k">return</span> <span class="mi">444</span><span class="o">;</span>
        <span class="o">}).</span><span class="na">get</span><span class="o">();</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="æ‰“é€ é«˜æ€§èƒ½ç¼“å­˜">æ‰“é€ é«˜æ€§èƒ½ç¼“å­˜</h3>

<h4 id="hashmap">HashMap</h4>

<ul>
  <li>ä½¿ç”¨mapç®€å•å®ç°</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æœ€ç®€å•çš„ç¼“å­˜å½¢å¼ï¼šHashMap
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImoocCache1</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="nc">Integer</span> <span class="nf">computer</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="c1">//å…ˆæ£€æŸ¥HashMapé‡Œé¢æœ‰æ²¡æœ‰ä¿å­˜è¿‡ä¹‹å‰çš„è®¡ç®—ç»“æœ</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">//å¦‚æœç¼“å­˜ä¸­æ‰¾ä¸åˆ°ï¼Œé‚£ä¹ˆéœ€è¦ç°åœ¨è®¡ç®—ä¸€ä¸‹ç»“æœï¼Œå¹¶ä¸”ä¿å­˜åˆ°HashMapä¸­</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">doCompute</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="nf">doCompute</span><span class="o">(</span><span class="nc">String</span> <span class="n">userId</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">Integer</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ImoocCache1</span> <span class="n">imoocCache1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImoocCache1</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¼€å§‹è®¡ç®—äº†"</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">imoocCache1</span><span class="o">.</span><span class="na">computer</span><span class="o">(</span><span class="s">"13"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸€æ¬¡è®¡ç®—ç»“æœï¼š"</span><span class="o">+</span><span class="n">result</span><span class="o">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">imoocCache1</span><span class="o">.</span><span class="na">computer</span><span class="o">(</span><span class="s">"13"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬äºŒæ¬¡è®¡ç®—ç»“æœï¼š"</span><span class="o">+</span><span class="n">result</span><span class="o">);</span>
 
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="concurrenthashmap-1">ConcurrentHashMap</h4>

<ul>
  <li>ç”¨çº¿ç¨‹å®‰å…¨map</li>
  <li>Computable</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     æœ‰ä¸€ä¸ªè®¡ç®—å‡½æ•°computerï¼Œç”¨æ¥ä»£è¡¨è€—æ—¶è®¡ç®—ï¼Œæ¯ä¸ªè®¡ç®—å™¨éƒ½è¦å®ç°è¿™ä¸ªæ¥å£ï¼Œè¿™æ ·å°±å¯ä»¥æ— ä¾µå…¥å®ç°ç¼“å­˜åŠŸèƒ½
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Computable</span> <span class="o">&lt;</span><span class="no">A</span><span class="o">,</span><span class="no">V</span><span class="o">&gt;{</span>
 
    <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>ExpensiveFunction</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     è€—æ—¶è®¡ç®—çš„å®ç°ç±»ï¼Œå®ç°äº†Computableæ¥å£ï¼Œä½†æ˜¯æœ¬èº«ä¸å…·å¤‡ç¼“å­˜èƒ½åŠ›ï¼Œä¸éœ€è¦è€ƒè™‘ç¼“å­˜çš„äº‹æƒ…
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExpensiveFunction</span> <span class="kd">implements</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;{</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">compute</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>MayFail</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     è€—æ—¶è®¡ç®—çš„å®ç°ç±»ï¼Œæœ‰æ¦‚ç‡è®¡ç®—å¤±è´¥
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MayFail</span> <span class="kd">implements</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;{</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Integer</span> <span class="nf">compute</span><span class="o">(</span><span class="nc">String</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="kt">double</span> <span class="n">random</span> <span class="o">=</span> <span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">random</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">"è¯»å–æ–‡ä»¶å‡ºé”™"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">3000</span><span class="o">);</span>
        <span class="k">return</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>test</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     ç¼©å°äº†synchronizedçš„ç²’åº¦ï¼Œæé«˜æ€§èƒ½ï¼Œä½†æ˜¯ä¾ç„¶å¹¶å‘ä¸å®‰å…¨
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImoocCache6</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ImoocCache6</span><span class="o">(</span><span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿›å…¥ç¼“å­˜æœºåˆ¶"</span><span class="o">);</span>
        <span class="no">V</span> <span class="n">result</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ImoocCache6</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">expensiveComputer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImoocCache6</span><span class="o">&lt;&gt;(</span>
                <span class="k">new</span> <span class="nf">ExpensiveFunction</span><span class="o">());</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸€æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸‰æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"667"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬äºŒæ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="future">Future</h4>

<ul>
  <li>é‡å¤è®¡ç®—é—®é¢˜ï¼ˆä¸¤ä¸ªçº¿ç¨‹ä¸€å‰ä¸€åï¼ŒåšåŒæ ·çš„è®¡ç®—ï¼‰</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     åˆ©ç”¨Futureï¼Œé¿å…é‡å¤è®¡ç®—
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImoocCache9</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ImoocCache9</span><span class="o">(</span><span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Callable</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">callable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="no">V</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">};</span>
                <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">ft</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">&lt;&gt;(</span><span class="n">callable</span><span class="o">);</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="n">ft</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">ft</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä»FutureTaskè°ƒç”¨äº†è®¡ç®—å‡½æ•°"</span><span class="o">);</span>
                    <span class="n">ft</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CancellationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¢«å–æ¶ˆäº†"</span><span class="o">);</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è®¡ç®—é”™è¯¯ï¼Œéœ€è¦é‡è¯•"</span><span class="o">);</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ImoocCache9</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">expensiveComputer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImoocCache9</span><span class="o">&lt;&gt;(</span>
                <span class="k">new</span> <span class="nf">MayFail</span><span class="o">());</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸€æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸‰æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"667"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬äºŒæ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ç¼“å­˜è¿‡æœŸ">ç¼“å­˜è¿‡æœŸ</h4>

<ul>
  <li>ä¸ºæ¯ä¸ªç»“æœæŒ‡å®šè¿‡æœŸæ—¶é—´ï¼Œå¹¶å®šæœŸæ‰«æè¿‡æœŸçš„å…ƒç´ </li>
  <li>è‹¥åŒæ—¶è¿‡æœŸï¼ŒåŒæ—¶æ‹¿ä¸åˆ°ç¼“å­˜ï¼Œä¼šå¯¼è‡´ç›´æ¥æ‰“çˆ†CPUå’ŒMySQLï¼Œé€ æˆç¼“å­˜é›ªå´©ï¼Œç¼“å­˜å‡»ç©¿</li>
  <li>ç¼“å­˜è¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºéšæœº</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æè¿°ï¼š     å‡ºäºå®‰å…¨æ€§è€ƒè™‘ï¼Œç¼“å­˜éœ€è¦è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸè‡ªåŠ¨å¤±æ•ˆï¼Œå¦åˆ™å¦‚æœç¼“å­˜ä¸€ç›´ä¸å¤±æ•ˆï¼Œé‚£ä¹ˆå¸¦æ¥ç¼“å­˜ä¸ä¸€è‡´ç­‰é—®é¢˜
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ImoocCache10</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="kd">implements</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="nc">Future</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;&gt;</span> <span class="n">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;();</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ImoocCache10</span><span class="o">(</span><span class="nc">Computable</span><span class="o">&lt;</span><span class="no">A</span><span class="o">,</span> <span class="no">V</span><span class="o">&gt;</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span><span class="o">,</span> <span class="nc">ExecutionException</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Future</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">f</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">Callable</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">callable</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Callable</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="no">V</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">};</span>
                <span class="nc">FutureTask</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">ft</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FutureTask</span><span class="o">&lt;&gt;(</span><span class="n">callable</span><span class="o">);</span>
                 <span class="c1">//åŸå­ç»„åˆ</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">putIfAbsent</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="n">ft</span><span class="o">);</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">f</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">ft</span><span class="o">;</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä»FutureTaskè°ƒç”¨äº†è®¡ç®—å‡½æ•°"</span><span class="o">);</span>
                    <span class="n">ft</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">CancellationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¢«å–æ¶ˆäº†"</span><span class="o">);</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ExecutionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è®¡ç®—é”™è¯¯ï¼Œéœ€è¦é‡è¯•"</span><span class="o">);</span>
                <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">computeRandomExpire</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">randomExpire</span> <span class="o">=</span> <span class="o">(</span><span class="kt">long</span><span class="o">)</span> <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">random</span><span class="o">()</span> <span class="o">*</span> <span class="mi">10000</span><span class="o">);</span>
        <span class="k">return</span> <span class="nf">compute</span><span class="o">(</span><span class="n">arg</span><span class="o">,</span> <span class="n">randomExpire</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">ScheduledExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newScheduledThreadPool</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
 
    <span class="kd">public</span> <span class="no">V</span> <span class="nf">compute</span><span class="o">(</span><span class="no">A</span> <span class="n">arg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">expire</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ExecutionException</span><span class="o">,</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">expire</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">executor</span><span class="o">.</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">expire</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">},</span> <span class="n">expire</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">compute</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">expire</span><span class="o">(</span><span class="no">A</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Future</span><span class="o">&lt;</span><span class="no">V</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">future</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Futureä»»åŠ¡è¢«å–æ¶ˆ"</span><span class="o">);</span>
                <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"è¿‡æœŸæ—¶é—´åˆ°ï¼Œç¼“å­˜è¢«æ¸…é™¤"</span><span class="o">);</span>
            <span class="n">cache</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="nc">ImoocCache10</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">expensiveComputer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ImoocCache10</span><span class="o">&lt;&gt;(</span>
                <span class="k">new</span> <span class="nf">MayFail</span><span class="o">());</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">,</span><span class="mi">5000L</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸€æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬ä¸‰æ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"667"</span><span class="o">);</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç¬¬äºŒæ¬¡çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}).</span><span class="na">start</span><span class="o">();</span>
 
 
        <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">6000L</span><span class="o">);</span>
        <span class="nc">Integer</span> <span class="n">result</span> <span class="o">=</span> <span class="n">expensiveComputer</span><span class="o">.</span><span class="na">compute</span><span class="o">(</span><span class="s">"666"</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ä¸»çº¿ç¨‹çš„è®¡ç®—ç»“æœï¼š"</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="é¿å‘å¿…çœ‹">é¿å‘å¿…çœ‹</h3>

<h4 id="1çº¿ç¨‹é‡ç”¨å¯¼è‡´ä¿¡æ¯é”™ä¹±">1çº¿ç¨‹é‡ç”¨å¯¼è‡´ä¿¡æ¯é”™ä¹±</h4>

<ul>
  <li>
    <p>æˆ‘ä»¬çŸ¥é“ï¼ŒThreadLocal é€‚ç”¨äºå˜é‡åœ¨<strong>çº¿ç¨‹é—´éš”ç¦»</strong>ï¼Œè€Œåœ¨æ–¹æ³•æˆ–ç±»é—´å…±äº«çš„åœºæ™¯ã€‚</p>
  </li>
  <li>
    <p>å¦‚æœç”¨æˆ·ä¿¡æ¯çš„è·å–æ¯”è¾ƒæ˜‚è´µï¼ˆæ¯”å¦‚ä»æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œé‚£ä¹ˆåœ¨ ThreadLocal ä¸­ç¼“å­˜æ•°æ®
æ˜¯æ¯”è¾ƒåˆé€‚çš„åšæ³•ã€‚</p>
  </li>
  <li>
    <p>ThreadLocalå¯ä»¥ç†è§£ä¸ºç»‘å®šåˆ°çº¿ç¨‹çš„Mapï¼Œç›¸åŒçº¿ç¨‹çš„ä¸åŒé€»è¾‘éœ€è¦å…±äº«æ•°æ®ï¼ˆä½†åˆæ— æ³•é€šè¿‡ä¼ å€¼æ¥å…±äº«æ•°æ®ï¼‰ï¼Œæˆ–ä¸ºäº†é¿å…ç›¸åŒçº¿ç¨‹é‡å¤åˆ›å»ºå¯¹è±¡å¸Œæœ›é‡ç”¨æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ThreadLocal</p>
  </li>
  <li>
    <p>ä½¿ç”¨ Spring Boot åˆ›å»ºä¸€ä¸ª Web åº”ç”¨ç¨‹åºï¼Œä½¿ç”¨ ThreadLocal å­˜æ”¾ä¸€ä¸ª Integer çš„å€¼ï¼Œæ¥æš‚ä¸”ä»£è¡¨éœ€è¦åœ¨çº¿ç¨‹ä¸­ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™ä¸ªå€¼åˆå§‹æ˜¯ nullã€‚åœ¨ä¸šåŠ¡é€»è¾‘ä¸­ï¼Œæˆ‘å…ˆä»ThreadLocal è·å–ä¸€æ¬¡å€¼ï¼Œç„¶åæŠŠå¤–éƒ¨ä¼ å…¥çš„å‚æ•°è®¾ç½®åˆ° ThreadLocal ä¸­ï¼Œæ¥æ¨¡æ‹Ÿä»å½“å‰ä¸Šä¸‹æ–‡è·å–åˆ°ç”¨æˆ·ä¿¡æ¯çš„é€»è¾‘ï¼Œéšåå†è·å–ä¸€æ¬¡å€¼ï¼Œæœ€åè¾“å‡ºä¸¤æ¬¡è·å¾—çš„å€¼å’Œçº¿ç¨‹åç§°ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"threadlocal"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocalMisuseController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">currentUser</span> <span class="o">=</span> <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">withInitial</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="kc">null</span><span class="o">);</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">wrong</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹å‰å…ˆæŸ¥è¯¢ä¸€æ¬¡ThreadLocalä¸­çš„ç”¨æˆ·ä¿¡æ¯</span>
        <span class="nc">String</span> <span class="n">before</span>  <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯åˆ°ThreadLocal</span>
        <span class="n">currentUser</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="c1">//è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹åå†æŸ¥è¯¢ä¸€æ¬¡ThreadLocalä¸­çš„ç”¨æˆ·ä¿¡æ¯</span>
        <span class="nc">String</span> <span class="n">after</span>  <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="c1">//æ±‡æ€»è¾“å‡ºä¸¤æ¬¡æŸ¥è¯¢ç»“æœ</span>
        <span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"before"</span><span class="o">,</span> <span class="n">before</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"after"</span><span class="o">,</span> <span class="n">after</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æŒ‰ç†è¯´ï¼Œåœ¨è®¾ç½®ç”¨æˆ·ä¿¡æ¯ä¹‹å‰ç¬¬ä¸€æ¬¡è·å–çš„å€¼å§‹ç»ˆåº”è¯¥æ˜¯ nullï¼Œä½†æˆ‘ä»¬è¦æ„è¯†åˆ°ï¼Œç¨‹åºè¿è¡Œåœ¨ Tomcat ä¸­ï¼Œæ‰§è¡Œç¨‹åºçš„çº¿ç¨‹æ˜¯ Tomcat çš„å·¥ä½œçº¿ç¨‹ï¼Œè€Œ Tomcat çš„å·¥ä½œçº¿ç¨‹æ˜¯åŸºäºçº¿ç¨‹æ± çš„ã€‚é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± ä¼šé‡ç”¨å›ºå®šçš„å‡ ä¸ªçº¿ç¨‹ï¼Œä¸€æ—¦çº¿ç¨‹é‡ç”¨ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½é¦–æ¬¡ä»ThreadLocal è·å–çš„å€¼æ˜¯ä¹‹å‰å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚é—ç•™çš„å€¼ã€‚è¿™æ—¶ï¼ŒThreadLocal ä¸­çš„ç”¨æˆ·ä¿¡æ¯å°±æ˜¯å…¶ä»–ç”¨æˆ·çš„ä¿¡æ¯ã€‚</p>
  </li>
  <li>
    <p>è®¾ç½®ä¸€ä¸‹ Tomcat çš„å‚æ•°ï¼ŒæŠŠå·¥ä½œçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°è®¾ç½®ä¸º 1ï¼Œè¿™æ ·å§‹ç»ˆæ˜¯åŒä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†è¯·æ±‚</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">server.tomcat.max-threads=1</code></p>
  </li>
  <li>
    <p>è¿è¡Œç¨‹åºåå…ˆè®©ç”¨æˆ· 1 æ¥è¯·æ±‚æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€å’Œç¬¬äºŒæ¬¡è·å–åˆ°ç”¨æˆ· ID åˆ†åˆ«æ˜¯ null å’Œ1ï¼Œç¬¦åˆé¢„æœŸã€‚éšåç”¨æˆ· 2 æ¥è¯·æ±‚æ¥å£ï¼Œè¿™æ¬¡å°±å‡ºç°äº† Bugï¼Œç¬¬ä¸€å’Œç¬¬äºŒæ¬¡è·å–åˆ°ç”¨æˆ· ID åˆ†åˆ«æ˜¯ 1 å’Œ2ï¼Œæ˜¾ç„¶ç¬¬ä¸€æ¬¡è·å–åˆ°äº†ç”¨æˆ· 1 çš„ä¿¡æ¯ï¼ŒåŸå› å°±æ˜¯ Tomcat çš„çº¿ç¨‹æ± é‡ç”¨äº†çº¿ç¨‹ã€‚ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸¤æ¬¡è¯·æ±‚çš„çº¿ç¨‹éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹</p>
  </li>
  <li>
    <p>å› ä¸ºçº¿ç¨‹çš„åˆ›å»ºæ¯”è¾ƒæ˜‚è´µï¼Œæ‰€ä»¥ Web æœåŠ¡å™¨å¾€å¾€ä¼šä½¿ç”¨çº¿ç¨‹æ± æ¥å¤„ç†è¯·æ±‚ï¼Œè¿™å°±æ„å‘³ç€çº¿ç¨‹ä¼šè¢«é‡ç”¨ã€‚è¿™æ—¶ï¼Œä½¿ç”¨ç±»ä¼¼ ThreadLocal å·¥å…·æ¥å­˜æ”¾ä¸€äº›æ•°æ®æ—¶ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„åœ¨ä»£ç è¿è¡Œå®Œåï¼Œ<strong>æ˜¾å¼åœ°å»æ¸…ç©ºè®¾ç½®çš„æ•°æ®ã€‚</strong>å¦‚æœåœ¨ä»£ç ä¸­ä½¿ç”¨äº†è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼Œä¹ŸåŒæ ·ä¼šé‡åˆ°è¿™ä¸ªé—®é¢˜ã€‚</p>
  </li>
  <li>
    <p>ä¿®æ­£è¿™æ®µä»£ç çš„æ–¹æ¡ˆæ˜¯ï¼Œåœ¨ä»£ç çš„ finally ä»£ç å—ä¸­ï¼Œæ˜¾å¼æ¸…é™¤ThreadLocal ä¸­çš„æ•°æ®ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ–°çš„è¯·æ±‚è¿‡æ¥å³ä½¿ä½¿ç”¨äº†ä¹‹å‰çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè·å–åˆ°é”™è¯¯çš„ç”¨æˆ·ä¿¡æ¯äº†</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">right</span><span class="o">(</span><span class="nd">@RequestParam</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span> <span class="nc">Integer</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">before</span>  <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
        <span class="n">currentUser</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">userId</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">after</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"before"</span><span class="o">,</span> <span class="n">before</span><span class="o">);</span>
            <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"after"</span><span class="o">,</span> <span class="n">after</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">//åœ¨finallyä»£ç å—ä¸­åˆ é™¤ThreadLocalä¸­çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®ä¸ä¸²</span>
            <span class="n">currentUser</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>ThreadLocal æ˜¯åˆ©ç”¨ç‹¬å èµ„æºçš„æ–¹å¼ï¼Œæ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œé‚£å¦‚æœæˆ‘ä»¬ç¡®å®éœ€è¦æœ‰èµ„æºåœ¨çº¿ç¨‹ä¹‹å‰å…±äº«ï¼Œåº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½å°±éœ€è¦ç”¨åˆ°çº¿ç¨‹å®‰å…¨çš„å®¹å™¨äº†</li>
</ul>

<h4 id="2ä½¿ç”¨å¹¶å‘å®‰å…¨å·¥å…·å¹¶ä¸ä¸€å®šå®‰å…¨">2ä½¿ç”¨å¹¶å‘å®‰å…¨å·¥å…·å¹¶ä¸ä¸€å®šå®‰å…¨</h4>

<ul>
  <li>
    <p>æœ‰ä¸€ä¸ªå« 900 ä¸ªå…ƒç´ çš„Mapï¼Œç°åœ¨å†è¡¥å…… 100 ä¸ªå…ƒç´ è¿›å»ï¼Œè¿™ä¸ªè¡¥å……æ“ä½œç”± 10 ä¸ªçº¿ç¨‹å¹¶å‘è¿›è¡Œã€‚å¼€å‘äººå‘˜è¯¯ä»¥ä¸ºä½¿ç”¨äº† ConcurrentHashMap å°±ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œäºæ˜¯ä¸åŠ æ€ç´¢åœ°å†™å‡ºäº†ä¸‹é¢çš„ä»£
ç ï¼šåœ¨æ¯ä¸€ä¸ªçº¿ç¨‹çš„ä»£ç é€»è¾‘ä¸­å…ˆé€šè¿‡ size æ–¹æ³•æ‹¿åˆ°å½“å‰å…ƒç´ æ•°é‡ï¼Œè®¡ç®—ConcurrentHashMap ç›®å‰è¿˜éœ€è¦è¡¥å……å¤šå°‘å…ƒç´ ï¼Œå¹¶åœ¨æ—¥å¿—ä¸­è¾“å‡ºäº†è¿™ä¸ªå€¼ï¼Œç„¶åé€šè¿‡putAll æ–¹æ³•æŠŠç¼ºå°‘çš„å…ƒç´ æ·»åŠ è¿›å»ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"concurrenthashmapmisuse"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentHashMapMisuseController</span> <span class="o">{</span>

    <span class="c1">//çº¿ç¨‹ä¸ªæ•°</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">THREAD_COUNT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="c1">//æ€»å…ƒç´ æ•°é‡</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">ITEM_COUNT</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>

    <span class="c1">//å¸®åŠ©æ–¹æ³•ï¼Œç”¨æ¥è·å¾—ä¸€ä¸ªæŒ‡å®šå…ƒç´ æ•°é‡æ¨¡æ‹Ÿæ•°æ®çš„ConcurrentHashMap</span>
    <span class="kd">private</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">getData</span><span class="o">(</span><span class="kt">int</span> <span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">LongStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
                <span class="o">.</span><span class="na">boxed</span><span class="o">()</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toConcurrentMap</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">(),</span> <span class="nc">Function</span><span class="o">.</span><span class="na">identity</span><span class="o">(),</span>
                        <span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">o1</span><span class="o">,</span> <span class="nl">ConcurrentHashMap:</span><span class="o">:</span><span class="k">new</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">wrong</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">concurrentHashMap</span> <span class="o">=</span> <span class="n">getData</span><span class="o">(</span><span class="no">ITEM_COUNT</span> <span class="o">-</span> <span class="mi">100</span><span class="o">);</span>
        <span class="c1">//åˆå§‹900ä¸ªå…ƒç´ </span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"init size:{}"</span><span class="o">,</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="c1">//ä½¿ç”¨çº¿ç¨‹æ± å¹¶å‘å¤„ç†é€»è¾‘</span>
        <span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="no">THREAD_COUNT</span><span class="o">);</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">//æŸ¥è¯¢è¿˜éœ€è¦è¡¥å……å¤šå°‘ä¸ªå…ƒç´ </span>
            <span class="kt">int</span> <span class="n">gap</span> <span class="o">=</span> <span class="no">ITEM_COUNT</span> <span class="o">-</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"gap size:{}"</span><span class="o">,</span> <span class="n">gap</span><span class="o">);</span>
            <span class="c1">//è¡¥å……å…ƒç´ </span>
            <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getData</span><span class="o">(</span><span class="n">gap</span><span class="o">));</span>
        <span class="o">}));</span>
        <span class="c1">//ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>

        <span class="c1">//æœ€åå…ƒç´ ä¸ªæ•°ä¼šæ˜¯1000å—ï¼Ÿ</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"finish size:{}"</span><span class="o">,</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>æœ€å HashMap çš„æ€»é¡¹ç›®æ•°æ˜¯ 1536ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆå¡«å……æ»¡ 1000 çš„é¢„æœŸã€‚å› ä¸ºconcurrentHashMapåªèƒ½ä¿è¯åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å‘é‡Œè¾¹æ·»åŠ å…ƒç´ ï¼Œä½†ä¸èƒ½ä¿è¯åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æŸ¥çœ‹é‡Œé¢çš„å…ƒç´ ã€‚</p>
  </li>
  <li>
    <p>è¯¸å¦‚ sizeã€isEmpty å’Œ containsValue ç­‰èšåˆæ–¹æ³•ï¼Œä¸èƒ½ç¡®ä¿åŸå­æ€§ï¼Œåœ¨å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ä¼šåæ˜ ConcurrentHashMap çš„ä¸­é—´çŠ¶æ€ã€‚å› æ­¤åœ¨å¹¶å‘æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•çš„è¿”å›å€¼åªèƒ½ç”¨ä½œå‚è€ƒï¼Œè€Œä¸èƒ½ç”¨äºæµç¨‹æ§åˆ¶ã€‚</p>
  </li>
  <li>
    <p>ä»£ç çš„ä¿®æ”¹æ–¹æ¡ˆå¾ˆç®€å•ï¼Œæ•´æ®µé€»è¾‘åŠ é”å³å¯</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"right"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">right</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">concurrentHashMap</span> <span class="o">=</span> <span class="n">getData</span><span class="o">(</span><span class="no">ITEM_COUNT</span> <span class="o">-</span> <span class="mi">100</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"init size:{}"</span><span class="o">,</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

        <span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="no">THREAD_COUNT</span><span class="o">);</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">//ä¸‹é¢çš„è¿™æ®µå¤åˆé€»è¾‘éœ€è¦é”ä¸€ä¸‹è¿™ä¸ªConcurrentHashMap</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">concurrentHashMap</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">gap</span> <span class="o">=</span> <span class="no">ITEM_COUNT</span> <span class="o">-</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"gap size:{}"</span><span class="o">,</span> <span class="n">gap</span><span class="o">);</span>
                <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">putAll</span><span class="o">(</span><span class="n">getData</span><span class="o">(</span><span class="n">gap</span><span class="o">));</span>
            <span class="o">}</span>
        <span class="o">}));</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"finish size:{}"</span><span class="o">,</span> <span class="n">concurrentHashMap</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>ä½¿ç”¨ ConcurrentHashMap å…¨ç¨‹åŠ é”ï¼Œè¿˜ä¸å¦‚ä½¿ç”¨æ™®é€šçš„HashMap å‘¢ã€‚å…¶å®ä¸å®Œå…¨æ˜¯è¿™æ ·ã€‚ConcurrentHashMap æä¾›äº†ä¸€äº›åŸå­æ€§çš„ç®€å•å¤åˆé€»è¾‘æ–¹æ³•ï¼Œç”¨å¥½è¿™äº›æ–¹æ³•å°±å¯ä»¥å‘æŒ¥å…¶å¨åŠ›ã€‚</li>
</ul>

<h4 id="3å‘æŒ¥concurrenthashmapçœŸæ­£å®åŠ›">3å‘æŒ¥concurrentHashMapçœŸæ­£å®åŠ›</h4>

<ul>
  <li>
    <p>ä½¿ç”¨ Map æ¥ç»Ÿè®¡ Key å‡ºç°æ¬¡æ•°ï¼Œä½¿ç”¨ ConcurrentHashMap æ¥ç»Ÿè®¡ï¼ŒKey çš„èŒƒå›´æ˜¯ 10ã€‚ä½¿ç”¨æœ€å¤š 10 ä¸ªå¹¶å‘ï¼Œå¾ªç¯æ“ä½œ 1000 ä¸‡æ¬¡ï¼Œæ¯æ¬¡æ“ä½œç´¯åŠ éšæœºçš„ Keyã€‚å¦‚æœ Key ä¸å­˜åœ¨çš„è¯ï¼Œé¦–æ¬¡è®¾ç½®å€¼ä¸º 1ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"concurrenthashmapperformance"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConcurrentHashMapPerformanceController</span> <span class="o">{</span>
    <span class="c1">//å¾ªç¯æ¬¡æ•°</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">LOOP_COUNT</span> <span class="o">=</span> <span class="mi">10000000</span><span class="o">;</span>
    <span class="c1">//çº¿ç¨‹æ•°é‡</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">THREAD_COUNT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="c1">//å…ƒç´ æ•°é‡</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="no">ITEM_COUNT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>

    <span class="c1">//æµ‹è¯•æ–¹æ³•</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"good"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">good</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"normaluse"</span><span class="o">);</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">normaluse</span> <span class="o">=</span> <span class="n">normaluse</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="c1">//æ ¡éªŒå…ƒç´ æ•°é‡</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">normaluse</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="no">ITEM_COUNT</span><span class="o">,</span> <span class="s">"normaluse size error"</span><span class="o">);</span>
        <span class="c1">//æ ¡éªŒç´¯è®¡æ€»æ•°</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">normaluse</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">mapToLong</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">()).</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nl">Long:</span><span class="o">:</span><span class="n">sum</span><span class="o">)</span> <span class="o">==</span> <span class="no">LOOP_COUNT</span>
                <span class="o">,</span> <span class="s">"normaluse count error"</span><span class="o">);</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"gooduse"</span><span class="o">);</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">gooduse</span> <span class="o">=</span> <span class="n">gooduse</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">gooduse</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="no">ITEM_COUNT</span><span class="o">,</span> <span class="s">"gooduse size error"</span><span class="o">);</span>
        <span class="nc">Assert</span><span class="o">.</span><span class="na">isTrue</span><span class="o">(</span><span class="n">gooduse</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">mapToLong</span><span class="o">(</span><span class="n">item</span> <span class="o">-&gt;</span> <span class="n">item</span><span class="o">.</span><span class="na">getValue</span><span class="o">())</span>
                        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="nl">Long:</span><span class="o">:</span><span class="n">sum</span><span class="o">)</span> <span class="o">==</span> <span class="no">LOOP_COUNT</span>
                <span class="o">,</span> <span class="s">"gooduse count error"</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">stopWatch</span><span class="o">.</span><span class="na">prettyPrint</span><span class="o">());</span>
        <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
    <span class="o">}</span>
	<span class="c1">//æ­£å¸¸æ€è·¯</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">normaluse</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="n">freqs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="no">ITEM_COUNT</span><span class="o">);</span>
        <span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="no">THREAD_COUNT</span><span class="o">);</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="no">LOOP_COUNT</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
                 <span class="c1">//è·å¾—ä¸€ä¸ªéšæœºçš„Key</span>
                    <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"item"</span> <span class="o">+</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="no">ITEM_COUNT</span><span class="o">);</span>
                    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">freqs</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">freqs</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">key</span><span class="o">))</span> <span class="o">{</span>
                            <span class="c1">//Keyå­˜åœ¨åˆ™+1</span>
                            <span class="n">freqs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">freqs</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="c1">//Keyä¸å­˜åœ¨åˆ™åˆå§‹åŒ–ä¸º1</span>
                            <span class="n">freqs</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="mi">1L</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">));</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">freqs</span><span class="o">;</span>
    <span class="o">}</span>
	<span class="c1">//æ›´å¥½çš„æ€è·¯</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">gooduse</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ConcurrentHashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">LongAdder</span><span class="o">&gt;</span> <span class="n">freqs</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="no">ITEM_COUNT</span><span class="o">);</span>
        <span class="nc">ForkJoinPool</span> <span class="n">forkJoinPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span><span class="no">THREAD_COUNT</span><span class="o">);</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="no">LOOP_COUNT</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"item"</span> <span class="o">+</span> <span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="no">ITEM_COUNT</span><span class="o">);</span>
          			<span class="c1">//åˆ©ç”¨computeIfAbsent()æ–¹æ³•æ¥å®ä¾‹åŒ–LongAdderï¼Œç„¶ååˆ©ç”¨LongAdderæ¥è¿›è¡Œæ“ä½œ</span>
                    <span class="n">freqs</span><span class="o">.</span><span class="na">computeIfAbsent</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">LongAdder</span><span class="o">()).</span><span class="na">increment</span><span class="o">();</span>
                <span class="o">}</span>
        <span class="o">));</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">shutdown</span><span class="o">();</span>
        <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">HOURS</span><span class="o">);</span>
        <span class="c1">//å› ä¸ºæˆ‘ä»¬çš„Valueæ˜¯LongAdderè€Œä¸æ˜¯Longï¼Œæ‰€ä»¥éœ€è¦åšä¸€æ¬¡è½¬æ¢æ‰èƒ½è¿”å›</span>
        <span class="k">return</span> <span class="n">freqs</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toMap</span><span class="o">(</span>
                        <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span>
                        <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">longValue</span><span class="o">())</span>
                <span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ä½¿ç”¨ ConcurrentHashMap çš„åŸå­æ€§æ–¹æ³• computeIfAbsent æ¥åšå¤åˆé€»è¾‘æ“ä½œï¼Œåˆ¤æ–­Key æ˜¯å¦å­˜åœ¨ Valueï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æŠŠ Lambda è¡¨è¾¾å¼è¿è¡Œåçš„ç»“æœæ”¾å…¥ Map ä½œä¸ºValueï¼Œä¹Ÿå°±æ˜¯æ–°åˆ›å»ºä¸€ä¸ª LongAdder å¯¹è±¡ï¼Œæœ€åè¿”å› Valueã€‚ç”±äº computeIfAbsent æ–¹æ³•è¿”å›çš„ Value æ˜¯ LongAdderï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ç´¯åŠ å™¨ï¼Œå› æ­¤å¯ä»¥ç›´æ¥è°ƒç”¨å…¶ increment æ–¹æ³•è¿›è¡Œç´¯åŠ ã€‚</p>
  </li>
  <li>computeIfAbsent ä¸ºä»€ä¹ˆå¦‚æ­¤é«˜æ•ˆå‘¢ï¼ŸJava è‡ªå¸¦çš„ Unsafe å®ç°çš„ CASã€‚å®ƒåœ¨è™šæ‹Ÿæœºå±‚é¢ç¡®ä¿äº†å†™å…¥æ•°æ®çš„åŸå­æ€§ï¼Œæ¯”åŠ é”çš„æ•ˆç‡é«˜å¾—å¤š</li>
</ul>

<h4 id="4é”™è¯¯çš„ä½¿ç”¨copyonwrite">4é”™è¯¯çš„ä½¿ç”¨CopyOnWrite</h4>

<ul>
  <li>
    <p>CopyOnWrite æ˜¯ä¸€ä¸ªæ—¶é«¦çš„æŠ€æœ¯ã€‚åœ¨ Java ä¸­ï¼ŒCopyOnWriteArrayList è™½ç„¶æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ ArrayListï¼Œä½†å› ä¸ºå…¶å®ç°æ–¹å¼æ˜¯ï¼Œæ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶éƒ½ä¼šå¤åˆ¶ä¸€ä»½æ•°æ®å‡ºæ¥ï¼Œæ‰€ä»¥æœ‰æ˜æ˜¾çš„é€‚ç”¨åœºæ™¯ï¼Œå³<strong>è¯»å¤šå†™å°‘æˆ–è€…è¯´å¸Œæœ›æ— é”è¯»çš„åœºæ™¯</strong>ã€‚å¦‚æœè¯»å†™æ¯”ä¾‹å‡è¡¡æˆ–è€…æœ‰å¤§é‡å†™æ“ä½œçš„è¯ï¼Œä½¿ç”¨ CopyOnWriteArrayList çš„æ€§èƒ½ä¼šéå¸¸ç³Ÿç³•ã€‚</p>
  </li>
  <li>
    <p>æ¯”è¾ƒä¸‹ä½¿ç”¨ CopyOnWriteArrayList å’Œæ™®é€šåŠ é”æ–¹å¼ ArrayListçš„è¯»å†™æ€§èƒ½</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"copyonwritelistmisuse"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CopyOnWriteListMisuseController</span> <span class="o">{</span>

    <span class="c1">//æµ‹è¯•å¹¶å‘å†™çš„æ€§èƒ½</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"write"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">testWrite</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">copyOnWriteArrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">synchronizedList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
        <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">loopCount</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">;</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"Write:copyOnWriteArrayList"</span><span class="o">);</span>
        <span class="c1">//å¾ªç¯100000æ¬¡å¹¶å‘å¾€CopyOnWriteArrayListå†™å…¥éšæœºå…ƒç´ </span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">loopCount</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">__</span> <span class="o">-&gt;</span> <span class="n">copyOnWriteArrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">loopCount</span><span class="o">)));</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"Write:synchronizedList"</span><span class="o">);</span>
        <span class="c1">//å¾ªç¯100000æ¬¡å¹¶å‘å¾€åŠ é”çš„ArrayListå†™å…¥éšæœºå…ƒç´ </span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">loopCount</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">__</span> <span class="o">-&gt;</span> <span class="n">synchronizedList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">loopCount</span><span class="o">)));</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">stopWatch</span><span class="o">.</span><span class="na">prettyPrint</span><span class="o">());</span>
        <span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"copyOnWriteArrayList"</span><span class="o">,</span> <span class="n">copyOnWriteArrayList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"synchronizedList"</span><span class="o">,</span> <span class="n">synchronizedList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">//å¸®åŠ©æ–¹æ³•ç”¨æ¥å¡«å……List</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">addAll</span><span class="o">(</span><span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">list</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">list</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1000000</span><span class="o">).</span><span class="na">boxed</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="c1">//æµ‹è¯•å¹¶å‘è¯»çš„æ€§èƒ½</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"read"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">Map</span> <span class="nf">testRead</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//åˆ›å»ºä¸¤ä¸ªæµ‹è¯•å¯¹è±¡</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">copyOnWriteArrayList</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CopyOnWriteArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">synchronizedList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">synchronizedList</span><span class="o">(</span><span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;&gt;());</span>
        <span class="c1">//å¡«å……æ•°æ®</span>
        <span class="n">addAll</span><span class="o">(</span><span class="n">copyOnWriteArrayList</span><span class="o">);</span>
        <span class="n">addAll</span><span class="o">(</span><span class="n">synchronizedList</span><span class="o">);</span>
        <span class="nc">StopWatch</span> <span class="n">stopWatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StopWatch</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">loopCount</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">copyOnWriteArrayList</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"Read:copyOnWriteArrayList"</span><span class="o">);</span>
        <span class="c1">//å¾ªç¯1000000æ¬¡å¹¶å‘ä»CopyOnWriteArrayListéšæœºæŸ¥è¯¢å…ƒç´ </span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">loopCount</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">__</span> <span class="o">-&gt;</span> <span class="n">copyOnWriteArrayList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">count</span><span class="o">)));</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">"Read:synchronizedList"</span><span class="o">);</span>
        <span class="c1">//å¾ªç¯1000000æ¬¡å¹¶å‘ä»åŠ é”çš„ArrayListéšæœºæŸ¥è¯¢å…ƒç´ </span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">loopCount</span><span class="o">).</span><span class="na">parallel</span><span class="o">().</span><span class="na">forEach</span><span class="o">(</span><span class="n">__</span> <span class="o">-&gt;</span> <span class="n">synchronizedList</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="nc">ThreadLocalRandom</span><span class="o">.</span><span class="na">current</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">count</span><span class="o">)));</span>
        <span class="n">stopWatch</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">stopWatch</span><span class="o">.</span><span class="na">prettyPrint</span><span class="o">());</span>
        <span class="nc">Map</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">();</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"copyOnWriteArrayList"</span><span class="o">,</span> <span class="n">copyOnWriteArrayList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="n">result</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"synchronizedList"</span><span class="o">,</span> <span class="n">synchronizedList</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>å¤§é‡å†™çš„åœºæ™¯ï¼ˆ10 ä¸‡æ¬¡ add æ“ä½œï¼‰ï¼ŒCopyOnWriteArray å‡ ä¹æ¯”åŒæ­¥çš„ ArrayList æ…¢ä¸€ç™¾å€ã€‚è€Œåœ¨å¤§é‡è¯»çš„åœºæ™¯ä¸‹ï¼ˆ100 ä¸‡æ¬¡ get æ“ä½œï¼‰ï¼ŒCopyOnWriteArray åˆæ¯”åŒæ­¥çš„ ArrayListå¿«äº”å€ä»¥ä¸Šã€‚ä¸ºä½•åœ¨å¤§é‡å†™çš„åœºæ™¯ä¸‹ï¼ŒCopyOnWriteArrayList ä¼šè¿™ä¹ˆæ…¢å‘¢ï¼Ÿä»¥ add æ–¹æ³•ä¸ºä¾‹ï¼Œæ¯æ¬¡ add æ—¶ï¼Œéƒ½ä¼šç”¨ Arrays.copyOf åˆ›å»ºä¸€ä¸ªæ–°æ•°ç»„ï¼Œé¢‘ç¹ add æ—¶å†…å­˜çš„ç”³è¯·é‡Šæ”¾æ¶ˆè€—ä¼šå¾ˆå¤§</li>
</ul>

<h4 id="5æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± ">5æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± </h4>

<ul>
  <li>ã€Šé˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œã€‹ä¸­æåˆ°ï¼Œç¦æ­¢ä½¿ç”¨è¿™äº›æ–¹æ³•æ¥åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œåº”è¯¥æ‰‹åŠ¨ new ThreadPoolExecutor æ¥åˆ›å»ºçº¿ç¨‹æ± ã€‚è¿™ä¸€æ¡è§„åˆ™çš„èƒŒåï¼Œæ˜¯å¤§é‡è¡€æ·‹æ·‹çš„ç”Ÿäº§äº‹æ•…ï¼Œæœ€å…¸å‹çš„å°±æ˜¯ newFixedThreadPool å’Œ newCachedThreadPoolï¼Œå¯èƒ½å› ä¸ºèµ„æºè€—å°½å¯¼è‡´OOM é—®é¢˜ã€‚</li>
  <li>åˆå§‹åŒ–ä¸€ä¸ªå•çº¿ç¨‹çš„ FixedThreadPoolï¼Œå¾ªç¯ 1 äº¿æ¬¡å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ¯”è¾ƒå¤§çš„å­—ç¬¦ä¸²ç„¶åä¼‘çœ ä¸€å°æ—¶ï¼Œæ‰§è¡Œç¨‹åºåä¸ä¹…ï¼Œæ—¥å¿—ä¸­å°±å‡ºç°äº†å¦‚ä¸‹ OOMã€‚ç¿»çœ‹ newFixedThreadPool æ–¹æ³•çš„æºç ä¸éš¾å‘ç°ï¼Œçº¿ç¨‹æ± çš„å·¥ä½œé˜Ÿåˆ—ç›´æ¥ new äº†ä¸€ä¸ªLinkedBlockingQueueï¼Œè€Œé»˜è®¤æ„é€ æ–¹æ³•çš„ LinkedBlockingQueue æ˜¯ä¸€ä¸ªInteger.MAX_VALUE é•¿åº¦çš„é˜Ÿåˆ—ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æ— ç•Œçš„ã€‚è™½ç„¶ä½¿ç”¨ newFixedThreadPool å¯ä»¥æŠŠå·¥ä½œçº¿ç¨‹æ§åˆ¶åœ¨å›ºå®šçš„æ•°é‡ä¸Šï¼Œä½†ä»»åŠ¡é˜Ÿåˆ—æ˜¯æ— ç•Œçš„ã€‚å¦‚æœä»»åŠ¡è¾ƒå¤šå¹¶ä¸”æ‰§è¡Œè¾ƒæ…¢çš„è¯ï¼Œé˜Ÿåˆ—å¯èƒ½ä¼šå¿«é€Ÿç§¯å‹ï¼Œæ’‘çˆ†å†…å­˜å¯¼è‡´ OOMã€‚</li>
  <li>æ”¹ä¸ºä½¿ç”¨ newCachedThreadPool æ–¹æ³•æ¥è·å¾—çº¿ç¨‹æ± ã€‚ç¨‹åºè¿è¡Œä¸ä¹…åï¼ŒåŒæ ·çœ‹åˆ°äº†å¦‚ä¸‹ OOM å¼‚å¸¸ã€‚è¿™æ¬¡ OOM çš„åŸå› æ˜¯æ— æ³•åˆ›å»ºçº¿ç¨‹ï¼Œç¿»çœ‹ newCachedThreadPool çš„æºç å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°æ˜¯ Integer.MAX_VALUEï¼Œå¯ä»¥è®¤ä¸ºæ˜¯æ²¡æœ‰ä¸Šé™çš„ï¼Œè€Œå…¶å·¥ä½œé˜Ÿåˆ— SynchronousQueue æ˜¯ä¸€ä¸ªæ²¡æœ‰å­˜å‚¨ç©ºé—´çš„é˜»å¡é˜Ÿåˆ—ã€‚ç”±äºæˆ‘ä»¬çš„ä»»åŠ¡éœ€è¦ 1 å°æ—¶æ‰èƒ½æ‰§è¡Œå®Œæˆï¼Œå¤§é‡çš„ä»»åŠ¡è¿›æ¥åä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ã€‚æˆ‘ä»¬çŸ¥é“çº¿ç¨‹æ˜¯éœ€è¦åˆ†é…ä¸€å®šçš„å†…å­˜ç©ºé—´ä½œä¸ºçº¿ç¨‹æ ˆçš„ï¼Œæ¯”å¦‚ 1MBï¼Œå› æ­¤æ— é™åˆ¶åˆ›å»ºçº¿ç¨‹å¿…ç„¶ä¼šå¯¼è‡´ OOM</li>
  <li>çº¿ç¨‹æ± é»˜è®¤çš„å·¥ä½œè¡Œä¸ºï¼š
    <ul>
      <li>ä¸ä¼šåˆå§‹åŒ– corePoolSize ä¸ªçº¿ç¨‹ï¼Œæœ‰ä»»åŠ¡æ¥äº†æ‰åˆ›å»ºå·¥ä½œçº¿ç¨‹</li>
      <li>å½“æ ¸å¿ƒçº¿ç¨‹æ»¡äº†ä¹‹åä¸ä¼šç«‹å³æ‰©å®¹çº¿ç¨‹æ± ï¼Œè€Œæ˜¯æŠŠä»»åŠ¡å †ç§¯åˆ°å·¥ä½œé˜Ÿåˆ—ä¸­</li>
      <li>å½“å·¥ä½œé˜Ÿåˆ—æ»¡äº†åæ‰©å®¹çº¿ç¨‹æ± ï¼Œä¸€ç›´åˆ°çº¿ç¨‹ä¸ªæ•°è¾¾åˆ° maximumPoolSize ä¸ºæ­¢</li>
      <li>å¦‚æœé˜Ÿåˆ—å·²æ»¡ä¸”è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹åè¿˜æœ‰ä»»åŠ¡è¿›æ¥ï¼ŒæŒ‰ç…§æ‹’ç»ç­–ç•¥å¤„ç†</li>
      <li>å½“çº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œçº¿ç¨‹ç­‰å¾… keepAliveTime åè¿˜æ˜¯æ²¡æœ‰ä»»åŠ¡éœ€è¦å¤„ç†çš„è¯ï¼Œ
æ”¶ç¼©çº¿ç¨‹åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°</li>
    </ul>
  </li>
  <li>æˆ‘ä»¬æœ‰æ²¡æœ‰åŠæ³•è®©çº¿ç¨‹æ± æ›´æ¿€è¿›ä¸€ç‚¹ï¼Œä¼˜å…ˆå¼€å¯æ›´å¤šçš„çº¿ç¨‹ï¼Œè€ŒæŠŠé˜Ÿåˆ—å½“æˆä¸€ä¸ªåå¤‡æ–¹æ¡ˆå‘¢ï¼Ÿç”±äºçº¿ç¨‹æ± åœ¨å·¥ä½œé˜Ÿåˆ—æ»¡äº†æ— æ³•å…¥é˜Ÿçš„æƒ…å†µä¸‹ä¼šæ‰©å®¹çº¿ç¨‹æ± ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥é‡å†™é˜Ÿåˆ—çš„ offer æ–¹æ³•ï¼Œé€ æˆè¿™ä¸ªé˜Ÿåˆ—å·²æ»¡çš„å‡è±¡å‘¢ï¼Ÿç”±äºæˆ‘ä»¬ Hack äº†é˜Ÿåˆ—ï¼Œåœ¨è¾¾åˆ°äº†æœ€å¤§çº¿ç¨‹ååŠ¿å¿…ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ï¼Œé‚£ä¹ˆèƒ½å¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„æ‹’ç»ç­–ç•¥å¤„ç†ç¨‹åºï¼Œè¿™ä¸ªæ—¶å€™å†æŠŠä»»åŠ¡çœŸæ­£æ’å…¥é˜Ÿåˆ—å‘¢ï¼Ÿ</li>
</ul>

<h4 id="6çº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¯å¤ç”¨çš„">6çº¿ç¨‹æ± æœ¬èº«æ˜¯ä¸æ˜¯å¯å¤ç”¨çš„</h4>

<ul>
  <li>
    <p>æŸé¡¹ç›®ç”Ÿäº§ç¯å¢ƒæ—¶ä¸æ—¶æœ‰æŠ¥è­¦æç¤ºçº¿ç¨‹æ•°è¿‡å¤šï¼Œè¶…è¿‡2000 ä¸ªï¼Œæ”¶åˆ°æŠ¥è­¦åæŸ¥çœ‹ç›‘æ§å‘ç°ï¼Œç¬æ—¶çº¿ç¨‹æ•°æ¯”è¾ƒå¤šä½†è¿‡ä¸€ä¼šå„¿åˆä¼šé™ä¸‹æ¥ï¼Œçº¿ç¨‹æ•°æŠ–åŠ¨å¾ˆå‰å®³ï¼Œè€Œåº”ç”¨çš„è®¿é—®é‡å˜åŒ–ä¸å¤§ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œçº¿ç¨‹æ± è‚¯å®šæ˜¯å¤ç”¨çš„ï¼Œæœ‰ 5 ä¸ªä»¥å†…çš„çº¿ç¨‹æ± éƒ½å¯ä»¥è®¤ä¸ºæ­£å¸¸ï¼Œè€Œ 1000 å¤šä¸ªçº¿ç¨‹æ± è‚¯å®šä¸æ­£å¸¸ã€‚</p>
  </li>
  <li>
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"threadpoolreuse"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadPoolReuseController</span> <span class="o">{</span>
<span class="cm">/*
è°ƒç”¨ ThreadPoolHelperçš„ getThreadPool æ–¹æ³•æ¥è·å¾—çº¿ç¨‹æ± ï¼Œç„¶åæäº¤æ•°ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± å¤„ç†
ä½†æ˜¯ï¼Œæ¥åˆ° ThreadPoolHelper çš„å®ç°è®©äººå¤§è·Œçœ¼é•œï¼ŒgetThreadPool æ–¹æ³•å±…ç„¶æ˜¯æ¯æ¬¡éƒ½ä½¿ç”¨ Executors.newCachedThreadPool æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ,çº¿ç¨‹æ± æ²¡æœ‰å¤ç”¨
*/</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"wrong"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">wrong</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
        <span class="nc">ThreadPoolExecutor</span> <span class="n">threadPool</span> <span class="o">=</span> <span class="nc">ThreadPoolHelper</span><span class="o">.</span><span class="na">getThreadPool</span><span class="o">();</span>
        <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">10</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">i</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">threadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">payload</span> <span class="o">=</span> <span class="nc">IntStream</span><span class="o">.</span><span class="na">rangeClosed</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1000000</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">mapToObj</span><span class="o">(</span><span class="n">__</span> <span class="o">-&gt;</span> <span class="s">"a"</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="nc">Collectors</span><span class="o">.</span><span class="na">joining</span><span class="o">(</span><span class="s">""</span><span class="o">))</span> <span class="o">+</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
                <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
            <span class="o">});</span>
        <span class="o">});</span>
        <span class="k">return</span> <span class="s">"OK"</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="cm">/*
  è§£å†³æ–¹æ¡ˆ
  ä½¿ç”¨ä¸€ä¸ªé™æ€å­—æ®µæ¥å­˜æ”¾çº¿ç¨‹æ± çš„å¼•ç”¨ï¼Œè¿”å›çº¿ç¨‹æ± çš„ä»£ç ç›´æ¥è¿”å›è¿™ä¸ªé™æ€å­—æ®µå³å¯
  */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ThreadPoolHelper</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="nc">ThreadPoolExecutor</span> <span class="n">threadPoolExecutor</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolExecutor</span><span class="o">(</span>
                <span class="mi">10</span><span class="o">,</span> <span class="mi">50</span><span class="o">,</span>
                <span class="mi">2</span><span class="o">,</span> <span class="nc">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span>
                <span class="k">new</span> <span class="nc">ArrayBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="mi">1000</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">ThreadFactoryBuilder</span><span class="o">().</span><span class="na">setNameFormat</span><span class="o">(</span><span class="s">"demo-threadpool-%d"</span><span class="o">).</span><span class="na">get</span><span class="o">());</span>

         
        <span class="kd">static</span> <span class="nc">ThreadPoolExecutor</span> <span class="nf">getRightThreadPool</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">threadPoolExecutor</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="7çº¿ç¨‹æ± çš„æ··ç”¨ç­–ç•¥">7çº¿ç¨‹æ± çš„æ··ç”¨ç­–ç•¥</h4>

<ul>
  <li>è¦æ ¹æ®ä»»åŠ¡çš„â€œè½»é‡ç¼“æ€¥â€æ¥æŒ‡å®šçº¿ç¨‹æ± çš„æ ¸å¿ƒå‚æ•°ï¼ŒåŒ…æ‹¬çº¿ç¨‹æ•°ã€å›æ”¶ç­–ç•¥å’Œä»»åŠ¡é˜Ÿåˆ—ã€‚å¯¹äºæ‰§è¡Œæ¯”è¾ƒæ…¢ã€æ•°é‡ä¸å¤§çš„ IO ä»»åŠ¡ï¼Œæˆ–è®¸è¦è€ƒè™‘æ›´å¤šçš„çº¿ç¨‹æ•°ï¼Œè€Œä¸éœ€è¦å¤ªå¤§çš„é˜Ÿåˆ—ã€‚è€Œå¯¹äºååé‡è¾ƒå¤§çš„è®¡ç®—å‹ä»»åŠ¡ï¼Œçº¿ç¨‹æ•°é‡ä¸å®œè¿‡å¤šï¼Œå¯ä»¥æ˜¯ CPU æ ¸æ•°æˆ–æ ¸æ•° *2ï¼ˆç†ç”±æ˜¯ï¼Œçº¿ç¨‹ä¸€å®šè°ƒåº¦åˆ°æŸä¸ª CPU è¿›è¡Œæ‰§è¡Œï¼Œå¦‚æœä»»åŠ¡æœ¬èº«æ˜¯ CPU ç»‘å®šçš„ä»»åŠ¡ï¼Œé‚£ä¹ˆè¿‡å¤šçš„çº¿ç¨‹åªä¼šå¢åŠ çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œå¹¶ä¸èƒ½æå‡ååé‡ï¼‰ï¼Œä½†å¯èƒ½éœ€è¦è¾ƒé•¿çš„é˜Ÿåˆ—æ¥åšç¼“å†²ã€‚</li>
  <li>çº¿ç¨‹æ± ä½¿ç”¨çš„æ˜¯CallerRunsPolicy ç­–ç•¥ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ± è¿›è¡Œå¼‚æ­¥è®¡ç®—çš„è¯ï¼Œå½“çº¿ç¨‹æ± é¥±å’Œçš„æ—¶
å€™ï¼Œè®¡ç®—ä»»åŠ¡ä¼šåœ¨æ‰§è¡Œ Web è¯·æ±‚çš„ Tomcat çº¿ç¨‹æ‰§è¡Œï¼Œè¿™æ—¶å°±ä¼šè¿›ä¸€æ­¥å½±å“åˆ°å…¶ä»–åŒæ­¥å¤„ç†çš„çº¿ç¨‹ï¼Œç”šè‡³é€ æˆæ•´ä¸ªåº”ç”¨ç¨‹åºå´©æºƒ</li>
  <li>è§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼Œä½¿ç”¨ç‹¬ç«‹çš„çº¿ç¨‹æ± æ¥åšè¿™æ ·çš„â€œè®¡ç®—ä»»åŠ¡â€å³å¯ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç›²ç›®å¤ç”¨çº¿ç¨‹æ± æ··ç”¨çº¿ç¨‹çš„é—®é¢˜åœ¨äºï¼Œåˆ«äººå®šä¹‰çš„çº¿ç¨‹æ± å±æ€§ä¸ä¸€å®šé€‚åˆä½ çš„ä»»åŠ¡ï¼Œè€Œä¸”æ··ç”¨ä¼šç›¸äº’å¹²æ‰°ã€‚</li>
  <li>Java 8 çš„ parallel stream åŠŸèƒ½ï¼Œå¯ä»¥è®©æˆ‘ä»¬å¾ˆæ–¹ä¾¿åœ°å¹¶è¡Œå¤„ç†é›†åˆä¸­çš„å…ƒç´ ï¼Œå…¶èƒŒåæ˜¯å…±äº«åŒä¸€ä¸ª ForkJoinPoolï¼Œé»˜è®¤å¹¶è¡Œåº¦æ˜¯CPU æ ¸æ•° -1ã€‚å¯¹äº CPU ç»‘å®šçš„ä»»åŠ¡æ¥è¯´ï¼Œä½¿ç”¨è¿™æ ·çš„é…ç½®æ¯”è¾ƒåˆé€‚ï¼Œä½†å¦‚æœé›†åˆæ“ä½œæ¶‰åŠåŒæ­¥ IO æ“ä½œçš„è¯ï¼ˆæ¯”å¦‚æ•°æ®åº“æ“ä½œã€å¤–éƒ¨æœåŠ¡è°ƒç”¨ç­‰ï¼‰ï¼Œå»ºè®®è‡ªå®šä¹‰ä¸€ä¸ªForkJoinPoolï¼ˆæˆ–æ™®é€šçº¿ç¨‹æ± ï¼‰ã€‚</li>
</ul>
:ET