I"Î<ul id="markdown-toc">
  <li><a href="#ç®€ä»‹" id="markdown-toc-ç®€ä»‹">ç®€ä»‹</a></li>
  <li><a href="#ä¼ ç»Ÿæ¨¡å¼èŠå¤©å®¤" id="markdown-toc-ä¼ ç»Ÿæ¨¡å¼èŠå¤©å®¤">ä¼ ç»Ÿæ¨¡å¼èŠå¤©å®¤</a></li>
  <li><a href="#é€šé“ä¸ç¼“å†²åŒº" id="markdown-toc-é€šé“ä¸ç¼“å†²åŒº">é€šé“ä¸ç¼“å†²åŒº</a>    <ul>
      <li><a href="#ç¼“å†²åŒºbuffer" id="markdown-toc-ç¼“å†²åŒºbuffer">ç¼“å†²åŒºï¼ˆBufferï¼‰</a></li>
      <li><a href="#é€šé“channel" id="markdown-toc-é€šé“channel">é€šé“ï¼ˆChannelï¼‰</a></li>
    </ul>
  </li>
  <li><a href="#åˆ†æ•£scatterå’Œèšé›†gather" id="markdown-toc-åˆ†æ•£scatterå’Œèšé›†gather">åˆ†æ•£ï¼ˆScatterï¼‰å’Œèšé›†ï¼ˆGatherï¼‰</a></li>
  <li><a href="#é€‰æ‹©å™¨selector" id="markdown-toc-é€‰æ‹©å™¨selector">é€‰æ‹©å™¨ï¼ˆSelectorï¼‰</a></li>
  <li><a href="#ç®¡é“pipe" id="markdown-toc-ç®¡é“pipe">ç®¡é“ï¼ˆPipeï¼‰</a></li>
  <li><a href="#æ–‡ä»¶æ‹·è´" id="markdown-toc-æ–‡ä»¶æ‹·è´">æ–‡ä»¶æ‹·è´</a></li>
  <li><a href="#èŠå¤©å®¤" id="markdown-toc-èŠå¤©å®¤">èŠå¤©å®¤</a></li>
  <li><a href="#path" id="markdown-toc-path">Path</a></li>
  <li><a href="#files" id="markdown-toc-files">Files</a></li>
</ul>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>

<ul>
  <li>
    <p>Java NIOï¼ˆNew IOï¼‰æ˜¯ä»Java 1.4ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªæ–°çš„IO APIï¼Œå¯ä»¥æ›¿ä»£æ ‡å‡†çš„Java IO APIã€‚ NIOä¸åŸæ¥çš„IOæœ‰åŒæ ·çš„ä½œç”¨å’Œç›®çš„ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ–¹å¼å®Œå…¨ä¸åŒï¼ŒNIOæ”¯æŒ<strong>é¢å‘ç¼“å†²åŒºçš„ã€åŸºäºé€šé“çš„IOæ“ä½œ</strong>ã€‚NIOå°†ä»¥æ›´åŠ é«˜æ•ˆçš„æ–¹å¼è¿›è¡Œæ–‡ä»¶çš„è¯»å†™æ“ä½œã€‚</p>
  </li>
  <li>
    <p>NIOä¸IOçš„åŒºåˆ«</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: center">IO</th>
          <th style="text-align: center">NIO</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: center">é¢å‘æµï¼ˆStream Orientedï¼‰</td>
          <td style="text-align: center">é¢å‘ç¼“å†²åŒºï¼ˆBuffer Orientedï¼‰</td>
        </tr>
        <tr>
          <td style="text-align: center">é˜»å¡IOï¼ˆBlocking IOï¼‰</td>
          <td style="text-align: center">éé˜»å¡IOï¼ˆNon Blocking IOï¼‰</td>
        </tr>
        <tr>
          <td style="text-align: center">æ— </td>
          <td style="text-align: center">é€‰æ‹©å™¨ï¼ˆSelectorsï¼‰</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>ä¼ ç»Ÿçš„IO æµéƒ½æ˜¯é˜»å¡å¼çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨read() æˆ–write()æ—¶ï¼Œè¯¥çº¿ç¨‹è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰ä¸€äº›æ•°æ®è¢«è¯»å–æˆ–å†™å…¥ï¼Œè¯¥çº¿ç¨‹åœ¨æ­¤æœŸé—´ä¸èƒ½æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚å› æ­¤ï¼Œåœ¨å®Œæˆç½‘ç»œé€šä¿¡è¿›è¡ŒIO æ“ä½œæ—¶ï¼Œç”±äºçº¿ç¨‹ä¼šé˜»å¡ï¼Œæ‰€ä»¥æœåŠ¡å™¨ç«¯å¿…é¡»ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æä¾›ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œå½“æœåŠ¡å™¨ç«¯éœ€è¦å¤„ç†å¤§é‡å®¢æˆ·ç«¯æ—¶ï¼Œæ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚</p>
  </li>
  <li>
    <p>Java NIO æ˜¯éé˜»å¡æ¨¡å¼çš„ã€‚å½“çº¿ç¨‹ä»æŸé€šé“è¿›è¡Œè¯»å†™æ•°æ®æ—¶ï¼Œè‹¥æ²¡æœ‰æ•°æ®å¯ç”¨æ—¶ï¼Œè¯¥çº¿ç¨‹å¯ä»¥è¿›è¡Œå…¶ä»–ä»»åŠ¡ã€‚çº¿ç¨‹é€šå¸¸å°†éé˜»å¡IO çš„ç©ºé—²æ—¶é—´ç”¨äºåœ¨å…¶ä»–é€šé“ä¸Šæ‰§è¡ŒIO æ“ä½œï¼Œæ‰€ä»¥å•ç‹¬çš„çº¿ç¨‹å¯ä»¥ç®¡ç†å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºé€šé“ã€‚å› æ­¤ï¼ŒNIO å¯ä»¥è®©æœåŠ¡å™¨ç«¯ä½¿ç”¨ä¸€ä¸ªæˆ–æœ‰é™å‡ ä¸ªçº¿ç¨‹æ¥åŒæ—¶å¤„ç†è¿æ¥åˆ°æœåŠ¡å™¨ç«¯çš„æ‰€æœ‰å®¢æˆ·ç«¯ã€‚</p>
  </li>
</ul>

<h3 id="ä¼ ç»Ÿæ¨¡å¼èŠå¤©å®¤">ä¼ ç»Ÿæ¨¡å¼èŠå¤©å®¤</h3>

<ul>
  <li>æœåŠ¡ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatServer</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">8888</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUIT</span> <span class="o">=</span> <span class="s">"quit"</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nc">ExecutorService</span> <span class="n">executorService</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ServerSocket</span> <span class="n">serverSocket</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">,</span> <span class="nc">Writer</span><span class="o">&gt;</span> <span class="n">connectedClients</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ChatServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">executorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
        <span class="n">connectedClients</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">addClient</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">socket</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
            <span class="nc">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">())</span>
            <span class="o">);</span>
            <span class="n">connectedClients</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">port</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯["</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">"]å·²è¿æ¥åˆ°æœåŠ¡å™¨"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">removeClient</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">socket</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getPort</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">connectedClients</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">port</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">connectedClients</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">connectedClients</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å®¢æˆ·ç«¯["</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">"]å·²æ–­å¼€è¿æ¥"</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">forwardMessage</span><span class="o">(</span><span class="nc">Socket</span> <span class="n">socket</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fwdMsg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">Integer</span> <span class="n">id</span> <span class="o">:</span> <span class="n">connectedClients</span><span class="o">.</span><span class="na">keySet</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">id</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getPort</span><span class="o">()))</span> <span class="o">{</span>
                <span class="nc">Writer</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">connectedClients</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">fwdMsg</span><span class="o">);</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">readyToQuit</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">QUIT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">serverSocket</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">serverSocket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å…³é—­serverSocket"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
 
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// ç»‘å®šç›‘å¬ç«¯å£</span>
            <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServerSocket</span><span class="o">(</span><span class="no">DEFAULT_PORT</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¯åŠ¨æœåŠ¡å™¨ï¼Œç›‘å¬ç«¯å£ï¼š"</span> <span class="o">+</span> <span class="no">DEFAULT_PORT</span> <span class="o">+</span> <span class="s">"..."</span><span class="o">);</span>
 
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥</span>
                <span class="nc">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                <span class="c1">// åˆ›å»ºChatHandlerçº¿ç¨‹</span>
                <span class="n">executorService</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nc">ChatHandler</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">socket</span><span class="o">));</span>
            <span class="o">}</span>
 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ChatServer</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ChatServer</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatHandler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ChatServer</span> <span class="n">server</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ChatHandler</span><span class="o">(</span><span class="nc">ChatServer</span> <span class="n">server</span><span class="o">,</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">server</span> <span class="o">=</span> <span class="n">server</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// å­˜å‚¨æ–°ä¸Šçº¿ç”¨æˆ·</span>
            <span class="n">server</span><span class="o">.</span><span class="na">addClient</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
 
            <span class="c1">// è¯»å–ç”¨æˆ·å‘é€çš„æ¶ˆæ¯</span>
            <span class="nc">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
            <span class="o">);</span>
 
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">msg</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">fwdMsg</span> <span class="o">=</span> <span class="s">"å®¢æˆ·ç«¯["</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]: "</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">;</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">fwdMsg</span><span class="o">);</span>
 
                <span class="c1">// å°†æ¶ˆæ¯è½¬å‘ç»™èŠå¤©å®¤é‡Œåœ¨çº¿çš„å…¶ä»–ç”¨æˆ·</span>
                <span class="n">server</span><span class="o">.</span><span class="na">forwardMessage</span><span class="o">(</span><span class="n">socket</span><span class="o">,</span> <span class="n">fwdMsg</span><span class="o">);</span>
 
                <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å‡†å¤‡é€€å‡º</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">server</span><span class="o">.</span><span class="na">readyToQuit</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">server</span><span class="o">.</span><span class="na">removeClient</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>å®¢æˆ·ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatClient</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_SERVER_HOST</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_SERVER_PORT</span> <span class="o">=</span> <span class="mi">8888</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUIT</span> <span class="o">=</span> <span class="s">"quit"</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nc">Socket</span> <span class="n">socket</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BufferedReader</span> <span class="n">reader</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">BufferedWriter</span> <span class="n">writer</span><span class="o">;</span>
 
    <span class="c1">// å‘é€æ¶ˆæ¯ç»™æœåŠ¡å™¨</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">socket</span><span class="o">.</span><span class="na">isOutputShutdown</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">"\n"</span><span class="o">);</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="c1">// ä»æœåŠ¡å™¨æ¥æ”¶æ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">receive</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">socket</span><span class="o">.</span><span class="na">isInputShutdown</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å‡†å¤‡é€€å‡º</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">readyToQuit</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">QUIT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">writer</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å…³é—­socket"</span><span class="o">);</span>
                <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
 
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// åˆ›å»ºsocket</span>
            <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Socket</span><span class="o">(</span><span class="no">DEFAULT_SERVER_HOST</span><span class="o">,</span> <span class="no">DEFAULT_SERVER_PORT</span><span class="o">);</span>
 
            <span class="c1">// åˆ›å»ºIOæµ</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedReader</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
            <span class="o">);</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedWriter</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">())</span>
            <span class="o">);</span>
 
            <span class="c1">// å¤„ç†ç”¨æˆ·çš„è¾“å…¥</span>
            <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserInputHandler</span><span class="o">(</span><span class="k">this</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
 
            <span class="c1">// è¯»å–æœåŠ¡å™¨è½¬å‘çš„æ¶ˆæ¯</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">((</span><span class="n">msg</span> <span class="o">=</span> <span class="n">receive</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ChatClient</span> <span class="n">chatClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ChatClient</span><span class="o">();</span>
        <span class="n">chatClient</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInputHandler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ChatClient</span> <span class="n">chatClient</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">UserInputHandler</span><span class="o">(</span><span class="nc">ChatClient</span> <span class="n">chatClient</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">chatClient</span> <span class="o">=</span> <span class="n">chatClient</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// ç­‰å¾…ç”¨æˆ·è¾“å…¥æ¶ˆæ¯</span>
            <span class="nc">BufferedReader</span> <span class="n">consoleReader</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">input</span> <span class="o">=</span> <span class="n">consoleReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
 
                <span class="c1">// å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span>
                <span class="n">chatClient</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
 
                <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å‡†å¤‡é€€å‡º</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatClient</span><span class="o">.</span><span class="na">readyToQuit</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="é€šé“ä¸ç¼“å†²åŒº">é€šé“ä¸ç¼“å†²åŒº</h3>

<ul>
  <li>Java NIOç³»ç»Ÿçš„æ ¸å¿ƒåœ¨äºï¼šé€šé“(Channel)å’Œç¼“å†²åŒº(Buffer)ã€‚é€šé“è¡¨ç¤ºæ‰“å¼€åˆ°IO è®¾å¤‡(ä¾‹å¦‚ï¼šæ–‡ä»¶ã€å¥—æ¥å­—)çš„è¿æ¥ã€‚è‹¥éœ€è¦ä½¿ç”¨NIO ç³»ç»Ÿï¼Œéœ€è¦è·å–ç”¨äºè¿æ¥IO è®¾å¤‡çš„é€šé“ä»¥åŠç”¨äºå®¹çº³æ•°æ®çš„ç¼“å†²åŒºã€‚ç„¶åæ“ä½œç¼“å†²åŒºï¼Œå¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ<strong>Channelè´Ÿè´£ä¼ è¾“ï¼ŒBufferè´Ÿè´£å­˜å‚¨</strong>ã€‚</li>
  <li>ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šä¸€ä¸ªç”¨äºç‰¹å®šåŸºæœ¬æ•°æ®ç±»å‹çš„å®¹å™¨ã€‚ç”±java.nioåŒ…å®šä¹‰çš„ï¼Œæ‰€æœ‰ç¼“å†²åŒºéƒ½æ˜¯BufferæŠ½è±¡ç±»çš„å­ç±»ã€‚</li>
  <li>java NIO ä¸­çš„Bufferä¸»è¦ç”¨äºä¸NIOé€šé“è¿›è¡Œäº¤äº’ï¼Œæ•°æ®æ˜¯ä»é€šé“è¯»å…¥ç¼“å†²åŒºï¼Œä»ç¼“å†²åŒºå†™å…¥é€šé“ä¸­çš„ã€‚</li>
</ul>

<h4 id="ç¼“å†²åŒºbuffer">ç¼“å†²åŒºï¼ˆBufferï¼‰</h4>

<ul>
  <li>Bufferå°±åƒä¸€ä¸ªæ•°ç»„ï¼Œå¯ä»¥ä¿å­˜å¤šä¸ªç›¸åŒç±»å‹çš„æ•°æ®ã€‚æ ¹æ®æ•°æ®ç±»å‹ä¸åŒ(boolean é™¤å¤–) ï¼Œæœ‰ä»¥ä¸‹Buffer å¸¸ç”¨å­ç±»ï¼š
    <ul>
      <li>ByteBuffer</li>
      <li>CharBuffer</li>
      <li>ShortBuffer</li>
      <li>IntBuffer</li>
      <li>LongBuffer</li>
      <li>FloatBuffer</li>
      <li>DoubleBuffer</li>
    </ul>
  </li>
  <li>è·å–Bufferå¯¹è±¡çš„æ–¹æ³•ï¼š<code class="language-plaintext highlighter-rouge">static XxxBuffer allocate(int capacity) </code>ï¼šåˆ›å»ºä¸€ä¸ªå®¹é‡ä¸ºcapacityçš„XxxBufferå¯¹è±¡</li>
  <li>ç¼“å†²åŒºçš„é‡è¦æ¦‚å¿µï¼š
    <ul>
      <li><strong>å®¹é‡ï¼ˆcapacityï¼‰</strong>:è¡¨ç¤ºBuffer æœ€å¤§æ•°æ®å®¹é‡ï¼Œç¼“å†²åŒºå®¹é‡ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”åˆ›å»ºåä¸èƒ½æ›´æ”¹ã€‚</li>
      <li><strong>é™åˆ¶ï¼ˆlimitï¼‰</strong>ï¼šç¬¬ä¸€ä¸ªä¸åº”è¯¥è¯»å–æˆ–å†™å…¥çš„æ•°æ®çš„ç´¢å¼•ï¼Œå³ä½äºlimit åçš„æ•°æ®ä¸å¯è¯»å†™ã€‚ç¼“å†²åŒºçš„é™åˆ¶ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºå…¶å®¹é‡ã€‚</li>
      <li><strong>ä½ç½®ï¼ˆpositionï¼‰</strong>ï¼šä¸‹ä¸€ä¸ªè¦è¯»å–æˆ–å†™å…¥çš„æ•°æ®çš„ç´¢å¼•ã€‚ç¼“å†²åŒºçš„ä½ç½®ä¸èƒ½ä¸ºè´Ÿï¼Œå¹¶ä¸”ä¸èƒ½å¤§äºå…¶é™åˆ¶</li>
      <li><strong>æ ‡è®°ï¼ˆMarkï¼‰ä¸é‡ç½®ï¼ˆresetï¼‰</strong>ï¼šæ ‡è®°æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œé€šè¿‡Buffer ä¸­çš„mark() æ–¹æ³•æŒ‡å®šBuffer ä¸­ä¸€ä¸ªç‰¹å®šçš„positionï¼Œä¹‹åå¯ä»¥é€šè¿‡è°ƒç”¨reset() æ–¹æ³•æ¢å¤åˆ°è¿™ä¸ªposition.</li>
      <li>æ ‡è®°ã€ä½ç½®ã€é™åˆ¶ã€å®¹é‡éµå®ˆä»¥ä¸‹ä¸å˜å¼ï¼š 0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2020/08/01/hSnU6TIBQsiLVWK.png" alt="image.png" /></p>

<ul>
  <li>Bufferå¸¸ç”¨æ–¹æ³•</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æ–¹æ³•</th>
      <th style="text-align: center">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">Buffer clear()</td>
      <td style="text-align: center">æ¸…ç©ºç¼“å†²åŒºå¹¶è¿”å›å¯¹ç¼“å†²åŒºçš„å¼•ç”¨</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer flip()</td>
      <td style="text-align: center">å°†ç¼“å†²åŒºçš„ç•Œé™ï¼ˆlimitï¼‰è®¾ç½®ä¸ºå½“å‰ä½ç½®ï¼Œå¹¶å°†å½“å‰ä½ç½®ï¼ˆpositionï¼‰é‡ç½®ä¸º0</td>
    </tr>
    <tr>
      <td style="text-align: center">int capacity()</td>
      <td style="text-align: center">è¿”å› Buffer çš„ capacity å¤§å°</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean hasRemaining()</td>
      <td style="text-align: center">åˆ¤æ–­ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰å…ƒç´ </td>
    </tr>
    <tr>
      <td style="text-align: center">int limit()</td>
      <td style="text-align: center">è¿”å› Buffer çš„ç•Œé™(limit) çš„ä½ç½®</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer limit(int n)</td>
      <td style="text-align: center">å°†è®¾ç½®ç¼“å†²åŒºç•Œé™ä¸º n, å¹¶è¿”å›ä¸€ä¸ªå…·æœ‰æ–° limit çš„ç¼“å†²åŒºå¯¹è±¡</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer mark()</td>
      <td style="text-align: center">å¯¹ç¼“å†²åŒºè®¾ç½®æ ‡è®°</td>
    </tr>
    <tr>
      <td style="text-align: center">int position()</td>
      <td style="text-align: center">è¿”å›ç¼“å†²åŒºçš„å½“å‰ä½ç½® position</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer position(int n)</td>
      <td style="text-align: center">å°†è®¾ç½®ç¼“å†²åŒºçš„å½“å‰ä½ç½®ä¸º n , å¹¶è¿”å›ä¿®æ”¹åçš„ Buffer å¯¹è±¡</td>
    </tr>
    <tr>
      <td style="text-align: center">int remaining()</td>
      <td style="text-align: center">è¿”å› position å’Œ limit ä¹‹é—´çš„å…ƒç´ ä¸ªæ•°</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer reset()</td>
      <td style="text-align: center">å°†ä½ç½® position è½¬åˆ°ä»¥å‰è®¾ç½®çš„ mark æ‰€åœ¨çš„ä½ç½®</td>
    </tr>
    <tr>
      <td style="text-align: center">Buffer rewind()</td>
      <td style="text-align: center">å°†ä½ç½®è®¾ä¸ºä¸º 0ï¼Œ å–æ¶ˆè®¾ç½®çš„ mark</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Buffer æ‰€æœ‰å­ç±»æä¾›äº†ä¸¤ä¸ªç”¨äºæ•°æ®æ“ä½œçš„æ–¹æ³•ï¼šget()ä¸put() æ–¹æ³•</li>
  <li>è·å–Bufferä¸­çš„æ•°æ®
    <ul>
      <li>get() ï¼šè¯»å–å•ä¸ªå­—èŠ‚</li>
      <li>get(byte[] dst)ï¼šæ‰¹é‡è¯»å–å¤šä¸ªå­—èŠ‚åˆ°dst ä¸­</li>
      <li>get(int index)ï¼šè¯»å–æŒ‡å®šç´¢å¼•ä½ç½®çš„å­—èŠ‚(ä¸ä¼šç§»åŠ¨position)</li>
    </ul>
  </li>
  <li>æ”¾å…¥æ•°æ®åˆ°Buffer ä¸­
    <ul>
      <li>put(byte b)ï¼šå°†ç»™å®šå•ä¸ªå­—èŠ‚å†™å…¥ç¼“å†²åŒºçš„å½“å‰ä½ç½®</li>
      <li>put(byte[] src)ï¼šå°†src ä¸­çš„å­—èŠ‚å†™å…¥ç¼“å†²åŒºçš„å½“å‰ä½ç½®</li>
      <li>put(int index, byte b)ï¼šå°†æŒ‡å®šå­—èŠ‚å†™å…¥ç¼“å†²åŒºçš„ç´¢å¼•ä½ç½®(ä¸ä¼šç§»åŠ¨position)</li>
    </ul>
  </li>
  <li>å­—èŠ‚ç¼“å†²åŒºè¦ä¹ˆæ˜¯ç›´æ¥çš„ï¼Œè¦ä¹ˆæ˜¯éç›´æ¥çš„ã€‚å¦‚æœä¸ºç›´æ¥å­—èŠ‚ç¼“å†²åŒºï¼Œåˆ™Java è™šæ‹Ÿæœºä¼šå°½æœ€å¤§åŠªåŠ›ç›´æ¥åœ¨æ­¤ç¼“å†²åŒºä¸Šæ‰§è¡Œæœ¬æœºI/O æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ¯æ¬¡è°ƒç”¨åŸºç¡€æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªæœ¬æœºI/O æ“ä½œä¹‹å‰ï¼ˆæˆ–ä¹‹åï¼‰ï¼Œè™šæ‹Ÿæœºéƒ½ä¼šå°½é‡é¿å…å°†ç¼“å†²åŒºçš„å†…å®¹å¤åˆ¶åˆ°ä¸­é—´ç¼“å†²åŒºä¸­ï¼ˆæˆ–ä»ä¸­é—´ç¼“å†²åŒºä¸­å¤åˆ¶å†…å®¹ï¼‰ã€‚</li>
  <li><strong>ç›´æ¥å­—èŠ‚ç¼“å†²åŒº</strong>å¯ä»¥é€šè¿‡è°ƒç”¨æ­¤ç±»çš„<strong>allocateDirect() å·¥å‚æ–¹æ³•</strong>æ¥åˆ›å»ºã€‚æ­¤æ–¹æ³•è¿”å›çš„<strong>ç¼“å†²åŒºè¿›è¡Œåˆ†é…å’Œå–æ¶ˆåˆ†é…æ‰€éœ€æˆæœ¬é€šå¸¸é«˜äºéç›´æ¥ç¼“å†²åŒº</strong>ã€‚ç›´æ¥ç¼“å†²åŒºçš„å†…å®¹å¯ä»¥é©»ç•™åœ¨å¸¸è§„çš„åƒåœ¾å›æ”¶å †ä¹‹å¤–ï¼Œå› æ­¤ï¼Œå®ƒä»¬å¯¹åº”ç”¨ç¨‹åºçš„å†…å­˜éœ€æ±‚é‡é€ æˆçš„å½±å“å¯èƒ½å¹¶ä¸æ˜æ˜¾ã€‚æ‰€ä»¥ï¼Œå»ºè®®å°†ç›´æ¥ç¼“å†²åŒºä¸»è¦åˆ†é…ç»™é‚£äº›æ˜“å—åŸºç¡€ç³»ç»Ÿçš„æœ¬æœºI/O æ“ä½œå½±å“çš„å¤§å‹ã€æŒä¹…çš„ç¼“å†²åŒºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€å¥½ä»…åœ¨ç›´æ¥ç¼“å†²åŒºèƒ½åœ¨ç¨‹åºæ€§èƒ½æ–¹é¢å¸¦æ¥æ˜æ˜¾å¥½å¤„æ—¶åˆ†é…å®ƒä»¬ã€‚</li>
  <li>ç›´æ¥å­—èŠ‚ç¼“å†²åŒºè¿˜å¯ä»¥é€šè¿‡<strong>FileChannel çš„map() æ–¹æ³•</strong>å°†æ–‡ä»¶åŒºåŸŸç›´æ¥æ˜ å°„åˆ°å†…å­˜ä¸­æ¥åˆ›å»ºã€‚è¯¥æ–¹æ³•è¿”å›<strong>MappedByteBuffer</strong> ã€‚Java å¹³å°çš„å®ç°æœ‰åŠ©äºé€šè¿‡JNI ä»æœ¬æœºä»£ç åˆ›å»ºç›´æ¥å­—èŠ‚ç¼“å†²åŒºã€‚å¦‚æœä»¥ä¸Šè¿™äº›ç¼“å†²åŒºä¸­çš„æŸä¸ªç¼“å†²åŒºå®ä¾‹æŒ‡çš„æ˜¯ä¸å¯è®¿é—®çš„å†…å­˜åŒºåŸŸï¼Œåˆ™è¯•å›¾è®¿é—®è¯¥åŒºåŸŸä¸ä¼šæ›´æ”¹è¯¥ç¼“å†²åŒºçš„å†…å®¹ï¼Œå¹¶ä¸”å°†ä¼šåœ¨è®¿é—®æœŸé—´æˆ–ç¨åçš„æŸä¸ªæ—¶é—´å¯¼è‡´æŠ›å‡ºä¸ç¡®å®šçš„å¼‚å¸¸ã€‚</li>
  <li>å­—èŠ‚ç¼“å†²åŒºæ˜¯ç›´æ¥ç¼“å†²åŒºè¿˜æ˜¯éç›´æ¥ç¼“å†²åŒºå¯é€šè¿‡è°ƒç”¨å…¶<strong>isDirect()</strong> æ–¹æ³•æ¥ç¡®å®šã€‚æä¾›æ­¤æ–¹æ³•æ˜¯ä¸ºäº†èƒ½å¤Ÿåœ¨æ€§èƒ½å…³é”®å‹ä»£ç ä¸­æ‰§è¡Œæ˜¾å¼ç¼“å†²åŒºç®¡ç†ã€‚</li>
  <li>éç›´æ¥ç¼“å†²åŒº</li>
</ul>

<p><img src="https://i.loli.net/2020/08/01/ShI3nKeuFicRE7g.png" alt="image.png" /></p>

<ul>
  <li>ç›´æ¥ç¼“å†²åŒº</li>
</ul>

<p><img src="https://i.loli.net/2020/08/01/k5x8HTrZYWdq4BP.png" alt="image.png" /></p>

<ul>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * ä¸€ã€ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šåœ¨ Java NIO ä¸­è´Ÿè´£æ•°æ®çš„å­˜å–ã€‚ç¼“å†²åŒºå°±æ˜¯æ•°ç»„ã€‚ç”¨äºå­˜å‚¨ä¸åŒæ•°æ®ç±»å‹çš„æ•°æ®
 * 
 * æ ¹æ®æ•°æ®ç±»å‹ä¸åŒï¼ˆboolean é™¤å¤–ï¼‰ï¼Œæä¾›äº†ç›¸åº”ç±»å‹çš„ç¼“å†²åŒºï¼š
 * ByteBuffer
 * CharBuffer
 * ShortBuffer
 * IntBuffer
 * LongBuffer
 * FloatBuffer
 * DoubleBuffer
 * 
 * ä¸Šè¿°ç¼“å†²åŒºçš„ç®¡ç†æ–¹å¼å‡ ä¹ä¸€è‡´ï¼Œé€šè¿‡ allocate() è·å–ç¼“å†²åŒº
 * 
 * äºŒã€ç¼“å†²åŒºå­˜å–æ•°æ®çš„ä¸¤ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼š
 * put() : å­˜å…¥æ•°æ®åˆ°ç¼“å†²åŒºä¸­
 * get() : è·å–ç¼“å†²åŒºä¸­çš„æ•°æ®
 * 
 * ä¸‰ã€ç¼“å†²åŒºä¸­çš„å››ä¸ªæ ¸å¿ƒå±æ€§ï¼š
 * capacity : å®¹é‡ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­æœ€å¤§å­˜å‚¨æ•°æ®çš„å®¹é‡ã€‚ä¸€æ—¦å£°æ˜ä¸èƒ½æ”¹å˜ã€‚
 * limit : ç•Œé™ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­å¯ä»¥æ“ä½œæ•°æ®çš„å¤§å°ã€‚ï¼ˆlimit åæ•°æ®ä¸èƒ½è¿›è¡Œè¯»å†™ï¼‰
 * position : ä½ç½®ï¼Œè¡¨ç¤ºç¼“å†²åŒºä¸­æ­£åœ¨æ“ä½œæ•°æ®çš„ä½ç½®ã€‚
 * 
 * mark : æ ‡è®°ï¼Œè¡¨ç¤ºè®°å½•å½“å‰ position çš„ä½ç½®ã€‚å¯ä»¥é€šè¿‡ reset() æ¢å¤åˆ° mark çš„ä½ç½®
 * 
 * 0 &lt;= mark &lt;= position &lt;= limit &lt;= capacity
 * 
 * å››ã€ç›´æ¥ç¼“å†²åŒºä¸éç›´æ¥ç¼“å†²åŒºï¼š
 * éç›´æ¥ç¼“å†²åŒºï¼šé€šè¿‡ allocate() æ–¹æ³•åˆ†é…ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºå»ºç«‹åœ¨ JVM çš„å†…å­˜ä¸­
 * ç›´æ¥ç¼“å†²åŒºï¼šé€šè¿‡ allocateDirect() æ–¹æ³•åˆ†é…ç›´æ¥ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºå»ºç«‹åœ¨ç‰©ç†å†…å­˜ä¸­ã€‚å¯ä»¥æé«˜æ•ˆç‡
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBuffer</span> <span class="o">{</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">(){</span>
		<span class="c1">//åˆ†é…ç›´æ¥ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">isDirect</span><span class="o">());</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">(){</span>
		<span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"abcde"</span><span class="o">;</span>
		
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
		
		<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		
		<span class="kt">byte</span><span class="o">[]</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dst</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">dst</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		
		<span class="c1">//mark() : æ ‡è®°</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">mark</span><span class="o">();</span>
		
		<span class="n">buf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dst</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">dst</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		
		<span class="c1">//reset() : æ¢å¤åˆ° mark çš„ä½ç½®</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">reset</span><span class="o">();</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		
		<span class="c1">//åˆ¤æ–­ç¼“å†²åŒºä¸­æ˜¯å¦è¿˜æœ‰å‰©ä½™æ•°æ®</span>
		<span class="k">if</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
			
			<span class="c1">//è·å–ç¼“å†²åŒºä¸­å¯ä»¥æ“ä½œçš„æ•°é‡</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">remaining</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span>
		<span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"abcde"</span><span class="o">;</span>
		
		<span class="c1">//1. åˆ†é…ä¸€ä¸ªæŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------allocate()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="c1">//2. åˆ©ç”¨ put() å­˜å…¥æ•°æ®åˆ°ç¼“å†²åŒºä¸­</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------put()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="c1">//3. åˆ‡æ¢è¯»å–æ•°æ®æ¨¡å¼</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------flip()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="c1">//4. åˆ©ç”¨ get() è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®</span>
		<span class="kt">byte</span><span class="o">[]</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dst</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">dst</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">dst</span><span class="o">.</span><span class="na">length</span><span class="o">));</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------get()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="c1">//5. rewind() : å¯é‡å¤è¯»</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------rewind()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="c1">//6. clear() : æ¸…ç©ºç¼“å†²åŒº. ä½†æ˜¯ç¼“å†²åŒºä¸­çš„æ•°æ®ä¾ç„¶å­˜åœ¨ï¼Œä½†æ˜¯å¤„äºâ€œè¢«é—å¿˜â€çŠ¶æ€</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------clear()----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">position</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">());</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span><span class="n">buf</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
		
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h4 id="é€šé“channel">é€šé“ï¼ˆChannelï¼‰</h4>

<ul>
  <li>é€šé“ï¼ˆChannelï¼‰ï¼šç”±java.nio.channels åŒ…å®šä¹‰çš„ã€‚Channel è¡¨ç¤ºIO æºä¸ç›®æ ‡æ‰“å¼€çš„è¿æ¥ã€‚ Channel ç±»ä¼¼äºä¼ ç»Ÿçš„â€œæµâ€ã€‚åªä¸è¿‡ Channelæœ¬èº«ä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®ï¼ŒChannel åªèƒ½ä¸Buffer è¿›è¡Œäº¤äº’ã€‚</li>
  <li>Java ä¸º Channel æ¥å£æä¾›çš„æœ€ä¸»è¦å®ç°ç±»å¦‚ä¸‹ï¼š
    <ul>
      <li>FileChannelï¼šç”¨äºè¯»å–ã€å†™å…¥ã€æ˜ å°„å’Œæ“ä½œæ–‡ä»¶çš„é€šé“ã€‚</li>
      <li>DatagramChannelï¼šé€šè¿‡ UDP è¯»å†™ç½‘ç»œä¸­çš„æ•°æ®é€šé“ã€‚</li>
      <li>SocketChannelï¼šé€šè¿‡ TCP è¯»å†™ç½‘ç»œä¸­çš„æ•°æ®ã€‚</li>
      <li>ServerSocketChannelï¼šå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„ TCP è¿æ¥ï¼Œå¯¹æ¯ä¸€ä¸ªæ–°è¿›æ¥çš„è¿æ¥éƒ½ä¼šåˆ›å»ºä¸€ä¸ªSocketChannelã€‚</li>
    </ul>
  </li>
  <li>è·å–é€šé“çš„ä¸€ç§æ–¹å¼æ˜¯å¯¹æ”¯æŒé€šé“çš„å¯¹è±¡è°ƒç”¨<strong>getChannel() æ–¹æ³•</strong>ã€‚æ”¯æŒé€šé“çš„ç±»å¦‚ä¸‹ï¼š
    <ul>
      <li>FileInputStream</li>
      <li>FileOutputStream</li>
      <li>RandomAccessFile</li>
      <li>DatagramSocket</li>
      <li>Socket</li>
      <li>ServerSocket</li>
    </ul>
  </li>
  <li>è·å–é€šé“çš„å…¶ä»–æ–¹å¼æ˜¯ä½¿ç”¨ Files ç±»çš„é™æ€æ–¹æ³• <strong>newByteChannel()</strong> è·å–å­—èŠ‚é€šé“ã€‚æˆ–è€…é€šè¿‡é€šé“çš„é™æ€æ–¹æ³• <strong>open()</strong> æ‰“å¼€å¹¶è¿”å›æŒ‡å®šé€šé“ã€‚</li>
  <li>é€šé“çš„æ•°æ®ä¼ è¾“
    <ul>
      <li>å°†Bufferä¸­çš„æ•°æ®å†™å…¥Channelï¼š<code class="language-plaintext highlighter-rouge">int bytesWritten = inChannel.write(buf)</code></li>
      <li>ä»Channelè¯»å–æ•°æ®åˆ°Bufferï¼š<code class="language-plaintext highlighter-rouge">int bytesRead = inChannel.read(buf)</code></li>
    </ul>
  </li>
  <li>æ¡ˆä¾‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ä¸€ã€é€šé“ï¼ˆChannelï¼‰ï¼šç”¨äºæºèŠ‚ç‚¹ä¸ç›®æ ‡èŠ‚ç‚¹çš„è¿æ¥ã€‚åœ¨ Java NIO ä¸­è´Ÿè´£ç¼“å†²åŒºä¸­æ•°æ®çš„ä¼ è¾“ã€‚Channel æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œå› æ­¤éœ€è¦é…åˆç¼“å†²åŒºè¿›è¡Œä¼ è¾“ã€‚
 * 
 * äºŒã€é€šé“çš„ä¸»è¦å®ç°ç±»
 * 	java.nio.channels.Channel æ¥å£ï¼š
 * 		|--FileChannel
 * 		|--SocketChannel
 * 		|--ServerSocketChannel
 * 		|--DatagramChannel
 * 
 * ä¸‰ã€è·å–é€šé“
 * 1. Java é’ˆå¯¹æ”¯æŒé€šé“çš„ç±»æä¾›äº† getChannel() æ–¹æ³•
 * 		æœ¬åœ° IOï¼š
 * 		FileInputStream/FileOutputStream
 * 		RandomAccessFile
 * 
 * 		ç½‘ç»œIOï¼š
 * 		Socket
 * 		ServerSocket
 * 		DatagramSocket
 * 		
 * 2. åœ¨ JDK 1.7 ä¸­çš„ NIO.2 é’ˆå¯¹å„ä¸ªé€šé“æä¾›äº†é™æ€æ–¹æ³• open()
 * 3. åœ¨ JDK 1.7 ä¸­çš„ NIO.2 çš„ Files å·¥å…·ç±»çš„ newByteChannel()
 * 
 * å››ã€é€šé“ä¹‹é—´çš„æ•°æ®ä¼ è¾“
 * transferFrom()
 * transferTo()
 * 
 * äº”ã€åˆ†æ•£(Scatter)ä¸èšé›†(Gather)
 * åˆ†æ•£è¯»å–ï¼ˆScattering Readsï¼‰ï¼šå°†é€šé“ä¸­çš„æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªç¼“å†²åŒºä¸­
 * èšé›†å†™å…¥ï¼ˆGathering Writesï¼‰ï¼šå°†å¤šä¸ªç¼“å†²åŒºä¸­çš„æ•°æ®èšé›†åˆ°é€šé“ä¸­
 * 
 * å…­ã€å­—ç¬¦é›†ï¼šCharset
 * ç¼–ç ï¼šå­—ç¬¦ä¸² -&gt; å­—èŠ‚æ•°ç»„
 * è§£ç ï¼šå­—èŠ‚æ•°ç»„  -&gt; å­—ç¬¦ä¸²
 * 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestChannel</span> <span class="o">{</span>
	
	<span class="c1">//å­—ç¬¦é›†</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test6</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="nc">Charset</span> <span class="n">cs1</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"GBK"</span><span class="o">);</span>
		
		<span class="c1">//è·å–ç¼–ç å™¨</span>
		<span class="nc">CharsetEncoder</span> <span class="n">ce</span> <span class="o">=</span> <span class="n">cs1</span><span class="o">.</span><span class="na">newEncoder</span><span class="o">();</span>
		
		<span class="c1">//è·å–è§£ç å™¨</span>
		<span class="nc">CharsetDecoder</span> <span class="n">cd</span> <span class="o">=</span> <span class="n">cs1</span><span class="o">.</span><span class="na">newDecoder</span><span class="o">();</span>
		
		<span class="nc">CharBuffer</span> <span class="n">cBuf</span> <span class="o">=</span> <span class="nc">CharBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		<span class="n">cBuf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"å°šç¡…è°·å¨æ­¦ï¼"</span><span class="o">);</span>
		<span class="n">cBuf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		
		<span class="c1">//ç¼–ç </span>
		<span class="nc">ByteBuffer</span> <span class="n">bBuf</span> <span class="o">=</span> <span class="n">ce</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">cBuf</span><span class="o">);</span>
		
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bBuf</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
		<span class="o">}</span>
		
		<span class="c1">//è§£ç </span>
		<span class="n">bBuf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		<span class="nc">CharBuffer</span> <span class="n">cBuf2</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">bBuf</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cBuf2</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"------------------------------------------------------"</span><span class="o">);</span>
		
		<span class="nc">Charset</span> <span class="n">cs2</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"GBK"</span><span class="o">);</span>
		<span class="n">bBuf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		<span class="nc">CharBuffer</span> <span class="n">cBuf3</span> <span class="o">=</span> <span class="n">cs2</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">bBuf</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">cBuf3</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test5</span><span class="o">(){</span>
		<span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">&gt;</span> <span class="n">map</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">availableCharsets</span><span class="o">();</span>
		
		<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">&gt;&gt;</span> <span class="n">set</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">entrySet</span><span class="o">();</span>
		
		<span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Charset</span><span class="o">&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="n">set</span><span class="o">)</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getKey</span><span class="o">()</span> <span class="o">+</span> <span class="s">"="</span> <span class="o">+</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
	<span class="c1">//åˆ†æ•£å’Œèšé›†</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test4</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="nc">RandomAccessFile</span> <span class="n">raf1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"1.txt"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
		
		<span class="c1">//1. è·å–é€šé“</span>
		<span class="nc">FileChannel</span> <span class="n">channel1</span> <span class="o">=</span> <span class="n">raf1</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
		
		<span class="c1">//2. åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf1</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf2</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="c1">//3. åˆ†æ•£è¯»å–</span>
		<span class="nc">ByteBuffer</span><span class="o">[]</span> <span class="n">bufs</span> <span class="o">=</span> <span class="o">{</span><span class="n">buf1</span><span class="o">,</span> <span class="n">buf2</span><span class="o">};</span>
		<span class="n">channel1</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bufs</span><span class="o">);</span>
		
		<span class="k">for</span> <span class="o">(</span><span class="nc">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">:</span> <span class="n">bufs</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">byteBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bufs</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bufs</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">limit</span><span class="o">()));</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"-----------------"</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bufs</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bufs</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">limit</span><span class="o">()));</span>
		
		<span class="c1">//4. èšé›†å†™å…¥</span>
		<span class="nc">RandomAccessFile</span> <span class="n">raf2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RandomAccessFile</span><span class="o">(</span><span class="s">"2.txt"</span><span class="o">,</span> <span class="s">"rw"</span><span class="o">);</span>
		<span class="nc">FileChannel</span> <span class="n">channel2</span> <span class="o">=</span> <span class="n">raf2</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
		
		<span class="n">channel2</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">bufs</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="c1">//é€šé“ä¹‹é—´çš„æ•°æ®ä¼ è¾“(ç›´æ¥ç¼“å†²åŒº)</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test3</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
		<span class="nc">FileChannel</span> <span class="n">inChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"1.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">);</span>
		<span class="nc">FileChannel</span> <span class="n">outChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"4.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">WRITE</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">);</span>
		
<span class="c1">//		inChannel.transferTo(0, inChannel.size(), outChannel);</span>
		<span class="n">outChannel</span><span class="o">.</span><span class="na">transferFrom</span><span class="o">(</span><span class="n">inChannel</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">inChannel</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
		
		<span class="n">inChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">outChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="c1">//ä½¿ç”¨ç›´æ¥ç¼“å†²åŒºå®Œæˆæ–‡ä»¶çš„å¤åˆ¶(å†…å­˜æ˜ å°„æ–‡ä»¶)</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test2</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span><span class="c1">//2127-1902-1777</span>
<span class="c1">//		long start = System.currentTimeMillis();</span>
		
		<span class="nc">FileChannel</span> <span class="n">inChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"1.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">);</span>
		<span class="nc">FileChannel</span> <span class="n">outChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"3.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">WRITE</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">);</span>
		
		<span class="c1">//å†…å­˜æ˜ å°„æ–‡ä»¶</span>
		<span class="nc">MappedByteBuffer</span> <span class="n">inMappedBuf</span> <span class="o">=</span> <span class="n">inChannel</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">MapMode</span><span class="o">.</span><span class="na">READ_ONLY</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">inChannel</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
		<span class="nc">MappedByteBuffer</span> <span class="n">outMappedBuf</span> <span class="o">=</span> <span class="n">outChannel</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nc">MapMode</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">inChannel</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
		
		<span class="c1">//ç›´æ¥å¯¹ç¼“å†²åŒºè¿›è¡Œæ•°æ®çš„è¯»å†™æ“ä½œ</span>
		<span class="kt">byte</span><span class="o">[]</span> <span class="n">dst</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">inMappedBuf</span><span class="o">.</span><span class="na">limit</span><span class="o">()];</span>
		<span class="n">inMappedBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">dst</span><span class="o">);</span>
		<span class="n">outMappedBuf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">dst</span><span class="o">);</span>
		
		<span class="n">inChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">outChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		
<span class="c1">//		long end = System.currentTimeMillis();</span>
<span class="c1">//		System.out.println("è€—è´¹æ—¶é—´ä¸ºï¼š" + (end - start));</span>
	<span class="o">}</span>
	
	<span class="c1">//åˆ©ç”¨é€šé“å®Œæˆæ–‡ä»¶çš„å¤åˆ¶ï¼ˆéç›´æ¥ç¼“å†²åŒºï¼‰</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">(){</span><span class="c1">//10874-10953</span>
<span class="c1">//		long start = System.currentTimeMillis();</span>
		
		<span class="nc">FileInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="c1">//â‘ è·å–é€šé“</span>
		<span class="nc">FileChannel</span> <span class="n">inChannel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="nc">FileChannel</span> <span class="n">outChannel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="s">"1.jpg"</span><span class="o">);</span>
			<span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="s">"2.jpg"</span><span class="o">);</span>
			
			<span class="n">inChannel</span> <span class="o">=</span> <span class="n">fis</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
			<span class="n">outChannel</span> <span class="o">=</span> <span class="n">fos</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
			
			<span class="c1">//â‘¡åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
			<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
			
			<span class="c1">//â‘¢å°†é€šé“ä¸­çš„æ•°æ®å­˜å…¥ç¼“å†²åŒºä¸­</span>
			<span class="k">while</span><span class="o">(</span><span class="n">inChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
				<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span> <span class="c1">//åˆ‡æ¢è¯»å–æ•°æ®çš„æ¨¡å¼</span>
				<span class="c1">//â‘£å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥é€šé“ä¸­</span>
				<span class="n">outChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
				<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="c1">//æ¸…ç©ºç¼“å†²åŒº</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="k">if</span><span class="o">(</span><span class="n">outChannel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">outChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="k">if</span><span class="o">(</span><span class="n">inChannel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">inChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="k">if</span><span class="o">(</span><span class="n">fos</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="k">if</span><span class="o">(</span><span class="n">fis</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">fis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
		
<span class="c1">//		long end = System.currentTimeMillis();</span>
<span class="c1">//		System.out.println("è€—è´¹æ—¶é—´ä¸ºï¼š" + (end - start));</span>
		
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>é˜»å¡NIO</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ä¸€ã€ä½¿ç”¨ NIO å®Œæˆç½‘ç»œé€šä¿¡çš„ä¸‰ä¸ªæ ¸å¿ƒï¼š
 * 
 * 1. é€šé“ï¼ˆChannelï¼‰ï¼šè´Ÿè´£è¿æ¥
 * 		
 * 	   java.nio.channels.Channel æ¥å£ï¼š
 * 			|--SelectableChannel
 * 				|--SocketChannel
 * 				|--ServerSocketChannel
 * 				|--DatagramChannel
 * 
 * 				|--Pipe.SinkChannel
 * 				|--Pipe.SourceChannel
 * 
 * 2. ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šè´Ÿè´£æ•°æ®çš„å­˜å–
 * 
 * 3. é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ï¼šæ˜¯ SelectableChannel çš„å¤šè·¯å¤ç”¨å™¨ã€‚ç”¨äºç›‘æ§ SelectableChannel çš„ IO çŠ¶å†µ
 * 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestBlockingNIO</span> <span class="o">{</span>

	<span class="c1">//å®¢æˆ·ç«¯</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">client</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="c1">//1. è·å–é€šé“</span>
		<span class="nc">SocketChannel</span> <span class="n">sChannel</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">9898</span><span class="o">));</span>
		
		<span class="nc">FileChannel</span> <span class="n">inChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"1.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">READ</span><span class="o">);</span>
		
		<span class="c1">//2. åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="c1">//3. è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå¹¶å‘é€åˆ°æœåŠ¡ç«¯</span>
		<span class="k">while</span><span class="o">(</span><span class="n">inChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
			<span class="n">sChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="c1">//4. å…³é—­é€šé“</span>
		<span class="n">inChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">sChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="c1">//æœåŠ¡ç«¯</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">server</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="c1">//1. è·å–é€šé“</span>
		<span class="nc">ServerSocketChannel</span> <span class="n">ssChannel</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="nc">FileChannel</span> <span class="n">outChannel</span> <span class="o">=</span> <span class="nc">FileChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="nc">Paths</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"5.jpg"</span><span class="o">),</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">WRITE</span><span class="o">,</span> <span class="nc">StandardOpenOption</span><span class="o">.</span><span class="na">CREATE</span><span class="o">);</span>
		
		<span class="c1">//2. ç»‘å®šè¿æ¥</span>
		<span class="n">ssChannel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9898</span><span class="o">));</span>
		
		<span class="c1">//3. è·å–å®¢æˆ·ç«¯è¿æ¥çš„é€šé“</span>
		<span class="nc">SocketChannel</span> <span class="n">sChannel</span> <span class="o">=</span> <span class="n">ssChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
		
		<span class="c1">//4. åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="c1">//5. æ¥æ”¶å®¢æˆ·ç«¯çš„æ•°æ®ï¼Œå¹¶ä¿å­˜åˆ°æœ¬åœ°</span>
		<span class="k">while</span><span class="o">(</span><span class="n">sChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">){</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
			<span class="n">outChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="c1">//6. å…³é—­é€šé“</span>
		<span class="n">sChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">outChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">ssChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		
	<span class="o">}</span>
	
<span class="o">}</span>
</code></pre></div></div>

<h3 id="åˆ†æ•£scatterå’Œèšé›†gather">åˆ†æ•£ï¼ˆScatterï¼‰å’Œèšé›†ï¼ˆGatherï¼‰</h3>

<ul>
  <li>åˆ†æ•£è¯»å–ï¼ˆScattering Readsï¼‰æ˜¯æŒ‡ä»Channel ä¸­è¯»å–çš„æ•°æ®â€œåˆ†æ•£â€åˆ°å¤šä¸ªBuffer ä¸­ã€‚æ³¨æ„ï¼šæŒ‰ç…§ç¼“å†²åŒºçš„é¡ºåºï¼Œä» Channel ä¸­è¯»å–çš„æ•°æ®ä¾æ¬¡å°† Buffer å¡«æ»¡ã€‚</li>
  <li><img src="https://i.loli.net/2020/08/01/u9Mw6ZrAjl7aBFq.png" alt="image.png" /></li>
  <li>èšé›†å†™å…¥ï¼ˆGathering Writesï¼‰æ˜¯æŒ‡å°†å¤šä¸ªBuffer ä¸­çš„æ•°æ®â€œèšé›†â€ åˆ°Channelã€‚æ³¨æ„ï¼šæŒ‰ç…§ç¼“å†²åŒºçš„é¡ºåºï¼Œå†™å…¥ position å’Œ limit ä¹‹é—´çš„æ•°æ®åˆ° Channel ã€‚</li>
  <li>FileChannnelçš„å¸¸ç”¨æ–¹æ³•ï¼š</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æ–¹æ³•</th>
      <th style="text-align: center">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">int read(ByteBuffer dst)</td>
      <td style="text-align: center">ä» Channel ä¸­è¯»å–æ•°æ®åˆ° ByteBuffer</td>
    </tr>
    <tr>
      <td style="text-align: center">long read(ByteBuffer[] dsts)</td>
      <td style="text-align: center">å°† Channel ä¸­çš„æ•°æ®â€œåˆ†æ•£â€åˆ° ByteBuffer[]</td>
    </tr>
    <tr>
      <td style="text-align: center">int write(ByteBuffer src)</td>
      <td style="text-align: center">å°† ByteBuffer ä¸­çš„æ•°æ®å†™å…¥åˆ° Channel</td>
    </tr>
    <tr>
      <td style="text-align: center">long write(ByteBuffer[] srcs)</td>
      <td style="text-align: center">å°† ByteBuffer[] ä¸­çš„æ•°æ®â€œèšé›†â€åˆ° Channel</td>
    </tr>
    <tr>
      <td style="text-align: center">long position()</td>
      <td style="text-align: center">è¿”å›æ­¤é€šé“çš„æ–‡ä»¶ä½ç½®</td>
    </tr>
    <tr>
      <td style="text-align: center">FileChannel position(long p)</td>
      <td style="text-align: center">è®¾ç½®æ­¤é€šé“çš„æ–‡ä»¶ä½ç½®</td>
    </tr>
    <tr>
      <td style="text-align: center">long size()</td>
      <td style="text-align: center">è¿”å›æ­¤é€šé“çš„æ–‡ä»¶çš„å½“å‰å¤§å°</td>
    </tr>
    <tr>
      <td style="text-align: center">FileChannel truncate(long s)</td>
      <td style="text-align: center">å°†æ­¤é€šé“çš„æ–‡ä»¶æˆªå–ä¸ºç»™å®šå¤§å°</td>
    </tr>
    <tr>
      <td style="text-align: center">void force(boolean metaData)</td>
      <td style="text-align: center">å¼ºåˆ¶å°†æ‰€æœ‰å¯¹æ­¤é€šé“çš„æ–‡ä»¶æ›´æ–°å†™å…¥åˆ°å­˜å‚¨è®¾å¤‡ä¸­</td>
    </tr>
  </tbody>
</table>

<h3 id="é€‰æ‹©å™¨selector">é€‰æ‹©å™¨ï¼ˆSelectorï¼‰</h3>

<ul>
  <li>é€‰æ‹©å™¨ï¼ˆSelectorï¼‰æ˜¯SelectableChannle å¯¹è±¡çš„å¤šè·¯å¤ç”¨å™¨ï¼Œ<strong>Selector å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ªSelectableChannel çš„IO çŠ¶å†µ</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ©ç”¨Selectorå¯ä½¿ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ç®¡ç†å¤šä¸ªChannelã€‚Selector æ˜¯éé˜»å¡IO çš„æ ¸å¿ƒã€‚</li>
  <li>åˆ›å»ºSelector ï¼šé€šè¿‡è°ƒç”¨Selector.open() æ–¹æ³•åˆ›å»ºä¸€ä¸ªSelectorã€‚<code class="language-plaintext highlighter-rouge">Selector sr = Selector.open()</code></li>
  <li>å‘é€‰æ‹©å™¨æ³¨å†Œé€šé“ï¼š<code class="language-plaintext highlighter-rouge">SelectableChannel.register(Selector sel,int ops)</code></li>
  <li>å½“è°ƒç”¨register(Selector sel, int ops)  å°†é€šé“æ³¨å†Œé€‰æ‹©å™¨æ—¶ï¼Œé€‰æ‹©å™¨å¯¹é€šé“çš„ç›‘å¬äº‹ä»¶ï¼Œéœ€è¦é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ops æŒ‡å®šã€‚</li>
  <li>å¯ä»¥ç›‘å¬çš„äº‹ä»¶ç±»å‹ï¼ˆå¯ä½¿ç”¨SelectionKey çš„å››ä¸ªå¸¸é‡è¡¨ç¤ºï¼‰ï¼š
    <ul>
      <li>è¯»: SelectionKey.OP_READ</li>
      <li>å†™: SelectionKey.OP_WRITE</li>
      <li>è¿æ¥: SelectionKey.OP_CONNECT</li>
      <li>æ¥æ”¶: SelectionKey.OP_ACCEPT</li>
    </ul>
  </li>
  <li>selectorçš„å¸¸ç”¨æ–¹æ³•ï¼š</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æ–¹æ³•</th>
      <th style="text-align: center">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center"><code class="language-plaintext highlighter-rouge">Set&lt;SelectionKey&gt; keys()</code></td>
      <td style="text-align: center">æ‰€æœ‰çš„ SelectionKey é›†åˆã€‚ä»£è¡¨æ³¨å†Œåœ¨è¯¥Selectorä¸Šçš„Channel</td>
    </tr>
    <tr>
      <td style="text-align: center">selectedKeys()</td>
      <td style="text-align: center">è¢«é€‰æ‹©çš„ SelectionKey é›†åˆã€‚è¿”å›æ­¤Selectorçš„å·²é€‰æ‹©é”®é›†</td>
    </tr>
    <tr>
      <td style="text-align: center">int select()</td>
      <td style="text-align: center">ç›‘æ§æ‰€æœ‰æ³¨å†Œçš„Channelï¼Œå½“å®ƒä»¬ä¸­é—´æœ‰éœ€è¦å¤„ç†çš„ IO æ“ä½œæ—¶ï¼Œè¯¥æ–¹æ³•è¿”å›ï¼Œå¹¶å°†å¯¹åº”å¾—çš„ SelectionKey åŠ å…¥è¢«é€‰æ‹©çš„SelectionKey é›†åˆä¸­ï¼Œè¯¥æ–¹æ³•è¿”å›è¿™äº› Channel çš„æ•°é‡ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: center">int select(long timeout)</td>
      <td style="text-align: center">å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é•¿çš„ select() æ“ä½œ</td>
    </tr>
    <tr>
      <td style="text-align: center">int selectNow()</td>
      <td style="text-align: center">æ‰§è¡Œä¸€ä¸ªç«‹å³è¿”å›çš„ select() æ“ä½œï¼Œè¯¥æ–¹æ³•ä¸ä¼šé˜»å¡çº¿ç¨‹</td>
    </tr>
    <tr>
      <td style="text-align: center">Selector wakeup()</td>
      <td style="text-align: center">ä½¿ä¸€ä¸ªè¿˜æœªè¿”å›çš„ select() æ–¹æ³•ç«‹å³è¿”å›</td>
    </tr>
    <tr>
      <td style="text-align: center">void close()</td>
      <td style="text-align: center">å…³é—­è¯¥é€‰æ‹©å™¨</td>
    </tr>
  </tbody>
</table>

<ul>
  <li><strong>SelectionKey</strong>ï¼šè¡¨ç¤ºSelectableChannel å’ŒSelector ä¹‹é—´çš„æ³¨å†Œå…³ç³»ã€‚æ¯æ¬¡å‘é€‰æ‹©å™¨æ³¨å†Œé€šé“æ—¶å°±ä¼šé€‰æ‹©ä¸€ä¸ªäº‹ä»¶(é€‰æ‹©é”®)ã€‚é€‰æ‹©é”®åŒ…å«ä¸¤ä¸ªè¡¨ç¤ºä¸ºæ•´æ•°å€¼çš„æ“ä½œé›†ã€‚æ“ä½œé›†çš„æ¯ä¸€ä½éƒ½è¡¨ç¤ºè¯¥é”®çš„é€šé“æ‰€æ”¯æŒçš„ä¸€ç±»å¯é€‰æ‹©æ“ä½œã€‚</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: center">æ–¹æ³•</th>
      <th style="text-align: center">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">int    interestOps()</td>
      <td style="text-align: center">è·å–æ„Ÿå…´è¶£äº‹ä»¶é›†åˆ</td>
    </tr>
    <tr>
      <td style="text-align: center">int    readyOps()</td>
      <td style="text-align: center">è·å–é€šé“å·²ç»å‡†å¤‡å°±ç»ªçš„æ“ä½œçš„é›†åˆ</td>
    </tr>
    <tr>
      <td style="text-align: center">SelectableChannel  channel()</td>
      <td style="text-align: center">è·å–æ³¨å†Œé€šé“</td>
    </tr>
    <tr>
      <td style="text-align: center">Selector  selector()</td>
      <td style="text-align: center">è¿”å›é€‰æ‹©å™¨</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean isReadable()</td>
      <td style="text-align: center">æ£€æµ‹ Channal ä¸­è¯»äº‹ä»¶æ˜¯å¦å°±ç»ª</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean isWritable()</td>
      <td style="text-align: center">æ£€æµ‹ Channal ä¸­å†™äº‹ä»¶æ˜¯å¦å°±ç»ª</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean isConnectable()</td>
      <td style="text-align: center">æ£€æµ‹ Channel ä¸­è¿æ¥æ˜¯å¦å°±ç»ª</td>
    </tr>
    <tr>
      <td style="text-align: center">boolean isAcceptable()</td>
      <td style="text-align: center">æ£€æµ‹ Channel ä¸­æ¥æ”¶æ˜¯å¦å°±ç»ª</td>
    </tr>
    <tr>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">Â </td>
    </tr>
  </tbody>
</table>

<ul>
  <li>
    <p>SocketChannelï¼šJava NIOä¸­çš„SocketChannelæ˜¯ä¸€ä¸ªè¿æ¥åˆ°TCPç½‘ç»œå¥—æ¥å­—çš„é€šé“ã€‚Java NIOä¸­çš„ServerSocketChannel æ˜¯ä¸€ä¸ªå¯ä»¥ç›‘å¬æ–°è¿›æ¥çš„TCPè¿æ¥çš„é€šé“ï¼Œå°±åƒæ ‡å‡†IOä¸­çš„ServerSocketä¸€æ ·ã€‚</p>
  </li>
  <li>
    <p>æ“ä½œæ­¥éª¤ï¼š</p>

    <p>æ‰“å¼€SocketChannel</p>

    <p>è¯»å†™æ•°æ®</p>

    <p>å…³é—­SocketChannel</p>
  </li>
  <li>
    <p>Java NIOä¸­çš„DatagramChannelæ˜¯ä¸€ä¸ªèƒ½æ”¶å‘UDPåŒ…çš„é€šé“ã€‚</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * ä¸€ã€ä½¿ç”¨ NIO å®Œæˆç½‘ç»œé€šä¿¡çš„ä¸‰ä¸ªæ ¸å¿ƒï¼š
 * 
 * 1. é€šé“ï¼ˆChannelï¼‰ï¼šè´Ÿè´£è¿æ¥
 * 		
 * 	   java.nio.channels.Channel æ¥å£ï¼š
 * 			|--SelectableChannel
 * 				|--SocketChannel
 * 				|--ServerSocketChannel
 * 				|--DatagramChannel
 * 
 * 				|--Pipe.SinkChannel
 * 				|--Pipe.SourceChannel
 * 
 * 2. ç¼“å†²åŒºï¼ˆBufferï¼‰ï¼šè´Ÿè´£æ•°æ®çš„å­˜å–
 * 
 * 3. é€‰æ‹©å™¨ï¼ˆSelectorï¼‰ï¼šæ˜¯ SelectableChannel çš„å¤šè·¯å¤ç”¨å™¨ã€‚ç”¨äºç›‘æ§ SelectableChannel çš„ IO çŠ¶å†µ
 * 
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestNonBlockingNIO</span> <span class="o">{</span>
	
	<span class="c1">//å®¢æˆ·ç«¯</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">client</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="c1">//1. è·å–é€šé“</span>
		<span class="nc">SocketChannel</span> <span class="n">sChannel</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">9898</span><span class="o">));</span>
		
		<span class="c1">//2. åˆ‡æ¢éé˜»å¡æ¨¡å¼</span>
		<span class="n">sChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
		
		<span class="c1">//3. åˆ†é…æŒ‡å®šå¤§å°çš„ç¼“å†²åŒº</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="c1">//4. å‘é€æ•°æ®ç»™æœåŠ¡ç«¯</span>
		<span class="nc">Scanner</span> <span class="n">scan</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
		
		<span class="k">while</span><span class="o">(</span><span class="n">scan</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
			<span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span> <span class="n">str</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
			<span class="n">sChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="c1">//5. å…³é—­é€šé“</span>
		<span class="n">sChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>

	<span class="c1">//æœåŠ¡ç«¯</span>
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">server</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="c1">//1. è·å–é€šé“</span>
		<span class="nc">ServerSocketChannel</span> <span class="n">ssChannel</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="c1">//2. åˆ‡æ¢éé˜»å¡æ¨¡å¼</span>
		<span class="n">ssChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
		
		<span class="c1">//3. ç»‘å®šè¿æ¥</span>
		<span class="n">ssChannel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9898</span><span class="o">));</span>
		
		<span class="c1">//4. è·å–é€‰æ‹©å™¨</span>
		<span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="c1">//5. å°†é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š, å¹¶ä¸”æŒ‡å®šâ€œç›‘å¬æ¥æ”¶äº‹ä»¶â€</span>
		<span class="n">ssChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
		
		<span class="c1">//6. è½®è¯¢å¼çš„è·å–é€‰æ‹©å™¨ä¸Šå·²ç»â€œå‡†å¤‡å°±ç»ªâ€çš„äº‹ä»¶</span>
		<span class="k">while</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
			
			<span class="c1">//7. è·å–å½“å‰é€‰æ‹©å™¨ä¸­æ‰€æœ‰æ³¨å†Œçš„â€œé€‰æ‹©é”®(å·²å°±ç»ªçš„ç›‘å¬äº‹ä»¶)â€</span>
			<span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
			
			<span class="k">while</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
				<span class="c1">//8. è·å–å‡†å¤‡â€œå°±ç»ªâ€çš„æ˜¯äº‹ä»¶</span>
				<span class="nc">SelectionKey</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
				
				<span class="c1">//9. åˆ¤æ–­å…·ä½“æ˜¯ä»€ä¹ˆäº‹ä»¶å‡†å¤‡å°±ç»ª</span>
				<span class="k">if</span><span class="o">(</span><span class="n">sk</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">()){</span>
					<span class="c1">//10. è‹¥â€œæ¥æ”¶å°±ç»ªâ€ï¼Œè·å–å®¢æˆ·ç«¯è¿æ¥</span>
					<span class="nc">SocketChannel</span> <span class="n">sChannel</span> <span class="o">=</span> <span class="n">ssChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
					
					<span class="c1">//11. åˆ‡æ¢éé˜»å¡æ¨¡å¼</span>
					<span class="n">sChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
					
					<span class="c1">//12. å°†è¯¥é€šé“æ³¨å†Œåˆ°é€‰æ‹©å™¨ä¸Š</span>
					<span class="n">sChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
				<span class="o">}</span><span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">sk</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()){</span>
					<span class="c1">//13. è·å–å½“å‰é€‰æ‹©å™¨ä¸Šâ€œè¯»å°±ç»ªâ€çŠ¶æ€çš„é€šé“</span>
					<span class="nc">SocketChannel</span> <span class="n">sChannel</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">sk</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
					
					<span class="c1">//14. è¯»å–æ•°æ®</span>
					<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
					
					<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
					<span class="k">while</span><span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">sChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">){</span>
						<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
						<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">));</span>
						<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
					<span class="o">}</span>
				<span class="o">}</span>
				
				<span class="c1">//15. å–æ¶ˆé€‰æ‹©é”® SelectionKey</span>
				<span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ç®¡é“pipe">ç®¡é“ï¼ˆPipeï¼‰</h3>

<ul>
  <li>Java NIO ç®¡é“æ˜¯2ä¸ªçº¿ç¨‹ä¹‹é—´çš„å•å‘æ•°æ®è¿æ¥ã€‚ Pipeæœ‰ä¸€ä¸ªsourceé€šé“å’Œä¸€ä¸ªsinké€šé“ã€‚æ•°æ®ä¼šè¢«å†™åˆ°sinké€šé“ï¼Œä»sourceé€šé“è¯»å–ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestNonBlockingNIO2</span> <span class="o">{</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="nc">DatagramChannel</span> <span class="n">dc</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="n">dc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
		
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="nc">Scanner</span> <span class="n">scan</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Scanner</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
		
		<span class="k">while</span><span class="o">(</span><span class="n">scan</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
			<span class="nc">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">scan</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="k">new</span> <span class="nc">Date</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">":\n"</span> <span class="o">+</span> <span class="n">str</span><span class="o">).</span><span class="na">getBytes</span><span class="o">());</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
			<span class="n">dc</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">9898</span><span class="o">));</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="o">}</span>
		
		<span class="n">dc</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="nc">DatagramChannel</span> <span class="n">dc</span> <span class="o">=</span> <span class="nc">DatagramChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="n">dc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
		
		<span class="n">dc</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">9898</span><span class="o">));</span>
		
		<span class="nc">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="n">dc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
		
		<span class="k">while</span><span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">){</span>
			<span class="nc">Iterator</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
			
			<span class="k">while</span><span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
				<span class="nc">SelectionKey</span> <span class="n">sk</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
				
				<span class="k">if</span><span class="o">(</span><span class="n">sk</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()){</span>
					<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
					
					<span class="n">dc</span><span class="o">.</span><span class="na">receive</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
					<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
					<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">buf</span><span class="o">.</span><span class="na">limit</span><span class="o">()));</span>
					<span class="n">buf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span>
			
			<span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>â€‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestPipe</span> <span class="o">{</span>

	<span class="nd">@Test</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">test1</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">{</span>
		<span class="c1">//1. è·å–ç®¡é“</span>
		<span class="nc">Pipe</span> <span class="n">pipe</span> <span class="o">=</span> <span class="nc">Pipe</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
		
		<span class="c1">//2. å°†ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç®¡é“</span>
		<span class="nc">ByteBuffer</span> <span class="n">buf</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
		
		<span class="nc">Pipe</span><span class="o">.</span><span class="na">SinkChannel</span> <span class="n">sinkChannel</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="na">sink</span><span class="o">();</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"é€šè¿‡å•å‘ç®¡é“å‘é€æ•°æ®"</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		<span class="n">sinkChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
		
		<span class="c1">//3. è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®</span>
		<span class="nc">Pipe</span><span class="o">.</span><span class="na">SourceChannel</span> <span class="n">sourceChannel</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">.</span><span class="na">source</span><span class="o">();</span>
		<span class="n">buf</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">sourceChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">));</span>
		
		<span class="n">sourceChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="n">sinkChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
	<span class="o">}</span>
	
<span class="o">}</span>
</code></pre></div></div>

<h3 id="æ–‡ä»¶æ‹·è´">æ–‡ä»¶æ‹·è´</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">interface</span> <span class="nc">FileCopyRunner</span> <span class="o">{</span>
 
    <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">);</span>
 
<span class="o">}</span>
 
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FileCopyDemo</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ROUNDS</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="c1">//æ—¶é—´æ€§èƒ½å¯¹æ¯”</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">benchmark</span><span class="o">(</span><span class="nc">FileCopyRunner</span> <span class="n">test</span><span class="o">,</span> <span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="no">ROUNDS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="n">test</span><span class="o">.</span><span class="na">copyFile</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">target</span><span class="o">);</span>
            <span class="n">elapsed</span> <span class="o">+=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">;</span>
            <span class="n">target</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">test</span> <span class="o">+</span> <span class="s">": "</span> <span class="o">+</span> <span class="n">elapsed</span> <span class="o">/</span> <span class="no">ROUNDS</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="c1">// å…³é—­èµ„æº</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Closeable</span> <span class="n">closeable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closeable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">closeable</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
 
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
         <span class="c1">// ä¸ä½¿ç”¨ç¼“å†²åŒºï¼Œå¾ˆæ…¢</span>
        <span class="nc">FileCopyRunner</span> <span class="n">noBufferStreamCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCopyRunner</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">InputStream</span> <span class="n">fin</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">OutputStream</span> <span class="n">fout</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">source</span><span class="o">);</span>
                    <span class="n">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">target</span><span class="o">);</span>
 
                    <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="na">read</span><span class="o">())</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">fout</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fin</span><span class="o">);</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fout</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"noBufferStreamCopy"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
 
         <span class="c1">//ä½¿ç”¨ç¼“å†²åŒº</span>
        <span class="nc">FileCopyRunner</span> <span class="n">bufferedStreamCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCopyRunner</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">InputStream</span> <span class="n">fin</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">OutputStream</span> <span class="n">fout</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedInputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
                    <span class="n">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BufferedOutputStream</span><span class="o">(</span><span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">target</span><span class="o">));</span>
 
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
 
                    <span class="kt">int</span> <span class="n">result</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">fout</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fin</span><span class="o">);</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fout</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"bufferedStreamCopy"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
 
         <span class="c1">//ä½¿ç”¨NIOç¼“å†²åŒº</span>
        <span class="nc">FileCopyRunner</span> <span class="n">nioBufferCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCopyRunner</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">FileChannel</span> <span class="n">fin</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">FileChannel</span> <span class="n">fout</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
 
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">source</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
                    <span class="n">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">target</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
 
                    <span class="nc">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">fin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                        <span class="k">while</span> <span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">fout</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fin</span><span class="o">);</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fout</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"nioBufferCopy"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
 
         <span class="c1">// ä½¿ç”¨NIOé€šé“</span>
        <span class="nc">FileCopyRunner</span> <span class="n">nioTransferCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCopyRunner</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">copyFile</span><span class="o">(</span><span class="nc">File</span> <span class="n">source</span><span class="o">,</span> <span class="nc">File</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">FileChannel</span> <span class="n">fin</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="nc">FileChannel</span> <span class="n">fout</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">fin</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileInputStream</span><span class="o">(</span><span class="n">source</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
                    <span class="n">fout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">target</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>
                    <span class="kt">long</span> <span class="n">transferred</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>
                    <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">transferred</span> <span class="o">!=</span> <span class="n">size</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">transferred</span> <span class="o">+=</span> <span class="n">fin</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">fout</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fin</span><span class="o">);</span>
                    <span class="n">close</span><span class="o">(</span><span class="n">fout</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="nc">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">return</span> <span class="s">"nioTransferCopy"</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>
 
         <span class="c1">//------------æµ‹è¯•å¼€å§‹----------------------</span>
        <span class="nc">File</span> <span class="n">smallFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/smallFile"</span><span class="o">);</span>
        <span class="nc">File</span> <span class="n">smallFileCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/smallFile-copy"</span><span class="o">);</span>
 
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---Copying small file---"</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">noBufferStreamCopy</span><span class="o">,</span> <span class="n">smallFile</span><span class="o">,</span> <span class="n">smallFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">bufferedStreamCopy</span><span class="o">,</span> <span class="n">smallFile</span><span class="o">,</span> <span class="n">smallFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioBufferCopy</span><span class="o">,</span> <span class="n">smallFile</span><span class="o">,</span> <span class="n">smallFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioTransferCopy</span><span class="o">,</span> <span class="n">smallFile</span><span class="o">,</span> <span class="n">smallFileCopy</span><span class="o">);</span>
 
        <span class="nc">File</span> <span class="n">bigFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/bigFile"</span><span class="o">);</span>
        <span class="nc">File</span> <span class="n">bigFileCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/bigFile-copy"</span><span class="o">);</span>
 
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---Copying big file---"</span><span class="o">);</span>
        <span class="c1">//benchmark(noBufferStreamCopy, bigFile, bigFileCopy);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">bufferedStreamCopy</span><span class="o">,</span> <span class="n">bigFile</span><span class="o">,</span> <span class="n">bigFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioBufferCopy</span><span class="o">,</span> <span class="n">bigFile</span><span class="o">,</span> <span class="n">bigFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioTransferCopy</span><span class="o">,</span> <span class="n">bigFile</span><span class="o">,</span> <span class="n">bigFileCopy</span><span class="o">);</span>
 
        <span class="nc">File</span> <span class="n">hugeFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/hugeFile"</span><span class="o">);</span>
        <span class="nc">File</span> <span class="n">hugeFileCopy</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="s">"/var/tmp/hugeFile-copy"</span><span class="o">);</span>
 
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"---Copying huge file---"</span><span class="o">);</span>
        <span class="c1">//benchmark(noBufferStreamCopy, hugeFile, hugeFileCopy);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">bufferedStreamCopy</span><span class="o">,</span> <span class="n">hugeFile</span><span class="o">,</span> <span class="n">hugeFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioBufferCopy</span><span class="o">,</span> <span class="n">hugeFile</span><span class="o">,</span> <span class="n">hugeFileCopy</span><span class="o">);</span>
        <span class="n">benchmark</span><span class="o">(</span><span class="n">nioTransferCopy</span><span class="o">,</span> <span class="n">hugeFile</span><span class="o">,</span> <span class="n">hugeFileCopy</span><span class="o">);</span>
 
    <span class="o">}</span>
 
<span class="o">}</span>

</code></pre></div></div>

<h3 id="èŠå¤©å®¤">èŠå¤©å®¤</h3>

<ul>
  <li>æœåŠ¡ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatServer</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_PORT</span> <span class="o">=</span> <span class="mi">8888</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUIT</span> <span class="o">=</span> <span class="s">"quit"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BUFFER</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nc">ServerSocketChannel</span> <span class="n">server</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Selector</span> <span class="n">selector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ByteBuffer</span> <span class="n">rBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFFER</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">ByteBuffer</span> <span class="n">wBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFFER</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">Charset</span> <span class="n">charset</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">ChatServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="no">DEFAULT_PORT</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nf">ChatServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">server</span> <span class="o">=</span> <span class="nc">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
             <span class="c1">//è®¾ç½®ä¸ºä¸é˜»å¡æ¨¡å¼</span>
            <span class="n">server</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
             <span class="c1">//ç»‘å®šç«¯å£</span>
            <span class="n">server</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">port</span><span class="o">));</span>
             <span class="c1">// å¼€å¯ä¸€ä¸ªselectoré€‰æ‹©å™¨</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">server</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¯åŠ¨æœåŠ¡å™¨ï¼Œ ç›‘å¬ç«¯å£ï¼š"</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">"..."</span><span class="o">);</span>
 
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectionKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">:</span> <span class="n">selectionKeys</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// å¤„ç†è¢«è§¦å‘çš„äº‹ä»¶</span>
                    <span class="n">handles</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">selectionKeys</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
 
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">selector</span><span class="o">);</span>
        <span class="o">}</span>
 
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handles</span><span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// ACCEPTäº‹ä»¶ - å’Œå®¢æˆ·ç«¯å»ºç«‹äº†è¿æ¥</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">ServerSocketChannel</span> <span class="n">server</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getClientName</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">+</span> <span class="s">"å·²è¿æ¥"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// READäº‹ä»¶ - å®¢æˆ·ç«¯å‘é€äº†æ¶ˆæ¯</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">fwdMsg</span> <span class="o">=</span> <span class="n">receive</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">fwdMsg</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// å®¢æˆ·ç«¯å¼‚å¸¸</span>
                <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                <span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getClientName</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">fwdMsg</span><span class="o">);</span>
                <span class="n">forwardMessage</span><span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">fwdMsg</span><span class="o">);</span>
 
                <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é€€å‡º</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">readyToQuit</span><span class="o">(</span><span class="n">fwdMsg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                    <span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">getClientName</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">+</span> <span class="s">"å·²æ–­å¼€"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
 
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">forwardMessage</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">client</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fwdMsg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">SelectionKey</span> <span class="nl">key:</span> <span class="n">selector</span><span class="o">.</span><span class="na">keys</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">Channel</span> <span class="n">connectedClient</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">connectedClient</span> <span class="k">instanceof</span> <span class="nc">ServerSocketChannel</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
 
            <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isValid</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">client</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">connectedClient</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">wBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
                <span class="n">wBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">charset</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">getClientName</span><span class="o">(</span><span class="n">client</span><span class="o">)</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">fwdMsg</span><span class="o">));</span>
                <span class="n">wBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">wBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
                    <span class="o">((</span><span class="nc">SocketChannel</span><span class="o">)</span><span class="n">connectedClient</span><span class="o">).</span><span class="na">write</span><span class="o">(</span><span class="n">wBuffer</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">receive</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">rBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">while</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">rBuffer</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">rBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">charset</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">rBuffer</span><span class="o">));</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">getClientName</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"å®¢æˆ·ç«¯["</span> <span class="o">+</span> <span class="n">client</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">readyToQuit</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">QUIT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Closeable</span> <span class="n">closable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">closable</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ChatServer</span> <span class="n">chatServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ChatServer</span><span class="o">(</span><span class="mi">7777</span><span class="o">);</span>
        <span class="n">chatServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>å®¢æˆ·ç«¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatClient</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_SERVER_HOST</span> <span class="o">=</span> <span class="s">"127.0.0.1"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_SERVER_PORT</span> <span class="o">=</span> <span class="mi">8888</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUIT</span> <span class="o">=</span> <span class="s">"quit"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">BUFFER</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">;</span>
 
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">host</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">SocketChannel</span> <span class="n">client</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">ByteBuffer</span> <span class="n">rBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFFER</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">ByteBuffer</span> <span class="n">wBuffer</span> <span class="o">=</span> <span class="nc">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="no">BUFFER</span><span class="o">);</span>
    <span class="kd">private</span> <span class="nc">Selector</span> <span class="n">selector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Charset</span> <span class="n">charset</span> <span class="o">=</span> <span class="nc">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
 
    <span class="kd">public</span> <span class="nf">ChatClient</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="no">DEFAULT_SERVER_HOST</span><span class="o">,</span> <span class="no">DEFAULT_SERVER_PORT</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="nf">ChatClient</span><span class="o">(</span><span class="nc">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">readyToQuit</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="no">QUIT</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">(</span><span class="nc">Closeable</span> <span class="n">closable</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">closable</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">client</span> <span class="o">=</span> <span class="nc">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
 
            <span class="n">selector</span> <span class="o">=</span> <span class="nc">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">);</span>
            <span class="n">client</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
 
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectionKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">key</span> <span class="o">:</span> <span class="n">selectionKeys</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">handles</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">selectionKeys</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClosedSelectorException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// ç”¨æˆ·æ­£å¸¸é€€å‡º</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">selector</span><span class="o">);</span>
        <span class="o">}</span>
 
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">handles</span><span class="o">(</span><span class="nc">SelectionKey</span> <span class="n">key</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">// CONNECTäº‹ä»¶ - è¿æ¥å°±ç»ªäº‹ä»¶</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isConnectable</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">isConnectionPending</span><span class="o">())</span> <span class="o">{</span>
                <span class="n">client</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">();</span>
                <span class="c1">// å¤„ç†ç”¨æˆ·çš„è¾“å…¥</span>
                <span class="k">new</span> <span class="nf">Thread</span><span class="o">(</span><span class="k">new</span> <span class="nc">UserInputHandler</span><span class="o">(</span><span class="k">this</span><span class="o">)).</span><span class="na">start</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="n">client</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="nc">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// READäº‹ä»¶ -  æœåŠ¡å™¨è½¬å‘æ¶ˆæ¯</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
            <span class="nc">SocketChannel</span> <span class="n">client</span> <span class="o">=</span> <span class="o">(</span><span class="nc">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="nc">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">receive</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
                <span class="c1">// æœåŠ¡å™¨å¼‚å¸¸</span>
                <span class="n">close</span><span class="o">(</span><span class="n">selector</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="o">(</span><span class="nc">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
 
        <span class="n">wBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">wBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">charset</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">msg</span><span class="o">));</span>
        <span class="n">wBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">wBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">client</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">wBuffer</span><span class="o">);</span>
        <span class="o">}</span>
 
        <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å‡†å¤‡é€€å‡º</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">readyToQuit</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">close</span><span class="o">(</span><span class="n">selector</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
 
    <span class="kd">private</span> <span class="nc">String</span> <span class="nf">receive</span><span class="o">(</span><span class="nc">SocketChannel</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">rBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">rBuffer</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">rBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">charset</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">rBuffer</span><span class="o">));</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ChatClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ChatClient</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">7777</span><span class="o">);</span>
        <span class="n">client</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserInputHandler</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
 
    <span class="kd">private</span> <span class="nc">ChatClient</span> <span class="n">chatClient</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">UserInputHandler</span><span class="o">(</span><span class="nc">ChatClient</span> <span class="n">chatClient</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">chatClient</span> <span class="o">=</span> <span class="n">chatClient</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// ç­‰å¾…ç”¨æˆ·è¾“å…¥æ¶ˆæ¯</span>
            <span class="nc">BufferedReader</span> <span class="n">consoleReader</span> <span class="o">=</span>
                    <span class="k">new</span> <span class="nf">BufferedReader</span><span class="o">(</span><span class="k">new</span> <span class="nc">InputStreamReader</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">));</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">input</span> <span class="o">=</span> <span class="n">consoleReader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
 
                <span class="c1">// å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯</span>
                <span class="n">chatClient</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">input</span><span class="o">);</span>
 
                <span class="c1">// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å‡†å¤‡é€€å‡º</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">chatClient</span><span class="o">.</span><span class="na">readyToQuit</span><span class="o">(</span><span class="n">input</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="path">Path</h3>

<ul>
  <li>
    <p>java.nio.file.Path æ¥å£ä»£è¡¨ä¸€ä¸ªå¹³å°æ— å…³çš„å¹³å°è·¯å¾„ï¼Œæè¿°äº†ç›®å½•ç»“æ„ä¸­æ–‡ä»¶çš„ä½ç½®ã€‚</p>
  </li>
  <li>
    <p>Paths æä¾›çš„get() æ–¹æ³•ç”¨æ¥è·å–Path å¯¹è±¡ï¼š</p>

    <p>Path get(String first, String â€¦ more) : ç”¨äºå°†å¤šä¸ªå­—ç¬¦ä¸²ä¸²è¿æˆè·¯å¾„ã€‚</p>
  </li>
  <li>
    <p>Path å¸¸ç”¨æ–¹æ³•ï¼š</p>

    <ul>
      <li>boolean endsWith(String path) : åˆ¤æ–­æ˜¯å¦ä»¥path è·¯å¾„ç»“æŸ</li>
      <li>boolean startsWith(String path) : åˆ¤æ–­æ˜¯å¦ä»¥path è·¯å¾„å¼€å§‹</li>
      <li>boolean isAbsolute() : åˆ¤æ–­æ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„</li>
      <li>Path getFileName() : è¿”å›ä¸è°ƒç”¨Path å¯¹è±¡å…³è”çš„æ–‡ä»¶å</li>
      <li>Path getName(int idx) : è¿”å›çš„æŒ‡å®šç´¢å¼•ä½ç½®idx çš„è·¯å¾„åç§°</li>
      <li>int getNameCount() : è¿”å›Path æ ¹ç›®å½•åé¢å…ƒç´ çš„æ•°é‡</li>
      <li>Path getParent() ï¼šè¿”å›Pathå¯¹è±¡åŒ…å«æ•´ä¸ªè·¯å¾„ï¼Œä¸åŒ…å«Path å¯¹è±¡æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„</li>
      <li>Path getRoot() ï¼šè¿”å›è°ƒç”¨Path å¯¹è±¡çš„æ ¹è·¯å¾„</li>
      <li>Path resolve(Path p) :å°†ç›¸å¯¹è·¯å¾„è§£æä¸ºç»å¯¹è·¯å¾„</li>
      <li>Path toAbsolutePath() : ä½œä¸ºç»å¯¹è·¯å¾„è¿”å›è°ƒç”¨Path å¯¹è±¡</li>
      <li>String toString() ï¼šè¿”å›è°ƒç”¨Path å¯¹è±¡çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼</li>
    </ul>
  </li>
</ul>

<h3 id="files">Files</h3>

<ul>
  <li>java.nio.file.Files ç”¨äºæ“ä½œæ–‡ä»¶æˆ–ç›®å½•çš„å·¥å…·ç±»ã€‚</li>
  <li>Fileså¸¸ç”¨æ–¹æ³•ï¼š
    <ul>
      <li>Path copy(Path src, Path dest, CopyOption â€¦ how) : æ–‡ä»¶çš„å¤åˆ¶</li>
      <li>Path createDirectory(Path path, FileAttribute&lt;?&gt; â€¦ attr) : åˆ›å»ºä¸€ä¸ªç›®å½•</li>
      <li>Path createFile(Path path, FileAttribute&lt;?&gt; â€¦ arr) : åˆ›å»ºä¸€ä¸ªæ–‡ä»¶</li>
      <li>void delete(Path path) : åˆ é™¤ä¸€ä¸ªæ–‡ä»¶</li>
      <li>Path move(Path src, Path dest, CopyOptionâ€¦how) : å°†src ç§»åŠ¨åˆ°dest ä½ç½®</li>
      <li>long size(Path path) : è¿”å›path æŒ‡å®šæ–‡ä»¶çš„å¤§å°</li>
      <li>boolean exists(Path path, LinkOption â€¦ opts) : åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨</li>
      <li>boolean isDirectory(Path path, LinkOption â€¦ opts) : åˆ¤æ–­æ˜¯å¦æ˜¯ç›®å½•</li>
      <li>boolean isExecutable(Path path) : åˆ¤æ–­æ˜¯å¦æ˜¯å¯æ‰§è¡Œæ–‡ä»¶</li>
      <li>boolean isHidden(Path path) : åˆ¤æ–­æ˜¯å¦æ˜¯éšè—æ–‡ä»¶</li>
      <li>boolean isReadable(Path path) : åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯è¯»</li>
      <li>boolean isWritable(Path path) : åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å¯å†™</li>
      <li>boolean notExists(Path path, LinkOption â€¦ opts) : åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸å­˜åœ¨</li>
      <li><code class="language-plaintext highlighter-rouge">public static &lt;A extends BasicFileAttributes&gt; A readAttributes(Path path,Class&lt;A&gt; type,LinkOption... options) </code>: è·å–ä¸path æŒ‡å®šçš„æ–‡ä»¶ç›¸å…³è”çš„å±æ€§ã€‚</li>
      <li>SeekableByteChannel newByteChannel(Path path, OpenOptionâ€¦how) : è·å–ä¸æŒ‡å®šæ–‡ä»¶çš„è¿æ¥ï¼Œ how æŒ‡å®šæ‰“å¼€æ–¹å¼ã€‚</li>
      <li>DirectoryStream newDirectoryStream(Path path) : æ‰“å¼€path æŒ‡å®šçš„ç›®å½•</li>
      <li>InputStream newInputStream(Path path, OpenOptionâ€¦how):è·å–InputStream å¯¹è±¡</li>
      <li>OutputStream newOutputStream(Path path, OpenOptionâ€¦how) : è·å–OutputStream å¯¹è±¡</li>
    </ul>
  </li>
</ul>
:ET