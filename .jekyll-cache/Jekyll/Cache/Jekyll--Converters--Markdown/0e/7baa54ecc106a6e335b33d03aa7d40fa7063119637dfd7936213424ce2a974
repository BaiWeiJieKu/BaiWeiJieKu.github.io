I"r—<ul id="markdown-toc">
  <li><a href="#æ¦‚è¿°" id="markdown-toc-æ¦‚è¿°">æ¦‚è¿°</a>    <ul>
      <li><a href="#mqæ¯”è¾ƒ" id="markdown-toc-mqæ¯”è¾ƒ">MQæ¯”è¾ƒ</a></li>
      <li><a href="#éœ€æ±‚èƒŒæ™¯" id="markdown-toc-éœ€æ±‚èƒŒæ™¯">éœ€æ±‚èƒŒæ™¯</a></li>
      <li><a href="#ä»€ä¹ˆæ˜¯mq" id="markdown-toc-ä»€ä¹ˆæ˜¯mq">ä»€ä¹ˆæ˜¯MQ</a></li>
      <li><a href="#å®‰è£…" id="markdown-toc-å®‰è£…">å®‰è£…</a></li>
    </ul>
  </li>
  <li><a href="#apiç¼–ç å®ç°" id="markdown-toc-apiç¼–ç å®ç°">APIç¼–ç å®ç°</a>    <ul>
      <li><a href="#é˜Ÿåˆ—-ç”Ÿäº§è€…" id="markdown-toc-é˜Ÿåˆ—-ç”Ÿäº§è€…">é˜Ÿåˆ—-ç”Ÿäº§è€…</a></li>
      <li><a href="#é˜Ÿåˆ—-åŒæ­¥é˜»å¡æ¶ˆè´¹è€…" id="markdown-toc-é˜Ÿåˆ—-åŒæ­¥é˜»å¡æ¶ˆè´¹è€…">é˜Ÿåˆ—-åŒæ­¥é˜»å¡æ¶ˆè´¹è€…</a></li>
      <li><a href="#é˜Ÿåˆ—-å¼‚æ­¥ç›‘å¬æ¶ˆè´¹è€…" id="markdown-toc-é˜Ÿåˆ—-å¼‚æ­¥ç›‘å¬æ¶ˆè´¹è€…">é˜Ÿåˆ—-å¼‚æ­¥ç›‘å¬æ¶ˆè´¹è€…</a></li>
      <li><a href="#ä¸»é¢˜-ç”Ÿäº§è€…" id="markdown-toc-ä¸»é¢˜-ç”Ÿäº§è€…">ä¸»é¢˜-ç”Ÿäº§è€…</a></li>
      <li><a href="#ä¸»é¢˜-æ¶ˆè´¹è€…" id="markdown-toc-ä¸»é¢˜-æ¶ˆè´¹è€…">ä¸»é¢˜-æ¶ˆè´¹è€…</a></li>
      <li><a href="#activemqæ§åˆ¶å°" id="markdown-toc-activemqæ§åˆ¶å°">activeMQæ§åˆ¶å°</a></li>
    </ul>
  </li>
  <li><a href="#jmsè§„èŒƒ" id="markdown-toc-jmsè§„èŒƒ">JMSè§„èŒƒ</a>    <ul>
      <li><a href="#æ¶ˆæ¯å¤´" id="markdown-toc-æ¶ˆæ¯å¤´">æ¶ˆæ¯å¤´</a></li>
      <li><a href="#æ¶ˆæ¯ä½“" id="markdown-toc-æ¶ˆæ¯ä½“">æ¶ˆæ¯ä½“</a></li>
      <li><a href="#æ¶ˆæ¯å±æ€§" id="markdown-toc-æ¶ˆæ¯å±æ€§">æ¶ˆæ¯å±æ€§</a></li>
      <li><a href="#æ¶ˆæ¯æŒä¹…åŒ–" id="markdown-toc-æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</a></li>
      <li><a href="#æ¶ˆæ¯äº‹åŠ¡æ€§" id="markdown-toc-æ¶ˆæ¯äº‹åŠ¡æ€§">æ¶ˆæ¯äº‹åŠ¡æ€§</a></li>
      <li><a href="#æ¶ˆæ¯ç­¾æ”¶æœºåˆ¶" id="markdown-toc-æ¶ˆæ¯ç­¾æ”¶æœºåˆ¶">æ¶ˆæ¯ç­¾æ”¶æœºåˆ¶</a></li>
      <li><a href="#ç‚¹å¯¹ç‚¹æ€»ç»“" id="markdown-toc-ç‚¹å¯¹ç‚¹æ€»ç»“">ç‚¹å¯¹ç‚¹æ€»ç»“</a></li>
      <li><a href="#å‘å¸ƒè®¢é˜…æ€»ç»“" id="markdown-toc-å‘å¸ƒè®¢é˜…æ€»ç»“">å‘å¸ƒè®¢é˜…æ€»ç»“</a></li>
    </ul>
  </li>
  <li><a href="#activemqçš„broker" id="markdown-toc-activemqçš„broker">ActiveMQçš„broker</a></li>
  <li><a href="#springæ•´åˆactivemq" id="markdown-toc-springæ•´åˆactivemq">springæ•´åˆactiveMQ</a></li>
  <li><a href="#springbootæ•´åˆactivemq" id="markdown-toc-springbootæ•´åˆactivemq">springBootæ•´åˆactiveMQ</a></li>
  <li><a href="#activemqçš„ä¼ è¾“åè®®" id="markdown-toc-activemqçš„ä¼ è¾“åè®®">activeMQçš„ä¼ è¾“åè®®</a>    <ul>
      <li><a href="#tcpåè®®" id="markdown-toc-tcpåè®®">TCPåè®®</a></li>
      <li><a href="#amqpåè®®" id="markdown-toc-amqpåè®®">AMQPåè®®</a></li>
      <li><a href="#stompåè®®" id="markdown-toc-stompåè®®">STOMPåè®®</a></li>
      <li><a href="#mqttåè®®" id="markdown-toc-mqttåè®®">MQTTåè®®</a></li>
      <li><a href="#nioåè®®" id="markdown-toc-nioåè®®">NIOåè®®</a></li>
    </ul>
  </li>
  <li><a href="#æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–" id="markdown-toc-æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–">æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–</a>    <ul>
      <li><a href="#kahadbæ¶ˆæ¯å­˜å‚¨" id="markdown-toc-kahadbæ¶ˆæ¯å­˜å‚¨">kahaDBæ¶ˆæ¯å­˜å‚¨</a></li>
      <li><a href="#jdbcæ¶ˆæ¯å­˜å‚¨" id="markdown-toc-jdbcæ¶ˆæ¯å­˜å‚¨">JDBCæ¶ˆæ¯å­˜å‚¨</a></li>
      <li><a href="#jdbc-message-store-with-activemq-journal" id="markdown-toc-jdbc-message-store-with-activemq-journal">JDBC Message store with ActiveMQ Journal</a></li>
      <li><a href="#æ€»ç»“" id="markdown-toc-æ€»ç»“">æ€»ç»“</a></li>
    </ul>
  </li>
  <li><a href="#å¤šèŠ‚ç‚¹é›†ç¾¤" id="markdown-toc-å¤šèŠ‚ç‚¹é›†ç¾¤">å¤šèŠ‚ç‚¹é›†ç¾¤</a></li>
  <li><a href="#å¼‚æ­¥æŠ•é€’" id="markdown-toc-å¼‚æ­¥æŠ•é€’">å¼‚æ­¥æŠ•é€’</a></li>
  <li><a href="#å»¶è¿ŸæŠ•é€’å’Œå®šæ—¶æŠ•é€’" id="markdown-toc-å»¶è¿ŸæŠ•é€’å’Œå®šæ—¶æŠ•é€’">å»¶è¿ŸæŠ•é€’å’Œå®šæ—¶æŠ•é€’</a></li>
  <li><a href="#æ¶ˆæ¯æ¶ˆè´¹çš„é‡è¯•æœºåˆ¶" id="markdown-toc-æ¶ˆæ¯æ¶ˆè´¹çš„é‡è¯•æœºåˆ¶">æ¶ˆæ¯æ¶ˆè´¹çš„é‡è¯•æœºåˆ¶</a></li>
  <li><a href="#æ­»ä¿¡é˜Ÿåˆ—" id="markdown-toc-æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</a></li>
  <li><a href="#æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹å¹‚ç­‰æ€§" id="markdown-toc-æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹å¹‚ç­‰æ€§">æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Œå¹‚ç­‰æ€§</a></li>
</ul>
<h3 id="æ¦‚è¿°">æ¦‚è¿°</h3>

<p><a href="https://github.com/BaiWeiJieKu/MK-rabbitmq">github</a></p>

<h4 id="mqæ¯”è¾ƒ">MQæ¯”è¾ƒ</h4>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç‰¹æ€§</th>
      <th style="text-align: center">activeMQ</th>
      <th style="text-align: center">RabbitMQ</th>
      <th style="text-align: center">Kafka</th>
      <th style="text-align: center">RocketMQ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">PRODUCER-CUMSUMER</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
    </tr>
    <tr>
      <td style="text-align: center">PUBLISH-SUBSCRIBE</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
    </tr>
    <tr>
      <td style="text-align: center">REQUEST-REPLY</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒ</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">æ”¯æŒ</td>
    </tr>
    <tr>
      <td style="text-align: center">APIå®Œå¤‡æ€§</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">ä½ï¼ˆé™æ€é…ç½®ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">å¤šè¯­è¨€æ”¯æŒ</td>
      <td style="text-align: center">æ”¯æŒjavaä¼˜å…ˆ</td>
      <td style="text-align: center">è¯­è¨€æ— å…³</td>
      <td style="text-align: center">æ”¯æŒjavaä¼˜å…ˆ</td>
      <td style="text-align: center">æ”¯æŒ</td>
    </tr>
    <tr>
      <td style="text-align: center">å•æœºååé‡</td>
      <td style="text-align: center">ä¸‡çº§</td>
      <td style="text-align: center">ä¸‡çº§</td>
      <td style="text-align: center">åä¸‡çº§</td>
      <td style="text-align: center">å•æœºä¸‡çº§</td>
    </tr>
    <tr>
      <td style="text-align: center">æ¶ˆæ¯å»¶è¿Ÿ</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">å¾®ç§’çº§</td>
      <td style="text-align: center">æ¯«ç§’çº§</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">å¯ç”¨æ€§</td>
      <td style="text-align: center">é«˜ï¼ˆä¸»ä»ï¼‰</td>
      <td style="text-align: center">é«˜ï¼ˆä¸»ä»ï¼‰</td>
      <td style="text-align: center">éå¸¸é«˜ï¼ˆåˆ†å¸ƒå¼ï¼‰</td>
      <td style="text-align: center">é«˜</td>
    </tr>
    <tr>
      <td style="text-align: center">æ¶ˆæ¯ä¸¢å¤±</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">ä½</td>
      <td style="text-align: center">ç†è®ºä¸Šä¸ä¼šä¸¢å¤±</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">æ¶ˆæ¯é‡å¤</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">å¯æ§æ€§</td>
      <td style="text-align: center">ç†è®ºä¸Šä¼šæœ‰é‡å¤</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">æ–‡æ¡£å®Œå¤‡æ€§</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">é«˜</td>
      <td style="text-align: center">ä¸­</td>
    </tr>
    <tr>
      <td style="text-align: center">å¿«é€Ÿå…¥é—¨</td>
      <td style="text-align: center">æœ‰</td>
      <td style="text-align: center">æœ‰</td>
      <td style="text-align: center">æœ‰</td>
      <td style="text-align: center">æ— </td>
    </tr>
    <tr>
      <td style="text-align: center">éƒ¨ç½²éš¾åº¦</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">ä½</td>
      <td style="text-align: center">ä¸­</td>
      <td style="text-align: center">é«˜</td>
    </tr>
    <tr>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">javaï¼Œä¸­å°å‹é¡¹ç›®</td>
      <td style="text-align: center">erlangè¯­è¨€ï¼Œä¸å¥½ä¿®æ”¹åº•å±‚ï¼Œä¸å»ºè®®é€‰ç”¨</td>
      <td style="text-align: center">ç¼–ç¨‹è¯­è¨€Scalaï¼Œå¤§æ•°æ®é¢†åŸŸä¸»æµMQ</td>
      <td style="text-align: center">javaï¼Œé€‚ç”¨äºå¤§å‹é›†ç¾¤é¡¹ç›®</td>
    </tr>
  </tbody>
</table>

<h4 id="éœ€æ±‚èƒŒæ™¯">éœ€æ±‚èƒŒæ™¯</h4>

<ul>
  <li>å¾®æœåŠ¡æ¶æ„åé“¾å¼è°ƒç”¨æ˜¯æˆ‘ä»¬åœ¨å†™ç¨‹åºæ—¶å€™çš„ä¸€èˆ¬æµç¨‹,ä¸ºäº†å®Œæˆä¸€ä¸ªæ•´ä½“åŠŸèƒ½ä¼šå°†å…¶æ‹†åˆ†æˆå¤šä¸ªå‡½æ•°(æˆ–å­æ¨¡å—)ï¼Œæ¯”å¦‚æ¨¡å—Aè°ƒç”¨æ¨¡å—B,æ¨¡å—Bè°ƒç”¨æ¨¡å—C,æ¨¡å—Cè°ƒç”¨æ¨¡å—Dã€‚ä½†åœ¨å¤§å‹åˆ†å¸ƒå¼åº”ç”¨ä¸­ï¼Œç³»ç»Ÿé—´çš„RPCäº¤äº’ç¹æ‚</li>
  <li>æ¯æ–°å¢ä¸€ä¸ªä¸‹æ¸¸åŠŸèƒ½ï¼Œéƒ½è¦å¯¹ä¸Šæ¸¸çš„ç›¸å…³æ¥å£è¿›è¡Œæ”¹é€ ï¼›æ¯ä¸ªæ¥å£æ¨¡å—çš„ååèƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œè¿™ä¸ªä¸Šé™èƒ½åŠ›å¦‚æœæ˜¯å ¤åï¼Œå½“å¤§æµé‡ï¼ˆæ´ªæ°´ï¼‰æ¥ä¸´æ—¶ï¼Œå®¹æ˜“è¢«å†²å®ã€‚RPCæ¥å£ä¸ŠåŸºæœ¬éƒ½æ˜¯åŒæ­¥è°ƒç”¨ï¼Œæ•´ä½“çš„æœåŠ¡æ€§èƒ½éµå¾ªâ€œæœ¨æ¡¶ç†è®ºâ€ï¼Œå³æ•´ä½“ç³»ç»Ÿçš„è€—æ—¶å–å†³äºé“¾è·¯ä¸­æœ€æ…¢çš„é‚£ä¸ªæ¥å£ã€‚</li>
  <li>æ ¹æ®ä¸Šè¿°çš„å‡ ä¸ªé—®é¢˜ï¼Œåœ¨è®¾è®¡ç³»ç»Ÿæ—¶å¯ä»¥æ˜ç¡®è¦è¾¾åˆ°çš„ç›®æ ‡ï¼š
    <ul>
      <li>1ï¼Œè¦åšåˆ°ç³»ç»Ÿè§£è€¦ï¼Œå½“æ–°çš„æ¨¡å—æ¥è¿›æ¥æ—¶ï¼Œå¯ä»¥åšåˆ°ä»£ç æ”¹åŠ¨æœ€å°ï¼›èƒ½å¤Ÿè§£è€¦</li>
      <li>2ï¼Œè®¾ç½®æµé‡ç¼“å†²æ± ï¼Œå¯ä»¥è®©åç«¯ç³»ç»ŸæŒ‰ç…§è‡ªèº«ååèƒ½åŠ›è¿›è¡Œæ¶ˆè´¹ï¼Œä¸è¢«å†²å®ï¼›èƒ½å‰Šå³°</li>
      <li>3ï¼Œå¼ºå¼±ä¾èµ–æ¢³ç†èƒ½å°†éå…³é”®è°ƒç”¨é“¾è·¯çš„æ“ä½œå¼‚æ­¥åŒ–å¹¶æå‡æ•´ä½“ç³»ç»Ÿçš„ååèƒ½åŠ›ï¼›èƒ½å¤Ÿå¼‚æ­¥</li>
    </ul>
  </li>
</ul>

<h4 id="ä»€ä¹ˆæ˜¯mq">ä»€ä¹ˆæ˜¯MQ</h4>

<ul>
  <li>é¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶ï¼ˆmessage-oriented middlewareï¼‰MOMèƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³ä»¥ä¸Šé—®é¢˜ï¼Œæ˜¯æŒ‡åˆ©ç”¨é«˜æ•ˆå¯é çš„æ¶ˆæ¯ä¼ é€’æœºåˆ¶ä¸å¹³å°æ— å…³çš„æ•°æ®äº¤æµï¼Œå¹¶åŸºäºæ•°æ®é€šä¿¡æ¥è¿›è¡Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„é›†æˆã€‚</li>
  <li>é€šè¿‡æä¾›æ¶ˆæ¯ä¼ é€’å’Œæ¶ˆæ¯æ’é˜Ÿæ¨¡å‹åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æä¾›åº”ç”¨è§£è€¦ï¼Œå¼¹æ€§ä¼¸ç¼©ï¼Œå†—ä½™å­˜å‚¨ã€æµé‡å‰Šå³°ï¼Œå¼‚æ­¥é€šä¿¡ï¼Œæ•°æ®åŒæ­¥ç­‰åŠŸèƒ½ã€‚</li>
  <li>å‘é€è€…æŠŠæ¶ˆæ¯å‘é€ç»™æ¶ˆæ¯æœåŠ¡å™¨ï¼Œæ¶ˆæ¯æœåŠ¡å™¨å°†æ¶ˆæ¯å­˜æ”¾åœ¨è‹¥å¹²é˜Ÿåˆ—/ä¸»é¢˜topicä¸­ï¼Œåœ¨åˆé€‚çš„æ—¶å€™ï¼Œæ¶ˆæ¯æœåŠ¡å™¨å›å°†æ¶ˆæ¯è½¬å‘ç»™æ¥å—è€…ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‘é€å’Œæ¥æ”¶æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯å‘é€æ— éœ€ç­‰å¾…ï¼Œè€Œä¸”å‘é€è€…å’Œæ¥å—è€…çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿæ²¡æœ‰å¿…ç„¶çš„å…³ç³»ï¼›å°¤å…¶åœ¨å‘å¸ƒpub/è®¢é˜…subæ¨¡å¼ä¸‹ï¼Œä¹Ÿå¯ä»¥å®Œæˆä¸€å¯¹å¤šçš„é€šä¿¡ï¼Œå³è®©ä¸€ä¸ªæ¶ˆæ¯æœ‰å¤šä¸ªæ¥å—è€…ã€‚</li>
  <li><strong>ç‰¹ç‚¹ï¼šè§£è€¦ï¼Œå‰Šé”‹ï¼Œå¼‚æ­¥</strong></li>
</ul>

<h4 id="å®‰è£…">å®‰è£…</h4>

<ul>
  <li>ActiveMQå®˜ç½‘ï¼š<code class="language-plaintext highlighter-rouge">http://activemq.apache.org/</code></li>
  <li>è§£å‹</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@i activemq]# tar -xzvf apache-activemq-5.14.3-bin.tar.gz
</code></pre></div></div>

<ul>
  <li>åœ¨/etc/init.d/ç›®å½•å¢åŠ å¢åŠ activemqæ–‡ä»¶</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /etc/init.d/
vi activemq

#!/bin/sh
#
# /etc/init.d/activemq
# chkconfig: 345 63 37
# description: activemq servlet container.
# processname: activemq 5.14.3

# Source function library.
#. /etc/init.d/functions
# source networking configuration.
#. /etc/sysconfig/network

export JAVA_HOME=/usr/local/jdk1.8.0_131
export CATALINA_HOME=/usr/local/activemq/apache-activemq-5.14.3

case $1 in
    start)
        sh $CATALINA_HOME/bin/activemq start
    ;;
    stop)
        sh $CATALINA_HOME/bin/activemq stop
    ;;
    restart)
        sh $CATALINA_HOME/bin/activemq stop
        sleep 1
        sh $CATALINA_HOME/bin/activemq start
    ;;

esac
exit 0

</code></pre></div></div>

<ul>
  <li>è®¾ç½®æƒé™</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ init.d]# chmod 777 activemq

è®¾ç½®å¼€æœºå¯åŠ¨
[root@ init.d]# chkconfig activemq on

å¯åŠ¨ActiveMQ
[root@ init.d]# service activemq start

ä»¥è®°å½•æ—¥å¿—æ–¹å¼å¯åŠ¨
service activemq start  &gt;  /usr/local/raohao/activemq.log

è®¿é—®activemqç®¡ç†é¡µé¢åœ°å€ï¼šhttp://IPåœ°å€:8161/
è´¦æˆ·admin  å¯†ç admin

æŸ¥çœ‹activemqçŠ¶æ€
service activemq status

å…³é—­activemqæœåŠ¡
service activemq stop
</code></pre></div></div>

<h3 id="apiç¼–ç å®ç°">APIç¼–ç å®ç°</h3>

<ul>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.activemq/activemq-all --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>activemq-all<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>5.15.11<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/org.apache.xbean/xbean-spring --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.xbean<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>xbean-spring<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>4.15<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<ul>
  <li>JMSå¼€å‘æ­¥éª¤ï¼š
    <ul>
      <li>åˆ›å»ºä¸€ä¸ªconnection factory</li>
      <li>é€šè¿‡connection factoryæ¥åˆ›å»ºJMS connection</li>
      <li>å¯åŠ¨JMS connection</li>
      <li>é€šè¿‡connectionåˆ›å»ºJMS session</li>
      <li>åˆ›å»ºJMS destination</li>
      <li>åˆ›å»ºJMS produceræˆ–è€…åˆ›å»ºJMS messageå¹¶è®¾ç½®destination</li>
      <li>åˆ›å»ºJMS consumeræˆ–è€…æ³¨å†Œä¸€ä¸ªJMS message listener</li>
      <li>å‘é€æˆ–è€…æ¥æ”¶JMS messageï¼ˆsï¼‰</li>
      <li>å…³é—­æ‰€æœ‰çš„JMSèµ„æºï¼ˆconnectionï¼Œsessionï¼Œproducerï¼Œconsumerç­‰ï¼‰</li>
    </ul>
  </li>
  <li>destinationç®€ä»‹ï¼šDestinationæ˜¯ç›®çš„åœ°ã€‚ç›®çš„åœ°ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºæ˜¯æ•°æ®å­˜å‚¨çš„åœ°æ–¹ã€‚</li>
  <li>Destinationåˆ†ä¸ºä¸¤ç§ï¼šé˜Ÿåˆ—å’Œä¸»é¢˜ã€‚</li>
  <li>åœ¨ç‚¹å¯¹ç‚¹çš„æ¶ˆæ¯ä¼ é€’åŸŸä¸­,ç›®çš„åœ°è¢«ç§°ä¸ºé˜Ÿåˆ—(queue)
    <ul>
      <li>æ¯ä¸ªæ¶ˆæ¯åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç±»ä¼¼äº1å¯¹1çš„å…³ç³»ã€‚å¥½æ¯”ä¸ªäººå¿«é€’è‡ªå·±é¢†è‡ªå·±çš„ã€‚</li>
      <li>æ¶ˆæ¯çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´æ²¡æœ‰æ—¶é—´ä¸Šçš„ç›¸å…³æ€§ã€‚æ— è®ºæ¶ˆè´¹è€…åœ¨ç”Ÿäº§è€…å‘é€æ¶ˆæ¯çš„æ—¶å€™æ˜¯å¦å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ¶ˆè´¹è€…éƒ½å¯ä»¥æå–æ¶ˆæ¯ã€‚å¥½æ¯”æˆ‘ä»¬çš„å‘é€çŸ­ä¿¡ï¼Œå‘é€è€…å‘é€åä¸è§å¾—æ¥æ”¶è€…ä¼šå³æ”¶å³çœ‹ã€‚</li>
      <li>æ¶ˆæ¯è¢«æ¶ˆè´¹åé˜Ÿåˆ—ä¸­ä¸ä¼šå†å­˜å‚¨ï¼Œæ‰€ä»¥æ¶ˆè´¹è€…ä¸ä¼šæ¶ˆè´¹åˆ°å·²ç»è¢«æ¶ˆè´¹æ‰çš„æ¶ˆæ¯ã€‚</li>
    </ul>
  </li>
  <li>åœ¨å‘å¸ƒè®¢é˜…æ¶ˆæ¯ä¼ é€’åŸŸä¸­,ç›®çš„åœ°è¢«ç§°ä¸ºä¸»é¢˜(topic)
    <ul>
      <li>ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°topicä¸­ï¼Œæ¯ä¸ªæ¶ˆæ¯å¯ä»¥æœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œå±äº1ï¼šNçš„å…³ç³»ï¼›</li>
      <li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¹‹é—´æœ‰æ—¶é—´ä¸Šçš„ç›¸å…³æ€§ã€‚è®¢é˜…æŸä¸€ä¸ªä¸»é¢˜çš„æ¶ˆè´¹è€…åªèƒ½æ¶ˆè´¹è‡ªå®ƒè®¢é˜…ä¹‹åå‘å¸ƒçš„æ¶ˆæ¯ã€‚</li>
      <li>ç”Ÿäº§è€…ç”Ÿäº§æ—¶ï¼Œtopicä¸ä¿å­˜æ¶ˆæ¯å®ƒæ˜¯æ— çŠ¶æ€çš„ä¸è½åœ°ï¼Œå‡å¦‚æ— äººè®¢é˜…å°±å»ç”Ÿäº§ï¼Œé‚£å°±æ˜¯ä¸€æ¡åºŸæ¶ˆæ¯ï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬å…ˆå¯åŠ¨æ¶ˆè´¹è€…å†å¯åŠ¨ç”Ÿäº§è€…ã€‚</li>
    </ul>
  </li>
  <li>JMSè§„èŒƒå…è®¸å®¢æˆ·åˆ›å»ºæŒä¹…è®¢é˜…ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ”¾æ¾äº†æ—¶é—´ä¸Šçš„ç›¸å…³æ€§è¦æ±‚ã€‚æŒä¹…è®¢é˜…å…è®¸æ¶ˆè´¹è€…æ¶ˆè´¹å®ƒåœ¨æœªå¤„äºæ¿€æ´»çŠ¶æ€æ—¶å‘é€çš„æ¶ˆæ¯ã€‚ä¸€å¥è¯ï¼Œå¥½æ¯”æˆ‘ä»¬çš„å¾®ä¿¡å…¬ä¼—å·è®¢é˜…</li>
  <li>å¯¹æ¯”é˜Ÿåˆ—å’Œä¸»é¢˜</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Â </th>
      <th>topicæ¨¡å¼é˜Ÿåˆ—</th>
      <th>queueæ¨¡å¼é˜Ÿåˆ—</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>å·¥ä½œæ¨¡å¼</td>
      <td>è®¢é˜…-å‘å¸ƒæ¨¡å¼ï¼Œå¦‚æœå½“å‰æ²¡æœ‰è®¢é˜…è€…ï¼Œæ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒã€‚å¦‚æœæœ‰å¤šä¸ªè®¢é˜…è€…ï¼Œé‚£ä¹ˆè¿™äº›è®¢é˜…è€…éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯</td>
      <td>è´Ÿè½½å‡è¡¡æ¨¡å¼ï¼Œå¦‚æœå½“å‰æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šè¢«ä¸¢å¼ƒï¼Œå¦‚æœæœ‰å¤šä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆä¸€æ¡æ¶ˆæ¯ä¹Ÿåªèƒ½å‘é€ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¹¶ä¸”è¦æ±‚æ¶ˆè´¹è€…ackä¿¡æ¯</td>
    </tr>
    <tr>
      <td>æœ‰æ— çŠ¶æ€</td>
      <td>æ— çŠ¶æ€</td>
      <td>queueæ•°æ®é»˜è®¤ä¼šåœ¨mqæœåŠ¡å™¨ä¸Šä»¥æ–‡ä»¶å½¢å¼ä¿å­˜ï¼Œæ¯”å¦‚ActiveMQä¸€èˆ¬ä¿å­˜åœ¨$AMQ_HOME\data\kr-store\dataä¸‹é¢ã€‚ä¹Ÿå¯ä»¥é…ç½®æˆDBå­˜å‚¨ã€‚</td>
    </tr>
    <tr>
      <td>ä¼ é€’å®Œæ•´æ€§</td>
      <td>å¦‚æœæ²¡æœ‰è®¢é˜…è€…ï¼Œæ¶ˆæ¯å°†ä¼šè¢«ä¸¢å¼ƒ</td>
      <td>æ¶ˆæ¯ä¸ä¼šä¸¢å¼ƒ</td>
    </tr>
    <tr>
      <td>å¤„ç†æ•ˆç‡</td>
      <td>ç”±äºæ¶ˆæ¯è¦æŒ‰ç…§è®¢é˜…è€…çš„æ•°é‡è¿›è¡Œå¤åˆ¶ï¼Œæ‰€ä»¥å¤„ç†æ€§èƒ½ä¼šéšç€è®¢é˜…è€…çš„å¢åŠ è€Œæ˜æ˜¾é™ä½ï¼Œè€Œä¸”è¿˜è¦ç»“åˆä¸åŒæ¶ˆæ¯åè®®è‡ªèº«çš„æ€§èƒ½å·®å¼‚</td>
      <td>ç”±äºä¸€æ¡æ¶ˆæ¯åªå‘é€ç»™ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå°±ç®—æ¶ˆè´¹è€…å†å¤šï¼Œæ€§èƒ½ä¹Ÿä¸ä¼šæœ‰æ˜æ˜¾ä¸‹é™ã€‚ä¸åŒæ¶ˆæ¯åè®®çš„å…·ä½“æ€§èƒ½ä¹Ÿæ˜¯æœ‰å·®å¼‚çš„ã€‚</td>
    </tr>
  </tbody>
</table>

<h4 id="é˜Ÿåˆ—-ç”Ÿäº§è€…">é˜Ÿåˆ—-ç”Ÿäº§è€…</h4>

<ul>
  <li>é˜Ÿåˆ—æ¶ˆæ¯ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce</span> <span class="o">{</span>
    <span class="c1">//  linux ä¸Šéƒ¨ç½²çš„activemq çš„ IP åœ°å€ + activemq çš„ç«¯å£å·</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="c1">// ç›®çš„åœ°çš„åç§°</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUEUE_NAME</span> <span class="o">=</span> <span class="s">"jdbc01"</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="c1">// 1 æŒ‰ç…§ç»™å®šçš„urlåˆ›å»ºè¿æ¥å·¥å‚ï¼Œè¿™ä¸ªæ„é€ å™¨é‡‡ç”¨é»˜è®¤çš„ç”¨æˆ·åå¯†ç ã€‚è¯¥ç±»çš„å…¶ä»–æ„é€ æ–¹æ³•å¯ä»¥æŒ‡å®šç”¨æˆ·åå’Œå¯†ç ã€‚</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="c1">// 2 é€šè¿‡è¿æ¥å·¥å‚ï¼Œè·å¾—è¿æ¥ connection å¹¶å¯åŠ¨è®¿é—®ã€‚</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// 3 åˆ›å»ºä¼šè¯session ã€‚ç¬¬ä¸€å‚æ•°æ˜¯æ˜¯å¦å¼€å¯äº‹åŠ¡ï¼Œ ç¬¬äºŒå‚æ•°æ˜¯æ¶ˆæ¯ç­¾æ”¶çš„æ–¹å¼</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="c1">// 4 åˆ›å»ºç›®çš„åœ°ï¼ˆä¸¤ç§ ï¼šé˜Ÿåˆ—/ä¸»é¢˜ï¼‰ã€‚Destinationæ˜¯Queueå’ŒTopicçš„çˆ¶ç±»</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">QUEUE_NAME</span><span class="o">);</span>
        <span class="c1">// 5 åˆ›å»ºæ¶ˆæ¯çš„ç”Ÿäº§è€…</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="c1">// 6 é€šè¿‡messageProducer ç”Ÿäº§ 3 æ¡ æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="c1">// 7  åˆ›å»ºæ¶ˆæ¯</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="c1">// 8  é€šè¿‡messageProducerå‘é€ç»™mq</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 9 å…³é—­èµ„æº</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** æ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ§åˆ¶å°æ¶ˆæ¯
    <ul>
      <li>Number Of Pending Messagesï¼šç­‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯ï¼Œè¿™ä¸ªæ˜¯æœªå‡ºé˜Ÿåˆ—çš„æ•°é‡ï¼Œå…¬å¼=æ€»æ¥æ”¶æ•°-æ€»å‡ºé˜Ÿåˆ—æ•°</li>
      <li>Number Of Consumersï¼šæ¶ˆè´¹è€…æ•°é‡ï¼Œæ¶ˆè´¹è€…ç«¯çš„æ¶ˆè´¹è€…æ•°é‡</li>
      <li>Messages Enqueuedï¼šè¿›é˜Ÿæ¶ˆæ¯æ•°ï¼Œè¿›é˜Ÿåˆ—çš„æ€»æ¶ˆæ¯é‡ï¼ŒåŒ…æ‹¬å‡ºé˜Ÿåˆ—çš„ã€‚è¿™ä¸ªæ•°åªå¢ä¸å‡ã€‚</li>
      <li>Messages Dequeuedï¼šå‡ºé˜Ÿæ¶ˆæ¯æ•°ï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯æ¶ˆè´¹è€…æ¶ˆè´¹æ‰çš„æ•°é‡ã€‚</li>
      <li>å½“æœ‰ä¸€ä¸ªæ¶ˆæ¯è¿›å…¥è¿™ä¸ªé˜Ÿåˆ—æ—¶ï¼Œç­‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯æ˜¯1ï¼Œè¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯1ã€‚</li>
      <li>å½“æ¶ˆæ¯æ¶ˆè´¹åï¼Œç­‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯æ˜¯0ï¼Œè¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯1ï¼Œå‡ºé˜Ÿåˆ—çš„æ¶ˆæ¯æ˜¯1ã€‚</li>
      <li>å½“å†æ¥ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œç­‰å¾…æ¶ˆè´¹çš„æ¶ˆæ¯æ˜¯1ï¼Œè¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å°±æ˜¯2ã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="é˜Ÿåˆ—-åŒæ­¥é˜»å¡æ¶ˆè´¹è€…">é˜Ÿåˆ—-åŒæ­¥é˜»å¡æ¶ˆè´¹è€…</h4>

<ul>
  <li>é˜Ÿåˆ—æ¶ˆæ¯æ¶ˆè´¹è€…</li>
  <li>è®¢é˜…è€…æˆ–æ¥æ”¶è€…æŠµç”¨MessageConsumerçš„receive()æ–¹æ³•æ¥æ¥æ”¶æ¶ˆæ¯ï¼Œreceiveæ–¹æ³•åœ¨èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰ï¼ˆæˆ–è¶…æ—¶ä¹‹å‰ï¼‰å°†ä¸€ç›´é˜»å¡ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="c1">// æ¶ˆæ¯çš„æ¶ˆè´¹è€…</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsumer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUEUE_NAME</span> <span class="o">=</span> <span class="s">"jdbc01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
      	<span class="c1">//1.åˆ›å»ºè¿æ¥å·¥å‚ï¼ŒæŒ‰ç…§ç»™å®šçš„URLï¼Œé‡‡ç”¨é»˜è®¤çš„ç”¨æˆ·åå¯†ç </span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
      	<span class="c1">//2.é€šè¿‡è¿æ¥å·¥å‚,è·å¾—connectionå¹¶å¯åŠ¨è®¿é—®</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      	 <span class="c1">//3.åˆ›å»ºä¼šè¯sessionã€‚ä¸¤ä¸ªå‚æ•°transacted=äº‹åŠ¡,acknowledgeMode=ç¡®è®¤æ¨¡å¼(ç­¾æ”¶)</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
      	 <span class="c1">//4.åˆ›å»ºç›®çš„åœ°(å…·ä½“æ˜¯é˜Ÿåˆ—queueè¿˜æ˜¯ä¸»é¢˜topic)</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">QUEUE_NAME</span><span class="o">);</span>
        <span class="c1">//5.åˆ›å»ºæ¶ˆæ¯çš„æ¶ˆè´¹è€…,æŒ‡å®šæ¶ˆè´¹å“ªä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
      	 <span class="c1">//å¾ªç¯è·å–</span>
        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="c1">// reveive() ä¸€ç›´ç­‰å¾…æ¥æ”¶æ¶ˆæ¯ï¼Œåœ¨èƒ½å¤Ÿæ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹å‰å°†ä¸€ç›´é˜»å¡ã€‚ æ˜¯åŒæ­¥é˜»å¡æ–¹å¼ ã€‚å’Œsocketçš„acceptæ–¹æ³•ç±»ä¼¼çš„ã€‚</span>
<span class="c1">// reveive(Long time) : ç­‰å¾…næ¯«ç§’ä¹‹åè¿˜æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±æ˜¯ç»“æŸé˜»å¡ã€‚</span>
            <span class="c1">// å› ä¸ºæ¶ˆæ¯å‘é€è€…æ˜¯ TextMessageï¼Œæ‰€ä»¥æ¶ˆæ¯æ¥å—è€…ä¹Ÿè¦æ˜¯TextMessage</span>
          	<span class="c1">//6.é€šè¿‡æ¶ˆè´¹è€…è°ƒç”¨æ–¹æ³•è·å–é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯(å‘é€çš„æ¶ˆæ¯æ˜¯ä»€ä¹ˆç±»å‹,æ¥æ”¶çš„æ—¶å€™å°±å¼ºè½¬æˆä»€ä¹ˆç±»å‹)</span>
            <span class="nc">TextMessage</span> <span class="n">message</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">messageConsumer</span><span class="o">.</span><span class="na">receive</span><span class="o">();</span> 
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span><span class="o">){</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">message</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
            <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
      	 <span class="c1">//7.å…³é—­èµ„æº</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="é˜Ÿåˆ—-å¼‚æ­¥ç›‘å¬æ¶ˆè´¹è€…">é˜Ÿåˆ—-å¼‚æ­¥ç›‘å¬æ¶ˆè´¹è€…</h4>

<ul>
  <li>å¼‚æ­¥</li>
  <li>è®¢é˜…è€…æˆ–æ¥æ”¶è€…é€šè¿‡MessageConsumerçš„setMessageListener(MessageListener listener)æ³¨å†Œä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ï¼Œå½“æ¶ˆæ¯åˆ°è¾¾ä¹‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨ç›‘å¬å™¨MessageListenerçš„onMessage(Message message)æ–¹æ³•ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="c1">// æ¶ˆæ¯çš„æ¶ˆè´¹è€…  ä¹Ÿå°±æ˜¯å›ç­”æ¶ˆæ¯çš„ç³»ç»Ÿ</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsumer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUEUE_NAME</span> <span class="o">=</span> <span class="s">"jdbc01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
      	 <span class="c1">//1.åˆ›å»ºè¿æ¥å·¥å‚ï¼ŒæŒ‰ç…§ç»™å®šçš„URLï¼Œé‡‡ç”¨é»˜è®¤çš„ç”¨æˆ·åå¯†ç </span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
      	<span class="c1">//2.é€šè¿‡è¿æ¥å·¥å‚,è·å¾—connectionå¹¶å¯åŠ¨è®¿é—®</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
      	<span class="c1">//3.åˆ›å»ºä¼šè¯session</span>
        <span class="c1">//ä¸¤ä¸ªå‚æ•°transacted=äº‹åŠ¡,acknowledgeMode=ç¡®è®¤æ¨¡å¼(ç­¾æ”¶)</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
      	<span class="c1">//4.åˆ›å»ºç›®çš„åœ°(å…·ä½“æ˜¯é˜Ÿåˆ—queueè¿˜æ˜¯ä¸»é¢˜topic)</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">QUEUE_NAME</span><span class="o">);</span>
      	<span class="c1">//5.åˆ›å»ºæ¶ˆæ¯çš„æ¶ˆè´¹è€…,æŒ‡å®šæ¶ˆè´¹å“ªä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
		<span class="c1">//6.é€šè¿‡ç›‘å¬çš„æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="cm">/* é€šè¿‡ç›‘å¬çš„æ–¹å¼æ¥æ¶ˆè´¹æ¶ˆæ¯ï¼Œæ˜¯å¼‚æ­¥éé˜»å¡çš„æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ã€‚
           é€šè¿‡messageConsumer çš„setMessageListener æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ï¼Œå½“æœ‰æ¶ˆæ¯å‘é€æ¥æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨MessageListener çš„ onMessage æ–¹æ³•å¤„ç†æ¶ˆæ¯
         */</span>
      	<span class="cm">/*
        å¼‚æ­¥éé˜»å¡å¼æ–¹å¼ç›‘å¬å™¨(onMessage)
        è®¢é˜…è€…æˆ–æ¶ˆè´¹è€…é€šè¿‡åˆ›å»ºçš„æ¶ˆè´¹è€…å¯¹è±¡,ç»™æ¶ˆè´¹è€…æ³¨å†Œæ¶ˆæ¯ç›‘å¬å™¨setMessageListener,
        å½“æ¶ˆæ¯æœ‰æ¶ˆæ¯çš„æ—¶å€™,ç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨MessageListenerç±»çš„onMessageæ–¹æ³•
        æˆ‘ä»¬åªéœ€è¦åœ¨onMessageæ–¹æ³•å†…åˆ¤æ–­æ¶ˆæ¯ç±»å‹å³å¯è·å–æ¶ˆæ¯
         */</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span>  <span class="o">{</span>
<span class="c1">//  instanceof åˆ¤æ–­æ˜¯å¦Aå¯¹è±¡æ˜¯å¦æ˜¯Bç±»çš„å­ç±»</span>
                    <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span>  <span class="o">&amp;&amp;</span> <span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">){</span>
                      	 <span class="c1">//7.æŠŠmessageè½¬æ¢æˆæ¶ˆæ¯å‘é€å‰çš„ç±»å‹å¹¶è·å–æ¶ˆæ¯å†…å®¹</span>
                        <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…çš„æ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">// è®©ä¸»çº¿ç¨‹ä¸è¦ç»“æŸã€‚å› ä¸ºä¸€æ—¦ä¸»çº¿ç¨‹ç»“æŸäº†ï¼Œå…¶ä»–çš„çº¿ç¨‹ï¼ˆå¦‚æ­¤å¤„çš„ç›‘å¬æ¶ˆæ¯çš„çº¿ç¨‹ï¼‰ä¹Ÿéƒ½ä¼šè¢«è¿«ç»“æŸã€‚</span>
        <span class="c1">// å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¼šä¸€ç›´è¿è¡Œï¼Œè¿™å¥ä»£ç éƒ½ä¼šçœç•¥ã€‚</span>
      	 <span class="c1">//ä¿è¯æ§åˆ¶å°ä¸å…³é—­,é˜»æ­¢ç¨‹åºå…³é—­</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
      	 <span class="c1">//8.å…³é—­èµ„æº</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ä¸»é¢˜-ç”Ÿäº§è€…">ä¸»é¢˜-ç”Ÿäº§è€…</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce_topic</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://192.168.17.3:61616"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
             <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
		
      	<span class="c1">//åˆ›å»ºç›®çš„åœ°(å…·ä½“æ˜¯é˜Ÿåˆ—queueè¿˜æ˜¯ä¸»é¢˜topic)</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"topic_name--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="nc">MapMessage</span> <span class="n">mapMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createMapMessage</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** TOPIC_NAMEæ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="ä¸»é¢˜-æ¶ˆè´¹è€…">ä¸»é¢˜-æ¶ˆè´¹è€…</h4>

<ul>
  <li><strong>å…ˆå¯åŠ¨è®¢é˜…è€…å†å¯åŠ¨ç”Ÿäº§è€…,ä¸ç„¶å‘é€çš„æ¶ˆæ¯æ˜¯åºŸæ¶ˆæ¯</strong></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsummer_topic</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://192.168.17.3:61616"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>

        <span class="c1">// 4 åˆ›å»ºç›®çš„åœ° ï¼ˆä¸¤ç§ ï¼š é˜Ÿåˆ—/ä¸»é¢˜   è¿™é‡Œç”¨ä¸»é¢˜ï¼‰</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>

        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>
<span class="c1">// MessageListeneræ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨lambdaè¡¨è¾¾å¼</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span>  <span class="o">&amp;&amp;</span> <span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">){</span>
                     <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…textçš„æ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">});</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="activemqæ§åˆ¶å°">activeMQæ§åˆ¶å°</h4>

<ul>
  <li>topicæœ‰å¤šä¸ªæ¶ˆè´¹è€…æ—¶ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„æ•°é‡â‰ˆ åœ¨çº¿æ¶ˆè´¹è€…æ•°é‡*ç”Ÿäº§æ¶ˆæ¯çš„æ•°é‡ã€‚</li>
</ul>

<h3 id="jmsè§„èŒƒ">JMSè§„èŒƒ</h3>

<ul>
  <li>ä»€ä¹ˆæ˜¯javaæ¶ˆæ¯æœåŠ¡ï¼šJavaæ¶ˆæ¯æœåŠ¡æŒ‡çš„æ˜¯ä¸¤ä¸ªåº”ç”¨ç¨‹åºä¹‹é—´è¿›è¡Œå¼‚æ­¥é€šä¿¡çš„APIï¼Œå®ƒä¸ºæ ‡å‡†åè®®å’Œæ¶ˆæ¯æœåŠ¡æä¾›äº†ä¸€ç»„é€šç”¨æ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºã€å‘é€ã€è¯»å–æ¶ˆæ¯ç­‰ï¼Œç”¨äºæ”¯æŒJavaåº”ç”¨ç¨‹åºå¼€å‘ã€‚åœ¨JavaEEä¸­ï¼Œå½“ä¸¤ä¸ªåº”ç”¨ç¨‹åºä½¿ç”¨JMSè¿›è¡Œé€šä¿¡æ—¶ï¼Œå®ƒä»¬ä¹‹é—´ä¸æ˜¯ç›´æ¥ç›¸è¿çš„ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå…±åŒçš„æ¶ˆæ¯æ”¶å‘æœåŠ¡ç»„ä»¶å…³è”èµ·æ¥ä»¥è¾¾åˆ°è§£è€¦/å¼‚æ­¥å‰Šå³°çš„æ•ˆæœã€‚</li>
  <li>JMSç»„æˆç»“æ„åŠç‰¹ç‚¹
    <ul>
      <li>JMS Providerï¼šå®ç°JMSæ¥å£å’Œè§„èŒƒçš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„MQæœåŠ¡å™¨</li>
      <li>JMS Producerï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼Œåˆ›å»ºå’Œå‘é€JMSæ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨</li>
      <li>JMS Consumerï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œæ¥æ”¶å’Œå¤„ç†JMSæ¶ˆæ¯çš„å®¢æˆ·ç«¯åº”ç”¨</li>
      <li>JMS Messageï¼šåŒ…æ‹¬æ¶ˆæ¯å¤´ï¼Œæ¶ˆæ¯å±æ€§ï¼Œæ¶ˆæ¯ä½“</li>
    </ul>
  </li>
</ul>

<h4 id="æ¶ˆæ¯å¤´">æ¶ˆæ¯å¤´</h4>

<ul>
  <li>JMSçš„æ¶ˆæ¯å¤´æœ‰å“ªäº›å±æ€§ï¼š
    <ul>
      <li>JMSDestinationï¼šæ¶ˆæ¯ç›®çš„åœ°ï¼Œä¸»è¦æ˜¯æŒ‡Queueå’ŒTopic</li>
      <li>JMSDeliveryModeï¼šæ¶ˆæ¯æŒä¹…åŒ–æ¨¡å¼ï¼›ä¸€æ¡æŒä¹…æ€§çš„æ¶ˆæ¯ï¼šåº”è¯¥è¢«ä¼ é€â€œä¸€æ¬¡ä»…ä»…ä¸€æ¬¡â€ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœJMSæä¾›è€…å‡ºç°æ•…éšœï¼Œè¯¥æ¶ˆæ¯å¹¶ä¸ä¼šä¸¢å¤±ï¼Œå®ƒä¼šåœ¨æœåŠ¡å™¨æ¢å¤ä¹‹åå†æ¬¡ä¼ é€’ï¼›ä¸€æ¡éæŒä¹…çš„æ¶ˆæ¯ï¼šæœ€å¤šä¼šä¼ é€’ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œè¯¥æ¶ˆæ¯å°†ä¼šæ°¸è¿œä¸¢å¤±ã€‚</li>
      <li>JMSExpirationï¼šæ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼›å¯ä»¥è®¾ç½®æ¶ˆæ¯åœ¨ä¸€å®šæ—¶é—´åè¿‡æœŸï¼Œé»˜è®¤æ˜¯æ°¸ä¸è¿‡æœŸï¼›æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œç­‰äºDestinationçš„sendæ–¹æ³•ä¸­çš„timeToLiveå€¼åŠ ä¸Šå‘é€æ—¶åˆ»çš„GMTæ—¶é—´å€¼ï¼›å¦‚æœtimeToLiveå€¼ç­‰äº0ï¼Œåˆ™JMSExpirationè¢«è®¾ä¸º0ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯æ°¸ä¸è¿‡æœŸï¼›å¦‚æœå‘é€åï¼Œåœ¨æ¶ˆæ¯è¿‡æœŸæ—¶é—´ä¹‹åè¿˜æ²¡æœ‰è¢«å‘é€åˆ°ç›®çš„åœ°ï¼Œåˆ™è¯¥æ¶ˆæ¯è¢«æ¸…é™¤ã€‚</li>
      <li>JMSPriorityï¼šæ¶ˆæ¯çš„ä¼˜å…ˆçº§ï¼›æ¶ˆæ¯ä¼˜å…ˆçº§ï¼Œä»0-9åä¸ªçº§åˆ«ï¼Œ0-4æ˜¯æ™®é€šæ¶ˆæ¯5-9æ˜¯åŠ æ€¥æ¶ˆæ¯ï¼›JMSä¸è¦æ±‚MQä¸¥æ ¼æŒ‰ç…§è¿™åä¸ªä¼˜å…ˆçº§å‘é€æ¶ˆæ¯ä½†å¿…é¡»ä¿è¯åŠ æ€¥æ¶ˆæ¯è¦å…ˆäºæ™®é€šæ¶ˆæ¯åˆ°è¾¾ã€‚é»˜è®¤æ˜¯4çº§ã€‚</li>
      <li>JMSMessageIDï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚åé¢æˆ‘ä»¬ä¼šä»‹ç»å¦‚ä½•è§£å†³å¹‚ç­‰æ€§ã€‚</li>
      <li>æ¶ˆæ¯çš„ç”Ÿäº§è€…å¯ä»¥setè¿™äº›å±æ€§ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹è€…å¯ä»¥getè¿™äº›å±æ€§ã€‚è¿™äº›å±æ€§åœ¨sendæ–¹æ³•é‡Œé¢ä¹Ÿå¯ä»¥è®¾ç½®</li>
    </ul>
  </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce_topic</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"topic_name--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="c1">// è¿™é‡Œå¯ä»¥æŒ‡å®šæ¯ä¸ªæ¶ˆæ¯çš„ç›®çš„åœ°</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSDestination</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>
            <span class="cm">/*
            æŒä¹…æ¨¡å¼å’ŒéæŒä¹…æ¨¡å¼ã€‚
            ä¸€æ¡æŒä¹…æ€§çš„æ¶ˆæ¯ï¼šåº”è¯¥è¢«ä¼ é€â€œä¸€æ¬¡ä»…ä»…ä¸€æ¬¡â€ï¼Œè¿™å°±æ„å‘³ç€å¦‚æœJMSæä¾›è€…å‡ºç°æ•…éšœï¼Œè¯¥æ¶ˆæ¯å¹¶ä¸ä¼šä¸¢å¤±ï¼Œå®ƒä¼šåœ¨æœåŠ¡å™¨æ¢å¤ä¹‹åå†æ¬¡ä¼ é€’ã€‚
            ä¸€æ¡éæŒä¹…çš„æ¶ˆæ¯ï¼šæœ€å¤šä¼šä¼ é€’ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€æœåŠ¡å™¨å‡ºç°æ•…éšœï¼Œè¯¥æ¶ˆæ¯å°†ä¼šæ°¸è¿œä¸¢å¤±ã€‚
             */</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSDeliveryMode</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
            <span class="cm">/*
            å¯ä»¥è®¾ç½®æ¶ˆæ¯åœ¨ä¸€å®šæ—¶é—´åè¿‡æœŸï¼Œé»˜è®¤æ˜¯æ°¸ä¸è¿‡æœŸã€‚
            æ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œç­‰äºDestinationçš„sendæ–¹æ³•ä¸­çš„timeToLiveå€¼åŠ ä¸Šå‘é€æ—¶åˆ»çš„GMTæ—¶é—´å€¼ã€‚
            å¦‚æœtimeToLiveå€¼ç­‰äº0ï¼Œåˆ™JMSExpirationè¢«è®¾ä¸º0ï¼Œè¡¨ç¤ºè¯¥æ¶ˆæ¯æ°¸ä¸è¿‡æœŸã€‚
            å¦‚æœå‘é€åï¼Œåœ¨æ¶ˆæ¯è¿‡æœŸæ—¶é—´ä¹‹åè¿˜æ²¡æœ‰è¢«å‘é€åˆ°ç›®çš„åœ°ï¼Œåˆ™è¯¥æ¶ˆæ¯è¢«æ¸…é™¤ã€‚
             */</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSExpiration</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
            <span class="cm">/*  æ¶ˆæ¯ä¼˜å…ˆçº§ï¼Œä»0-9åä¸ªçº§åˆ«ï¼Œ0-4æ˜¯æ™®é€šæ¶ˆæ¯5-9æ˜¯åŠ æ€¥æ¶ˆæ¯ã€‚
            JMSä¸è¦æ±‚MQä¸¥æ ¼æŒ‰ç…§è¿™åä¸ªä¼˜å…ˆçº§å‘é€æ¶ˆæ¯ä½†å¿…é¡»ä¿è¯åŠ æ€¥æ¶ˆæ¯è¦å…ˆäºæ™®é€šæ¶ˆæ¯åˆ°è¾¾ã€‚é»˜è®¤æ˜¯4çº§ã€‚
             */</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSPriority</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
            <span class="c1">// å”¯ä¸€æ ‡è¯†æ¯ä¸ªæ¶ˆæ¯çš„æ ‡è¯†ã€‚MQä¼šç»™æˆ‘ä»¬é»˜è®¤ç”Ÿæˆä¸€ä¸ªï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æŒ‡å®šã€‚</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSMessageID</span><span class="o">(</span><span class="s">"ABCD"</span><span class="o">);</span>
            <span class="c1">// ä¸Šé¢æœ‰äº›å±æ€§åœ¨sendæ–¹æ³•é‡Œä¹Ÿèƒ½è®¾ç½®</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** TOPIC_NAMEæ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯ä½“">æ¶ˆæ¯ä½“</h4>

<ul>
  <li>å°è£…å…·ä½“çš„æ¶ˆæ¯æ•°æ®</li>
  <li>å‘é€å’Œæ¥æ”¶çš„æ¶ˆæ¯ä½“ç±»å‹å¿…é¡»ä¸€è‡´å¯¹åº”</li>
  <li>5ç§æ¶ˆæ¯æ ¼å¼ï¼š
    <ul>
      <li>TxtMessageï¼šæ™®é€šå­—ç¬¦ä¸²æ¶ˆæ¯ï¼ŒåŒ…å«ä¸€ä¸ªString</li>
      <li>MapMessageï¼šä¸€ä¸ªMapç±»å‹çš„æ¶ˆæ¯ï¼Œkeyä¸ºStrngç±»å‹ï¼Œè€Œå€¼ä¸ºJavaåŸºæœ¬ç±»å‹</li>
      <li>BytesMessageï¼šäºŒè¿›åˆ¶æ•°ç»„æ¶ˆæ¯ï¼ŒåŒ…å«ä¸€ä¸ªbyte[]</li>
      <li>StreamMessageï¼šJavaæ•°æ®æµæ¶ˆæ¯ï¼Œç”¨æ ‡å‡†æµæ“ä½œæ¥é¡ºåºå¡«å……å’Œè¯»å–</li>
      <li>ObjectMessageï¼šå¯¹è±¡æ¶ˆæ¯ï¼ŒåŒ…å«ä¸€ä¸ªå¯åºåˆ—åŒ–çš„Javaå¯¹è±¡</li>
    </ul>
  </li>
  <li>æ¼”ç¤ºTextMessageå’ŒMapMessageçš„ç”¨æ³•</li>
  <li>æ¶ˆæ¯ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce_topic</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
         <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
         <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="c1">// å‘é€TextMessageæ¶ˆæ¯ä½“</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"topic_name--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="c1">// å‘é€MapMessage  æ¶ˆæ¯ä½“ã€‚setæ–¹æ³•: æ·»åŠ ï¼Œgetæ–¹å¼ï¼šè·å–</span>
            <span class="nc">MapMessage</span>  <span class="n">mapMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createMapMessage</span><span class="o">();</span>
            <span class="n">mapMessage</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="s">"name"</span><span class="o">,</span> <span class="s">"å¼ ä¸‰"</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
            <span class="n">mapMessage</span><span class="o">.</span><span class="na">setInt</span><span class="o">(</span><span class="s">"age"</span><span class="o">,</span> <span class="mi">18</span><span class="o">+</span><span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">mapMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** TOPIC_NAMEæ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆæ¯æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsummer_topic</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
 <span class="c1">// åˆ¤æ–­æ¶ˆæ¯æ˜¯å“ªç§ç±»å‹ä¹‹åï¼Œå†å¼ºè½¬ã€‚</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span>  <span class="o">&amp;&amp;</span> <span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">){</span>
                   <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…textçš„æ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span>  <span class="o">&amp;&amp;</span> <span class="n">message</span> <span class="k">instanceof</span> <span class="nc">MapMessage</span><span class="o">){</span>
                <span class="nc">MapMessage</span> <span class="n">mapMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">MapMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…çš„mapæ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">mapMessage</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">"name"</span><span class="o">));</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…çš„mapæ¶ˆæ¯ï¼š"</span><span class="o">+</span><span class="n">mapMessage</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">"age"</span><span class="o">));</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯å±æ€§">æ¶ˆæ¯å±æ€§</h4>

<ul>
  <li>å¦‚æœéœ€è¦é™¤æ¶ˆæ¯å¤´å­—æ®µä¹‹å¤–çš„å€¼ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯å±æ€§ã€‚ä»–æ˜¯è¯†åˆ«/å»é‡/é‡ç‚¹æ ‡æ³¨ç­‰æ“ä½œï¼Œéå¸¸æœ‰ç”¨çš„æ–¹æ³•ã€‚</li>
  <li>ä»–ä»¬æ˜¯ä»¥å±æ€§åå’Œå±æ€§å€¼å¯¹çš„å½¢å¼åˆ¶å®šçš„ã€‚å¯ä»¥å°†å±æ€§è§†ä¸ºæ¶ˆæ¯å¤´çš„æ‰©å±•ï¼Œå±æ€§æŒ‡å®šä¸€äº›æ¶ˆæ¯å¤´æ²¡æœ‰åŒ…æ‹¬çš„é™„åŠ ä¿¡æ¯ï¼Œæ¯”å¦‚å¯ä»¥åœ¨å±æ€§é‡ŒæŒ‡å®šæ¶ˆæ¯é€‰æ‹©å™¨ã€‚æ¶ˆæ¯çš„å±æ€§å°±åƒå¯ä»¥åˆ†é…ç»™ä¸€æ¡æ¶ˆæ¯çš„é™„åŠ æ¶ˆæ¯å¤´ä¸€æ ·ã€‚å®ƒä»¬å…è®¸å¼€å‘è€…æ·»åŠ æœ‰å…³æ¶ˆæ¯çš„ä¸é€æ˜é™„åŠ ä¿¡æ¯ã€‚å®ƒä»¬è¿˜ç”¨äºæš´éœ²æ¶ˆæ¯é€‰æ‹©å™¨åœ¨æ¶ˆæ¯è¿‡æ»¤æ—¶ä½¿ç”¨çš„æ•°æ®ã€‚</li>
  <li>æ¶ˆæ¯ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce_topic</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"topic_name--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="c1">// è°ƒç”¨Messageçš„set*Property()æ–¹æ³•ï¼Œå°±èƒ½è®¾ç½®æ¶ˆæ¯å±æ€§ã€‚æ ¹æ®valueçš„æ•°æ®ç±»å‹çš„ä¸åŒï¼Œæœ‰ç›¸åº”çš„APIã€‚</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setStringProperty</span><span class="o">(</span><span class="s">"From"</span><span class="o">,</span><span class="s">"ZhangSan@qq.com"</span><span class="o">);</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setByteProperty</span><span class="o">(</span><span class="s">"Spec"</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">1</span><span class="o">);</span>
            <span class="n">textMessage</span><span class="o">.</span><span class="na">setBooleanProperty</span><span class="o">(</span><span class="s">"Invalide"</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** TOPIC_NAMEæ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆæ¯æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsummer_topic</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span> <span class="o">(</span><span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span>  <span class="o">&amp;&amp;</span> <span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">){</span>
                    <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯ä½“ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å±æ€§ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getStringProperty</span><span class="o">(</span><span class="s">"From"</span><span class="o">));</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å±æ€§ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getByteProperty</span><span class="o">(</span><span class="s">"Spec"</span><span class="o">));</span>
                      <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å±æ€§ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getBooleanProperty</span><span class="o">(</span><span class="s">"Invalide"</span><span class="o">));</span>
                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</h4>

<ul>
  <li>ä»€ä¹ˆæ˜¯æŒä¹…åŒ–æ¶ˆæ¯ï¼šåœ¨æ¶ˆæ¯ç”Ÿäº§è€…å°†æ¶ˆæ¯æˆåŠŸå‘é€ç»™MQæ¶ˆæ¯ä¸­é—´ä»¶ä¹‹åã€‚æ— è®ºæ˜¯å‡ºç°ä»»ä½•é—®é¢˜ï¼Œå¦‚ï¼šMQæœåŠ¡å™¨å®•æœºã€æ¶ˆè´¹è€…æ‰çº¿ç­‰ã€‚éƒ½ä¿è¯ï¼ˆtopicè¦ä¹‹å‰æ³¨å†Œè¿‡ï¼Œqueueä¸ç”¨ï¼‰æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œèƒ½å¤ŸæˆåŠŸæ¶ˆè´¹æ¶ˆæ¯ã€‚å¦‚æœæ¶ˆæ¯ç”Ÿäº§è€…å‘é€æ¶ˆæ¯å°±å¤±è´¥äº†ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…ä¹Ÿä¸ä¼šæ¶ˆè´¹åˆ°è¯¥æ¶ˆæ¯ã€‚</li>
  <li>queueéæŒä¹…ï¼šå½“æœåŠ¡å™¨å®•æœºï¼Œæ¶ˆæ¯ä¸å­˜åœ¨ï¼ˆæ¶ˆæ¯ä¸¢å¤±äº†ï¼‰ã€‚å³ä¾¿æ˜¯éæŒä¹…ï¼Œæ¶ˆè´¹è€…åœ¨ä¸åœ¨çº¿çš„è¯ï¼Œæ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œç­‰å¾…æ¶ˆè´¹è€…åœ¨çº¿ï¼Œè¿˜æ˜¯èƒ½å¤Ÿæ”¶åˆ°æ¶ˆæ¯çš„ã€‚</li>
  <li>queueæŒä¹…ï¼šqueueæŒä¹…åŒ–ï¼Œå½“æœåŠ¡å™¨å®•æœºï¼Œæ¶ˆæ¯ä¾ç„¶å­˜åœ¨ã€‚queueæ¶ˆæ¯é»˜è®¤æ˜¯æŒä¹…åŒ–çš„ã€‚</li>
  <li>å¯é æ€§çš„å¦ä¸€ä¸ªé‡è¦æ–¹é¢æ˜¯ç¡®ä¿æŒä¹…æ€§æ¶ˆæ¯ä¼ é€è‡³ç›®æ ‡åï¼Œæ¶ˆæ¯æœåŠ¡åœ¨å‘æ¶ˆè´¹è€…ä¼ é€å®ƒä»¬ä¹‹å‰ä¸ä¼šä¸¢å¤±è¿™äº›æ¶ˆæ¯ã€‚</li>
  <li>éæŒä¹…åŒ–çš„ç”Ÿäº§è€…ï¼šå½“ç”Ÿäº§è€…æˆåŠŸå‘å¸ƒæ¶ˆæ¯ä¹‹åï¼ŒMQæœåŠ¡ç«¯å®•æœºé‡å¯ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…å°±æ”¶ä¸åˆ°è¯¥æ¶ˆæ¯äº†</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUEUE_NAME</span> <span class="o">=</span> <span class="s">"jdbc01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="c1">// éæŒä¹…åŒ–</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">NON_PERSISTENT</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"---MessageListener---"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** æ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æŒä¹…åŒ–ç”Ÿäº§è€…ï¼šå½“ç”Ÿäº§è€…æˆåŠŸå‘å¸ƒæ¶ˆæ¯ä¹‹åï¼ŒMQæœåŠ¡ç«¯å®•æœºé‡å¯ï¼Œæ¶ˆæ¯ç”Ÿäº§è€…ä»ç„¶èƒ½å¤Ÿæ”¶åˆ°è¯¥æ¶ˆæ¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">QUEUE_NAME</span> <span class="o">=</span> <span class="s">"jdbc01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span><span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
      	<span class="c1">//æŒä¹…åŒ–è®¾ç½®</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"---MessageListener---"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** æ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>topicæŒä¹…åŒ–ï¼štopicé»˜è®¤å°±æ˜¯éæŒä¹…åŒ–çš„ï¼Œå› ä¸ºç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯æ—¶ï¼Œæ¶ˆè´¹è€…ä¹Ÿè¦åœ¨çº¿ï¼Œè¿™æ ·æ¶ˆè´¹è€…æ‰èƒ½æ¶ˆè´¹åˆ°æ¶ˆæ¯ã€‚topicæ¶ˆæ¯æŒä¹…åŒ–ï¼Œåªè¦æ¶ˆè´¹è€…å‘MQæœåŠ¡å™¨æ³¨å†Œè¿‡ï¼Œæ‰€æœ‰ç”Ÿäº§è€…å‘å¸ƒæˆåŠŸçš„æ¶ˆæ¯ï¼Œè¯¥æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°ï¼Œä¸ç®¡æ˜¯MQæœåŠ¡å™¨å®•æœºè¿˜æ˜¯æ¶ˆè´¹è€…ä¸åœ¨çº¿ã€‚</li>
  <li>æ³¨æ„ï¼š
    <ul>
      <li>ä¸€å®šè¦å…ˆè¿è¡Œä¸€æ¬¡æ¶ˆè´¹è€…ï¼Œç­‰äºå‘MQæ³¨å†Œï¼Œç±»ä¼¼æˆ‘è®¢é˜…äº†è¿™ä¸ªä¸»é¢˜</li>
      <li>ç„¶åå†è¿è¡Œç”Ÿäº§è€…å‘é€æ¶ˆæ¯</li>
      <li>ä¹‹åæ— è®ºæ¶ˆè´¹è€…æ˜¯å¦åœ¨çº¿ï¼Œéƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚å¦‚æœä¸åœ¨çº¿çš„è¯ï¼Œä¸‹æ¬¡è¿æ¥çš„æ—¶å€™ï¼Œä¼šæŠŠæ²¡æœ‰æ”¶è¿‡çš„æ¶ˆæ¯éƒ½æ¥æ”¶è¿‡æ¥</li>
    </ul>
  </li>
  <li>æŒä¹…åŒ–topicç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="c1">// æŒä¹…åŒ–topic çš„æ¶ˆæ¯ç”Ÿäº§è€…</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsProduce_persistence</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://192.168.17.3:61616"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="n">javax</span><span class="o">.</span><span class="na">jms</span><span class="o">.</span><span class="na">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">topic</span><span class="o">);</span>

        <span class="c1">// è®¾ç½®æŒä¹…åŒ–topic </span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">setDeliveryMode</span><span class="o">(</span><span class="nc">DeliveryMode</span><span class="o">.</span><span class="na">PERSISTENT</span><span class="o">);</span>
        <span class="c1">// è®¾ç½®æŒä¹…åŒ–topicä¹‹åå†ï¼Œå¯åŠ¨è¿æ¥</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"topic_name--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="nc">MapMessage</span> <span class="n">mapMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createMapMessage</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"  **** TOPIC_NAMEæ¶ˆæ¯å‘é€åˆ°MQå®Œæˆ ****"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æŒä¹…åŒ–topicæ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="c1">// æŒä¹…åŒ–topic çš„æ¶ˆæ¯æ¶ˆè´¹è€…</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JmsConsummer_persistence</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://192.168.17.3:61616"</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOPIC_NAME</span> <span class="o">=</span> <span class="s">"topic01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
<span class="c1">// è®¾ç½®å®¢æˆ·ç«¯IDã€‚å‘MQæœåŠ¡å™¨æ³¨å†Œè‡ªå·±çš„åç§°</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">setClientID</span><span class="o">(</span><span class="s">"marrry"</span><span class="o">);</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Topic</span> <span class="n">topic</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTopic</span><span class="o">(</span><span class="no">TOPIC_NAME</span><span class="o">);</span>
<span class="c1">// åˆ›å»ºä¸€ä¸ªtopicè®¢é˜…è€…å¯¹è±¡ã€‚ä¸€å‚æ˜¯topicï¼ŒäºŒå‚æ˜¯è®¢é˜…è€…åç§°</span>
        <span class="nc">TopicSubscriber</span> <span class="n">topicSubscriber</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createDurableSubscriber</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span><span class="s">"remark..."</span><span class="o">);</span>
         <span class="c1">// ä¹‹åå†å¼€å¯è¿æ¥</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Message</span> <span class="n">message</span> <span class="o">=</span> <span class="n">topicSubscriber</span><span class="o">.</span><span class="na">receive</span><span class="o">();</span>
         <span class="k">while</span> <span class="o">(</span><span class="kc">null</span> <span class="o">!=</span> <span class="n">message</span><span class="o">){</span>
             <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span><span class="n">message</span><span class="o">;</span>
             <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" æ”¶åˆ°çš„æŒä¹…åŒ– topic ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
             <span class="n">message</span> <span class="o">=</span> <span class="n">topicSubscriber</span><span class="o">.</span><span class="na">receive</span><span class="o">();</span>
         <span class="o">}</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h4 id="æ¶ˆæ¯äº‹åŠ¡æ€§">æ¶ˆæ¯äº‹åŠ¡æ€§</h4>

<ul>
  <li>ç”Ÿäº§è€…å¼€å¯äº‹åŠ¡åï¼Œæ‰§è¡Œcommitæ–¹æ³•ï¼Œè¿™æ‰¹æ¶ˆæ¯æ‰çœŸæ­£çš„è¢«æäº¤ã€‚ä¸æ‰§è¡Œcommitæ–¹æ³•ï¼Œè¿™æ‰¹æ¶ˆæ¯ä¸ä¼šæäº¤ã€‚æ‰§è¡Œrollbackæ–¹æ³•ï¼Œä¹‹å‰çš„æ¶ˆæ¯ä¼šå›æ»šæ‰ã€‚ç”Ÿäº§è€…çš„äº‹åŠ¡æœºåˆ¶ï¼Œè¦é«˜äºç­¾æ”¶æœºåˆ¶ï¼Œå½“ç”Ÿäº§è€…å¼€å¯äº‹åŠ¡ï¼Œç­¾æ”¶æœºåˆ¶ä¸å†é‡è¦ã€‚</li>
  <li>æ¶ˆè´¹è€…å¼€å¯äº‹åŠ¡åï¼Œæ‰§è¡Œcommitæ–¹æ³•ï¼Œè¿™æ‰¹æ¶ˆæ¯æ‰ç®—çœŸæ­£çš„è¢«æ¶ˆè´¹ã€‚ä¸æ‰§è¡Œcommitæ–¹æ³•ï¼Œè¿™äº›æ¶ˆæ¯ä¸ä¼šæ ‡è®°å·²æ¶ˆè´¹ï¼Œä¸‹æ¬¡è¿˜ä¼šè¢«æ¶ˆè´¹ã€‚æ‰§è¡Œrollbackæ–¹æ³•ï¼Œæ˜¯ä¸èƒ½å›æ»šä¹‹å‰æ‰§è¡Œè¿‡çš„ä¸šåŠ¡é€»è¾‘ï¼Œä½†æ˜¯èƒ½å¤Ÿå›æ»šä¹‹å‰çš„æ¶ˆæ¯ï¼Œå›æ»šåçš„æ¶ˆæ¯ï¼Œä¸‹æ¬¡è¿˜ä¼šè¢«æ¶ˆè´¹ã€‚æ¶ˆè´¹è€…åˆ©ç”¨commitå’Œrollbackæ–¹æ³•ï¼Œç”šè‡³èƒ½å¤Ÿè¿åä¸€ä¸ªæ¶ˆè´¹è€…åªèƒ½æ¶ˆè´¹ä¸€æ¬¡æ¶ˆæ¯çš„åŸç†ã€‚</li>
  <li>æ¶ˆè´¹è€…å’Œç”Ÿäº§è€…çš„äº‹åŠ¡ï¼Œå®Œå…¨æ²¡æœ‰å…³è”ï¼Œå„è‡ªæ˜¯å„è‡ªçš„äº‹åŠ¡ã€‚</li>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Producer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://192.168.10.130:61616"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Queue-TX"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">//1.åˆ›å»ºä¼šè¯sessionï¼Œä¸¤ä¸ªå‚æ•°transacted=äº‹åŠ¡,acknowledgeMode=ç¡®è®¤æ¨¡å¼(ç­¾æ”¶)</span>
        <span class="c1">//è®¾ç½®ä¸ºå¼€å¯äº‹åŠ¡</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"tx msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
              <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
<span class="k">if</span><span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="o">){</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"GG....."</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// 2. å¼€å¯äº‹åŠ¡åï¼Œä½¿ç”¨commitæäº¤äº‹åŠ¡ï¼Œè¿™æ ·è¿™æ‰¹æ¶ˆæ¯æ‰èƒ½çœŸæ­£çš„è¢«æäº¤ã€‚</span>
            <span class="n">session</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å‘é€å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡ºç°å¼‚å¸¸,æ¶ˆæ¯å›æ»š"</span><span class="o">);</span>
            <span class="c1">// 3. å·¥ä½œä¸­ä¸€èˆ¬ï¼Œå½“ä»£ç å‡ºé”™ï¼Œæˆ‘ä»¬åœ¨catchä»£ç å—ä¸­å›æ»šã€‚è¿™æ ·è¿™æ‰¹å‘é€çš„æ¶ˆæ¯å°±èƒ½å›æ»šã€‚</span>
            <span class="n">session</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">//4. å…³é—­èµ„æº</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Consumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Queue-TX"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="c1">// åˆ›å»ºä¼šè¯sessionï¼Œä¸¤ä¸ªå‚æ•°transacted=äº‹åŠ¡,acknowledgeMode=ç¡®è®¤æ¨¡å¼(ç­¾æ”¶)</span>
        <span class="c1">// æ¶ˆè´¹è€…å¼€å¯äº†äº‹åŠ¡å°±å¿…é¡»æ‰‹åŠ¨æäº¤ï¼Œä¸ç„¶ä¼šé‡å¤æ¶ˆè´¹æ¶ˆæ¯</span>
        <span class="kd">final</span> <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">true</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   "</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                        <span class="k">if</span><span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"commit"</span><span class="o">);</span>
                            <span class="n">session</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
                            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"rollback"</span><span class="o">);</span>
                            <span class="n">session</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                        <span class="o">}</span>
                        <span class="n">a</span><span class="o">++;</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡ºç°å¼‚å¸¸ï¼Œæ¶ˆè´¹å¤±è´¥ï¼Œæ”¾å¼ƒæ¶ˆè´¹"</span><span class="o">);</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">session</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="c1">//å…³é—­èµ„æº</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   tx msg--0
commit
***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   tx msg--1
***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   tx msg--2
rollback
***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   tx msg--1
***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   tx msg--2

*/</span>
</code></pre></div></div>

<h4 id="æ¶ˆæ¯ç­¾æ”¶æœºåˆ¶">æ¶ˆæ¯ç­¾æ”¶æœºåˆ¶</h4>

<ul>
  <li>è‡ªåŠ¨ç­¾æ”¶ï¼ˆSession.AUTO_ACKNOWLEDGEï¼‰ï¼šè¯¥æ–¹å¼æ˜¯é»˜è®¤çš„ã€‚è¯¥ç§æ–¹å¼ï¼Œæ— éœ€æˆ‘ä»¬ç¨‹åºåšä»»ä½•æ“ä½œï¼Œæ¡†æ¶ä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨ç­¾æ”¶æ”¶åˆ°çš„æ¶ˆæ¯ã€‚</li>
  <li>æ‰‹åŠ¨ç­¾æ”¶ï¼ˆSession.CLIENT_ACKNOWLEDGEï¼‰ï¼šæ‰‹åŠ¨ç­¾æ”¶ã€‚è¯¥ç§æ–¹å¼ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è°ƒç”¨Message.acknowledge()ï¼Œæ¥ç­¾æ”¶æ¶ˆæ¯ã€‚å¦‚æœä¸ç­¾æ”¶æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ä¼šè¢«æˆ‘ä»¬åå¤æ¶ˆè´¹ï¼Œåªåˆ°è¢«ç­¾æ”¶ã€‚</li>
  <li>å…è®¸é‡å¤æ¶ˆæ¯ï¼ˆSession.DUPS_OK_ACKNOWLEDGEï¼‰ï¼šå¤šçº¿ç¨‹æˆ–å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶æ¶ˆè´¹åˆ°ä¸€ä¸ªæ¶ˆæ¯ï¼Œå› ä¸ºçº¿ç¨‹ä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šé‡å¤æ¶ˆè´¹ã€‚è¯¥ç§æ–¹å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li>
  <li>äº‹åŠ¡ä¸‹çš„ç­¾æ”¶ï¼ˆSession.SESSION_TRANSACTEDï¼‰ï¼šå¼€å§‹äº‹åŠ¡çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è¯¥æ–¹å¼ã€‚è¯¥ç§æ–¹å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li>
  <li>åœ¨äº‹åŠ¡æ€§ä¼šè¯ä¸­ï¼Œå½“ä¸€ä¸ªäº‹åŠ¡è¢«æˆåŠŸæäº¤åˆ™æ¶ˆæ¯è¢«è‡ªåŠ¨ç­¾æ”¶ã€‚å¦‚æœäº‹åŠ¡å›æ»šï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«å†æ¬¡ä¼ é€ã€‚äº‹åŠ¡ä¼˜å…ˆäºç­¾æ”¶ï¼Œå¼€å§‹äº‹åŠ¡åï¼Œç­¾æ”¶æœºåˆ¶ä¸å†èµ·ä»»ä½•ä½œç”¨ã€‚</li>
  <li>éäº‹åŠ¡æ€§ä¼šè¯ä¸­ï¼Œæ¶ˆæ¯ä½•æ—¶è¢«ç¡®è®¤å–å†³äºåˆ›å»ºä¼šè¯æ—¶çš„åº”ç­”æ¨¡å¼ã€‚</li>
  <li>ç”Ÿäº§è€…äº‹åŠ¡å¼€å¯ï¼Œåªæœ‰commitåæ‰èƒ½å°†å…¨éƒ¨æ¶ˆæ¯å˜ä¸ºå·²æ¶ˆè´¹ã€‚</li>
  <li>
    <p>äº‹åŠ¡åå‘ç”Ÿäº§è€…ï¼Œç­¾æ”¶åå‘æ¶ˆè´¹è€…ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”Ÿäº§è€…ä½¿ç”¨äº‹åŠ¡æ›´å¥½ç‚¹ï¼Œæ¶ˆè´¹è€…ä½¿ç”¨ç­¾æ”¶æœºåˆ¶æ›´å¥½ç‚¹ã€‚</p>
  </li>
  <li>éäº‹åŠ¡ä¸‹çš„ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Producer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Queue-ACK"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"tx msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å‘é€å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>éäº‹åŠ¡ä¸‹çš„æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Consumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Queue-ACK"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">CLIENT_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageListener</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   "</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                        <span class="cm">/* è®¾ç½®ä¸ºSession.CLIENT_ACKNOWLEDGEåï¼Œè¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ ‡å¿—ç€è¯¥æ¶ˆæ¯å·²è¢«ç­¾æ”¶ï¼ˆæ¶ˆè´¹ï¼‰ã€‚
                            å¦‚æœä¸è°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¯¥æ¶ˆæ¯çš„æ ‡å¿—è¿˜æ˜¯æœªæ¶ˆè´¹ï¼Œä¸‹æ¬¡å¯åŠ¨æ¶ˆè´¹è€…æˆ–å…¶ä»–æ¶ˆè´¹è€…è¿˜ä¼šæ”¶åˆ°æ”¹æ¶ˆæ¯ã€‚
                         */</span>
                        <span class="n">textMessage</span><span class="o">.</span><span class="na">acknowledge</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡ºç°å¼‚å¸¸ï¼Œæ¶ˆè´¹å¤±è´¥ï¼Œæ”¾å¼ƒæ¶ˆè´¹"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="ç‚¹å¯¹ç‚¹æ€»ç»“">ç‚¹å¯¹ç‚¹æ€»ç»“</h4>

<ul>
  <li>ç‚¹å¯¹ç‚¹æ¨¡å‹æ˜¯åŸºäºé˜Ÿåˆ—çš„ï¼Œç”Ÿäº§è€…å‘æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä»é˜Ÿåˆ—æ¥æ”¶æ¶ˆæ¯ï¼Œé˜Ÿåˆ—çš„å­˜åœ¨ä½¿å¾—æ¶ˆæ¯çš„å¼‚æ­¥ä¼ è¾“æˆä¸ºå¯èƒ½ã€‚å’Œæˆ‘ä»¬å¹³æ—¶ç»™æœ‹å‹å‘é€çŸ­ä¿¡ç±»ä¼¼ã€‚</li>
  <li>å¦‚æœåœ¨Sessionå…³é—­æ—¶æœ‰éƒ¨åˆ†æ¶ˆæ¯å·±è¢«æ”¶åˆ°ä½†è¿˜æ²¡æœ‰è¢«ç­¾æ”¶(acknowledged),é‚£å½“æ¶ˆè´¹è€…ä¸‹æ¬¡è¿æ¥åˆ°ç›¸åŒçš„é˜Ÿåˆ—æ—¶ï¼Œè¿™äº›æ¶ˆæ¯è¿˜ä¼šè¢«å†æ¬¡æ¥æ”¶</li>
  <li>é˜Ÿåˆ—å¯ä»¥é•¿ä¹…åœ°ä¿å­˜æ¶ˆæ¯ç›´åˆ°æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ã€‚æ¶ˆè´¹è€…ä¸éœ€è¦å› ä¸ºæ‹…å¿ƒæ¶ˆæ¯ä¼šä¸¢å¤±è€Œæ—¶åˆ»å’Œé˜Ÿåˆ—ä¿æŒæ¿€æ´»çš„è¿æ¥çŠ¶æ€ï¼Œå……åˆ†ä½“ç°äº†å¼‚æ­¥ä¼ è¾“æ¨¡å¼çš„ä¼˜åŠ¿</li>
</ul>

<h4 id="å‘å¸ƒè®¢é˜…æ€»ç»“">å‘å¸ƒè®¢é˜…æ€»ç»“</h4>

<ul>
  <li>JMS Pub/Sub æ¨¡å‹å®šä¹‰äº†å¦‚ä½•å‘ä¸€ä¸ªå†…å®¹èŠ‚ç‚¹å‘å¸ƒå’Œè®¢é˜…æ¶ˆæ¯ï¼Œè¿™äº›èŠ‚ç‚¹è¢«ç§°ä½œtopicã€‚</li>
  <li>ä¸»é¢˜å¯ä»¥è¢«è®¤ä¸ºæ˜¯æ¶ˆæ¯çš„ä¼ è¾“ä¸­ä»‹ï¼Œå‘å¸ƒè€…ï¼ˆpublisherï¼‰å‘å¸ƒæ¶ˆæ¯åˆ°ä¸»é¢˜ï¼Œè®¢é˜…è€…ï¼ˆsubscribeï¼‰ä»ä¸»é¢˜è®¢é˜…æ¶ˆæ¯ã€‚</li>
  <li>ä¸»é¢˜ä½¿å¾—æ¶ˆæ¯è®¢é˜…è€…å’Œæ¶ˆæ¯å‘å¸ƒè€…ä¿æŒäº’ç›¸ç‹¬ç«‹ä¸éœ€è¦è§£é™¤å³å¯ä¿è¯æ¶ˆæ¯çš„ä¼ é€</li>
  <li>éæŒä¹…è®¢é˜…ï¼š
    <ul>
      <li>éæŒä¹…è®¢é˜…åªæœ‰å½“å®¢æˆ·ç«¯å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å’ŒMQä¿æŒè¿æ¥çŠ¶æ€æ‰èƒ½æ”¶å‘åˆ°æŸä¸ªä¸»é¢˜çš„æ¶ˆæ¯ã€‚</li>
      <li>å¦‚æœæ¶ˆè´¹è€…å¤„äºç¦»çº¿çŠ¶æ€ï¼Œç”Ÿäº§è€…å‘é€çš„ä¸»é¢˜æ¶ˆæ¯å°†ä¼šä¸¢å¤±ä½œåºŸï¼Œæ¶ˆè´¹è€…æ°¸è¿œä¸ä¼šæ”¶åˆ°ã€‚</li>
      <li>ä¸€å¥è¯ï¼šå…ˆè®¢é˜…æ³¨å†Œæ‰èƒ½æ¥å—åˆ°å‘å¸ƒï¼Œåªç»™è®¢é˜…è€…å‘å¸ƒæ¶ˆæ¯ã€‚</li>
    </ul>
  </li>
  <li>æŒä¹…è®¢é˜…ï¼š
    <ul>
      <li>å®¢æˆ·ç«¯é¦–å…ˆå‘MQæ³¨å†Œä¸€ä¸ªè‡ªå·±çš„èº«ä»½IDè¯†åˆ«å·ï¼Œå½“è¿™ä¸ªå®¢æˆ·ç«¯å¤„äºç¦»çº¿æ—¶ï¼Œç”Ÿäº§è€…ä¼šä¸ºè¿™ä¸ªIDä¿å­˜æ‰€æœ‰å‘é€åˆ°ä¸»é¢˜çš„æ¶ˆæ¯ï¼Œå½“å®¢æˆ·å†æ¬¡è¿æ¥åˆ°MQçš„æ—¶å€™ï¼Œä¼šæ ¹æ®æ¶ˆè´¹è€…çš„IDå¾—åˆ°æ‰€æœ‰å½“è‡ªå·±å¤„äºç¦»çº¿æ—¶å‘é€åˆ°ä¸»é¢˜çš„æ¶ˆæ¯</li>
      <li>å½“æŒä¹…è®¢é˜…çŠ¶æ€ä¸‹ï¼Œä¸èƒ½æ¢å¤æˆ–é‡æ–°æ´¾é€ä¸€ä¸ªæœªç­¾æ”¶çš„æ¶ˆæ¯ã€‚</li>
      <li>æŒä¹…è®¢é˜…æ‰èƒ½æ¢å¤æˆ–é‡æ–°æ´¾é€ä¸€ä¸ªæœªç­¾æ”¶çš„æ¶ˆæ¯ã€‚</li>
    </ul>
  </li>
  <li>å½“æ‰€æœ‰çš„æ¶ˆæ¯å¿…é¡»è¢«æ¥æ”¶ï¼Œåˆ™ç”¨æŒä¹…åŒ–è®¢é˜…ã€‚å½“æ¶ˆæ¯ä¸¢å¤±èƒ½å¤Ÿè¢«å®¹å¿ï¼Œåˆ™ç”¨éæŒä¹…è®¢é˜…ã€‚</li>
</ul>

<h3 id="activemqçš„broker">ActiveMQçš„broker</h3>

<ul>
  <li>brokeræ˜¯ä»€ä¹ˆï¼šç›¸å½“äºä¸€ä¸ªActiveMQæœåŠ¡å™¨å®ä¾‹ã€‚è¯´ç™½äº†ï¼ŒBrokerå…¶å®å°±æ˜¯å®ç°äº†ç”¨ä»£ç çš„å½¢å¼å¯åŠ¨ActiveMQå°†MQåµŒå…¥åˆ°Javaä»£ç ä¸­ï¼Œä»¥ä¾¿éšæ—¶ç”¨éšæ—¶å¯åŠ¨ï¼Œåœ¨ç”¨çš„æ—¶å€™å†å»å¯åŠ¨è¿™æ ·èƒ½èŠ‚çœäº†èµ„æºï¼Œä¹Ÿä¿è¯äº†å¯ç”¨æ€§ã€‚è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬<strong>å®é™…å¼€å‘ä¸­å¾ˆå°‘é‡‡ç”¨</strong>ï¼Œå› ä¸ºä»–ç¼ºå°‘å¤ªå¤šäº†ä¸œè¥¿ï¼Œå¦‚ï¼šæ—¥å¿—ï¼Œæ•°æ®å­˜å‚¨ç­‰ç­‰ã€‚</li>
  <li>å¯åŠ¨brokeræ—¶æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šå¯åŠ¨å¤šä¸ªbrokerã€‚å®é™…å·¥ä½œä¸­ä¸€èˆ¬ä¸€å°æœåŠ¡å™¨åªå¯åŠ¨ä¸€ä¸ªbrokerã€‚</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># pwd
/myactivemq/apache-activemq-5.15.9/conf
# cp activemq.xml activemq02.xml

# pwd
/myactivemq/apache-activemq-5.15.9/bin
# ./activemq start xbean:file:/myactivemq/apache-activemq-5.15.9/conf/activemq02.xml
</code></pre></div></div>

<ul>
  <li>ç”¨ActiveMQ Brokerä½œä¸ºç‹¬ç«‹çš„æ¶ˆæ¯æœåŠ¡å™¨æ¥æ„å»ºJavaåº”ç”¨ã€‚ActiveMQä¹Ÿæ”¯æŒåœ¨vmä¸­é€šä¿¡åŸºäºåµŒå…¥çš„brokerï¼Œèƒ½å¤Ÿæ— ç¼çš„é›†æˆå…¶ä»–javaåº”ç”¨ã€‚</li>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.10.1<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>

</code></pre></div></div>

<ul>
  <li>å¯åŠ¨ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.broker.BrokerService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmbedBroker</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
        <span class="c1">//ActiveMQä¹Ÿæ”¯æŒåœ¨vmä¸­é€šä¿¡åŸºäºåµŒå…¥çš„broker</span>
        <span class="nc">BrokerService</span> <span class="n">brokerService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BrokerService</span><span class="o">();</span>
        <span class="n">brokerService</span><span class="o">.</span><span class="na">setPopulateJMSXUserID</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">brokerService</span><span class="o">.</span><span class="na">addConnector</span><span class="o">(</span><span class="s">"tcp://127.0.0.1:61616"</span><span class="o">);</span>
        <span class="n">brokerService</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
   <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="springæ•´åˆactivemq">springæ•´åˆactiveMQ</h3>

<ul>
  <li>å°†ä¸Šé¢çš„ç±»æ³¨å…¥åˆ°Springä¸­ï¼Œå…¶ä»–ä¸å˜ã€‚è¿™æ ·æ—¢èƒ½ä¿æŒåŸç”Ÿçš„ä»£ç ï¼Œåˆèƒ½é›†æˆåˆ°springã€‚</li>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
   <span class="c">&lt;!-- activemqæ ¸å¿ƒä¾èµ–åŒ…  --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>activemq-all<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.10.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!--  åµŒå…¥å¼activemqçš„brokeræ‰€éœ€è¦çš„ä¾èµ–åŒ…   --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.fasterxml.jackson.core<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>jackson-databind<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>2.10.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- activemqè¿æ¥æ±  --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.activemq<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>activemq-pool<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.15.10<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- springæ”¯æŒjmsçš„åŒ… --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-jms<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.1.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!--springç›¸å…³ä¾èµ–åŒ…--&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.xbean<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>xbean-spring<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.15<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>5.2.1.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Springæ ¸å¿ƒä¾èµ– --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.3.23.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-context<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.3.23.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-aop<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.3.23.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.springframework<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>spring-orm<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.3.23.RELEASE<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>

</code></pre></div></div>

<ul>
  <li>é…ç½®æ–‡ä»¶spring-activemq.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--  å¼€å¯åŒ…çš„è‡ªåŠ¨æ‰«æ  --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.activemq.demo"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!--  é…ç½®ç”Ÿäº§è€…  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"connectionFactory"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.pool.PooledConnectionFactory"</span> <span class="na">destroy-method=</span><span class="s">"stop"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--      æ­£çœŸå¯ä»¥ç”Ÿäº§Connectionçš„ConnectionFactory,ç”±å¯¹åº”çš„JMSæœåŠ¡å•†æä¾›      --&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.apache.activemq.spring.ActiveMQConnectionFactory"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"brokerURL"</span> <span class="na">value=</span><span class="s">"tcp://192.168.10.130:61616"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxConnections"</span> <span class="na">value=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  è¿™ä¸ªæ˜¯é˜Ÿåˆ—ç›®çš„åœ°,ç‚¹å¯¹ç‚¹çš„Queue  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"destinationQueue"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.command.ActiveMQQueue"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--    é€šè¿‡æ„é€ æ³¨å…¥Queueå    --&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"spring-active-queue"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  è¿™ä¸ªæ˜¯é˜Ÿåˆ—ç›®çš„åœ°,  å‘å¸ƒè®¢é˜…çš„ä¸»é¢˜Topic--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"destinationTopic"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.command.ActiveMQTopic"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"spring-active-topic"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  Springæä¾›çš„JMSå·¥å…·ç±»,ä»–å¯ä»¥è¿›è¡Œæ¶ˆæ¯å‘é€,æ¥æ”¶ç­‰  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jmsTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jms.core.JmsTemplate"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--    ä¼ å…¥è¿æ¥å·¥å‚    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span> <span class="na">ref=</span><span class="s">"connectionFactory"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--    ä¼ å…¥ç›®çš„åœ°    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"defaultDestination"</span> <span class="na">ref=</span><span class="s">"destinationQueue"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--    æ¶ˆæ¯è‡ªåŠ¨è½¬æ¢å™¨    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"messageConverter"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.jms.support.converter.SimpleMessageConverter"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<ul>
  <li>é˜Ÿåˆ—ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringProduce</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"spring-activemq.xml"</span><span class="o">);</span>
        <span class="nc">SpringProduce</span> <span class="n">springMQ_producer</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="nc">SpringProduce</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">springMQ_producer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">MessageCreator</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="nc">Message</span> <span class="nf">createMessage</span><span class="o">(</span><span class="nc">Session</span> <span class="n">session</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"***Springå’ŒActiveMQçš„æ•´åˆcase111....."</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
        <span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"********send task over"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>é˜Ÿåˆ—æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringMQ_Consumer</span> <span class="o">{</span>
 
 
    <span class="kd">private</span> <span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span>
 
    <span class="nd">@Autowired</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setJmsTemplate</span><span class="o">(</span><span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jmsTemplate</span> <span class="o">=</span> <span class="n">jmsTemplate</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"Application.xml"</span><span class="o">);</span>
        <span class="n">SpringMQ_Consumer</span> <span class="n">springMQ_consumer</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">SpringMQ_Consumer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">springMQ_consumer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">receiveAndConvert</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…æ”¶åˆ°çš„æ¶ˆæ¯:   "</span> <span class="o">+</span> <span class="n">returnValue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸»é¢˜ç”Ÿäº§è€…</li>
  <li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…éƒ½å¯ä»¥é€šè¿‡jmsTemplateå¯¹è±¡å®æ—¶è®¾ç½®ç›®çš„åœ°ç­‰å…¶ä»–ä¿¡æ¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringMQ_Topic_Producer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">SpringMQ_Topic_Producer</span><span class="o">(</span><span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jmsTemplate</span> <span class="o">=</span> <span class="n">jmsTemplate</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"Application.xml"</span><span class="o">);</span>
        <span class="n">SpringMQ_Topic_Producer</span> <span class="n">springMQ_topic_producer</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">SpringMQ_Topic_Producer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//ç›´æ¥è°ƒç”¨application.xmlé‡Œé¢åˆ›å»ºçš„destinationTopicè¿™ä¸ªbeanè®¾ç½®ä¸ºç›®çš„åœ°å°±è¡Œäº†</span>
        <span class="n">springMQ_topic_producer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">setDefaultDestination</span><span class="o">(((</span><span class="nc">Destination</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"destinationTopic"</span><span class="o">)));</span>
        <span class="n">springMQ_topic_producer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">session</span> <span class="o">-&gt;</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"***Springå’ŒActiveMQçš„æ•´åˆTopicCase111....."</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸»é¢˜æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringMQ_Topic_Consumer</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">;</span>
 
    <span class="kd">public</span> <span class="nf">SpringMQ_Topic_Consumer</span><span class="o">(</span><span class="nc">JmsTemplate</span> <span class="n">jmsTemplate</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">jmsTemplate</span> <span class="o">=</span> <span class="n">jmsTemplate</span><span class="o">;</span>
    <span class="o">}</span>
 
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ApplicationContext</span> <span class="n">applicationContext</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"Application.xml"</span><span class="o">);</span>
        <span class="n">SpringMQ_Topic_Consumer</span> <span class="n">springMQConsumer</span> <span class="o">=</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">SpringMQ_Topic_Consumer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">//ç›´æ¥è°ƒç”¨application.xmlé‡Œé¢åˆ›å»ºçš„destinationTopicè¿™ä¸ªbeanè®¾ç½®ä¸ºç›®çš„åœ°å°±è¡Œäº†</span>
        <span class="n">springMQConsumer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">setDefaultDestination</span><span class="o">(((</span><span class="nc">Destination</span><span class="o">)</span> <span class="n">applicationContext</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="s">"destinationTopic"</span><span class="o">)));</span>
        <span class="nc">String</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">springMQConsumer</span><span class="o">.</span><span class="na">jmsTemplate</span><span class="o">.</span><span class="na">receiveAndConvert</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"****æ¶ˆè´¹è€…æ”¶åˆ°çš„æ¶ˆæ¯:   "</span> <span class="o">+</span> <span class="n">returnValue</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>åœ¨Springé‡Œé¢å®ç°æ¶ˆè´¹è€…ä¸å¯åŠ¨ï¼Œç›´æ¥é€šè¿‡é…ç½®ç›‘å¬å®Œæˆã€‚ç±»ä¼¼äºå‰é¢setMessageListennerå®æ—¶é—´æä¾›æ¶ˆæ¯</li>
  <li>springé…ç½®æ–‡ä»¶</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--  å¼€å¯åŒ…çš„è‡ªåŠ¨æ‰«æ  --&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.demo.activemq"</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!--  é…ç½®ç”Ÿäº§è€…  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"connectionFactory"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.pool.PooledConnectionFactory"</span> <span class="na">destroy-method=</span><span class="s">"stop"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!--      æ­£çœŸå¯ä»¥ç”Ÿäº§Connectionçš„ConnectionFactory,ç”±å¯¹åº”çš„JMSæœåŠ¡å•†æä¾›     --&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.apache.activemq.spring.ActiveMQConnectionFactory"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"brokerURL"</span> <span class="na">value=</span><span class="s">"tcp://192.168.10.130:61616"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/bean&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxConnections"</span> <span class="na">value=</span><span class="s">"100"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  è¿™ä¸ªæ˜¯é˜Ÿåˆ—ç›®çš„åœ°,ç‚¹å¯¹ç‚¹çš„Queue  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"destinationQueue"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.command.ActiveMQQueue"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--    é€šè¿‡æ„é€ æ³¨å…¥Queueå    --&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"spring-active-queue"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  è¿™ä¸ªæ˜¯é˜Ÿåˆ—ç›®çš„åœ°,  å‘å¸ƒè®¢é˜…çš„ä¸»é¢˜Topic--&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"destinationTopic"</span> <span class="na">class=</span><span class="s">"org.apache.activemq.command.ActiveMQTopic"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;constructor-arg</span> <span class="na">index=</span><span class="s">"0"</span> <span class="na">value=</span><span class="s">"spring-active-topic"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  Springæä¾›çš„JMSå·¥å…·ç±»,ä»–å¯ä»¥è¿›è¡Œæ¶ˆæ¯å‘é€,æ¥æ”¶ç­‰  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"jmsTemplate"</span> <span class="na">class=</span><span class="s">"org.springframework.jms.core.JmsTemplate"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--    ä¼ å…¥è¿æ¥å·¥å‚    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span> <span class="na">ref=</span><span class="s">"connectionFactory"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--    ä¼ å…¥ç›®çš„åœ°    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"defaultDestination"</span> <span class="na">ref=</span><span class="s">"destinationQueue"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--    æ¶ˆæ¯è‡ªåŠ¨è½¬æ¢å™¨    --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"messageConverter"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.jms.support.converter.SimpleMessageConverter"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;/property&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!--  é…ç½®Jmsæ¶ˆæ¯ç›‘å¬å™¨  --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"defaultMessageListenerContainer"</span> <span class="na">class=</span><span class="s">"org.springframework.jms.listener.DefaultMessageListenerContainer"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!--  Jmsè¿æ¥çš„å·¥å‚     --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"connectionFactory"</span> <span class="na">ref=</span><span class="s">"connectionFactory"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--   è®¾ç½®é»˜è®¤çš„ç›‘å¬ç›®çš„åœ°     --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"destination"</span> <span class="na">ref=</span><span class="s">"destinationTopic"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--  æŒ‡å®šè‡ªå·±å®ç°äº†MessageListenerçš„ç±»     --&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"messageListener"</span> <span class="na">ref=</span><span class="s">"myMessageListener"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆæ¯ç›‘å¬ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * å®ç°MessageListenerçš„ç±»,éœ€è¦æŠŠè¿™ä¸ªç±»äº¤ç»™xmlé…ç½®é‡Œé¢çš„DefaultMessageListenerContainerç®¡ç†
 */</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMessageListener</span> <span class="kd">implements</span> <span class="nc">MessageListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹è€…æ”¶åˆ°çš„æ¶ˆæ¯"</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹è€…é…ç½®äº†è‡ªåŠ¨ç›‘å¬ï¼Œå°±ç›¸å½“äºåœ¨springé‡Œé¢åå°è¿è¡Œï¼Œæœ‰æ¶ˆæ¯å°±è¿è¡Œæˆ‘ä»¬å®ç°ç›‘å¬ç±»é‡Œé¢çš„æ–¹æ³•</li>
</ul>

<h3 id="springbootæ•´åˆactivemq">springBootæ•´åˆactiveMQ</h3>

<ul>
  <li>pom</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
   <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
   <span class="nt">&lt;parent&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-parent<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>2.1.5.RELEASE<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;relativePath/&gt;</span> <span class="c">&lt;!-- lookup parent from repository --&gt;</span>
   <span class="nt">&lt;/parent&gt;</span>
   <span class="nt">&lt;groupId&gt;</span>com.at.boot.activemq<span class="nt">&lt;/groupId&gt;</span>
   <span class="nt">&lt;artifactId&gt;</span>boot_mq_produce<span class="nt">&lt;/artifactId&gt;</span>
   <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>


   <span class="nt">&lt;properties&gt;</span>
      <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
      <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
      <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
   <span class="nt">&lt;/properties&gt;</span>

   <span class="nt">&lt;dependencies&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>

      <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
      <span class="c">&lt;!--spring bootæ•´åˆactivemqçš„jaråŒ…--&gt;</span>
      <span class="nt">&lt;dependency&gt;</span>
         <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-activemq<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;version&gt;</span>2.1.5.RELEASE<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;/dependency&gt;</span>
   <span class="nt">&lt;/dependencies&gt;</span>

   <span class="nt">&lt;build&gt;</span>
      <span class="nt">&lt;plugins&gt;</span>
         <span class="nt">&lt;plugin&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;/plugin&gt;</span>
      <span class="nt">&lt;/plugins&gt;</span>
   <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span>

</code></pre></div></div>

<ul>
  <li>yml</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># webå ç”¨çš„ç«¯å£</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">7777</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">activemq</span><span class="pi">:</span>
    <span class="c1"># activemqçš„brokerçš„url</span>
    <span class="na">broker-url</span><span class="pi">:</span> <span class="s">tcp://192.168.17.3:61616</span>
    <span class="c1"># è¿æ¥activemqçš„brokeræ‰€éœ€çš„è´¦å·å’Œå¯†ç </span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">admin</span>
  <span class="na">jms</span><span class="pi">:</span>
    <span class="c1"># ç›®çš„åœ°æ˜¯queueè¿˜æ˜¯topicï¼Œ falseï¼ˆé»˜è®¤ï¼‰ = queue    true =  topic</span>
    <span class="na">pub-sub-domain</span><span class="pi">:</span> <span class="no">false</span>

<span class="c1">#  è‡ªå®šä¹‰é˜Ÿåˆ—åç§°ã€‚è¿™åªæ˜¯ä¸ªå¸¸é‡</span>
<span class="na">myqueue</span><span class="pi">:</span> <span class="s">boot-activemq-queue</span>

</code></pre></div></div>

<ul>
  <li>é…ç½®ç›®çš„åœ°çš„beanå’Œå¼€å¯springbootçš„jmsåŠŸèƒ½</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è®©springç®¡ç†çš„æ³¨è§£ï¼Œç›¸å½“äºspringä¸­åœ¨xml ä¸­å†™äº†ä¸ªbean</span>
<span class="nd">@Component</span>
<span class="c1">// å¼€å¯jmsé€‚é…</span>
<span class="nd">@EnableJms</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigBean</span> <span class="o">{</span>

        <span class="c1">// æ³¨å…¥é…ç½®æ–‡ä»¶ä¸­çš„ myqueue</span>
        <span class="nd">@Value</span><span class="o">(</span><span class="s">"${myqueue}"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="nc">String</span> <span class="n">myQueue</span> <span class="o">;</span>

        <span class="nd">@Bean</span>   <span class="c1">// bean id=""  class="â€¦"</span>
        <span class="kd">public</span> <span class="nc">ActiveMQQueue</span> <span class="nf">queue</span><span class="o">(){</span>
             <span class="k">return</span>  <span class="k">new</span> <span class="nf">ActiveMQQueue</span><span class="o">(</span><span class="n">myQueue</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>é˜Ÿåˆ—ç”Ÿäº§è€…ä»£ç ã€‚å‘é€æ¶ˆæ¯</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Queue_Produce</span> <span class="o">{</span>

    <span class="c1">// JMSæ¨¡æ¿</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JmsMessagingTemplate</span>  <span class="n">jmsMessagingTemplate</span> <span class="o">;</span>

    <span class="c1">// è¿™ä¸ªæ˜¯æˆ‘ä»¬é…ç½®çš„é˜Ÿåˆ—ç›®çš„åœ°</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">;</span>

    <span class="c1">// å‘é€æ¶ˆæ¯</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMessage</span><span class="o">(){</span>
        <span class="c1">// ä¸€å‚æ˜¯ç›®çš„åœ°ï¼ŒäºŒå‚æ˜¯æ¶ˆæ¯çš„å†…å®¹</span>
        <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span><span class="s">"****"</span><span class="o">+</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">6</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// å®šæ—¶ä»»åŠ¡ã€‚æ¯3ç§’æ‰§è¡Œä¸€æ¬¡ã€‚éå¿…é¡»ä»£ç ï¼Œä»…ä¸ºæ¼”ç¤ºã€‚</span>
    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceMessageScheduled</span><span class="o">(){</span>
        <span class="n">produceMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸»å¯åŠ¨ç±»</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="c1">// æ˜¯å¦å¼€å¯å®šæ—¶ä»»åŠ¡è°ƒåº¦åŠŸèƒ½</span>
<span class="nd">@EnableScheduling</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainApp_Produce</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">MainApp_Produce</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æµ‹è¯•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åŠ è½½ä¸»ç±»</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="n">MainApp_Produce</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// åŠ è½½springçš„junit</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="c1">// åŠ è½½web</span>
<span class="nd">@WebAppConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestActiveMQ</span> <span class="o">{</span>

    <span class="nd">@Resource</span>    <span class="c1">//  è¿™ä¸ªæ˜¯java çš„æ³¨è§£ï¼Œè€ŒAutowried æ˜¯ spring çš„</span>
    <span class="kd">private</span> <span class="n">Queue_Produce</span>  <span class="n">queue_produce</span> <span class="o">;</span>

<span class="c1">//  è¿™ä¸ªæ˜¯java çš„æ³¨è§£ï¼Œè€ŒAutowried æ˜¯ spring çš„</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span>  <span class="kt">void</span> <span class="nf">testSend</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span><span class="o">{</span>
        <span class="n">queue_produce</span><span class="o">.</span><span class="na">produceMessage</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>é˜Ÿåˆ—æ¶ˆè´¹è€…ï¼Œæ³¨å†Œä¸€ä¸ªæ¶ˆæ¯ç›‘å¬å™¨ã€‚é¡¹ç›®å¼€å¯åç›‘å¬æŸä¸ªä¸»é¢˜çš„æ¶ˆæ¯ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Queue_consummer</span> <span class="o">{</span>

    <span class="c1">// æ³¨å†Œä¸€ä¸ªç›‘å¬å™¨ã€‚destinationæŒ‡å®šç›‘å¬çš„ä¸»é¢˜ã€‚</span>
    <span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">"${myqueue}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="nc">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">" ***  æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯  ***"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸»é¢˜ç”Ÿäº§è€…</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">6666</span>
<span class="na">spring</span><span class="pi">:</span>
  <span class="na">activemq</span><span class="pi">:</span>
    <span class="na">broker-url</span><span class="pi">:</span> <span class="s">tcp://192.168.17.3:61616</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">admin</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">admin</span>
  <span class="na">jms</span><span class="pi">:</span>
    <span class="c1"># ç›®çš„åœ°æ˜¯queueè¿˜æ˜¯topicï¼Œ falseï¼ˆé»˜è®¤ï¼‰ = queue    true =  topic</span>
    <span class="na">pub-sub-domain</span><span class="pi">:</span> <span class="no">true</span>

 <span class="c1">#  è‡ªå®šä¹‰ä¸»é¢˜åç§°</span>
<span class="na">mytopic</span><span class="pi">:</span> <span class="s">boot-activemq-topic</span>

</code></pre></div></div>

<ul>
  <li>é…ç½®ç›®çš„åœ°çš„beanå’Œå¼€å¯JMSåŠŸèƒ½</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="nd">@EnableJms</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConfigBean</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${mytopic}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span>  <span class="n">topicName</span> <span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">Topic</span> <span class="nf">topic</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">ActiveMQTopic</span><span class="o">(</span><span class="n">topicName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ç”Ÿäº§è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic_Produce</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">JmsMessagingTemplate</span>  <span class="n">jmsMessagingTemplate</span> <span class="o">;</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">Topic</span>  <span class="n">topic</span> <span class="o">;</span>

    <span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">produceTopic</span><span class="o">(){</span>
        <span class="n">jmsMessagingTemplate</span><span class="o">.</span><span class="na">convertAndSend</span><span class="o">(</span><span class="n">topic</span><span class="o">,</span><span class="s">"ä¸»é¢˜æ¶ˆæ¯"</span><span class="o">+</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">6</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>ä¸»é¢˜æ¶ˆè´¹è€…</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Topic_Consummer</span> <span class="o">{</span>

    <span class="nd">@JmsListener</span><span class="o">(</span><span class="n">destination</span> <span class="o">=</span> <span class="s">"${mytopic}"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">receive</span><span class="o">(</span><span class="nc">TextMessage</span> <span class="n">textMessage</span><span class="o">)</span> <span class="kd">throws</span>  <span class="nc">Exception</span><span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆè´¹è€…å—åˆ°è®¢é˜…çš„ä¸»é¢˜ï¼š"</span><span class="o">+</span><span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="activemqçš„ä¼ è¾“åè®®">activeMQçš„ä¼ è¾“åè®®</h3>

<ul>
  <li>ActiveMQæ”¯æŒçš„client-brokeré€šè®¯åè®®æœ‰ï¼šTVPã€NIOã€UDPã€SSLã€Http(s)ã€VMã€‚å…¶ä¸­é…ç½®Transport Connectorçš„æ–‡ä»¶åœ¨ActiveMQå®‰è£…ç›®å½•çš„conf/activemq.xmlä¸­çš„<code class="language-plaintext highlighter-rouge">&lt;transportConnectors&gt;</code>æ ‡ç­¾ä¹‹å†…ã€‚</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;transportConnectors&gt;</span>
	<span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"openwire"</span> <span class="na">uri=</span><span class="s">"tcp://0.0.0.0:61616?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"amqp"</span> <span class="na">uri=</span><span class="s">"amqp://0.0.0.0:5672?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"stomp"</span> <span class="na">uri=</span><span class="s">"stomp://0.0.0.0:61613?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"mqtt"</span> <span class="na">uri=</span><span class="s">"mqtt://0.0.0.0:1884?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;transportConnector</span> <span class="na">name=</span><span class="s">"ws"</span> <span class="na">uri=</span><span class="s">"ws://0.0.0.0:61614?maximumConnections=1000&amp;amp;wireFormat.maxFrameSize=104857600"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/transportConnectors&gt;</span>

</code></pre></div></div>

<ul>
  <li>ActiveMQä¸­é»˜è®¤çš„æ¶ˆæ¯åè®®å°±æ˜¯openwire</li>
</ul>

<table>
  <thead>
    <tr>
      <th>åè®®</th>
      <th>æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>TCP</td>
      <td>é»˜è®¤çš„åè®®ï¼Œæ€§èƒ½ç›¸å¯¹å¯ä»¥</td>
    </tr>
    <tr>
      <td>NIO</td>
      <td>åŸºäºTCPåè®®ï¼Œè¿›è¡Œäº†æ‰©å±•ä¼˜åŒ–ï¼Œæ€§èƒ½æ›´å¥½</td>
    </tr>
    <tr>
      <td>UDP</td>
      <td>æ€§èƒ½æ¯”TCPå¥½ï¼Œä½†æ˜¯ä¸å…·æœ‰å¯é æ€§</td>
    </tr>
    <tr>
      <td>SSL</td>
      <td>å®‰å…¨é“¾æ¥</td>
    </tr>
    <tr>
      <td>HTTP(S)</td>
      <td>åŸºäºHTTPæˆ–HTTPS</td>
    </tr>
    <tr>
      <td>VM</td>
      <td>æœ¬èº«ä¸æ˜¯ä¸€ç§åè®®ï¼Œå½“å®¢æˆ·ç«¯å’Œä»£ç†åœ¨åŒä¸€ä¸ªJVMä¸­æ—¶ï¼Œä»–ä»¬ä¹‹é—´éœ€è¦é€šä¿¡ï¼Œä½†ä¸æƒ³å ç”¨ç½‘ç»œé€šé“ï¼Œè€Œæ˜¯ç›´æ¥é€šä¿¡ï¼Œå¯ä»¥é‡‡ç”¨è¯¥æ–¹å¼ã€‚</td>
    </tr>
  </tbody>
</table>

<h4 id="tcpåè®®">TCPåè®®</h4>

<ul>
  <li>Transmission Control Protocol(TCP)æ˜¯é»˜è®¤çš„ã€‚TCPçš„Clientç›‘å¬ç«¯å£61616</li>
  <li>åœ¨ç½‘ç»œä¼ è¾“æ•°æ®å‰ï¼Œå¿…é¡»è¦å…ˆåºåˆ—åŒ–æ•°æ®ï¼Œæ¶ˆæ¯æ˜¯é€šè¿‡ä¸€ä¸ªå«wire protocolçš„æ¥åºåˆ—åŒ–æˆå­—èŠ‚æµ</li>
  <li>TCPè¿æ¥çš„URIåé¢çš„å‚æ•°æ˜¯å¯é€‰çš„</li>
  <li>TCPä¼ è¾“çš„ä¼˜ç‚¹ï¼š
    <ul>
      <li>TCPåè®®ä¼ è¾“å¯é æ€§é«˜ï¼Œç¨³å®šæ€§å¼º</li>
      <li>é«˜æ•ˆç‡ï¼šå­—èŠ‚æµæ–¹å¼ä¼ é€’ï¼Œæ•ˆç‡å¾ˆé«˜</li>
      <li>æœ‰æ•ˆæ€§ã€å¯ç”¨æ€§ï¼šåº”ç”¨å¹¿æ³›ï¼Œæ”¯æŒä»»ä½•å¹³å°</li>
    </ul>
  </li>
</ul>

<h4 id="amqpåè®®">AMQPåè®®</h4>

<ul>
  <li>Advanced Message Queuing Protocolï¼Œä¸€ä¸ªæä¾›ç»Ÿä¸€æ¶ˆæ¯æœåŠ¡çš„åº”ç”¨å±‚æ ‡å‡†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒå¼€å‘è¯­è¨€ç­‰æ¡ä»¶é™åˆ¶ã€‚</li>
</ul>

<h4 id="stompåè®®">STOMPåè®®</h4>

<ul>
  <li>STOPï¼ŒStreaming Text Orientation Message Protocolï¼Œæ˜¯æµæ–‡æœ¬å®šå‘æ¶ˆæ¯åè®®ï¼Œæ˜¯ä¸€ç§ä¸ºMOM(Message Oriented Middlewareï¼Œé¢å‘æ¶ˆæ¯ä¸­é—´ä»¶)è®¾è®¡çš„ç®€å•æ–‡æœ¬åè®®ã€‚</li>
</ul>

<h4 id="mqttåè®®">MQTTåè®®</h4>

<ul>
  <li>MQTT(Message Queuing Telemetry Transportï¼Œæ¶ˆæ¯é˜Ÿåˆ—é¥æµ‹ä¼ è¾“)æ˜¯IBMå¼€å‘çš„ä¸€ä¸ªå³æ—¶é€šè®¯åè®®ï¼Œæœ‰å¯èƒ½æˆä¸ºç‰©è”ç½‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚è¯¥åè®®æ”¯æŒæ‰€æœ‰å¹³å°ï¼Œå‡ ä¹å¯ä»¥æŠŠæ‰€æœ‰è”ç½‘ç‰©å“å’Œå¤–éƒ¨è¿æ¥èµ·æ¥ï¼Œè¢«ç”¨æ¥å½“ä½œä¼ æ„Ÿå™¨å’Œè‡´åŠ¨å™¨(æ¯”å¦‚é€šè¿‡Twitterè®©æˆ¿å±‹è”ç½‘)çš„é€šä¿¡åè®®ã€‚</li>
</ul>

<h4 id="nioåè®®">NIOåè®®</h4>

<ul>
  <li>NIOåè®®å’ŒTCPåè®®ç±»ä¼¼ï¼Œä½†NIOæ›´ä¾§é‡äºåº•å±‚çš„è®¿é—®æ“ä½œã€‚å®ƒå…è®¸å¼€å‘äººå‘˜å¯¹åŒä¸€èµ„æºå¯æœ‰æ›´å¤šçš„clientè°ƒç”¨å’ŒæœåŠ¡å™¨ç«¯æœ‰æ›´å¤šçš„è´Ÿè½½ã€‚</li>
  <li>é€‚åˆä½¿ç”¨NIOåè®®çš„åœºæ™¯ï¼š
    <ul>
      <li>å¯èƒ½æœ‰å¤§é‡çš„Clientå»è¿æ¥åˆ°Brokerä¸Šï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¤§é‡çš„Clientå»è¿æ¥Brokeræ˜¯è¢«æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ‰€é™åˆ¶çš„ã€‚å› æ­¤ï¼ŒNIOçš„å®ç°æ¯”TCPéœ€è¦æ›´å°‘çš„çº¿ç¨‹å»è¿è¡Œï¼Œæ‰€ä»¥å»ºè®®ä½¿ç”¨NIOåè®®ã€‚</li>
      <li>å¯èƒ½å¯¹äºBrokeræœ‰ä¸€ä¸ªå¾ˆè¿Ÿé’çš„ç½‘ç»œä¼ è¾“ï¼ŒNIOæ¯”TCPæä¾›æ›´å¥½çš„æ€§èƒ½ã€‚</li>
    </ul>
  </li>
  <li>NIOè¿æ¥çš„URIå½¢å¼ï¼šnio://hostname:port?key=value&amp;key=value</li>
</ul>

<h3 id="æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–">æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–</h3>

<ul>
  <li>MQé«˜å¯ç”¨ï¼šäº‹åŠ¡ã€å¯æŒä¹…ã€ç­¾æ”¶ï¼Œæ˜¯å±äºMQè‡ªèº«ç‰¹æ€§ï¼Œè‡ªå¸¦çš„ã€‚<strong>è¿™é‡Œçš„æŒä¹…åŒ–æ˜¯å¤–åŠ›ï¼Œæ˜¯å¤–éƒ¨æ’ä»¶</strong>ã€‚ä¹‹å‰è®²çš„æŒä¹…åŒ–æ˜¯MQçš„å¤–åœ¨è¡¨ç°ï¼Œç°åœ¨è®²çš„çš„æŒä¹…æ˜¯æ˜¯åº•å±‚å®ç°ã€‚</li>
  <li>ä¸ºäº†é¿å…æ„å¤–å®•æœºä»¥åä¸¢å¤±ä¿¡æ¯ï¼Œéœ€è¦åšåˆ°é‡å¯åå¯ä»¥æ¢å¤æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ¶ˆæ¯ç³»ç»Ÿä¸€åŠéƒ½ä¼šé‡‡ç”¨æŒä¹…åŒ–æœºåˆ¶ã€‚ActiveMQçš„æ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶æœ‰JDBCï¼ŒAMQï¼ŒKahaDBå’ŒLevelDBï¼Œæ— è®ºä½¿ç”¨å“ªç§æŒä¹…åŒ–æ–¹å¼ï¼Œæ¶ˆæ¯çš„å­˜å‚¨é€»è¾‘éƒ½æ˜¯ä¸€è‡´çš„ã€‚å°±æ˜¯åœ¨å‘é€è€…å°†æ¶ˆæ¯å‘é€å‡ºå»åï¼Œæ¶ˆæ¯ä¸­å¿ƒé¦–å…ˆå°†æ¶ˆæ¯å­˜å‚¨åˆ°æœ¬åœ°æ•°æ®æ–‡ä»¶ã€å†…å­˜æ•°æ®åº“æˆ–è€…è¿œç¨‹æ•°æ®åº“ç­‰ã€‚å†è¯•å›¾å°†æ¶ˆæ¯å‘ç»™æ¥æ”¶è€…ï¼ŒæˆåŠŸåˆ™å°†æ¶ˆæ¯ä»å­˜å‚¨ä¸­åˆ é™¤ï¼Œå¤±è´¥åˆ™ç»§ç»­å°è¯•å°è¯•å‘é€ã€‚æ¶ˆæ¯ä¸­å¿ƒå¯åŠ¨ä»¥åï¼Œè¦å…ˆæ£€æŸ¥æŒ‡å®šçš„å­˜å‚¨ä½ç½®æ˜¯å¦æœ‰æœªæˆåŠŸå‘é€çš„æ¶ˆæ¯ï¼Œå¦‚æœæœ‰ï¼Œåˆ™ä¼šå…ˆæŠŠå­˜å‚¨ä½ç½®ä¸­çš„æ¶ˆæ¯å‘å‡ºå»ã€‚</li>
</ul>

<h4 id="kahadbæ¶ˆæ¯å­˜å‚¨">kahaDBæ¶ˆæ¯å­˜å‚¨</h4>

<ul>
  <li>åŸºäºæ—¥å¿—æ–‡ä»¶ï¼Œä»ActiveMQ5.4ï¼ˆå«ï¼‰å¼€å§‹é»˜è®¤çš„æŒä¹…åŒ–æ’ä»¶ã€‚</li>
  <li>æ—¥å¿—æ–‡ä»¶çš„å­˜å‚¨ç›®å½•åœ¨ï¼š%activemqå®‰è£…ç›®å½•%/data/kahadb</li>
  <li>KahaDBæ˜¯ç›®å‰é»˜è®¤çš„å­˜å‚¨æ–¹å¼ï¼Œå¯ç”¨äºä»»ä½•åœºæ™¯ï¼Œæé«˜äº†æ€§èƒ½å’Œæ¢å¤èƒ½åŠ›ã€‚</li>
  <li>æ¶ˆæ¯å­˜å‚¨ä½¿ç”¨ä¸€ä¸ªäº‹åŠ¡æ—¥å¿—å’Œä»…ä»…ç”¨ä¸€ä¸ªç´¢å¼•æ–‡ä»¶æ¥å­˜å‚¨å®ƒæ‰€æœ‰çš„åœ°å€ã€‚</li>
  <li>KahaDBæ˜¯ä¸€ä¸ªä¸“é—¨é’ˆå¯¹æ¶ˆæ¯æŒä¹…åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒå¯¹å…¸å‹çš„æ¶ˆæ¯ä½¿ç”¨æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–ã€‚</li>
  <li>æ•°æ®è¢«è¿½åŠ åˆ°data logsä¸­ã€‚å½“ä¸å†éœ€è¦logæ–‡ä»¶ä¸­çš„æ•°æ®çš„æ—¶å€™ï¼Œlogæ–‡ä»¶ä¼šè¢«ä¸¢å¼ƒã€‚</li>
  <li>KahaDBåœ¨æ¶ˆæ¯ä¿å­˜çš„ç›®å½•ä¸­æœ‰4ç±»æ–‡ä»¶å’Œä¸€ä¸ªlock
    <ul>
      <li><strong>db-number.log</strong>ï¼šKahaDBå­˜å‚¨æ¶ˆæ¯åˆ°é¢„å®šå¤§å°çš„æ•°æ®çºªå½•æ–‡ä»¶ä¸­ï¼Œæ–‡ä»¶åä¸ºdb-number.logã€‚å½“æ•°æ®æ–‡ä»¶å·²æ»¡æ—¶ï¼Œä¸€ä¸ªæ–°çš„æ–‡ä»¶ä¼šéšä¹‹åˆ›å»ºï¼Œnumberæ•°å€¼ä¹Ÿä¼šéšä¹‹é€’å¢ï¼Œå½“ä¸å†æœ‰å¼•ç”¨åˆ°æ•°æ®æ–‡ä»¶ä¸­çš„ä»»ä½•æ¶ˆæ¯æ—¶ï¼Œæ–‡ä»¶ä¼šè¢«åˆ é™¤æˆ–è€…å½’æ¡£ã€‚</li>
      <li><strong>db.data</strong>ï¼šè¯¥æ–‡ä»¶åŒ…å«äº†æŒä¹…åŒ–çš„BTreeç´¢å¼•ï¼Œç´¢å¼•äº†æ¶ˆæ¯æ•°æ®è®°å½•ä¸­çš„æ¶ˆæ¯ï¼Œå®ƒæ˜¯æ¶ˆæ¯çš„ç´¢å¼•æ–‡ä»¶ï¼Œæœ¬è´¨ä¸Šæ˜¯B-Treeï¼ˆBæ ‘ï¼‰ï¼Œä½¿ç”¨B-Treeä½œä¸ºç´¢å¼•æŒ‡å‘db-numberã€‚logé‡Œé¢å­˜å‚¨æ¶ˆæ¯ã€‚</li>
      <li><strong>db.free</strong>ï¼šå½“é—®å½“å‰db.dataæ–‡ä»¶é‡Œé¢å“ªäº›é¡µé¢æ˜¯ç©ºé—²çš„ï¼Œæ–‡ä»¶å…·ä½“å†…å®¹æ˜¯æ‰€æœ‰ç©ºé—²é¡µçš„ID</li>
      <li><strong>db.redo</strong>ï¼šç”¨æ¥è¿›è¡Œæ¶ˆæ¯æ¢å¤ï¼Œå¦‚æœKahaDBæ¶ˆæ¯å­˜å‚¨å†å¼ºåˆ¶é€€å‡ºåå¯åŠ¨ï¼Œç”¨äºæ¢å¤BTreeç´¢å¼•ã€‚</li>
      <li><strong>lock</strong>ï¼šæ–‡ä»¶é”ï¼Œè¡¨ç¤ºå½“å‰kahadbç‹¬å†™æƒé™çš„brokerã€‚</li>
    </ul>
  </li>
</ul>

<h4 id="jdbcæ¶ˆæ¯å­˜å‚¨">JDBCæ¶ˆæ¯å­˜å‚¨</h4>

<ul>
  <li>æ·»åŠ mysqlæ•°æ®åº“çš„é©±åŠ¨åŒ…åˆ°activeMQçš„libæ–‡ä»¶å¤¹</li>
  <li>ä¿®æ”¹activemq.xml</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;persistenceAdapter&gt;</span>  
      <span class="nt">&lt;jdbcPersistenceAdapter</span> <span class="na">dataSource=</span><span class="s">"#mysql-ds"</span> <span class="na">createTableOnStartup=</span><span class="s">"true"</span><span class="nt">/&gt;</span> 
<span class="nt">&lt;/persistenceAdapter&gt;</span>
<span class="c">&lt;!--
dataSourceæ˜¯æŒ‡å®šå°†è¦å¼•ç”¨çš„æŒä¹…åŒ–æ•°æ®åº“çš„beanåç§°ã€‚
createTableOnStartupæ˜¯å¦åœ¨å¯åŠ¨çš„æ—¶å€™åˆ›å»ºæ•°æ®åº“è¡¨ï¼Œé»˜è®¤æ˜¯trueï¼Œè¿™æ ·æ¯æ¬¡å¯åŠ¨éƒ½ä¼šå»åˆ›å»ºè¡¨äº†ï¼Œä¸€èˆ¬æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™è®¾ç½®ä¸ºtrueï¼Œç„¶åå†å»æ”¹æˆfalseã€‚
--&gt;</span>
</code></pre></div></div>

<ul>
  <li>æ•°æ®åº“è¿æ¥æ± é…ç½®:ä¹‹åéœ€è¦å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œåä¸ºactivemqã€‚æ–°å»ºçš„æ•°æ®åº“è¦é‡‡ç”¨latin1 æˆ–è€…ASCIIç¼–ç ã€‚</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;/broker&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"mysql-ds"</span> <span class="na">class=</span><span class="s">"org.apache.commons.dbcp2.BasicDataSource"</span> <span class="na">destroy-method=</span><span class="s">"close"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driverClassName"</span> <span class="na">value=</span><span class="s">"com.mysql.jdbc.Driver"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"jdbc:mysql://mysqlæ•°æ®åº“URL/activemq?relaxAutoCommit=true"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"mysqlæ•°æ®åº“ç”¨æˆ·å"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"mysqlæ•°æ®åº“å¯†ç "</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"poolPreparedStatements"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">"jetty.xml"</span><span class="nt">/&gt;</span>

</code></pre></div></div>

<ul>
  <li>é‡å¯activemqã€‚ä¼šè‡ªåŠ¨ç”Ÿæˆå¦‚ä¸‹3å¼ è¡¨ã€‚å¦‚æœæ²¡æœ‰è‡ªåŠ¨ç”Ÿæˆï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ‰§è¡ŒSQLã€‚ACTIVEMQ_ACKSï¼ŒACTIVEMQ_MSGSï¼ŒACTIVEMQ_LOCK</li>
  <li>queueæ¨¡å¼ï¼ŒéæŒä¹…åŒ–ä¸ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–åˆ°æ•°æ®åº“ã€‚</li>
  <li>queueæ¨¡å¼ï¼ŒæŒä¹…åŒ–ä¼šå°†æ¶ˆæ¯æŒä¹…åŒ–æ•°æ®åº“ã€‚</li>
  <li>æˆ‘ä»¬ä½¿ç”¨queueæ¨¡å¼æŒä¹…åŒ–ï¼Œå‘å¸ƒ3æ¡æ¶ˆæ¯åï¼Œå‘ç°ACTIVEMQ_MSGSæ•°æ®è¡¨å¤šäº†3æ¡æ•°æ®ã€‚</li>
  <li>
    <p>å¯åŠ¨æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹äº†æ‰€æœ‰çš„æ¶ˆæ¯åï¼Œå‘ç°æ•°æ®è¡¨çš„æ•°æ®æ¶ˆå¤±äº†ã€‚</p>
  </li>
  <li>æˆ‘ä»¬å…ˆå¯åŠ¨ä¸€ä¸‹æŒä¹…åŒ–topicçš„æ¶ˆè´¹è€…ã€‚çœ‹åˆ°ACTIVEMQ_ACKSæ•°æ®è¡¨å¤šäº†ä¸€æ¡æ¶ˆæ¯ã€‚å¤šäº†ä¸€ä¸ªæ¶ˆè´¹è€…çš„èº«ä»½ä¿¡æ¯ã€‚ä¸€æ¡è®°å½•ä»£è¡¨ï¼šä¸€ä¸ªæŒä¹…åŒ–topicæ¶ˆè´¹è€…</li>
  <li>
    <p>æŒä¹…åŒ–topicçš„æ¶ˆæ¯ä¸ç®¡æ˜¯å¦è¢«æ¶ˆè´¹ï¼Œæ˜¯å¦æœ‰æ¶ˆè´¹è€…ï¼Œäº§ç”Ÿçš„æ•°æ®æ°¸è¿œéƒ½å­˜åœ¨ï¼Œä¸”åªå­˜å‚¨ä¸€æ¡ã€‚è¿™ä¸ªæ˜¯è¦æ³¨æ„çš„ï¼ŒæŒä¹…åŒ–çš„topicå¤§é‡æ•°æ®åå¯èƒ½å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚è¿™é‡Œå°±åƒå…¬ä¼—å·ä¸€æ ·ï¼Œæ¶ˆè´¹è€…æ¶ˆè´¹å®Œåï¼Œæ¶ˆæ¯è¿˜ä¼šä¿ç•™ã€‚</p>
  </li>
  <li>æ€»ç»“ï¼š
    <ul>
      <li>å¦‚æœæ˜¯queueï¼Œåœ¨æ²¡æœ‰æ¶ˆè´¹è€…æ¶ˆè´¹çš„æƒ…å†µä¸‹ä¼šå°†æ¶ˆæ¯ä¿å­˜åˆ°activemq_msgsè¡¨ä¸­ï¼Œåªè¦æœ‰ä»»æ„ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹äº†ï¼Œå°±ä¼š<strong>åˆ é™¤æ¶ˆè´¹è¿‡çš„æ¶ˆæ¯</strong></li>
      <li>å¦‚æœæ˜¯topicï¼Œä¸€èˆ¬æ˜¯å…ˆå¯åŠ¨æ¶ˆè´¹è®¢é˜…è€…ç„¶åå†ç”Ÿäº§çš„æƒ…å†µä¸‹<strong>ä¼šå°†æŒä¹…è®¢é˜…è€…æ°¸ä¹…ä¿å­˜åˆ°qctivemq_acks</strong>ï¼Œè€Œ<strong>æ¶ˆæ¯åˆ™æ°¸ä¹…ä¿å­˜åœ¨activemq_msgs</strong>ï¼Œåœ¨acksè¡¨ä¸­çš„è®¢é˜…è€…æœ‰ä¸€ä¸ªlast_ack_idå¯¹åº”äº†activemq_msgsä¸­çš„idå­—æ®µï¼Œè¿™æ ·å°±çŸ¥é“è®¢é˜…è€…æœ€åæ”¶åˆ°çš„æ¶ˆæ¯æ˜¯å“ªä¸€æ¡ã€‚</li>
    </ul>
  </li>
  <li>é‡‡å‘
    <ul>
      <li>æ•°æ®åº“jaråŒ…ï¼Œæ³¨æ„æŠŠå¯¹åº”ç‰ˆæœ¬çš„æ•°æ®åº“jaræˆ–è€…ä½ è‡ªå·±ä½¿ç”¨çš„éè‡ªå¸¦çš„æ•°æ®åº“è¿æ¥æ± jaråŒ…</li>
      <li>createTablesOnStartupå±æ€§ï¼šé»˜è®¤ä¸ºtrueï¼Œæ¯æ¬¡å¯åŠ¨activemqéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºè¡¨ï¼Œåœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œåº”æ”¹ä¸ºfalseï¼Œé¿å…ä¸å¿…è¦çš„æŸå¤±ã€‚</li>
      <li>java.lang.IllegalStateException: LifecycleProcessor not initializedï¼šç¡®è®¤è®¡ç®—æœºä¸»æœºååç§°æ²¡æœ‰ä¸‹åˆ’çº¿</li>
    </ul>
  </li>
</ul>

<h4 id="jdbc-message-store-with-activemq-journal">JDBC Message store with ActiveMQ Journal</h4>

<ul>
  <li>è¿™ç§æ–¹å¼å…‹æœäº†JDBC Storeçš„ä¸è¶³ï¼ŒJDBCæ¯æ¬¡æ¶ˆæ¯è¿‡æ¥ï¼Œéƒ½éœ€è¦å»å†™åº“è¯»åº“ã€‚ActiveMQ Journalï¼Œä½¿ç”¨é«˜é€Ÿç¼“å­˜å†™å…¥æŠ€æœ¯ï¼Œå¤§å¤§æé«˜äº†æ€§èƒ½ã€‚å½“æ¶ˆè´¹è€…çš„é€Ÿåº¦èƒ½å¤ŸåŠæ—¶è·Ÿä¸Šç”Ÿäº§è€…æ¶ˆæ¯çš„ç”Ÿäº§é€Ÿåº¦æ—¶ï¼Œjournalæ–‡ä»¶èƒ½å¤Ÿå¤§å¤§å‡å°‘éœ€è¦å†™å…¥åˆ°DBä¸­çš„æ¶ˆæ¯ã€‚</li>
  <li>ä¸¾ä¸ªä¾‹å­ï¼šç”Ÿäº§è€…ç”Ÿäº§äº†1000æ¡æ¶ˆæ¯ï¼Œè¿™1000æ¡æ¶ˆæ¯ä¼šä¿å­˜åˆ°journalæ–‡ä»¶ï¼Œå¦‚æœæ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦å¾ˆå¿«çš„æƒ…å†µä¸‹ï¼Œåœ¨journalæ–‡ä»¶è¿˜æ²¡æœ‰åŒæ­¥åˆ°DBä¹‹å‰ï¼Œæ¶ˆè´¹è€…å·²ç»æ¶ˆè´¹äº†90%çš„ä»¥ä¸Šæ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™åªéœ€è¦åŒæ­¥å‰©ä½™çš„10%çš„æ¶ˆæ¯åˆ°DBã€‚å¦‚æœæ¶ˆè´¹è€…çš„é€Ÿåº¦å¾ˆæ…¢ï¼Œè¿™ä¸ªæ—¶å€™journalæ–‡ä»¶å¯ä»¥ä½¿æ¶ˆæ¯ä»¥æ‰¹é‡æ–¹å¼å†™åˆ°DBã€‚</li>
  <li>ä¸ºäº†é«˜æ€§èƒ½ï¼Œè¿™ç§æ–¹å¼ä½¿ç”¨æ—¥å¿—æ–‡ä»¶å­˜å‚¨+æ•°æ®åº“å­˜å‚¨ã€‚<strong>å…ˆå°†æ¶ˆæ¯æŒä¹…åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†å°†æœªæ¶ˆè´¹çš„æ¶ˆæ¯æŒä¹…åˆ°æ•°æ®åº“</strong>ã€‚è¯¥æ–¹å¼è¦æ¯”JDBCæ€§èƒ½è¦é«˜ã€‚</li>
  <li>é…ç½®</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;persistenceFactory&gt;</span>        
              <span class="nt">&lt;journalPersistenceAdapterFactory</span> 
                                   <span class="na">journalLogFiles=</span><span class="s">"5"</span> 
                                   <span class="na">journalLogFileSize=</span><span class="s">"32768"</span> 
                                   <span class="na">useJournal=</span><span class="s">"true"</span> 
                                   <span class="na">useQuickJournal=</span><span class="s">"true"</span> 
                                   <span class="na">dataSource=</span><span class="s">"#mysql-ds"</span> 
                                   <span class="na">dataDirectory=</span><span class="s">"../activemq-data"</span> <span class="nt">/&gt;</span> 
<span class="nt">&lt;/persistenceFactory&gt;</span>
</code></pre></div></div>

<h4 id="æ€»ç»“">æ€»ç»“</h4>

<ul>
  <li>jdbcæ•ˆç‡ä½ï¼ŒkahaDBæ•ˆç‡é«˜ï¼Œjdbc+Journalæ•ˆç‡è¾ƒé«˜ã€‚</li>
  <li>æŒä¹…åŒ–æ¶ˆæ¯ä¸»è¦æŒ‡çš„æ˜¯ï¼šMQæ‰€åœ¨æœåŠ¡å™¨å®•æœºäº†æ¶ˆæ¯ä¸ä¼šä¸¢è¯•çš„æœºåˆ¶</li>
  <li>ActiveMQæ¶ˆæ¯æŒä¹…åŒ–æœºåˆ¶æœ‰ï¼š
    <ul>
      <li>AMQï¼šåŸºäºæ—¥å¿—æ–‡ä»¶</li>
      <li>KahaDBï¼šåŸºäºæ—¥å¿—æ–‡ä»¶ï¼Œä»ActiveMQ5.4å¼€å§‹é»˜è®¤ä½¿ç”¨</li>
      <li>JDBCï¼šåŸºäºç¬¬ä¸‰æ–¹æ•°æ®åº“</li>
      <li>Replicated LevelDB Store ï¼šä»5.9å¼€å§‹æä¾›äº†LevelDBå’ŒZookeeperçš„æ•°æ®å¤åˆ¶æ–¹æ³•ï¼Œç”¨äºMaster-slaveæ–¹å¼çš„é¦–é€‰æ•°æ®å¤åˆ¶æ–¹æ¡ˆã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="å¤šèŠ‚ç‚¹é›†ç¾¤">å¤šèŠ‚ç‚¹é›†ç¾¤</h3>

<ul>
  <li>åŸºäºzookeeperå’ŒLevelDBæ­å»ºActiveMQé›†ç¾¤ã€‚é›†ç¾¤ä»…æä¾›ä¸»å¤‡æ–¹å¼çš„é«˜å¯ç”¨é›†ç¾¤åŠŸèƒ½ï¼Œé¿å…å•ç‚¹æ•…éšœã€‚</li>
  <li>zookeeper+replicated-leveldb-storeçš„ä¸»ä»é›†ç¾¤</li>
</ul>

<h3 id="å¼‚æ­¥æŠ•é€’">å¼‚æ­¥æŠ•é€’</h3>

<ul>
  <li>ActiveMQæ”¯æŒåŒæ­¥ï¼Œå¼‚æ­¥ä¸¤ç§å‘é€çš„æ¨¡å¼å°†æ¶ˆæ¯å‘é€åˆ°brokerï¼Œæ¨¡å¼çš„é€‰æ‹©å¯¹å‘é€å»¶æ—¶æœ‰å·¨å¤§çš„å½±å“ã€‚producerèƒ½è¾¾åˆ°æ€ä¹ˆæ ·çš„äº§å‡ºç‡ï¼ˆäº§å‡ºç‡=å‘é€æ•°æ®æ€»é‡/æ—¶é—´ï¼‰ä¸»è¦å—å‘é€å»¶æ—¶çš„å½±å“ï¼Œä½¿ç”¨å¼‚æ­¥å‘é€å¯ä»¥æ˜¾è‘—æé«˜å‘é€çš„æ€§èƒ½ã€‚</li>
  <li>ActiveMQé»˜è®¤ä½¿ç”¨å¼‚æ­¥å‘é€çš„æ¨¡å¼ï¼šé™¤éæ˜ç¡®æŒ‡å®šä½¿ç”¨åŒæ­¥å‘é€çš„æ–¹å¼æˆ–è€…åœ¨æœªä½¿ç”¨äº‹åŠ¡çš„å‰æä¸‹å‘é€æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼Œè¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯åŒæ­¥å‘é€çš„ã€‚</li>
  <li>å¦‚æœä½ æ²¡æœ‰ä½¿ç”¨äº‹åŠ¡ä¸”å‘é€çš„æ˜¯æŒä¹…åŒ–çš„æ¶ˆæ¯ï¼Œæ¯ä¸€æ¬¡å‘é€éƒ½æ˜¯åŒæ­¥å‘é€çš„ä¸”ä¼šé˜»å¡</li>
  <li>producerçŸ¥é“brokerè¿”å›ä¸€ä¸ªç¡®è®¤ï¼Œè¡¨ç¤ºæ¶ˆæ¯å·²ç»è¢«å®‰å…¨çš„æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚ç¡®è®¤æœºåˆ¶æä¾›äº†æ¶ˆæ¯å®‰å…¨çš„ä¿éšœï¼Œä½†åŒæ—¶ä¼šé˜»å¡å®¢æˆ·ç«¯å¸¦æ¥äº†å¾ˆå¤§çš„å»¶æ—¶ã€‚</li>
  <li>å¾ˆå¤šé«˜æ€§èƒ½çš„åº”ç”¨ï¼Œå…è®¸åœ¨å¤±è´¥çš„æƒ…å†µä¸‹æœ‰å°‘é‡çš„æ•°æ®ä¸¢å¤±ã€‚å¦‚æœä½ çš„åº”ç”¨æ»¡è¶³è¿™ä¸ªç‰¹ç‚¹ï¼Œä½ å¯ä»¥ä½¿ç”¨å¼‚æ­¥å‘é€æ¥æé«˜ç”Ÿäº§ç‡ï¼Œå³ä½¿å‘é€çš„æ˜¯æŒä¹…åŒ–çš„æ¶ˆæ¯ã€‚</li>
  <li>å¼‚æ­¥å‘é€å®ƒå¯ä»¥æœ€å¤§åŒ–producerç«¯çš„å‘é€æ•ˆç‡ã€‚æˆ‘ä»¬é€šå¸¸åœ¨å‘é€æ¶ˆæ¯é‡æ¯”è¾ƒå¯†é›†çš„æƒ…å†µä¸‹ä½¿ç”¨å¼‚æ­¥å‘é€ï¼Œå®ƒå¯ä»¥å¾ˆå¤§çš„æå‡Produceræ€§èƒ½ï¼›ä¸è¿‡è¿™ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„é—®é¢˜ï¼Œ
å°±æ˜¯éœ€è¦æ¶ˆè€—æ›´å¤šçš„Clientç«¯å†…å­˜åŒæ—¶ä¹Ÿä¼šå¯¼è‡´brokerç«¯æ€§èƒ½æ¶ˆè€—å¢åŠ ï¼›
æ­¤å¤–å®ƒä¸èƒ½æœ‰æ•ˆçš„ç¡®ä¿æ¶ˆæ¯çš„å‘é€æˆåŠŸã€‚åœ¨userAsyncSend=trueçš„æƒ…å†µä¸‹å®¢æˆ·ç«¯éœ€è¦å®¹å¿æ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½ã€‚</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnection</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.activemq.ActiveMQConnectionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.jms.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Producer</span> <span class="o">{</span>

    <span class="c1">// æ–¹å¼1ã€‚3ç§æ–¹å¼ä»»é€‰ä¸€ç§</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626?jms.useAsyncSend=true"</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Async"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="c1">// æ–¹å¼2</span>
        <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">setUseAsyncSend</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="c1">// æ–¹å¼3</span>
        <span class="o">((</span><span class="nc">ActiveMQConnection</span><span class="o">)</span><span class="n">connection</span><span class="o">).</span><span class="na">setUseAsyncSend</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">producer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"tx msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">producer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å‘é€å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">producer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>å¼‚æ­¥å‘é€å¦‚ä½•ç¡®ä¿æ¶ˆæ¯å‘é€æˆåŠŸï¼Ÿ
    <ul>
      <li>å¼‚æ­¥å‘é€ä¸¢å¤±æ¶ˆæ¯çš„åœºæ™¯æ˜¯ï¼šç”Ÿäº§è€…è®¾ç½®userAsyncSend=trueï¼Œä½¿ç”¨producer.send(msg)æŒç»­å‘é€æ¶ˆæ¯ã€‚</li>
      <li>å¦‚æœæ¶ˆæ¯ä¸é˜»å¡ï¼Œç”Ÿäº§è€…ä¼šè®¤ä¸ºæ‰€æœ‰sendçš„æ¶ˆæ¯å‡è¢«æˆåŠŸå‘é€è‡³MQã€‚</li>
      <li>å¦‚æœMQçªç„¶å®•æœºï¼Œæ­¤æ—¶ç”Ÿäº§è€…ç«¯å†…å­˜ä¸­å°šæœªè¢«å‘é€è‡³MQçš„æ¶ˆæ¯éƒ½ä¼šä¸¢å¤±ã€‚</li>
      <li>æ­£ç¡®çš„å¼‚æ­¥å‘é€æ–¹æ³•æ˜¯éœ€è¦æ¥æ”¶å›è°ƒçš„ã€‚åŒæ­¥å‘é€å’Œå¼‚æ­¥å‘é€çš„åŒºåˆ«å°±åœ¨æ­¤ï¼ŒåŒæ­¥å‘é€ç­‰sendä¸é˜»å¡äº†å°±è¡¨ç¤ºä¸€å®šå‘é€æˆåŠŸäº†ï¼Œå¼‚æ­¥å‘é€éœ€è¦å®¢æˆ·ç«¯å›æ‰§å¹¶ç”±å®¢æˆ·ç«¯å†åˆ¤æ–­ä¸€æ¬¡æ˜¯å¦å‘é€æˆåŠŸ</li>
    </ul>
  </li>
  <li>å¼‚æ­¥å‘é€å›è°ƒ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Producer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Async"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">setUseAsyncSend</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">ActiveMQMessageProducer</span> <span class="n">activeMQMessageProducer</span> <span class="o">=</span> <span class="o">(</span><span class="nc">ActiveMQMessageProducer</span><span class="o">)</span><span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"tx msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="n">textMessage</span><span class="o">.</span><span class="na">setJMSMessageID</span><span class="o">(</span><span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()+</span><span class="s">"orderAtguigu"</span><span class="o">);</span>
                <span class="kd">final</span> <span class="nc">String</span>  <span class="n">msgId</span> <span class="o">=</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getJMSMessageID</span><span class="o">();</span>
                <span class="n">activeMQMessageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">,</span> <span class="k">new</span> <span class="nc">AsyncCallback</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSuccess</span><span class="o">()</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æˆåŠŸå‘é€æ¶ˆæ¯Id:"</span><span class="o">+</span><span class="n">msgId</span><span class="o">);</span>
                    <span class="o">}</span>

                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onException</span><span class="o">(</span><span class="nc">JMSException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å¤±è´¥å‘é€æ¶ˆæ¯Id:"</span><span class="o">+</span><span class="n">msgId</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å‘é€å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">activeMQMessageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="å»¶è¿ŸæŠ•é€’å’Œå®šæ—¶æŠ•é€’">å»¶è¿ŸæŠ•é€’å’Œå®šæ—¶æŠ•é€’</h3>

<ul>
  <li>è¦åœ¨activemq.xmlä¸­é…ç½®schedulerSupportå±æ€§ä¸ºtrueã€‚ä¹‹åé‡å¯activemq</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;broker</span> <span class="na">xmlns=</span><span class="s">"http://activemq.apache.org/schema/core"</span> <span class="na">brokerName=</span><span class="s">"localhost"</span> <span class="na">dataDirectory=</span><span class="s">"${activemq.data}"</span>  <span class="na">schedulerSupport=</span><span class="s">"true"</span> <span class="nt">&gt;</span>
</code></pre></div></div>

<ul>
  <li>javaä»£ç é‡Œé¢å°è£…çš„è¾…åŠ©æ¶ˆæ¯ç±»å‹ï¼šScheduleMessage</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Producer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Schedule01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageProducer</span> <span class="n">messageProducer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createProducer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span>  <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">period</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="mi">1000</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">repeat</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createTextMessage</span><span class="o">(</span><span class="s">"tx msg--"</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
                <span class="c1">// å»¶è¿Ÿçš„æ—¶é—´</span>
                <span class="n">textMessage</span><span class="o">.</span><span class="na">setLongProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_DELAY</span><span class="o">,</span> <span class="n">delay</span><span class="o">);</span>
                <span class="c1">// é‡å¤æŠ•é€’çš„æ—¶é—´é—´éš”</span>
                <span class="n">textMessage</span><span class="o">.</span><span class="na">setLongProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_PERIOD</span><span class="o">,</span> <span class="n">period</span><span class="o">);</span>
                <span class="c1">// é‡å¤æŠ•é€’çš„æ¬¡æ•°</span>
                <span class="n">textMessage</span><span class="o">.</span><span class="na">setIntProperty</span><span class="o">(</span><span class="nc">ScheduledMessage</span><span class="o">.</span><span class="na">AMQ_SCHEDULED_REPEAT</span><span class="o">,</span> <span class="n">repeat</span><span class="o">);</span>
                <span class="c1">// æ­¤å¤„çš„æ„æ€ï¼šè¯¥æ¡æ¶ˆæ¯ï¼Œç­‰å¾…10ç§’ï¼Œä¹‹åæ¯5ç§’å‘é€ä¸€æ¬¡ï¼Œé‡å¤å‘é€3æ¬¡ã€‚</span>
                <span class="n">messageProducer</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">textMessage</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"æ¶ˆæ¯å‘é€å®Œæˆ"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">messageProducer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<ul>
  <li>æ¶ˆè´¹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Jms_TX_Consumer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_URL</span> <span class="o">=</span> <span class="s">"tcp://118.24.20.3:61626"</span><span class="o">;</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">ACTIVEMQ_QUEUE_NAME</span> <span class="o">=</span> <span class="s">"Schedule01"</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">JMSException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="nc">ActiveMQConnectionFactory</span> <span class="n">activeMQConnectionFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ActiveMQConnectionFactory</span><span class="o">(</span><span class="no">ACTIVEMQ_URL</span><span class="o">);</span>
        <span class="nc">Connection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">activeMQConnectionFactory</span><span class="o">.</span><span class="na">createConnection</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="nc">Session</span> <span class="n">session</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="na">createSession</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="nc">Session</span><span class="o">.</span><span class="na">AUTO_ACKNOWLEDGE</span><span class="o">);</span>
        <span class="nc">Queue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createQueue</span><span class="o">(</span><span class="no">ACTIVEMQ_QUEUE_NAME</span><span class="o">);</span>
        <span class="nc">MessageConsumer</span> <span class="n">messageConsumer</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="na">createConsumer</span><span class="o">(</span><span class="n">queue</span><span class="o">);</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">setMessageListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">MessageListener</span><span class="o">()</span> <span class="o">{</span>

            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">message</span> <span class="k">instanceof</span> <span class="nc">TextMessage</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="nc">TextMessage</span> <span class="n">textMessage</span> <span class="o">=</span> <span class="o">(</span><span class="nc">TextMessage</span><span class="o">)</span> <span class="n">message</span><span class="o">;</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"***æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯:   "</span> <span class="o">+</span> <span class="n">textMessage</span><span class="o">.</span><span class="na">getText</span><span class="o">());</span>
                        <span class="n">textMessage</span><span class="o">.</span><span class="na">acknowledge</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‡ºç°å¼‚å¸¸ï¼Œæ¶ˆè´¹å¤±è´¥ï¼Œæ”¾å¼ƒæ¶ˆè´¹"</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">});</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
        <span class="n">messageConsumer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">session</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">connection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<h3 id="æ¶ˆæ¯æ¶ˆè´¹çš„é‡è¯•æœºåˆ¶">æ¶ˆæ¯æ¶ˆè´¹çš„é‡è¯•æœºåˆ¶</h3>

<ul>
  <li>æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ï¼Œä¹‹åå‡ºç°å¼‚å¸¸äº†ï¼Œæ²¡æœ‰å‘Šè¯‰brokerç¡®è®¤æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œbrokerä¼šå°è¯•å†å°†è¯¥æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ã€‚å°è¯•næ¬¡ï¼Œå¦‚æœæ¶ˆè´¹è€…è¿˜æ˜¯æ²¡æœ‰ç¡®è®¤æ”¶åˆ°è¯¥æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å°†è¢«æ”¾åˆ°æ­»ä¿¡é˜Ÿåˆ—é‡ï¼Œä¹‹åbrokerä¸ä¼šå†å°†è¯¥æ¶ˆæ¯å‘é€ç»™æ¶ˆè´¹è€…ã€‚</li>
  <li>å“ªäº›æƒ…å†µä¼šå‘é€æ¶ˆæ¯é‡å‘
    <ul>
      <li>Clientç”¨äº†transactionsä¸”å†sessionä¸­è°ƒç”¨äº†rollback</li>
      <li>Clientç”¨äº†transactionsä¸”å†è°ƒç”¨commitä¹‹å‰å…³é—­æˆ–è€…æ²¡æœ‰commit</li>
      <li>Clientå†CLIENT_ACKNOWLEDGEçš„ä¼ é€’æ¨¡å¼ä¸‹ï¼Œsessionä¸­è°ƒç”¨äº†recover</li>
    </ul>
  </li>
  <li>è¯·è¯´è¯´æ¶ˆæ¯é‡å‘æ—¶é—´é—´éš”å’Œé‡å‘æ¬¡æ•°
é—´éš”ï¼š1
æ¬¡æ•°ï¼š6
 æ¯ç§’å‘6æ¬¡</li>
  <li>æœ‰æ¯’æ¶ˆæ¯Poison ACK
ä¸€ä¸ªæ¶ˆæ¯è¢«redelivedredè¶…è¿‡é»˜è®¤çš„æœ€å¤§é‡å‘æ¬¡æ•°ï¼ˆé»˜è®¤6æ¬¡ï¼‰æ—¶ï¼Œæ¶ˆè´¹çš„å›ä¸ªMQå‘ä¸€ä¸ªâ€œpoison ackâ€è¡¨ç¤ºè¿™ä¸ªæ¶ˆæ¯æœ‰æ¯’ï¼Œå‘Šè¯‰brokerä¸è¦å†å‘äº†ã€‚è¿™ä¸ªæ—¶å€™brokerä¼šæŠŠè¿™ä¸ªæ¶ˆæ¯æ”¾åˆ°DLQï¼ˆç§ä¿¡é˜Ÿåˆ—ï¼‰ã€‚</li>
</ul>

<h3 id="æ­»ä¿¡é˜Ÿåˆ—">æ­»ä¿¡é˜Ÿåˆ—</h3>

<ul>
  <li>æ­»ä¿¡é˜Ÿåˆ—ï¼šå¼‚å¸¸æ¶ˆæ¯è§„é¿å¤„ç†çš„é›†åˆï¼Œä¸»è¦å¤„ç†å¤±è´¥çš„æ¶ˆæ¯ã€‚å³ä¸€æ¡æ¶ˆæ¯åœ¨è¢«é‡å‘äº†å¤šæ¬¡åï¼ˆé»˜è®¤ä¸ºé‡å‘6æ¬¡ï¼ŒrediliveryCounter=6ï¼‰å°†ä¼šè¢«ç§»å…¥â€œæ­»ä¿¡é˜Ÿåˆ—â€ã€‚</li>
  <li>ä¸€èˆ¬ç”Ÿäº§ç¯å¢ƒä¸­ä¼šè®¾è®¡ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—</li>
  <li>ä¸ç®¡æ˜¯queueè¿˜æ˜¯topicï¼Œå¤±è´¥çš„æ¶ˆæ¯éƒ½æ”¾åˆ°è¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚ä¸‹é¢ä¿®æ”¹activemq.xmlçš„é…ç½®ï¼Œå¯ä»¥è¾¾åˆ°ä¿®æ”¹é˜Ÿåˆ—çš„åå­—ã€‚</li>
  <li>å¯ä»¥ä¸ºqueueå’Œtopicå•ç‹¬æŒ‡å®šä¸¤ä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚è¿˜å¯ä»¥ä¸ºæŸä¸ªè¯é¢˜ï¼Œå•ç‹¬æŒ‡å®šä¸€ä¸ªæ­»ä¿¡é˜Ÿåˆ—ã€‚</li>
</ul>

<h3 id="æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹å¹‚ç­‰æ€§">æ¶ˆæ¯ä¸è¢«é‡å¤æ¶ˆè´¹ï¼Œå¹‚ç­‰æ€§</h3>

<ul>
  <li>ç½‘ç»œå»¶è¿Ÿä¼ è¾“ä¸­ï¼Œä¼šé€ æˆè¿›è¡ŒMQé‡è¯•ï¼Œåœ¨é‡è¯•è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šé€ æˆé‡å¤æ¶ˆè´¹ã€‚</li>
  <li>å¦‚æœæ¶ˆæ¯æ˜¯åšæ•°æ®åº“çš„æ’å…¥æ“ä½œï¼Œç»™è¿™ä¸ªæ¶ˆæ¯åšä¸€ä¸ªå”¯ä¸€ä¸»é”®ï¼Œé‚£ä¹ˆå°±ç®—å‡ºç°é‡å¤æ¶ˆè´¹ï¼Œå°±ä¼šå¯¼è‡´ä¸»é”®å†²çªï¼Œé¿å…æ•°æ®åº“å‡ºç°è„æ•°æ®ã€‚</li>
  <li>è¿˜å¯ä»¥é‡‡ç”¨ç¬¬ä¸‰æ–¹æœåŠ¡æ¥åšæ¶ˆè´¹è®°å½•ï¼Œæ¯”å¦‚ç”¨redisç»™æ¶ˆæ¯åˆ†é…ä¸€ä¸ªå…¨å±€idï¼Œåªè¦æ¶ˆè´¹è¿‡è¯¥æ¶ˆæ¯ï¼Œå°†idå’Œmessageä»¥é”®å€¼å¯¹çš„å½¢å¼å†™å…¥redisï¼Œé‚£æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹å‰ï¼Œå…ˆå»redisä¸­æŸ¥è¯¢æœ‰æ— æ¶ˆè´¹è®°å½•å³å¯ã€‚</li>
</ul>
:ET