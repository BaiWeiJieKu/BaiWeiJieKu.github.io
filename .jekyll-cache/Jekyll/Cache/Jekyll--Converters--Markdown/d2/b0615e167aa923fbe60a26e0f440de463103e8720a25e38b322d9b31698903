I"4¾<ul id="markdown-toc">
  <li><a href="#åŸºæœ¬æ¦‚å¿µ" id="markdown-toc-åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</a>    <ul>
      <li><a href="#æ¶æ„" id="markdown-toc-æ¶æ„">æ¶æ„</a></li>
    </ul>
  </li>
  <li><a href="#ç™»å½•ç™»å‡º" id="markdown-toc-ç™»å½•ç™»å‡º">ç™»å½•ç™»å‡º</a>    <ul>
      <li><a href="#æ¡ˆä¾‹" id="markdown-toc-æ¡ˆä¾‹">æ¡ˆä¾‹</a></li>
      <li><a href="#æºç æµç¨‹" id="markdown-toc-æºç æµç¨‹">æºç æµç¨‹</a></li>
    </ul>
  </li>
  <li><a href="#è‡ªå®šä¹‰realm" id="markdown-toc-è‡ªå®šä¹‰realm">è‡ªå®šä¹‰realm</a>    <ul>
      <li><a href="#æ¡ˆä¾‹-1" id="markdown-toc-æ¡ˆä¾‹-1">æ¡ˆä¾‹</a></li>
      <li><a href="#realmå¯†ç åŠ å¯†" id="markdown-toc-realmå¯†ç åŠ å¯†">realmå¯†ç åŠ å¯†</a></li>
    </ul>
  </li>
  <li><a href="#ç”¨æˆ·æˆæƒ" id="markdown-toc-ç”¨æˆ·æˆæƒ">ç”¨æˆ·æˆæƒ</a>    <ul>
      <li><a href="#æˆæƒæ–¹å¼" id="markdown-toc-æˆæƒæ–¹å¼">æˆæƒæ–¹å¼</a></li>
      <li><a href="#æˆæƒæµç¨‹" id="markdown-toc-æˆæƒæµç¨‹">æˆæƒæµç¨‹</a></li>
      <li><a href="#æ£€æŸ¥è§’è‰²" id="markdown-toc-æ£€æŸ¥è§’è‰²">æ£€æŸ¥è§’è‰²</a></li>
    </ul>
  </li>
</ul>
<p><a href="https://yubuntu0109.github.io">å‚è€ƒè‡´è°¢</a></p>

<h3 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h3>

<ul>
  <li>Apache Shiroæ˜¯ä¸€ä¸ªå¼ºå¤§æ˜“ç”¨çš„Javaå®‰å…¨æ¡†æ¶,æä¾›äº†è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ç­‰åŠŸèƒ½ï¼Œå¯¹äºä»»ä½•ä¸€ä¸ªåº”ç”¨ç¨‹åº,Shiroéƒ½å¯ä»¥æä¾›å…¨é¢çš„å®‰å…¨ç®¡ç†æœåŠ¡</li>
  <li>æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>æˆæƒ</strong>ä¸¤ä¸ªéƒ¨åˆ†,ç®€ç§°è®¤è¯æˆæƒ</li>
  <li><strong>èº«ä»½è®¤è¯</strong> : ä¸ºåˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„è¿‡ç¨‹,æœ€å¸¸ç”¨çš„èº«ä»½è®¤è¯æ–¹å¼å°±æ˜¯ç³»ç»Ÿé€šè¿‡æ ¸å¯¹ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå£ä»¤,å°†å…¶ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„è¯¥ç”¨æˆ·ä¿¡æ¯ç›¸å¯¹æ¯”,ç»§è€Œæ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®</li>
  <li><strong>æˆæƒ</strong> : æ—¢è®¿é—®æƒé™,æ§åˆ¶ç”¨æˆ·è®¿é—®èµ„æºçš„æƒé™. ä¸»ä½“(subject)è¿›è¡Œèº«ä»½è®¤è¯åéœ€è¦åˆ†é…æƒé™æ–¹å¯è®¿é—®ç³»ç»Ÿçš„èµ„æº</li>
</ul>

<h4 id="æ¶æ„">æ¶æ„</h4>

<ul>
  <li>Shiroå¯ä»¥éå¸¸å®¹æ˜“çš„å¼€å‘å‡ºè¶³å¤Ÿå¥½çš„åº”ç”¨,å…¶ä¸ä»…å¯ä»¥ç”¨åœ¨JavaSEç¯å¢ƒ,ä¹Ÿå¯ä»¥ç”¨åœ¨JavaEEç¯å¢ƒ. Shiroå¯ä»¥å¸®åŠ©æˆ‘ä»¬å®Œæˆ : è®¤è¯ã€æˆæƒã€åŠ å¯†ã€ä¼šè¯ç®¡ç†ã€ä¸Webé›†æˆã€ç¼“å­˜ç­‰</li>
  <li><strong>Authentication</strong> : èº«ä»½è®¤è¯ / ç™»å½•,éªŒè¯ç”¨æˆ·æ˜¯ä¸æ˜¯æ‹¥æœ‰ç›¸åº”çš„èº«ä»½</li>
  <li><strong>Authorization</strong> : æˆæƒ,å³æƒé™éªŒè¯,éªŒè¯æŸä¸ªå·²è®¤è¯çš„ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªæƒé™. å³åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½åšäº‹æƒ…,å¸¸è§çš„å¦‚ : éªŒè¯æŸä¸ªç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªè§’è‰²,æˆ–è€…ç»†ç²’åº¦çš„éªŒè¯æŸä¸ªç”¨æˆ·å¯¹æŸä¸ªèµ„æºæ˜¯å¦å…·æœ‰æŸä¸ªæƒé™</li>
  <li><strong>Session Manager</strong> : ä¼šè¯ç®¡ç†,å³ç”¨æˆ·ç™»å½•åå°±æ˜¯ä¸€æ¬¡ä¼šè¯,åœ¨æ²¡æœ‰é€€å‡ºä¹‹å‰,å®ƒçš„æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨ä¼šè¯ä¸­. ä¼šè¯å¯ä»¥æ˜¯æ™®é€šJavaSEç¯å¢ƒçš„,ä¹Ÿå¯ä»¥æ˜¯å¦‚Webç¯å¢ƒçš„</li>
  <li><strong>SessionDAO</strong> : DAOå¤§å®¶éƒ½ç”¨è¿‡,æ•°æ®è®¿é—®å¯¹è±¡,ç”¨äºä¼šè¯çš„CRUD,æ¯”å¦‚æˆ‘ä»¬æƒ³æŠŠSessionä¿å­˜åˆ°æ•°æ®åº“,é‚£ä¹ˆå¯ä»¥å®ç°è‡ªå·±çš„ SessionDAO,é€šè¿‡å¦‚JDBCå†™åˆ°æ•°æ®åº“. æ¯”å¦‚æƒ³æŠŠSessionæ”¾åˆ°Memcachedä¸­,å¯ä»¥å®ç°è‡ªå·±çš„Memcached SessionDAO. å¦å¤–SessionDAOä¸­å¯ä»¥ä½¿ç”¨Cacheè¿›è¡Œç¼“å­˜,ä»¥æé«˜æ€§èƒ½</li>
  <li><strong>Cryptography</strong> : åŠ å¯†,ä¿æŠ¤æ•°æ®çš„å®‰å…¨æ€§,å¦‚å¯†ç åŠ å¯†å­˜å‚¨åˆ°æ•°æ®åº“,è€Œä¸æ˜¯æ˜æ–‡å­˜å‚¨</li>
  <li><strong>CacheManager</strong> : ç¼“å­˜æ§åˆ¶å™¨,æ¥ç®¡ç†å¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰çš„ç¼“å­˜çš„. å› ä¸ºè¿™äº›æ•°æ®åŸºæœ¬ä¸Šå¾ˆå°‘å»æ”¹å˜,æ”¾åˆ°ç¼“å­˜ä¸­åå¯ä»¥æé«˜è®¿é—®çš„æ€§èƒ½</li>
  <li><strong>Web Support</strong> : Webæ”¯æŒ,å¯ä»¥éå¸¸å®¹æ˜“çš„é›†æˆåˆ°Webç¯å¢ƒä¸­</li>
  <li><strong>Caching</strong> : ç¼“å­˜,æ¯”å¦‚ç”¨æˆ·ç™»å½•å,å…¶ç”¨æˆ·ä¿¡æ¯ã€æ‹¥æœ‰çš„è§’è‰² / æƒé™ä¸å¿…æ¯æ¬¡å»æŸ¥,è¿™æ ·å¯ä»¥æé«˜æ•ˆç‡</li>
  <li><strong>Concurrency</strong> : shiroæ”¯æŒå¤šçº¿ç¨‹åº”ç”¨çš„å¹¶å‘éªŒè¯,å³å¦‚åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¼€å¯å¦ä¸€ä¸ªçº¿ç¨‹,èƒ½æŠŠæƒé™è‡ªåŠ¨ä¼ æ’­è¿‡å»</li>
  <li><strong>Testing</strong> : æä¾›æµ‹è¯•æ”¯æŒ</li>
  <li><strong>Run As</strong> : å…è®¸ä¸€ä¸ªç”¨æˆ·å‡è£…ä¸ºå¦ä¸€ä¸ªç”¨æˆ·(åœ¨ä»–ä»¬å…è®¸çš„æƒ…å†µä¸‹)çš„èº«ä»½è¿›è¡Œè®¿é—®</li>
  <li><strong>Remember Me</strong> : è®°ä½æˆ‘,è¿™ä¸ªæ˜¯éå¸¸å¸¸è§çš„åŠŸèƒ½,å³ä¸€æ¬¡ç™»å½•å,ä¸‹æ¬¡ä¸ç”¨é‡å¤ç™»å½•äº†</li>
  <li>shiro APIå«ä¹‰ï¼š</li>
  <li><strong>Subject</strong> : ä¸»ä½“,ä»£è¡¨äº†å½“å‰â€ç”¨æˆ·â€,è¿™ä¸ªç”¨æˆ·ä¸ä¸€å®šæ˜¯ä¸€ä¸ªå…·ä½“çš„äºº,ä¸å½“å‰åº”ç”¨äº¤äº’çš„ä»»ä½•ä¸œè¥¿éƒ½æ˜¯Subject,å¦‚ç½‘ç»œçˆ¬è™«,æœºå™¨äººç­‰,å³ä¸ºä¸€ä¸ªæŠ½è±¡æ¦‚å¿µ. æ‰€æœ‰Subjectéƒ½ç»‘å®šåˆ°SecurityManager,ä¸Subjectçš„æ‰€æœ‰äº¤äº’éƒ½ä¼šå§”æ‰˜ç»™SecurityManager. å¯ä»¥æŠŠSubjectè®¤ä¸ºæ˜¯ä¸€ä¸ªé—¨é¢,SecurityManageræ‰æ˜¯å®é™…çš„æ‰§è¡Œè€…</li>
  <li><strong>SecurityManager</strong> : å®‰å…¨ç®¡ç†å™¨,å³æ‰€æœ‰ä¸å®‰å…¨æœ‰å…³çš„æ“ä½œéƒ½ä¼šä¸SecurityManageräº¤äº’,ä¸”å®ƒç®¡ç†ç€æ‰€æœ‰Subject. å¯ä»¥çœ‹å‡ºå®ƒæ˜¯Shiroçš„æ ¸å¿ƒ,å®ƒè´Ÿè´£ä¸åè¾¹ä»‹ç»çš„å…¶ä»–ç»„ä»¶è¿›è¡Œäº¤äº’,å¦‚æœå­¦ä¹ è¿‡SpringMVC,ä½ å¯ä»¥æŠŠå®ƒçœ‹æˆ<code class="language-plaintext highlighter-rouge">DispatcherServlet</code>å‰ç«¯æ§åˆ¶å™¨</li>
  <li><strong>Realm</strong> : åŸŸ,Shiroä»Realmè·å–å®‰å…¨æ•°æ®(å¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™),å°±æ˜¯è¯´SecurityManagerè¦éªŒè¯ç”¨æˆ·èº«ä»½,é‚£ä¹ˆå®ƒéœ€è¦ä»Realmè·å–ç›¸åº”çš„ç”¨æˆ·è¿›è¡Œæ¯”è¾ƒä»¥ç¡®å®šç”¨æˆ·èº«ä»½æ˜¯å¦åˆæ³•,ä¹Ÿéœ€è¦ä»Realmå¾—åˆ°ç”¨æˆ·ç›¸åº”çš„è§’è‰² / æƒé™è¿›è¡ŒéªŒè¯ç”¨æˆ·æ˜¯å¦èƒ½è¿›è¡Œæ“ä½œ. å¯ä»¥æŠŠRealmçœ‹æˆ DataSource,å³å®‰å…¨æ•°æ®æºã€‚æ³¨æ„ : Shiroä¸çŸ¥é“ä½ çš„ç”¨æˆ· / æƒé™å­˜å‚¨åœ¨å“ªåŠä»¥ä½•ç§æ ¼å¼å­˜å‚¨,æ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬åœ¨åº”ç”¨ä¸­éƒ½éœ€è¦å®ç°è‡ªå·±çš„Realm</li>
  <li>
    <p>Shiroä¸æä¾›ç»´æŠ¤ç”¨æˆ· / æƒé™,è€Œæ˜¯é€šè¿‡Realmè®©å¼€å‘äººå‘˜è‡ªå·±æ³¨å…¥å†…éƒ¨ç»“æ„</p>
  </li>
  <li>æœ€ç®€å•çš„ä¸€ä¸ªShiroåº”ç”¨å¯ä»¥åŸºæœ¬åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤ :
    <ul>
      <li>åº”ç”¨ä»£ç é€šè¿‡Subjectæ¥è¿›è¡Œè®¤è¯å’Œæˆæƒ,è€ŒSubjectåˆå°†æ‰€æœ‰çš„äº’äº¤éƒ½å§”æ‰˜ç»™äº†SecurityManager</li>
      <li>æˆ‘ä»¬éœ€è¦ç»™Shiroçš„SecurityManageræ³¨å…¥Realm,ä»è€Œè®©SecurityManagerèƒ½å¾—åˆ°åˆæ³•çš„ç”¨æˆ·åŠå…¶æƒé™è¿›è¡Œåˆ¤æ–­</li>
    </ul>
  </li>
  <li><strong>Authenticator</strong> : è®¤è¯å™¨,è´Ÿè´£ä¸»ä½“è®¤è¯çš„,è¿™æ˜¯ä¸€ä¸ªæ‰©å±•ç‚¹,å¦‚æœç”¨æˆ·è§‰å¾—Shiroé»˜è®¤çš„ä¸å¥½,å¯ä»¥è‡ªå®šä¹‰å®ç°. å…¶éœ€è¦è®¤è¯ç­–ç•¥(Authentication Strategy),å³ä»€ä¹ˆæƒ…å†µä¸‹ç®—ç”¨æˆ·è®¤è¯é€šè¿‡äº†</li>
  <li><strong>Authrizer</strong> : æˆæƒå™¨,æˆ–è€…è®¿é—®æ§åˆ¶å™¨,ç”¨æ¥å†³å®šä¸»ä½“æ˜¯å¦æœ‰æƒé™è¿›è¡Œç›¸åº”çš„æ“ä½œ,å³æ§åˆ¶ç€ç”¨æˆ·èƒ½è®¿é—®åº”ç”¨ä¸­çš„å“ªäº›åŠŸèƒ½</li>
</ul>

<h3 id="ç™»å½•ç™»å‡º">ç™»å½•ç™»å‡º</h3>

<ul>
  <li>åœ¨shiroä¸­,ç”¨æˆ·éœ€è¦æä¾›principals(èº«ä»½)å’Œcredentials(è¯æ˜)ç»™shiro,ç»§è€Œæ¥éªŒè¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯,æœ€å¸¸è§çš„princpalså’Œ credentialsç»„åˆå°±æ˜¯ç”¨æˆ·å / å¯†ç </li>
  <li><strong>principals</strong> : èº«ä»½,å³ä¸»ä½“çš„æ ‡è¯†å±æ€§,å¦‚ç”¨æˆ·åã€é‚®ç®±ç­‰,éœ€å”¯ä¸€. ä¸€ä¸ªä¸»ä½“å¯ä»¥æœ‰å¤šä¸ªprincipals,ä½†åªæœ‰ä¸€ä¸ªPrimary principals,ä¸€èˆ¬æ˜¯ç”¨æˆ·å / æ‰‹æœºå·</li>
  <li><strong>credentials</strong> : è¯æ˜ / å‡­è¯,å³åªæœ‰ä¸»ä½“çŸ¥é“çš„å®‰å…¨å€¼,å¦‚å¯†ç  / æ•°å­—è¯ä¹¦ç­‰</li>
</ul>

<h4 id="æ¡ˆä¾‹">æ¡ˆä¾‹</h4>

<ul>
  <li>mavenä¾èµ–</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="c">&lt;!--Junit å•å…ƒæµ‹è¯• --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Shiroæ ¸å¿ƒåŒ… --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- slf4jçš„æ¥å£å®ç° --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.7.12<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<ul>
  <li>shiroæ–‡ä»¶ï¼šshiro.ini(å­˜å‚¨ç”¨æˆ·èº«ä»½ä¿¡æ¯(è´¦æˆ·=å¯†ç ))ç›¸å½“äºä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºçš„è´¦å·å¯†ç </li>
</ul>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[users]</span>
<span class="py">root</span><span class="p">=</span><span class="s">yubuntu0109</span>
</code></pre></div></div>

<ul>
  <li>æµ‹è¯•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Shiroè®¤è¯æµ‹è¯•:éªŒè¯ç”¨æˆ·ç™»å½•ä¿¡æ¯
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ShiroTest</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testLogin</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">//1:åŠ è½½é…ç½®æ–‡ä»¶,åˆ›å»ºSecurityManagerå·¥å‚å¯¹è±¡</span>
        <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">SecurityManager</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IniSecurityManagerFactory</span><span class="o">(</span><span class="s">"classpath:shiro.ini"</span><span class="o">);</span>
        <span class="c1">//2:è·å¾—securityManagerå®ä¾‹å¯¹è±¡</span>
        <span class="nc">SecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="c1">//3:å°†securityMangerå®ä¾‹ç»‘å®šåˆ°å½“å‰è¿è¡Œç¯å¢ƒä¸­,ä¾¿äºè®¿é—®</span>
        <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
        <span class="c1">//4:åˆ›å»ºå½“å‰ç™»å½•çš„ä¸»ä½“</span>
        <span class="nc">Subject</span> <span class="n">currentUser</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="c1">//5:ç»‘å®šä¸»ä½“ç™»å½•çš„èº«ä»½/å‡­è¯,æ—¢è´¦æˆ·åŠå¯†ç ï¼ˆç›¸å½“äºä»å‰å°formè¡¨å•è·å–åˆ°çš„è´¦å·å¯†ç ï¼‰</span>
        <span class="nc">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordToken</span><span class="o">(</span><span class="s">"root"</span><span class="o">,</span> <span class="s">"yubuntu0109"</span><span class="o">);</span>
        <span class="c1">//6:ä¸»ä½“ç™»å½•</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">currentUser</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·èº«ä»½æ˜¯å¦éªŒè¯æˆåŠŸ :"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·è´¦æˆ·ä¿¡æ¯é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·å¯†ç ä¿¡æ¯é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//8:æ³¨é”€ç™»å½•</span>
        <span class="n">currentUser</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"èº«ä»½èº«ä»½æ˜¯å¦æ³¨é”€æˆåŠŸ :"</span> <span class="o">+</span> <span class="o">!</span><span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="æºç æµç¨‹">æºç æµç¨‹</h4>

<ul>
  <li>1ï¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">subject.login(AuthenticationToken token)</code>æ–¹æ³•è¿›è¡Œç”¨æˆ·ç™»å½•,å…¶ä¼šè‡ªåŠ¨å§”æ‰˜ç»™<code class="language-plaintext highlighter-rouge">securityManager.login(Subject subject, AuthenticationToken token)</code>æ–¹æ³•è¿›è¡Œç™»å½•</li>
  <li>2ï¼š<code class="language-plaintext highlighter-rouge">securityManager</code>(å®‰å…¨ç®¡ç†å™¨)é€šè¿‡<code class="language-plaintext highlighter-rouge">Authenticator</code>(è®¤è¯å™¨)è¿›è¡Œè®¤è¯</li>
  <li>3ï¼š<code class="language-plaintext highlighter-rouge">Authenticator</code>çš„å®ç°ç±»<code class="language-plaintext highlighter-rouge">ModularRealmAuthenticator</code>é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">realm</code>ä»<code class="language-plaintext highlighter-rouge">shiro.ini</code>é…ç½®æ–‡ä»¶ä¸­è·å–ç”¨æˆ·çœŸå®çš„ä¿¡æ¯(è´¦æˆ·å’Œå¯†ç ),è¿™é‡Œçš„Realm(åŸŸ)å¯ä»¥çœ‹æˆDataSource,å³å®‰å…¨æ•°æ®æº</li>
  <li>4ï¼š<code class="language-plaintext highlighter-rouge">IniRealm</code>(å¯é€šè¿‡åŠ è½½<code class="language-plaintext highlighter-rouge">.ini</code>æ–‡ä»¶ç”Ÿæˆreamlå¯¹è±¡)å…ˆæ ¹æ®<code class="language-plaintext highlighter-rouge">token</code>ä¸­çš„è´¦å·å»<code class="language-plaintext highlighter-rouge">shiro.ini</code>é…ç½®æ–‡ä»¶ä¸­å»åŒ¹é…è¯¥è´¦å·,å¦‚æœæ‰¾ä¸åˆ°åˆ™<code class="language-plaintext highlighter-rouge">ModularRealmAuthenticator</code>è¿”å›null,å¦‚æœæ‰¾åˆ°åˆ™ç»§ç»­åŒ¹é…å¯†ç ,è‹¥åŒ¹é…æˆåŠŸåˆ™è®¤è¯é€šè¿‡,åä¹‹ä¸é€šè¿‡</li>
  <li>5ï¼šæœ€åå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">Subject.logout()</code>è¿›è¡Œé€€å‡ºæ“ä½œ</li>
</ul>

<h3 id="è‡ªå®šä¹‰realm">è‡ªå®šä¹‰realm</h3>

<ul>
  <li><strong>Realm</strong> : åŸŸ,Shiroä»Realmè·å–å®‰å…¨æ•°æ®(å¦‚ç”¨æˆ·ã€è§’è‰²ã€æƒé™),å°±æ˜¯è¯´SecurityManagerè¦éªŒè¯ç”¨æˆ·èº«ä»½,é‚£ä¹ˆå®ƒéœ€è¦ä»Realmè·å–ç›¸åº”çš„ç”¨æˆ·è¿›è¡Œæ¯”è¾ƒä»¥ç¡®å®šç”¨æˆ·èº«ä»½æ˜¯å¦åˆæ³•. ä¹Ÿéœ€è¦ä»Realmå¾—åˆ°ç”¨æˆ·ç›¸åº”çš„è§’è‰² / æƒé™è¿›è¡ŒéªŒè¯ç”¨æˆ·æ˜¯å¦èƒ½è¿›è¡Œæ“ä½œ,å¯ä»¥æŠŠRealmçœ‹æˆ DataSource,å³å®‰å…¨æ•°æ®æº. å¦‚æˆ‘ä»¬ä¹‹å‰çš„inié…ç½®æ–¹å¼ä½¿ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">org.apache.shiro.realm.text.IniRealm</code>æ¥å£</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//org.apache.shiro.realm.Realmæ¥å£</span>
<span class="c1">//è¿”å›ä¸€ä¸ªå”¯ä¸€çš„Realmåå­—</span>
<span class="nc">String</span> <span class="nf">getName</span><span class="o">();</span> 
<span class="c1">//åˆ¤æ–­æ­¤Realmæ˜¯å¦æ”¯æŒæ­¤Token</span>
<span class="kt">boolean</span> <span class="nf">supports</span><span class="o">(</span><span class="nc">AuthenticationToken</span> <span class="n">token</span><span class="o">);</span> 
<span class="c1">//æ ¹æ®Tokenè·å–è®¤è¯ä¿¡æ¯</span>
<span class="nc">AuthenticationInfo</span> <span class="nf">getAuthenticationInfo</span><span class="o">(</span><span class="nc">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span><span class="o">;</span>
</code></pre></div></div>

<h4 id="æ¡ˆä¾‹-1">æ¡ˆä¾‹</h4>

<ul>
  <li>ä¾èµ–</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Shiroæ ¸å¿ƒåŒ… --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- slf4jçš„æ¥å£å®ç° --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.7.12<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<ul>
  <li>ä¿¡æ¯æ–‡ä»¶ï¼šshiro.ini</li>
</ul>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#è‡ªå®šä¹‰realm
</span><span class="py">myRealm</span> <span class="p">=</span> <span class="s">com.xxx.MyRealm</span>
<span class="c">#æŒ‡å®šSecurityManagerçš„realmså®ç°
</span><span class="py">securityManager.realm</span> <span class="p">=</span> <span class="s">$myRealm</span>
</code></pre></div></div>

<ul>
  <li>è‡ªå®šä¹‰realmï¼šMyRealm</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyRealm</span> <span class="kd">extends</span> <span class="nc">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"myRealm"</span><span class="o">;</span> <span class="c1">//åŒºåˆ†ä¸åŒçš„Realm</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//æˆæƒæ“ä½œ</span>
    <span class="kd">protected</span> <span class="nc">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="nc">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//è®¤è¯æ“ä½œ:å…¶tokenå­˜å‚¨ç€ä¼ å…¥çš„ç”¨æˆ·ç™»å½•ä¿¡æ¯(usernamePasswordToken)</span>
    <span class="kd">protected</span> <span class="nc">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="nc">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>

        <span class="c1">//è·å–å¹¶éªŒè¯ç”¨æˆ·è´¦å·ä¿¡æ¯(å‰ç«¯ä¼ å…¥)</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">)</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="c1">//ä¸æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒ</span>
        <span class="k">if</span> <span class="o">(!</span><span class="s">"root"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//å‡è®¾æ•°æ®åº“ä¸­ç”¨æˆ·å¯†ç ä¿¡æ¯</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"yubuntu0109"</span><span class="o">;</span>

        <span class="c1">//SimpleAuthenticationInfo(Object principal, Object credentials, String realmName)</span>
        <span class="nc">SimpleAuthenticationInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">getName</span><span class="o">());</span>
        <span class="k">return</span> <span class="n">info</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æµ‹è¯•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * æµ‹è¯•è‡ªå®šä¹‰realm
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">loginByMyRealm</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1:åŠ è½½é…ç½®æ–‡ä»¶,åˆ›å»ºSecurityManagerå·¥å‚å¯¹è±¡</span>
        <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">SecurityManager</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IniSecurityManagerFactory</span><span class="o">(</span><span class="s">"classpath:my-shiro.ini"</span><span class="o">);</span>
        <span class="c1">//2:è·å¾—securityManagerå®ä¾‹å¯¹è±¡</span>
        <span class="nc">SecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="c1">//3:å°†securityMangerå®ä¾‹ç»‘å®šåˆ°å½“å‰è¿è¡Œç¯å¢ƒä¸­,ä¾¿äºè®¿é—®</span>
        <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
        <span class="c1">//4:åˆ›å»ºå½“å‰ç™»å½•çš„ä¸»ä½“</span>
        <span class="nc">Subject</span> <span class="n">currentUser</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="c1">//5:ç»‘å®šä¸»ä½“ç™»å½•çš„èº«ä»½/å‡­è¯,æ—¢è´¦æˆ·åŠå¯†ç </span>
        <span class="nc">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordToken</span><span class="o">(</span><span class="s">"root"</span><span class="o">,</span> <span class="s">"yubuntu0109"</span><span class="o">);</span>
        <span class="c1">//6:ä¸»ä½“ç™»å½•</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">currentUser</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·èº«ä»½æ˜¯å¦éªŒè¯æˆåŠŸ :"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·è´¦æˆ·é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·å¯†ç é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//8:æ³¨é”€ç™»å½•</span>
        <span class="n">currentUser</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"èº«ä»½èº«ä»½æ˜¯å¦æ³¨é”€æˆåŠŸ :"</span> <span class="o">+</span> <span class="o">!</span><span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="realmå¯†ç åŠ å¯†">realmå¯†ç åŠ å¯†</h4>

<ul>
  <li>æ•£åˆ—ç®—æ³•ä¸€èˆ¬ç”¨äºç”Ÿæˆæ•°æ®çš„æ‘˜è¦ä¿¡æ¯,æ˜¯ä¸€ç§ä¸å¯é€†çš„ç®—æ³•,ä¸€èˆ¬é€‚åˆå­˜å‚¨å¯†ç ä¹‹ç±»çš„æ•°æ®,å¸¸è§çš„æ•£åˆ—ç®—æ³•å¦‚MD5ã€SHAç­‰.</li>
  <li>é€šè¿‡ä½¿ç”¨MD5åŠ å¯†è‡ªå®šä¹‰Realm,</li>
</ul>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[main]</span>
<span class="c">#å®šä¹‰å‡­è¯åŒ¹é…å™¨
</span><span class="py">credentialsMatcher</span> <span class="p">=</span> <span class="s">org.apache.shiro.authc.credential.HashedCredentialsMatcher</span>
<span class="c">#æ•£åˆ—ç®—æ³•
</span><span class="py">credentialsMatcher.hashAlgorithmName</span> <span class="p">=</span> <span class="s">md5</span>
<span class="c">#æ•£åˆ—æ¬¡æ•°
</span><span class="py">credentialsMatcher.hashIterations</span> <span class="p">=</span> <span class="s">10</span>
<span class="c">#å°†å‡­è¯åŒ¹é…å™¨è®¾ç½®åˆ°realm
</span><span class="py">myRealm</span> <span class="p">=</span> <span class="s">com.xxx.EncryRealm</span>
<span class="py">myRealm.credentialsMatcher</span> <span class="p">=</span> <span class="s">$credentialsMatcher</span>
<span class="py">securityManager.realms</span> <span class="p">=</span> <span class="s">$myRealm</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
*åŠ å¯†realm
*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EncryRealm</span> <span class="kd">extends</span> <span class="nc">AuthorizingRealm</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"myRealm"</span><span class="o">;</span> <span class="c1">//åŒºåˆ†ä¸åŒçš„Realm</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//æˆæƒæ“ä½œ</span>
    <span class="kd">protected</span> <span class="nc">AuthorizationInfo</span> <span class="nf">doGetAuthorizationInfo</span><span class="o">(</span><span class="nc">PrincipalCollection</span> <span class="n">principals</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="c1">//è®¤è¯æ“ä½œ</span>
    <span class="kd">protected</span> <span class="nc">AuthenticationInfo</span> <span class="nf">doGetAuthenticationInfo</span><span class="o">(</span><span class="nc">AuthenticationToken</span> <span class="n">token</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">AuthenticationException</span> <span class="o">{</span>

        <span class="c1">//è·å–ç”¨æˆ·è´¦æˆ·ä¿¡æ¯</span>
        <span class="nc">String</span> <span class="n">username</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="s">"root"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">username</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">//MD5åŠ å¯†åçš„ç”¨æˆ·å¯†ç ä¿¡æ¯</span>
        <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"f3005f7acf36cec973498845460b0c33"</span><span class="o">;</span><span class="c1">//password + username + 10</span>
        <span class="c1">//æŒ‡å®šç›å€¼:ByteSource.Util.bytes(username)</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleAuthenticationInfo</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="nc">ByteSource</span><span class="o">.</span><span class="na">Util</span><span class="o">.</span><span class="na">bytes</span><span class="o">(</span><span class="n">username</span><span class="o">),</span> <span class="n">getName</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="ç”¨æˆ·æˆæƒ">ç”¨æˆ·æˆæƒ</h3>

<ul>
  <li>æˆæƒ,ä¹Ÿå«è®¿é—®æ§åˆ¶,å³åœ¨åº”ç”¨ä¸­æ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æº(å¦‚è®¿é—®é¡µé¢/ç¼–è¾‘æ•°æ®/é¡µé¢æ“ä½œç­‰). åœ¨æˆæƒä¸­éœ€äº†è§£çš„å‡ ä¸ªå…³é”®å¯¹è±¡ : ä¸»ä½“(Subject)ã€èµ„æº(Resource)ã€æƒé™(Permission)ã€è§’è‰²(Role)</li>
  <li><strong>ä¸»ä½“</strong> : ä¸»ä½“,å³è®¿é—®åº”ç”¨çš„ç”¨æˆ·,åœ¨Shiroä¸­ä½¿ç”¨Subjectä»£è¡¨è¯¥ç”¨æˆ·. ç”¨æˆ·åªæœ‰æˆæƒåæ‰å…è®¸è®¿é—®ç›¸åº”çš„èµ„æº</li>
  <li><strong>èµ„æº</strong> : åœ¨åº”ç”¨ä¸­ç”¨æˆ·å¯ä»¥è®¿é—®çš„ä»»ä½•èµ„æº,æ¯”å¦‚è®¿é—®JSPé¡µé¢ã€æŸ¥çœ‹/ç¼–è¾‘æŸäº›æ•°æ®ã€è®¿é—®æŸä¸ªä¸šåŠ¡æ–¹æ³•ã€æ‰“å°æ–‡æœ¬ç­‰ç­‰..ç”¨æˆ·éœ€è¦æˆæƒåæ–¹å¯è®¿é—®</li>
  <li><strong>æƒé™</strong> : å®‰å…¨ç­–ç•¥ä¸­çš„åŸå­æˆæƒå•ä½,å¯ç”¨æƒé™æ§åˆ¶ç”¨æˆ·åœ¨åº”ç”¨ä¸­æ˜¯å¦èƒ½è®¿é—®æŸä¸ªèµ„æº,å¦‚è®¿é—®ç”¨æˆ·åˆ—è¡¨é¡µé¢,æŸ¥çœ‹/æ–°å¢/ä¿®æ”¹/åˆ é™¤ç”¨æˆ·æ•°æ®(åŸºæœ¬ä¸ºCRUDå¼æƒé™æ§åˆ¶)</li>
  <li><strong>è§’è‰²</strong> : è§’è‰²ä»£è¡¨äº†æ“ä½œé›†åˆ,å¯ä»¥ç†è§£ä¸ºæƒé™çš„é›†åˆ,ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šèµ‹äºˆç”¨æˆ·è§’è‰²è€Œä¸æ˜¯æƒé™,å³è¿™æ ·ç”¨æˆ·å¯ä»¥æ‹¥æœ‰ä¸€ç»„æƒé™,ä¸åŒçš„è§’è‰²æ‹¥æœ‰ä¸€ç»„ä¸åŒçš„æƒé™
    <ul>
      <li><strong>éšå¼è§’è‰²</strong> : å³ç›´æ¥é€šè¿‡è§’è‰²æ¥éªŒè¯ç”¨æˆ·æœ‰æ²¡æœ‰æ“ä½œæƒé™,å³ç²’åº¦æ˜¯ä»¥è§’è‰²ä¸ºå•ä½è¿›è¡Œè®¿é—®æ§åˆ¶çš„,ç²’åº¦è¾ƒç²—. è‹¥è¿›è¡Œå˜æ›´å¯èƒ½éœ€è¦å¤šå¤„ä»£ç çš„ä¿®æ”¹</li>
      <li><strong>æ˜¾ç¤ºè§’è‰²</strong> : åœ¨ç¨‹åºä¸­é€šè¿‡æƒé™æ§åˆ¶è°èƒ½è®¿é—®æŸä¸ªèµ„æº,è§’è‰²èšåˆä¸€ç»„æƒé™é›†åˆ. è¿™æ ·è‹¥éœ€è¦å“ªä¸ªè§’è‰²ä¸èƒ½è®¿é—®æŸä¸ªèµ„æº,åªéœ€è¦ä»è§’è‰²ä»£è¡¨çš„æƒé™é›†åˆä¸­ç§»é™¤æŒ‡å®šçš„è®¿é—®æƒé™å³å¯,æ— é¡»ä¿®æ”¹å¤šå¤„</li>
    </ul>
  </li>
</ul>

<h4 id="æˆæƒæ–¹å¼">æˆæƒæ–¹å¼</h4>

<ul>
  <li>ç¼–ç¨‹å¼ : é€šè¿‡å†™if/elseæˆæƒä»£ç å—å®Œæˆ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Subject</span> <span class="n">subject</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
<span class="k">if</span><span class="o">(</span><span class="n">subject</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"admin"</span><span class="o">))</span> <span class="o">{</span>
    <span class="c1">//æœ‰æƒé™</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="c1">//æ— æƒé™</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>æ³¨è§£å¼ : é€šè¿‡åœ¨æ‰§è¡Œçš„Javaæ–¹æ³•ä¸Šæ”¾ç½®ç›¸åº”çš„æ³¨è§£å®Œæˆ</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiresRoles</span><span class="o">(</span><span class="s">"admin"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">hello</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">//æœ‰æƒé™</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>JSP/GSP æ ‡ç­¾ : åœ¨JSP/GSPé¡µé¢é€šè¿‡ç›¸åº”çš„æ ‡ç­¾å®Œæˆ</li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;shiro:hasRole </span><span class="na">name=</span><span class="s">"admin"</span><span class="nt">&gt;</span>
<span class="nt">&lt;</span><span class="err">!â€”</span> <span class="na">æœ‰æƒé™</span> <span class="err">â€”</span><span class="nt">&gt;</span>
<span class="nt">&lt;/shiro:hasRole&gt;</span>
</code></pre></div></div>

<h4 id="æˆæƒæµç¨‹">æˆæƒæµç¨‹</h4>

<ul>
  <li>é¦–å…ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">Subject.isPermitted/hasRole</code>æ¥å£,å…¶ä¼šå§”æ‰˜ç»™SecurityManager,è€ŒSecurityManageræ¥ç€ä¼šå§”æ‰˜ç»™Authorizer</li>
  <li>Authorizeræ˜¯çœŸæ­£çš„æˆæƒè€…,å¦‚æœæˆ‘ä»¬è°ƒç”¨å¦‚<code class="language-plaintext highlighter-rouge">isPermitted(â€œuser:createâ€)</code>,å…¶é¦–å…ˆä¼šé€šè¿‡PermissionResolveræŠŠå­—ç¬¦ä¸²è½¬æ¢æˆç›¸åº”çš„Permissionå®ä¾‹</li>
  <li>åœ¨è¿›è¡Œæˆæƒä¹‹å‰,å…¶ä¼šè°ƒç”¨ç›¸åº”çš„Realmè·å–Subjectç›¸åº”çš„è§’è‰²/æƒé™ç”¨äºåŒ¹é…ä¼ å…¥çš„è§’è‰²/æƒé™</li>
  <li>Authorizerä¼šåˆ¤æ–­Realmçš„è§’è‰²/æƒé™æ˜¯å¦å’Œä¼ å…¥çš„åŒ¹é…,å¦‚æœæœ‰å¤šä¸ªRealm,åˆ™ä¼šå§”æ‰˜ç»™ModularRealmAuthorizerè¿›è¡Œå¾ªç¯åˆ¤æ–­,å¦‚æœåŒ¹é…å¦‚<code class="language-plaintext highlighter-rouge">isPermitted/hasRole</code>ä¼šè¿”å›true,å¦åˆ™è¿”å›falseä»¥è¡¨ç¤ºæˆæƒå¤±è´¥</li>
</ul>

<h4 id="æ£€æŸ¥è§’è‰²">æ£€æŸ¥è§’è‰²</h4>

<ul>
  <li>ä¾èµ–</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>4.11<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- Shiroæ ¸å¿ƒåŒ… --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.shiro<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>shiro-core<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.3.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- slf4jçš„æ¥å£å®ç° --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.slf4j<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>slf4j-log4j12<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.7.12<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
    <span class="c">&lt;!-- java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>commons-logging<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>commons-logging<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.2<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></div></div>

<ul>
  <li>é…ç½®ä¿¡æ¯ï¼šshiro.ini</li>
</ul>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#æƒé™è¡¨è¾¾å¼çš„å®šä¹‰:é¦–å…ˆæ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾è§’è‰²,å†æ ¹æ®è§’è‰²æŸ¥æ‰¾æƒé™,è§’è‰²æ˜¯æƒé™çš„é›†åˆ
</span>
<span class="nn">[users]</span>
<span class="c">#ç”¨æˆ·hunagyuhuiçš„å¯†ç ä¸ºloveyourself,ä¸”å…·æœ‰studentå’Œprogrammerä¸¤ä¸ªè§’è‰²
</span><span class="py">huangyuhui</span> <span class="p">=</span> <span class="s">loveyourself,student,programmer</span>

<span class="nn">[roles]</span>
<span class="c">#è§’è‰²studentå¯¹èµ„æº'user'æ‹¥æœ‰create,updateæƒé™
</span><span class="py">student</span> <span class="p">=</span> <span class="s">user:create,user:update</span>
<span class="c">#è§’è‰²programmerå¯¹èµ„æº'user'read,deleteæƒé™
</span><span class="py">programmer</span> <span class="p">=</span> <span class="s">user:read,user:delete</span>
</code></pre></div></div>

<ul>
  <li>æµ‹è¯•</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">RolesTest</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1:åŠ è½½é…ç½®æ–‡ä»¶,åˆ›å»ºSecurityManagerå·¥å‚å¯¹è±¡</span>
        <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">SecurityManager</span><span class="o">&gt;</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IniSecurityManagerFactory</span><span class="o">(</span><span class="s">"classpath:per-shiro.ini"</span><span class="o">);</span>
        <span class="c1">//2:è·å¾—securityManagerå®ä¾‹å¯¹è±¡</span>
        <span class="nc">SecurityManager</span> <span class="n">securityManager</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
        <span class="c1">//3:å°†securityMangerå®ä¾‹ç»‘å®šåˆ°å½“å‰è¿è¡Œç¯å¢ƒä¸­,ä¾¿äºè®¿é—®</span>
        <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">setSecurityManager</span><span class="o">(</span><span class="n">securityManager</span><span class="o">);</span>
        <span class="c1">//4:åˆ›å»ºå½“å‰ç™»å½•çš„ä¸»ä½“</span>
        <span class="nc">Subject</span> <span class="n">currentUser</span> <span class="o">=</span> <span class="nc">SecurityUtils</span><span class="o">.</span><span class="na">getSubject</span><span class="o">();</span>
        <span class="c1">//5:ç»‘å®šä¸»ä½“ç™»å½•çš„èº«ä»½/å‡­è¯,æ—¢è´¦æˆ·åŠå¯†ç </span>
        <span class="nc">UsernamePasswordToken</span> <span class="n">token</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">UsernamePasswordToken</span><span class="o">(</span><span class="s">"huangyuhui"</span><span class="o">,</span> <span class="s">"loveyourself"</span><span class="o">);</span>
        <span class="c1">//6:ä¸»ä½“ç™»å½•</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">currentUser</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="n">token</span><span class="o">);</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·èº«ä»½æ˜¯å¦éªŒè¯æˆåŠŸ :"</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>
            <span class="c1">//7:è¿›è¡Œç”¨æˆ·è§’è‰²åˆ¤æ–­</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰'student'è§’è‰² : "</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">hasRole</span><span class="o">(</span><span class="s">"student"</span><span class="o">));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦åŒæ—¶æ‹¥æœ‰'student'ä¸'programmer'è§’è‰² : "</span> <span class="o">+</span> <span class="n">currentUser</span><span class="o">.</span><span class="na">hasAllRoles</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"student"</span><span class="o">,</span> <span class="s">"programmer"</span><span class="o">)));</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰'student','programmer','singer'è§’è‰² : "</span> <span class="o">+</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">currentUser</span><span class="o">.</span><span class="na">hasRoles</span><span class="o">(</span><span class="nc">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"student"</span><span class="o">,</span> <span class="s">"programmer"</span><span class="o">,</span> <span class="s">"singer"</span><span class="o">))));</span>
            <span class="c1">//åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰æŸä¸ªè§’è‰²,è‹¥æ‹¥æœ‰è¯¥è§’è‰²åˆ™ä¸åšä»»ä½•æ“ä½œ(æ— è¿”å›å€¼),åä¹‹åˆ™æŠ›å‡º:UnauthorizedException</span>
            <span class="n">currentUser</span><span class="o">.</span><span class="na">checkRole</span><span class="o">(</span><span class="s">"singer"</span><span class="o">);</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnknownAccountException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·è´¦æˆ·é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IncorrectCredentialsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·å¯†ç é”™è¯¯ !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">UnauthorizedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·å¹¶ä¸æ‹¥æœ‰'singer'è§’è‰² !"</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">AuthenticationException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="c1">//8:æ³¨é”€ç™»å½•</span>
        <span class="n">currentUser</span><span class="o">.</span><span class="na">logout</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ³¨é”€æˆåŠŸ :"</span> <span class="o">+</span> <span class="o">!</span><span class="n">currentUser</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>
<span class="cm">/*
// Â·Â·Â·Â·Â·Â·
ç”¨æˆ·èº«ä»½æ˜¯å¦éªŒè¯æˆåŠŸ :true
// Â·Â·Â·Â·Â·Â·
åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰'student'è§’è‰² : true
// Â·Â·Â·Â·Â·Â·
åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦åŒæ—¶æ‹¥æœ‰'student'ä¸'programmer'è§’è‰² : true
// Â·Â·Â·Â·Â·Â·
åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰'student','programmer','singer'è§’è‰² : [true, true, false]
// Â·Â·Â·Â·Â·Â·
ç”¨æˆ·å¹¶ä¸æ‹¥æœ‰'singer'è§’è‰² !
// Â·Â·Â·Â·Â·Â·
ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ³¨é”€æˆåŠŸ :true
*/</span>
</code></pre></div></div>
:ET