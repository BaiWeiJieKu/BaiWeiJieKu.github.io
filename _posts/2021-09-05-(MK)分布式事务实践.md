---
layout: post
title: "MK-分布式事务实践"
categories: 事务
tags: 事务
author: 百味皆苦
music-id: 2602106546
---

* content
{:toc}
### 简介

- 数据一致性问题
  - 数据的并发访问，修改
  - 不同请求之间的数据隔离
  - 多个服务共同完成一个业务请求，保证都完成或失败
  - 发生异常时的数据回滚



### 事务原则与实现

- A：原子性
- C：一致性
- I：隔离性
- D：持久性



### spring事务机制

- 事务抽象，事务传播，事务隔离
- spring事务抽象
  - PlatformTransactionManager
  - TransactionDefinition
  - TransactionStatus
- PlatformTransactionManager的常见实现
  - DataSourceTransactionManager
  - JpaTransactionManager
  - JmsTransactionManager
  - JtaTransactionManager



#### Jpa事务实例

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-trans-jpa</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-trans-jpa</name>
  	<description>Demo project for Spring JPA transaction</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-data-jpa</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>com.h2database</groupId>
  			<artifactId>h2</artifactId>
  			<scope>runtime</scope>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- dao

- ```java
  public interface CustomerRepository extends JpaRepository<Customer, Long> {
      Customer findOneByUsername(String username);
  }
  ```

- service

- ```java
  //注解方式
  @Service
  public class CustomerServiceTxInAnnotation {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInAnnotation.class);
  
      @Autowired
      private CustomerRepository customerRepository;
  
      @Transactional
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Annotation create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          customer.setUsername("Annotation:" + customer.getUsername());
          return customerRepository.save(customer);
      }
  }
  
  //代码方式
  @Service
  public class CustomerServiceTxInCode {
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInCode.class);
  
      @Autowired
      private CustomerRepository customerRepository;
      @Autowired
      private PlatformTransactionManager transactionManager;
  
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Code create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          DefaultTransactionDefinition def = new DefaultTransactionDefinition();
          def.setIsolationLevel(TransactionDefinition.ISOLATION_SERIALIZABLE);
          def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
          def.setTimeout(15);
          TransactionStatus status = transactionManager.getTransaction(def);
          try {
              customer.setUsername("Code:" + customer.getUsername());
              customerRepository.save(customer);
              transactionManager.commit(status);
              return customer;
          } catch (Exception e) {
              transactionManager.rollback(status);
              throw e;
          }
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
      private static final Logger LOG = LoggerFactory.getLogger(CustomerResource.class);
  
      @Autowired
      private CustomerServiceTxInAnnotation customerService;
      @Autowired
      private CustomerServiceTxInCode customerServiceInCode;
      @Autowired
      private CustomerRepository customerRepository;
  
      @PostMapping("/annotation")
      public Customer createInAnnotation(@RequestBody Customer customer) {
          LOG.info("CustomerResource create in annotation create customer:{}", customer.getUsername());
          return customerService.create(customer);
      }
  
      @PostMapping("/code")
      public Customer createInCode(@RequestBody Customer customer) {
          LOG.info("CustomerResource create in code create customer:{}", customer.getUsername());
          return customerServiceInCode.create(customer);
      }
  
      @GetMapping("")
      public List<Customer> getAll() {
          return customerRepository.findAll();
      }
  
  }
  ```



#### Jms事务实例

- session原生事务

- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/163084616206524_Copy_24.png)

- JmsTransactionManager事务

- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/163084620640225_Copy_25.png)

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-trans-jms</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-trans-jms</name>
  	<description>Demo project for Spring JMS transaction</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-activemq</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- config

- ```java
  @EnableJms
  @Configuration
  public class JmsConfig {
      private static final Logger LOG = LoggerFactory.getLogger(CustomerService.class);
  
      @Bean
      public JmsTemplate initJmsTemplate(ConnectionFactory connectionFactory) {
          LOG.debug("init jms template with converter.");
          JmsTemplate template = new JmsTemplate();
          template.setConnectionFactory(connectionFactory); // JmsTemplate使用的connectionFactory跟JmsTransactionManager使用的必须是同一个，不能在这里封装成caching之类的。
          return template;
      }
  
      // 这个用于设置 @JmsListener使用的containerFactory
      @Bean
      public JmsListenerContainerFactory<?> msgFactory(ConnectionFactory connectionFactory,
                                                       DefaultJmsListenerContainerFactoryConfigurer configurer,
                                                       PlatformTransactionManager transactionManager) {
          DefaultJmsListenerContainerFactory factory = new DefaultJmsListenerContainerFactory();
          factory.setTransactionManager(transactionManager);
          factory.setCacheLevelName("CACHE_CONNECTION");
          factory.setReceiveTimeout(10000L);
          configurer.configure(factory, connectionFactory);
          return factory;
      }
  
      @Bean
      public PlatformTransactionManager transactionManager(ConnectionFactory connectionFactory) {
          return new JmsTransactionManager(connectionFactory);
      }
  
  }
  ```

- service

- ```java
  @Service
  public class CustomerService {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerService.class);
  
      @Autowired
      JmsTemplate jmsTemplate;
      @Autowired
      private PlatformTransactionManager transactionManager;
  
      @PostConstruct
      public void init() {
          jmsTemplate.setReceiveTimeout(3000);
      }
  
      @JmsListener(destination = "customer:msg:new", containerFactory = "msgFactory")
      public void handle(String msg) {
          LOG.debug("Get JMS message to from customer:{}", msg);
          String reply = "Replied - " + msg;
          jmsTemplate.convertAndSend("customer:msg:reply", reply);
          if (msg.contains("error")) {
              simulateError();
          }
      }
  
      @JmsListener(destination = "customer:msg2:new", containerFactory = "msgFactory")
      public void handle2(String msg) {
          LOG.debug("Get JMS message2 to from customer:{}", msg);
          DefaultTransactionDefinition def = new DefaultTransactionDefinition();
          def.setTimeout(15);
          TransactionStatus status = transactionManager.getTransaction(def);
          try {
              String reply = "Replied-2 - " + msg;
              jmsTemplate.convertAndSend("customer:msg:reply", reply);
              if (!msg.contains("error")) {
                  transactionManager.commit(status);
              } else {
                  transactionManager.rollback(status);
              }
          } catch (Exception e) {
              transactionManager.rollback(status);
              throw e;
          }
      }
  
      private void simulateError() {
          throw new RuntimeException("some Data error.");
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
  
      @Autowired
      JmsTemplate jmsTemplate;
      @Autowired
      private CustomerService customerService;
  
      @PostMapping("/message1/listen")
      public void createMsgWithListener(@RequestParam String msg) {
          jmsTemplate.convertAndSend("customer:msg:new", msg);
      }
      @PostMapping("/message1/direct")
      public void createMsgDirect(@RequestParam String msg) {
          customerService.handle(msg);
      }
  
      @PostMapping("/message2/listen")
      public void createMsg2WithListener(@RequestParam String msg) {
          jmsTemplate.convertAndSend("customer:msg2:new", msg);
      }
      @PostMapping("/message2/direct")
      public void createMsg2Direct(@RequestParam String msg) {
          customerService.handle2(msg);
      }
  
      @GetMapping("/message")
      public String getMsg() {
          Object reply = jmsTemplate.receiveAndConvert("customer:msg:reply");
          return String.valueOf(reply);
      }
  }
  ```



#### Jta分布式事务实例

- 本地事务
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/163084788223328_Copy_28.png)
- 外部全局事务
  - 外部事务管理器提供事务管理
  - 通过spring事务接口，调用外部管理器
  - 使用JNDI等方式获取外部事务管理器的实例
  - 外部事务管理器一般由应用服务器提供，如Jboss等
  - 外部事务管理器提供JTA事务管理
  - JTA事务管理器可以管理多个数据资源
  - 通过2阶段提交实现多数据源事务
- ![image-20210907221517324](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/image-20210907221517324.png)
- JTA事务管理的弊端
  - 两阶段提交
  - 事务实践太长，锁数据的实践太长
  - 低性能，低吞吐量
- 不使用JTA实现多数据源的事务管理
  - spring事务同步机制
  - 多个数据源上实现近似事务一致性
  - 高性能，高吞吐量



##### 单数据源

- 使用spring JTA事务管理
- Atomikos外部事务管理器提供JTA事务管理
- 使用一个数据库-单数据源

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-trans-jta</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-trans-jta</name>
  	<description>Demo project for Spring JTA transaction</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-data-jpa</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-jta-atomikos</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>com.h2database</groupId>
  			<artifactId>h2</artifactId>
  			<scope>runtime</scope>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- dao

- ```java
  public interface CustomerRepository extends JpaRepository<Customer, Long> {
      Customer findOneByUsername(String username);
  }
  ```

- service

- ```java
  //注解方式
  @Service
  public class CustomerServiceTxInAnnotation {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInAnnotation.class);
  
      @Autowired
      private CustomerRepository customerRepository;
  
      @Transactional
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Annotation create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          customer.setUsername("Annotation:" + customer.getUsername());
          return customerRepository.save(customer);
      }
  }
  
  
  //代码方式
  @Service
  public class CustomerServiceTxInCode {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInCode.class);
  
      @Autowired
      private CustomerRepository customerRepository;
      @Autowired
      private PlatformTransactionManager transactionManager;
  
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Code create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          DefaultTransactionDefinition def = new DefaultTransactionDefinition();
  //        def.setIsolationLevel(TransactionDefinition.ISOLATION_SERIALIZABLE);
          def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
          def.setTimeout(15);
          TransactionStatus status = transactionManager.getTransaction(def);
          try {
              customer.setUsername("Code:" + customer.getUsername());
              customerRepository.save(customer);
              transactionManager.commit(status);
              return customer;
          } catch (Exception e) {
              transactionManager.rollback(status);
              throw e;
          }
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
      private static final Logger LOG = LoggerFactory.getLogger(CustomerResource.class);
  
      @Autowired
      private CustomerServiceTxInAnnotation customerService;
      @Autowired
      private CustomerServiceTxInCode customerServiceInCode;
      @Autowired
      private CustomerRepository customerRepository;
  
      @PostMapping("/annotation")
      public Customer createInAnnotation(@RequestBody Customer customer) {
          LOG.info("CustomerResource create in annotation create customer:{}", customer.getUsername());
          return customerService.create(customer);
      }
  
      @PostMapping("/code")
      public Customer createInCode(@RequestBody Customer customer) {
          LOG.info("CustomerResource create in code create customer:{}", customer.getUsername());
          return customerServiceInCode.create(customer);
      }
  
      @GetMapping("")
      public List<Customer> getAll() {
          return customerRepository.findAll();
      }
  
  }
  ```





##### 多数据源

- 多个数据源：DB，MQ

- pom

- ```xml
  <dependencies>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-activemq</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-data-jpa</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-jta-atomikos</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>com.h2database</groupId>
  			<artifactId>h2</artifactId>
  			<scope>runtime</scope>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  ```

- service

- ```java
  //注解方式
  @Service
  public class CustomerServiceTxInAnnotation {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInAnnotation.class);
  
      @Autowired
      private CustomerRepository customerRepository;
      @Autowired
      private JmsTemplate jmsTemplate;
  
      @Transactional
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Annotation create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          customer.setUsername("Annotation:" + customer.getUsername());
          jmsTemplate.convertAndSend("customer:msg:reply", customer.getUsername() + " created.");
          return customerRepository.save(customer);
      }
  
      @Transactional
      @JmsListener(destination = "customer:msg:new")
      public Customer createByListener(String name) {
          LOG.info("CustomerService In Annotation by Listener create customer:{}", name);
          Customer customer = new Customer();
          customer.setUsername("Annotation:" + name);
          customer.setRole("USER");
          customer.setPassword("111111");
  
          jmsTemplate.convertAndSend("customer:msg:reply", customer.getUsername() + " created.");
          return customerRepository.save(customer);
      }
  
  }
  
  
  //代码方式
  @Service
  public class CustomerServiceTxInCode {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerServiceTxInCode.class);
  
      @Autowired
      private CustomerRepository customerRepository;
      @Autowired
      private PlatformTransactionManager transactionManager;
      @Autowired
      private JmsTemplate jmsTemplate;
  
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Code create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          DefaultTransactionDefinition def = new DefaultTransactionDefinition();
          def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
          def.setTimeout(15);
          TransactionStatus status = transactionManager.getTransaction(def);
          try {
              customer.setUsername("Code:" + customer.getUsername());
              customerRepository.save(customer);
              jmsTemplate.convertAndSend("customer:msg:reply", customer.getUsername() + " created.");
              transactionManager.commit(status);
              return customer;
          } catch (Exception e) {
              transactionManager.rollback(status);
              throw e;
          }
      }
  
      @JmsListener(destination = "customer:msg2:new")
      public void createByListener(String name) {
          LOG.info("CustomerService In Code by Listener create customer:{}", name);
          Customer customer = new Customer();
          customer.setUsername("Code:" + name);
          customer.setRole("USER");
          customer.setPassword("111111");
  
          DefaultTransactionDefinition def = new DefaultTransactionDefinition();
          def.setPropagationBehavior(TransactionDefinition.PROPAGATION_REQUIRED);
          def.setTimeout(15);
          TransactionStatus status = transactionManager.getTransaction(def);
          try {
              customerRepository.save(customer);
              jmsTemplate.convertAndSend("customer:msg:reply", customer.getUsername() + " created.");
              transactionManager.commit(status);
          } catch (Exception e) {
              transactionManager.rollback(status);
              throw e;
          }
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
  
      @Autowired
      JmsTemplate jmsTemplate;
  
      @Autowired
      private CustomerServiceTxInAnnotation customerService;
      @Autowired
      private CustomerServiceTxInCode customerServiceInCode;
      @Autowired
      private CustomerRepository customerRepository;
  
      @PostMapping("/annotation")
      public Customer createInAnnotation(@RequestBody Customer customer) {
          return customerService.create(customer);
      }
  
      @PostMapping("/code")
      public Customer createInCode(@RequestBody Customer customer) {
          return customerServiceInCode.create(customer);
      }
  
      @Transactional
      @PostMapping("/message/annotation")
      public void createMsgWithListener(@RequestParam String userName) {
          jmsTemplate.convertAndSend("customer:msg:new", userName);
      }
  
      @Transactional
      @PostMapping("/message/code")
      public void createMsgDirect(@RequestParam String userName) {
          jmsTemplate.convertAndSend("customer:msg2:new", userName);
      }
  
      @GetMapping("")
      public List<Customer> getAll() {
          return customerRepository.findAll();
      }
  
  }
  ```





### 模式和技术

- JTA实现多服务的分布式事务
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/16311060470851_Copy_1.png)
- 不使用JTA，消息驱动的分布式事务
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/16311063516922_Copy_2.png)
- 如何选择
  - 强一致性事务：JTA性能最差，只适用于单个服务内
  - 弱，最终一致性事务：最大努力一次提交，链式事务（设计相应的错误处理机制）
  - MQ-DB：最大努力一次提交+重试
  - 多个DB：链式事务管理
  - 多个数据源：链式事务，或其他事务同步方式
- 实现模式
  - 消息驱动模式：Message Driven
  - 事件溯源模式：Event Sourcing
  - TCC模式：Try-Confirm-Cancel
- 幂等性
  - 幂等操作：任意多次执行所产生的影响，与一次执行的影响相同
  - 方法的幂等性：使用同样的参数调用一个方法多次，与调用一次结果相同
  - 接口的幂等性：接口被重复调用，结果一致
- 微服务接口的幂等性
  - 重要性：经常需要通过重试实现分布式事务的最终一致性
  - get方法不会对系统产生副作用，具有幂等性
  - post，put，delete方法的实现需要满足幂等性

![image-20210908222708151](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/image-20210908222708151.png)

- 分布式系统唯一性id：guid
  - 分布式系统的全局唯一标识
  - uuid：生成唯一id的规范
  - 用于唯一标识，处理重复消息
  - 数据库自增序列
  - uuid：唯一id标准，128位，几种版本
  - mongodb的objectId：时间戳+机器id+进程id+序号
  - redis的incr操作，zookeeper节点的版本号
- 使用哪种方式
  - 自增id：考虑安全性，部署
  - 时间有序：便于通过id判断创建时间
  - 长度，是否数字类型：是否建立索引
- 分布式系统分布式对象
  - redis：redission库：rlock，rmap，rqueue等对象
  - zookeeper：netfilx curator库：lock，queue等对象



#### 实例1：DatasourceTransactionManager

- MySQL+MySQL

- 链式事务：DatasourceTransactionManager

- 不处理重试

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-dtx-db-db</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-dtx-db-db</name>
  	<description>Demo project for Spring distributed transaction for DB-DB</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-jdbc</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>com.zaxxer</groupId>
  			<artifactId>HikariCP</artifactId>
  			<version>2.7.8</version>
  		</dependency>
  		<dependency>
  			<groupId>mysql</groupId>
  			<artifactId>mysql-connector-java</artifactId>
  			<version>5.1.39</version>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
          <dependency>
              <groupId>org.springframework.data</groupId>
              <artifactId>spring-data-commons</artifactId>
              <version>1.13.7.RELEASE</version>
          </dependency>
      </dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- yml

- ```properties
  
  # 默认的Datasource配置
  # spring.datasource.url = jdbc:mysql://localhost:3307/imooc_user
  # spring.datasource.username = root
  # spring.datasource.password = 123456
  # spring.datasource.driverClassName=com.mysql.jdbc.Driver
  
  spring.ds_user.url = jdbc:mysql://localhost:3306/imooc_user
  spring.ds_user.username = root
  spring.ds_user.password = 123456
  spring.ds_user.driver-class-name = com.mysql.jdbc.Driver
  
  spring.ds_order.url=jdbc:mysql://localhost:3307/imooc_order
  spring.ds_order.username=root
  spring.ds_order.password=123456
  spring.ds_order.driver-class-name=com.mysql.jdbc.Driver
  ```

- service

- ```java
  @Service
  public class CustomerService {
  
      @Autowired
      @Qualifier("userJdbcTemplate")
      private JdbcTemplate userJdbcTemplate;
  
      @Autowired
      @Qualifier("orderJdbcTemplate")
      private JdbcTemplate orderJdbcTemplate;
  
      private static final String SQL_UPDATE_DEPOSIT = "UPDATE customer SET deposit = deposit - ? where id = ?";
      private static final String SQL_CREATE_ORDER = "INSERT INTO customer_order (customer_id, title, amount) VALUES (?, ?, ?)";
  
      @Transactional
      public void createOrder(Order order) {
          userJdbcTemplate.update(SQL_UPDATE_DEPOSIT, order.getAmount(), order.getCustomerId());
          if (order.getTitle().contains("error1")) {
              throw new RuntimeException("Error1");
          }
          orderJdbcTemplate.update(SQL_CREATE_ORDER, order.getCustomerId(), order.getTitle(), order.getAmount());
          if (order.getTitle().contains("error2")) {
              throw new RuntimeException("Error2");
          }
      }
  
  
      public Map userInfo(Long customerId) {
          Map customer = userJdbcTemplate.queryForMap("SELECT * from customer where id = " + customerId);
          List orders = orderJdbcTemplate.queryForList("SELECT * from customer_order where customer_id = " + customerId);
  
          Map result = new HashMap();
          result.put("customer", customer);
          result.put("orders", orders);
          return result;
      }
  
  }
  
  ```

- config

- ```java
  @Configuration
  public class DBConfiguration {
  
      @Bean
      @Primary //默认使用这个DataSourceProperties
      @ConfigurationProperties(prefix = "spring.ds_user")
      public DataSourceProperties userDataSourceProperties() {
          return new DataSourceProperties();
      }
  
      @Bean
      @Primary
      public DataSource userDataSource() {
          return userDataSourceProperties().initializeDataSourceBuilder().type(HikariDataSource.class).build();
      }
  
      //链式事务管理器，把两个事务管理器连接起来
      @Bean
      public PlatformTransactionManager transactionManager() {
          DataSourceTransactionManager userTM = new DataSourceTransactionManager(userDataSource());
          PlatformTransactionManager orderTM = new DataSourceTransactionManager(orderDataSource());
          ChainedTransactionManager tm = new ChainedTransactionManager(userTM, orderTM);
          return tm;
      }
  
      @Bean
      public JdbcTemplate userJdbcTemplate(@Qualifier("userDataSource") DataSource userDataSource) {
          return new JdbcTemplate(userDataSource);
      }
  
      @Bean
      @ConfigurationProperties(prefix = "spring.ds_order")
      public DataSourceProperties orderDataSourceProperties() {
          return new DataSourceProperties();
      }
  
      @Bean
      public DataSource orderDataSource() {
          return orderDataSourceProperties().initializeDataSourceBuilder().type(HikariDataSource.class).build();
      }
  
      @Bean
      public JdbcTemplate orderJdbcTemplate(@Qualifier("orderDataSource") DataSource orderDataSource) {
          return new JdbcTemplate(orderDataSource);
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
  
      @Autowired
      private CustomerService customerService;
  
      @PostMapping("/order")
      public void create(@RequestBody Order order) {
          customerService.createOrder(order);
      }
  
      @GetMapping("/{id}")
      public Map userInfo(@PathVariable Long id) {
          return customerService.userInfo(id);
      }
  
  }
  
  ```



#### 实例2：JpaTransactionManager

- MySQL+MySQL

- 链式事务：JpaTransactionManager

- 不处理重试

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-dtx-jpa-db</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-dtx-jpa-db</name>
  	<description>Demo project for Spring distributed transaction for DB-DB</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-data-jpa</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>mysql</groupId>
  			<artifactId>mysql-connector-java</artifactId>
  			<version>5.1.39</version>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- service

- ```java
  @Service
  public class CustomerService {
  
      @Autowired
      private CustomerRepository customerRepository;
  
      @Autowired
      @Qualifier("orderJdbcTemplate")
      private JdbcTemplate orderJdbcTemplate;
  
      private static final String SQL_CREATE_ORDER = "INSERT INTO customer_order (customer_id, title, amount) VALUES (?, ?, ?)";
  
      @Transactional
      public void createOrder(Order order) {
          Customer customer = customerRepository.findOne(order.getCustomerId());
          customer.setDeposit(customer.getDeposit() - order.getAmount());
          customerRepository.save(customer);
          if (order.getTitle().contains("error1")) {
              throw new RuntimeException("Error1");
          }
          orderJdbcTemplate.update(SQL_CREATE_ORDER, order.getCustomerId(), order.getTitle(), order.getAmount());
  
          if (order.getTitle().contains("error2")) {
              throw new RuntimeException("Error2");
          }
      }
  
  
      public Map userInfo(Long customerId) {
          Customer customer = customerRepository.findOne(customerId);
          List orders = orderJdbcTemplate.queryForList("SELECT * from customer_order where customer_id = " + customerId);
  
          Map result = new HashMap();
          result.put("customer", customer);
          result.put("orders", orders);
          return result;
      }
  
  }
  ```

- config

- ```java
  @Configuration
  public class DBConfiguration {
  
      @Bean(name = "userDataSource")
      @Primary
      @ConfigurationProperties(prefix = "spring.ds_user")
      public DataSource userDataSource() {
          return DataSourceBuilder.create().build();
      }
  
      @Bean(name = "orderDataSource")
      public DataSource orderDataSource() {
          return DataSourceBuilder.create().build();
      }
  
      @Bean
      public JdbcTemplate orderJdbcTemplate(@Qualifier("orderDataSource") DataSource orderDataSource) {
          return new JdbcTemplate(orderDataSource);
      }
  
      @Bean
      public LocalContainerEntityManagerFactoryBean entityManagerFactory() {
          HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
          vendorAdapter.setGenerateDdl(false); // we have already created tables.
  
          LocalContainerEntityManagerFactoryBean factory = new LocalContainerEntityManagerFactoryBean();
          factory.setJpaVendorAdapter(vendorAdapter);
          factory.setPackagesToScan("com.imooc.example");
          factory.setDataSource(userDataSource());
          return factory;
      }
  
      //链式事务管理器
      @Bean
      public PlatformTransactionManager transactionManager() {
          JpaTransactionManager userTM = new JpaTransactionManager();
          userTM.setEntityManagerFactory(entityManagerFactory().getObject());
          PlatformTransactionManager orderTM = new DataSourceTransactionManager(orderDataSource());
          ChainedTransactionManager tm = new ChainedTransactionManager(userTM, orderTM);
          return tm;
      }
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
  
      @Autowired
      private CustomerService customerService;
  
      @PostMapping("/order")
      public void create(@RequestBody Order order) {
          customerService.createOrder(order);
      }
  
      @GetMapping("/{id}")
      public Map userInfo(@PathVariable Long id) {
          return customerService.userInfo(id);
      }
  
  }
  ```



#### 实例3：activeMQ+MySQL

- JMS-DB

- activeMQ+MySQL

- 最大努力一次提交：TransactionAwareConnectionFactoryProxy

- pom

- ```xml
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  	<modelVersion>4.0.0</modelVersion>
  
  	<groupId>com.imooc.example</groupId>
  	<artifactId>spring-dtx-jms-db</artifactId>
  	<version>0.0.1-SNAPSHOT</version>
  	<packaging>jar</packaging>
  
  	<name>spring-dtx-jms-db</name>
  	<description>Demo project for Spring distributed transaction for DB and MQ resources.</description>
  
  	<parent>
  		<groupId>org.springframework.boot</groupId>
  		<artifactId>spring-boot-starter-parent</artifactId>
  		<version>1.5.9.RELEASE</version>
  		<relativePath/> <!-- lookup parent from repository -->
  	</parent>
  
  	<properties>
  		<project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  		<project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
  		<java.version>1.8</java.version>
  	</properties>
  
  	<dependencies>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-activemq</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-data-jpa</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-web</artifactId>
  		</dependency>
  		<dependency>
  			<groupId>mysql</groupId>
  			<artifactId>mysql-connector-java</artifactId>
  			<version>5.1.39</version>
  		</dependency>
  
  		<dependency>
  			<groupId>org.springframework.boot</groupId>
  			<artifactId>spring-boot-starter-test</artifactId>
  			<scope>test</scope>
  		</dependency>
  	</dependencies>
  
  	<build>
  		<plugins>
  			<plugin>
  				<groupId>org.springframework.boot</groupId>
  				<artifactId>spring-boot-maven-plugin</artifactId>
  			</plugin>
  		</plugins>
  	</build>
  
  
  </project>
  
  ```

- yaml

- ```properties
  
  spring.datasource.url = jdbc:mysql://localhost:3306/imooc_user
  spring.datasource.username = root
  spring.datasource.password = 123456
  spring.datasource.driverClassName=com.mysql.jdbc.Driver
  
  spring.activemq.broker-url = tcp://localhost:61616
  ```

- service

- ```java
  @Service
  public class CustomerService {
  
      private static final Logger LOG = LoggerFactory.getLogger(CustomerService.class);
  
      @Autowired
      private CustomerRepository customerRepository;
      @Autowired
      private JmsTemplate jmsTemplate;
  
      @Transactional
      @JmsListener(destination = "customer:msg:new")
      public void handle(String msg) {
          LOG.info("Get msg1:{}", msg);
          Customer customer = new Customer();
          customer.setUsername(msg);
          customer.setDeposit(100);
          customerRepository.save(customer);
          if (msg.contains("error1")) {
              throw new RuntimeException("Error1");
          }
  
          jmsTemplate.convertAndSend("customer:msg:reply", msg + " created.");
          if (msg.contains("error2")) {
              throw new RuntimeException("Error2");
          }
      }
  
      @Transactional
      public Customer create(Customer customer) {
          LOG.info("CustomerService In Annotation create customer:{}", customer.getUsername());
          if (customer.getId() != null) {
              throw new RuntimeException("用户已经存在");
          }
          customer.setUsername("Annotation:" + customer.getUsername());
          customer = customerRepository.save(customer);
          if (customer.getUsername().contains("error1")) {
              throw new RuntimeException("Error1");
          }
          jmsTemplate.convertAndSend("customer:msg:reply", customer.getUsername() + " created.");
          if (customer.getUsername().contains("error2")) {
              throw new RuntimeException("Error2");
          }
  
          return customer;
      }
  
  }
  ```

- config

- ```java
  @Configuration
  public class JmsConfiguration {
  
      @Bean
      public JmsTemplate initJmsTemplate(ConnectionFactory connectionFactory) {
          JmsTemplate template = new JmsTemplate();
          template.setConnectionFactory(connectionFactory);
          template.setSessionTransacted(true);
          return template;
      }
  
      //把JMS事务同步到JPA事务上
      @Bean
      public ConnectionFactory connectionFactory() {
          ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory("tcp://localhost:61616");
          TransactionAwareConnectionFactoryProxy proxy = new TransactionAwareConnectionFactoryProxy();
          proxy.setTargetConnectionFactory(cf);
          proxy.setSynchedLocalTransactionAllowed(true);
          return proxy;
      }
  
  }
  ```

- web

- ```java
  @RestController
  @RequestMapping("/api/customer")
  public class CustomerResource {
  
      @Autowired
      JmsTemplate jmsTemplate;
  
      @Autowired
      private CustomerService customerService;
  
      @Autowired
      private CustomerRepository customerRepository;
  
      //通过jpa创建
      @PostMapping("/annotation")
      public Customer createInAnnotation(@RequestBody Customer customer) {
          return customerService.create(customer);
      }
  
      //通过activeMQ创建
      @PostMapping("/msg")
      public void create(@RequestBody Customer customer) {
          jmsTemplate.convertAndSend("customer:msg:new", customer.getUsername());
      }
  
  
      @GetMapping("")
      public List<Customer> getAll() {
          return customerRepository.findAll();
      }
  
      @GetMapping("/msg")
      public String getMsg() {
          jmsTemplate.setReceiveTimeout(3000);
          Object reply = jmsTemplate.receiveAndConvert("customer:msg:reply");
          return String.valueOf(reply);
      }
  
  }
  ```





### 消息驱动模型

- 消息驱动模型
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/16311940006211_Copy_1.png)
- 注意
  - 消息中间件需要支持事务
  - 如果处理重试的消息
  - 发生业务异常时回滚操作
- 系统错误的处理
  - 方法1：将出错未处理的消息写到失败队列，进行相应回滚操作
  - 方法2：通过定时任务检查超时订单，对未完成的订单做自动回滚
  - 方法3：保存出错消息，人工处理



#### 卖票实例

- order服务，user服务，ticket服务
- activeMQ作为消息中间件
- 错误处理：定时任务检查超时并回滚
- 幂等性：实现方法的幂等性
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/16311943608125_Copy_5.png)
- 流程
- ![image-20210909225053250](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/image-20210909225053250.png)
- ![img](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/163119462783710_Copy_10.png)
- 失败场景
- ![image-20210909225307575](https://gitee.com/shanyuanjushi/picgo_images/raw/master/images/image-20210909225307575.png)
- 异常订单处理
  - 定时处理异常订单：1未被处理完成 2未被按失败订单处理
  - 解锁票，撤销交票
  - 对于余额之类的重要数据，可能使用人工处理
- 实现锁票的安全性
  - 利用@JmsListener设置一个消费者，不适用于多实例
  - 使用事务和数据库锁的特性
  - 分布式锁
- 
