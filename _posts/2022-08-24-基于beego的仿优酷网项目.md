---
layout: post
title: "基于beego的仿优酷网项目"
categories: golang基础
tags: golang
author: 百味皆苦
music-id: 3136952023
---

* content
{:toc}

## Beego框架特性

1. 简单化

   > RESTful 支持、MVC 模型，可以使用 bee 工具快速地开发应用，包括监控代码修改进行热编译、自动化测试代码以及自动化打包部署。

2. 智能化

   > 支持智能路由、智能监控，可以监控 QPS、内存消耗、CPU 使用，以及 goroutine 的运行状况，让您的线上应用尽在掌握。

3. 模块化

   > beego 内置了强大的模块，包括 Session、缓存操作、日志记录、配置解析、性能监控、上下文操作、ORM 模块、请求模拟等强大的模块，足以支撑你任何的应用。

4. 高性能

   > beego 采用了 Go 原生的 http 包来处理请求，goroutine 的并发效率足以应付大流量的 Web 应用和 API 应用，目前已经应用于大量高并发的产品中。

Beego官方网址 [beego.me](https://beego.me/)



## 环境搭建

**GOROOT**

> Go的安装目录

**GOPATH**

> 工作目录，目录下包含bin，pkg，src三个文件夹，src是存放go源代码的，编写的项目都在这个文件夹下；pkg是存放编译好的库文件的；bin文件夹是存放编译后的可执行文件的。

***注意：GOPATH不要配置成GO的安装目录,会引起混乱***

**安装步骤**

1. 下载Go安装文件，解压到相关目录

   > 下载地址 [studygolang.com/dl](https://studygolang.com/dl)

2. 配置GOROOT、GOPATH、PATH

   ```javascript
    export GOROOT=/usr/local/go
    export GOPATH=/Users/goRoot:/Users/go
    export PATH=/usr/local/go/bin:/Users/goRoot/bin:$PATH
   ```

3. 测试，打印版本号`go version`



Beego和bee的安装比较简单

```javascript
    go get -u github.com/astaxie/beego
    go get -u github.com/beego/bee
```

为了更加方便的操作，请将 $GOPATH/bin 加入到你的 $PATH 变量中。请确保在此之前您已经添加了 $GOPATH 变量

测试是否成功

```javascript
    bee version
```

Beego和bee [官方安装教程](https://beego.me/quickstart)



### bee的主要命令

1. bee new

   > 新建一个 Web 项目

2. bee api

   > 创建 API 应用的，和 Web 项目相比，少了 static 和 views 目录，多了一个 test 模块，用来做单元测试的

3. bee run

   > 监控 beego 的项目

4. bee pack

   > 发布应用的时候打包，会把项目打包成 zip 包，这样我们部署的时候直接把打包之后的项目上传，解压就可以部署

5. 注意：bee pack -be GOOS=linux

   > MAC下打的包是不能再linux执行的，需要制定参数



### 创建项目

进入 $GOPATH/src 所在的目录：

```javascript
    ➜  src  bee new quickstart
[INFO] Creating application...
/gopath/src/quickstart/
/gopath/src/quickstart/conf/
/gopath/src/quickstart/controllers/
/gopath/src/quickstart/models/
/gopath/src/quickstart/routers/
/gopath/src/quickstart/tests/
/gopath/src/quickstart/static/
/gopath/src/quickstart/static/js/
/gopath/src/quickstart/static/css/
/gopath/src/quickstart/static/img/
/gopath/src/quickstart/views/
/gopath/src/quickstart/conf/app.conf
/gopath/src/quickstart/controllers/default.go
/gopath/src/quickstart/views/index.tpl
/gopath/src/quickstart/routers/router.go
/gopath/src/quickstart/tests/default_test.go
/gopath/src/quickstart/main.go
2014/11/06 18:17:09 [SUCC] New application successfully created!
```

通过一个简单的命令就创建了一个 beego 项目。他的目录结构如下所示

```javascript
quickstart
|-- conf
|   `-- app.conf
|-- controllers
|   `-- default.go
|-- main.go
|-- models
|-- routers
|   `-- router.go
|-- static
|   |-- css
|   |-- img
|   `-- js
|-- tests
|   `-- default_test.go
`-- views
    `-- index.tpl
```

main.go 是入口文件



### 路由和MVC

**路由设置**

有两种方式：

1. 在router.go中配置

   > beego.Router("/hello", &controllers.MainController{}, "get:GetHello")

2. 在router.go中include引入，直接在函数上方配置规则

   > beego.Include(&controllers.DemoController{})
   >
   > ```javascript
   >  // @router /demo/hello [get]
   >  func (this *DemoController) GetHello() {
   >      var (
   >          title string
   >      )
   >      title = "Hello World!"
   >      this.Ctx.WriteString(title)
   >  }
   > ```

**MVC模式**

在目录下有 controllers models views 文件夹分别存放controller文件，model文件和模板文件。后面项目中用到的文件都会分别在这三个文件夹中



### 过滤器和配置文件

**过滤器，为什么有过滤器呢？**

比如，进行安全验证，访问用户中心的时候，进行是否登录的判断可以在过滤器中，也可以实现屏蔽IP的功能，屏蔽黑名单的功能等等，对项目有整体的规则时，都可以在过滤器中实现，不用在每个函数中来实现了

过滤器是通过beego.insertfilter函数来实现的

在router文件中

```javascript
    beego.InsertFilter("/demo/*", beego.BeforeRouter, FilterDemo)

    var FilterDemo = func(ctx *context.Context) {
        var (
            title string
        )
        title = "禁止访问"
        ctx.WriteString(title)
    }
```

这里是屏蔽规则，包含demo/的url都走过滤规则；第二个参数是BeforeRouter，在寻找路由之前；第三个参数是函数名。

**配置信息**

beego提供了专门配置文件，配置信息定义在conf文件夹中的app.conf

```javascript
    appname = fyouku //项目名称
    httpport = 8098  //访问端口号
    runmode = dev    //运行环境，下面会根据运行环境加载不同配置

    [dev]
    apiurl = http://127.0.0.1:8099
    microApi = http://127.0.0.1:8085

    [prod]
    apiurl = http://127.0.0.1:8099
    microApi = http://127.0.0.1:8085
```

**静态文件**

项目中的css、js、img文件都是怎样访问的，bee new创建的项目中有static文件夹，这是beego默认注册的静态文件处理目录

```javascript
├── static
    │   ├── css
    │   ├── img
    │   └── js
```

访问地址为：http://127.0.0.1:8080/static/js/fyouku.js

也可以通过下面命令来自定义目录

```javascript
beego.SetStaticPath("/down1", "download1")
```



### view语法

1. 统一使用 作为左右标签
2. 使用 . 来访问当前位置的上下文
3. 使用 $ 来引用当前模板根级的上下文
4. 使用 $var 来访问创建的变量

**判断语句 if ... else ... end**

```javascript
{{if eq .IsEmail 1}}
    <a class="email" href="mailto:{{.Email}}">{{.Email}}</a>
{{else}}
    <a class="email" href="#">不允许访问Email</a>
{{end}}
```

**eq / ne / lt / le / gt / ge**

```javascript
eq: arg1 == arg2

ne: arg1 != arg2

lt: arg1 < arg2

le: arg1 <= arg2

gt: arg1 > arg2

ge: arg1 >= arg2
```

**循环语句 range**

```javascript
{{range $index,$value := .Pages}}
    {{$index}} - {{$value.Num}} of {{$.Website}}
    <br>
{{end}}
```

**载入其它模板**

```javascript
{{template "head.html" .}}
```





### 数据库ORM使用

**什么是orm?**

在关系型数据库和对象之间作一个映射，在操作数据库时，不需要写复杂的SQL语句，只需要像操作对象一样。

**第一步 安装**

```javascript
go get github.com/astaxie/beego/orm
go get github.com/go-sql-driver/mysql
```

**第二步 配置数据库信息，加载信息**

app.conf中增加配置信息

```javascript
[dev]
defaultdb = root:123456@tcp(127.0.0.1:3306)/fyouku?charset=utf8
```

main.go中加载信息

```go
    import (
    "github.com/astaxie/beego/orm"
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    //获取配置文件中信息
    defaultdb := beego.AppConfig.String("defaultdb")
    orm.RegisterDriver("mysql", orm.DRMySQL)
    orm.RegisterDataBase("default", "mysql", defaultdb, 30, 30)

    beego.Run()
}
```

注意：ORM 必须注册一个别名为 default 的数据库，作为默认使用

**第三步 model中使用**

```go
    package models

    import (
        "github.com/astaxie/beego/orm"
    )
    //定义type
    type Advert struct {
        Id       int
        Title    string
        SubTitle string
        AddTime  int64
        Img      string
        Url      string
    }

    func init() {
        //注册model
        orm.RegisterModel(new(Advert))
    }

    func GetChannelAdvert(channelId int) (int64, []Advert, error) {
        //使用前先new一下
        o := orm.NewOrm()
        var adverts []Advert
        num, err := o.Raw("SELECT id, title, sub_title,img,add_time,url FROM advert WHERE status=1 AND channel_id=? ORDER BY sort DESC LIMIT 1", channelId).QueryRows(&adverts)
        return num, adverts, err
    }
```





增删改查

```go
package models

import (
    //引入orm
    "github.com/astaxie/beego/orm"
)

//操作数据库都需要定义struct和表结构对应
type User struct {
    Id      int
    Name    string
    AddTime int64
    Status  int
    Mobile  string
    Avatar  string
}

//初始化注册对应model
func init() {
    orm.RegisterModel(new(User))
}

//获取用户信息
func UserInfo(id int) (User, error) {
    //通过orm中的Read函数获取
    var (
        err error
    )
    o := orm.NewOrm()
    user := User{Id: id}
    err = o.Read(&user)
    return user, err
}

//保存用户
func Save(name string, mobile string, avatar string) error {
    //通过orm中的Insert来保存
    var (
        err  error
        user User
    )
    o := orm.NewOrm()
    //设置字段的值
    user.Name = name
    user.Mobile = mobile
    user.Avatar = avatar
    user.Status = 0
    _, err = o.Insert(&user)
    return err
}

//更新用户名
func UpdateUsername(id int, name string) error {
    //通过orm中的Update来保存
    var (
        user User
        err  error
    )
    o := orm.NewOrm()
    //先判断数据是否存在
    user = User{Id: id}
    if o.Read(&user) == nil {
        //存在更新姓名
        user.Name = name
        _, err = o.Update(&user)
    }
    return err
}

//删除用户，通过ID删除数据
func Delete(id int) error {
    //通过orm中的Delete来保存
    var (
        user User
        err  error
    )
    o := orm.NewOrm()
    user = User{Id: id}
    _, err = o.Delete(&user)
    return err
}

//获取用户列表
func List() ([]User, error) {
    var (
        users []User
        err   error
    )
    o := orm.NewOrm()
    //声明操作的表
    qs := o.QueryTable("user")
    //条件id大于10
    qs = qs.Filter("id__gt", 10)
    //返回几条数据
    qs = qs.Limit(2)
    //倒序是前面加上负号
    qs = qs.OrderBy("-id")
    //后面是设置返回的字段
    qs.All(&users, "Id", "Name")
    return users, err

}

//从这往下是通过原生sql操作数据库
//QueryRow 获取单条数据使用
//QueryRows 获取多条数据使用
//Exec  执行insert\update\delete语句
//通过sql获取用户信息
func SqlUserInfo(id int) (User, error) {
    var (
        user User
        err  error
    )
    o := orm.NewOrm()
    err = o.Raw("SELECT `name`,`mobile` FROM user Where id=? LIMIT 1", id).QueryRow(&user)
    return user, err
}

//通过sql保存用户
func SqlSave(name string, mobile string, avatar string) error {
    var (
        err error
    )
    o := orm.NewOrm()
    _, err = o.Raw("INSERT INTO user (`name`, `mobile`, `avatar`, `status`) VALUES (?, ?, ?, ?)", name, mobile, avatar, 0).Exec()
    return err
}

//原生sql修改用户名
func SqlUpdateUsername(id int, name string) error {
    var (
        err error
    )
    o := orm.NewOrm()
    _, err = o.Raw("UPDATE user SET name=? WHERE id=?", name, id).Exec()
    return err
}

//原生sql删除用户
func SqlDelete(id int) error {
    o := orm.NewOrm()
    _, err := o.Raw("DELETE FROM user WHERE id=?", id).Exec()
    return err
}

//原生sql实现获取用户列表
func SqlList() (int64, []User, error) {
    var (
        users []User
    )
    o := orm.NewOrm()
    num, err := o.Raw("SELECT * FROM user WHERE id>? ORDER BY id DESC LIMIT 2", 10).QueryRows(&users)
    return num, users, err
}
```



入口demo.go

```go
package controllers
 
import (
    "demo/models"
 
    "github.com/astaxie/beego"
)
 
type DemoController struct {
    beego.Controller
}
 
//输出Hello World!
// @router /demo/hello [get]
func (this *DemoController) GetHello() {
    var (
        title string
    )
    title = "Hello World!"
    this.Ctx.WriteString(title)
}
 
//通过id获取用户名
// @router /user/username [get]
func (this *DemoController) GetUsername() {
    var (
        id    int
        err   error
        title string
        user  models.User
    )
    //接受浏览器中的参数
    id, err = this.GetInt("id")
    user, err = models.UserInfo(id)
    if err == nil {
        title = user.Name
    } else {
        title = "抱歉，服务器走丢了"
    }
    this.Ctx.WriteString(title)
}
 
//实现用户注册功能
// @router /user/save [get]
func (this *DemoController) Save() {
    var (
        name   string
        mobile string
        avatar string
        err    error
        title  string
    )
    name = this.GetString("name")
    mobile = this.GetString("mobile")
    avatar = this.GetString("avatar")
    err = models.Save(name, mobile, avatar)
    if err == nil {
        title = "恭喜，保存成功了"
    } else {
        title = "抱歉，服务器又走丢了"
    }
    this.Ctx.WriteString(title)
}
 
//实现修改用户名
// @router /user/update [get]
func (this *DemoController) UpdateUsername() {
    var (
        id    int
        name  string
        title string
        err   error
    )
    id, err = this.GetInt("id")
    name = this.GetString("name")
    err = models.UpdateUsername(id, name)
    if err == nil {
        title = "恭喜，名字修改成功了"
    } else {
        title = "抱歉，服务器又走丢了"
    }
    this.Ctx.WriteString(title)
}
 
//删除用户
// @router /user/delete [get]
func (this *DemoController) Delete() {
    var (
        id    int
        err   error
        title string
    )
    id, err = this.GetInt("id")
 
    err = models.Delete(id)
    if err == nil {
        title = "恭喜，您成功的把自己删除了"
    } else {
        title = "抱歉，服务器怎么又走丢了"
    }
    this.Ctx.WriteString(title)
}
 
//获取用户列表
// @router /user/list [get]
func (this *DemoController) List() {
    var (
        err   error
        title string
        users []models.User
    )
    users, err = models.List()
    if err == nil {
        for _, v := range users {
            title += v.Name + ","
        }
    } else {
        title = "抱歉，一个人也没有了"
    }
    this.Ctx.WriteString(title)
}
 
//通过原生sql方式获取用户信息
// @router /sql/user/userinfo [get]
func (this *DemoController) SqlUserInfo() {
    var (
        id    int
        err   error
        title string
        user  models.User
    )
    id, err = this.GetInt("id")
    user, err = models.SqlUserInfo(id)
    if err == nil {
        title = "用户名：" + user.Name + "，手机号：" + user.Mobile
    } else {
        title = "抱歉，没有这个人"
    }
    this.Ctx.WriteString(title)
}
 
//通过原生sql保存用户
// @router /sql/user/save [get]
func (this *DemoController) SqlSave() {
    var (
        err    error
        title  string
        name   string
        mobile string
        avatar string
    )
    name = this.GetString("name")
    mobile = this.GetString("mobile")
    avatar = this.GetString("avatar")
    err = models.SqlSave(name, mobile, avatar)
    if err == nil {
        title = "保存成功了"
    } else {
        title = "抱歉，服务器走丢了"
    }
    this.Ctx.WriteString(title)
}
 
//原生sql修改用户名
// @router /sql/user/updatename [get]
func (this *DemoController) SqlUpdateUsername() {
    var (
        err   error
        title string
        id    int
        name  string
    )
    id, err = this.GetInt("id")
    name = this.GetString("name")
    err = models.SqlUpdateUsername(id, name)
    if err == nil {
        title = "恭喜，您把自己的名字改了"
    } else {
        title = "抱歉，服务器又丢了~"
    }
    this.Ctx.WriteString(title)
}
 
//通过原生sql删除用户
// @router /sql/user/delete [get]
func (this *DemoController) SqlDelete() {
    var (
        id    int
        err   error
        title string
    )
    id, err = this.GetInt("id")
    err = models.SqlDelete(id)
    if err == nil {
        title = "恭喜，您成功把自己删除了"
    } else {
        title = "抱歉，删除错误，请联系客服"
    }
    this.Ctx.WriteString(title)
}
 
//原生sql获取用户列表
// @router /sql/user/list [get]
func (this *DemoController) SqlList() {
    var (
        err   error
        title string
        users []models.User
    )
    _, users, err = models.SqlList()
    if err == nil {
        for _, v := range users {
            title += v.Name + ","
        }
    } else {
        title = "没有相关信息"
    }
    this.Ctx.WriteString(title)
}
```

