---
layout: post
title: "开发爬坑记录"
categories: 手记
tags: 手记
author: 百味皆苦
music-id: 2602106546
---

* content
{:toc}
### 工具类中无法注入mapper

- 因为一般情况下工具类是不归spring容器管理的，这时候使用@Autowired注解去注入mapper是不管用的
- 使用@PostConstruct注解声明一个初始化方法
- 声明一个本工具类的静态变量
- 在初始化方法中初始化mapper

```java
public class MysqlDateUtils {
	@Autowired
	private SysUserMapper sysUserMapper;
	private static MysqlDateUtils mysqlDateUtils; 
	
	@PostConstruct  
    public void init() {  
		mysqlDateUtils = this;  
		mysqlDateUtils.sysUserMapper = this.sysUserMapper;  
    }
	
	/**
	 * 获取数据库当前的年月日（yyyy-MM-dd HH:mm:ss）
	 * @return Date
	 */
	public static String getMysqlNowDate() {
		
		return parseMysqlDateToStr("yyyy-MM-dd",mysqlDateUtils.sysUserMapper.getMysqlNowDate());
	}
    /**
	 * 获取数据库当前的年月日时分秒（yyyy-MM-dd HH:mm:ss）
	 * @return DateTime
	 */
	public static String getMysqlNowDateTime() {
		return parseMysqlDateToStr("yyyy-MM-dd HH:mm:ss",mysqlDateUtils.sysUserMapper.getMysqlNowDate());
	}
	
	public static final String parseMysqlDateToStr(final String format, final Date date)
    {
        return new SimpleDateFormat(format).format(date);
    }
```

### 使用java8拼接单日排班模板信息

- 从数据库中查询到的原始数据

```json
[{
    auto_id = 1,
    admStart = 06: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 院级模板,
    maintain_id = 1,
    amsStart = 06: 00,
    admEnd = 07: 00: 00,
    classes_name = 上午,
    source_number = 10,
    amsEnd = 11: 00
}, {
    auto_id = 2,
    admStart = 14: 05: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 院级模板,
    maintain_id = 1,
    amsStart = 15: 30,
    admEnd = 15: 00: 00,
    classes_name = 下午,
    source_number = 10,
    amsEnd = 18: 30
}, {
    auto_id = 3,
    admStart = 06: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 妇产科模板,
    maintain_id = 2,
    amsStart = 06: 00,
    admEnd = 07: 00: 00,
    classes_name = 上午,
    source_number = 11,
    amsEnd = 11: 00
}, {
    auto_id = 4,
    admStart = 14: 05: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 妇产科模板,
    maintain_id = 2,
    amsStart = 15: 30,
    admEnd = 15: 00: 00,
    classes_name = 下午,
    source_number = 11,
    amsEnd = 18: 30
}, {
    auto_id = 5,
    admStart = 06: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 张三模板,
    maintain_id = 3,
    amsStart = 06: 00,
    admEnd = 07: 00: 00,
    classes_name = 上午,
    source_number = 12,
    amsEnd = 11: 00
}, {
    auto_id = 6,
    admStart = 14: 05: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 张三模板,
    maintain_id = 3,
    amsStart = 15: 30,
    admEnd = 15: 00: 00,
    classes_name = 下午,
    source_number = 12,
    amsEnd = 18: 30
}, {
    auto_id = 7,
    admStart = 07: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 院级模板,
    maintain_id = 1,
    amsStart = 06: 00,
    admEnd = 08: 00: 00,
    classes_name = 上午,
    source_number = 10,
    amsEnd = 11: 00
}, {
    auto_id = 8,
    admStart = 15: 01: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 院级模板,
    maintain_id = 1,
    amsStart = 15: 30,
    admEnd = 16: 00: 00,
    classes_name = 下午,
    source_number = 10,
    amsEnd = 18: 30
}, {
    auto_id = 9,
    admStart = 07: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 妇产科模板,
    maintain_id = 2,
    amsStart = 06: 00,
    admEnd = 08: 00: 00,
    classes_name = 上午,
    source_number = 11,
    amsEnd = 11: 00
}, {
    auto_id = 10,
    admStart = 15: 01: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 妇产科模板,
    maintain_id = 2,
    amsStart = 15: 30,
    admEnd = 16: 00: 00,
    classes_name = 下午,
    source_number = 11,
    amsEnd = 18: 30
}, {
    auto_id = 11,
    admStart = 15: 01: 00,
    source_allot_id = 0,
    classes_id = 52,
    maintain_name = 张三模板,
    maintain_id = 3,
    amsStart = 15: 30,
    admEnd = 16: 00: 00,
    classes_name = 下午,
    source_number = 12,
    amsEnd = 18: 30
}, {
    auto_id = 12,
    admStart = 07: 01: 00,
    source_allot_id = 0,
    classes_id = 48,
    maintain_name = 张三模板,
    maintain_id = 3,
    amsStart = 06: 00,
    admEnd = 08: 00: 00,
    classes_name = 上午,
    source_number = 12,
    amsEnd = 11: 00
}]
```

- 最终要求效果：

```json
{
    "msg": "操作成功",
    "code": 0,
    "data": [
        {
            "amsStart": "06:00",
            "segmentdata": [
                {
                    "admStart": "06:01:00",
                    "admEnd": "07:00:00",
                    "classes_name": "上午",
                    "source_number": 10
                },
                {
                    "admStart": "06:01:00",
                    "admEnd": "07:00:00",
                    "classes_name": "上午",
                    "source_number": 11
                },
                {
                    "admStart": "06:01:00",
                    "admEnd": "07:00:00",
                    "classes_name": "上午",
                    "source_number": 12
                },
                {
                    "admStart": "07:01:00",
                    "admEnd": "08:00:00",
                    "classes_name": "上午",
                    "source_number": 10
                },
                {
                    "admStart": "07:01:00",
                    "admEnd": "08:00:00",
                    "classes_name": "上午",
                    "source_number": 11
                },
                {
                    "admStart": "07:01:00",
                    "admEnd": "08:00:00",
                    "classes_name": "上午",
                    "source_number": 12
                }
            ],
            "classes_name": "上午",
            "amsEnd": "11:00"
        },
        {
            "amsStart": "15:30",
            "segmentdata": [
                {
                    "admStart": "14:05:00",
                    "admEnd": "15:00:00",
                    "classes_name": "下午",
                    "source_number": 10
                },
                {
                    "admStart": "14:05:00",
                    "admEnd": "15:00:00",
                    "classes_name": "下午",
                    "source_number": 11
                },
                {
                    "admStart": "14:05:00",
                    "admEnd": "15:00:00",
                    "classes_name": "下午",
                    "source_number": 12
                },
                {
                    "admStart": "15:01:00",
                    "admEnd": "16:00:00",
                    "classes_name": "下午",
                    "source_number": 10
                },
                {
                    "admStart": "15:01:00",
                    "admEnd": "16:00:00",
                    "classes_name": "下午",
                    "source_number": 11
                },
                {
                    "admStart": "15:01:00",
                    "admEnd": "16:00:00",
                    "classes_name": "下午",
                    "source_number": 12
                }
            ],
            "classes_name": "下午",
            "amsEnd": "18:30"
        }
    ]
}
```

- 代码处理

```java
public AjaxResult selectDayTemplateByMoreOperation(@RequestParam(value = "name", required = false) String name,
			@RequestParam(value = "scheludingclass", required = false) String scheludingclass,
			@RequestParam(value = "deptId", required = false) String deptId,
			@RequestParam(value = "arsDocId", required = false) String arsDocId) {
    
		List<Map<String, Object>> list = arsDayMaintainService.selectDayTemplateByMoreOperation(name, deptId, arsDocId);
		System.out.println("原始数据：" + list);
		// 筛选list中的map，让每个map只包含班次名称，开始时间，结束时间三个字段
		List<Map<String, Object>> allList = new ArrayList<Map<String, Object>>();
		list.stream().forEach(map -> {
			Map<String, Object> collect = map.entrySet().stream()
					.filter(m -> m.getKey().equals("classes_name") || m.getKey().equals("amsStart")
							|| m.getKey().equals("amsEnd"))
					.collect(Collectors.toMap(h -> h.getKey(), h -> h.getValue()));
			allList.add(collect);
		});
		System.out.println("没去重之前：" + allList);
		// 针对筛选完成后的list中的map去重
		/*
		  去重后：
		 [{
		    amsStart = 06: 00,
		    classes_name = 上午,
		    amsEnd = 11: 00
		  }, 
		  {
		    amsStart = 15: 30,
		    classes_name = 下午,
		    amsEnd = 18: 30
		  }
		]  
		*/ 
		List<Map<String, Object>> distinctcollect = allList.stream().distinct().collect(Collectors.toList());
		System.out.println("去重之后" + distinctcollect);
		for (int i = 0; i < distinctcollect.size(); i++) {
			// 获取当前的班次名称
			Object classesName = distinctcollect.get(i).get("classes_name");
			// 开始封装第二层
			// 筛选list中的map，让每个map只包含分段开始时间，分段结束时间，号源数三个字段
			List<Map<String, Object>> segmentList = new ArrayList<Map<String, Object>>();
			list.stream().forEach(map -> {
				Map<String, Object> collect = map.entrySet().stream()
						.filter(m -> m.getKey().equals("admStart") || m.getKey().equals("admEnd")
								|| m.getKey().equals("source_number") || m.getValue().equals(classesName))
						.collect(Collectors.toMap(h -> h.getKey(), h -> h.getValue()));
				// 开始进行过滤，过滤掉map中没有classes_name这个key的map
				if (collect.containsKey("classes_name")) {
					segmentList.add(collect);
				}
			});
			// 把分段数据挂到相应的班次下面
			distinctcollect.get(i).put("segmentdata", segmentList);
			System.out.println(classesName.toString() + "班次中的所有分段数据：" + segmentList);
		}

		return AjaxResult.success(distinctcollect);
	}
```

